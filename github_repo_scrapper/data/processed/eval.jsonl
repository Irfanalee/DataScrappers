{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_utils.py`:\n\n```python\nif token is not None:\n            kwargs[\"token\"] = token\n\n        processor_dict, kwargs = cls.get_processor_dict(pretrained_model_name_or_path, **kwargs)\n        args = cls._get_arguments_from_pretrained(pretrained_model_name_or_path, **kwargs)\n        processor_dict, kwargs = cls.get_processor_dict(pretrained_model_name_or_path, **kwargs)\n```"}, {"role": "assistant", "content": "Yeha, that was done for a reason since we use kwargs later to update config keys. So we can allow users to `from_pretrained(model_id, subfolder='x', any_processor_attribute='new_value')`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42031, "url": "https://github.com/huggingface/transformers/pull/42031#discussion_r2494152721"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cookies.py`:\n\n```python\nreturn cookie_str\n\n    def _get_request_cookies(self, jar, request):\n        # from 'Cookie' request header\n        cookie_header = request.headers.get('Cookie', '')\n        cookie_list = re.split(';\\s*', cookie_header.decode('latin1'))\n```"}, {"role": "assistant", "content": "Are there stdlib functions to parse cookies?\r\n\r\nAlso, cookies should be UTF-8 in most cases (but other encodings are also possible, so the code must be robust); .decode('latin1') never fails, but I wonder if non-ascii UTF-8 cookies are preserved correctly now. Could you please add a test for it?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 2400, "url": "https://github.com/scrapy/scrapy/pull/2400#discussion_r88844580"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_primer.py`:\n\n```python\n\"no_diff\": False,\n        }\n        with patch(\"black_primer.cli.lib.process_queue\", return_zero):\n            return_val = loop.run_until_complete(cli.async_main(**args))\n            return_val = loop.run_until_complete(cli.async_main(**args))  # type: ignore\n```"}, {"role": "assistant", "content": "Decided to ignore here, because of the dict's convenience"}], "_meta": {"repo": "psf/black", "pr_number": 2363, "url": "https://github.com/psf/black/pull/2363#discussion_r664792700"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_requests.py`:\n\n```python\ndef test_invalid_url(self):\n        with pytest.raises(MissingSchema):\n            requests.get('hiwpefhipowhefopw')\n        with pytest.raises(InvalidSchema):\n            requests.get('localhost:3128')\n        with pytest.raises(InvalidSchema):\n```"}, {"role": "assistant", "content": "What I've meant is that this tests the skipping code: if this was changed, e.g. by using a more sophisticated regex, the behavior might change and this additional test might catch it."}], "_meta": {"repo": "psf/requests", "pr_number": 2222, "url": "https://github.com/psf/requests/pull/2222#discussion_r17487277"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nif proxy is not None:\n                await proxy.aclose()\n\n        self._is_closed = True\n```"}, {"role": "assistant", "content": "I saw several same places where race condition _is possible_ \r\n\r\nI can try to write a test, which strictly cause a race condition here (if it's possible)"}], "_meta": {"repo": "encode/httpx", "pr_number": 1197, "url": "https://github.com/encode/httpx/pull/1197#discussion_r472965687"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_qwen2_moe.py`:\n\n```python\nreturn attn_output, attn_weights\n\n\nclass Qwen2MoeExperts(nn.ModuleList):\n    \"\"\"\n    ModuleList of experts.\n    \"\"\"\nclass Qwen2MoeExperts(nn.Module):\n    \"\"\"Collection of expert weights stored as 3D tensors.\"\"\"\n\n    def __init__(self, config):\n        super().__init__()\n        self.num_experts = config.num_experts\n        for _ in range(config.num_experts):\n            self.append(Qwen2MoeMLP(config, intermediate_size=config.moe_intermediate_size))\n```"}, {"role": "assistant", "content": "This change is not straightforward and breaks downstream libraries expecting `Qwen2MoeExperts` experts to be `nn.Linear`. Is there an easy workaround?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41580, "url": "https://github.com/huggingface/transformers/pull/41580#discussion_r2534809184"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\ncallback=target_version_option_callback,\n    multiple=True,\n    help=(\n        \"Python versions that should be supported by Black's output. [default: per-file\"\n        \" auto-detection]\"\n        \"Minimum Python version that should be supported by Black's output. By default,\"\n        \" Black will try to infer this from the project metadata in pyproject.toml. If\"\n        \" this does not yield conclusive results, Black will use per-file\"\n        \" auto-detection.\"\n```"}, {"role": "assistant", "content": "Good call to document the per-file auto-detection fallback!"}], "_meta": {"repo": "psf/black", "pr_number": 3219, "url": "https://github.com/psf/black/pull/3219#discussion_r996213862"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `validate_call_decorator.py`:\n\n```python\ndef wrapper_function(*args, **kwargs):\n            return validate_call_wrapper(*args, **kwargs)\n\n        @functools.wraps(function)\n        async def async_wrapper_function(*args, **kwargs):\n            return await validate_call_wrapper(*args, **kwargs)\n\n        wrapper_function.raw_function = function  # type: ignore\n        async_wrapper_function.raw_function = function  # type: ignore\n\n        return wrapper_function  # type: ignore\n        if inspect.iscoroutinefunction(function):\n            return async_wrapper_function  # type: ignore\n        else:\n            return wrapper_function  # type: ignore\n```"}, {"role": "assistant", "content": "Let's add the function definitions (`wrapper_function` and `async_wrapper_function`) to the relevant parts of this conditional. Can also move the `.raw_function` assignments there as well."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10374, "url": "https://github.com/pydantic/pydantic/pull/10374#discussion_r1754528183"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `ignore_pyi.py`:\n\n```python\ndef f():  # type: ignore\n    ...\n\nclass x:  # some comment\n    ...\n\nclass y:\n    ...  # comment\n\n# whitespace doesn't matter (note the next line has a trailing space and tab)\nclass z:        \n    ...\n\ndef g():\n    # hi\n    ...\n\ndef h():\n    ...\n    # bye\n\n# output\n\ndef f():  # type: ignore\n    ...\n\nclass x:  # some comment\n    ...\n\nclass y: ...  # comment\n\n# whitespace doesn't matter (note the next line has a trailing space and tab)\nclass z: ...\n\ndef g():\n    # hi\n    ...\n\ndef h():\n    ...\n    # bye\n```"}, {"role": "assistant", "content": "Arguably we could turn this into `def h(): ...  # bye`, but that's more complicated to implement and if the user put it on a separate line, we might as well keep it there."}], "_meta": {"repo": "psf/black", "pr_number": 3745, "url": "https://github.com/psf/black/pull/3745#discussion_r1239310658"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cli_parser.py`:\n\n```python\nlog = logging.getLogger(__name__)\n\n\nfor executor_name in ExecutorLoader.get_executor_names(validate_teams=False):\n```"}, {"role": "assistant", "content": "Good point!\r\n\r\n> Possibly one way of doing it is simple mapping of the executors -> provider (for built-in executors we have mapping from the executor to provider package and checking if the provider has \"cli\" defined in provider info? Also likely we should raise an error if provider has an executor defined with cli commands AND cli command defined in provider info.\r\n\r\nYes, that is the exact same idea for me. It could be done in ProviderManager, and I will add the same validation for AuthManager as well."}], "_meta": {"repo": "apache/airflow", "pr_number": 59805, "url": "https://github.com/apache/airflow/pull/59805#discussion_r2649708589"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `translate.py`:\n\n```python\nif old_translation:\n        prompt_segments.extend(\n            [\n                \"There's an existing previous translation for this content that is probably outdated with old content or old instructions.\",\n                \"There is an existing previous translation for the original English content, that may be outdated.\",\n                \"Update the translation only where necessary:\",\n                \"- If the original English content has changed, reflect that in the translation.\",\n                \"- If the original English content has added parts, also add these parts to the translation.\",\n                \"- If the original English content has removed parts, also remove them from the translation, unless you were instructed earlier to not do that in specific cases.\",\n                \"- If parts of the original English content have changed, also change those parts in the translation.\",\n```"}, {"role": "assistant", "content": "As I understand it ...\r\n\r\n```\r\nIf the original English content has added parts (...)\r\nIf the original English content has removed parts (...)\r\nIf parts of the original English content have changed (...)\r\n```\r\n\r\n... means _\"compared to the existing translation\"_ and not _\"compared to the previous version of the English document\"_. Do you agree? If so, then I do not see an issue, do you?\r\n\r\nNotice, the shorter version did not add a part to a sentence, in a situation when retranslating the test file (this sentence). It was stubborn, even when I retranslated again. After I changed the prompt, it detected the addition.\r\n\r\nRegarding comment markers, I also thought about this one, and the problem you mentioned (when the addition may become invalid), and I found no good solution, which is why stuck to just allow added `abbr`s, which are removed when the sentence gets removed.\r\n\r\nBTW, I will make another complete retranslation before merging, to check if it works with the updated prompts."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 14015, "url": "https://github.com/fastapi/fastapi/pull/14015#discussion_r2323501046"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `curl.py`:\n\n```python\nresult['cookies'] = cookies\n    if parsed_args.data:\n        result['body'] = parsed_args.data\n        if result.get('method') == 'GET':\n            # if the \"data\" is specified but the \"method\" is not specified,\n            # the default method is 'POST'\n            result['method'] = 'POST'\n```"}, {"role": "assistant", "content": "Hi , \r\n\r\nI'm not sure which approach to take. From my perspective, this command tries to do the best from the cURL command, and I think that it doesn't have any sense to add the body when the method is GET.\r\n\r\nBefore deciding this I checked other tools as https://curl.trillworks.com/ , and when entering:\r\n```bash\r\ncurl URL -X GET --data asdf\r\n```\r\n\r\nI got:\r\n```python\r\nimport requests\r\n\r\ndata = 'asdf'\r\n\r\nresponse = requests.post('http://URL', data=data)\r\n```\r\n\r\nOf course, I can change it to respect the provided GET, but I'm not sure about the best option. Any other idea / thoughts?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4612, "url": "https://github.com/scrapy/scrapy/pull/4612#discussion_r436797139"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conf.py`:\n\n```python\n'tox': ('https://tox.readthedocs.io/en/latest', None),\n    'twisted': ('https://twistedmatrix.com/documents/current', None),\n    'twistedapi': ('https://twistedmatrix.com/documents/current/api', None),\n    'cryptography' : ('https://cryptography.io/en/latest/', None),\n```"}, {"role": "assistant", "content": ":lipstick: Let\u2019s keep these entries alphabetical :nerd_face:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4899, "url": "https://github.com/scrapy/scrapy/pull/4899#discussion_r532609259"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\ndataclass_bases_stack.enter_context(self._types_namespace_stack.push(dataclass_base))\n\n                # Pushing a config overwrites the previous config, so iterate though the MRO backwards\n                config = None\n```"}, {"role": "assistant", "content": "I have a suspicion that this isn't needed, but perhaps that's wrong"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9183, "url": "https://github.com/pydantic/pydantic/pull/9183#discussion_r1651790243"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_decoders.py`:\n\n```python\nfor chunk in data:\n            yield chunk\n\n    response = httpx.Response(200, content=iterator())\n    response = httpx.Response(200, stream=iterator())\n```"}, {"role": "assistant", "content": "Strictly speaking these would need to be `stream=AsyncIteratorStream(iterator())`, correct?\r\n\r\nI'd be in favor of making that change, since we're otherwise setting false expectations that `stream=` accepts async generators when it actually doesn't (it just so happens to work because responses don't call into `.get_headers()` or `.can_replay()`)."}], "_meta": {"repo": "encode/httpx", "pr_number": 648, "url": "https://github.com/encode/httpx/pull/648#discussion_r360360625"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `kernel_config.py`:\n\n```python\ndef __init__(self, kernel_mapping={}):\n        self.kernel_mapping = kernel_mapping\n        self.registered_layer_names = {}\n        self.use_local_kernel = False\n```"}, {"role": "assistant", "content": "we need to set `self.use_local_kernel` to `use_local_kernel` passed in the constructor, and defaults to False"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42800, "url": "https://github.com/huggingface/transformers/pull/42800#discussion_r2623094911"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_processor_glm46v.py`:\n\n```python\n# Copyright 2025 The HuggingFace Team. All rights reserved.\n```"}, {"role": "assistant", "content": "This part directly uses the GLM4V tests without modification. Since these are two different processors, I believe the test code should be the same."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42122, "url": "https://github.com/huggingface/transformers/pull/42122#discussion_r2517641084"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_utils.py`:\n\n```python\ncls._auto_class = auto_class\n\n    @staticmethod\n    def _get_global_generation_defaults() -> dict[str, Any]:\n        return {\n            \"max_length\": 20,\n            \"min_length\": 0,\n            \"do_sample\": False,\n            \"early_stopping\": False,\n            \"num_beams\": 1,\n            \"temperature\": 1.0,\n            \"top_k\": 50,\n            \"top_p\": 1.0,\n            \"typical_p\": 1.0,\n            \"repetition_penalty\": 1.0,\n            \"length_penalty\": 1.0,\n            \"no_repeat_ngram_size\": 0,\n            \"encoder_no_repeat_ngram_size\": 0,\n            \"bad_words_ids\": None,\n            \"num_return_sequences\": 1,\n            \"output_scores\": False,\n            \"return_dict_in_generate\": False,\n            \"forced_bos_token_id\": None,\n            \"forced_eos_token_id\": None,\n            \"remove_invalid_values\": False,\n            \"exponential_decay_length_penalty\": None,\n            \"suppress_tokens\": None,\n            \"begin_suppress_tokens\": None,\n            # Deprecated arguments (moved to the Hub). TODO joao, manuel: remove in v4.62.0\n            \"num_beam_groups\": 1,\n            \"diversity_penalty\": 0.0,\n        }\n\n    def _get_non_default_generation_parameters(self) -> dict[str, Any]:\n    def _get_generation_parameters(self) -> dict[str, Any]:\n        \"\"\"\n        Gets the non-default generation parameters on the PreTrainedConfig instance\n        \"\"\"\n        non_default_generation_parameters = {}\n        decoder_attribute_name = None\n\n        # If it is a composite model, we want to check the subconfig that will be used for generation\n        self_decoder_config = self if decoder_attribute_name is None else getattr(self, decoder_attribute_name)\n\n        for parameter_name, default_global_value in self._get_global_generation_defaults().items():\n            if hasattr(self_decoder_config, parameter_name):\n                parameter_value = getattr(self_decoder_config, parameter_name, None)\n                # Two cases in which is okay for the model config to hold generation config parameters:\n                # 1. The parameter is set to `None`, effectively delegating its value to the generation config\n                # 2. The parameter is set the global generation defaults\n                if parameter_value is None or parameter_value == default_global_value:\n                    continue\n                non_default_generation_parameters[parameter_name] = getattr(self_decoder_config, parameter_name)\n\n        return non_default_generation_parameters\n        generation_params = {}\n        default_config = self.__class__().to_dict() if not self.has_no_defaults_at_init else {}\n        for key in GenerationConfig._get_default_generation_params().keys():\n            if hasattr(self, key) and getattr(self, key) is not None and key not in default_config:\n                generation_params[key] = getattr(self, key)\n```"}, {"role": "assistant", "content": "yeah, that and also because these lines are more of a workaround for old models (e.g. bart). New models don't have any generation params in model config anyway, we don't allow it for quite a long time"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42702, "url": "https://github.com/huggingface/transformers/pull/42702#discussion_r2610122149"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cookies.py`:\n\n```python\ndef __init__(self, debug=False):\n        self.jars = defaultdict(CookieJar)\n        self.debug = debug\n        self.re_cookie_header = re.compile(b';\\s*')\n```"}, {"role": "assistant", "content": "Changed the approach, not using `re` anymore, `bytes.split` and `bytes.strip` are more efficient in this case."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 2400, "url": "https://github.com/scrapy/scrapy/pull/2400#discussion_r268373805"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_gcs.py`:\n\n```python\nfrom datetime import datetime\nfrom unittest.mock import Mock, call, patch\nimport sys\nfrom datetime import datetime, timedelta\nfrom unittest.mock import MagicMock, Mock, call, patch\n\nimport pytest\nfrom google.cloud.exceptions import NotFound\n\nfrom celery.backends.gcs import GCSBackend\nfrom celery.exceptions import ImproperlyConfigured\n\n# Workaround until python-firestore is fixed\nis_py313 = sys.version_info >= (3, 13)\nif not is_py313:\n    from celery.backends.gcs import GCSBackend\nelse:\n    GCSBackend = None\n\n\n@pytest.mark.skipif(\n    is_py313,\n    reason=\"https://github.com/googleapis/python-firestore/issues/973\",\n```"}, {"role": "assistant", "content": "Looking at this linked issue, it has now been fixed in the upstream. I would like to be able to upgrade to Python 3.13 without being unable to the GCS backend.\r\n\r\nI would be happy to fix this alongside the other issues that I have noted above"}], "_meta": {"repo": "celery/celery", "pr_number": 9302, "url": "https://github.com/celery/celery/pull/9302#discussion_r2058651110"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_api.py`:\n\n```python\nRequestData,\n    RequestFiles,\n    TimeoutTypes,\n    URLTypes,\n    VerifyTypes,\n)\nfrom ._urls import URL\n```"}, {"role": "assistant", "content": "I'd only use that if it was required to avoid a cyclical dependency."}], "_meta": {"repo": "encode/httpx", "pr_number": 3245, "url": "https://github.com/encode/httpx/pull/3245#discussion_r1688184272"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_linkextractors.py`:\n\n```python\n),\n            ],\n        )\n\n    def test_link_allowed_is_false_with_empty_url(self):\n        mock_link = Mock()\n```"}, {"role": "assistant", "content": "Do you need to use `Mock` in these tests? It feels like `Link` could work, and `Mock` is usually left for cases where it is needed."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6232, "url": "https://github.com/scrapy/scrapy/pull/6232#discussion_r1497329653"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `middleware.py`:\n\n```python\nself.methods['close_spider'].appendleft(mw.close_spider)\n\n    def _process_parallel(self, methodname: str, obj, *args) -> Deferred:\n        return process_parallel(self.methods[methodname], obj, *args)\n        methods = cast(Iterable[Callable], self.methods[methodname])\n        return process_parallel(methods, obj, *args)\n\n    def _process_chain(self, methodname: str, obj, *args) -> Deferred:\n        return process_chain(self.methods[methodname], obj, *args)\n        methods = cast(Iterable[Callable], self.methods[methodname])\n        return process_chain(methods, obj, *args)\n\n    def _process_chain_both(self, cb_methodname: str, eb_methodname: str, obj, *args) -> Deferred:\n```"}, {"role": "assistant", "content": "This method is not covered because it's never used. I think we can drop it?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5334, "url": "https://github.com/scrapy/scrapy/pull/5334#discussion_r758274435"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tokenization_auto.py`:\n\n```python\ndef tokenizer_class_from_name(class_name: str) -> Union[type[Any], None]:\n    if class_name == \"BloomTokenizer\":\n        return TokenizersBackend\n```"}, {"role": "assistant", "content": "Not sure about this, the tokenizer should be fixed in a separate pr, and team members are already working on an other fix"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41567, "url": "https://github.com/huggingface/transformers/pull/41567#discussion_r2602742421"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_nanochat.py`:\n\n```python\nfrom transformers.configuration_utils import PretrainedConfig\nfrom transformers.utils import logging\n\n\nlogger = logging.get_logger(__name__)\n\n\n__all__ = [\"NanoChatConfig\"]\n\n\nclass NanoChatConfig(PretrainedConfig):\n    r\"\"\"Configuration for the NanoChat model.\"\"\"\n\n    model_type = \"nanochat\"\n    keys_to_ignore_at_inference = [\"past_key_values\"]\n    attribute_map = {\n        \"hidden_size\": \"n_embd\",\n        \"num_hidden_layers\": \"n_layer\",\n        \"num_attention_heads\": \"n_head\",\n    }\n```"}, {"role": "assistant", "content": "Just a random point but it might be nice to have a tp/pp plan if the model is big https://github.com/huggingface/transformers/blob/bdbc2d037b1751c71b30a488f0a168deabef9a90/src/transformers/models/llama/configuration_llama.py#L146-L159"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41634, "url": "https://github.com/huggingface/transformers/pull/41634#discussion_r2436860549"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_types.py`:\n\n```python\nFoo(a=a)\n\n\ndef test_invalid_decimal_constraint():\n@pytest.mark.parametrize(\n    'kwargs',\n    [\n        {'max_length': 5},\n        {'min_length': 5},\n    ],\n)\ndef test_invalid_decimal_constraint(kwargs):\n```"}, {"role": "assistant", "content": "I think this could be consolidated into the test above..."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10763, "url": "https://github.com/pydantic/pydantic/pull/10763#discussion_r1842444199"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_black.py`:\n\n```python\none.write_text(\"print('hello')\", encoding=\"utf-8\")\n            two = (workspace / \"two.py\").resolve()\n            two.write_text(\"print('hello')\", encoding=\"utf-8\")\n            black.write_cache({}, [one], mode)\n            cache = black.Cache.read(mode)\n            cache.write([one])\n            invokeBlack([str(workspace)])\n            assert one.read_text(encoding=\"utf-8\") == \"print('hello')\"\n            assert two.read_text(encoding=\"utf-8\") == 'print(\"hello\")\\n'\n            cache = black.read_cache(mode)\n            assert str(one) in cache\n            assert str(two) in cache\n            cache = black.Cache.read(mode)\n            assert not cache.is_changed(one)\n            assert not cache.is_changed(two)\n\n    @pytest.mark.parametrize(\"color\", [False, True], ids=[\"no-color\", \"with-color\"])\n    def test_no_cache_when_writeback_diff(self, color: bool) -> None:\n        mode = DEFAULT_MODE\n        with cache_dir() as workspace:\n            src = (workspace / \"test.py\").resolve()\n            src.write_text(\"print('hello')\", encoding=\"utf-8\")\n            with patch(\"black.read_cache\") as read_cache, patch(\n                \"black.write_cache\"\n            with patch.object(black.Cache, \"read\") as read_cache, patch.object(\n                black.Cache, \"write\"\n            ) as write_cache:\n                cmd = [str(src), \"--diff\"]\n                if color:\n                    cmd.append(\"--color\")\n                invokeBlack(cmd)\n                cache_file = get_cache_file(mode)\n                assert cache_file.exists() is False\n                read_cache.assert_called_once()\n```"}, {"role": "assistant", "content": "This is a change in behaviour from eagerly reading the cache. Doesn't seem like a big deal"}], "_meta": {"repo": "psf/black", "pr_number": 3821, "url": "https://github.com/psf/black/pull/3821#discussion_r1294274095"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `base.py`:\n\n```python\n:param data_interval: The data interval of the DAG run.\n        \"\"\"\n        return run_type.generate_run_id(suffix=run_after.isoformat())\n\n    def next_dagrun_info_v2(self, *, last_dagrun_info: DagRunInfo | None, restriction: TimeRestriction):\n        \"\"\"\n        Provide information to schedule the next DagRun.\n\n        The default implementation raises ``NotImplementedError``.\n\n        :param last_dagrun_info: The DagRunInfo object of the\n            Dag's last scheduled or backfilled run.\n        :param restriction: Restriction to apply when scheduling the DAG run.\n```"}, {"role": "assistant", "content": "```suggestion\n        :param restriction: Restriction to apply when scheduling the Dag run.\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 59115, "url": "https://github.com/apache/airflow/pull/59115#discussion_r2697740371"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\nreturn result\n\n\nclass InstrumentedFeedSlot(_FeedSlot):\n    \"\"\"Instrumented _FeedSlot subclass for keeping track of calls to\n    start_exporting and finish_exporting.\"\"\"\n    def start_exporting(self):\n        self.update_listener('start')\n        super().start_exporting()\n\n    def finish_exporting(self):\n        self.update_listener('finish')\n        super().finish_exporting()\n\n    @classmethod\n    def subscribe__listener(cls, listener):\n        cls.update_listener = listener.update\n\n\nclass IsExportingListener:\n    \"\"\"When subscribed to InstrumentedFeedSlot, keeps track of when\n    a call to start_exporting has been made without a closing call to\n    finish_exporting and when a call to finis_exporting has been made\n```"}, {"role": "assistant", "content": ":lipstick: \r\n\r\n```suggestion\r\n    finish_exporting and when a call to finish_exporting has been made\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5758, "url": "https://github.com/scrapy/scrapy/pull/5758#discussion_r1066934458"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nreturn (loss, outputs) if return_outputs else loss\n\n    def _deepspeed_sp_compute_loss(self, model, inputs, return_outputs, pc):\n        \"\"\"\n        How the loss is computed by Trainer under context parallelism scenario with sp_backend==deepspeed and sp_size>1. By default, all models return the loss in the first element.\n\n        Args:\n            model (`nn.Module`):\n                The model to compute the loss for.\n            inputs (`dict[str, Union[torch.Tensor, Any]]`):\n                The input data for the model.\n            return_outputs (`bool`, *optional*, defaults to `False`):\n                Whether to return the model outputs along with the loss.\n            pc (`accelerate.parallelism_config.ParallelismConfig`):\n                self.accelerator.parallelism_config object (not None)\n\n        Returns:\n            The loss of the model along with its output if return_outputs was set to True\n        \"\"\"\n\n        unwrapped_model = self.accelerator.unwrap_model(model)\n\n        outputs = model(**inputs)\n        shift_labels = inputs[\"shift_labels\"]\n        loss = unwrapped_model.loss_function(\n            logits=outputs.logits,\n            labels=None,\n            shift_labels=shift_labels,\n            vocab_size=unwrapped_model.config.vocab_size,\n        )\n\n        if pc.sp_size > 1:\n```"}, {"role": "assistant", "content": "this check should always be True here so let's remove that and check for it before."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41832, "url": "https://github.com/huggingface/transformers/pull/41832#discussion_r2538884193"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `entry_points.py`:\n\n```python\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport functools\nimport logging\nimport sys\nfrom collections import defaultdict\nfrom collections.abc import Iterator\n\nif sys.version_info >= (3, 12):\n    from importlib import metadata\nelse:\n    import importlib_metadata as metadata\n\nlog = logging.getLogger(__name__)\n\nEPnD = tuple[metadata.EntryPoint, metadata.Distribution]\n\n\"\"\"Re-export entry_points utilities from shared library for backward compatibility.\"\"\"\n\n@functools.cache\ndef _get_grouped_entry_points() -> dict[str, list[EPnD]]:\n    mapping: dict[str, list[EPnD]] = defaultdict(list)\n    for dist in metadata.distributions():\n        try:\n            for e in dist.entry_points:\n                mapping[e.group].append((e, dist))\n        except Exception as e:\n            log.warning(\"Error when retrieving package metadata (skipping it): %s, %s\", dist, e)\n    return mapping\n\n\ndef entry_points_with_dist(group: str) -> Iterator[EPnD]:\n    \"\"\"\n    Retrieve entry points of the given group.\n\n    This is like the ``entry_points()`` function from ``importlib.metadata``,\n    except it also returns the distribution the entry point was loaded from.\n\n    Note that this may return multiple distributions to the same package if they\n    are loaded from different ``sys.path`` entries. The caller site should\n    implement appropriate deduplication logic if needed.\nfrom __future__ import annotations\n\n    :param group: Filter results to only this entrypoint group\n    :return: Generator of (EntryPoint, Distribution) objects for the specified groups\n    \"\"\"\n    return iter(_get_grouped_entry_points()[group])\nfrom airflow._shared.module_loading.entry_points import (\n    EPnD as EPnD,\n    _get_grouped_entry_points as _get_grouped_entry_points,\n    entry_points_with_dist as entry_points_with_dist,\n    metadata as metadata,\n)\n```"}, {"role": "assistant", "content": "Here you go: https://github.com/apache/airflow/pull/60061"}], "_meta": {"repo": "apache/airflow", "pr_number": 59971, "url": "https://github.com/apache/airflow/pull/59971#discussion_r2658219297"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nreturn maybe_schema\n\n            schema = cls.__dict__.get('__pydantic_core_schema__')\n            if (\n                schema is not None\n                and not isinstance(schema, MockCoreSchema)\n                # Due to the way generic classes are built, it's possible that an invalid schema may be temporarily\n                # set on generic classes. Probably we could resolve this to ensure that we get proper schema caching\n                # for generics, but for simplicity for now, we just always rebuild if the class has a generic origin:\n```"}, {"role": "assistant", "content": "Makes me a bit nervous, but given you are probably one of the heaviest users of pydantic generics, my guess is that if you aren't seeing bugs, it's probably working okay? \ud83d\ude05  Admittedly this code has gotten a lot of refactoring since I was last looking at it heavily"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11434, "url": "https://github.com/pydantic/pydantic/pull/11434#discussion_r1953348404"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nReturns:\n            A `CoreConfig` object created from config.\n        \"\"\"\n\n        def dict_not_none(**kwargs: Any) -> Any:\n            return {k: v for k, v in kwargs.items() if v is not None}\n\n        core_config = core_schema.CoreConfig(\n            **dict_not_none(\n                title=self.config_dict.get('title') or (obj and obj.__name__),\n                extra_fields_behavior=self.config_dict.get('extra'),\n                allow_inf_nan=self.config_dict.get('allow_inf_nan'),\n                populate_by_name=self.config_dict.get('populate_by_name'),\n                str_strip_whitespace=self.config_dict.get('str_strip_whitespace'),\n                str_to_lower=self.config_dict.get('str_to_lower'),\n                str_to_upper=self.config_dict.get('str_to_upper'),\n                strict=self.config_dict.get('strict'),\n                ser_json_timedelta=self.config_dict.get('ser_json_timedelta'),\n                ser_json_bytes=self.config_dict.get('ser_json_bytes'),\n                ser_json_inf_nan=self.config_dict.get('ser_json_inf_nan'),\n                from_attributes=self.config_dict.get('from_attributes'),\n                loc_by_alias=self.config_dict.get('loc_by_alias'),\n                revalidate_instances=self.config_dict.get('revalidate_instances'),\n                validate_default=self.config_dict.get('validate_default'),\n                str_max_length=self.config_dict.get('str_max_length'),\n                str_min_length=self.config_dict.get('str_min_length'),\n                hide_input_in_errors=self.config_dict.get('hide_input_in_errors'),\n                coerce_numbers_to_str=self.config_dict.get('coerce_numbers_to_str'),\n                regex_engine=self.config_dict.get('regex_engine'),\n                validation_error_cause=self.config_dict.get('validation_error_cause'),\n                cache_strings=self.config_dict.get('cache_strings'),\n            )\n        )\n        return core_config\n        config = self.config_dict\n        title = config.get('title') or (obj and obj.__name__)\n\n        core_config_values = {\n            'title': title,\n```"}, {"role": "assistant", "content": "```suggestion\r\n\r\n        core_config_values = {\r\n            'title': config.get('title') or (obj and obj.__name__),\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9953, "url": "https://github.com/pydantic/pydantic/pull/9953#discussion_r1689989522"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `config.py`:\n\n```python\ntitle: str | None\n    \"\"\"The title for the generated JSON schema, defaults to the model's name\"\"\"\n\n    class_title_generator: Callable[[str], str] | None\n    \"\"\"A callable that takes a class name and returns the title for it. Defaults to `None`.\"\"\"\n```"}, {"role": "assistant", "content": "It works for all model and model-like (pydantic dataclass, builtin dataclass, typeddict) types. `ConfigDict` can be applied to all of them so IMO it's a little redundant. Changing the name to `model_title_generator` makes this even more clear I feel.\r\n\r\n\r\nI will add more documentation if you feel it's necessary."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9183, "url": "https://github.com/pydantic/pydantic/pull/9183#discussion_r1622564233"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_responses.py`:\n\n```python\ncontent=b\"Hello,\\nworld!\",\n    )\n    content = [line for line in response.iter_lines()]\n    assert content == [\"Hello,\\n\", \"world!\"]\n    assert content == [\"Hello,\", \"world!\"]\n```"}, {"role": "assistant", "content": "Oh, I didn't realise there was a `keepends` flag, let me rework the patch with that."}], "_meta": {"repo": "encode/httpx", "pr_number": 2423, "url": "https://github.com/encode/httpx/pull/2423#discussion_r1027299829"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nsrc_ast = parse_ast(src)\n    except Exception as exc:\n        raise AssertionError(\n            f\"cannot use --safe with this file; failed to parse source file: {exc}\"\n            f\"cannot use --safe with this file; failed to parse source file AST: {exc}\"\n```"}, {"role": "assistant", "content": "Perhaps a simpler solution to the problem  noticed would be:\r\n```suggestion\r\n            f\"cannot use --safe with this file; failed to parse source file AST: {exc}\\n\"\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 2786, "url": "https://github.com/psf/black/pull/2786#discussion_r788897322"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `context.py`:\n\n```python\n)\n\n\nclass Context(TypedDict, total=False):\n```"}, {"role": "assistant", "content": "If I recall correctly (not sure), `total=False` only affects if everything declared are in the dict; it does not affect if you can put other things in (type checker always flags, runtime always allows). So we don\u2019t need this if we mark all the optional keys with NotRequired (do we?)"}], "_meta": {"repo": "apache/airflow", "pr_number": 54421, "url": "https://github.com/apache/airflow/pull/54421#discussion_r2488996754"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_pixtral.py`:\n\n```python\nposition_ids = position_ids_in_meshgrid(\n            patch_embeds_list, max_width=self.config.image_size // self.config.patch_size\n        )\n        kwargs[\"position_ids\"] = position_ids.to(patch_embeds.device, non_blocking=True)\n        kwargs[\"position_ids\"] = position_ids.unsqueeze(0).to(patch_embeds.device, non_blocking=True)\n```"}, {"role": "assistant", "content": "oh actually no, them we'd have to squeeze it back in position embeddings. The extra dim is needed only for attn module"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43443, "url": "https://github.com/huggingface/transformers/pull/43443#discussion_r2721042215"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `genspider.py`:\n\n```python\nif filename.endswith('.tmpl'):\n                print(\"  %s\" % splitext(filename)[0])\n\n    def _spider_exists(self, name):\n        if not self.settings.get('NEWSPIDER_MODULE'):\n            # if run as a standalone command and file with same filename already exists\n            if exists(name + \".py\"):\n                print(\"%s already exists\" % (abspath(name + \".py\")))\n                return True\n            return False\n\n        try:\n            spidercls = self.crawler_process.spider_loader.load(name)\n        except KeyError:\n            pass\n        else:\n            # if spider with same name exists\n            print(\"Spider %r already exists in module:\" % name)\n            print(\"  %s\" % spidercls.__module__)\n            return True\n        # if spider same filename exists\n```"}, {"role": "assistant", "content": "```suggestion\r\n\r\n        # a file with the same name exists in the target directory\r\n```\r\nGrammar police :oncoming_police_car:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4623, "url": "https://github.com/scrapy/scrapy/pull/4623#discussion_r469891506"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `wsgi.py`:\n\n```python\nseen_exc_info = exc_info\n\n        result = self.app(environ, start_response)\n        # This is needed because the status returned by start_response\n        # shouldn't be used until the first non-empty chunk has been served.\n        result = _get_non_empty_chunk(result)\n```"}, {"role": "assistant", "content": "Woops \ud83d\ude04  (Forgot to add this suggestion to my previous review!)\r\n\r\n```suggestion\r\n        result = _skip_leading_empty_chunks(result)\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 887, "url": "https://github.com/encode/httpx/pull/887#discussion_r399779698"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `preview_long_strings.py`:\n\n```python\nlog.info(f\"Skipping: {desc['db_id']=} {desc['ms_name']} {money=} {dte=} {pos_share=} {desc['status']=} {desc['exposure_max']=}\")\n\nlog.info(f'Skipping: {desc[\"db_id\"]} {foo(\"bar\",x=123)} {\"foo\" != \"bar\"} {(x := \"abc=\")} {pos_share=} {desc[\"status\"]} {desc[\"exposure_max\"]}')\n```"}, {"role": "assistant", "content": "Let's keep these but adjust the output formatting. That way, we at least keep testing that these don't crash."}], "_meta": {"repo": "psf/black", "pr_number": 4498, "url": "https://github.com/psf/black/pull/4498#discussion_r1812852156"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `handle_ipynb_magics.py`:\n\n```python\n\"ESCAPED_NL\",\n    )\n)\nNON_PYTHON_CELL_MAGICS = frozenset(\nPYTHON_CELL_MAGICS = frozenset(\n    (\n        \"bash\",\n        \"html\",\n        \"javascript\",\n        \"js\",\n        \"latex\",\n        \"markdown\",\n        \"perl\",\n        \"ruby\",\n        \"script\",\n        \"sh\",\n        \"svg\",\n        \"writefile\",\n        \"capture\",\n        \"prun\",\n        \"pypy\",\n        \"python\",\n        \"python2\",\n```"}, {"role": "assistant", "content": "Thanks, removed in https://github.com/psf/black/pull/2630/commits/744820647cc1728d0c4e82e20fcfbeaeb0fd6cad"}], "_meta": {"repo": "psf/black", "pr_number": 2630, "url": "https://github.com/psf/black/pull/2630#discussion_r753361883"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nser_json_inf_nan='null',\n    validate_default=False,\n    validate_return=False,\n    protected_namespaces=('model_',),\n    protected_namespaces=('model_validate', 'model_dump'),\n```"}, {"role": "assistant", "content": "Good question. I've addressed this concern via https://github.com/pydantic/pydantic/pull/10493 - `model_fields` and `model_computed_fields` now follow a pattern such that they can be overridden without internals breaking down.\r\n\r\nWe should get a warning when a field name shadows an attribute in the parent, like:\r\n\r\n```py\r\nfrom pydantic import BaseModel\r\n\r\nclass User(BaseModel):\r\n    id: int\r\n    name: str\r\n    model_fields: list[str]\r\n\r\nuser = User(id=1, name='John Doe', model_fields=['id', 'name'])\r\n\"\"\"\r\n/Users/programming/pydantic_work/pydantic/pydantic/_internal/_fields.py:190: UserWarning: Field name \"model_fields\" in \"User\" shadows an attribute in parent \"BaseModel\"\r\n  warnings.warn(\r\n\"\"\"\r\n```\r\n\r\nThus, I think we don't explicitly need to add these to the protected namespace block."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10441, "url": "https://github.com/pydantic/pydantic/pull/10441#discussion_r1784593415"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_common.py`:\n\n```python\n# Make sure both saved state_dict are identical\n                    self.assertTrue(compare_state_dicts(model.state_dict(), model_reloaded.state_dict()))\n\n    def _text_features_prepare_config_and_inputs(self):\n        config, inputs_dict = self.model_tester.prepare_config_and_inputs_for_common()\n        if hasattr(self.model_tester, \"text_model_tester\"):\n            _, inputs_dict = self.model_tester.text_model_tester.prepare_config_and_inputs_for_common()\n        else:\n            inputs_dict = {\n                key: value\n                for key, value in inputs_dict.items()\n                if key in [\"input_ids\", \"token_type_ids\", \"attention_mask\"]\n            }\n        return config, inputs_dict\n\n    def _image_features_prepare_config_and_inputs(self):\n        config, inputs_dict = self.model_tester.prepare_config_and_inputs_for_common()\n        if hasattr(self.model_tester, \"vision_model_tester\"):\n            _, inputs_dict = self.model_tester.vision_model_tester.prepare_config_and_inputs_for_common()\n        else:\n            inputs_dict = {\n                key: value\n                for key, value in inputs_dict.items()\n                if (\"pixel\" in key or \"image\" in key)\n                and \"video\" not in key\n                or key in [\"spatial_shapes\", \"qformer_input_ids\"]\n            }\n        return config, inputs_dict\n\n    def _audio_features_prepare_config_and_inputs(self):\n        config, inputs_dict = self.model_tester.prepare_config_and_inputs_for_common()\n        if hasattr(self.model_tester, \"audio_model_tester\"):\n            _, inputs_dict = self.model_tester.audio_model_tester.prepare_config_and_inputs_for_common()\n        else:\n            inputs_dict = {\n                key: value\n                for key, value in inputs_dict.items()\n                if \"audio\" in key\n                or \"input_values\" in key\n                or \"input_features\" in key\n                or key in [\"padding_mask\", \"is_longer\", \"feature_attention_mask\"]\n            }\n        return config, inputs_dict\n\n    def _video_features_prepare_config_and_inputs(self):\n        config, inputs_dict = self.model_tester.prepare_config_and_inputs_for_common()\n        if hasattr(self.model_tester, \"video_model_tester\"):\n            _, inputs_dict = self.model_tester.video_model_tester.prepare_config_and_inputs_for_common()\n        else:\n            if \"pixel_values\" in inputs_dict and \"pixel_values_videos\" not in inputs_dict:\n                inputs_dict[\"pixel_values_videos\"] = inputs_dict.pop(\"pixel_values\")\n            if \"image_grid_thw\" in inputs_dict and \"video_grid_thw\" not in inputs_dict:\n                inputs_dict[\"video_grid_thw\"] = inputs_dict.pop(\"image_grid_thw\")\n            if \"image_merge_sizes\" in inputs_dict and \"video_merge_sizes\" not in inputs_dict:\n                inputs_dict[\"video_merge_sizes\"] = inputs_dict.pop(\"image_merge_sizes\")\n```"}, {"role": "assistant", "content": "The test code can definitely be cleaned up, I just worked quickly to spot issues in the implementation and get a working test suite."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2704330948"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deprecate.py`:\n\n```python\nreturn f'{cls.__module__}.{cls.__name__}'\n\n\nDEPRECATION_RULES = [\n    ('scrapy.telnet.', 'scrapy.extensions.telnet.'),\n]\nDEPRECATION_RULES = []\n\n\ndef update_classpath(path):\n```"}, {"role": "assistant", "content": "`update_classpath` is used in the code that parses object dicts such as `DOWNLOADER_MIDDLEWARES`: https://github.com/scrapy/scrapy/blob/45c2bd7d9c1d6adf0e051842c422c5d6af1d0a17/scrapy/utils/conf.py#L15\r\n\r\nI think you can't use `` for this."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5730, "url": "https://github.com/scrapy/scrapy/pull/5730#discussion_r1030298179"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nclass.\n    \"\"\"\n\n    name = None\n    custom_settings = None\n    name: Optional[str] = None\n```"}, {"role": "assistant", "content": "Indeed, it's not supported, that's why the PR is under the Python 3.6+ milestone."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4691, "url": "https://github.com/scrapy/scrapy/pull/4691#discussion_r461527416"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nif isinstance(url, str):\n            self._url = url\n        else:\n            raise TypeError('%s url must be str, got %s:' %\n                            (type(self).__name__, type(url).__name__))\n            raise TypeError(f'{type(self).__name__} url must be str, '\n                            f'got {type(url).__name__}')\n```"}, {"role": "assistant", "content": "Looks like that colon at the end shouldn\u2019t have been there in the first place, so :heavy_check_mark:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4324, "url": "https://github.com/scrapy/scrapy/pull/4324#discussion_r477149547"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_deepspeed.py`:\n\n```python\nself.assertAlmostEqual(no_grad_accum_a, yes_grad_accum_a, delta=1e-4)\n            self.assertAlmostEqual(no_grad_accum_b, yes_grad_accum_b, delta=1e-4)\n        else:\n            self.assertAlmostEqual(no_grad_accum_a, yes_grad_accum_a, places=5)\n            self.assertAlmostEqual(no_grad_accum_b, yes_grad_accum_b, places=5)\n            self.assertAlmostEqual(no_grad_accum_a, yes_grad_accum_a, delta=1e-4)\n            self.assertAlmostEqual(no_grad_accum_b, yes_grad_accum_b, delta=1e-4)\n```"}, {"role": "assistant", "content": "ok, I collapsed the 2 branches into 1 as they are the same."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41925, "url": "https://github.com/huggingface/transformers/pull/41925#discussion_r2495539274"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_glm_image.py`:\n\n```python\ndef test_model_parallelism(self):\n        pass\n\n    @unittest.skip(reason=\"GLM-Image has special image token IDs that get clamped when vocab is resized smaller\")\n    def test_resize_embeddings_untied(self):\n        pass\n\n    @unittest.skip(reason=\"GLM-Image has special image token IDs that get clamped when vocab is resized smaller\")\n    def test_resize_tokens_embeddings(self):\n        pass\n```"}, {"role": "assistant", "content": "we need to assign `image_token_id` to a different token id in that case. It can be done in `GlmImageModelTester`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43342, "url": "https://github.com/huggingface/transformers/pull/43342#discussion_r2732471374"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_validate_call.py`:\n\n```python\nfind_max(1)\n\n\n@pytest.mark.skipif(sys.version_info < (3, 12), reason='requires Python 3.12+ for PEP 695 syntax with generics')\ndef test_pep695_with_class():\n    \"\"\"Primarily to ensure that the syntax is accepted and doesn't raise a NameError.\"\"\"\n\n    for import_annotations in ('from __future__ import annotations', ''):\n        globs = {}\n        exec(\n            f\"\"\"\n{import_annotations}\nfrom pydantic import validate_call\n\nclass A[T]:\n    @validate_call(validate_return=True)\n    def f(self, a: T) -> T:\n        return str(a)\n\n    \"\"\",\n            globs,\n        )\n\n        A = globs['A']\n        a = A[int]()\n        # these two are undesired behavior, but it's what happens now\n        assert a.f(1) == '1'\n        assert a.f('1') == '1'\n\n\n@pytest.mark.skipif(sys.version_info < (3, 12), reason='requires Python 3.12+ for PEP 695 syntax with generics')\ndef test_pep695_with_nested_scopes():\n    \"\"\"Nested scopes generally cannot be caught by `parent_frame_namespace`,\n    so currently this test is expected to fail.\n    \"\"\"\n```"}, {"role": "assistant", "content": "I haven't really seen that module before. I will take a look, thx!"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10380, "url": "https://github.com/pydantic/pydantic/pull/10380#discussion_r1757122771"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `protocol.py`:\n\n```python\ndef _send_pending_requests(self):\n        # TODO: handle MAX_CONCURRENT_STREAMS\n        # Initiate all pending requests\n        for stream in self._pending_request_stream_pool:\n        while len(self._pending_request_stream_pool):\n```"}, {"role": "assistant", "content": ":lipstick: \r\n\r\n```suggestion\r\n        while self._pending_request_stream_pool:\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r441680698"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cookies.py`:\n\n```python\nexpires = time.time() + morsel[\"max-age\"]\n    elif morsel['expires']:\n        expires = morsel['expires']\n        if type(expires) == type(\"\"):\n```"}, {"role": "assistant", "content": "That would be what I would prefer. **But** don't submit a new PR. Simply tack extra commits onto this branch to fix that.\n\nFor testing, we could use mock here but the library doesn't already use it and while we're not as concerned about testing dependencies, it is fine to create the Morsel. It communicates the intent of the function. I would just ask that you break that one test up into 3. You already have the body of that function broken into three paragraphs, they're three different logical tests and should be isolated in three different functions to represent that."}], "_meta": {"repo": "psf/requests", "pr_number": 1772, "url": "https://github.com/psf/requests/pull/1772#discussion_r8050016"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `task.py`:\n\n```python\nstamped_headers = self.request.stamped_headers.copy()\n            stamps = self.request.stamps.copy()\n            stamped_headers.extend(sig.options.get('stamped_headers', []))\n            stamped_headers = list(set(stamped_headers))\n            stamps.update({\n                stamp: value\n                for stamp, value in sig.options.items() if stamp in sig.options.get('stamped_headers', [])\n            })\n            sig.options['stamped_headers'] = stamped_headers\n            sig.options.update(stamps)\n\n            links = sig.options['link'] if 'link' in sig.options else []\n            links.extend(sig.options['link_error'] if 'link_error' in sig.options else [])\n\n            if hasattr(sig, \"tasks\"):\n                tasks = sig.tasks\n                if isinstance(tasks, group):\n```"}, {"role": "assistant", "content": "Your new test cases should cover this. Let's see if the PR tests pass with the new edge cases."}], "_meta": {"repo": "celery/celery", "pr_number": 8034, "url": "https://github.com/celery/celery/pull/8034#discussion_r1090859492"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `vertica.py`:\n\n```python\n@property\n    def sqlalchemy_url(self) -> URL:\n```"}, {"role": "assistant", "content": "I think it will fail `mypy` tests now that we moved to sqlalchemy 2. We need to add typechecking exclusion likely."}], "_meta": {"repo": "apache/airflow", "pr_number": 60177, "url": "https://github.com/apache/airflow/pull/60177#discussion_r2665624752"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_format.py`:\n\n```python\nassert_format(source, expected, mode, fast=False)\n\n\n@pytest.mark.filterwarnings(\"ignore:invalid escape sequence.*:DeprecationWarning\")\n```"}, {"role": "assistant", "content": "or maybe it will just be a warning forever ;) ? https://github.com/python/cpython/issues/77093"}], "_meta": {"repo": "psf/black", "pr_number": 3175, "url": "https://github.com/psf/black/pull/3175#discussion_r922681109"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `testing_utils.py`:\n\n```python\npaths = [self.repo_root_dir_str, self.src_dir_str]\n        if \"/examples\" in self.test_file_dir_str:\n            paths.append(self.examples_dir_str)\n        else:\n            paths.append(self.tests_dir_str)\n        paths.append(env.get(\"PYTHONPATH\", \"\"))\n\n        env[\"PYTHONPATH\"] = \":\".join(paths)\n        return env\n\n    def get_auto_remove_tmp_dir(self, tmp_dir=None, before=None, after=None):\n    def get_auto_remove_tmp_dir(self, tmp_dir=None, before=None, after=None, return_pathlib_obj=False):\n```"}, {"role": "assistant", "content": "this is a really old version. In the latest incarnation it always return a `Path` object. But to keep BC, I added a new flag here instead. The tests are less clunkier then.\r\n\r\nThe latest version is here: https://github.com/stas00/ml-engineering/blob/master/testing/testing_utils.py\r\n\r\nIf wanted you could switch to the latest version instead and adapt tests to simplify."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41832, "url": "https://github.com/huggingface/transformers/pull/41832#discussion_r2467685197"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_utils.py`:\n\n```python\ntransformers_module = direct_transformers_import(Path(__file__).parent)\n\n\nclass _LazyAutoProcessorMapping(dict):\n    \"\"\"\n    Lazy dictionary to avoid circular imports.\n    The mapping names are only imported when accessed.\n    \"\"\"\n\n    _MAPPING_NAMES = {\n        \"image_processor\": (\"transformers.models.auto.image_processing_auto\", \"AutoImageProcessor\"),\n        \"video_processor\": (\"transformers.models.auto.video_processing_auto\", \"AutoVideoProcessor\"),\n        \"feature_extractor\": (\n            \"transformers.models.auto.feature_extraction_auto\",\n            \"AutoFeatureExtractor\",\n        ),\n        \"tokenizer\": (\"transformers.models.auto.tokenization_auto\", \"AutoTokenizer\"),\n    }\n\n    def __getitem__(self, key):\n        if key not in self._MAPPING_NAMES:\n            raise KeyError(key)\n        module_name, attr_name = self._MAPPING_NAMES[key]\n        module = __import__(module_name, fromlist=[attr_name])\n        return getattr(module, attr_name)\n\n    def __contains__(self, key):\n        return key in self._MAPPING_NAMES\n\n    def keys(self):\n        return self._MAPPING_NAMES.keys()\n\n\nMODALITY_TO_AUTOPROCESSOR_MAPPING = _LazyAutoProcessorMapping()\n\nAUTO_TO_BASE_CLASS_MAPPING = {\n    \"AutoTokenizer\": \"PreTrainedTokenizerBase\",\n    \"AutoFeatureExtractor\": \"FeatureExtractionMixin\",\n    \"AutoImageProcessor\": \"ImageProcessingMixin\",\n    \"AutoVideoProcessor\": \"BaseVideoProcessor\",\n    \"audio_tokenizer\": \"DacModel\",\n```"}, {"role": "assistant", "content": "We should be able to use `AutoModelForAudioTokenization`, no? https://github.com/huggingface/transformers/blob/e20df45bf676d80bdddb9757eeeafe6c0c81ecfa/src/transformers/models/auto/modeling_auto.py#L2248-L2249\r\nWe want to standardize this in the future for other models as well"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41633, "url": "https://github.com/huggingface/transformers/pull/41633#discussion_r2433466037"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nself._content = b\"\".join(self.iter_bytes())\n        return self._content\n\n    def iter_bytes(self) -> typing.Iterator[bytes]:\n    def iter_bytes(self, chunk_size: int = None) -> typing.Iterator[bytes]:\n```"}, {"role": "assistant", "content": "In this PR, when `chunk_size=None` we just return the input `content` unchanged, as one single big chunk.\r\n\r\nYes, this would deviate from what Requests seems to do, but:\r\n\r\n- Setting a non-`None` default would break backward compatibility on our side.\r\n- Defaulting to \"transparently pass the chunk sent by the server\" is probably the most reasonable approach _anyway_.\r\n\r\nThat said, we'd need to add this deviation from Requests to the compatibility guide. :+1:"}], "_meta": {"repo": "encode/httpx", "pr_number": 1277, "url": "https://github.com/encode/httpx/pull/1277#discussion_r502757453"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `display.py`:\n\n```python\n\"\"\"\n\nimport sys\nfrom platform import version\nfrom packaging.version import parse\nfrom pprint import pformat as pformat_\n\n\ndef _colorize(text, colorize=True):\n    if not colorize or not sys.stdout.isatty():\n        return text\n    try:\n        import pygments.util\n        from pygments.formatters import get_formatter_by_name\n        from pygments import highlight\n        from pygments.formatters import TerminalFormatter\n        from pygments.lexers import PythonLexer\n        return highlight(text, PythonLexer(), TerminalFormatter())\n    except ImportError:\n        return text\n\n    \"\"\"\n    All Windows versions >= \"10.0.14393\" interpret ANSI escape sequences\n    using terminal processing.\n\n    Enable enivornment variable `ENABLE_VIRTUAL_TERMINAL_PROCESSING`\n    to activate terminal processing.\n    \"\"\"\n    if sys.platform == \"win32\" and parse(version()) >= parse(\"10.0.14393\"):\n        import ctypes\n        kernel32 = ctypes.windll.kernel32\n        kernel32.SetConsoleMode(kernel32.GetStdHandle(-11), 7)\n        # set `ENABLE_VIRTUAL_TERMINAL_PROCESSING` flag\n    colors = color_support_info()\n    if colors == 256:\n        format_options = {'style': 'default'}\n    else:\n        format_options = {'bg': 'dark'}\n    format_alias = 'terminal256' if colors == 256 else 'terminal'\n```"}, {"role": "assistant", "content": ":lipstick:\r\n```suggestion\r\n    if color_support_info() == 256:\r\n        format_alias = 'terminal256'\r\n        format_options = {'style': 'default'}\r\n    else:\r\n        format_alias = 'terminal'\r\n        format_options = {'bg': 'dark'}\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4403, "url": "https://github.com/scrapy/scrapy/pull/4403#discussion_r399684264"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_apertus.py`:\n\n```python\nself.use_cache = use_cache\n        self.attention_bias = attention_bias\n        self.attention_dropout = attention_dropout\n\n        # Try to set `rope_scaling` if available, otherwise use `rope_parameters`\n        rope_scaling = kwargs.pop(\"rope_scaling\", None)\n        self.rope_parameters = rope_scaling or rope_parameters\n        rope_parameters = rope_scaling or rope_parameters\n        self.rope_parameters = rope_parameters if rope_parameters is not None else {}\n\n        # Validate the correctness of rotary position embeddings parameters\n        rope_theta = kwargs.get(\"rope_theta\", 12000000.0)\n        standardize_rope_params(self, rope_theta=rope_theta)\n        rope_config_validation(self)\n        if \"rope_theta\" not in self.rope_parameters:\n            self.rope_parameters[\"rope_theta\"] = kwargs.pop(\"rope_theta\", 12000000.0)\n        rope_config_standardize_and_validate(self)\n```"}, {"role": "assistant", "content": "We can have a RopeConfigMixin, PreTrainedConfig can inherit from it or something -> isolate rope stuff but they are stil common"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42255, "url": "https://github.com/huggingface/transformers/pull/42255#discussion_r2569250135"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `providers_manager_runtime.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n\"\"\"Manages runtime provider resources for task execution.\"\"\"\n\nfrom __future__ import annotations\n\nimport functools\nimport inspect\nimport logging\nimport traceback\nimport warnings\nfrom collections.abc import Callable, MutableMapping\nfrom typing import TYPE_CHECKING, Any\nfrom urllib.parse import SplitResult\n\nfrom airflow.sdk._shared.module_loading import import_string\nfrom airflow.sdk._shared.providers_discovery import (\n    KNOWN_UNHANDLED_OPTIONAL_FEATURE_ERRORS,\n    HookClassProvider,\n    HookInfo,\n    LazyDictWithCache,\n    PluginInfo,\n    ProviderInfo,\n    _check_builtin_provider_prefix,\n    _create_provider_info_schema_validator,\n    discover_all_providers_from_packages,\n    log_import_warning,\n    log_optional_feature_disabled,\n    provider_info_cache,\n)\nfrom airflow.sdk.definitions._internal.logging_mixin import LoggingMixin\nfrom airflow.sdk.exceptions import AirflowOptionalProviderFeatureException\n\nif TYPE_CHECKING:\n    from airflow.sdk import BaseHook\n    from airflow.sdk.bases.decorator import TaskDecorator\n    from airflow.sdk.definitions.asset import Asset\n\nlog = logging.getLogger(__name__)\n```"}, {"role": "assistant", "content": "```suggestion\r\nlog = structlog.getLogger(__name__)\r\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60218, "url": "https://github.com/apache/airflow/pull/60218#discussion_r2693773347"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_apertus.py`:\n\n```python\ndel self.mlp_bias\n        del self.head_dim\n\n        # Validate the correctness of rotary position embeddings parameters\n        rope_theta = kwargs.get(\"rope_theta\", 12000000.0)\n        standardize_rope_params(self, rope_theta=rope_theta)\n        rope_config_validation(self)\n```"}, {"role": "assistant", "content": "Ahh, I think it is better to standardize right away and let people obtain `config.rope_parameters` in correct format"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39847, "url": "https://github.com/huggingface/transformers/pull/39847#discussion_r2435838315"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_emu3.py`:\n\n```python\n]\n        image_features = self.get_input_embeddings()(image_tokens)\n        image_features = torch.split(image_features, split_sizes)\n        # NOTE: @Tom Not easily converted to the standard format\n```"}, {"role": "assistant", "content": "In terms of shape, they would match and have the same hidden dim as text. Maybe I am nitty-picking, just curious about theoretical correctness because in other models we're outputting `last_hidden_states` before alignment, i.e. before pooling/projection/etc layers\r\n\r\nIn VQ models the quantizer serves as a substitute for modality alignment imo, and the `image_features` are thus equivalent of `pooled_outputs` in other VLMs"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2588656413"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_commands.py`:\n\n```python\nspider_filename = 'myspider.pyw'\n\n    def setUp(self):\n        if platform != 'win32':\n            raise unittest.SkipTest(\".pyw file extension only supported in Windows\")\n        super(WindowsRunSpiderCommandTest, self).setUp()\n\n    if platform != 'win32':\n        def test_run_good_spider(self):\n            raise unittest.SkipTest(\"Windows required\")\n\n        def test_runspider(self):\n            raise unittest.SkipTest(\"Windows required\")\n\n        def test_runspider_dnscache_disabled(self):\n            raise unittest.SkipTest(\"Windows required\")\n\n        def test_runspider_log_level(self):\n            raise unittest.SkipTest(\"Windows required\")\n\n        def test_runspider_log_short_names(self):\n            raise unittest.SkipTest(\"Windows required\")\n\n        def test_runspider_no_spider_found(self):\n            raise unittest.SkipTest(\"Windows required\")\n```"}, {"role": "assistant", "content": "I think it would be better to use `` instead, in each method, and have their implementation be `super().<method_name>()`.\r\n\r\nIn any case, do all of those test fail on Linux?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4646, "url": "https://github.com/scrapy/scrapy/pull/4646#discussion_r448932519"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `python.py`:\n\n```python\nreturn cls(*_parse_version_info(result.strip()))\n\n\nclass PythonOperator(BaseOperator):\nclass PythonOperator(BaseAsyncOperator):\n```"}, {"role": "assistant", "content": "The do automatically as they inherit from PythonOperator which is an async operator by default.  The BaseBranchOperator operator should not be async."}], "_meta": {"repo": "apache/airflow", "pr_number": 59087, "url": "https://github.com/apache/airflow/pull/59087#discussion_r2672994103"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scheduler.py`:\n\n```python\nFactory method, initializes the scheduler with arguments taken from the crawl settings\n        \"\"\"\n        dupefilter_cls = load_object(crawler.settings[\"DUPEFILTER_CLASS\"])\n        if crawler is not None:\n```"}, {"role": "assistant", "content": "Many of those checks seem unneeded but some of them, like this one (and especially a check for `self` later) are definitely unneeded."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6169, "url": "https://github.com/scrapy/scrapy/pull/6169#discussion_r1419680973"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\n`report` is where output about exclusions goes.\n    \"\"\"\n\n    def is_ignored(\n```"}, {"role": "assistant", "content": "Using a nested function allows me to short-circuit if a match is found and break the outer loop (`for child in paths:`) with its result. Using `continue` in an inner loop just jumps to the next iteration in that loop. Using `break` might help, but how to know if there was actually a match or not (breaking because `relative_path is None` or because there was a match)? I think that using a nested function makes it easier to read/understand."}], "_meta": {"repo": "psf/black", "pr_number": 3338, "url": "https://github.com/psf/black/pull/3338#discussion_r1006124768"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_gemma3n.py`:\n\n```python\npast_key_values: Optional[Cache] = None,\n        inputs_embeds: Optional[torch.FloatTensor] = None,\n        use_cache: Optional[bool] = None,\n        output_attentions: Optional[bool] = None,\n        output_hidden_states: Optional[bool] = None,\n        cache_position: Optional[torch.LongTensor] = None,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> BaseModelOutputWithPast:\n        r\"\"\"\n        per_layer_inputs (torch.Tensor, *optional*, defaults to None):\n            Pre-computed per-layer embeddings. If None, they are derived from input_ids if provided.\n        \"\"\"\n        output_attentions = output_attentions if output_attentions is not None else self.config.output_attentions\n        output_hidden_states = (\n            output_hidden_states if output_hidden_states is not None else self.config.output_hidden_states\n        )\n        use_cache = use_cache if use_cache is not None else self.config.use_cache\n\n        if (input_ids is None) ^ (inputs_embeds is not None):\n            raise ValueError(\"You must specify exactly one of input_ids or inputs_embeds\")\n\n        if self.gradient_checkpointing and self.training and use_cache:\n            logger.warning_once(\n                \"`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.\"\n            )\n            use_cache = False\n\n        if input_ids is not None:\n            inputs_embeds = self.embed_tokens(input_ids)\n            per_layer_inputs = self.get_per_layer_inputs(input_ids)\n\n        per_layer_inputs = self.project_per_layer_inputs(inputs_embeds, per_layer_inputs)\n\n        if use_cache and past_key_values is None and not self.training:\n        if use_cache and past_key_values is None:\n            past_key_values = DynamicCache(config=self.config)\n\n        if cache_position is None:\n            past_seen_tokens = past_key_values.get_seq_length() if past_key_values is not None else 0\n            cache_position = torch.arange(\n                past_seen_tokens,\n                past_seen_tokens + inputs_embeds.shape[1],\n                device=inputs_embeds.device,\n            )\n            cache_position = torch.arange(inputs_embeds.shape[1], device=inputs_embeds.device) + past_seen_tokens\n```"}, {"role": "assistant", "content": "Yeah apparently `arange` sync by calling `.item` if a tensor on-device is passed to it.... \ud83e\udee0\ud83e\udee0\ud83d\ude43\ud83d\ude43"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42586, "url": "https://github.com/huggingface/transformers/pull/42586#discussion_r2585940510"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_responses.py`:\n\n```python\nheaders = {\"Content-Length\": \"8\"}\n    response = httpx.Response(200, content=content(), headers=headers)\n    assert response.headers == {\"Content-Length\": \"8\"}\n\n\ndef test_response_picklable():\n    response = httpx.Response(\n        200,\n        content=b\"Hello, world!\",\n        request=httpx.Request(\"GET\", \"https://example.org\"),\n    )\n    pickle_response = pickle.loads(pickle.dumps(response))\n    assert pickle_response.is_closed is True\n    assert pickle_response.is_stream_consumed is True\n    assert pickle_response.next_request is None\n    assert pickle_response.stream is not None\n    assert pickle_response.content == b\"Hello, world!\"\n    assert pickle_response.status_code == 200\n    assert pickle_response.request.url == response.request.url\n    assert pickle_response.extensions == {}\n    assert pickle_response.history == []\n\n\n@pytest.mark.asyncio\nasync def test_response_async_streaming_picklable():\n    response = httpx.Response(200, content=async_streaming_body())\n    pickle_response = pickle.loads(pickle.dumps(response))\n    assert hasattr(pickle_response, \"_content\") is False\n```"}, {"role": "assistant", "content": "I guess testing against public API we probably want something like this instead...\r\n\r\n```python\r\nwith pytest.raises(httpx.ResponseNotRead):\r\n    response.content\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1579, "url": "https://github.com/encode/httpx/pull/1579#discussion_r616497491"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_modernbert.py`:\n\n```python\nDictionary containing the configuration parameters for the RoPE embeddings. The dictionary should contain\n            a value for `rope_theta` and optionally parameters used for scaling in case you want to use RoPE\n            with longer `max_position_embeddings`.\n        local_attention (`int`, *optional*, defaults to 128):\n            The window size for local attention.\n        sliding_window (`int`, *optional*, defaults to 128):\n            The window size for sliding window attention.\n```"}, {"role": "assistant", "content": "This will be breaking, let's add an `attribute_map` instead, e.g. https://github.com/huggingface/transformers/blob/59b9cb06f4a19c6d6601cb3e96c018f170ff6808/src/transformers/models/ernie4_5_moe/configuration_ernie4_5_moe.py#L115"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43030, "url": "https://github.com/huggingface/transformers/pull/43030#discussion_r2673603592"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `fetch_hub_objects_for_ci.py`:\n\n```python\nreturn filename\n\n\ndef parse_hf_url(url):\n    \"\"\"\n    Parse a HuggingFace Hub URL into components for hf_hub_download.\n\n    Returns dict with (repo_id, filename, repo_type, revision) or None if not a HF URL.\n    \"\"\"\n    pattern = r\"https://huggingface\\.co/(datasets/)?([^/]+/[^/]+)/resolve/([^/]+)/(.+)\"\n    match = re.match(pattern, url)\n    if not match:\n        return None\n\n    is_dataset = match.group(1) is not None\n    revision = match.group(3)\n    return {\n        \"repo_id\": match.group(2),\n        \"filename\": match.group(4),\n        \"repo_type\": \"dataset\" if is_dataset else \"model\",\n        \"revision\": revision if revision != \"main\" else None,\n    }\n\n\ndef validate_downloaded_content(filepath):\n    with open(filepath, \"r\") as f:\n        header = f.read(32)\n\n    for bad_sig in [\"<!doctype\", \"<html\", '{\"error', '{\"message']:\n        if header.lower().startswith(bad_sig):\n            raise ValueError(\n                f\"Downloaded file appears to be an HTML error page, not a valid media file. \"\n                f\"This may indicate rate limiting. File starts with: {header[:50]!r}\"\n            )\n\n    file_size = os.path.getsize(filepath)\n    if file_size < 100:\n        raise ValueError(f\"Downloaded file is suspiciously small ({file_size} bytes).\")\n\n    return True\n```"}, {"role": "assistant", "content": "Doing it here means that the CI flags rate limiting immediately, instead of confusing PIL errors somewhere else"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43530, "url": "https://github.com/huggingface/transformers/pull/43530#discussion_r2732837314"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_tutorial001.py`:\n\n```python\nimport importlib\n\nimport pytest\nfrom fastapi.testclient import TestClient\nfrom pytest import MonkeyPatch\n\nfrom ...utils import needs_pydanticv2\nfrom ...utils import needs_pydanticv1, needs_pydanticv2\n\n\n@pytest.fixture(\n    params=[\n        pytest.param(\"tutorial001\", marks=needs_pydanticv2),\n        pytest.param(\"tutorial001_pv1\", marks=needs_pydanticv1),\n    ],\n)\ndef get_app(request: pytest.FixtureRequest):\n    def app_wrapper():\n        mod = importlib.import_module(f\"docs_src.settings.{request.param}\")\n        return mod.app\n\n    return app_wrapper\n```"}, {"role": "assistant", "content": "I think that it is better to monkeypatch `get_app()`, instead of test_settings:\r\n\r\n```python\r\n\r\n.fixture(\r\n    name=\"app\",\r\n    params=[\r\n        pytest.param(\"tutorial001\", marks=needs_pydanticv2),\r\n        pytest.param(\"tutorial001_pv1\", marks=needs_pydanticv1),\r\n    ],\r\n)\r\ndef get_app(request: pytest.FixtureRequest, monkeypatch: MonkeyPatch):\r\n    monkeypatch.setenv(\"ADMIN_EMAIL\", \"admin.com\")\r\n    mod = importlib.import_module(f\"docs_src.settings.{request.param}\")\r\n    return mod.app\r\n\r\n\r\ndef test_settings(app):\r\n    client = TestClient(app)\r\n    response = client.get(\"/info\")\r\n    assert response.status_code == 200, response.text\r\n    assert response.json() == {\r\n        \"app_name\": \"Awesome API\",\r\n        \"admin_email\": \"admin.com\",\r\n        \"items_per_user\": 50,\r\n    }\r\n\r\n```"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 13505, "url": "https://github.com/fastapi/fastapi/pull/13505#discussion_r2005481524"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_generator.py`:\n\n```python\nwith self.assertRaises(email.errors.HeaderWriteError):\n                    message.as_string()\n                with self.assertRaises(email.errors.HeaderWriteError):\n                    message.as_bytes()\n```"}, {"role": "assistant", "content": "Ah, I see, this is the added test.  Yes, this looks fine.\r\n\r\nThat docstring on the test method should be a comment, though (I know that's pre-existing)."}], "_meta": {"repo": "python/cpython", "pr_number": 144126, "url": "https://github.com/python/cpython/pull/144126#discussion_r2714351470"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `spidermw.py`:\n\n```python\ndef _get_mwlist_from_settings(cls, settings: BaseSettings) -> list[Any]:\n        return build_component_list(settings.getwithbase(\"SPIDER_MIDDLEWARES\"))\n\n    def __init__(self, *middlewares: Any) -> None:\n        self._check_deprecated_process_start_requests_use(middlewares)\n        super().__init__(*middlewares)\n\n    def _check_deprecated_process_start_requests_use(\n        self, middlewares: tuple[Any]\n    ) -> None:\n        deprecated_middlewares = [\n            middleware\n            for middleware in middlewares\n            if hasattr(middleware, \"process_start_requests\")\n            and not hasattr(middleware, \"process_start\")\n        ]\n        self._use_start_requests = bool(deprecated_middlewares)\n        if self._use_start_requests:\n            deprecated_middleware_list = \", \".join(\n                global_object_name(middleware.__class__)\n                for middleware in deprecated_middlewares\n            )\n            warn(\n                f\"The following enabled spider middlewares, directly or \"\n                f\"through their parent classes, define the deprecated \"\n                f\"process_start_requests() method: \"\n                f\"{deprecated_middleware_list}. process_start_requests() has \"\n                f\"been deprecated in favor of a new method, process_start(), \"\n                f\"to support asynchronous code execution. \"\n                f\"process_start_requests() will stop being called in a future \"\n                f\"version of Scrapy. If you use Scrapy VERSION or higher \"\n                f\"only, replace process_start_requests() with \"\n                f\"process_start(); note that process_start() is a coroutine \"\n                f\"(async def). If you need to maintain compatibility with \"\n                f\"lower Scrapy versions, when defining \"\n                f\"process_start_requests() in a spider middleware class, \"\n                f\"define process_start() as well. See the release notes of \"\n                f\"Scrapy VERSION for details: \"\n                f\"https://docs.scrapy.org/en/VERSION/news.html\",\n                ScrapyDeprecationWarning,\n            )\n\n    def _add_middleware(self, mw: Any) -> None:\n        super()._add_middleware(mw)\n        if hasattr(mw, \"process_spider_input\"):\n            self.methods[\"process_spider_input\"].append(mw.process_spider_input)\n        if hasattr(mw, \"process_start_requests\"):\n            self.methods[\"process_start_requests\"].appendleft(mw.process_start_requests)\n        if self._use_start_requests:\n            if hasattr(mw, \"process_start_requests\"):\n                self.methods[\"process_start_requests\"].appendleft(\n                    mw.process_start_requests\n                )\n        elif hasattr(mw, \"process_start\"):\n            self.methods[\"process_start\"].appendleft(mw.process_start)\n```"}, {"role": "assistant", "content": "I went for an implementation where you cannot combine new-style and old-style middlewares, but you can mix either with universal. If there are new-style and universal, `process_start` is used. If there are old-style and universal, `process_start_requests` is used. What I had not accounted for was mixing new-style and old-style middlewares (only the equivalent for spider vs middlewares)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6729, "url": "https://github.com/scrapy/scrapy/pull/6729#discussion_r2012302251"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_blt.py`:\n\n```python\n\"attentions\": OutputRecorder(BltSelfAttention, index=1, layer_name=\"local_decoder\"),\n    }\n\n    # Weight initialization is adapted from:\n    # - https://github.com/facebookresearch/blt/blob/main/bytelatent/model/blt.py\n    # - https://github.com/pytorch/torchtitan/blob/main/torchtitan/experiments/transformers_modeling_backend/model/model.py\n    #\n    # Both implementations use truncated normal initialization with std ~ 1 / sqrt(d_model)\n    # (or 1 / sqrt(hidden_dim) for FFN outputs), and unit initialization for normalization layers.\n    # We follow the same scheme here, but expressed in the Transformers APIs.\n\n    @torch.no_grad()\n    def _init_weights(self, module):\n        raise AttributeError(\"No need to inherit it!\")\n        \"\"\"\n        Initialize BLT weights following the original ByteLatentTransformer:\n\n        - All weights are drawn from a truncated normal.\n        - Scale is ~ 1 / sqrt(model_dim) (or 1/sqrt(hidden_dim) for FFN outputs).\n        - Norm layers are set to weight = 1, bias = 0.\n        \"\"\"\n        class_name = module.__class__.__name__\n\n        # Norms: RMSNorm / LayerNorm\n        if isinstance(module, (BltRMSNorm, nn.LayerNorm)) or \"RMSNorm\" in class_name or \"LayerNorm\" in class_name:\n            if getattr(module, \"weight\", None) is not None:\n                module.weight.data.fill_(1.0)\n            if getattr(module, \"bias\", None) is not None:\n                module.bias.data.zero_()\n            return\n```"}, {"role": "assistant", "content": "in `transformers` we enforce the usage of `nn.init` this is otherwise incompatible with our weight loader!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42685, "url": "https://github.com/huggingface/transformers/pull/42685#discussion_r2610699822"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `convert_gpt_oss_weights_to_hf.py`:\n\n```python\nconverter = GptOssConverter(\n        vocab_file=tokenizer_path,\n        model_max_length=None,\n        chat_template=chat_template if instruct else None,\n        chat_template=chat_template,\n    )\n    tokenizer = converter.tokenizer\n    tokenizer.save_pretrained(save_dir)\n\n    if instruct:\n        print(\"Saving chat template...\")\n        chat_template_path = os.path.join(save_dir, \"chat_template.json\")\n        with open(chat_template_path, \"w\") as f:\n            json.dump({\"chat_template\": chat_template}, f, indent=2)\n    print(\"Saving chat template...\")\n    chat_template_path = os.path.join(save_dir, \"chat_template.json\")\n```"}, {"role": "assistant", "content": "We prefer raw `chat_template.jinja` in modern conversions!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42901, "url": "https://github.com/huggingface/transformers/pull/42901#discussion_r2623555880"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_utils_python.py`:\n\n```python\nself.assertEqual(get_func_args(\" \".join, stripself=True), [\"iterable\"])\n\n        if platform.python_implementation() == \"CPython\":\n            # doesn't work on CPython: https://bugs.python.org/issue42785\n            self.assertEqual(get_func_args(operator.itemgetter(2)), [])\n            # Didn't used to work on CPython: https://bugs.python.org/issue42785\n```"}, {"role": "assistant", "content": "I'd rephrase it: https://english.stackexchange.com/questions/8816/whats-the-negation-of-i-used-to-be-surely-not-i-didnt-used-to-be"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6316, "url": "https://github.com/scrapy/scrapy/pull/6316#discussion_r1568452973"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `webclient.py`:\n\n```python\nimport re\nfrom time import time\nfrom urllib.parse import urlparse, urlunparse, urldefrag\n\nfrom twisted.web.http import HTTPClient\n\nfrom twisted.internet import defer\n```"}, {"role": "assistant", "content": "Some import sorting and grouping changes like this one look wrong to me, but I am OK with merging this as an overall improvement, and in a separate pull request introduce a CI job to check these with isort, and include isort into the pre-commit configuration that we may introduce in https://github.com/scrapy/scrapy/pull/5734."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5677, "url": "https://github.com/scrapy/scrapy/pull/5677#discussion_r1032899639"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sessions.py`:\n\n```python\nreturn r\n\n    def merge_environment_settings(self, url, proxies, stream, verify, cert):\n        \"\"\"Checks the environment and merges it with some settings.\"\"\"\n        # Gather clues from the surrounding environment.\n        if self.trust_env:\n            # Set environment's proxies.\n            env_proxies = get_environ_proxies(url) or {}\n            for (k, v) in env_proxies.items():\n                proxies.setdefault(k, v)\n\n            # Look for configuration.\n            if verify is True or verify is None:\n                verify = os.environ.get('REQUESTS_CA_BUNDLE')\n\n            # Curl compatibility.\n            if verify is True or verify is None:\n                verify = os.environ.get('CURL_CA_BUNDLE')\n```"}, {"role": "assistant", "content": "While we're here, these two conditional blocks make me feel a bit uncomfortable. Maybe combine the two? Something like:\n\n``` python\nif verify is True or verify is None:\n    verify = os.environ.get('REQUESTS_CA_BUNDLE') or os.environ.get('CURL_CA_BUNDLE')\n```\n\nObviously there's a line length issue here, but I feel like it's a little cleaner. We'd need to update the commenting too.\n\nI'm not hugely attached to it, what do you think?"}], "_meta": {"repo": "psf/requests", "pr_number": 2178, "url": "https://github.com/psf/requests/pull/2178#discussion_r16632859"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pep_572_py39.py`:\n\n```python\n# We better not remove the parentheses here (since it's a 3.10 feature)\nx[(a := 1)]\nx[(a := 1), (b := 3)]\n\n# don't remove the brackets here, it changes the meaning of the code.\n```"}, {"role": "assistant", "content": "This test seems like the wrong place, it's about PEP 572 (walrus expressions). Maybe move it to one of the `context_managers_*` tests."}], "_meta": {"repo": "psf/black", "pr_number": 4634, "url": "https://github.com/psf/black/pull/4634#discussion_r2022108248"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `display.py`:\n\n```python\n\"\"\"\n\nimport sys\nfrom distutils.version import LooseVersion as parse_version\nfrom platform import version\nfrom pprint import pformat as pformat_\n\n\ndef _colorize(text, colorize=True):\n    if not colorize or not sys.stdout.isatty():\n        return text\n    try:\n        from pygments import highlight\n        from pygments.formatters import TerminalFormatter\n        from pygments import highlight\n        from pygments.lexers import PythonLexer\n        return highlight(text, PythonLexer(), TerminalFormatter())\n    except ImportError:\n        return text\n\n    # All Windows versions >= \"10.0.14393\" interpret ANSI escape sequences\n    # using terminal processing.\n    #\n    # Enable enivornment variable `ENABLE_VIRTUAL_TERMINAL_PROCESSING`\n    # to activate terminal processing.\n    if sys.platform == \"win32\" and parse_version(version()) >= parse_version(\"10.0.14393\"):\n        try:\n            import ctypes\n            kernel32 = ctypes.windll.kernel32\n            handle = kernel32.GetStdHandle(-11)\n            # set `ENABLE_VIRTUAL_TERMINAL_PROCESSING` flag\n            if not kernel32.SetConsoleMode(handle, 7):\n                raise ValueError\n        except ValueError:\n            return text\n```"}, {"role": "assistant", "content": "I have pushed the test code.Please have a look, windows mocking part is failing giving this error `AttributeError: <module 'ctypes' from '/usr/lib/python3.6/ctypes/__init__.py'> does not have the attribute 'windll'\r\n`"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4403, "url": "https://github.com/scrapy/scrapy/pull/4403#discussion_r440223622"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_rope_utils.py`:\n\n```python\nreceived_keys -= {\"type\"}\n            required_keys.add(\"rope_type\")\n\n        optional_keys = optional_keys or set()\n        if \"partial_rotary_factor\" not in optional_keys:\n            optional_keys.add(\"partial_rotary_factor\")\n```"}, {"role": "assistant", "content": "yeah, and a few more models, there are total 7-8 models with partial factor rn"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42513, "url": "https://github.com/huggingface/transformers/pull/42513#discussion_r2598733063"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n# Check minimum required Python version\nif sys.version_info < (3, 5, 2):\n    print(\"Scrapy %s requires Python 3.5.2\" % __version__)\nif sys.version_info < (3, 6):\n    print((\"Scrapy %s requires Python 3.6+\" % __version__).encode())\n```"}, {"role": "assistant", "content": "I needed to do this to get the new test to pass in Python 2.7. It has to do with the fact that we are replacing `sys.stdout` to capture. I figure, being ASCII text, that this should not be a problem. But if we can test the output without having to do this, that would definitely be better.\r\n\r\nI got issues when using StringIO, so I switched to BytesIO. I\u2019ll try cStringIO as mentioned in https://stackoverflow.com/a/1218951/939364, maybe that will work."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4742, "url": "https://github.com/scrapy/scrapy/pull/4742#discussion_r477223743"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_qwen3.py`:\n\n```python\nfrom ...cache_utils import Cache, DynamicCache\nfrom ...generation import GenerationMixin\nfrom ...integrations import use_kernel_forward_from_hub\nfrom ...integrations.hub_kernels import rotary_kernel\n```"}, {"role": "assistant", "content": "I think we need to lazily load the kernel, because here we are loading it before even knowing if the user wants to use kernels or not"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41147, "url": "https://github.com/huggingface/transformers/pull/41147#discussion_r2379354218"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nclass SSLContext(ssl.SSLContext):\n    DEFAULT_CA_BUNDLE_PATH = Path(certifi.where())\n```"}, {"role": "assistant", "content": "Let's keep it, avoid new `certifi.where()` call per instantization."}], "_meta": {"repo": "encode/httpx", "pr_number": 3335, "url": "https://github.com/encode/httpx/pull/3335#discussion_r1791986336"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nfield_name: str | None,\n) -> core_schema.CoreSchema:\n    # This V1 compatibility shim should eventually be removed\n    if not each_item_validators:\n        return schema\n```"}, {"role": "assistant", "content": "```suggestion\r\n\r\n    # fail early if each_item_validators is empty\r\n    if not each_item_validators:\r\n        return schema\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9950, "url": "https://github.com/pydantic/pydantic/pull/9950#discussion_r1689979987"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crawler.py`:\n\n```python\nreactor_class: str = self.settings[\"TWISTED_REACTOR\"]\n        event_loop: str = self.settings[\"ASYNCIO_EVENT_LOOP\"]\n        logged_reactor_info: bool = False\n\n        if self._init_reactor:\n            # this needs to be done after the spider settings are merged,\n            # but before something imports twisted.internet.reactor\n            if reactor_class:\n                install_reactor(reactor_class, event_loop)\n            else:\n                from twisted.internet import reactor  # noqa: F401\n            log_reactor_info()\n\n            if not logged_reactor_info:\n                log_reactor_info()\n                logged_reactor_info = True\n\n        if reactor_class:\n            verify_installed_reactor(reactor_class)\n            if is_asyncio_reactor_installed() and event_loop:\n                verify_installed_asyncio_event_loop(event_loop)\n\n            log_reactor_info()\n```"}, {"role": "assistant", "content": "TBH this logic needs some comments, I wasn't able to understand without spending some time what are the possible code paths here."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6657, "url": "https://github.com/scrapy/scrapy/pull/6657#discussion_r1944313660"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_sam2.py`:\n\n```python\nreturn attn_output, attn_weights\n\n\nclass Sam2TwoWayAttentionBlock(nn.Module):\nclass Sam2TwoWayAttentionBlock(GradientCheckpointingLayer):\n```"}, {"role": "assistant", "content": "All of those were inherited with `GradientCheckpointingLayer` in modular, I suppose to add it. It was not working until now"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43556, "url": "https://github.com/huggingface/transformers/pull/43556#discussion_r2737394263"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scraper.py`:\n\n```python\ndef call_spider(self, result, request, spider):\n        result.request = request\n        # StopDownload exceptions: make the partial response an attribute of the failure\n        if (\n            isinstance(result, Failure)\n            and isinstance(result.value, StopDownload)\n            and hasattr(result.value, \"response\")\n        ):\n            result.response = result.value.response\n            delattr(result.value, \"response\")\n```"}, {"role": "assistant", "content": "No reason in particular, I just didn't think of it. Do you think `del` is more readable than `dellattr`? I don't really have a strong opinion on this."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4559, "url": "https://github.com/scrapy/scrapy/pull/4559#discussion_r427624503"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_granitemoehybrid.py`:\n\n```python\nfrom ...processing_utils import Unpack\nfrom ...utils import TransformersKwargs, auto_docstring, can_return_tuple, logging\nfrom ...utils.generic import check_model_inputs\nfrom ...utils.import_utils import is_causal_conv1d_available, is_mamba_2_ssm_available\nfrom .configuration_granitemoehybrid import GraniteMoeHybridConfig\n\n\nif is_mamba_2_ssm_available():\n    from mamba_ssm.ops.triton.selective_state_update import selective_state_update\n    from mamba_ssm.ops.triton.ssd_combined import mamba_chunk_scan_combined, mamba_split_conv1d_scan_combined\nelse:\n    selective_state_update = None\n\nif is_causal_conv1d_available():\n    from causal_conv1d import causal_conv1d_fn, causal_conv1d_update\nelse:\n    causal_conv1d_update, causal_conv1d_fn = None, None\n```"}, {"role": "assistant", "content": "Ok, no I'm confused: `lazy_load_kernel` only loads a kernel from the hub, no? I.e. we load the respective kernel but have no fallbacks to other implementations. \r\n\r\nWhat I'm referencing is the original packages, i.e. `mamba-ssm` and `causal-conv1d`. Users should be able to use both:\r\n- The kernels from the hub\r\n- The original packages\r\n\r\nMaybe I'm overseeing something, but I don't see a reference to the original ones\r\n\r\nEdit: I see this is possibly https://github.com/huggingface/transformers/blob/fa6ea6e95f2838067d2f64f7987f70c611bd66b1/src/transformers/integrations/hub_kernels.py#L302-L317\r\n\r\nBut aren't we ignoring version restrictions atp, i.e. we hope they have a good enough version of that package?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41540, "url": "https://github.com/huggingface/transformers/pull/41540#discussion_r2534141920"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_granite_speech.py`:\n\n```python\nself.out_mid = nn.Linear(config.output_dim, config.hidden_dim, bias=True)\n        self.num_layers = config.num_layers\n\n    def forward(self, hidden_states: torch.Tensor):\n    @check_model_inputs(tie_last_hidden_states=False)\n```"}, {"role": "assistant", "content": "oh no \ud83d\ude3f Audio models are still under work, makes sense. We can make it a `PreTrainedModel` and add it in auto classes mapping. Though it's not really necessary for this PR imo, ig we can simply remove `check_model_inputs` and let audio team to standardize the models at some point"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2661101491"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_utils.py`:\n\n```python\n_prepare_4d_attention_mask,\n        _prepare_4d_causal_attention_mask,\n    )\n    from transformers.modeling_utils import _find_disjoint, _find_identical\n    from transformers.modeling_utils import (\n        _FLASH_ATTN_KERNEL_FALLBACK,\n        _find_disjoint,\n        _find_identical,\n```"}, {"role": "assistant", "content": "It seems that here is using these two methods."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42803, "url": "https://github.com/huggingface/transformers/pull/42803#discussion_r2617814080"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deadline.py`:\n\n```python\nresource_type, resource_details = _determine_resource()\n\n        return (\n            f\"[{resource_type} Deadline] {resource_details} needed by \"\n            f\"{self.deadline_time} or run: {self.callback}\"\n            f\"[{resource_type} Deadline] \"\n            f\"created at {self.created_at}, \"\n            f\"{resource_details}, \"\n            f\"needed by {self.deadline_time} \"\n            f\"or run: {self.callback.path}({self.callback.kwargs or ''})\"\n```"}, {"role": "assistant", "content": "The callback portion is now handled by its own `__repr__` so I think we should revert this line to `or run: {self.callback}`"}], "_meta": {"repo": "apache/airflow", "pr_number": 58248, "url": "https://github.com/apache/airflow/pull/58248#discussion_r2520735518"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_gemma3.py`:\n\n```python\nrope_scaling = kwargs.pop(\"rope_scaling\", None)\n\n        # Try to set `rope_scaling` if available, otherwise use `rope_parameters`. If we find `rope_parameters`\n        # as arg in the inputs, we can safely assume that it is in the new format. New naming used -> new format\n        # as arg in the inputs and both `sliding_attention` and `full_attention` are present, we can safely assume\n        # that it is in the new format. New naming used -> new format\n        default_rope_params = {\n            \"sliding_attention\": {\"rope_type\": \"default\"},\n            \"full_attention\": {\"rope_type\": \"default\"},\n        }\n        self.rope_parameters = self.rope_parameters if self.rope_parameters is not None else default_rope_params\n        if (\n            self.rope_parameters.get(\"sliding_attention\") is not None\n            and self.rope_parameters.get(\"full_attention\") is not None\n        ):\n            self.rope_parameters = default_rope_params\n```"}, {"role": "assistant", "content": "not really correct because only one key could be present technically, if the `config.layers_types` consists of the same type, for ex all layers are sliding. This happens in tests and Ig those a few might fail now"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43320, "url": "https://github.com/huggingface/transformers/pull/43320#discussion_r2698417684"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_transforms.py`:\n\n```python\nreturn x.float()\n\n\ndef _group_images_by_shape(nested_images, is_nested: bool = False):\n    \"\"\"Helper function to flatten a single level of nested image structures and group by shape.\"\"\"\ndef _group_images_by_shape(nested_images, *paired_inputs, is_nested: bool = False):\n```"}, {"role": "assistant", "content": "I'd prefer to leave variadic args out unless we have no choice!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41393, "url": "https://github.com/huggingface/transformers/pull/41393#discussion_r2413851130"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `auto_docstring.py`:\n\n```python\n\"parakeet\": \"ParakeetCTCConfig\",\n    \"lasr\": \"LasrCTCConfig\",\n    \"wav2vec2-with-lm\": \"Wav2Vec2Config\",\n    \"youtu\": \"YoutuConfig\",\n```"}, {"role": "assistant", "content": "Why is this needed, would like to leave this out if possible"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43166, "url": "https://github.com/huggingface/transformers/pull/43166#discussion_r2728512890"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `consumer.py`:\n\n```python\n# to determine whether connection retries are disabled.\n            retry_disabled = not self.app.conf.broker_connection_retry\n\n            warnings.warn(\n                CPendingDeprecationWarning(\n                    f\"The broker_connection_retry configuration setting will no longer determine\\n\"\n                    f\"whether broker connection retries are made during startup in Celery 6.0 and above.\\n\"\n                    f\"If you wish to retain the existing behavior for retrying connections on startup,\\n\"\n                    f\"you should set broker_connection_retry_on_startup to {self.app.conf.broker_connection_retry}.\")\n            )\n            if retry_disabled:\n                warnings.warn(\n                    CPendingDeprecationWarning(\n                        \"The broker_connection_retry configuration setting will no longer determine\\n\"\n```"}, {"role": "assistant", "content": "You mean with the `{self.app.conf.broker_connection_retry}`? I don't think so, given that I also changed \"retain the existing behavior\" to \"refrain from retrying connections\".\r\nActually, I copied the warning in the doc, I think having the exact same words here and there make a lot of sense\r\n\r\n(Or if you were just talking about the `f` before the `\"`, the linter complained about it being useless given that there's no variables inside anymore)"}], "_meta": {"repo": "celery/celery", "pr_number": 9227, "url": "https://github.com/celery/celery/pull/9227#discussion_r1745042188"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_typing_extra.py`:\n\n```python\nvalue, globalns, localns\n            )\n    except TypeError as e:\n        if not (isinstance(value, typing.ForwardRef) and is_backport_fixable_error(e)):\n            raise\n        try:\n            from eval_type_backport import eval_type_backport\n        except ImportError:\n            raise TypeError(\n                f'You have a type annotation {value.__forward_arg__!r} '\n                f'which makes use of newer typing features than are supported in your version of Python. '\n                f'To handle this error, you should either remove the use of new syntax '\n                f'or install the `eval_type_backport` package.'\n            ) from e\n\n        return eval_type_backport(value, globalns, localns, try_default=False)\n        if isinstance(value, typing.ForwardRef):\n```"}, {"role": "assistant", "content": "I've pushed some changes which I think is the best we can do"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10030, "url": "https://github.com/pydantic/pydantic/pull/10030#discussion_r1701907655"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_otel.py`:\n\n```python\nlog = logging.getLogger(\"integration.otel.test_otel\")\n\n\ndef wait_for_otel_collector(host: str, port: int, timeout: int = 120) -> None:\n    \"\"\"\n    Wait for the OTel collector to be reachable before running tests.\n\n    This prevents flaky test failures caused by transient DNS resolution issues\n    (e.g., 'Temporary failure in name resolution' for breeze-otel-collector).\n\n    Note: If the collector is not reachable after timeout, logs a warning but\n    does not fail - allows tests to run and fail naturally if needed.\n    \"\"\"\n    deadline = time.monotonic() + timeout\n    last_error = None\n    while time.monotonic() < deadline:\n        try:\n            # Test DNS resolution and TCP connectivity\n            sock = socket.create_connection((host, port), timeout=5)\n            sock.close()\n```"}, {"role": "assistant", "content": "Good catch, Henry! Using a context manager is much cleaner. I\u2019ll update the implementation to use with `socket.create_connection` to ensure the socket is always properly closed."}], "_meta": {"repo": "apache/airflow", "pr_number": 61242, "url": "https://github.com/apache/airflow/pull/61242#discussion_r2745688602"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_worker.py`:\n\n```python\nassert initContainers[1][\"name\"] == \"kerberos-init\"\n            assert initContainers[1][\"args\"] == [\"kerberos\", \"-o\"]\n\n    @pytest.mark.parametrize(\n        \"workers_values\",\n        [\n            {\"kerberosInitContainer\": {\"enabled\": True}},\n            {\"celery\": {\"kerberosInitContainer\": {\"enabled\": True}}},\n            {\n                \"kerberosInitContainer\": {\"enabled\": False},\n                \"celery\": {\"kerberosInitContainer\": {\"enabled\": True}},\n            },\n        ],\n    )\n    def test_airflow_kerberos_init_container_celery_values(self, workers_values):\n        \"\"\"Test that workers.celery.kerberosInitContainer configuration works and takes precedence.\"\"\"\n        docs = render_chart(\n            values={\n                \"airflowVersion\": \"2.8.0\",\n                \"workers\": {\n                    **workers_values,\n                    \"celery\": {\n                        **workers_values.get(\"celery\", {}),\n                        \"persistence\": {\"fixPermissions\": True},\n                    },\n                },\n```"}, {"role": "assistant", "content": "```python\r\n\"workers\": workers_values\r\n```\r\n`persistence` is not required for `kerberosInitContainer` to be present"}], "_meta": {"repo": "apache/airflow", "pr_number": 60427, "url": "https://github.com/apache/airflow/pull/60427#discussion_r2696183728"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `video_processing_utils.py`:\n\n```python\nlogger.info(\n                f\"loading configuration file {video_processor_file} from cache at {resolved_video_processor_file}\"\n            )\n\n        # Specific models need the original path for modification in `from_dict`, e.g. see `Ernie 4.5 VL` with fonts\n        kwargs[\"resolved_file_path\"] = final_resolved_file_path\n```"}, {"role": "assistant", "content": "Hmm, the issue is that at the point that the local path is resolved, i.e. we loaded the base video dict, all necessary kwargs are popped to refind the proper file --> offline, cache, from the hub etc. As you said, this could also be subfolders etc. Without this, I would need to pass these kwargs myself afterwards so I can re-resolve the path which is a not so nice looking function :D Meaning this function here https://github.com/huggingface/transformers/blob/6564633bc87b1f808de5773a74db2ec01f681520/src/transformers/video_processing_utils.py#L597\r\n\r\nAnd no, I cannot override this because the auto video processor will be used, always calling the one from the base video processor. So I have no chance to override it myself (without breaking quite a bit of logic that was recently introduced, i.e. use auto classes to load everything). In my original version I overrode this function directly but yea no longer viable (as of now)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39585, "url": "https://github.com/huggingface/transformers/pull/39585#discussion_r2599988717"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\ndef download(self, request: Request, spider: Optional[Spider] = None) -> Deferred:\n        \"\"\"Return a Deferred which fires with a Response as result, only downloader middlewares are applied\"\"\"\n        if spider is None:\n            spider = self.spider\n        else:\n        if spider is not None:\n            warnings.warn(\n                \"Passing a 'spider' argument to ExecutionEngine.download is deprecated\",\n                category=ScrapyDeprecationWarning,\n                stacklevel=2,\n            )\n            if spider is not self.spider:\n                logger.warning(\"The spider '%s' does not match the open spider\", spider.name)\n        if spider is None:\n        if self.spider is None:\n```"}, {"role": "assistant", "content": "For what i understood from PR:\r\n\r\n- #5090 \r\n\r\nThis will be never the case it seems, since the spider instance saved `ExecutionEngine.spider` after calling `open_spider` will be always available, did i get correctly?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5589, "url": "https://github.com/scrapy/scrapy/pull/5589#discussion_r937634799"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_blip_2.py`:\n\n```python\n```\"\"\"\n\n        if self.config.use_decoder_only_language_model:\n            text_outputs: CausalLMOutputWithPast = self.language_model(\n            text_outputs: BaseModelOutputWithPast = self.language_model.base_model(\n                input_ids=input_ids,\n                attention_mask=attention_mask,\n                return_dict=True,\n                **kwargs,\n            )\n        else:\n            inputs_embeds = self.language_model.get_input_embeddings()(input_ids)\n            text_outputs: Seq2SeqLMOutput = self.language_model(\n                inputs_embeds=inputs_embeds,\n            text_outputs: BaseModelOutputWithPastAndCrossAttentions = self.language_model.get_encoder()(\n```"}, {"role": "assistant", "content": "I went with `encoder` as:\r\n```\r\n(Pdb) type(self.language_model)\r\n<class 'transformers.models.t5.modeling_t5.T5ForConditionalGeneration'>\r\n(Pdb) type(self.language_model.base_model)\r\n<class 'transformers.models.t5.modeling_t5.T5ForConditionalGeneration'>\r\n(Pdb) self.language_model.base_model == self.language_model\r\nTrue\r\n```\r\nand then the `decoder_input_ids` can't be None or I'll get `ValueError: You have to specify either decoder_input_ids or decoder_inputs_embeds`. \r\nWhen providing a `decoder_input_ids`, the output becomes `Seq2SeqLMOutput` with `logits`, `past_key_values`, and `encoder_last_hidden_state`. When returning with (a subclass of) `BaseModelOutputWithPooling`, I'd still mostly do\r\n```python\r\n        return BaseModelOutputWithPooling(\r\n            last_hidden_state=text_outputs.encoder_last_hidden_state,\r\n            hidden_states=text_outputs.encoder_hidden_states,\r\n            attentions=text_outputs.encoder_attentions,\r\n        )\r\n```\r\nBut it's a bit messy/arbitrary either way."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2694111369"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\ndef __repr__(self):\n        cls_name = self.__class__.__name__\n        return \"%s(concurrency=%r, delay=%0.2f, randomize_delay=%r)\" % (\n            cls_name, self.concurrency, self.delay, self.randomize_delay)\n        return (f\"{cls_name}(concurrency={self.concurrency!r}, \"\n                f\"delay={self.delay:.2f}, \"\n                f\"randomize_delay={self.randomize_delay!r}\")\n```"}, {"role": "assistant", "content": ", I did not find where this class is tested. Would you please give me some directions to where/how would `__repr__` be tested?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4324, "url": "https://github.com/scrapy/scrapy/pull/4324#discussion_r478661358"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\nraise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')\n\n        def __setattr__(self, name: str, value: Any) -> None:\n            if name in self.__class_vars__:\n            if (fast_memo_handler := self.__pydantic_setattr_handlers__.get(name)) is not None:\n                fast_memo_handler(self, value)\n```"}, {"role": "assistant", "content": "I think the word `fast` in the name of this variable is carrying some weight in terms of documenting what is going on here \u2014\u00a0it doesn't seem to be indicated explicitly that the reason for memoizing the attribute handler is purely for performance and isn't otherwise logically required. I mean, I know we have the docstring of `__pydantic_setattr_handlers__`, but that is far away from the implementing code and still doesn't make it clear that the current logic _only_ makes use of the memoization for performance reasons (and isn't otherwise dependent on the memoization), which may be useful context if we refactor this in the future.\r\n\r\nI don't really mind the word fast in the name, but I think either way we should add a comment here reiterating that the memoization is purely for performance reasons. And if we do, the word fast probably becomes less useful."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10868, "url": "https://github.com/pydantic/pydantic/pull/10868#discussion_r1847174753"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_trainer.py`:\n\n```python\nfinal_model_path = os.path.join(final_checkpoint_path, SAFE_WEIGHTS_NAME)\n        self.assertTrue(os.path.exists(final_model_path), \"Final model checkpoint was not saved!\")\n\n    def test_resume_batch_order(self):\n        \"\"\"\n        Test that verifies dataloader order is reproducible when resuming from partial checkpoints.\n        Tests resuming from checkpoint 7 (within epoch 1).\n        \"\"\"\n\n        # --- Helper classes and functions defined locally for this test ---\n        class DummyDataset(torch.utils.data.Dataset):\n            def __init__(self, size: int = 32):\n                self.size = size\n                self.data = torch.randn((size, 10))\n                self.data[:, 0] = torch.arange(0, size)  # Encode the data order\n                self.labels = torch.randint(0, 10, (size,))\n\n            def __len__(self) -> int:\n                return self.size\n\n            def __getitem__(self, idx: int):\n                return {\"input_ids\": self.data[idx], \"labels\": self.labels[idx]}\n\n        class DummyModel(nn.Module):\n            def __init__(self, size: int):\n                super().__init__()\n                self.fc = nn.Linear(10, 10, bias=False)\n                # data_order logs the order of data points seen by the model\n                self.register_buffer(\"data_order\", torch.empty(0, dtype=torch.long))\n\n            def load_state_dict(self, state_dict, strict=True):\n                # Handle data_order buffer size mismatch during checkpoint loading\n                if \"data_order\" in state_dict:\n                    saved_data_order = state_dict[\"data_order\"]\n                    if hasattr(self, \"data_order\") and self.data_order.shape != saved_data_order.shape:\n                        # Resize the buffer to match the saved state\n                        self.data_order = saved_data_order.clone()\n\n                return super().load_state_dict(state_dict, strict=strict)\n\n            def forward(self, input_ids: torch.Tensor, labels: torch.Tensor = None):\n                logits = self.fc(input_ids)\n                loss = None\n                if labels is not None:\n                    loss_fn = nn.CrossEntropyLoss()\n                    loss = loss_fn(logits, labels)\n\n                # Log the data order for verification\n                data_indices = input_ids[:, 0].int()\n                self.data_order = torch.cat([self.data_order, data_indices.detach().clone()])\n\n                return {\"loss\": loss, \"logits\": logits}\n\n        # Scenario 1: Run baseline training to completion\n        # 1.1 Run training to completion\n        set_seed(42)\n        train_dataset = DummyDataset(size=10)\n        model_baseline = DummyModel(size=10)\n```"}, {"role": "assistant", "content": "I rebased my code on the latests updates I could fetch from main yesterday. \r\n\r\nLet me do it again in a fresh env and a fresh branch directly checked out from current transformers main!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40691, "url": "https://github.com/huggingface/transformers/pull/40691#discussion_r2494153021"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tokenization_mistral_common.py`:\n\n```python\nraise ValueError(_invalid_mode_msg)\n        return mode\n\n    def add_special_tokens(\n        self,\n        special_tokens_dict: dict[str, Union[str, AddedToken, Sequence[Union[str, AddedToken]]]],\n        replace_extra_special_tokens: bool = True,\n    ):\n        r\"\"\"`MistralCommonBackend` does not implement `add_special_tokens`.\"\"\"\n\n        raise NotImplementedError(\"`MistralCommonBackend` does not implement `add_special_tokens`.\")\n\n    def add_tokens(  # type: ignore[override]\n        self,\n        special_tokens_dict: dict[str, Union[str, AddedToken, Sequence[Union[str, AddedToken]]]],\n        replace_extra_special_tokens: bool = True,\n    ):\n        r\"\"\"`MistralCommonBackend` does not implement `add_special_tokens`.\"\"\"\n\n        raise NotImplementedError(\"`MistralCommonBackend` does not implement `add_tokens`.\")\n```"}, {"role": "assistant", "content": "most probably due to having to regex for all special tokens on any string -> to split the string on them!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43143, "url": "https://github.com/huggingface/transformers/pull/43143#discussion_r2671828712"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_urlparse.py`:\n\n```python\n# For 'path' we need to drop ? and # from the GEN_DELIMS set.\n    parsed_path: str = quote(path, safe=SUB_DELIMS + \":/[]@\")\n    # For 'query' we need to drop '#' from the GEN_DELIMS set.\n    # We also exclude '/' because it is more robust to replace it with a percent\n    # encoding despite it not being a requirement of the spec and include '%' to\n    # prevent duplicate encoding of previously quoted items.\n    parsed_query: typing.Optional[str] = (\n        None if query is None else quote(query, safe=SUB_DELIMS + \":/?[]@\")\n        None if query is None else quote(query, safe=SUB_DELIMS + \":?[]@%\")\n```"}, {"role": "assistant", "content": "I'll rephrase: Can you drop that bit from this pull request? It seems unrelated so it'd make sense to consider it separately."}], "_meta": {"repo": "encode/httpx", "pr_number": 2723, "url": "https://github.com/encode/httpx/pull/2723#discussion_r1207742623"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `genspider.py`:\n\n```python\ntry:\n            spidercls = self.crawler_process.spider_loader.load(name)\n        except KeyError:\n            pass\n            if not self.settings.get('NEWSPIDER_MODULE'):\n                if exists(name + \".py\"):\n                    print(\"File %r already exists in the current directory\" % (name + \".py\"))\n                    return\n            else:\n                spiders_module = import_module(self.settings['NEWSPIDER_MODULE'])\n                spiders_dir = dirname(spiders_module.__file__)\n                spiders_dir_abs = abspath(spiders_dir)\n                if exists(join(spiders_dir_abs, name + \".py\")):\n                    print(\"Spider with filename %r already exists in directory:\" % (name + \".py\"))\n                    print(\"  %s\" % spiders_dir)\n```"}, {"role": "assistant", "content": ":lipstick:  I would simplify both messages to \"%r already exists\", where %r is the absolute path of the destination file."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4623, "url": "https://github.com/scrapy/scrapy/pull/4623#discussion_r439863160"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `canvas.py`:\n\n```python\nlast_task_id=None, group_id=None, chord_body=None,\n                      clone=True, from_dict=Signature.from_dict,\n                      group_index=None):\n        \"\"\"Prepare the chain for execution.\n\n        To execute a chain, we first need to unpack it correctly.\n        During the unpacking, we might encounter other chains, groups, or chords,\n        which we need to unpack as well.\n\n        For example:\n        chain(signature1, chain(signature2, signature3)) --> Upgrades to chain(signature1, signature2, signature3)\n        chain(group(signature1, signature2), signature3) --> Upgrades to chord([signature1, signature2], signature3)\n\n        The responsibility of this method is to assure that the chain is\n```"}, {"role": "assistant", "content": "```suggestion\r\n        The responsibility of this method is to ensure that the chain is\r\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 7897, "url": "https://github.com/celery/celery/pull/7897#discussion_r1019136591"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\nline, line_length=mode.line_length, features=features\n            )\n\n        # HACK: functions (like rhs) compiled by mypyc don't retain their __name__\n```"}, {"role": "assistant", "content": "I guess it would be a bigger refactor but I'd like it better if we just stopped using `__name__`."}], "_meta": {"repo": "psf/black", "pr_number": 2431, "url": "https://github.com/psf/black/pull/2431#discussion_r691367047"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `celery.py`:\n\n```python\nos.environ['CELERY_CONFIG_MODULE'] = config\n    if skip_checks:\n        os.environ['CELERY_SKIP_CHECKS'] = 'true'\n    ctx.obj = CLIContext(app=app, no_color=no_color, workdir=workdir,\n\n    try:\n        app_object = find_app(app)\n```"}, {"role": "assistant", "content": "You're absolutely right, ! My bad, sorry. \ud83d\ude48 \r\n\r\n* Tentative fix at https://github.com/celery/celery/pull/9426"}], "_meta": {"repo": "celery/celery", "pr_number": 9361, "url": "https://github.com/celery/celery/pull/9361#discussion_r1851284312"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nSee documentation in docs/topics/loaders.rst\n\"\"\"\nfrom collections import defaultdict\nfrom contextlib import suppress\n\nfrom itemadapter import ItemAdapter\nimport itemloaders\n\nfrom scrapy.item import Item\nfrom scrapy.loader.common import wrap_loader_context\nfrom scrapy.loader.processors import Identity\nfrom scrapy.selector import Selector\nfrom scrapy.utils.misc import arg_to_iter, extract_regex\nfrom scrapy.utils.python import flatten\n\n\ndef unbound_method(method):\n    \"\"\"\n    Allow to use single-argument functions as input or output processors\n    (no need to define an unused first 'self' argument)\nclass ItemLoader(itemloaders.ItemLoader):\n    \"\"\"\n    with suppress(AttributeError):\n        if '.' not in method.__qualname__:\n            return method.__func__\n    return method\n    A user-fiendly abstraction to populate data to an :ref:`Item <topics-items>`\n    by applying :ref:`field processors <topics-loaders-processors>` to scraped data.\n    When instantiated with a ``selector`` or a ``response`` it supports\n    data extraction from web pages using :ref:`selectors <topics-selectors>`.\n\n    :param item: The item instance to populate using subsequent calls to\n        :meth:`~ItemLoader.add_xpath`, :meth:`~ItemLoader.add_css`,\n        or :meth:`~ItemLoader.add_value`.\n    :type item: :class:`~scrapy.item.Item` object\n\n    :param selector: The selector to extract data from, when using the\n        :meth:`add_xpath` (resp. :meth:`add_css`) or :meth:`replace_xpath`\n        (resp. :meth:`replace_css`) method.\n    :type selector: :class:`~scrapy.selector.Selector` object\n\n    :param response: The response used to construct the selector using the\n        :attr:`default_selector_class`, unless the selector argument is given,\n        in which case this argument is ignored.\n    :type response: :class:`~scrapy.http.Response` object\n\n    If no item is given, one is instantiated automatically using the class in\n    :attr:`default_item_class`.\n    The item, selector, response and the remaining keyword arguments are\n    assigned to the Loader context (accessible through the :attr:`context` attribute).\n\n    .. attribute:: item\n\n        The item object being parsed by this Item Loader.\n        This is mostly used as a property so when attempting to override this\n```"}, {"role": "assistant", "content": "```suggestion\r\n        This is mostly used as a property so, when attempting to override this\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4516, "url": "https://github.com/scrapy/scrapy/pull/4516#discussion_r450090500"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\n):\n        store_uri = _to_string(store_uri)\n        if not store_uri:\n            raise NotConfigured\n            setting_name = (\n                \"IMAGES_STORE\"\n                if self.__class__.__name__ == \"ImagesPipeline\"\n                else \"FILES_STORE\"\n            )\n            raise NotConfigured(\n```"}, {"role": "assistant", "content": "I have updated the check to handle that None case."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6969, "url": "https://github.com/scrapy/scrapy/pull/6969#discussion_r2236950579"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nsrc_ast = parse_ast(src)\n    except Exception as exc:\n        raise AssertionError(\n            f\"cannot use --safe with this file; failed to parse source file: {exc}\"\n            f\"cannot use --safe with this file; failed to parse source file AST: {exc}\"\n            f\"This could be caused by running black with an older python version \"\n            f\"that does not support new syntax used in your source file.\"\n```"}, {"role": "assistant", "content": "I agree it isn't ideal.\r\nThat is more than I can take on at this time though(Covid/childcare problems)."}], "_meta": {"repo": "psf/black", "pr_number": 2786, "url": "https://github.com/psf/black/pull/2786#discussion_r788815493"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `convert_colqwen2_weights_to_hf.py`:\n\n```python\npush_to_hub: bool,\n    revision: Optional[str] = None,\n    original_vlm_name_or_path: Optional[str] = None,\n    using_qwen2_5=False,\n```"}, {"role": "assistant", "content": "Let's keep this argument name consistent across different files so `use_qwen2_5` instead of `using_qwen2_5`."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40600, "url": "https://github.com/huggingface/transformers/pull/40600#discussion_r2314475329"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_form_default.py`:\n\n```python\nfrom typing import Optional\n\nfrom fastapi import FastAPI, File, Form\nfrom starlette.testclient import TestClient\nfrom typing_extensions import Annotated\n\napp = FastAPI()\nclient = TestClient(app)\n\n\n@app.post(\"/urlencoded\")\nasync def post_url_encoded(age: Annotated[Optional[int], Form()] = None):\n    return age\n\n\ndef test_form_default_url_encoded():\n    response = client.post(\"/urlencoded\", data={\"age\": \"\"})\n    assert response.status_code == 200\n    assert response.text == \"null\"\n```"}, {"role": "assistant", "content": "This looks odd to me.\r\nIf you pass a string to an integer field, I would expect a `4xx` error code."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 13537, "url": "https://github.com/fastapi/fastapi/pull/13537#discussion_r2076095083"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_auto.py`:\n\n```python\nif \"AutoProcessor\" in config_dict.get(\"auto_map\", {}):\n                        processor_auto_map = config_dict[\"auto_map\"][\"AutoProcessor\"]\n\n            # Saved as feature extractor\n            if preprocessor_config_file is None:\n                preprocessor_config_file = cached_file(\n                    pretrained_model_name_or_path, FEATURE_EXTRACTOR_NAME, **cached_file_kwargs\n                )\n                if preprocessor_config_file is not None and processor_class is None:\n                    config_dict, _ = FeatureExtractionMixin.get_feature_extractor_dict(\n                        pretrained_model_name_or_path, **kwargs\n                    )\n                    processor_class = config_dict.get(\"processor_class\", None)\n                    if \"AutoProcessor\" in config_dict.get(\"auto_map\", {}):\n                        processor_auto_map = config_dict[\"auto_map\"][\"AutoProcessor\"]\n```"}, {"role": "assistant", "content": "I removed this because it is actually never used unless I missed something. It's already called here:\r\nhttps://github.com/huggingface/transformers/blob/f77950605e2f2f27613b829559b133c2b9fd8912/src/transformers/models/auto/processing_auto.py#L297-L304\r\nand if we `preprocessor_config_file` is None above, it will be None here as well. If it's not None, then we'll never enter the code path I removed. So it seems like dead code"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42402, "url": "https://github.com/huggingface/transformers/pull/42402#discussion_r2565435780"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asynchronous.py`:\n\n```python\nfrom celery.exceptions import TimeoutError\nfrom celery.utils.threads import THREAD_TIMEOUT_MAX\n\nE_CELERY_RESTART_REQUIRED = \"\"\"\nCelery must be restarted because a shutdown signal was detected.\n\"\"\"\n```"}, {"role": "assistant", "content": "The `E_CELERY_RESTART_REQUIRED` constant starts with a leading newline, which will produce an empty first line in the error output; remove the leading newline for cleaner messages.\n```suggestion\nE_CELERY_RESTART_REQUIRED = \"Celery must be restarted because a shutdown signal was detected.\"\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 9371, "url": "https://github.com/celery/celery/pull/9371#discussion_r2196800690"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_decorators.py`:\n\n```python\nreturn func\n\n\ndef get_function_return_type(\n    func: Any,\n    explicit_return_type: Any,\n_function_like = (\n    partial,\n    partialmethod,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.MethodType,\n    types.WrapperDescriptorType,\n    types.MethodWrapperType,\n    types.MemberDescriptorType,\n)\n\n\ndef get_callable_return_type(\n    callable_obj: Any,\n    globalns: GlobalsNamespace | None = None,\n    localns: MappingNamespace | None = None,\n) -> Any:\n    \"\"\"Get the function return type.\n\n    It gets the return type from the type annotation if `explicit_return_type` is `None`.\n    Otherwise, it returns `explicit_return_type`.\n) -> Any | PydanticUndefinedType:\n    \"\"\"Get the callable return type.\n\n    Args:\n        func: The function to get its return type.\n        explicit_return_type: The explicit return type.\n        callable_obj: The callable to analyze.\n        globalns: The globals namespace to use during type annotation evaluation.\n        localns: The locals namespace to use during type annotation evaluation.\n\n    Returns:\n        The function return type.\n```"}, {"role": "assistant", "content": "Can we add more detail here now that we return `| PydanticUndefinedType` as well"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11451, "url": "https://github.com/pydantic/pydantic/pull/11451#discussion_r1960493561"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `snapshot.py`:\n\n```python\nfrom __future__ import annotations\n\nimport difflib\nimport logging\nimport re\nimport subprocess\nfrom pathlib import Path\nfrom typing import Mapping, NamedTuple\n\nfrom benchmark import Command\n\n\ndef normalize_output(output: str, cwd: Path) -> str:\n    \"\"\"Normalize output by replacing absolute paths with relative placeholders.\"\"\"\n\n    # Replace absolute paths with <CWD>/relative/path.\n    # This handles both the cwd itself and any paths within it.\n    cwd_str = str(cwd.resolve())\n    normalized = output.replace(cwd_str, \"<CWD>\")\n\n    # Replace temp directory patterns (e.g., /var/folders/.../tmp123abc/).\n    # Match common temp directory patterns across platforms.\n    normalized = re.sub(\n        r\"/(?:var/folders|tmp)/[a-zA-Z0-9/_-]+/tmp[a-zA-Z0-9]+\",\n        \"<TMPDIR>\",\n        normalized,\n    )\n\n    # Normalize unordered lists in error messages (e.g., '\"name\", \"description\"' vs '\"description\", \"name\"').\n    # Sort quoted comma-separated items to make them deterministic.\n    def sort_quoted_items(match):\n        items = match.group(0)\n        quoted_items = re.findall(r'\"[^\"]+\"', items)\n        if len(quoted_items) > 1:\n            sorted_items = \", \".join(sorted(quoted_items))\n            return sorted_items\n        return items\n\n    normalized = re.sub(r'\"[^\"]+\"(?:, \"[^\"]+\")+', sort_quoted_items, normalized)\n\n    return normalized\n\n\nclass SnapshotRunner(NamedTuple):\n    name: str\n    \"\"\"The benchmark to run.\"\"\"\n\n    commands: list[Command]\n    \"\"\"The commands to snapshot.\"\"\"\n\n    snapshot_dir: Path\n    \"\"\"Directory to store snapshots.\"\"\"\n\n    accept: bool\n    \"\"\"Whether to accept snapshot changes.\"\"\"\n\n    def run(self, *, cwd: Path, env: Mapping[str, str] = dict()):\n        \"\"\"Run commands and snapshot their output.\"\"\"\n        # Create snapshot directory if it doesn't exist.\n        self.snapshot_dir.mkdir(parents=True, exist_ok=True)\n```"}, {"role": "assistant", "content": "```suggestion\r\n    def run(self, *, cwd: Path, env: Mapping[str, str] | None = None):\r\n        \"\"\"Run commands and snapshot their output.\"\"\"\r\n        env = env or {}\r\n        \r\n        # Create snapshot directory if it doesn't exist.\r\n        self.snapshot_dir.mkdir(parents=True, exist_ok=True)\r\n```"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 21536, "url": "https://github.com/astral-sh/ruff/pull/21536#discussion_r2547148661"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_api.py`:\n\n```python\nauth: AuthTypes | None = None,\n    proxy: ProxyTypes | None = None,\n    follow_redirects: bool = False,\n    cert: CertTypes | None = None,\n    verify: VerifyTypes = True,\n    ssl_context: typing.Optional[ssl.SSLContext] = None,\n```"}, {"role": "assistant", "content": "```suggestion\r\n    ssl_context: ssl.SSLContext | None = None,\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 3022, "url": "https://github.com/encode/httpx/pull/3022#discussion_r1790227449"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test.py`:\n\n```python\n# Set by default settings that prevent deprecation warnings.\n    settings: Dict[str, Any] = {}\n    if prevent_warnings:\n        settings[\"REQUEST_FINGERPRINTER_IMPLEMENTATION\"] = \"2.7\"\n        pass\n```"}, {"role": "assistant", "content": "Seems that work as well, local pre-commit pass, just pushed. cc:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6213, "url": "https://github.com/scrapy/scrapy/pull/6213#discussion_r1473100710"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_ggml.py`:\n\n```python\nEXPECTED_TEXT = \"Hello, I am interested in [The Park]\\nThe\"\n        self.assertEqual(tokenizer.decode(out[0], skip_special_tokens=True), EXPECTED_TEXT)\n\n    def test_t5_q8_0(self):\n        tokenizer = AutoTokenizer.from_pretrained(self.t5_model_id, gguf_file=self.q8_0_t5_model_id)\n        model = AutoModelForSeq2SeqLM.from_pretrained(\n            self.t5_model_id, gguf_file=self.q8_0_t5_model_id, device_map=\"auto\", torch_dtype=torch.float16\n        )\n\n        T5_EXAMPLE_TEXT = \"translate English to German: How old are you?\"\n\n        text = tokenizer(T5_EXAMPLE_TEXT, return_tensors=\"pt\").to(torch_device)\n        out = model.generate(**text, max_new_tokens=10)\n\n        EXPECTED_TEXT = \"Wie ich er?\"\n        self.assertEqual(tokenizer.decode(out[0], skip_special_tokens=True), EXPECTED_TEXT)\n```"}, {"role": "assistant", "content": "Sure! I just added fp16 test and weights conversion test!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 33389, "url": "https://github.com/huggingface/transformers/pull/33389#discussion_r1786003082"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\n}\n\n\n# TODO V3: this function is only used for deprecated decorators. It should\n# be removed once we drop support for those.\n```"}, {"role": "assistant", "content": "Looks like this is also used in some other places in the file - just wanted to make sure you were aware of that..."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10094, "url": "https://github.com/pydantic/pydantic/pull/10094#discussion_r1726137249"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `video_processing_auto.py`:\n\n```python\n(\"video_llava\", \"VideoLlavaVideoProcessor\"),\n            (\"videomae\", \"VideoMAEVideoProcessor\"),\n            (\"vjepa2\", \"VJEPA2VideoProcessor\"),\n            (\"video_llama_3\", \"VideoLlama3VideoProcessor\"),  # PLACEHOLDER - needs proper video processor class\n```"}, {"role": "assistant", "content": "we have it already, no?\n\nhttps://github.com/huggingface/transformers/blob/main/src/transformers/models/video_llama_3/video_processing_video_llama_3.py"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41633, "url": "https://github.com/huggingface/transformers/pull/41633#discussion_r2435172644"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\ndef _get_slot(self, request, spider):\n        key = self._get_slot_key(request, spider)\n        if key not in self.slots:\n            conc = self.ip_concurrency if self.ip_concurrency else self.domain_concurrency\n            conc = self.per_slot_settings.get(key, {}).get('concurrency', self.ip_concurrency if self.ip_concurrency else self.domain_concurrency)\n            conc, delay = _get_concurrency_delay(conc, spider, self.settings)\n            self.slots[key] = Slot(conc, delay, self.randomize_delay)\n            delay = self.per_slot_settings.get(key, {}).get('delay', delay)\n            randomize_delay = self.per_slot_settings.get(key, {}).get('randomize_delay', self.randomize_delay)\n            new_slot = Slot(conc, delay, randomize_delay)\n            self.slots[key] = new_slot\n            logger.debug(\n                f\"Downloader slot '{key}' - created {'(from per slot settings)' if key in self.per_slot_settings.keys() else ''}: {new_slot}\")\n```"}, {"role": "assistant", "content": "I understand this may have helped while implementing this feature, but I am not sure we should keep these debug messages around.\r\n\r\nSame for the message below."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5328, "url": "https://github.com/scrapy/scrapy/pull/5328#discussion_r755559874"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_auto.py`:\n\n```python\nif \"AutoProcessor\" in config_dict.get(\"auto_map\", {}):\n                        processor_auto_map = config_dict[\"auto_map\"][\"AutoProcessor\"]\n\n            # Saved as feature extractor\n            if preprocessor_config_file is None:\n                preprocessor_config_file = cached_file(\n                    pretrained_model_name_or_path, FEATURE_EXTRACTOR_NAME, **cached_file_kwargs\n                )\n                if preprocessor_config_file is not None and processor_class is None:\n                    config_dict, _ = FeatureExtractionMixin.get_feature_extractor_dict(\n                        pretrained_model_name_or_path, **kwargs\n                    )\n                    processor_class = config_dict.get(\"processor_class\", None)\n                    if \"AutoProcessor\" in config_dict.get(\"auto_map\", {}):\n                        processor_auto_map = config_dict[\"auto_map\"][\"AutoProcessor\"]\n```"}, {"role": "assistant", "content": "Hmm I still think this code path is never entered \ud83d\ude05. But this can be addressed in another PR anyway, so I added this back."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42402, "url": "https://github.com/huggingface/transformers/pull/42402#discussion_r2582139971"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `log.py`:\n\n```python\n@task_instances_log_router.get(\n    \"/{task_id}/externalLogUrl/{try_number}\",\n    responses=create_openapi_http_exception_doc([status.HTTP_400_BAD_REQUEST, status.HTTP_404_NOT_FOUND]),\n    dependencies=[Depends(requires_access_dag(\"GET\", DagAccessEntity.TASK_INSTANCE))],\n    dependencies=[Depends(requires_access_dag(\"GET\", DagAccessEntity.TASK_LOGS))],\n```"}, {"role": "assistant", "content": "Fair point, the example above make sense to me. Thanks for the clarification."}], "_meta": {"repo": "apache/airflow", "pr_number": 60412, "url": "https://github.com/apache/airflow/pull/60412#discussion_r2689265332"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nsources: Set[Path] = set()\n    root = ctx.obj[\"root\"]\n\n    _exclude = exclude\n```"}, {"role": "assistant", "content": "Maybe use `typing.cast` when passing the value to `gen_python_files`? `cast(Pattern[str], _exclude)`. Feels bad but should make mypy happy as we know the value should never be `None`.\r\n\r\nCheck this snippet on mypy playground. This is a small reproduction of the issue at hand: mypy does not see that `backup` (`_exclude`) will never be `None`:\r\n\r\n```python\r\nfrom typing import Optional, cast\r\n\r\n\r\ndef function(arg: Optional[str]) -> str:\r\n    backup = arg\r\n    if arg is None:\r\n        if backup is None:\r\n            backup = \"\"\r\n    # return cast(str, backup)\r\n    return backup\r\n\r\nfunction(None)\r\nfunction(\"a\")\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 3336, "url": "https://github.com/psf/black/pull/3336#discussion_r997472953"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `base.py`:\n\n```python\n# Django 1.7 allows for specifying a class name in INSTALLED_APPS.\n    # (Issue #2248).\n    try:\n        # Return package itself when no related_name.\n        module = importlib.import_module(package)\n        if not related_name and module:\n            return module\n    except ImportError:\n    except ModuleNotFoundError:\n        # On import error, try to walk package up one level.\n        package, _, _ = package.rpartition('.')\n        if not package:\n            raise\n\n    module_name = f'{package}.{related_name}'\n\n    try:\n        # Try to find related_name under package.\n        return importlib.import_module(module_name)\n    except ImportError as e:\n    except ModuleNotFoundError as e:\n        import_exc_name = getattr(e, 'name', module_name)\n        if import_exc_name is not None and import_exc_name != module_name:\n```"}, {"role": "assistant", "content": "Dropped an integration test in -- LMK how that looks :pray:"}], "_meta": {"repo": "celery/celery", "pr_number": 8632, "url": "https://github.com/celery/celery/pull/8632#discussion_r1399868629"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_solar_open.py`:\n\n```python\n# Copyright 2025 Upstage and HuggingFace Inc. team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\"\"\"Testing suite for the PyTorch SolarOpen model.\"\"\"\n\nimport unittest\n\nimport torch\n\nfrom transformers import is_torch_available\nfrom transformers.testing_utils import (\n    cleanup,\n    require_torch,\n    require_torch_accelerator,\n    slow,\n    torch_device,\n)\n\nfrom ...causal_lm_tester import CausalLMModelTest, CausalLMModelTester\n\n\nif is_torch_available():\n    from transformers import AutoTokenizer, SolarOpenForCausalLM, SolarOpenModel\n\n\nclass SolarOpenModelTester(CausalLMModelTester):\n    if is_torch_available():\n        base_model_class = SolarOpenModel\n\n    def __init__(\n        self,\n        parent,\n        n_routed_experts=8,\n        n_shared_experts=1,\n        n_group=1,\n        topk_group=1,\n        num_experts_per_tok=2,\n        moe_intermediate_size=16,\n        routed_scaling_factor=1.0,\n        norm_topk_prob=True,\n        use_qk_norm=False,\n    ):\n        super().__init__(parent=parent, num_experts_per_tok=num_experts_per_tok)\n        self.n_routed_experts = n_routed_experts\n        self.n_shared_experts = n_shared_experts\n        self.n_group = n_group\n        self.topk_group = topk_group\n        self.moe_intermediate_size = moe_intermediate_size\n        self.routed_scaling_factor = routed_scaling_factor\n        self.norm_topk_prob = norm_topk_prob\n        self.use_qk_norm = use_qk_norm\n\n\n@require_torch\nclass SolarOpenModelTest(CausalLMModelTest, unittest.TestCase):\n    model_tester_class = SolarOpenModelTester\n    # used in `test_torch_compile_for_training`. Skip as \"Dynamic control flow in MoE\"\n    _torch_compile_train_cls = None\n```"}, {"role": "assistant", "content": "Can be maybe removed, we allow compile as of now, see #42697 (let me know if not)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43244, "url": "https://github.com/huggingface/transformers/pull/43244#discussion_r2691570953"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `continuous_api.py`:\n\n```python\nmax_queue_size: int = 0,\n        num_q_cuda_graphs: int = 0,\n        num_kv_cuda_graphs: int = 0,\n        allow_prefix_sharing: bool = True,\n```"}, {"role": "assistant", "content": "I feel `enable_prefix_sharing` is better semantically"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42094, "url": "https://github.com/huggingface/transformers/pull/42094#discussion_r2522928826"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `default_settings.py`:\n\n```python\nFEED_TEMPDIR = None\nFEEDS = {}\nFEED_URI_PARAMS = None  # a function to extend uri arguments\nFEED_STORE_EMPTY = False\nFEED_STORE_EMPTY = True\n```"}, {"role": "assistant", "content": "To mention that files are not exported may be a good thing, yes.\r\n\r\nI don\u2019t think we need anything else, though. We will need to justify this default value change, explain the reasons behind it, in the release notes, but we usually handle release notes entries when preparing the release, so you do not need to worry about that part here."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5847, "url": "https://github.com/scrapy/scrapy/pull/5847#discussion_r1138214724"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nreturn json_schema\n\n\nclass ConfigWrapperStack:\n    \"\"\"A stack of `ConfigWrapper` instances.\"\"\"\n\n    def __init__(self, config_wrapper: ConfigWrapper):\n        self._config_wrapper_stack: list[ConfigWrapper] = [config_wrapper]\n\n    @property\n    def tail(self) -> ConfigWrapper:\n        return self._config_wrapper_stack[-1]\n\n    def push(self, config_wrapper: ConfigWrapper | ConfigDict | None) -> ContextManager[None]:\n        if config_wrapper is None:\n            return nullcontext()\n\n        if not isinstance(config_wrapper, ConfigWrapper):\n            config_wrapper = ConfigWrapper(config_wrapper, check=False)\n\n        @contextmanager\n        def _context_manager() -> Iterator[None]:\n            self._config_wrapper_stack.append(config_wrapper)\n            try:\n                yield\n            finally:\n                self._config_wrapper_stack.pop()\n\n        return _context_manager()\n\n\nJsonEncoders = Dict[Type[Any], Callable[[Any], Any]]\n\n\ndef _add_custom_serialization_from_json_encoders(\n    json_encoders: JsonEncoders | None, obj: Any, schema: CoreSchema\n) -> None:\n    if json_encoders is None:\n        return\n    # Check the class type and its superclasses for a matching encoder\n    for base in (obj, obj.__class__.__mro__[:-1]):\n```"}, {"role": "assistant", "content": "Is the `:-1` here just to prevent `object` from being a base that gets checked? Any reason not to allow people to have an encoder for `object`? Lol."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6737, "url": "https://github.com/pydantic/pydantic/pull/6737#discussion_r1270795065"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_fields.py`:\n\n```python\nreturn True\n\n\ndef rebuild_model_fields(\n    cls: type[BaseModel],\n    *,\n    ns_resolver: NsResolver,\n    typevars_map: dict[TypeVar, Any],\n    raise_errors: bool = True,\n) -> dict[str, FieldInfo]:\n    \"\"\"Rebuild the (already present) model fields by trying to reevaluate annotations.\n\n    This function should be called whenever a model with incomplete fields is encountered.\n\n    Note:\n        This function *doesn't* mutate the model fields in place, as it can be called during\n        schema generation, where you don't want to mutate other model's fields.\n    \"\"\"\n    FieldInfo_ = import_cached_field_info()\n\n    rebuilt_fields: dict[str, FieldInfo] = {}\n```"}, {"role": "assistant", "content": "It's only going to make temporary memory allocations, as:\r\n- if this is called from `model_rebuild()`, it will override the existing `__pydantic_fields__`, so the old ones will be gc'ed.\r\n- if this is called in `GenerateSchema._model_schema()`, as part of another model build, they are going to be gc'ed at the end of the method."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11388, "url": "https://github.com/pydantic/pydantic/pull/11388#discussion_r1949902245"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\nlogger = logging.get_logger(__name__)\n\n\ndef reverse_target_pattern(pattern: str) -> tuple[str, str | None]:\n    \"\"\"\n    Process a target pattern for reverse mapping (when targets become sources).\n\n    This handles several edge cases in checkpoint conversion mappings:\n    - Removes `^` prefix and `$` suffix (start/end of string anchors)\n    - Removes negative lookahead/lookbehind assertions\n    - Detects capturing groups and replaces them with `\\\\1` backreference\n\n    Args:\n        pattern: The target pattern to process for reverse mapping.\n\n    Returns:\n        A tuple of (processed_pattern, captured_group) where captured_group is\n        the original capturing group found (e.g., \"(encoder|decoder)\") or None.\n    \"\"\"\n    # Some mapping contains `^` to notify start of string when matching -> remove it during reverse mapping\n    pattern = pattern.removeprefix(\"^\")\n    # Some mapping contains `$` to notify end of string when matching -> remove it during reverse mapping\n    pattern = pattern.removesuffix(\"$\")\n    # Remove negative lookahead/behind if any. This is ugly but needed for reverse mapping of\n    # Qwen2.5, Sam3, Ernie4.5 VL MoE!\n    pattern = re.sub(r\"\\(\\?.+\\)\", \"\", pattern)\n    # Allow capturing groups in patterns, i.e. to add/remove a prefix to all keys (e.g. timm_wrapper, sam3)\n    capturing_group_match = re.search(r\"\\([^)]+\\)\", pattern)\n    captured_group = None\n    if capturing_group_match:\n        captured_group = capturing_group_match.group(0)\n        pattern = pattern.replace(captured_group, r\"\\1\", 1)\n    return pattern, captured_group\n```"}, {"role": "assistant", "content": "Yep haha https://github.com/huggingface/transformers/pull/43205"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2686920279"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `misc.py`:\n\n```python\nreturn instance\n\n\ndef build_from_crawler(objcls, crawler, *args, **kwargs):\n    \"\"\"\n    Constructs a class instance using ``from_crawler`` constructor\n\n    ``*args`` and ``**kwargs`` are forwarded to the constructors.\n\n    Raises ``ValueError`` if``crawler`` is``None``.\n    Raises typeError is instance is None\n    \"\"\"\n    settings = crawler.settings\n    if crawler and hasattr(objcls, \"from_crawler\"):\n        instance = objcls.from_crawler(crawler, *args, **kwargs)\n        method_name = \"from_crawler\"\n    elif hasattr(objcls, \"from_settings\"):\n        instance = objcls.from_settings(settings, *args, **kwargs)\n        method_name = \"from_settings\"\n    else:\n        instance = objcls(*args, **kwargs)\n        method_name = \"__new__\"\n    if instance is None:\n        raise TypeError(f\"{objcls.__qualname__}.{method_name} returned None\")\n    return instance\n\n\ndef build_from_settings(objcls, settings, *args, **kwargs):\n```"}, {"role": "assistant", "content": "```suggestion\r\ndef build_from_settings(objcls, settings, /, *args, **kwargs):\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6169, "url": "https://github.com/scrapy/scrapy/pull/6169#discussion_r1421729476"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_requests.py`:\n\n```python\n'http://localhost.localdomain:5000/v1.0/') == {}\n        assert get_environ_proxies('http://www.requests.com/') != {}\n\n    def test_guess_filename_when_int(self):\n        from requests.utils import guess_filename\n        assert None is guess_filename(1)\n\n    def test_guess_filename_when_filename_is_an_int(self):\n        from requests.utils import guess_filename\n        fake = type('Fake', (object,), {'name': 1})()\n        assert None is guess_filename(fake)\n\n    def test_guess_filename_with_file_like_obj(self):\n        from requests.utils import guess_filename\n        fake = type('Fake', (object,), {'name': 'value'})()\n        assert 'value' == guess_filename(fake)\n\n    def test_guess_filename_with_unicode_name(self):\n        from requests.utils import guess_filename\n        fake = type('Fake', (object,), {'name': b'value'.decode('utf-8')})()\n        assert 'value' == guess_filename(fake)\n```"}, {"role": "assistant", "content": "The test will work fine on Py2, it just won't prove anything because of the implicit string type conversion. The test fundamentally asks a different question on each platform. On Python 3, it will say \"does guess_filename return a unicode string with the value 'value'\", whereas on Python 2 it will say \"does guess_filename return any string that can be coerced to 'value'\".\n\nObserve that if this was the function of `guess_filename` it would work fine on Py 2 and fail on Py 3:\n\n``` python\ndef guess_filename(obj):\n    return b'value'\n```\n\nNote that the check against `None` is included in a type check. I'm happy to check the value _as well_, but we need to write a test that Python 2's implicit string conversion doesn't defeat."}], "_meta": {"repo": "psf/requests", "pr_number": 2413, "url": "https://github.com/psf/requests/pull/2413#discussion_r23167513"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\nself.row_embeddings = nn.Embedding(50, embedding_dim)\n        self.column_embeddings = nn.Embedding(50, embedding_dim)\n\n    def forward(self, pixel_values, pixel_mask=None):\n        height, width = pixel_values.shape[-2:]\n        width_values = torch.arange(width, device=pixel_values.device)\n        height_values = torch.arange(height, device=pixel_values.device)\n    @compile_compatible_method_lru_cache(maxsize=1)\n    def forward(\n        self,\n        shape: torch.Size,\n        device: Union[torch.device, str],\n        dtype: torch.dtype,\n        mask: Optional[torch.Tensor] = None,\n    ):\n        height, width = shape[-2:]\n        width_values = torch.arange(width, device=device)\n        height_values = torch.arange(height, device=device)\n        x_emb = self.column_embeddings(width_values)\n        y_emb = self.row_embeddings(height_values)\n        pos = torch.cat([x_emb.unsqueeze(0).repeat(height, 1, 1), y_emb.unsqueeze(1).repeat(1, width, 1)], dim=-1)\n        pos = pos.permute(2, 0, 1)\n        pos = pos.unsqueeze(0)\n        pos = pos.repeat(pixel_values.shape[0], 1, 1, 1)\n        pos = pos.repeat(shape[0], 1, 1, 1)\n        return pos\n\n\ndef build_position_encoding(config):\n    n_steps = config.d_model // 2\n    if config.position_embedding_type == \"sine\":\n        # TODO find a better way of exposing other arguments\n        position_embedding = DetrSinePositionEmbedding(n_steps, normalize=True)\n    elif config.position_embedding_type == \"learned\":\n        position_embedding = DetrLearnedPositionEmbedding(n_steps)\n    else:\n        raise ValueError(f\"Not supported {config.position_embedding_type}\")\ndef eager_attention_forward(\n```"}, {"role": "assistant", "content": "Let's sync with bert #41625\r\n\r\nIt's more robust and we should avoid multiple implementations here"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2433304060"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nschema = self._apply_discriminator_to_union(schema, field_info.discriminator)\n            return schema\n\n        # Convert `@field_validator` decorators to `Before/After/Plain/WrapValidator` instances:\n        validators_from_decorators = []\n        for decorator in filter_field_decorator_info_by_field(decorators.field_validators.values(), name):\n            validators_from_decorators.append(_mode_to_validator[decorator.info.mode]._from_decorator(decorator))\n\n        with self.field_name_stack.push(name):\n            if field_info.discriminator is not None:\n                schema = self._apply_annotations(source_type, annotations, transform_inner_schema=set_discriminator)\n                schema = self._apply_annotations(\n                    source_type, annotations + validators_from_decorators, transform_inner_schema=set_discriminator\n```"}, {"role": "assistant", "content": "This is an interesting pattern - I'm assuming, based on passing tests, that this preserves annotation order as expected."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10094, "url": "https://github.com/pydantic/pydantic/pull/10094#discussion_r1724009391"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\n'__schema_cache__': {},\n            '__json_encoder__': staticmethod(json_encoder),\n            '__custom_root_type__': _custom_root_type,\n            '__hash__': (lambda self: hash(tuple(self.__dict__.values()))) if not config.allow_mutation else None,\n```"}, {"role": "assistant", "content": "okay, so it can't just be a method on `BaseModel`, but let's make it a proper function, not a lambda."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 1881, "url": "https://github.com/pydantic/pydantic/pull/1881#discussion_r502392221"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_blip.py`:\n\n```python\n>>> inputs = processor(text=[\"a photo of a cat\", \"a photo of a dog\"], padding=True, return_tensors=\"pt\")\n        >>> text_features = model.get_text_features(**inputs)\n        ```\"\"\"\n        text_outputs = self.text_model(\n        text_outputs: BaseModelOutputWithPoolingAndCrossAttentions = self.text_model(\n            input_ids=input_ids,\n            attention_mask=attention_mask,\n            position_ids=position_ids,\n            **kwargs,\n```"}, {"role": "assistant", "content": "Similarly elsewhere, noticing it being used sometimes but sometimes not"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2694306158"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `param.py`:\n\n```python\nCLASS_IDENTIFIER = \"__class\"\n\n    def __init__(self, default: Any = NOTSET, description: str | None = None, **kwargs):\n    def __init__(\n        self,\n        default: Any = NOTSET,\n        description: str | None = None,\n        source: Literal[\"Dag\", \"task\", \"Dag run\"] | None = None,\n```"}, {"role": "assistant", "content": "Not sure if `\"Dag run\"` is intend to be here as I only saw `\"Dag\"` and `\"task\"` above.\n\n```suggestion\n        source: Literal[\"Dag\", \"task\"] | None = None,\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 58615, "url": "https://github.com/apache/airflow/pull/58615#discussion_r2567302130"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_keycloak_auth_manager.py`:\n\n```python\nclient_secret_key=\"client_secret\",\n        )\n        assert client == mock_keycloak_openid.return_value\n\n    def test_get_token_url_without_trailing_slash(self, auth_manager):\n```"}, {"role": "assistant", "content": "I like those tests but could be one test with multiple parameter using `.mark.parametrize`. Can you please do that?"}], "_meta": {"repo": "apache/airflow", "pr_number": 61305, "url": "https://github.com/apache/airflow/pull/61305#discussion_r2754725479"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\ndata = yield self.run_and_export(TestSpider, settings)\n        return data\n\n    @defer.inlineCallbacks\n    def assertExported(self, items, header, rows, settings=None, ordered=True):\n        yield self.assertExportedCsv(items, header, rows, settings, ordered)\n        yield self.assertExportedJsonLines(items, rows, settings)\n        yield self.assertExportedXml(items, rows, settings)\n        yield self.assertExportedPickle(items, rows, settings)\n        yield self.assertExportedMarshal(items, rows, settings)\n        yield self.assertExportedMultiple(items, rows, settings)\n\n    @abstractmethod\n    def run_and_export(self, spider_cls, settings):\n        pass\n\n    def _load_until_eof(self, data, load_func):\n        result = []\n        with tempfile.TemporaryFile() as temp:\n            temp.write(data)\n            temp.seek(0)\n            while True:\n                try:\n                    result.append(load_func(temp))\n                except EOFError:\n                    break\n        return result\n\n\nclass FeedExportTest(FeedExportTestBase):\n    __test__ = True\n\n    @defer.inlineCallbacks\n    def run_and_export(self, spider_cls, settings):\n        \"\"\" Run spider with specified settings; return exported data. \"\"\"\n\n        FEEDS = settings.get('FEEDS') or {}\n        settings['FEEDS'] = {\n            urljoin('file:', pathname2url(str(file_path))): feed\n            for file_path, feed in FEEDS.items()\n        }\n        content = {}\n        try:\n            with MockServer() as s:\n```"}, {"role": "assistant", "content": "Do you mean to use `scrapy.utils.test.get_crawler` instead of `MockServer` or it is about an error which I get trying to use `S3FeedStorageTest::test_store`?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4434, "url": "https://github.com/scrapy/scrapy/pull/4434#discussion_r418478025"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_audioflamingo3.py`:\n\n```python\nSpecial token used to represent audio inputs in the chat template.\n    \"\"\"\n\n    attributes = [\"feature_extractor\", \"tokenizer\"]\n    feature_extractor_class = \"WhisperFeatureExtractor\"\n    tokenizer_class = \"Qwen2TokenizerFast\"\n```"}, {"role": "assistant", "content": "Cc  , moved this to the auto files to have one source of truth, and removed attributes as they are now auto-detected"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42667, "url": "https://github.com/huggingface/transformers/pull/42667#discussion_r2594063713"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_video_processing_qwen3_vl.py`:\n\n```python\nself.video_processor_tester.min_resolution = prev_min_resolution\n            if prev_max_resolution is not None:\n                self.video_processor_tester.max_resolution = prev_max_resolution\n\n    def test_image_input(self):\n        for video_processing_class in self.video_processor_list:\n            video_processor_dict = self.video_processor_dict.copy()\n            video_processor_dict[\"size\"] = {\"longest_edge\": 40960, \"shortest_edge\": 4096}\n            video_processor_dict[\"do_sample_frames\"] = False\n            video_processor_dict[\"temporal_patch_size\"] = 3\n            video_processing = video_processing_class(**video_processor_dict)\n\n            n, w, h = 1, 64, 64\n            video_inputs = [(np.random.randint(0, 256, (h, w, 3), dtype=np.uint8)) for _ in range(n)]\n\n            video_processed = video_processing(video_inputs, return_tensors=\"pt\")\n            encoded_videos = video_processed[self.input_name]\n            self.assertEqual(list(encoded_videos.shape), [16, 2304])\n\n            video_grid_thw = video_processed[\"video_grid_thw\"]\n            self.assertEqual(video_grid_thw.tolist(), [[1, 4, 4]])\n\n    def test_num_frames_equal_temporal_patch_size_plus_two(self):\n        for video_processing_class in self.video_processor_list:\n            video_processor_dict = self.video_processor_dict.copy()\n            video_processor_dict[\"size\"] = {\"longest_edge\": 40960, \"shortest_edge\": 4096}\n```"}, {"role": "assistant", "content": "down the size to 32 * 32, if smaller, `smart_resize` will change it too."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42083, "url": "https://github.com/huggingface/transformers/pull/42083#discussion_r2505801228"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nreturn builder(*preargs, uri, *args, **kwargs)\n\n\nclass ItemFilter:\n    \"\"\"\n    This will be used by FeedExporter to decide if an item should be allowed\n    to be exported to a particular feed.\n\n    :param feed_options: feed specific options passed from FeedExporter\n    :type feed_options: dict\n    \"\"\"\n\n    def __init__(self, feed_options):\n        self.feed_options = feed_options\n        self.item_classes = set()\n\n        if 'item_classes' in self.feed_options:\n            for item_class in self.feed_options['item_classes']:\n                self.item_classes.add(load_object(item_class))\n\n    def accepts(self, item):\n        \"\"\"\n        Return ``True`` if `item` should be exported or ``False`` otherwise.\n\n        :param item: scraped item which user wants to check if is acceptable\n        :type item: scrapy supported items (dictionaries, Item objects, dataclass objects, and attrs objects)\n```"}, {"role": "assistant", "content": "Good point, it would be better to say \u201cScrapy items\u201d and link to the items documentation."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5178, "url": "https://github.com/scrapy/scrapy/pull/5178#discussion_r668779550"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_utils.py`:\n\n```python\ntied_mapping = self._tied_weights_keys\n        # If the config does not specify any tying, return empty dict\n        if not self.config.tie_word_embeddings:\n        # NOTE: not all modules have `tie_word_embeddings` attr, for example vision-only\n        # modules do not have any word embeddings!\n        tie_word_embeddings = getattr(self.config.get_text_config(decoder=True), \"tie_word_embeddings\", False)\n```"}, {"role": "assistant", "content": "yeah, though in VLMs the attribute is stored in text config but the tying is done in `TaskHeadModel`. So when trying to tie weights, we end up checking `self.config` and not `self.config.text_config`\r\nDo we have any models with many text-submodules where one module ties wieghts and the other doesn't? If not, we can default to always checking text config imo"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41541, "url": "https://github.com/huggingface/transformers/pull/41541#discussion_r2672180170"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `setup.py`:\n\n```python\nextras[\"torch\"] = deps_list(\"torch\", \"accelerate\")\nextras[\"vision\"] = deps_list(\"torchvision\", \"Pillow\")\nextras[\"audio\"] = deps_list(\"torchaudio\", \"librosa\", \"pyctcdecode\", \"phonemizer\", \"kenlm\")\nextras[\"audio\"] = deps_list(\"torchaudio\", \"librosa\", \"pyctcdecode\", \"phonemizer\")\nif PYTHON_MINOR_VERSION < 13:\n    extras[\"audio\"] += deps_list(\"kenlm\")\nextras[\"video\"] = deps_list(\"av\")\nextras[\"timm\"] = deps_list(\"timm\")\nextras[\"quality\"] = deps_list(\"datasets\", \"ruff\", \"GitPython\", \"urllib3\", \"libcst\", \"rich\")\nextras[\"kernels\"] = deps_list(\"kernels\")\nextras[\"sentencepiece\"] = deps_list(\"sentencepiece\", \"protobuf\")\nextras[\"tiktoken\"] = deps_list(\"tiktoken\", \"blobfile\")\nextras[\"mistral-common\"] = deps_list(\"mistral-common[image]\")\nif PYTHON_MINOR_VERSION < 14:\n    extras[\"mistral-common\"] = deps_list(\"mistral-common[image]\")\n```"}, {"role": "assistant", "content": "no it is indeed failing with that version, \n\n```\nm5 \u279ctestmistral bin/pip install \"mistral-common[image]>=1.8.8\"\nERROR: Ignored the following versions that require a different python version: 1.6.0 Requires-Python >=3.9.0,<3.14; 1.6.1 Requires-Python >=3.9.0,<3.14; 1.6.2 Requires-Python >=3.9.0,<3.14; 1.6.3 Requires-Python >=3.9.0,<3.14; 1.6.4 Requires-Python >=3.9.0,<3.14; 1.7.0 Requires-Python >=3.9.0,<3.14; 1.8.0 Requires-Python >=3.9.0,<3.14; 1.8.1 Requires-Python >=3.9.0,<3.14; 1.8.2 Requires-Python >=3.9.0,<3.14; 1.8.3 Requires-Python >=3.9.0,<3.14; 1.8.4 Requires-Python >=3.9.0,<3.14; 1.8.5 Requires-Python >=3.9.0,<3.14; 1.8.6 Requires-Python >=3.10.0,<3.14; 1.8.7 Requires-Python >=3.10.0,<3.14; 1.8.8 Requires-Python >=3.10.0,<3.14; 1.9.0 Requires-Python >=3.10.0,<3.14\nERROR: Could not find a version that satisfies the requirement mistral-common>=1.8.8 (from versions: 1.0.0, 1.0.1, 1.0.2, 1.1.0, 1.2.0, 1.2.1, 1.3.0, 1.3.1, 1.3.2, 1.3.3, 1.3.4, 1.4.0, 1.4.1, 1.4.2, 1.4.3, 1.4.4, 1.5.0, 1.5.1, 1.5.2, 1.5.3, 1.5.4, 1.5.5, 1.5.6)\nERROR: No matching distribution found for mistral-common>=1.8.8\n```\n\nthey started to specifically require <3.13"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43490, "url": "https://github.com/huggingface/transformers/pull/43490#discussion_r2746096107"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `strings.py`:\n\n```python\nimport re\nimport sys\nimport unicodedata\nfrom functools import lru_cache\nfrom typing import List, Pattern\nfrom typing import List, Pattern, Text\n```"}, {"role": "assistant", "content": "Text is only relevant for Python 2/3 compatibility. Black is Python 3-only, so just use `str`."}], "_meta": {"repo": "psf/black", "pr_number": 3445, "url": "https://github.com/psf/black/pull/3445#discussion_r1051422796"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nforce=False,\n        )\n\n    def _fetch_parent_frame(self, depth: int) -> FrameType | None:\n```"}, {"role": "assistant", "content": "No need to have the depth arg here, you can just use `self._parent_depth`"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10893, "url": "https://github.com/pydantic/pydantic/pull/10893#discussion_r1851005496"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_hpa.py`:\n\n```python\n[\n            ({\"celery\": {\"persistence\": {\"enabled\": True}}}, \"StatefulSet\"),\n            ({\"celery\": {\"persistence\": {\"enabled\": False}}}, \"Deployment\"),\n            ({\"persistence\": {\"enabled\": True}, \"celery\": {\"persistence\": {\"enabled\": None}}}, \"StatefulSet\"),\n            ({\"persistence\": {\"enabled\": False}, \"celery\": {\"persistence\": {\"enabled\": None}}}, \"Deployment\"),\n```"}, {"role": "assistant", "content": "Not meaningful. These tests were testing if the unset behaviour of `workers.celery` will bring back the previous behaviour of the chart (not breaking change behaviour), so if we are removing it, they are not needed"}], "_meta": {"repo": "apache/airflow", "pr_number": 61049, "url": "https://github.com/apache/airflow/pull/61049#discussion_r2726019088"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `extract_metadata.py`:\n\n```python\n#!/usr/bin/env python\n# Copyright 2025 The HuggingFace Inc. team.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n\"\"\"Extract metadata from setup.py for CI testing.\n\nUsage:\n    python utils/extract_metadata.py extras          # List all extras (one per line)\n    python utils/extract_metadata.py python-versions # Output JSON array of Python versions\n\"\"\"\n\nimport json\nimport sys\nfrom pathlib import Path\nfrom types import ModuleType\n\n\ndef get_setup_module() -> ModuleType:\n    \"\"\"Import and return the setup module.\"\"\"\n    repo_root: Path = Path(__file__).parent.parent\n    sys.path.insert(0, str(repo_root))\n    import setup\n\n    return setup\n\n\ndef extract_extras() -> None:\n    \"\"\"Print all extras in definition order (one per line).\"\"\"\n    setup: ModuleType = get_setup_module()\n    for extra in setup.extras.keys():\n        print(extra)\n\n\ndef extract_python_versions() -> None:\n    \"\"\"Print supported Python versions as a JSON array.\"\"\"\n    setup: ModuleType = get_setup_module()\n    min_ver: int\n    max_ver: int\n    min_ver, max_ver = setup.SUPPORTED_PYTHON_VERSIONS\n    versions: list[str] = [f\"3.{v}\" for v in range(min_ver, max_ver + 1)]\n    print(json.dumps(versions))\n\n\nif __name__ == \"__main__\":\n    if len(sys.argv) < 2:\n        print(\"Usage: python utils/extract_metadata.py {extras|python-versions}\", file=sys.stderr)\n        sys.exit(1)\n```"}, {"role": "assistant", "content": "it's mostly similar.\n\n`sys.exit(1)` is like raising `SystemExit` and when you raise another error, you also get an exit code of `1`\n\nhere I chose to display a clean message and exit 1, rather than a full traceback."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43490, "url": "https://github.com/huggingface/transformers/pull/43490#discussion_r2745354966"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_blip_2.py`:\n\n```python\n```\"\"\"\n\n        if self.config.use_decoder_only_language_model:\n            text_outputs: CausalLMOutputWithPast = self.language_model(\n            text_outputs: BaseModelOutputWithPast = self.language_model.base_model(\n                input_ids=input_ids,\n                attention_mask=attention_mask,\n                return_dict=True,\n                **kwargs,\n```"}, {"role": "assistant", "content": "Would not remove the dict, we should make sure that we really have the correct type"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2691823102"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `kernel_config.py`:\n\n```python\n},\n            ...\n        }\n        For single device form local\n        {\n            \"RMSNorm\":\n                \"/abs-path:LlamaRMSNorm\",\n```"}, {"role": "assistant", "content": "```suggestion\n                \"/abs/path:LlamaRMSNorm\",\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42800, "url": "https://github.com/huggingface/transformers/pull/42800#discussion_r2622478132"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nif proxy:\n                raise RuntimeError(\"Use either `proxy` or 'proxies', not both.\")\n\n        allow_env_proxies = trust_env and app is None and transport is None\n        if app:\n            raise RuntimeError(\n```"}, {"role": "assistant", "content": "Via #3071 and since v1.0 is major upgrade, I'm now more interested to directly drop instead of deprecation."}], "_meta": {"repo": "encode/httpx", "pr_number": 3050, "url": "https://github.com/encode/httpx/pull/3050#discussion_r1466369932"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `log.py`:\n\n```python\n'twisted': {\n            'level': 'ERROR',\n        },\n        'hpack': {\n```"}, {"role": "assistant", "content": ":lipstick:  What about keeping this alphabetical? hpack, scrapy, twisted."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r450104266"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nUserWarning,\n                    )\n\n                extra_behavior: core_schema.ExtraBehavior = 'ignore'\n                extras_schema: CoreSchema | None = None  # For 'allow', equivalent to `Any` - no validation performed.\n\n                # `__closed__` is `None` when not specified (equivalent to `False`):\n                is_closed = bool(getattr(typed_dict_cls, '__closed__', False))\n                extra_items = getattr(typed_dict_cls, '__extra_items__', typing_extensions.NoExtraItems)\n                if is_closed:\n                    extra_behavior = 'forbid'\n                    extras_schema = None\n                elif not typing_objects.is_noextraitems(extra_items):\n                    extra_behavior = 'allow'\n                    extras_schema = self.generate_schema(replace_types(extra_items, typevars_map))\n```"}, {"role": "assistant", "content": "It is first assigned the value of `'ignore'`, so if:\r\n- the TD is not closed\r\n- the TD has no extra items\r\n- the extra from the config is not `'allow'` or `'forbid'`"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12179, "url": "https://github.com/pydantic/pydantic/pull/12179#discussion_r2394130478"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\n@property\n    def is_ssl(self) -> bool:\n        message = 'URL.is_ssl() is pending deprecation. Use url.scheme == \"https\"'\n        warnings.warn(message, DeprecationWarning)\n```"}, {"role": "assistant", "content": "Note: we have a handy util in `_utils.py` so we don't have to remember which warning category should be passed (planning to issue a PR to update all usage to this shortly!).\r\n\r\n```suggestion\r\n        warn_deprecated(message)\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1128, "url": "https://github.com/encode/httpx/pull/1128#discussion_r465879004"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auth.py`:\n\n```python\nreturn b\"HTTP/1.1\", self.status_code, b\"\", response_headers, response_stream\n\n\nclass SyncMockTransport(httpcore.SyncHTTPTransport):\n```"}, {"role": "assistant", "content": "I didn't manage to reuse the code from `AsyncMockTransport` without copy&pasting it."}], "_meta": {"repo": "encode/httpx", "pr_number": 1012, "url": "https://github.com/encode/httpx/pull/1012#discussion_r432935540"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `ready_to_reschedule.py`:\n\n```python\nin the future.\n        \"\"\"\n        if (\n            # Exclude infrastructure-triggered reschedules.\n            # When a task is rescheduled due to a startup failure (e.g. the task runner\n            # cannot load the Dag or task), the task instance will be set\n            # in UP_FOR_RESCHEDULE state. In this case, we'll ignore the task's\n            # \"reschedule\" attribute check, since the reschedule was not initiated by the\n            # operator itself.\n            ti.state is None\n```"}, {"role": "assistant", "content": "I don't quite see how this comment ties up with checking if ti.state is None?"}], "_meta": {"repo": "apache/airflow", "pr_number": 59604, "url": "https://github.com/apache/airflow/pull/59604#discussion_r2671775117"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `migrate-black.py`:\n\n```python\n#!/usr/bin/env python3\n# check out every commit added by the current branch, blackify them,\n# and generate diffs to reconstruct the original commits, but then\n# blackified\nimport os\nimport sys\nfrom subprocess import check_output, run, Popen, PIPE\n\n\ndef git(*args):\n    return check_output([\"git\"] + list(args)).decode(\"utf8\").strip()\n\n\ndef blackify(base_branch, black_command):\n    current_branch = git(\"branch\", \"--show-current\")\n\n    if not current_branch or base_branch == current_branch:\n        print(\"You need to check out a feature brach to work on\")\n        return 1\n\n    if not os.path.exists(\".git\"):\n        print(\"Run me in the root of your repo\")\n        return 1\n\n    merge_base = git(\"merge-base\", \"HEAD\", base_branch)\n    if not merge_base:\n        print(\"Could not find a common commit for current head and %s\" % base_branch)\n        return 1\n\n    commits = git(\n        \"log\", \"--reverse\", \"--pretty=format:%H\", \"%s~1..HEAD\" % merge_base\n    ).split()\n    for commit in commits:\n        git(\"checkout\", commit, \"-b\" \"%s-black\" % commit)\n        check_output(black_command, shell=True)\n```"}, {"role": "assistant", "content": "```suggestion\r\n        import shlex\r\n        check_output(shlex.split(black_command))\r\n```\r\nShouldn't need shell=True here ..."}], "_meta": {"repo": "psf/black", "pr_number": 3038, "url": "https://github.com/psf/black/pull/3038#discussion_r862373562"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_xpickle.py`:\n\n```python\ncls.enterClassContext(support.swap_attr(pickle, 'HIGHEST_PROTOCOL',\n                                                highest_protocol))\n\n    @staticmethod\n    def send_to_worker(python, data):\n    @classmethod\n    def start_worker(cls):\n        target = os.path.join(os.path.dirname(__file__), 'xpickle_worker.py')\n        worker = subprocess.Popen([*python, target],\n                                  stdin=subprocess.PIPE,\n                                  stdout=subprocess.PIPE,\n                                  stderr=subprocess.PIPE,\n                                  # For windows bpo-17023.\n                                  shell=is_windows)\n```"}, {"role": "assistant", "content": "But we do binary IO for stdin/stdout in normal case.\n\nThis code is only for troubleshooting. It is not executed when the tests pass."}], "_meta": {"repo": "python/cpython", "pr_number": 144393, "url": "https://github.com/python/cpython/pull/144393#discussion_r2754317977"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_phimoe.py`:\n\n```python\nEXPECTED_OUTPUT = torch.tensor(\n            [\n                    [-3.4844, -2.4531, -1.1719, 0.6055, -0.4922, -0.1001, 0.8086, -0.2422, 0.3477, -1.0078],\n                    [-0.9766, 0.1631, -0.5508, 2.3594, 0.7031, 3.1719, 0.4141, 0.2305, 0.6055, -2.1250],\n                [-3.4844, -2.4688, -1.1719, 0.5703, -0.4902, -0.0942, 0.7773, -0.2539, 0.3223, -1.0234],\n                [-0.9805, 0.0811, -0.5273, 2.3438, 0.6914, 3.0781, 0.3164, 0.2197, 0.5312, -2.1094],\n```"}, {"role": "assistant", "content": "We should check against A10 runners - let's revert for now and check with run-slow first. If it needs a change, I can update it"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43445, "url": "https://github.com/huggingface/transformers/pull/43445#discussion_r2727809014"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\nreturn MergeModulelist(self.dim)\n\n\nclass Transpose(ConversionOps):\n    \"\"\"\n    Transposes the given tensor along dim0 and dim1.\n    \"\"\"\n\n    def __init__(self, dim0: int = 0, dim1: int = 1):\n        self.dim0 = dim0\n        self.dim1 = dim1\n```"}, {"role": "assistant", "content": "Ah I messed up the order, I thought it was transpose then shard"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43307, "url": "https://github.com/huggingface/transformers/pull/43307#discussion_r2695337617"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_bart.py`:\n\n```python\nWhether or not the model should return the last key/values attentions (not used by all models).\n        num_labels (`int`, *optional*, defaults to 3):\n            The number of labels to use in [`BartForSequenceClassification`].\n        forced_eos_token_id (`int`, *optional*, defaults to 2):\n            The id of the token to force as the last generated token when `max_length` is reached. Usually set to\n            `eos_token_id`.\n```"}, {"role": "assistant", "content": "yeah, these would not be assigned as config attr so the docs is a bit misleading now"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42337, "url": "https://github.com/huggingface/transformers/pull/42337#discussion_r2556330486"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `parsing.py`:\n\n```python\nreturn code\n\n\ndef parse_ast(src: str) -> Union[ast.AST, ast3.AST, ast27.AST]:\ndef parse_single_version(\n    src: str, version: Tuple[int, int]\n) -> Union[ast.AST, ast3.AST, ast27.AST]:\n    filename = \"<unknown>\"\n    if sys.version_info >= (3, 8):\n        # TODO: support Python 4+ ;)\n        for minor_version in range(sys.version_info[1], 4, -1):\n            try:\n                return ast.parse(src, filename, feature_version=(3, minor_version))\n            except SyntaxError:\n                continue\n    else:\n        for feature_version in (7, 6):\n            try:\n                return ast3.parse(src, filename, feature_version=feature_version)\n            except SyntaxError:\n                continue\n    if ast27.__name__ == \"ast\":\n        raise SyntaxError(\n            \"The requested source code has invalid Python 3 syntax.\\n\"\n            \"If you are trying to format Python 2 files please reinstall Black\"\n            \" with the 'python2' extra: `python3 -m pip install black[python2]`.\"\n        )\n    return ast27.parse(src)\n    # typed_ast is needed because of feature version limitations in the builtin ast\n    if sys.version_info >= (3, 8) and version >= (3,):\n        return ast.parse(src, filename, feature_version=version)\n    elif version >= (3,):\n        return ast3.parse(src, filename, feature_version=version[1])\n    elif version == (2, 7):\n        return ast27.parse(src)\n    raise AssertionError(\"INTERNAL ERROR: Tried parsing unsupported Python version!\")\n\n\ndef parse_ast(src: str) -> Union[ast.AST, ast3.AST, ast27.AST]:\n    # TODO: support Python 4+ ;)\n```"}, {"role": "assistant", "content": "Technically a bigger concern is the fact 3.10 syntax is not supported but oh well ;)"}], "_meta": {"repo": "psf/black", "pr_number": 2304, "url": "https://github.com/psf/black/pull/2304#discussion_r663298632"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_decoders.py`:\n\n```python\nself.buffer = \"\"\n\n    def decode(self, text: str) -> typing.List[str]:\n        lines = []\n\n        if text and self.buffer and self.buffer[-1] == \"\\r\":\n            if text.startswith(\"\\n\"):\n                # Handle the case where we have an \"\\r\\n\" split across\n                # our previous input, and our new chunk.\n                lines.append(self.buffer[:-1] + \"\\n\")\n                self.buffer = \"\"\n                text = text[1:]\n            else:\n                # Handle the case where we have \"\\r\" at the end of our\n                # previous input.\n                lines.append(self.buffer[:-1] + \"\\n\")\n                self.buffer = \"\"\n\n        while text:\n            num_chars = len(text)\n            for idx in range(num_chars):\n                char = text[idx]\n                next_char = None if idx + 1 == num_chars else text[idx + 1]\n                if char == \"\\n\":\n                    lines.append(self.buffer + text[: idx + 1])\n                    self.buffer = \"\"\n                    text = text[idx + 1 :]\n                    break\n                elif char == \"\\r\" and next_char == \"\\n\":\n                    lines.append(self.buffer + text[:idx] + \"\\n\")\n                    self.buffer = \"\"\n                    text = text[idx + 2 :]\n                    break\n                elif char == \"\\r\" and next_char is not None:\n                    lines.append(self.buffer + text[:idx] + \"\\n\")\n                    self.buffer = \"\"\n                    text = text[idx + 1 :]\n                    break\n                elif next_char is None:\n                    self.buffer += text\n                    text = \"\"\n                    break\n        if self.buffer:\n            text = self.buffer + text\n\n        if not text:\n            return []\n\n        lines = text.splitlines(True)\n```"}, {"role": "assistant", "content": "I guess we'll want to drop the `True` here, given review comments."}], "_meta": {"repo": "encode/httpx", "pr_number": 2423, "url": "https://github.com/encode/httpx/pull/2423#discussion_r1044351913"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nallow_redirects: bool = True,\n        timeout: typing.Union[TimeoutTypes, UnsetType] = UNSET,\n    ) -> Response:\n        \"\"\"\n        Send a pre-built request.\n\n        Does not merge parameters with the client.\n        \"\"\"\n```"}, {"role": "assistant", "content": "Added this with a minor rewording to the new version!"}], "_meta": {"repo": "encode/httpx", "pr_number": 1152, "url": "https://github.com/encode/httpx/pull/1152#discussion_r467979767"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\nsource_keys: list[str],\n        target_keys: list[str],\n        full_layer_name: str,\n        model,\n        missing_keys,\n        config,\n        **kwargs,\n```"}, {"role": "assistant", "content": "most of the args should be optional kwargs so that we can clean the other convert function with **kwargs and only put args that are being used but that's fine, we should do that later on"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42289, "url": "https://github.com/huggingface/transformers/pull/42289#discussion_r2550203393"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trigger_dagrun.py`:\n\n```python\nself.skip_when_already_exists = skip_when_already_exists\n        self.fail_when_dag_is_paused = fail_when_dag_is_paused\n        self.openlineage_inject_parent_info = openlineage_inject_parent_info\n        self.deferrable = deferrable\n        # deferrable only makes sense when wait_for_completion=True\n        self.deferrable = deferrable and wait_for_completion\n```"}, {"role": "assistant", "content": "Looking again, I think the actual issue is in `task_runner.py` as it seems to check `deferrable` BEFORE checking `wait_for_completion`.  I'll fix that instead."}], "_meta": {"repo": "apache/airflow", "pr_number": 60052, "url": "https://github.com/apache/airflow/pull/60052#discussion_r2660871387"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\n\"\"\"\n        # `__tracebackhide__` tells pytest and some other tools to omit this function from tracebacks\n        __tracebackhide__ = True\n\n        if by_alias is False and by_name is not True:\n            raise PydanticUserError(\n                'At least one of `by_alias` or `by_name` must be set to True.',\n                code='validate-by-alias-and-name-false',\n            )\n```"}, {"role": "assistant", "content": "Up for debate if we should do this here (and in other model validation methods, including on type adapter)... also happy to use a helper function if we want, though I think the verbosity here is helpful."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11468, "url": "https://github.com/pydantic/pydantic/pull/11468#discussion_r1966887252"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `encoders.py`:\n\n```python\nfrom airflow.serialization.decoders import decode_asset_like\n\n    return decode_asset_like(encode_asset_like(obj))\n\n\nclass _PartitionMapperSerializer:\n    BUILTIN_PARTITION_MAPPERS: dict[type, str] = {\n        IdentityMapper: \"airflow.timetables.simple.IdentityMapper\",\n    }\n\n    @functools.singledispatchmethod\n    def serialize(self, partition_mapper: PartitionMapper) -> dict[str, Any]:\n        raise NotImplementedError\n\n    @serialize.register\n    def _(self, partition_mapper: IdentityMapper) -> dict[str, Any]:\n        return {}\n```"}, {"role": "assistant", "content": "The serializer-singledispatch pattern is only needed for timetables because we don\u2019t want to put serialization logic on SDK classes. Since the partition mapper logic is only in core, we can put serialization logic there."}], "_meta": {"repo": "apache/airflow", "pr_number": 60204, "url": "https://github.com/apache/airflow/pull/60204#discussion_r2689847305"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_reformer.py`:\n\n```python\ndef create_and_check_reformer_model_generate(self, config, input_ids, input_mask, choice_labels):\n        config.is_decoder = True\n        config.lsh_num_chunks_after = 0\n        config.bos_token_id = 0\n        config.eos_token_id = None\n        config.max_length = 20\n```"}, {"role": "assistant", "content": "generation params should not be assigned in model's config!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42702, "url": "https://github.com/huggingface/transformers/pull/42702#discussion_r2606500168"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_generics.py`:\n\n```python\nassert type(m.mapping_field) is dict  # this is determined in CustomMapping.__get_pydantic_core_schema__\n    assert type(m.ordered_dict_field) is CustomOrderedDict\n    assert type(m.set_field) is CustomSet\n    assert type(m.tuple_field) is tuple\n    assert type(m.long_tuple_field) is tuple\n    assert type(m.tuple_field) is CustomTuple\n    assert type(m.long_tuple_field) is CustomLongTuple\n```"}, {"role": "assistant", "content": "Several bugs / inconsistencies are getting fixed by this PR"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6737, "url": "https://github.com/pydantic/pydantic/pull/6737#discussion_r1269567456"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `django.py`:\n\n```python\nclass DjangoWorkerFixup:\n    _db_recycles = 0\n    worker = None  # Set via on_worker_init callback to avoid recursive WorkController instantiation\n```"}, {"role": "assistant", "content": "This is a user-facing behavior change in the Django fixup. Should we add documentation updates (versionchanged::) and a whatsnew/changelog entry?\n\nThe change affects how `DjangoWorkerFixup` is initialized and how the worker instance is set (now deferred to `on_worker_init` callback). Users who create `DjangoWorkerFixup` directly will need to be aware of this change, and the changelog should note this fixes the recursion bug (#10042) and the AttributeError when pool_cls is a string."}], "_meta": {"repo": "celery/celery", "pr_number": 10045, "url": "https://github.com/celery/celery/pull/10045#discussion_r2659459636"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nsources.add(p)\n        elif p.is_dir():\n            if exclude is None:\n                exclude = re_compile_maybe_verbose(DEFAULT_EXCLUDES)\n                gitignore = get_gitignore(root)\n            if exclude_is_None:\n```"}, {"role": "assistant", "content": "```suggestion\r\n            if using_default_exclude:\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 3336, "url": "https://github.com/psf/black/pull/3336#discussion_r1014764031"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\n:rtype: str\n    \"\"\"\n    scheme, netloc, path, params, query, fragment = urlparse(url, new_scheme)\n    parsed = parse_url(url)\n    scheme, auth, host, port, path, query, fragment = parsed\n\n    # urlparse is a finicky beast, and sometimes decides that there isn't a\n    # netloc present. Assume that it's being over-cautious, and switch netloc\n    # and path if urlparse decided there was no netloc.\n    # urlparse and parse_url determine that there isn't a netloc present in some\n    # urls. We've chosen to assume parsing is being over-cautious, and switch\n    # the netloc and path. This is maintained for backwards compatibility.\n    netloc = parsed.netloc\n```"}, {"role": "assistant", "content": "I've reworded things to be a bit clearer."}], "_meta": {"repo": "psf/requests", "pr_number": 5917, "url": "https://github.com/psf/requests/pull/5917#discussion_r776146587"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cli_parser.py`:\n\n```python\nlog = logging.getLogger(__name__)\n\n\nfor executor_name in ExecutorLoader.get_executor_names(validate_teams=False):\n```"}, {"role": "assistant", "content": "I think we need to add a fallback reading of CLIs in old ways - not sure how to do it without impacting performance too much, because we do not want to **always** load executor class. \n\nThis is important for two reasons:\n\n1) someone want to stay with old \"community\" provider version but use newer airflow\n2) someone has their own executor in their 3rd-party provider with CLIs defined\n\nPossibly one way of doing it is simple mapping of the executors -> provider  (for built-in executors we have mapping from the executor to provider package and checking if the provider has \"cli\" defined in provider info? Also likely we should raise an error if provider has an executor defined with cli commands AND cli command defined in provider info."}], "_meta": {"repo": "apache/airflow", "pr_number": 59805, "url": "https://github.com/apache/airflow/pull/59805#discussion_r2649692458"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\ndef collect_expected_diagnostics(path: Path) -> list[Diagnostic]:\n    diagnostics: list[Diagnostic] = []\n    for file in path.resolve().rglob(\"*.py\"):\n        for idx, line in enumerate(file.read_text().splitlines(), 1):\n    for entry in path.iterdir():\n        if not entry.is_file():\n            continue\n        if entry.suffix not in {\".py\", \".pyi\"}:\n```"}, {"role": "assistant", "content": "Should we skip files starting with an `_`? I assume it's not strictly necessary, since they never contain any comments matching the error pattern but it feels unnecessary"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22671, "url": "https://github.com/astral-sh/ruff/pull/22671#discussion_r2702309581"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `vault_client.py`:\n\n```python\nif not self.mount_point:\n            split_secret_path = secret_path.split(\"/\", 1)\n            if len(split_secret_path) < 2:\n                raise InvalidPath\n                raise InvalidPath(\n                    \"The variable path you have provided is invalid. Please provide a full path: path/to/secret/variable\"\n```"}, {"role": "assistant", "content": "```suggestion\n                    \"The variable path you have provided is invalid. Please provide a full path of the format: path/to/secret/variable\"\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 59224, "url": "https://github.com/apache/airflow/pull/59224#discussion_r2629803348"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `canvas.py`:\n\n```python\nheaders (Dict): Stamps that should be added to headers.\n        \"\"\"\n        self.stamp_links(visitor, **headers)\n\n        headers = headers.copy()\n        headers = deepcopy(headers)\n        visitor_headers = None\n        if visitor is not None:\n            visitor_headers = visitor.on_signature(self, **headers)\n            visitor_headers = visitor.on_signature(self, **headers) or {}\n        headers = self._stamp_headers(visitor_headers, **headers)\n        return self.set(**headers)\n\n    def _stamp_headers(self, visitor_headers=None, **headers):\n        headers = deepcopy(headers)\n        if visitor_headers is not None:\n            visitor_headers = visitor_headers or {}\n            if \"stamped_headers\" not in visitor_headers:\n                visitor_headers[\"stamped_headers\"] = list(visitor_headers.keys())\n            _merge_dictionaries(headers, visitor_headers)\n            _merge_dictionaries(headers, visitor_headers, aggregate_duplicates=False)\n            headers[\"stamped_headers\"] = list(set(headers[\"stamped_headers\"]))\n        else:\n            headers[\"stamped_headers\"] = [header for header in headers.keys() if header not in self.options]\n            _merge_dictionaries(headers, self.options)\n            stamped_headers = [\n                header for header in headers.keys()\n                if all([\n                    header != \"stamped_headers\",\n                    header in self.options.get(\"stamped_headers\", [])\n                ])\n            ]\n            if \"stamped_headers\" in headers:\n                headers[\"stamped_headers\"].extend(stamped_headers)\n            else:\n                headers[\"stamped_headers\"] = stamped_headers\n            for stamp in headers.keys():\n                if stamp != \"stamped_headers\" and stamp not in headers[\"stamped_headers\"]:\n                    headers[\"stamped_headers\"].append(stamp)\n            headers[\"stamped_headers\"] = list(set(headers[\"stamped_headers\"]))\n```"}, {"role": "assistant", "content": "I agree. Thank's for the code snippet.\r\nFix pushed."}], "_meta": {"repo": "celery/celery", "pr_number": 8045, "url": "https://github.com/celery/celery/pull/8045#discussion_r1097992136"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_hpa.py`:\n\n```python\n[\n            ({\"celery\": {\"persistence\": {\"enabled\": True}}}, \"StatefulSet\"),\n            ({\"celery\": {\"persistence\": {\"enabled\": False}}}, \"Deployment\"),\n            ({\"persistence\": {\"enabled\": True}, \"celery\": {\"persistence\": {\"enabled\": None}}}, \"StatefulSet\"),\n            ({\"persistence\": {\"enabled\": False}, \"celery\": {\"persistence\": {\"enabled\": None}}}, \"Deployment\"),\n```"}, {"role": "assistant", "content": "Why are you removing these tests? Are they broken or not meaningful?\nIf disabled because of fix complexity this should keep a note at least."}], "_meta": {"repo": "apache/airflow", "pr_number": 61049, "url": "https://github.com/apache/airflow/pull/61049#discussion_r2726012043"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nclass IFeedStorage(Interface):\n    \"\"\"Interface that all Feed Storages must implement\"\"\"\n\n    def __init__(uri):\n        \"\"\"Initialize the storage with the parameters given in the URI\"\"\"\n    def __init__(uri, feed):\n```"}, {"role": "assistant", "content": "What do you think about calling it feed_options?\r\n\r\n* for feed argument I'd expect some instance of Feed, whatever is it\r\n* feed_settings is not good, because this dict is not a Settings instance"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4512, "url": "https://github.com/scrapy/scrapy/pull/4512#discussion_r421726672"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `setup.py`:\n\n```python\n},\n    test_suite=\"tests.test_black\",\n```"}, {"role": "assistant", "content": "Unrelatedly, isn't this wrong now? We have more test files than this."}], "_meta": {"repo": "psf/black", "pr_number": 2823, "url": "https://github.com/psf/black/pull/2823#discussion_r795065438"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feature_extraction_utils.py`:\n\n```python\nimport torch\n\n            def as_tensor(value):\n                if torch.is_tensor(value):\n                    return value\n\n                # stack list of tensors if tensor_type is PyTorch (# torch.tensor() does not support list of tensors)\n                if isinstance(value, (list, tuple)) and len(value) > 0 and torch.is_tensor(value[0]):\n                    return torch.stack(value)\n\n                # convert list of numpy arrays to numpy array (stack) if tensor_type is Numpy\n```"}, {"role": "assistant", "content": "Ok sgtm, I might do that in another PR though, as this would be quite a big change, and it might be lost in the 63+ files modified here just due to allowing stacking tensors"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42750, "url": "https://github.com/huggingface/transformers/pull/42750#discussion_r2611140844"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\n# We could enforce triple quotes at this point.\n            quote = quote_char * quote_len\n            leaf.value = prefix + quote + docstring + quote\n\n            if Preview.long_docstring_quotes_on_newline in self.mode:\n                # Put closing quotes on new line if max line length exceeded\n                last_line_length = len(docstring.splitlines()[-1]) if docstring else 0\n\n                # Make the docstring apart from the closing quotes, which happen below\n                docstring = prefix + quote + docstring\n                if (\n                    len(indent) + len(prefix) + 2 * len(quote) + last_line_length\n                    <= self.mode.line_length\n                ):\n```"}, {"role": "assistant", "content": "I've tried to think this through, but I'm not 100 % still. Wouldn't this be incorrect if we had a multiline docstring whose last line was just acceptable? We would sum the prefix and quote length to it and refuse to add quotes at the end.\r\n\r\n```python\r\ndef foo():\r\n    \"\"\"first line---------------------------------------------------------------\r\n\r\n    second line--------------------------------------------------------------\"\"\"\r\n```\r\n\r\nIn any case, a test about this would be nice too."}], "_meta": {"repo": "psf/black", "pr_number": 3044, "url": "https://github.com/psf/black/pull/3044#discussion_r865383225"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_align.py`:\n\n```python\n>>> with torch.inference_mode():\n        ...     text_features = model.get_text_features(**inputs)\n        ```\"\"\"\n        text_outputs = self.text_model(\n        text_outputs: BaseModelOutputWithPooling = self.text_model(\n            input_ids=input_ids,\n            attention_mask=attention_mask,\n            token_type_ids=token_type_ids,\n            position_ids=position_ids,\n            inputs_embeds=inputs_embeds,\n            **kwargs,\n        )\n        last_hidden_state = text_outputs[0][:, 0, :]\n        text_features = self.text_projection(last_hidden_state)\n        text_outputs.pooler_output = self.text_projection(last_hidden_state)\n```"}, {"role": "assistant", "content": "It's indeed sometimes possible that the original `pooler_output` is preferred. The exact format of what's stored in this `pooler_output` also differs. For example, for `get_text_features` it's often `[batch_size, hidden_size]`, i.e. the sequence length dimension is \"pooled\" away, while with `get_image_features` it can be `[batch_size, hidden_size]`, but also e.g. a list of `[num_patches, hidden_size]` for each image.\r\n\r\nThere's still a handful of different formats used in `last_hidden_state`/`pooler_output`/`attentions`/`hidden_states`, depending on the architecture. That makes downstream use still somewhat complicated, but a lot more viable than currently. For `pooler_output` I've continuously chosen for what was already being returned on `main`, and `last_hidden_state`/`attentions`/`hidden_states` are preserved from the relevant modality encoder.\r\n\r\nFor context, my goal is to expose the `last_hidden_state` (and to a lesser extent also the pooled, per-layer hidden states, or attentions) for individual modalities."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2695098911"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deb822_repository.py`:\n\n```python\ndescription:\n        - Tells APT whether the source is enabled or not.\n        type: bool\n    exclude:\n        description:\n        - Controls which packages APT should not use from the repository.\n        - Mutually exclusive with O(include).\n        type: list\n        elements: str\n        version_added: '2.21'\n    include:\n        description:\n        - Controls which packages APT should use from the repository.\n```"}, {"role": "assistant", "content": "```suggestion\r\n        - Controls which packages C(APT) should use from the repository.\r\n```"}], "_meta": {"repo": "ansible/ansible", "pr_number": 86171, "url": "https://github.com/ansible/ansible/pull/86171#discussion_r2515051313"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `config.py`:\n\n```python\nverify = True\n            self._load_client_certs(ssl_context)\n\n        if trust_env:\n            if verify is True or verify is None:\n                verify = get_ssl_cert_file()  # type: ignore\n```"}, {"role": "assistant", "content": "I also think we should *probably* inspect the environment at the point of calling `load_ssl_context`, rather than on `__init__`."}], "_meta": {"repo": "encode/httpx", "pr_number": 307, "url": "https://github.com/encode/httpx/pull/307#discussion_r320250946"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_types.py`:\n\n```python\nassert import_things.model_dump_json() == '{\"obj\":\"sys.stdout\"}'\n\n\ndef test_import_string_thing_with_name() -> None:\n    \"\"\"https://github.com/pydantic/pydantic/issues/12218\"\"\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n    \"\"\"https://github.com/pydantic/pydantic/issues/12218\"\"\"\r\n\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12219, "url": "https://github.com/pydantic/pydantic/pull/12219#discussion_r2346646743"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_lasr.py`:\n\n```python\ntorch.testing.assert_close(predicted_ids.cpu(), EXPECTED_TOKENS)\n        predicted_transcripts = self.processor.batch_decode(predicted_ids, skip_special_tokens=True)\n        self.assertListEqual(predicted_transcripts, EXPECTED_TRANSCRIPTIONS)\n\n    @slow\n    @unittest.skip(reason=\"TODO when checkpoint\")\n    def test_model_integration_pipe_with_chunk(self):\n        EXPECTED_TRANSCRIPTIONS = [\n            {\"text\": \"Mr. Kuer is thele of the middle classes and we are glad to welcome his gosal.</s>\"}\n        ]\n\n        samples = self._load_datasamples(1)\n        pipe = pipeline(\n            task=\"automatic-speech-recognition\", model=self.checkpoint_name, dtype=self.dtype, device_map=torch_device\n        )\n        self.assertEqual(pipe.type, \"ctc\")\n        predicted_transcripts = pipe(samples, chunk_length_s=3, stride_length_s=1)\n        self.assertListEqual(predicted_transcripts, EXPECTED_TRANSCRIPTIONS)\n```"}, {"role": "assistant", "content": "Moved to https://github.com/huggingface/transformers/pull/42823."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42720, "url": "https://github.com/huggingface/transformers/pull/42720#discussion_r2611995892"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\nreplace_chars = \" '\\\"\"\n\n    for val in value.split(\",\"):\n    for val in re.split(\",\\ *<\", value):\n```"}, {"role": "assistant", "content": "Why do you have a `\\` in the expression? I'm very certain that's unnecessary if you're trying to say \"zero or more ` `s\"."}], "_meta": {"repo": "psf/requests", "pr_number": 2271, "url": "https://github.com/psf/requests/pull/2271#discussion_r18708681"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nworkers=workers,\n            )\n\n    out()\n    if verbose or not quiet:\n        out(error_msg if report.return_code else \"All done! \u2728 \ud83c\udf70 \u2728\")\n```"}, {"role": "assistant", "content": "```suggestion\r\n    if verbose or not quiet:\r\n        out()\r\n        out(error_msg if report.return_code else \"All done! \u2728 \ud83c\udf70 \u2728\")\r\n```\r\nSorry for being unclear, but we should only add the newline if we're gonna be emitting the summary anyway."}], "_meta": {"repo": "psf/black", "pr_number": 2712, "url": "https://github.com/psf/black/pull/2712#discussion_r773378719"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `comments8.py`:\n\n```python\n# The percent-percent comments are Spyder IDE cells.\n# Both `#%%`` and `# %%` are accepted, so `black` standardises\n# to the latter.\n\n#%%\ndef func():\n    x = \"\"\"\n    a really long string\n    \"\"\"\n    lcomp3 = [\n```"}, {"role": "assistant", "content": "Can we shorten this code? The test can focus on just `#%%`, so no need for everything else."}], "_meta": {"repo": "psf/black", "pr_number": 2919, "url": "https://github.com/psf/black/pull/2919#discussion_r831392122"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `exceptions.py`:\n\n```python\n\"\"\"\nfrom urllib3.exceptions import HTTPError as BaseHTTPError\n\ntry:\n```"}, {"role": "assistant", "content": "I'm not sure I'm following, could you clarify which properties you're referring to? We have 3 parent classes that we'd ever use in our environment, `json.JSONDecodeError`, `simplejson.JSONDecodeError`, and `ValueError`. Only one of those can be relevant in a given execution of Requests.\r\n\r\nWhat I was asking about was if we did:\r\n\r\n```python\r\nfrom .compat import JSONDecodeError as CompatJSONDecodeError\r\n\r\n[...]\r\n\r\nclass JSONDecodeError(InvalidJSONError, CompatJSONDecodeError):\r\n```\r\n\r\nWe've already resolved these values once in compat, so I wanted to know why we're doing it again here."}], "_meta": {"repo": "psf/requests", "pr_number": 5856, "url": "https://github.com/psf/requests/pull/5856#discussion_r673356731"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_scheduler.py`:\n\n```python\n\"StatefulSet\",\n            ),\n            (\"LocalExecutor\", {\"celery\": {\"persistence\": {\"enabled\": False}}}, \"Deployment\"),\n            # Test workers.persistence.enabled flag when celery one is default (expected no impact on kind)\n            # Test workers.persistence.enabled flag when celery one is default\n            (\"CeleryExecutor\", {\"persistence\": {\"enabled\": False}}, \"Deployment\"),\n            (\"CeleryExecutor\", {\"persistence\": {\"enabled\": True}}, \"Deployment\"),\n            (\"CeleryKubernetesExecutor\", {\"persistence\": {\"enabled\": True}}, \"Deployment\"),\n            (\"CeleryExecutor,KubernetesExecutor\", {\"persistence\": {\"enabled\": True}}, \"Deployment\"),\n            (\"KubernetesExecutor\", {\"persistence\": {\"enabled\": True}}, \"Deployment\"),\n            (\"LocalKubernetesExecutor\", {\"persistence\": {\"enabled\": False}}, \"StatefulSet\"),\n            (\"LocalKubernetesExecutor\", {\"persistence\": {\"enabled\": False}}, \"Deployment\"),\n            (\"LocalKubernetesExecutor\", {\"persistence\": {\"enabled\": True}}, \"StatefulSet\"),\n            (\"LocalExecutor\", {\"persistence\": {\"enabled\": True}}, \"StatefulSet\"),\n            (\"LocalExecutor,KubernetesExecutor\", {\"persistence\": {\"enabled\": True}}, \"StatefulSet\"),\n            (\"LocalExecutor\", {\"persistence\": {\"enabled\": False}}, \"StatefulSet\"),\n            # Test workers.persistence.enabled flag when celery one is unset\n```"}, {"role": "assistant", "content": "Tests were testing if the unset behaviour of `workers.celery` will bring back the previous behaviour of the chart (not breaking change behaviour), so if we are removing it, they are not needed"}], "_meta": {"repo": "apache/airflow", "pr_number": 61049, "url": "https://github.com/apache/airflow/pull/61049#discussion_r2726021484"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asyncio.py`:\n\n```python\nfinally:\n            self._loop = loop\n\n    async def fork(\n        self,\n        coroutine1: typing.Callable,\n        args1: typing.Sequence,\n        coroutine2: typing.Callable,\n        args2: typing.Sequence,\n    ) -> None:\n        task1 = self.loop.create_task(coroutine1(*args1))\n        task2 = self.loop.create_task(coroutine2(*args2))\n\n        try:\n            await asyncio.gather(task1, task2)\n        finally:\n            pending: typing.Set[asyncio.Future[typing.Any]]  # Please mypy.\n            _, pending = await asyncio.wait({task1, task2}, timeout=0)\n            for task in pending:\n                task.cancel()\n                try:\n                    await task\n                except asyncio.CancelledError:\n                    pass\n```"}, {"role": "assistant", "content": "This'll look a bunch nicer with `anyio`. (Tho we should leave Trio's implementation alone, since they already *have* a sensible nursery primitive.)"}], "_meta": {"repo": "encode/httpx", "pr_number": 603, "url": "https://github.com/encode/httpx/pull/603#discussion_r354758409"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\ntotal_length = None\n    current_position = 0\n\n    if hasattr(o, \"__len__\"):\n    if isinstance(o, str):\n```"}, {"role": "assistant", "content": "Sounds fine to me. My usual workflow would be to rewrite my commit and do a force push to my branch (in my fork). Is this ok or would you prefer a separate commit for the change?"}], "_meta": {"repo": "psf/requests", "pr_number": 6589, "url": "https://github.com/psf/requests/pull/6589#discussion_r1409321632"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `handle_ipynb_magics.py`:\n\n```python\nreturn src\n\n\ndef _get_code_start(src: str) -> str:\n    \"\"\"Provides the first line where the code starts.\n\n    Iterates over lines of code until it finds the first line that doesn't\n    contain only empty spaces and comments. It removes any empty spaces at the\n    start of the line and returns it. If such line doesn't exist, it returns an\n    empty string.\n    \"\"\"\n    for match in re.finditer(\".+\", src):\n```"}, {"role": "assistant", "content": "There might be a slight performance difference because `re.finditer` will stop splitting string once the first line with code is found while `src.splitlines()` will always split the entire string by lines. But I haven't benchmarked anything and this probably won't affect much the performance of the entire formatting process.\r\n\r\nI'm also ok with switching to `src.splitlines()` if that is the preferred way."}], "_meta": {"repo": "psf/black", "pr_number": 4462, "url": "https://github.com/psf/black/pull/4462#discussion_r1765230879"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_proxy_connect.py`:\n\n```python\nimport json\nimport os\nimport re\nfrom subprocess import Popen, PIPE\nimport sys\n```"}, {"role": "assistant", "content": ":lipstick: I think the `subprocess` import should be below `sys`, being in the `from \u2026 import \u2026` form. See https://stackoverflow.com/a/20763446/939364"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4114, "url": "https://github.com/scrapy/scrapy/pull/4114#discussion_r341055144"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `kubernetes.py`:\n\n```python\nclient_configuration=self.client_configuration,\n                context=cluster_context,\n            )\n            return client.ApiClient()\n            return _TimeoutK8sApiClient()\n\n        return self._get_default_client(cluster_context=cluster_context)\n\n    def _get_default_client(self, *, cluster_context: str | None = None) -> client.ApiClient:\n    def _get_default_client(self, *, cluster_context: str | None = None) -> _TimeoutK8sApiClient:\n```"}, {"role": "assistant", "content": "Same as above: Recommend to keep return declaration compatible\n```suggestion\n    def _get_default_client(self, *, cluster_context: str | None = None) -> client.ApiClient:\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60254, "url": "https://github.com/apache/airflow/pull/60254#discussion_r2677653077"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `connections.py`:\n\n```python\ntry:\n        data = test_body.model_dump(by_alias=True)\n        data[\"conn_id\"] = transient_conn_id\n\n        try:\n            existing_conn = Connection.get_connection_from_secrets(test_body.connection_id)\n            if data.get(\"password\") is not None and existing_conn.password is not None:\n                data[\"password\"] = merge(data[\"password\"], existing_conn.password, \"password\")\n```"}, {"role": "assistant", "content": "I agree that if an API user provides both `connection_id` and `password`, the current behavior may not match what the user expects. Thanks for find this!\r\nI\u2019m currently thinking about how to resolve this, but it\u2019s starting to feel a bit complex as more conditions are added\ud83d\ude22\r\n\r\nI think I\u2019ll need to take a closer look later this evening. Understanding the secrets backend also feels somewhat complex, so it may take a bit more time."}], "_meta": {"repo": "apache/airflow", "pr_number": 59643, "url": "https://github.com/apache/airflow/pull/59643#discussion_r2637698743"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `serialize.py`:\n\n```python\nTIME_FORMAT = \"%H:%M:%S\"\n\n    def default(self, o: Any) -> Any:\n        warnings.warn(\n            \"'ScrapyJSONEncoder' is a deprecated setting.\\nIt will be removed in a future version of Scrapy.\",\n```"}, {"role": "assistant", "content": "What I meant here is that `ScrapyJSONEncoder` and `ScrapyJSONDecoder` are different classes (they are also not settings).\r\n\r\nMy stacklevel comment was about the other places where you care calling `warn()` with the default value of it."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6519, "url": "https://github.com/scrapy/scrapy/pull/6519#discussion_r1824027147"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `strings.py`:\n\n```python\nr\"^([\" + STRING_PREFIX_CHARS + r\"]*)(.*)$\", re.DOTALL\n)\nFIRST_NON_WHITESPACE_RE: Final = re.compile(r\"\\s*\\t+\\s*(\\S)\")\nUNICODE_RE = re.compile(\n```"}, {"role": "assistant", "content": "Should probably also make this Final.\r\n\r\nAnd using `re.MULTILINE` might be nice so you can put comments inside the regex."}], "_meta": {"repo": "psf/black", "pr_number": 2916, "url": "https://github.com/psf/black/pull/2916#discussion_r827592379"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_gpt2.py`:\n\n```python\noutputs = model.generate(\n            input_ids=input_ids,\n            attention_mask=inputs[\"attention_mask\"].to(torch_device),\n            max_length=20,\n            max_length=max_length,\n        )\n\n        outputs_tt = model.generate(\n            input_ids=input_ids,\n            attention_mask=inputs[\"attention_mask\"].to(torch_device),\n            token_type_ids=token_type_ids,\n            max_length=20,\n            max_length=max_length,\n        )\n\n        inputs_non_padded = tokenizer(sentences[0], return_tensors=\"pt\").input_ids.to(torch_device)\n        output_non_padded = model.generate(input_ids=inputs_non_padded, max_length=20)\n        output_non_padded = model.generate(input_ids=inputs_non_padded, max_length=max_length)\n\n        num_paddings = inputs_non_padded.shape[-1] - inputs[\"attention_mask\"][-1].long().sum().item()\n        inputs_padded = tokenizer(sentences[1], return_tensors=\"pt\").input_ids.to(torch_device)\n        output_padded = model.generate(\n            input_ids=inputs_padded, max_length=model.generation_config.max_length - num_paddings\n        )\n        output_padded = model.generate(input_ids=inputs_padded, max_length=max_length - num_paddings)\n```"}, {"role": "assistant", "content": "According to the CI dashboard, the test first appeared on 12-19-2025, and it seems to have been failing since then."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43231, "url": "https://github.com/huggingface/transformers/pull/43231#discussion_r2690992947"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_model_schema_generation.py`:\n\n```python\nreturn self.field\n\n    benchmark(rebuild_model, ModelWithValidator)\n\n\n@pytest.mark.benchmark(group='model_schema_generation')\ndef test_tagged_union_with_str_discriminator_schema_generation(benchmark):\n    class Cat(BaseModel):\n        pet_type: Literal['cat']\n        meows: int\n\n    class Dog(BaseModel):\n        pet_type: Literal['dog']\n        barks: float\n\n    class Lizard(BaseModel):\n        pet_type: Literal['reptile', 'lizard']\n        scales: bool\n\n    class Model(BaseModel):\n```"}, {"role": "assistant", "content": "```suggestion\r\n    class Model(DeferredModel):\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10362, "url": "https://github.com/pydantic/pydantic/pull/10362#discussion_r1766643746"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scraper.py`:\n\n```python\nself._log_download_errors, request_result, request, spider)\n\n    def call_spider(self, result, request, spider):\n        result.request = request\n        if getattr(result, \"request\", None) is None:\n            result.request = request\n```"}, {"role": "assistant", "content": "Actually, `result` can be a `Failure` object, that's what the attribute check is needed: https://github.com/scrapy/scrapy/pull/4618/commits/3992338573ba64f8c7ebaf5cee919068fcdd2ea9#diff-d12d4e527e55eef105fcf232ef856619R80-R83"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4632, "url": "https://github.com/scrapy/scrapy/pull/4632#discussion_r440976725"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\nfrom __future__ import annotations\n\nimport argparse\nimport itertools as it\nimport json\nimport re\nimport subprocess\nimport sys\nfrom dataclasses import dataclass\nfrom enum import Flag, StrEnum, auto\nfrom functools import reduce\nfrom operator import attrgetter, or_\nfrom pathlib import Path\nfrom textwrap import dedent\nfrom typing import Any, Self\n\nCONFORMANCE_ERROR_PATTERN = re.compile(r\"#\\s*E(?:\\s*(?::\\s*(.+)|\\[(.+)\\]))?\\s*\")\n```"}, {"role": "assistant", "content": "Could you add a comment that documents what this regex intends to capture? You could consider using the `re.VERBOSE` flag: https://docs.python.org/3/library/re.html#re.VERBOSE"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22231, "url": "https://github.com/astral-sh/ruff/pull/22231#discussion_r2680018594"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nself.storages = self._load_components('FEED_STORAGES')\n        self.exporters = self._load_components('FEED_EXPORTERS')\n        self.storage_batch_item_count = self.settings.getint('FEED_STORAGE_BATCH_ITEM_COUNT')\n        for uri, feed in self.feeds.items():\n            if not self._storage_supported(uri):\n                raise NotConfigured\n            if not self._settings_are_valid(uri):\n                raise NotConfigured\n            if not self._exporter_supported(feed['format']):\n                raise NotConfigured\n\n    def open_spider(self, spider):\n        for uri, feed in self.feeds.items():\n            uri = uri % self._get_uri_params(spider, feed['uri_params'])\n            storage = self._get_storage(uri)\n            file = storage.open(spider)\n            exporter = self._get_exporter(\n                file=file,\n                format=feed['format'],\n                fields_to_export=feed['fields'],\n                encoding=feed['encoding'],\n                indent=feed['indent'],\n            )\n            slot = _FeedSlot(file, exporter, storage, uri, feed['format'], feed['store_empty'])\n            self.slots.append(slot)\n            if slot.store_empty:\n                slot.start_exporting()\n            uri_params = self._get_uri_params(spider, feed['uri_params'], None)\n```"}, {"role": "assistant", "content": "I think it would be better to set `None` as default value for `slot` in `_get_uri_params` ."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4434, "url": "https://github.com/scrapy/scrapy/pull/4434#discussion_r446733210"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_responses.py`:\n\n```python\nheaders = {\"Content-Length\": \"8\"}\n    response = httpx.Response(200, content=content(), headers=headers)\n    assert response.headers == {\"Content-Length\": \"8\"}\n\n\ndef test_response_picklable():\n    response = httpx.Response(\n        200,\n        content=b\"Hello, world!\",\n        request=httpx.Request(\"GET\", \"https://example.org\"),\n    )\n    pickle_response = pickle.loads(pickle.dumps(response))\n    assert pickle_response.is_closed is True\n    assert pickle_response.is_stream_consumed is True\n    assert pickle_response.next_request is None\n    assert pickle_response.stream is not None\n    assert pickle_response.content == b\"Hello, world!\"\n    assert pickle_response.status_code == 200\n    assert pickle_response.request.url == response.request.url\n    assert pickle_response.extensions == {}\n    assert pickle_response.history == []\n\n\n@pytest.mark.asyncio\nasync def test_response_async_streaming_picklable():\n    response = httpx.Response(200, content=async_streaming_body())\n    pickle_response = pickle.loads(pickle.dumps(response))\n    assert hasattr(pickle_response, \"_content\") is False\n    with pytest.raises(httpx.ResponseClosed):  # TODO: StreamClosed\n        await pickle_response.aread()\n    assert pickle_response.is_stream_consumed is False\n    assert pickle_response._num_bytes_downloaded == 0\n```"}, {"role": "assistant", "content": "Let's aim to test against public API wherever possible.\r\n\r\nEg. in this case let's access the property instead, so... `assert pickle_response.num_bytes_downloaded == 0`"}], "_meta": {"repo": "encode/httpx", "pr_number": 1579, "url": "https://github.com/encode/httpx/pull/1579#discussion_r616496859"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\nref = getattr(module_obj, param_name)\n    if ref is None:\n        unexpected_keys.add(target_name)\n        return\n\n    # case where we use local_rowise/colwise\n    is_local_tensor = not getattr(distributed_operation, \"use_dtensor\", True)\n    if distributed_operation is not None:\n        param_value = DTensor.from_local(\n            param_value,\n            distributed_operation.device_mesh,\n            getattr(distributed_operation, \"shard\", Replicate()),\n            run_check=False,\n            shape=ref.size(),\n            stride=ref.stride(),\n        )\n\n    # Remove from missing keys (it's either mismatched, or all good)\n    missing_keys.discard(target_name)\n    if ref is not None and ref.shape != param_value.shape and hf_quantizer is None:\n        mismatch_keys.add((target_name, param_value.shape, ref.shape))\n        return\n\n    # local_rowise/colwise case\n    if is_local_tensor and isinstance(param_value, DTensor):\n        param_value = param_value.to_local()\n\n    if param_name not in module_obj._buffers:\n        param_value = torch.nn.Parameter(param_value, requires_grad=param_value.is_floating_point())\n\n    param_value._is_hf_initialized = True\n\n    setattr(module_obj, param_name, param_value)\n    else:\n        if not isinstance(param_value, torch.nn.Parameter):\n            if distributed_operation is not None:\n                device_mesh = distributed_operation.device_mesh\n                target_device = torch.device(f\"{device_mesh.device_type}:{device_mesh.get_local_rank()}\")\n                param_value = param_value.to(target_device)\n            if param_name not in module_obj._buffers:\n                param_value = torch.nn.Parameter(param_value, requires_grad=param_value.is_floating_point())\n\n        # Remove from missing keys (it's either mismatched, or all good)\n        missing_keys.discard(target_name)\n        # Skip shape check when tensor parallel sharding is applied (shape is intentionally different)\n```"}, {"role": "assistant", "content": "this is not really optimal, we should build / copy the utils or just create a dummy Dtensor with meta device just to let it handle the shape! But we cannot ship without shape checking IMO!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43157, "url": "https://github.com/huggingface/transformers/pull/43157#discussion_r2681761870"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nTODO support functional validators once we support them in Config\n        \"\"\"\n        sig = signature(function)\n        globalns, localns = self._types_namespace\n        type_hints = _typing_extra.get_function_type_hints(function, globalns=globalns, localns=localns)\n        arguments_schema = self._arguments_schema(function)\n\n        return_schema: core_schema.CoreSchema | None = None\n        config_wrapper = self._config_wrapper\n        if config_wrapper.validate_return:\n            sig = signature(function)\n            return_hint = sig.return_annotation\n            if return_hint is not sig.empty:\n                globalns, localns = self._types_namespace\n                type_hints = _typing_extra.get_function_type_hints(\n                    function, globalns=globalns, localns=localns, include_keys={'return'}\n                )\n                return_schema = self.generate_schema(type_hints['return'])\n\n        return core_schema.call_schema(\n            arguments_schema,\n            function,\n            return_schema=return_schema,\n        )\n\n    def _arguments_schema(\n        self, function: ValidateCallSupportedTypes, parameters_callback: Callable[[int, str, Any], Any] | None = None\n    ) -> core_schema.ArgumentsSchema:\n        \"\"\"Generate schema for a Signature.\"\"\"\n        mode_lookup: dict[_ParameterKind, Literal['positional_only', 'positional_or_keyword', 'keyword_only']] = {\n            Parameter.POSITIONAL_ONLY: 'positional_only',\n            Parameter.POSITIONAL_OR_KEYWORD: 'positional_or_keyword',\n            Parameter.KEYWORD_ONLY: 'keyword_only',\n        }\n\n        sig = signature(function)\n        globalns, localns = self._types_namespace\n        type_hints = _typing_extra.get_function_type_hints(function, globalns=globalns, localns=localns)\n\n        arguments_list: list[core_schema.ArgumentsParameter] = []\n        var_args_schema: core_schema.CoreSchema | None = None\n        var_kwargs_schema: core_schema.CoreSchema | None = None\n        var_kwargs_mode: core_schema.VarKwargsMode | None = None\n\n        for name, p in sig.parameters.items():\n        for i, (name, p) in enumerate(sig.parameters.items()):\n            if p.annotation is sig.empty:\n                annotation = typing.cast(Any, Any)\n            else:\n                annotation = type_hints[name]\n\n            if parameters_callback is not None:\n                from pydantic.validate_call_decorator import SKIP\n```"}, {"role": "assistant", "content": "```suggestion\r\n                from ..validate_call_decorator import SKIP\r\n```\r\nlooks like we mostly do relative imports in this file.\r\n\r\nAlso shouldn't this be outside the for loop?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11572, "url": "https://github.com/pydantic/pydantic/pull/11572#discussion_r2006053347"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `serialized_dag.py`:\n\n```python\nserialized_dag_hash = session.scalars(\n            select(cls.dag_hash).where(cls.dag_id == dag.dag_id).order_by(cls.created_at.desc())\n        ).first()\n        dag_version = DagVersion.get_latest_version(dag.dag_id, session=session)\n        dag_version = session.scalar(\n            select(DagVersion)\n            .where(DagVersion.dag_id == dag.dag_id)\n            .options(joinedload(DagVersion.task_instances))\n            .options(joinedload(DagVersion.serialized_dag))\n```"}, {"role": "assistant", "content": "Yeah, though not fully wrong. Line 438 was supposed to use the serdag.\n\n`latest_ser_dag = dag_version.serialized_dag`\n\nbut omitted. I will open a PR to address it"}], "_meta": {"repo": "apache/airflow", "pr_number": 56422, "url": "https://github.com/apache/airflow/pull/56422#discussion_r2476728037"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_format.py`:\n\n```python\n)\n\n\n@pytest.mark.parametrize(\"filename\", PY310_CASES)\n@pytest.mark.parametrize(\"filename\", all_data_cases(\"py_310\"))\ndef test_python_310(filename: str) -> None:\n    source, expected = read_data(filename)\n    mode = black.Mode(target_versions={black.TargetVersion.PY310})\n    assert_format(source, expected, mode, minimum_version=(3, 10))\n\n\ndef test_python_310_without_target_version() -> None:\n    source, expected = read_data(\"pattern_matching_simple\")\n@pytest.mark.parametrize(\"filename\", all_data_cases(\"py_310\"))\n```"}, {"role": "assistant", "content": "I thought that this is the right thing to do, because the test is not specific for \"pattern_matching_simple\""}], "_meta": {"repo": "psf/black", "pr_number": 3062, "url": "https://github.com/psf/black/pull/3062#discussion_r867986554"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\n\"\"\"Performs validation related to the resulting generated length\"\"\"\n\n        # 1. Max length warnings related to poor parameterization\n        if has_default_max_length and generation_config.max_new_tokens is None and generation_config.max_length == 20:\n        if (\n```"}, {"role": "assistant", "content": "I guess we need this because compile causes a graph break on warning/loggers. Why don't we add the same cond for the later warnings about \"min_length\"?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 30788, "url": "https://github.com/huggingface/transformers/pull/30788#discussion_r1615773056"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `create_circleci_config.py`:\n\n```python\npytest_flags.append(\n            f\"--make-reports={self.name}\" if \"examples\" in self.name else f\"--make-reports=tests_{self.name}\"\n        )\n        # Use CIRCLE_BUILD_NUM as seed for pytest-random-order to ensure:\n        # - Different randomization for each build/PR\n        # - Same seed across all parallel containers in a build (reproducible)\n        # - Deterministic test order for debugging failures\n        # - bucket=module randomizes within each file, works well with --dist=loadfile\n        pytest_flags.append(\"--random-order-bucket=module\")\n        pytest_flags.append(\"--random-order-seed=${CIRCLE_BUILD_NUM:-0}\")\n```"}, {"role": "assistant", "content": "`{CIRCLE_BUILD_NUM:-0}` means if that variable is not found it fallbacks to `0`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43483, "url": "https://github.com/huggingface/transformers/pull/43483#discussion_r2726998574"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_discriminated_union.py`:\n\n```python\nassert str(yard_dict['pet']['type']) == 'dog'\n\n\n@pytest.mark.thread_unsafe(reason='Passes on multithreaded. This needs to be investigated further.')\n```"}, {"role": "assistant", "content": "While all the other tests marked as thread unsafe made sense, I have no idea why this one passes. Core schemas are identical, and verified it isn't a late lambda binding issue. Might be something in core?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11516, "url": "https://github.com/pydantic/pydantic/pull/11516#discussion_r1978024887"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nfield_name: str | None,\n) -> core_schema.CoreSchema:\n    # This V1 compatibility shim should eventually be removed\n    if not each_item_validators:\n        return schema\n```"}, {"role": "assistant", "content": "Or we can even omit the comment bc the behavior is clear, but at least add a line between this and the comment above"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9950, "url": "https://github.com/pydantic/pydantic/pull/9950#discussion_r1689986810"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_gemma3n.py`:\n\n```python\npast_key_values: Optional[Cache] = None,\n        inputs_embeds: Optional[torch.FloatTensor] = None,\n        use_cache: Optional[bool] = None,\n        output_attentions: Optional[bool] = None,\n        output_hidden_states: Optional[bool] = None,\n        cache_position: Optional[torch.LongTensor] = None,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> BaseModelOutputWithPast:\n        r\"\"\"\n        per_layer_inputs (torch.Tensor, *optional*, defaults to None):\n            Pre-computed per-layer embeddings. If None, they are derived from input_ids if provided.\n        \"\"\"\n        output_attentions = output_attentions if output_attentions is not None else self.config.output_attentions\n        output_hidden_states = (\n            output_hidden_states if output_hidden_states is not None else self.config.output_hidden_states\n        )\n        use_cache = use_cache if use_cache is not None else self.config.use_cache\n\n        if (input_ids is None) ^ (inputs_embeds is not None):\n            raise ValueError(\"You must specify exactly one of input_ids or inputs_embeds\")\n\n        if self.gradient_checkpointing and self.training and use_cache:\n            logger.warning_once(\n                \"`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.\"\n            )\n            use_cache = False\n\n        if input_ids is not None:\n            inputs_embeds = self.embed_tokens(input_ids)\n            per_layer_inputs = self.get_per_layer_inputs(input_ids)\n\n        per_layer_inputs = self.project_per_layer_inputs(inputs_embeds, per_layer_inputs)\n\n        if use_cache and past_key_values is None and not self.training:\n        if use_cache and past_key_values is None:\n            past_key_values = DynamicCache(config=self.config)\n\n        if cache_position is None:\n            past_seen_tokens = past_key_values.get_seq_length() if past_key_values is not None else 0\n            cache_position = torch.arange(\n                past_seen_tokens,\n                past_seen_tokens + inputs_embeds.shape[1],\n                device=inputs_embeds.device,\n            )\n            cache_position = torch.arange(inputs_embeds.shape[1], device=inputs_embeds.device) + past_seen_tokens\n```"}, {"role": "assistant", "content": "Hmm, that was to avoid a device sync iirc? Just fmi"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42586, "url": "https://github.com/huggingface/transformers/pull/42586#discussion_r2585912534"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_config.py`:\n\n```python\nassert m == m.model_copy()\n\n    def test_config_class_is_deprecated(self):\n        with warnings.catch_warnings():\n            # we need to explicitly ignore the other warning in pytest-8\n            # TODO: rewrite it to use two nested pytest.warns() when pytest-7 is no longer supported\n            warnings.simplefilter('ignore')\n            with pytest.warns(\n                PydanticDeprecatedSince20,\n                match='Support for class-based `config` is deprecated, use ConfigDict instead.',\n            ):\n\n                class Config(BaseConfig):\n                    pass\n        with pytest.warns(PydanticDeprecatedSince20) as all_warnings:\n\n            class Config(BaseConfig):\n                pass\n\n        assert len(all_warnings) == 2\n        expected_warnings = [\n            'BaseConfig is deprecated. Use the `pydantic.ConfigDict` instead',\n            'Support for class-based `config` is deprecated, use ConfigDict instead',\n        ]\n        assert [w.message.message for w in all_warnings] == expected_warnings\n\n    def test_config_class_attributes_are_deprecated(self):\n```"}, {"role": "assistant", "content": "I doubt this one can be nested -- since `typing-extensions=4.6.1` only emits one warning rather two, there'd still be a failure when the outer block doesn't throw a warning."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9702, "url": "https://github.com/pydantic/pydantic/pull/9702#discussion_r1648360922"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_utils_datatypes.py`:\n\n```python\nself.assertIn(set(\"bar\"), d)\n\n        # supplied sequence is a set, so checking for list (non)inclusion fails\n        self.assertRaises(TypeError, (0, 1, 2) in d)\n        self.assertRaises(TypeError, d.__contains__, [\"a\", \"b\", \"c\"])\n        with pytest.raises(TypeError):\n            [0, 1, 2] in d  # noqa: B015\n        with pytest.raises(TypeError):\n            d.__contains__([\"a\", \"b\", \"c\"])\n```"}, {"role": "assistant", "content": "```suggestion\r\n            [\"a\", \"b\", \"c\"] in d\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6680, "url": "https://github.com/scrapy/scrapy/pull/6680#discussion_r1973324614"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_http2_client_protocol.py`:\n\n```python\ndef assert_metadata(response: Response):\n            self.assertEqual(response.request, request)\n            self.assertIsInstance(response.certificate, Certificate)\n            assert response.certificate  # typing\n```"}, {"role": "assistant", "content": "I haven't found how to make mypy look at ~~pytest~~ unittest asserts :)"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6127, "url": "https://github.com/scrapy/scrapy/pull/6127#discussion_r1378207687"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `requests.py`:\n\n```python\nerror=self.error,\n            timestamps=self.timestamps,\n        )\n\n    def fork(self, new_request_id: str) -> \"RequestState\":\n        \"\"\"Fork the request into a new request with the same state expect for request_id, created_time and lifespan.\"\"\"\n        new = deepcopy(self)\n```"}, {"role": "assistant", "content": "Ok, makes sense. I deepcopied the attributes that are mutable and changed during generation"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42921, "url": "https://github.com/huggingface/transformers/pull/42921#discussion_r2664712134"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_buffer.py`:\n\n```python\nwith self.assertRaises(SystemError):\n            obj.__buffer__(inspect.BufferFlags.WRITE)\n\n    @support.cpython_only\n    @unittest.skipIf(_testcapi is None, \"requires _testcapi\")\n    def test_bytearray_alignment(self):\n        # gh-140557: pointer alignment of buffers including empty allocation\n        # should be at least to `size_t`.\n        align = struct.calcsize(\"N\")\n        cases = [\n            bytearray(),\n            bytearray(1),\n            bytearray(b\"0123456789abcdef\"),\n            bytearray(16),\n        ]\n        ptrs = [_testcapi.buffer_pointer_as_int(array) for array in cases]\n        self.assertEqual([ptr % align for ptr in ptrs], [0]*len(ptrs))\n\n    @support.cpython_only\n    @unittest.skipIf(_testcapi is None, \"requires _testcapi\")\n    def test_array_alignment(self):\n        # gh-140557: pointer alignment of buffers including empty allocation\n        # should be at least to `size_t`.\n        align = struct.calcsize(\"N\")\n```"}, {"role": "assistant", "content": "Chatted with a Rust export on the \"Rust for CPython Discord\". Came to the conclusion with them that we should align `array.array` to 8 bytes since it can store 8 byte things (typecodes: \"qQd\", https://docs.python.org/3/library/array.html#array.array). On 32 bit platforms `size_t` will only require 4 byte alignment.\n\nRather than `struct.calcsize(\"N\")` I think we can just use the constant 8 here + have a comment pointing to the item size table in the `array.array`doc?"}], "_meta": {"repo": "python/cpython", "pr_number": 140559, "url": "https://github.com/python/cpython/pull/140559#discussion_r2671464284"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\n@classmethod\n    def __pydantic_init_subclass__(cls, **kwargs: Any) -> None:\n        \"\"\"This is intended to behave just like `__init_subclass__`, but is called by `ModelMetaclass`\n        only after the class is actually fully initialized. In particular, attributes like `model_fields` will\n        be present when this is called.\n        only after basic class initialization is complete. In particular, attributes like `model_fields` will\n        be present when this is called, but forward annotations are not guaranteed to be resolved yet,\n        meaning that creating an instance of the class may fail.\n\n        This is necessary because `__init_subclass__` will always be called by `type.__new__`,\n        and it would require a prohibitively large refactor to the `ModelMetaclass` to ensure that\n        `type.__new__` was called in such a manner that the class would already be sufficiently initialized.\n\n        This will receive the same `kwargs` that would be passed to the standard `__init_subclass__`, namely,\n        any kwargs passed to the class definition that aren't used internally by pydantic.\n        any kwargs passed to the class definition that aren't used internally by Pydantic.\n\n        Args:\n            **kwargs: Any keyword arguments passed to the class definition that aren't used internally\n                by pydantic.\n                by Pydantic.\n\n        Note:\n            You may want to override `__pydantic_on_complete__` instead, which is called once the class\n            and its fields are fully initialized and ready for validation.\n        \"\"\"\n        pass\n\n    @classmethod\n    def __pydantic_on_complete__(cls) -> None:\n        \"\"\"This is called once the class and its fields are fully initialized and ready to be used.\n\n        This typically happens when the class is created (just before `__pydantic_init_subclass__` is\n```"}, {"role": "assistant", "content": "```suggestion\r\n        This typically happens when the class is created (just before [`__pydantic_init_subclass__()`][pydantic.BaseModel.__pydantic_init_subclass__] is\r\n```\r\n\r\nline length might have to be adjusted."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11762, "url": "https://github.com/pydantic/pydantic/pull/11762#discussion_r2056643554"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asyncio.py`:\n\n```python\n\"\"\"Utilities related to asyncio and its support in Scrapy.\"\"\"\n\nfrom scrapy.utils.reactor import is_asyncio_reactor_installed, is_reactor_installed\n\n\ndef is_asyncio_available() -> bool:\n    \"\"\"Check if it's possible to call asyncio code that relies on the asyncio event loop.\n\n    .. versionadded:: VERSION\n\n    Currently this function is identical to\n    :func:`scrapy.utils.reactor.is_asyncio_reactor_installed`: it returns\n    ``True`` if the Twisted reactor that is installed is\n    :class:`~twisted.internet.asyncioreactor.AsyncioSelectorReactor`, returns\n    ``False`` if a different reactor is installed, and raises a\n    :exc:`RuntimeError` if no reactor is installed. In a future Scrapy version,\n    when Scrapy supports running without a Twisted reactor, this function will\n    also return ``True`` when running in that mode, so code that doesn't\n    directly require a Twisted reactor should use this function instead of\n    :func:`~scrapy.utils.reactor.is_asyncio_reactor_installed`.\n\n    When this returns ``True``, an asyncio loop is installed and used by\n    Scrapy. It's possible to call functions that require it, such as\n    :func:`asyncio.sleep`, and await on :class:`asyncio.Future` objects in\n    Scrapy-related code.\n\n    When this returns ``False``, a non-asyncio Twisted reactor is installed.\n    It's not possible to use asyncio features that require an asyncio event\n    loop or await on :class:`asyncio.Future` objects in Scrapy-related code,\n    but it's possible to await on :class:`~twisted.internet.defer.Deferred`\n    objects.\n    \"\"\"\n    if not is_reactor_installed():\n```"}, {"role": "assistant", "content": "No, it should be possible to test, I'll add a test."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6827, "url": "https://github.com/scrapy/scrapy/pull/6827#discussion_r2111187297"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pipeline.py`:\n\n```python\n@pytest.mark.parametrize(\n    'type_, pipeline, valid_cases, invalid_cases',\n    [\n        (int, validate_as(int).multiple_of(5), [5, 20, 0], [18, 7]),\n        (float, validate_as(float).multiple_of(2.5), [2.5, 5.0, 7.5], [3.0, 1.1]),\n        (int, validate_as(int).multiple_of(5), [5, 20, 0], [18, 7]),  # type: ignore\n```"}, {"role": "assistant", "content": "It had to do with the typing of `multiple_of`. I'm still not 100% certain it's correct but since it's just typing good enough."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9674, "url": "https://github.com/pydantic/pydantic/pull/9674#discussion_r1643516633"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `item.py`:\n\n```python\nfrom collections.abc import MutableMapping\n\nfrom scrapy.item import BaseItem\n\n\ndef _is_dataclass_instance(obj):\n    \"\"\"\n    Return True if *obj* is a dataclass object, False otherwise.\n    Taken from https://docs.python.org/3/library/dataclasses.html#dataclasses.is_dataclass.\n    \"\"\"\n    try:\n        from dataclasses import is_dataclass\n    except ImportError:\n        return False\n    else:\n        return is_dataclass(obj) and not isinstance(obj, type)\n\n\ndef is_item_like(obj):\n    \"\"\"\n    Return True if *obj* is considered a Scrapy *item*, False otherwise.\n\n    An object is considered an *item* if it is:\n    - a scrapy.item.BaseItem or dict instance (or any subclass)\n    - a dataclass object\n    \"\"\"\n    return isinstance(obj, (BaseItem, dict)) or _is_dataclass_instance(obj)\n\n\nclass ItemAdapter(MutableMapping):\n```"}, {"role": "assistant", "content": "That makes sense to me :+1:  My idea was to start working on `attrs` support once we got the `ItemAdapter` class merged.\r\nI can create a repo under my account and start working on it, we can transfer it later. Does that sound good?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 3881, "url": "https://github.com/scrapy/scrapy/pull/3881#discussion_r410463830"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `serialized_dag.py`:\n\n```python\nreturn self.__data_cache\n\n    @classmethod\n    def _reconstruct_deadline_alerts(\n        cls,\n        dag_data: dict[str, Any],\n        serialized_dag_id: str,\n        session: Session,\n    ) -> dict[str, Any]:\n        \"\"\"\n        Reconstruct DeadlineAlert objects from UUID references during deserialization.\n\n        Queries the deadline_alert table to fetch full DeadlineAlert definitions\n        and reconstructs them in the serialized format expected by SerializedDAG.\n\n        :param dag_data: The serialized Dag data dictionary\n        :param serialized_dag_id: The serialized_dag ID\n        \"\"\"\n        dag_deadline_data = dag_data.get(\"dag\", {}).get(\"deadline\")\n        if not dag_deadline_data:\n            return dag_data\n\n        deadline_list = dag_deadline_data if isinstance(dag_deadline_data, list) else [dag_deadline_data]\n        deadline_alerts_by_id = {\n            str(alert.id): alert\n            for alert in session.execute(\n                select(DeadlineAlertModel).filter(\n                    DeadlineAlertModel.id.in_(deadline_list),\n                    DeadlineAlertModel.serialized_dag_id == serialized_dag_id,\n                )\n            )\n            .scalars()\n```"}, {"role": "assistant", "content": "Thanks!   I was a bit confused on when to use one vs the other, I think that makes sense now.  I'll make the changes."}], "_meta": {"repo": "apache/airflow", "pr_number": 58248, "url": "https://github.com/apache/airflow/pull/58248#discussion_r2563930843"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nself._type = type\n        self._config = config\n        self._parent_depth = _parent_depth\n\n        if module is None:\n            f = sys._getframe(1)\n            self._module_name = cast(str, f.f_globals.get('__name__', ''))\n        else:\n            self._module_name = module\n\n        self._core_schema: CoreSchema | None = None\n        self._validator: SchemaValidator | PluggableSchemaValidator | None = None\n        self._serializer: SchemaSerializer | None = None\n        self.core_schema: CoreSchema\n        self.validator: SchemaValidator | PluggableSchemaValidator\n        self.serializer: SchemaSerializer\n\n        localns: _namespace_utils.MappingNamespace = (\n            _typing_extra.parent_frame_namespace(parent_depth=self._parent_depth) or {}\n        )\n        globalns: _namespace_utils.GlobalsNamespace = sys._getframe(max(self._parent_depth - 1, 1)).f_globals.copy()\n        ns_resolver = _namespace_utils.NsResolver(\n            namespaces_tuple=_namespace_utils.NamespacesTuple(locals=localns, globals=globalns),\n            parent_namespace=localns,\n        )\n        self._init_core_attrs(ns_resolver=ns_resolver, force=False)\n\n    def _init_core_attrs(self, ns_resolver: _namespace_utils.NsResolver, force: bool) -> bool:\n        \"\"\"Initialize the core schema, validator, and serializer for the type.\n\n        if not self._defer_build():\n            # Immediately initialize the core schema, validator and serializer\n            with self._with_frame_depth(1):  # +1 frame depth for this __init__\n                # Model itself may be using deferred building. For backward compatibility we don't rebuild model mocks\n                # here as part of __init__ even though TypeAdapter itself is not using deferred building.\n                self._init_core_attrs(rebuild_mocks=False)\n        If `force` is set to `False` and `_defer_build` is `True`, the core schema, validator, and serializer will be set to mocks.\n\n    @contextmanager\n    def _with_frame_depth(self, depth: int) -> Iterator[None]:\n        self._parent_depth += depth\n        try:\n            yield\n        finally:\n            self._parent_depth -= depth\n        Args:\n            ns_resolver: The namespace resolver to use when building the core schema for the adapted type.\n            force: Whether to force the initialization of the core schema, validator, and serializer.\n\n        Returns:\n            `True` if the core schema, validator, and serializer were successfully initialized, otherwise `False`.\n        \"\"\"\n        if not force and self._defer_build:\n            _mock_val_ser.set_type_adapter_mocks(self, str(self._type))\n            self._pydantic_complete = False\n```"}, {"role": "assistant", "content": "Well maybe not, as we dont use \"dunder like\" attrs here anyways in TypeAdapter"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10537, "url": "https://github.com/pydantic/pydantic/pull/10537#discussion_r1838401242"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conftest.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport os\n\nos.environ[\"_AIRFLOW__AS_LIBRARY\"] = \"true\"\n```"}, {"role": "assistant", "content": "Not a fan with this global side effect on import, especially since this leaks out of the tests (if you run multiple directories together)"}], "_meta": {"repo": "apache/airflow", "pr_number": 59883, "url": "https://github.com/apache/airflow/pull/59883#discussion_r2671243273"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_tutorial002.py`:\n\n```python\n}\n                ]\n            }\n        )\n        | IsDict(\n            # TODO: remove when deprecating Pydantic v1\n```"}, {"role": "assistant", "content": "Can we add it to the function? \r\n\r\n\"Remove v1 argument when deprecating Pydantic v1\"\r\n\r\nMaybe we can use codecrumbs in the future to clean things up. \r\n\r\nThere are a lot of refactorings missing which would be needed for this. But it would be a reason to continue this project :-)"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 12534, "url": "https://github.com/fastapi/fastapi/pull/12534#discussion_r2019206861"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `item.py`:\n\n```python\nclass Item(MutableMapping[str, Any], object_ref, metaclass=ItemMeta):\n    \"\"\"\n    Base class for scraped items.\n\n    In Scrapy, an object is considered an ``item`` if it is an instance of either\n    :class:`Item` or :class:`dict`, or any subclass. For example, when the output of a\n    spider callback is evaluated, only instances of :class:`Item` or\n    :class:`dict` are passed to :ref:`item pipelines <topics-item-pipeline>`.\n    \"\"\"Base class for scraped items.\n\n    If you need instances of a custom class to be considered items by Scrapy,\n    you must inherit from either :class:`Item` or :class:`dict`.\n    In Scrapy, an object is considered an ``item`` if it's supported by the\n    `itemadapter`_ library. For example, when the output of a spider callback\n    is evaluated, only such objects are passed to :ref:`item pipelines\n    <topics-item-pipeline>`. :class:`Item` is one of the classes supported by\n    `itemadapter`_ by default.\n\n    Items must declare :class:`Field` attributes, which are processed and stored\n```"}, {"role": "assistant", "content": "There is also another problem, the fragments in generated links: https://docs.scrapy.org/en/latest/topics/items.html#scrapy.item.scrapy.item.Item\r\n\r\nProbably because of `.. module:: scrapy.item` at the beginning of items.rst?\r\n\r\nAnd what do you think about adding the docstring to the documentation page, or is it a separate more general task?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6427, "url": "https://github.com/scrapy/scrapy/pull/6427#discussion_r1665254868"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `training_args.py`:\n\n```python\nself.deepspeed_plugin.set_mixed_precision(self.mixed_precision)\n            self.deepspeed_plugin.set_deepspeed_weakref()\n\n        # Override enable_jit_checkpoint from environment if set\n        if \"HF_ENABLE_JIT_CHECKPOINT\" in os.environ:\n            self.enable_jit_checkpoint = strtobool(os.environ.get(\"HF_ENABLE_JIT_CHECKPOINT\"))\n\n        # Override save_strategy from environment if set\n        if \"HF_SAVE_STRATEGY\" in os.environ:\n            self.save_strategy = os.environ.get(\"HF_SAVE_STRATEGY\")\n\n        # Override save_steps from environment if set\n        if \"HF_SAVE_STEPS\" in os.environ:\n            self.save_steps = float(os.environ.get(\"HF_SAVE_STEPS\"))\n\n        # Override save_total_limit from environment if set\n        if \"HF_SAVE_TOTAL_LIMIT\" in os.environ:\n            self.save_total_limit = int(os.environ.get(\"HF_SAVE_TOTAL_LIMIT\"))\n\n        # Override output_dir from environment if set\n        if \"HF_OUTPUT_DIR\" in os.environ:\n            self.output_dir = os.environ.get(\"HF_OUTPUT_DIR\")\n\n        # Override resume_from_checkpoint from environment if set\n        if \"HF_RESUME_FROM_CHECKPOINT\" in os.environ:\n            self.resume_from_checkpoint = os.environ.get(\"HF_RESUME_FROM_CHECKPOINT\")\n```"}, {"role": "assistant", "content": "Is there a specific reason you want to do that ? I prefer to not rely on env var as much as possible."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41723, "url": "https://github.com/huggingface/transformers/pull/41723#discussion_r2546657432"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `django.py`:\n\n```python\nself._db_recycles += 1\n\n    def _close_database(self) -> None:\n        for conn in self._db.connections.all():\n        for conn in self._db.connections.all(initialized_only=True):\n```"}, {"role": "assistant", "content": "how would you suggest we address this issue? The oldest version of Django that is still being supported by the Django team is 4.2. The previous LTS version was 3.2 which was EOL in April 2024.\r\n\r\nI also notice that the docs state that the django requirement is for informational purposes only and \"You should probably not use this in your requirements, it's here for informational purposes only.\" It also isn't used in any tests.\r\n\r\nFor now I've gone ahead and wrapped the method call in exception handling which seems like the path of least resistance for now."}], "_meta": {"repo": "celery/celery", "pr_number": 10015, "url": "https://github.com/celery/celery/pull/10015#discussion_r2597528350"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nreturn max(cast(int, self.getpriority(name)) for name in self)\n        return get_settings_priority(\"default\")\n\n    def replace_in_component_list(\n        self, name: _SettingsKeyT, old_cls: type, new_cls: type, pos: int | None = None\n    ) -> None:\n        \"\"\"Replace *old_cls* with *new_cls* in the *name* component list.\n\n        If *old_cls* is missing, :exc:`KeyError` is raised.\n\n        If *old_cls* was present as an import string, even more than once,\n        those keys are dropped and replaced by *new_cls*.\n\n        If *pos* is specified, that is the value assigned to *new_cls* in the\n        component list. Otherwise, the value of *old_cls* is used. If *old_cls*\n        was present multiple times (possible with import strings) with\n        different values, the value assigned to *new_cls* is one of them, with\n        no guarantee about which one it is.\n\n        This change is applied regardless of the priority of the *name*\n        setting. The setting priority is not affected by this change either.\n        \"\"\"\n        component_list = self.getdict(name)\n        old_pos = None\n        for cls_or_path in tuple(component_list):\n            if isinstance(cls_or_path, str):\n                _cls = load_object(cls_or_path)\n            else:\n                _cls = cls_or_path\n            if _cls == old_cls:\n```"}, {"role": "assistant", "content": "I ended up checking for identity instead of using `issubclass` and raising an exception if `old_cls` is not found, with the idea that add-ons can then log a warning or error to let the user know. Still not completely sure if this is the right approach, and even if so, whether or not we should provide the option to check for subclasses."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6614, "url": "https://github.com/scrapy/scrapy/pull/6614#discussion_r1915107488"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_rope_utils.py`:\n\n```python\n}\n\n\ndef rope_config_validation(config: PreTrainedConfig, ignore_keys: Optional[set] = None):\ndef rope_config_standardize_and_validate(config: PreTrainedConfig, ignore_keys: Optional[set] = None):\n```"}, {"role": "assistant", "content": "Why not introduce a wrapper around both functions instead? Then we have standardize, validate, and the wrapper that calls both subsequently - nothing gets broken"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42255, "url": "https://github.com/huggingface/transformers/pull/42255#discussion_r2567970733"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n\" when piping source on standard input).\"\n    ),\n)\n@click.option(\n    \"--ipynb\",\n    is_flag=True,\n    help=(\n        \"Format all input files like ipynb notebooks regardless of file extension \"\n        \"(useful when piping source on standard input).\"\n    ),\n)\n```"}, {"role": "assistant", "content": "I'm not the biggest fan of this since this allows for \"illegal state\" to be configured (forcing all files to be treated both as stubs and jupyter notebooks). While this doesn't break anything (the --ipynb flag wins out), it's probably not the best UX. Totally down to deal with this in a later PR (although before this gets released). Also, totally fine to leave this alone, it's not that terrible anyway."}], "_meta": {"repo": "psf/black", "pr_number": 2357, "url": "https://github.com/psf/black/pull/2357#discussion_r671594383"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scheduler_job_runner.py`:\n\n```python\nreturn executor\n\n    def _exceeds_max_active_runs(\n    def _check_exceeds_max_active_runs(\n```"}, {"role": "assistant", "content": "i think check actually makes sense because, we are checking whether it is exceeded; and if it is exceeded, then we set it to the right value.  you can't set without that \"check\" part first.\r\n\r\nTo me, `set` sort of implies we already know, and we are setting it to `exceeds=True`. \r\n\r\nI think `evaluate` might be an even better word, but it's so long i kindof think check is better. wdyt?"}], "_meta": {"repo": "apache/airflow", "pr_number": 60006, "url": "https://github.com/apache/airflow/pull/60006#discussion_r2669219575"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\nconfig: DetrConfig\n    \"\"\"\n\n    _can_record_outputs = {\n        \"hidden_states\": DetrEncoderLayer,\n        \"attentions\": OutputRecorder(DetrSelfAttention, layer_name=\"self_attn\", index=1),\n```"}, {"role": "assistant", "content": "Do we need the explicit output recorder, iirc `DetrSelfAttention` should work fine in itself"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2435668177"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `defer.py`:\n\n```python\nbreak\n        except Exception:\n            errback(failure.Failure(), *a, **kw)\n\n\ndef _isfuture(o):\n    # workaround for Python before 3.5.3 not having asyncio.isfuture\n    if hasattr(asyncio, 'isfuture'):\n        return asyncio.isfuture(o)\n    return isinstance(o, asyncio.Future)\n```"}, {"role": "assistant", "content": "If the coverage data is correct, `_isfuture` could be replaced by `asyncio.isfuture` and work the same. I wonder what the best approach here would be. Maybe we should just use `asyncio.isfuture`.\r\n\r\nIf we need to exclude future-like content that are not `Future` instances, such as `Task` instances, I think we may need a more complex check."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4259, "url": "https://github.com/scrapy/scrapy/pull/4259#discussion_r361920475"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pipeline.py`:\n\n```python\ns = s.copy()\n            s['to_upper'] = True\n            return s\n\n    # TODO: need to expand this logic to cover more cases, like datetimes, etc\n    basic_builtin_types = [int, float, bool, str, list, dict, set, tuple, bytes]\n    if func in basic_builtin_types:\n        # handle case where func is a standard type constructor, like int, float, etc.\n        # where we want to get more accurate schema information\n        # The general challenge here is how do we infer the type of the output of a function\n        # and attach that appropriately to the schema\n        # For now, we're challenged by the coupling of validation and serialization info\n        return cs.chain_schema([s, handler(func)])\n    return cs.no_info_after_validator_function(func, s)\n```"}, {"role": "assistant", "content": "Eek, seeking feedback. This feels wrong, but works for these basic cases.\r\n\r\nI mentioned to , I'd like to have a more in depth discussion about the coupling of our validation and serialization stuff.  \ud83d\udc40"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9459, "url": "https://github.com/pydantic/pydantic/pull/9459#discussion_r1628433345"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\nif is_lpar_token(first) and is_rpar_token(last):\n        middle = node.children[1]\n        # make parentheses invisible\n        first.value = \"\"\n        last.value = \"\"\n        if (\n            not node.children[1]\n            .prefix.strip()\n            .replace(\" \", \"\")\n            .startswith(\"#type:ignore\")\n```"}, {"role": "assistant", "content": "Umm I don't think I can directly replace code here with the `is_type_comment()` function, as the function expect a `leaf` as input and check on its `value` field, while here the comment is as a `node`'s prefix (node.children[1] is still a node), I tried to find some existing function to convert this prefix string into a `leaf`, but I haven't found one yet...  Any further guidance would be really helpful!"}], "_meta": {"repo": "psf/black", "pr_number": 3740, "url": "https://github.com/psf/black/pull/3740#discussion_r1238067858"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_emu3.py`:\n\n```python\nimage_sizes (`torch.LongTensor` of shape `(batch_size, 2)`):\n                The sizes of the images in the batch, being (height, width) for each image.\n        \"\"\"\n        image_tokens_list = self.vqmodel.encode(pixel_values, image_sizes)\n        bpe_tokens_list = [self.vocabulary_mapping.convert_img2bpe(tokens).flatten() for tokens in image_tokens_list]\n        vqmodel_outputs: Emu3VQVAEModelOutput = self.vqmodel.encode(pixel_values, image_sizes, return_dict=True)\n        bpe_tokens_list = [\n            self.vocabulary_mapping.convert_img2bpe(tokens).flatten() for tokens in vqmodel_outputs.image_tokens\n        ]\n        bpe_tokens = torch.cat(bpe_tokens_list)\n        return bpe_tokens\n\n    def get_image_features(self, pixel_values: torch.FloatTensor, image_sizes: torch.LongTensor):\n        \"\"\"\n        Tokenizes images into discrete tokens with VQGAN module and embeds\n        them with text embeddings layer\n\n        Args:\n            pixel_values (`torch.FloatTensor` of shape `(batch_size, num_channels, image_size, image_size)):\n                The tensors corresponding to the input images.\n    @can_return_tuple\n    @auto_docstring(\n        custom_intro=\"Tokenizes images into discrete tokens with VQGAN module and embeds them with text embeddings layer\"\n    )\n    def get_image_features(\n        self, pixel_values: torch.FloatTensor, image_sizes: torch.LongTensor, **kwargs: Unpack[TransformersKwargs]\n    ) -> tuple | Emu3VQVAEModelOutput:\n        r\"\"\"\n        pixel_values (`torch.FloatTensor` of shape `(batch_size, num_channels, image_size, image_size)):\n            The tensors corresponding to the input images.\n        \"\"\"\n        image_tokens = self.get_image_tokens(pixel_values, image_sizes)\n```"}, {"role": "assistant", "content": "I think it currently only exists for third-party/downstream use. It's not meaningfully used internally, same with e.g. chameleon, but interestingly, the new GLM-Image (based on Chameleon) does use it in its `forward`.\r\nI can remove it, but it might be breaking for downstream use (if there is any)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2703815109"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_compat.py`:\n\n```python\nreturn self.field_info.annotation\n\n        def __post_init__(self) -> None:\n            self._type_adapter: TypeAdapter[Any] = TypeAdapter(\n                Annotated[self.field_info.annotation, self.field_info]\n            )\n            with warnings.catch_warnings():\n                # Pydantic >= 2.12.0 warns about field specific metadata that is unused\n                # (e.g. `TypeAdapter(Annotated[int, Field(alias='b')])`). In some cases, we\n                # end up building the type adapter from a model field annotation so we\n                # need to ignore the warning:\n                if PYDANTIC_VERSION_MINOR_TUPLE >= (2, 12):  # pragma: no cover\n                    from pydantic.warnings import (  # type: ignore[attr-defined]\n                        UnsupportedFieldAttributeWarning,\n                    )\n\n                    warnings.simplefilter(\n```"}, {"role": "assistant", "content": "This is still incorrect, as per my first point here."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 14036, "url": "https://github.com/fastapi/fastapi/pull/14036#discussion_r2410098702"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_decorators.py`:\n\n```python\nreturn func\n\n\ndef get_function_return_type(\n    func: Any,\n    explicit_return_type: Any,\n_function_like = (\n    partial,\n    partialmethod,\n    types.FunctionType,\n    types.BuiltinFunctionType,\n    types.MethodType,\n    types.WrapperDescriptorType,\n    types.MethodWrapperType,\n    types.MemberDescriptorType,\n)\n\n\ndef get_callable_return_type(\n    callable_obj: Any,\n    globalns: GlobalsNamespace | None = None,\n    localns: MappingNamespace | None = None,\n) -> Any:\n    \"\"\"Get the function return type.\n\n    It gets the return type from the type annotation if `explicit_return_type` is `None`.\n    Otherwise, it returns `explicit_return_type`.\n) -> Any | PydanticUndefinedType:\n    \"\"\"Get the callable return type.\n\n    Args:\n        func: The function to get its return type.\n        explicit_return_type: The explicit return type.\n        callable_obj: The callable to analyze.\n        globalns: The globals namespace to use during type annotation evaluation.\n        localns: The locals namespace to use during type annotation evaluation.\n\n    Returns:\n        The function return type.\n    \"\"\"\n    if explicit_return_type is PydanticUndefined:\n        # try to get it from the type annotation\n        hints = get_function_type_hints(\n            unwrap_wrapped_function(func),\n            include_keys={'return'},\n            globalns=globalns,\n            localns=localns,\n        )\n        return hints.get('return', PydanticUndefined)\n    else:\n        return explicit_return_type\n    if isinstance(callable_obj, type):\n        # types are callables, and we assume the return type\n        # is the type itself (e.g. `int()` results in an instance of `int`).\n        return callable_obj\n\n    if not isinstance(callable_obj, _function_like):\n```"}, {"role": "assistant", "content": "This is the annoying thing we need to do: manually check for something that is _not_ a function, assume it is an instance (it isn't a type thanks to the added check above) and check for `__call__`.\r\n\r\nThis is also handled by `inspect.signature`, but we need to do this on our end as well so that we can evaluate forward refs.\r\n\r\ncc"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11451, "url": "https://github.com/pydantic/pydantic/pull/11451#discussion_r1958425421"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `benchmark_config.py`:\n\n```python\ntry:\n        from kernels import get_kernel\n\n        get_kernel(\"kernels-community/flash-attn\")\n        get_kernel(\"kernels-community/flash-attn2\")\n```"}, {"role": "assistant", "content": "No, I mean the `version` kwargs! You are right for the repos URL."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43428, "url": "https://github.com/huggingface/transformers/pull/43428#discussion_r2728178194"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sql.py`:\n\n```python\ntherefore it is expected the table has them defined.\n    :param uppercase_names: if True use schema and table names uppercase\n    \"\"\"\n    if and_ is None or or_ is None:\n        raise AirflowOptionalProviderFeatureException(\n            \"sqlalchemy is required for SQL filter clause generation. \"\n            \"Install it with: pip install 'apache-airflow-providers-openlineage[sqlalchemy]'\"\n        )\n```"}, {"role": "assistant", "content": "```suggestion\ntry:\n    from sqlalchemy import and_, or_\nexcept ImportError:\n    raise AirflowOptionalProviderFeatureException(\n        \"sqlalchemy is required for SQL filter clause generation. \"\n        \"Install it with: pip install 'apache-airflow-providers-openlineage[sqlalchemy]'\"\n    )\n```\nSame as above"}], "_meta": {"repo": "apache/airflow", "pr_number": 59921, "url": "https://github.com/apache/airflow/pull/59921#discussion_r2652929590"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `0097_3_2_0_add_timetable_type_to_dag_table_for_.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n\n\"\"\"\nadd timetable_type to dag table for filtering.\n\nRevision ID: e79fc784f145\nRevises: c47f2e1ab9d4\nCreate Date: 2026-01-04 14:36:04.648869\n\n\"\"\"\n\nfrom __future__ import annotations\n\nimport sqlalchemy as sa\nfrom alembic import op\n\n# revision identifiers, used by Alembic.\nrevision = \"e79fc784f145\"\ndown_revision = \"c47f2e1ab9d4\"\nbranch_labels = None\ndepends_on = None\nairflow_version = \"3.2.0\"\n\n\ndef upgrade():\n    \"\"\"Apply add timetable_type to dag table for filtering.\"\"\"\n    # ### commands auto generated by Alembic - please adjust! ###\n    # Step 1: Add column as nullable to allow filling existing rows\n    with op.batch_alter_table(\"dag\", schema=None) as batch_op:\n        batch_op.add_column(sa.Column(\"timetable_type\", sa.String(length=255)))\n\n    # Step 2: Fill existing rows with empty string (transient data, will be overwritten by next DAG parsing)\n    op.execute(\"UPDATE dag SET timetable_type = '' WHERE timetable_type IS NULL\")\n\n    # Step 3: Make the column non-nullable\n    with op.batch_alter_table(\"dag\", schema=None) as batch_op:\n        batch_op.alter_column(\"timetable_type\", existing_type=sa.String(length=255), nullable=False)\n\n    # ### end Alembic commands ###\n```"}, {"role": "assistant", "content": ", the comments there can still be removed. Especially the alembic autogenerated comments"}], "_meta": {"repo": "apache/airflow", "pr_number": 58852, "url": "https://github.com/apache/airflow/pull/58852#discussion_r2668687949"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `postprocessing.py`:\n\n```python\n\"\"\"\nExtension for processing data before they are exported to feeds.\n\"\"\"\nfrom bz2 import BZ2File\nfrom gzip import GzipFile\nfrom io import IOBase\nfrom lzma import LZMAFile\nfrom typing import Any, BinaryIO, Dict, List\n\nfrom scrapy.utils.misc import load_object\n\n\nclass GzipPlugin:\n```"}, {"role": "assistant", "content": "While there is 1 case in similar Scrapy code where we use an interface, in most similar cases we tend to instead document the interface, so the current approach I think is the one most in line with the current code base.\r\n\r\nIn Python, interfaces are seldom used, and I don\u2019t see much benefit for them being used here."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5190, "url": "https://github.com/scrapy/scrapy/pull/5190#discussion_r663670282"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\nelse:\n                json_schema['patternProperties'] = {keys_pattern: values_schema}\n\n        if ks is not None:\n            keys_type = ks.get('type', None)\n            if keys_type == 'enum':\n                keys_members = ks.get('members', [])\n                json_schema['propertyNames'] = {'enum': keys_members}\n```"}, {"role": "assistant", "content": "> While doing it, this will also add a propertyNames schema to an existing test case. This should be expected behaviour, as python's Path in json schema of pydantic has the ' format' 'path' schema.\r\n\r\nAgreed, this change looks correct to me. I second ' request for that additional test case with constrained dict keys.\r\n\r\n> Would it then be best to add the ref to propertyNames schema, or the resolved one? I'll go with the resolved for now but am open for your inputs :)\r\n\r\nRe refs - I think the current behavior makes sense. I haven't seen strings as references in JSON schemas yet. Maybe  has?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10478, "url": "https://github.com/pydantic/pydantic/pull/10478#discussion_r1777258849"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `decorator_implicit_classmethod.py`:\n\n```python\n\"\"\"Test that the mypy plugin implicitly transforms the right decorators into class methods.\"\"\"\n\nfrom pydantic import BaseModel, field_validator, model_serializer, model_validator\n\n\nclass Model(BaseModel):\n    a: int\n\n    @field_validator('a')\n    def f_val(cls, value: int) -> int:\n        reveal_type(cls)\n# MYPY: note: Revealed type is \"type[tests.mypy.modules.decorator_implicit_classmethod.Model]\"\n        return value\n\n    @model_validator(mode='before')\n    def m_val_before(self, values: dict[str, object]) -> dict[str, object]:\n        reveal_type(self)\n# MYPY: note: Revealed type is \"type[tests.mypy.modules.decorator_implicit_classmethod.Model]\"\n        return values\n```"}, {"role": "assistant", "content": "Surprising that it would be different from an `after` model validator..."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11298, "url": "https://github.com/pydantic/pydantic/pull/11298#discussion_r1923992045"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `celery_command.py`:\n\n```python\nautoscale = args.autoscale\n    skip_serve_logs = args.skip_serve_logs\n\n    if autoscale is None and conf.has_option(\"celery\", \"worker_autoscale\"):\n        autoscale = conf.get(\"celery\", \"worker_autoscale\")\n    if autoscale is None and config.has_option(\"celery\", \"worker_autoscale\"):\n```"}, {"role": "assistant", "content": ", this is failing backward compatibility. In Airflow 3.1.3, ExecutorConf exists but lacks critical methods like has_option, getsection, etc. were added in commit 5ba75af409 for Airflow 3.2+\n```\n    if autoscale is None and config.has_option(\"celery\", \"worker_autoscale\"):\nAttributeError: 'ExecutorConf' object has no attribute 'has_option'\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60675, "url": "https://github.com/apache/airflow/pull/60675#discussion_r2724353852"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `suppressions.py`:\n\n```python\n# Multiple codes but none are used\n    # ruff: disable[E741, F401, F841]\n    print(\"hello\")\n\n\ndef f():\n    # Unknown rule codes\n    # ruff: disable[YF829]\n    # ruff: disable[F841, RQW320]\n```"}, {"role": "assistant", "content": "Can you add a test that verifies we don't flag rules defined using `external` (might have to be a CLI test)"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 21908, "url": "https://github.com/astral-sh/ruff/pull/21908#discussion_r2613457489"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conftest.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport os\n\nos.environ[\"_AIRFLOW__AS_LIBRARY\"] = \"true\"\n```"}, {"role": "assistant", "content": "The thing I don\u2019t like is if you run the shared lib and core tests in the same process (say locally in breeze) it would mysteriously fail. I wonder if this would work in a module-scoped fixture instead."}], "_meta": {"repo": "apache/airflow", "pr_number": 59883, "url": "https://github.com/apache/airflow/pull/59883#discussion_r2671339443"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_dinov3_vit.py`:\n\n```python\nsequence_output = self.norm(hidden_states)\n        pooled_output = sequence_output[:, 0, :]\n\n        return BaseModelOutputWithPooling(\n            last_hidden_state=sequence_output,\n            pooler_output=pooled_output,\n        )\n        return BaseModelOutputWithPooling(last_hidden_state=sequence_output, pooler_output=pooled_output)\n\n\n@auto_docstring\nclass DINOv3ViTBackbone(DINOv3ViTPreTrainedModel, BackboneMixin):\n    def __init__(self, config):\n        super().__init__(config)\n        super()._init_backbone(config)\n\n        self.embeddings = DINOv3ViTEmbeddings(config)\n        self.rope_embeddings = DINOv3ViTRopePositionEmbedding(config)\n        self.layer = nn.ModuleList([DINOv3ViTLayer(config) for _ in range(config.num_hidden_layers)])\n        self.norm = nn.LayerNorm(config.hidden_size, eps=config.layer_norm_eps)\n        self.gradient_checkpointing = False\n\n        self.num_features = [config.hidden_size for _ in range(config.num_hidden_layers + 1)]\n        self.layernorm = nn.LayerNorm(config.hidden_size, eps=config.layer_norm_eps)\n        self.post_init()\n\n    def get_input_embeddings(self):\n        return self.embeddings.patch_embeddings\n\n    @check_model_inputs()\n    @can_return_tuple\n    def forward(\n        self,\n        pixel_values: torch.Tensor,\n        output_hidden_states: Optional[bool] = None,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> BackboneOutput:\n        pixel_values = pixel_values.to(self.embeddings.patch_embeddings.weight.dtype)\n        hidden_states = self.embeddings(pixel_values)\n        position_embeddings = self.rope_embeddings(pixel_values)\n\n        stage_hidden_states: list[torch.Tensor] = [hidden_states]\n\n        for layer_module in self.layer:\n            hidden_states = layer_module(hidden_states, position_embeddings=position_embeddings)\n            stage_hidden_states.append(hidden_states)\n\n        sequence_output = self.norm(hidden_states)\n        stage_hidden_states[-1] = sequence_output\n\n        batch_size, _, image_height, image_width = pixel_values.shape\n        patch_size = self.config.patch_size\n        num_patches_height = image_height // patch_size\n        num_patches_width = image_width // patch_size\n\n        num_prefix = 1 + getattr(self.config, \"num_register_tokens\", 0)\n\n        feature_maps = []\n        for stage_name, hidden_state in zip(self.stage_names, stage_hidden_states):\n            if stage_name in self.out_features:\n                if self.config.apply_layernorm:\n                    hidden_state = self.layernorm(hidden_state)\n```"}, {"role": "assistant", "content": "```suggestion\n                    hidden_state = self.norm(hidden_state)\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41276, "url": "https://github.com/huggingface/transformers/pull/41276#discussion_r2487297074"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\nreturn self.encoder\n\n    def freeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(False)\n\n    def unfreeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(True)\n```"}, {"role": "assistant", "content": "Just asked  who's an avid finetuner and is not using these methods anymore, I think they were good initially but they're ok to go now. Agreed it's out of scope for current PR will create another to remove all of it (cc  as we chatted on finetuning too)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2445111442"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `settings.py`:\n\n```python\nsys.path.append(PLUGINS_FOLDER)\n\n\ndef __getattr__(name: str):\n    \"\"\"Handle deprecated module attributes.\"\"\"\n    if name == \"MASK_SECRETS_IN_LOGS\":\n        import warnings\n\n        warnings.warn(\n            \"settings.MASK_SECRETS_IN_LOGS has been removed. \"\n            \"Use SecretsMasker.enable_log_masking(), disable_log_masking(), or is_log_masking_enabled() instead.\",\n            DeprecationWarning,\n            stacklevel=2,\n        )\n        return\n```"}, {"role": "assistant", "content": "Pushed in https://github.com/apache/airflow/pull/55712/commits/821b6e9b594bec85001d035f1dd25c5a01ffbb60"}], "_meta": {"repo": "apache/airflow", "pr_number": 55712, "url": "https://github.com/apache/airflow/pull/55712#discussion_r2351609089"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `postprocessing.py`:\n\n```python\n\"\"\"\nExtension for processing data before they are exported to feeds.\n\"\"\"\nfrom bz2 import BZ2File\nfrom gzip import GzipFile\nfrom io import IOBase\nfrom lzma import LZMAFile\nfrom typing import Any, BinaryIO, Dict, List\n\nfrom scrapy.utils.misc import load_object\n\n\nclass GzipPlugin:\n```"}, {"role": "assistant", "content": "Since all post-processing plugins have a common structure, how about declaring an interface (eg. `IPostProcessingPlugin`) with the `write` and `close` methods?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5190, "url": "https://github.com/scrapy/scrapy/pull/5190#discussion_r663646925"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `parse.py`:\n\n```python\nopts.spargs = arglist_to_dict(opts.spargs)\n        except ValueError:\n            raise UsageError(\"Invalid -a value, use -a NAME=VALUE\", print_help=False)\n        if opts.output:\n```"}, {"role": "assistant", "content": "Please use `scrapy.utils.conf.feed_process_params_from_cli` to handle this. `FEED_URI`, `FEED_FORMAT` and the `-t` CLI option are deprecated in #3858 (to be released in 2.1)"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4377, "url": "https://github.com/scrapy/scrapy/pull/4377#discussion_r401114153"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auth.py`:\n\n```python\nassert len(response.history) == 1\n\n\n@pytest.mark.asyncio\nasync def test_digest_auth_reuses_challenge() -> None:\n    url = \"https://example.org/\"\n    auth = DigestAuth(username=\"tomchristie\", password=\"password123\")\n    app = DigestApp()\n\n    async with httpx.AsyncClient(transport=httpx.MockTransport(app)) as client:\n        response_1 = await client.get(url, auth=auth)\n        response_2 = await client.get(url, auth=auth)\n\n        assert response_1.status_code == 200\n        assert response_2.status_code == 200\n\n        assert len(response_1.history) == 1\n        assert len(response_2.history) == 0\n\n\n@pytest.mark.asyncio\nasync def test_digest_auth_resets_nonce_count_after_401() -> None:\n    url = \"https://example.org/\"\n    auth = DigestAuth(username=\"tomchristie\", password=\"password123\")\n```"}, {"role": "assistant", "content": "```suggestion\r\n    auth = DigestAuth(username=\"user\", password=\"password123\")\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 2463, "url": "https://github.com/encode/httpx/pull/2463#discussion_r1032517268"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conversion_mapping.py`:\n\n```python\n# Add the ones from the quantizer as well if provided\n    if hf_quantizer is not None:\n        weight_conversions.extend(hf_quantizer.get_weight_conversions())\n        # NOTE: Since get_weight_conversions() only serves to dequantize, we need to put them first in the list.\n        # However, for now it's not possible to match 1 param with 2 converters (i.e. 1 dequantization converter\n        # and 1 model-specific converter. Which means that if a model that has model-specific conversions and is being\n        # dequantized, the model-specific conversion that has patterns matching the dequantization patterns will be ignored.\n```"}, {"role": "assistant", "content": "```suggestion\r\n        # NOTE: Since get_weight_conversions() only serves to dequantize, we need to put them first in the list.\r\n        # However, for now it's not possible to match 1 param with 2 converters (i.e. 1 dequantization converter\r\n        # and 1 model-specific converter). Which means that if a model that has model-specific conversions and is being\r\n        # dequantized, the model-specific conversion that has patterns matching the dequantization patterns will be ignored.\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43227, "url": "https://github.com/huggingface/transformers/pull/43227#discussion_r2698703690"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `term.py`:\n\n```python\ndef supports_images() -> bool:\n    return sys.stdin.isatty() and ITERM_PROFILE is not None\n    return isatty(sys.stdin) and ITERM_PROFILE is not None\n```"}, {"role": "assistant", "content": "```suggestion\r\n    \r\n    try:\r\n        return sys.stdin.isatty() and ITERM_PROFILE\r\n    except AttributeError:\r\n        pass\r\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 9494, "url": "https://github.com/celery/celery/pull/9494#discussion_r1916049255"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_requests.py`:\n\n```python\nassert request.url.port is None\n    assert request.url.path == \"/abc\"\n    assert request.url.raw_path == b\"/abc?foo=bar\"\n\n\ndef test_request_picklable():\n    request = httpx.Request(\"POST\", \"http://example.org\", json={\"test\": 123})\n    pickle_request = pickle.loads(pickle.dumps(request))\n    assert pickle_request.method == \"POST\"\n    assert pickle_request.url.path == \"/\"\n    assert pickle_request.headers[\"Content-Type\"] == \"application/json\"\n    assert pickle_request.content == b'{\"test\": 123}'\n    assert pickle_request.stream is not None\n    assert request.headers == {\n        \"Host\": \"example.org\",\n        \"Content-Type\": \"application/json\",\n        \"content-length\": \"13\",\n    }\n\n\n@pytest.mark.asyncio\nasync def test_request_async_streaming_content_picklable():\n    async def streaming_body(data):\n        yield data\n\n    data = streaming_body(b\"test 123\")\n    request = httpx.Request(\"POST\", \"http://example.org\", content=data)\n    pickle_request = pickle.loads(pickle.dumps(request))\n    with pytest.raises(httpx.RequestNotRead):\n        pickle_request.content\n    with pytest.raises(httpx.ResponseClosed):  # TODO: StreamClosed\n```"}, {"role": "assistant", "content": "```suggestion\r\n    with pytest.raises(httpx.StreamClosed):\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1579, "url": "https://github.com/encode/httpx/pull/1579#discussion_r617388301"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `request.py`:\n\n```python\nreturn getattr(obj, name)\n    except AttributeError:\n        raise ValueError(f\"Method {name!r} not found in: {obj}\")\n\n\ndef request_to_curl(request: Request) -> str:\n    \"\"\"\n    Converts a :class:`~scrapy.Request` object to a curl command.\n\n    :param :class:`~scrapy.Request`: Request object to be converted\n    :return: string containing the curl command\n    \"\"\"\n    method = request.method\n    data = (\n        \"--data-raw '{}'\".format(request.body.decode(\"utf-8\")) if request.body else \"\"\n    )\n    headers = \" \".join(\n        \"-H '{}: {}'\".format(k.decode(), v[0].decode())\n        for k, v in request.headers.items()\n    )\n    url = request.url\n    cookies = \"\"\n    if isinstance(request.cookies, dict) and request.cookies:\n        cookies = \"--cookie '{}'\".format(\n            \"; \".join(\"{}={}\".format(k, v) for k, v in request.cookies.items())\n        )\n    elif isinstance(request.cookies, list):\n```"}, {"role": "assistant", "content": "Makes sense. The default is an empty dict, but I guess it is possible that an empty list ends up there."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5892, "url": "https://github.com/scrapy/scrapy/pull/5892#discussion_r1164093245"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_glm_image.py`:\n\n```python\ninputs_embeds: torch.FloatTensor | None = None,\n        pixel_values: torch.Tensor | None = None,\n        image_grid_thw: torch.LongTensor | None = None,\n        images_per_sample: torch.LongTensor | None = None,\n        num_source_images_per_sample: torch.LongTensor | None = None,\n        rope_deltas: torch.LongTensor | None = None,\n        cache_position: torch.LongTensor | None = None,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> tuple | GlmImageModelOutputWithPast:\n        r\"\"\"\n        image_grid_thw (`torch.LongTensor` of shape `(num_images, 3)`, *optional*):\n        image_grid_thw (`torch.LongTensor` of shape `(total_images_in_batch, 3)`, *optional*):\n            The temporal, height and width of feature shape of each image in LLM.\n            Images are packed across all samples in the batch.\n        images_per_sample (`torch.LongTensor` of shape `(batch_size,)`, *optional*):\n            Number of images (including target grids) for each sample in the batch.\n        num_source_images_per_sample (`torch.LongTensor` of shape `(batch_size,)`, *optional*):\n            Number of source images (with pixel_values) for each sample in the batch.\n        rope_deltas (`torch.LongTensor` of shape `(batch_size, )`, *optional*):\n            The rope index difference between sequence length and multimodal rope.\n        \"\"\"\n        if (input_ids is None) ^ (inputs_embeds is not None):\n            raise ValueError(\"You must specify exactly one of input_ids or inputs_embeds\")\n\n        batch_size = input_ids.shape[0] if input_ids is not None else inputs_embeds.shape[0]\n\n        if pixel_values is not None:\n            image_embeds = self.get_image_features(pixel_values, image_grid_thw[:-1])\n            image_embeds = torch.cat(image_embeds, dim=0)\n            image_ids = self.get_image_tokens(image_embeds, image_grid_thw[:-1])\n            image_ids = image_ids.view(-1).to(input_ids.device)\n            special_image_mask = self.get_placeholder_mask(input_ids, image_ids)\n            input_ids = input_ids.masked_scatter(special_image_mask, image_ids)\n            # For i2i mode: num_source_images = images_per_sample - 1 (1 target grid)\n            # Compute num_source_images_per_sample if not provided\n            if num_source_images_per_sample is None and images_per_sample is not None:\n                num_source_images_per_sample = images_per_sample - 1\n```"}, {"role": "assistant", "content": "IMO `num_source_images_per_sample` can always be inferred from `images_per_sample`, and we don't need to add `num_source_images_per_sample` in model args. WDYT?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43342, "url": "https://github.com/huggingface/transformers/pull/43342#discussion_r2716252916"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_eomt_dinov3.py`:\n\n```python\n# Copyright 2026 the HuggingFace Team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\"\"\"PyTorch EoMT model backed by DINOv3.\"\"\"\n\nimport torch\nimport torch.nn.functional as F\nfrom torch import Tensor, nn\n\nfrom ... import initialization as init\nfrom ...modeling_utils import PreTrainedModel\nfrom ...processing_utils import Unpack\nfrom ...utils import (\n    TransformersKwargs,\n    auto_docstring,\n)\nfrom ...utils.generic import check_model_inputs\nfrom ..dinov3_vit.modeling_dinov3_vit import (\n    DINOv3ViTAttention,\n    DINOv3ViTEmbeddings,\n    DINOv3ViTLayer,\n    DINOv3ViTLayerScale,\n    DINOv3ViTRopePositionEmbedding,\n)\nfrom ..eomt.configuration_eomt import EomtConfig\nfrom ..eomt.modeling_eomt import (\n    EomtForUniversalSegmentation,\n    EomtForUniversalSegmentationOutput,\n    EomtLoss,\n)\n\n\nclass EomtDinov3Attention(DINOv3ViTAttention):\n    pass\n\n\nclass EomtDinov3ViTEmbeddings(DINOv3ViTEmbeddings):\n    pass\n\n\nclass EomtDinov3Layer(DINOv3ViTLayer):\n    pass\n\n\nclass EomtDinov3LayerScale(DINOv3ViTLayerScale):\n    pass\n\n\nclass EomtDinov3RopePositionEmbedding(DINOv3ViTRopePositionEmbedding):\n    pass\n```"}, {"role": "assistant", "content": "Just looked into the modeling code, this is super custom. I'd love to have this refactored at some point to allow custom RoPE more easily - I'll work on that but want to keep you in the loop cc"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41212, "url": "https://github.com/huggingface/transformers/pull/41212#discussion_r2705564741"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `galaxy.py`:\n\n```python\ndef _display_collection(collection, cwidth=10, vwidth=7, min_cwidth=10, min_vwidth=7):\n    display.display('{fqcn:{cwidth}} {version:{vwidth}}'.format(\n        fqcn=to_text(collection.fqcn),\n        fqcn=to_text(\".\".join(pathlib.Path(to_text(collection.src)).parts[-2:])),\n```"}, {"role": "assistant", "content": "I completely misunderstood what you were saying. I see what you mean now. The current state of the PR uses what you suggest, it's way more elegant imo. I kept the old changes around in a branch here. \r\n\r\nThe one benefit to my previous method was that in `ansible-galaxy collection list`, it buffered the warning with the rest of `list`'s warnings. I don't think this minor UI change is enough to warrant adding a new property to the class and adding the warning/error logic to every function as in my old method."}], "_meta": {"repo": "ansible/ansible", "pr_number": 86402, "url": "https://github.com/ansible/ansible/pull/86402#discussion_r2734117533"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `token.py`:\n\n```python\naccess_token: str\n\n\nclass TokenBody(StrictBaseModel):\n    \"\"\"Token serializer for post bodies.\"\"\"\nclass TokenPasswordBody(StrictBaseModel):\n    \"\"\"Password Grant Token serializer for post bodies.\"\"\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n    \"\"\"Password grant token serializer for post bodies.\"\"\"\r\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 59411, "url": "https://github.com/apache/airflow/pull/59411#discussion_r2662283650"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `strings.py`:\n\n```python\nreturn f\"{new_prefix}{match.group(2)}\"\n\n\n@lru_cache(maxsize=256)\n```"}, {"role": "assistant", "content": "Interesting, thanks for the extra information. I looked at `re.compile` and it calls a helper function (`_compile`) and does an `isinstance` call before looking at the cache, and the cache key is a tuple `type(pattern), pattern, flags`. I suppose that adds up to more overhead than whatever lru_cache does internally."}], "_meta": {"repo": "psf/black", "pr_number": 2431, "url": "https://github.com/psf/black/pull/2431#discussion_r691576743"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_typing_extra.py`:\n\n```python\nother cases. See https://discuss.python.org/t/is-there-a-way-to-access-parent-nested-namespaces/20659.\n    \"\"\"\n    frame = sys._getframe(parent_depth)\n    # if f_back is None, it's the global module namespace and we don't need to include it here\n    if frame.f_back is None:\n    # if the class is defined at the top module level, we don't need to add namespace information\n    if frame.f_back is None or getframeinfo(frame).function == '<module>':\n```"}, {"role": "assistant", "content": "I believe I am missing something: if `frame.f_back` is `None`, doesn't that mean we are already know the `frame`'s \"function\" is the module already?\r\n\r\nI've tried defining the following::\r\n\r\n```python\r\nclass ModuleModel(BaseModel):\r\n    pass\r\n\r\ndef func():\r\n    class FuncModel(BaseModel):\r\n        pass\r\n\r\nfunc()\r\n```\r\n\r\nFor `ModuleModel`, both `frame.f_back is None` and `getframeinfo(frame).function == '<module>'` evaluate to `True`.\r\n\r\nFor `FuncModel`, they both evaluate to `False`."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10113, "url": "https://github.com/pydantic/pydantic/pull/10113#discussion_r1714981531"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `functional_validators.py`:\n\n```python\nfunc = cast(core_schema.NoInfoValidatorFunction, self.func)\n            return core_schema.no_info_after_validator_function(func, schema=schema)\n\n    @classmethod\n    def _from_decorator(cls, decorator: _decorators.Decorator[_decorators.FieldValidatorDecoratorInfo]) -> Self:\n        return cls(func=decorator.func)\n```"}, {"role": "assistant", "content": "(I'll note that this removes the need for `_VALIDATOR_F_MATCH` and `apply_validators`. They are kept for deprecated decorator code but will be removed in v3)."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10094, "url": "https://github.com/pydantic/pydantic/pull/10094#discussion_r1724505864"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `param.py`:\n\n```python\nreturn ParamsDict(data)\n\n    def _fill_missing_param_source(\n        self,\n        source: Literal[\"dag\", \"task\"] | None = None,\n    ) -> None:\n        for key in self.__dict:\n            if self.__dict[key].source is None:\n                self.__dict[key].source = source\n\n    @staticmethod\n    def filter_params_by_source(params: ParamsDict, source: Literal[\"Dag\", \"task\"]) -> ParamsDict:\n```"}, {"role": "assistant", "content": "```suggestion\n    def filter_params_by_source(params: ParamsDict, source: Literal[\"dag\", \"task\"]) -> ParamsDict:\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 58615, "url": "https://github.com/apache/airflow/pull/58615#discussion_r2567503953"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_docs_extraction.py`:\n\n```python\n\"\"\"Utilities related to attribute docstring extraction.\"\"\"\nfrom __future__ import annotations\n\nimport ast\nimport inspect\nimport textwrap\nfrom typing import Any, Iterable\n\n\ndef _get_assign_targets(node: ast.Assign | ast.AnnAssign) -> Iterable[str]:\n    if isinstance(node, ast.Assign):\n        for target in node.targets:\n            if isinstance(target, ast.Tuple):\n                yield from (el.id for el in target.elts)\n            else:\n                yield target.id\n    else:\n        # `target` can only be `ast.Name` in the context of a `BaseModel` subclass definition\n        yield node.target.id\n\n\ndef _extract_docs(cls_def: ast.ClassDef) -> dict[str, str]:\n\n    nodes_docs_pairs = [\n        (node, inspect.cleandoc(next_node.value.s))\n        for node, next_node in zip(cls_def.body, cls_def.body[1:])\n        if isinstance(node, (ast.Assign, ast.AnnAssign))  # e.g. a: int / a = 1...\n        if isinstance(next_node, ast.Expr)  # ...with next_node being a docstring\n        if isinstance(next_node.value, ast.Str)\n    ]\n\n    doc_mapping: dict[str, str] = {}\n\n    for node, docs in nodes_docs_pairs:\n        for target in _get_assign_targets(node):\n            doc_mapping[target] = docs\n\n    return doc_mapping\n\n\ndef extract_docstrings_from_cls(cls: type[Any]) -> dict[str, str]:\n    \"\"\"Returns a mapping of the model attributes and their corresponding docstring.\n\n    Args:\n        cls: The class of the Pydantic model to inspect.\n    Returns:\n        A mapping containing attribute names and their corresponding docstring.\n    \"\"\"\n    try:\n        source = inspect.getsource(cls)\n    except OSError:\n        # Source can't be parsed (maybe because running in an interactive terminal)\n        # TODO should we issue a UserWarning to indicate that docstrings won't be\n        # taken into account?\n        return {}\n\n    text = textwrap.dedent(source)\n```"}, {"role": "assistant", "content": "<details><summary>MRE</summary>\r\n\r\n```python\r\ndef test():\r\n    class Model(BaseModel):\r\n        a: int\r\n        \"\"\"doc\"\"\"\r\n\r\n    source = inspect.getsource(Model)\r\n    tree = ast.parse(source)\r\n\r\ntest()\r\n#> IndentationError: unexpected indent\r\n```\r\n\r\n</details>"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6563, "url": "https://github.com/pydantic/pydantic/pull/6563#discussion_r1261570548"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `static_checker.py`:\n\n```python\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport ast\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom pathlib import Path\n\n\nclass StaticCheckerResult:\n```"}, {"role": "assistant", "content": "Even here and module name -> I would say it's better if that whole PR focuses on \"dag stability\" or similar checks - rather than generic \"static checks\" -> yes it is done via static anaylysis of the AST, but there are so many different static checks that could even likely be done in different moments, with different switches and different \"off/error/warning\" values for the switches, that generically naming it \"static checks\" now is too early. \n\nI would say when we see the need for **third** such check we should see if we can implement some generic framework for static checks execution and error raising - but at this stage it's purely about \"Dag stability\"."}], "_meta": {"repo": "apache/airflow", "pr_number": 59430, "url": "https://github.com/apache/airflow/pull/59430#discussion_r2644095699"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_model_schema_generation.py`:\n\n```python\nreturn self.field\n\n    benchmark(rebuild_model, ModelWithValidator)\n\n\n@pytest.mark.benchmark(group='model_schema_generation')\ndef test_tagged_union_with_str_discriminator_schema_generation(benchmark):\n    class Cat(BaseModel):\n        pet_type: Literal['cat']\n        meows: int\n\n    class Dog(BaseModel):\n        pet_type: Literal['dog']\n        barks: float\n\n    class Lizard(BaseModel):\n        pet_type: Literal['reptile', 'lizard']\n        scales: bool\n\n    class Model(BaseModel):\n        pet: Union[Cat, Dog, Lizard] = Field(..., discriminator='pet_type')\n        n: int\n\n    benchmark(rebuild_model, Model)\n\n\n@pytest.mark.benchmark(group='model_schema_generation')\ndef test_tagged_union_with_callable_discriminator_schema_generation(benchmark):\n    class Pie(BaseModel):\n        time_to_cook: int\n        num_ingredients: int\n\n    class ApplePie(Pie):\n        fruit: Literal['apple'] = 'apple'\n\n    class PumpkinPie(Pie):\n        filling: Literal['pumpkin'] = 'pumpkin'\n\n    def get_discriminator_value(v: Any) -> str:\n        if isinstance(v, dict):\n            return v.get('fruit', v.get('filling'))\n        return getattr(v, 'fruit', getattr(v, 'filling', None))\n\n    class ThanksgivingDinner(BaseModel):\n```"}, {"role": "assistant", "content": "Thanks for the feedback on these 2! I will be fixing it ASAP."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10362, "url": "https://github.com/pydantic/pydantic/pull/10362#discussion_r1768013872"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `version.py`:\n\n```python\nif opts.verbose:\n            versions = scrapy_components_versions()\n            width = max(len(n) for (n, _) in versions)\n            patt = \"%-{}s : %s\".format(width)\n            patt = f\"%-{width}s : %s\"\n            for name, version in versions:\n                print(patt % (name, version))\n```"}, {"role": "assistant", "content": "Looks like it can be done as:\r\n\r\n```suggestion\r\n            for name, version in versions:\r\n                print(f\"{name:<{width}} : {version}\")\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4324, "url": "https://github.com/scrapy/scrapy/pull/4324#discussion_r477114053"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `check_docstrings.py`:\n\n```python\n\"YolosImageProcessor\",\n    \"YolosModel\",\n    \"YosoConfig\",\n    \"YoutuConfig\",\n```"}, {"role": "assistant", "content": "Found the culprits it's the docstrings in the config\r\n```text\r\ninitializer_range (`float`, *optional*):\r\n            The standard deviation of the truncated_normal_initializer for initializing all weight matrices, except embedding matrices.\r\n        embedding_initializer_range (`float`, *optional*):\r\n            The standard deviation of the truncated_normal_initializer for initializing all embedding matrices.\r\n```\r\nWill take another look there either ways"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43166, "url": "https://github.com/huggingface/transformers/pull/43166#discussion_r2717756203"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crawler.py`:\n\n```python\nreactor_class: str = self.settings[\"TWISTED_REACTOR\"]\n        event_loop: str = self.settings[\"ASYNCIO_EVENT_LOOP\"]\n        logged_reactor_info: bool = False\n\n        if self._init_reactor:\n            # this needs to be done after the spider settings are merged,\n            # but before something imports twisted.internet.reactor\n            if reactor_class:\n                install_reactor(reactor_class, event_loop)\n            else:\n                from twisted.internet import reactor  # noqa: F401\n            log_reactor_info()\n\n            if not logged_reactor_info:\n                log_reactor_info()\n                logged_reactor_info = True\n\n        if reactor_class:\n            verify_installed_reactor(reactor_class)\n            if is_asyncio_reactor_installed() and event_loop:\n                verify_installed_asyncio_event_loop(event_loop)\n\n            log_reactor_info()\n```"}, {"role": "assistant", "content": "\ud83d\udcaf  , I updated the code using your logic make more sense and is more clear, please take a look."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6657, "url": "https://github.com/scrapy/scrapy/pull/6657#discussion_r1944482651"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pattern_matching_extras.py`:\n\n```python\nmatch match:\n    case case:\n        pass\n\n\nmatch a, *b(), c:\n```"}, {"role": "assistant", "content": "Well then, I need to play with pattern matching too."}], "_meta": {"repo": "psf/black", "pr_number": 2667, "url": "https://github.com/psf/black/pull/2667#discussion_r761999611"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `reactor.py`:\n\n```python\nreturn self._func(*self._a, **self._kw)\n\n\ndef install_reactor(reactor_path):\ndef install_reactor(reactor_path, event_loop_path=None):\n    \"\"\"Installs the :mod:`~twisted.internet.reactor` with the specified\n    import path.\"\"\"\n    import path. Also installs the asyncio event loop with the specified import\n    path if the asyncio reactor is enabled\"\"\"\n    reactor_class = load_object(reactor_path)\n    if reactor_class is asyncioreactor.AsyncioSelectorReactor:\n        with suppress(error.ReactorAlreadyInstalledError):\n            asyncioreactor.install(asyncio.get_event_loop())\n            if event_loop_path is not None:\n                event_loop_class = load_object(event_loop_path)\n                event_loop = event_loop_class()\n                asyncio.set_event_loop(event_loop)\n            else:\n                event_loop = asyncio.get_event_loop()\n```"}, {"role": "assistant", "content": "But if we remove this part and `asyncioreactor.install` then how would we deal with the case when no event loop path is specified and the user wants to install the asyncio reactor with the default event loop ?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4414, "url": "https://github.com/scrapy/scrapy/pull/4414#discussion_r396641403"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `applications.py`:\n\n```python\n\"\"\"\n            ),\n        ] = True,\n        openapi_external_docs: Annotated[\n            Optional[Dict[str, Any]],\n            Doc(\n                \"\"\"\n                This field allows you to provide additional external documentation links\n                for an API operation or component. It\u2019s an optional field and can be added\n                to an operation or a tag. If provided, it must be a dictionary containing:\n\n                * `description`: A brief description of the external documentation, which may use\n                [CommonMark syntax](https://commonmark.org/) for rich text formatting.\n                * `url`: The URL pointing to the external documentation. The value **MUST**\n                be a valid URL format.\n\n                **Example**:\n\n                ```python\n                from fastapi import FastAPI\n                from typing import Dict, Any\n                from typing import Optional\n                from fastapi.openapi.models import Doc\n                from typing_extensions import Annotated\n\n                external_docs: Annotated[Optional[Dict[str, Any]], Doc()] = {\n                    \"description\": \"Detailed API Reference\",\n                    \"url\": \"https://example.com/api-docs\",\n                }\n\n                app = FastAPI(openapi_external_docs=external_docs)\n\n                ```\n\n                ### Explanation:\n                - `description`: Provides a short description explaining what this external documentation covers.\n                - `url`: Points to the full external documentation.\n\n                **Notes**:\n                - This field is **optional**; if not included, no external documentation will be linked.\n                - You can use this feature to link to full API documentation, tutorials, or any other\n```"}, {"role": "assistant", "content": "```suggestion\r\n```\r\nI think we don't need this. The above explanation should be enough"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 13713, "url": "https://github.com/fastapi/fastapi/pull/13713#discussion_r2210711862"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nreturn inputs\n\n    def _is_attention_mask_causal(self, attention_mask):\n        \"\"\"\n        Check if an attention mask is causal (compatible with causal attention).\n        Context parallelism only supports causal attention patterns. This function\n        checks if the provided attention mask is compatible.\n\n        Args:\n            attention_mask (torch.Tensor): The attention mask to check\n\n        Returns:\n            bool: True if the mask is causal or compatible with causal attention\n        \"\"\"\n        if attention_mask is None:\n            return True  # No mask is considered causal (model uses default causal masking)\n\n        # Handle different mask dimensions\n        if attention_mask.dim() == 2:\n            # (batch_size, seq_len) - standard padding mask, compatible with causal attention\n            return True\n        elif attention_mask.dim() in [3, 4]:\n            # (batch_size, seq_len, seq_len) or (batch_size, num_heads, seq_len, seq_len)\n            # Check if it's lower triangular (causal)\n            seq_len = attention_mask.shape[-1]\n            if seq_len <= 1:\n                return True  # Single token or empty is always causal\n\n            # Take first batch and head (if 4D) for checking pattern\n            if attention_mask.dim() == 4:\n                mask = attention_mask[0, 0]  # First batch, first head\n            else:\n                mask = attention_mask[0]  # First batch\n\n            # Check if upper triangular part is masked (should be 0 or very negative for causal)\n            upper_triangular = torch.triu(mask, diagonal=1)\n\n            # For causal masks, upper triangular should be 0 or very negative (like -inf)\n            # Use a reasonable threshold to handle float precision issues\n            is_causal = torch.all(upper_triangular <= 1e-6) or torch.all(upper_triangular < -1e4)\n            return is_causal.item() if isinstance(is_causal, torch.Tensor) else is_causal\n\n        # For unknown dimensions, be conservative and reject\n        return False\n\n    def _prepare_cp(self, model, inputs: dict[str, Union[torch.Tensor, Any]]):\n        if (\n            getattr(self.accelerator, \"parallelism_config\") is not None\n            and self.accelerator.parallelism_config.cp_enabled\n        ):\n```"}, {"role": "assistant", "content": "still need to fix that potentially but we can do that in a follow up otherwise"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40205, "url": "https://github.com/huggingface/transformers/pull/40205#discussion_r2293637875"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_webclient.py`:\n\n```python\n).addCallback(self.assertEqual, to_bytes(s))\n\n    def testPayloadDisabledCipher(self):\n        if sys.implementation.name == \"pypy\" and parse_version(cryptography.__version__) <= parse_version(\"2.3.1\"):\n            self.skipTest(\"This does work in PyPy with cryptography<=2.3.1\")\n```"}, {"role": "assistant", "content": "Is a \u201cnot\u201d missing in the skip message?\r\n\r\nAs for the reason, it would be ideal to find it out and mention it. I\u2019ve found https://github.com/pyca/cryptography/commit/ce6fe07632c17f16221f02ad19c6875327cdd10a , but it was not introduced in 2.3.1, but in 2.3. Could it be the cause? It seems like it would cause things to break starting with 2.3, not to be fixed starting from 2.3.1.\r\n\r\nThe only change specific to 2.3.1 was the rebuild of wheels with a newer OpenSSL version: 1.1.0g \u2192 1.1.0h. From the OpenSSL changelog I cannot tell much, but if we are sure that 2.3.1 is the point where things change, I guess we can assume that the new wheels are what fixes things, and we can mention that in the test."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4924, "url": "https://github.com/scrapy/scrapy/pull/4924#discussion_r545021464"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `connections.py`:\n\n```python\ndescription: str = \"\",\n            default: str | None = None,\n            widget=None,\n            source: Literal[\"Dag\", \"task\"] | None = None,\n```"}, {"role": "assistant", "content": "It kinda contradicts the previous consensus, but \"dag\", \"task'` looks better. As our consensus mainly applies to docs, I think it should be fine"}], "_meta": {"repo": "apache/airflow", "pr_number": 58615, "url": "https://github.com/apache/airflow/pull/58615#discussion_r2567430037"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_return_with_argument_inside_generator.py`:\n\n```python\nimport unittest\n\nfrom scrapy.utils.misc import is_generator_with_return_value\n\n\nclass UtilsMiscPy3TestCase(unittest.TestCase):\n\n    def test_generators_with_return_statements(self):\n        \"\"\"\n        'return with argument inside generator' is a SyntaxError before Python 3.3\n        \"\"\"\n        def f():\n            yield 1\n            return 2\n\n        def g():\n            yield 1\n            return 'asdf'\n\n        def h():\n            yield 1\n            return None\n\n        def i():\n            yield 1\n            return\n\n        def j():\n            yield 1\n\n        assert is_generator_with_return_value(f)\n        assert is_generator_with_return_value(g)\n        assert not is_generator_with_return_value(h)\n        assert not is_generator_with_return_value(i)\n        assert not is_generator_with_return_value(j)\n```"}, {"role": "assistant", "content": "I can think of a test case (expected failure?) that we might want to cover here: A test that verifies that, if something like `yield from` is used and this issue affects the nested generator, we will still not detect it because we do not inspect callbacks recursively (which I assume would make things much more complicated and/or have a potentially-significant negative impact on performance)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 3869, "url": "https://github.com/scrapy/scrapy/pull/3869#discussion_r303400904"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `finegrained_fp8.py`:\n\n```python\nreturn C\n\n\ndef w8a8_block_fp8_matmul(\n    A: torch.Tensor,\n    B: torch.Tensor,\n    As: torch.Tensor,\n    Bs: torch.Tensor,\n    block_size: list[int],\n    output_dtype: torch.dtype = torch.float32,\n) -> torch.Tensor:\n    \"\"\"\n    Dispatch to CUTLASS or Triton for block-wise FP8 matmul.\n\n    Uses CUTLASS when:\n    - Block size is [128, 128] (the only size CUTLASS supports)\n    - Running on SM90+ (Hopper or newer)\n    - The CUTLASS kernel is available\n    - Output dtype is bfloat16 or float16 (CUTLASS requirement)\n    - Tensor dimensions are compatible (divisible by 16)\n\n    Otherwise falls back to Triton.\n    \"\"\"\n    # Check if we can use CUTLASS\n    # CUTLASS only supports bfloat16/float16 output\n    cutlass_compatible_dtype = output_dtype in (torch.bfloat16, torch.float16)\n\n    if cutlass_compatible_dtype and _supports_cutlass_blockwise_fp8(block_size):\n        kernel = _get_quantization_kernel()\n        if kernel is not None:\n            try:\n                # CUTLASS expects:\n                # - A: [M, K] row-major, float8_e4m3fn\n                # - B: [K, N] column-major, float8_e4m3fn\n                # - As: [M, K//128] M-major (activation scales)\n                # - Bs: [K//128, N//128] K-major (weight scales)\n\n                # Reshape A to 2D if needed\n                original_shape = A.shape\n                M = A.numel() // A.shape[-1]\n                K = A.shape[-1]\n                N = B.shape[0]\n\n                # CUTLASS requires dimensions divisible by 16\n                if K % 16 != 0 or N % 16 != 0:\n                    raise ValueError(f\"CUTLASS requires K ({K}) and N ({N}) divisible by 16\")\n\n                A_2d = A.view(M, K).contiguous()\n                # B needs to be column-major for CUTLASS: [K, N] with stride(0)==1\n                # Our B is [N, K] row-major. Make it contiguous first, then transpose.\n                # B.contiguous() gives [N, K] with stride=(K,1)\n                # B.contiguous().t() gives [K, N] with stride=(1,K) which is column-major\n                # Do NOT call .contiguous() after .t() as it would make it row-major!\n                B_col_major = B.contiguous().t()\n\n                # Scales need proper layout for CUTLASS blockwise:\n                # As should be [M, K//128] with M-major layout (stride(0)==1)\n                # Bs should be [K//128, N//128] with K-major layout (stride(0)==1)\n\n                # As: reshape to [M, K//128], then make M-major via t().contiguous().t()\n                As_2d = As.view(M, -1).contiguous()\n                As_2d = As_2d.t().contiguous().t()  # [M, K//128] with stride(0)==1\n\n                # Bs: our input is [N//128, K//128], need [K//128, N//128] with stride(0)==1\n                # Transpose to get [K//128, N//128], then make K-major via t().contiguous().t()\n                Bs_km = Bs.contiguous().t()  # [K//128, N//128]\n                Bs_km = Bs_km.t().contiguous().t()  # Make K-major (stride(0)==1)\n```"}, {"role": "assistant", "content": "the overhead is already taken into consideration in the benchmark, the gains outweight the overhead"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43304, "url": "https://github.com/huggingface/transformers/pull/43304#discussion_r2698361155"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `redis.py`:\n\n```python\nfor param in (\"host\", \"port\", \"db\", \"password\"):\n            connparams.pop(param)\n\n        # Adding db/password in connparams to connect to the correct instance\n        for param in (\"db\", \"password\"):\n        # Adding db/password/username in connparams to connect to the correct instance\n        for param in (\"db\", \"password\", \"username\"):\n            if connparams['hosts'] and param in connparams['hosts'][0]:\n                connparams[param] = connparams['hosts'][0].get(param)\n```"}, {"role": "assistant", "content": "This appears to enable Redis Sentinel ACL authentication (username + password), which is user-facing behavior. Should we add documentation updates showing the usage pattern with username in the sentinel URL?\n\nIf yes: Could we add an example in `docs/getting-started/backends-and-brokers/redis.rst` near line 108 (in the Sentinel result backend section) showing:\n```python\napp.conf.result_backend = 'sentinel://myuser:mypass:port/db;...'\n```\nand possibly a `versionchanged:: 5.6.1` note mentioning ACL auth support for Sentinel result backends?\n\nIf no: Could you share the rationale for deferring docs, and note where users should look for usage guidance?"}], "_meta": {"repo": "celery/celery", "pr_number": 10013, "url": "https://github.com/celery/celery/pull/10013#discussion_r2584273590"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloader_handler_twisted_http2.py`:\n\n```python\ndef test_download_broken_chunked_content_allow_data_loss_via_setting(self):\n        pytest.skip(self.HTTP2_DATALOSS_SKIP_REASON)\n\n    def test_concurrent_requests_same_domain(self):\n    @deferred_f_from_coro_f\n    async def test_concurrent_requests_same_domain(self):\n        spider = Spider(\"foo\")\n\n        request1 = Request(self.getURL(\"file\"))\n        d1 = self.download_request(request1, spider)\n        d1.addCallback(lambda r: r.body)\n        d1.addCallback(self.assertEqual, b\"0123456789\")\n        response1 = await self.download_request(request1, spider)\n        assert response1.body == b\"0123456789\"\n\n        request2 = Request(self.getURL(\"echo\"), method=\"POST\")\n        d2 = self.download_request(request2, spider)\n        d2.addCallback(lambda r: r.headers[\"Content-Length\"])\n        d2.addCallback(self.assertEqual, b\"79\")\n\n        return defer.DeferredList([d1, d2])\n        response2 = await self.download_request(request2, spider)\n```"}, {"role": "assistant", "content": "The original test executed both requests concurrently via DeferredList, but this awaits the first before starting the second, losing concurrency coverage. Consider running both with `asyncio.gather` or using DeferredList to preserve the concurrent request behavior."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6846, "url": "https://github.com/scrapy/scrapy/pull/6846#discussion_r2117788017"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_policy.py`:\n\n```python\nmessage.as_string(),\n                    f\"{text}\\nBody\",\n                )\n                self.assertEqual(\n```"}, {"role": "assistant", "content": "Likewise here the test docstring should be a comment."}], "_meta": {"repo": "python/cpython", "pr_number": 144126, "url": "https://github.com/python/cpython/pull/144126#discussion_r2714352061"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_granitemoehybrid.py`:\n\n```python\nreturn cos.to(dtype=x.dtype), sin.to(dtype=x.dtype)\n\n\nclass GraniteFlashAttentionKwargs(TypedDict, total=False):\n```"}, {"role": "assistant", "content": "It looks like these just got moved during the regeneration. I'm not sure if should be included (to enforce consistency with the generation script) or excluded (to minimize the size of the change)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42036, "url": "https://github.com/huggingface/transformers/pull/42036#discussion_r2494902344"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `compat.py`:\n\n```python\nexcept ImportError:\n    cStringIO = None\n\nif is_py3:\n    def u(s):\n        return s\nelse:\n    def u(s):\n        return s.decode('unicode-escape')\ndef u(s):\n```"}, {"role": "assistant", "content": "Should we go through and remove all uses of `u(...)` in the tests to simplify them?"}], "_meta": {"repo": "psf/requests", "pr_number": 6091, "url": "https://github.com/psf/requests/pull/6091#discussion_r833414757"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_glm_image.py`:\n\n```python\nself,\n        pixel_values: torch.FloatTensor,\n        image_grid_thw: torch.LongTensor | None = None,\n        return_dict: bool | None = None,\n```"}, {"role": "assistant", "content": "yes, it is necessary because we'll be adapting 3rd party libraries to expect a tuple or dict object as output from `get_image_feature`. Thus we don't want to manually return a single tensor"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43342, "url": "https://github.com/huggingface/transformers/pull/43342#discussion_r2737139660"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_qwen2.py`:\n\n```python\nwith torch.no_grad():\n            out = model(input_ids).logits.float().cpu()\n        # Expected mean on dim = -1\n        EXPECTED_MEAN = torch.tensor([[-1.9537, -1.6193, -1.4123, -1.4673, -1.8511, -1.9309, -1.9826, -2.1776]])\n        EXPECTED_MEAN = torch.tensor([[-2.2121, -1.6335, -1.4816, -1.5035, -1.9110, -1.8979, -1.9682, -2.1980]])\n```"}, {"role": "assistant", "content": "I will run the slow test to see if this does not break things on CUDA, otherwise you should add Expectations"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42879, "url": "https://github.com/huggingface/transformers/pull/42879#discussion_r2626694795"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `content.py`:\n\n```python\nimport typing\nfrom json import dumps as json_dumps\nfrom urllib.parse import urlencode\n\nfrom .multipart import multipart_encode\n\nRequestData = typing.Union[dict, str, bytes, typing.AsyncIterator[bytes]]\n\nRequestFiles = typing.Dict[\n    str,\n    typing.Union[\n        # file (or str)\n        typing.Union[typing.IO[typing.AnyStr], typing.AnyStr],\n        # (filename, file (or str))\n        typing.Tuple[\n            typing.Optional[str], typing.Union[typing.IO[typing.AnyStr], typing.AnyStr],\n        ],\n        # (filename, file (or str), content_type)\n        typing.Tuple[\n            typing.Optional[str],\n            typing.Union[typing.IO[typing.AnyStr], typing.AnyStr],\n            typing.Optional[str],\n        ],\n    ],\n]\n\n\nclass RequestContent:\n    \"\"\"\n    Base class for request content.\n    Defaults to a \"no request body\" implementation.\n    \"\"\"\n\n    def get_headers(self) -> typing.Dict[str, str]:\n        return {}\n\n    def can_rewind(self) -> bool:\n        return True\n```"}, {"role": "assistant", "content": "What is this property supposed to enable in practice? Does that mean we can `async for chunk in content` again once we've done so at least once? I can't think of better names (`.is_replayable()`? `.can_replay()`? `.can_read_multiple_times`? `.is_isomorphic()`? \ud83e\udd23), but maybe a docstring on this base implementation could help."}], "_meta": {"repo": "encode/httpx", "pr_number": 636, "url": "https://github.com/encode/httpx/pull/636#discussion_r357912684"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_refresh_token.py`:\n\n```python\ncall_next = AsyncMock(return_value=Response())\n\n        response = await middleware.dispatch(mock_request, call_next)\n        assert response.status_code == 403\n        assert response.body == b'{\"detail\":\"Invalid JWT token\"}'\n        assert response.status_code == 200\n```"}, {"role": "assistant", "content": "Good question. In reality this will most likely return a 401. The difference here is it is a test, thus the route itself is mocked and return a 200. But in real life, if the token is expired, the route itself will also return a 401"}], "_meta": {"repo": "apache/airflow", "pr_number": 60781, "url": "https://github.com/apache/airflow/pull/60781#discussion_r2705835748"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_forward_ref.py`:\n\n```python\nfunc_val(a=1)\n\n\n@pytest.mark.xfail(\n    reason='In `GenerateSchema`, only the current class module is taken into account. '\n    'This is similar to `test_uses_the_correct_globals_to_resolve_model_forward_refs`.'\n)\ndef test_uses_the_correct_globals_to_resolve_forward_refs_on_serializers(create_module):\n    # Note: unlike `test_uses_the_correct_globals_to_resolve_model_forward_refs`,\n    # we use the globals of the underlying func to resolve the return type.\n    @create_module\n    def module_1():\n        from pydantic import BaseModel, field_serializer  # or model_serializer\n        from pydantic import BaseModel, field_serializer  # or model_serializer, computed_field\n```"}, {"role": "assistant", "content": "oh my goodness \ud83d\ude22 sorry I missed that \ud83e\udee8. Thanks! Let's merge :)"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10929, "url": "https://github.com/pydantic/pydantic/pull/10929#discussion_r1852583152"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crypto.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport logging\nfrom functools import cache\nfrom typing import Protocol\n\nlog = logging.getLogger(__name__)\n\n\nclass FernetProtocol(Protocol):\n    \"\"\"This class is only used for TypeChecking (for IDEs, mypy, etc).\"\"\"\n\n    is_encrypted: bool\n\n    def decrypt(self, msg: bytes | str, ttl: int | None = None) -> bytes:\n        \"\"\"Decrypt with Fernet.\"\"\"\n        ...\n\n    def encrypt(self, msg: bytes) -> bytes:\n        \"\"\"Encrypt with Fernet.\"\"\"\n        ...\n\n\nclass _NullFernet:\n    \"\"\"\n    A \"Null\" encryptor class that doesn't encrypt or decrypt but that presents a similar interface to Fernet.\n\n    The purpose of this is to make the rest of the code not have to know the\n    difference, and to only display the message once, not 20 times when\n    `airflow db migrate` is run.\n    \"\"\"\n\n    is_encrypted = False\n\n    def decrypt(self, msg: bytes | str, ttl: int | None = None) -> bytes:\n        \"\"\"Decrypt with Fernet.\"\"\"\n        if isinstance(msg, bytes):\n            return msg\n        if isinstance(msg, str):\n            return msg.encode(\"utf-8\")\n        raise ValueError(f\"Expected bytes or str, got {type(msg)}\")\n\n    def encrypt(self, msg: bytes) -> bytes:\n        \"\"\"Encrypt with Fernet.\"\"\"\n        return msg\n\n\nclass _RealFernet:\n    \"\"\"\n    A wrapper around the real Fernet to set is_encrypted to True.\n\n    This class is only used internally to avoid changing the interface of\n    the get_fernet function.\n    \"\"\"\n```"}, {"role": "assistant", "content": "These imports at class body level execute at class definition time (not lazy) and are redundant since `get_fernet()` already imports them. Should be removed."}], "_meta": {"repo": "apache/airflow", "pr_number": 60771, "url": "https://github.com/apache/airflow/pull/60771#discussion_r2705300264"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conversion_mapping.py`:\n\n```python\nWeightRenaming(\"mlp.moe_statics.e_score_correction_bias\", \"mlp.gate.moe_statics.e_score_correction_bias\")\n    ]\n    mapping[\"glm4_moe\"] = mapping[\"qwen2_moe\"].copy()\n    mapping[\"glm4_moe_lite\"] = mapping[\"qwen2_moe\"].copy()\n```"}, {"role": "assistant", "content": "Yes, but since this model still follows the previous structure, we'll keep this setting for now."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43031, "url": "https://github.com/huggingface/transformers/pull/43031#discussion_r2674898934"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_docs_extraction.py`:\n\n```python\n\"\"\"Utilities related to attribute docstring extraction.\"\"\"\nfrom __future__ import annotations\n\nimport ast\nimport inspect\nimport textwrap\nfrom typing import Any, Iterable\n\n\ndef _get_assign_targets(node: ast.Assign | ast.AnnAssign) -> Iterable[str]:\n    if isinstance(node, ast.Assign):\n        for target in node.targets:\n            if isinstance(target, ast.Tuple):\n                yield from (el.id for el in target.elts)\n            else:\n                yield target.id\n    else:\n        # `target` can only be `ast.Name` in the context of a `BaseModel` subclass definition\n        yield node.target.id\n\n\ndef _extract_docs(cls_def: ast.ClassDef) -> dict[str, str]:\n\n    nodes_docs_pairs = [\n        (node, inspect.cleandoc(next_node.value.s))\n        for node, next_node in zip(cls_def.body, cls_def.body[1:])\n        if isinstance(node, (ast.Assign, ast.AnnAssign))  # e.g. a: int / a = 1...\n```"}, {"role": "assistant", "content": "We could simplify even more by disregarding `ast.Assign`, which isn't possible in a Pydantic model:\r\n\r\n```python\r\nclass A(BaseModel):\r\n  a = 1\r\n# throws PydanticUserError\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6563, "url": "https://github.com/pydantic/pydantic/pull/6563#discussion_r1258660533"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `connection.py`:\n\n```python\nif self.extra:\n            try:\n                extra = json.loads(self.extra)\n                if nested:\n                    for key, value in json.loads(self.extra).items():\n                        extra[key] = value\n                    for key, value in extra.items():\n                        if isinstance(value, str):\n                            with suppress(JSONDecodeError):\n                            try:\n                                extra[key] = json.loads(value)\n                else:\n                    extra = json.loads(self.extra)\n                            except (JSONDecodeError, TypeError):\n                                pass\n```"}, {"role": "assistant", "content": "Sorry for pointing you in the wrong direction in my last review.\nAfter double-checking, we don\u2019t need to change `get_extra_dejson` at all."}], "_meta": {"repo": "apache/airflow", "pr_number": 59339, "url": "https://github.com/apache/airflow/pull/59339#discussion_r2625571312"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_qwen2_5_vl.py`:\n\n```python\nimage_grid_thw = image_inputs[\"image_grid_thw\"]\n\n        if videos is not None:\n            fps = output_kwargs[\"videos_kwargs\"].get(\"fps\", 2.0)\n            if \"do_sample_frames\" not in output_kwargs[\"videos_kwargs\"] and (\n                output_kwargs[\"videos_kwargs\"].get(\"fps\") is not None\n            ):\n                output_kwargs[\"videos_kwargs\"][\"do_sample_frames\"] = True\n                logger.info(\n                    \"User specified 'fps' without 'do_sample_frames'; \"\n                    \"'do_sample_frames' has been automatically enabled.\"\n                )\n\n            videos_inputs = self.video_processor(videos=videos, **output_kwargs[\"videos_kwargs\"])\n            video_grid_thw = videos_inputs[\"video_grid_thw\"]\n\n            # Get video metadata\n            if \"return_metadata\" not in kwargs:\n                video_metadata = videos_inputs.pop(\"video_metadata\")\n            else:\n                video_metadata = videos_inputs[\"video_metadata\"]\n\n            fps = output_kwargs[\"videos_kwargs\"].get(\n                \"fps\", [metadata.fps if metadata.fps is not None else 24 for metadata in video_metadata]\n            )\n```"}, {"role": "assistant", "content": "Thanks for detailed explanation. I looked through the qwen paper and the m-rope documentation and it looks like the FPS is indeed the video's fps after the optional sampling. Though it will be breaking wrt the current main branch because the default fps when not provided is 24 now. I want to also ask the authors  to take a look and confirm this is how QwenVL should work"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42009, "url": "https://github.com/huggingface/transformers/pull/42009#discussion_r2497795970"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nitems = parse_qsl(value)\n        elif isinstance(value, QueryParams):\n            items = value.multi_items()\n        elif isinstance(value, list):\n        elif type(value) in [list, tuple]:\n```"}, {"role": "assistant", "content": "As per `isinstance(value, Sequence)` - it is a bit too broad. For example - String is also isinstance of Sequence:\r\n```\r\n>>> isinstance('asfd', Sequence)\r\nTrue\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1426, "url": "https://github.com/encode/httpx/pull/1426#discussion_r541634440"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_extension_statsmailer.py`:\n\n```python\nfrom unittest.mock import MagicMock\n\nimport pytest\n\nfrom scrapy import signals\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.extensions import statsmailer\nfrom scrapy.mail import MailSender\nfrom scrapy.signalmanager import SignalManager\nfrom scrapy.spiders import Spider\nfrom scrapy.statscollectors import StatsCollector\n\n\nclass DummySpider(Spider):\n    name = \"dummy_spider\"\n\n\n@pytest.fixture\ndef dummy_stats():\n    class DummyStats(StatsCollector):\n        def __init__(self):\n            # pylint: disable=super-init-not-called\n            self._stats = {\"global_item_scraped_count\": 42}\n\n        def get_stats(self, spider=None):\n            if spider:\n```"}, {"role": "assistant", "content": "We need to accept the spider argument in our DummyStats.get_stats, but ignore it. That way the test will work across different versions. Gives an error in case spider arg is not passed."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7013, "url": "https://github.com/scrapy/scrapy/pull/7013#discussion_r2301737683"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_validators.py`:\n\n```python\nThough this could be divided into two separate functions, the logic is easier to follow if we couple the computation\n    of the number of decimals and digits together.\n    \"\"\"\n    decimal_tuple = decimal.as_tuple()\n    if not isinstance(decimal_tuple.exponent, int):\n        raise TypeError(f'Unable to extract decimal digits info from supplied value {decimal}')\n    exponent = decimal_tuple.exponent\n    num_digits = len(decimal_tuple.digits)\n\n    if exponent >= 0:\n        # A positive exponent adds that many trailing zeros\n        # Ex: digit_tuple=(1, 2, 3), exponent=2 -> 12300 -> 0 decimal places, 5 digits\n        num_digits += exponent\n        decimal_places = 0\n    else:\n        # If the absolute value of the negative exponent is larger than the\n        # number of digits, then it's the same as the number of digits,\n        # because it'll consume all the digits in digit_tuple and then\n        # add abs(exponent) - len(digit_tuple) leading zeros after the decimal point.\n        # Ex: digit_tuple=(1, 2, 3), exponent=-2 -> 1.23 -> 2 decimal places, 3 digits\n        # Ex: digit_tuple=(1, 2, 3), exponent=-4 -> 0.0123 -> 4 decimal places, 4 digits\n        decimal_places = abs(exponent)\n        num_digits = max(num_digits, decimal_places)\n    try:\n        decimal_tuple = decimal.as_tuple()\n\n    return decimal_places, num_digits\n```"}, {"role": "assistant", "content": "Would it be better to change the argument type to `Any` and add another `assert` to check if the type is `Decimal`? \ud83e\udd14"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10763, "url": "https://github.com/pydantic/pydantic/pull/10763#discussion_r1844740265"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nraise AttributeError(attribute)\n\n\ndef _annotated_type(type_: Any) -> Any | None:\n    return get_args(type_)[0] if _typing_extra.is_annotated(type_) else None\n\n\ndef _type_has_config(type_: Any) -> bool:\n    \"\"\"Returns whether the type has config.\"\"\"\n    type_ = _annotated_type(type_) or type_\n    try:\n        return issubclass(type_, BaseModel) or is_dataclass(type_) or is_typeddict(type_)\n    except TypeError:\n        # type is not a class\n        return False\n\n\ndef _frame_depth(depth: int) -> Callable[[Callable[..., R]], Callable[..., R]]:\n    def wrapper(func: Callable[..., R]) -> Callable[..., R]:\n        @wraps(func)\n        def wrapped(self: TypeAdapter, *args: Any, **kwargs: Any) -> R:\n            # depth + 1 for the wrapper function\n            with self._with_frame_depth(depth + 1):\n                return func(self, *args, **kwargs)\n\n        return wrapped\n\n    return wrapper\n```"}, {"role": "assistant", "content": "Yeah no way to get rid of parent depth handling but some better (optional) way could be offered via configs to resolve the names. As working of the parent depth handling highly depends on the context on how model happens to be used"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 8939, "url": "https://github.com/pydantic/pydantic/pull/8939#discussion_r1552063424"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `defer.py`:\n\n```python\nreturn DeferredList([coop.coiterate(work) for _ in range(count)])\n\n\nclass _AsyncCooperatorAdapter(Iterator[Deferred], Generic[_T]):\nclass _AsyncCooperatorAdapter(Iterator[Deferred], Generic[_T, _SelfResultT]):\n```"}, {"role": "assistant", "content": "See full error stack trace here: https://github.com/vsevolodbreus/scrapy/actions/runs/10700184494/job/29663370539"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6472, "url": "https://github.com/scrapy/scrapy/pull/6472#discussion_r1743543183"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_proxy_connect.py`:\n\n```python\nyield crawler.crawl(self.mockserver.url(\"/status?n=200\", is_secure=True))\n        self._assert_got_response_code(200, l)\n\n    @pytest.mark.xfail(reason='mitmproxy gives an error for noconnect requests')\n```"}, {"role": "assistant", "content": "What error is that? Is it some feature missing in mitmproxy, which was present before? If so, it'd be good to open a ticket in their issue tracker, and add a link  here."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4114, "url": "https://github.com/scrapy/scrapy/pull/4114#discussion_r341840393"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_llava_next_fast.py`:\n\n```python\n)\n                processed_image_patches_grouped[shape] = stacked_image_patches\n            processed_image_patches = reorder_images(processed_image_patches_grouped, grouped_image_patches_index)\n            processed_image_patches = (\n                torch.stack(processed_image_patches, dim=0) if return_tensors else processed_image_patches\n            )\n            processed_image_patches = torch.stack(processed_image_patches, dim=0)\n```"}, {"role": "assistant", "content": "is it safe to stack or do we assume that resizing is `True`? If images weren't resized and padded, it will fail"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41773, "url": "https://github.com/huggingface/transformers/pull/41773#discussion_r2509458568"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\nimport pytest\nfrom fastapi._compat import PYDANTIC_V2\nfrom inline_snapshot import Snapshot\n\nneeds_py39 = pytest.mark.skipif(sys.version_info < (3, 9), reason=\"requires python3.9+\")\nneeds_py310 = pytest.mark.skipif(\n    sys.version_info < (3, 10), reason=\"requires python3.10+\"\n)\nneeds_pydanticv2 = pytest.mark.skipif(not PYDANTIC_V2, reason=\"requires Pydantic v2\")\nneeds_pydanticv1 = pytest.mark.skipif(PYDANTIC_V2, reason=\"requires Pydantic v1\")\n\n\ndef pydantic_snapshot(\n    *,\n    v2: Snapshot,\n    v1: Snapshot,\n):\n    \"\"\"\n    this function should be used like:\n```"}, {"role": "assistant", "content": "```suggestion\r\n    This function should be used like this:\r\n```"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 12534, "url": "https://github.com/fastapi/fastapi/pull/12534#discussion_r2018991952"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\n)\n\n    def _unsubstituted_typevar_schema(self, typevar: typing.TypeVar) -> core_schema.CoreSchema:\n        assert isinstance(typevar, typing.TypeVar)\n\n        bound = typevar.__bound__\n        constraints = typevar.__constraints__\n\n        try:\n            typevar_has_default = typevar.has_default()  # type: ignore\n            has_default = typevar.has_default()\n        except AttributeError:\n            # could still have a default if it's an old version of typing_extensions.TypeVar\n            typevar_has_default = getattr(typevar, '__default__', None) is not None\n            # Happens if using `typing.TypeVar` on Python < 3.13\n            pass\n        else:\n            if has_default:\n                return self.generate_schema(typevar.__default__)\n\n        if (bound is not None) + (len(constraints) != 0) + typevar_has_default > 1:\n            raise NotImplementedError(\n                'Pydantic does not support mixing more than one of TypeVar bounds, constraints and defaults'\n            )\n        if typevar.__constraints__:\n            return self._union_schema(typing.Union[typevar.__constraints__])\n```"}, {"role": "assistant", "content": "```suggestion\r\n        if (constraints := typevar.__constraints__):\r\n            return self._union_schema(typing.Union[constraints])\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10789, "url": "https://github.com/pydantic/pydantic/pull/10789#discussion_r1845234695"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `remove_await_parens.py`:\n\n```python\nasync def main():\n    await (yield)\n\nasync def main():\n    await (a ** b)\n\nasync def main():\n```"}, {"role": "assistant", "content": "These two cases were already fine, but I added them for completeness"}], "_meta": {"repo": "psf/black", "pr_number": 3994, "url": "https://github.com/psf/black/pull/3994#discussion_r1375173135"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_grounding_dino.py`:\n\n```python\nreturn token_ids\n\n\nclass GroundingDinoProcessorKwargs(ProcessingKwargs, total=False):\n    _defaults = {\n        \"text_kwargs\": {\n            \"add_special_tokens\": True,\n            \"padding\": False,\n            \"truncation\": None,\n            \"max_length\": None,\n            \"stride\": 0,\n            \"pad_to_multiple_of\": None,\n            \"return_attention_mask\": None,\n            \"return_overflowing_tokens\": False,\n            \"return_special_tokens_mask\": False,\n            \"return_offsets_mapping\": False,\n            \"return_token_type_ids\": True,\n            \"return_length\": False,\n            \"verbose\": True,\n        }\n    }\n```"}, {"role": "assistant", "content": "I was also hesitated to write like this. I will change this as he comments!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 31964, "url": "https://github.com/huggingface/transformers/pull/31964#discussion_r1677656303"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_utils.py`:\n\n```python\nnum_hidden_layers=2,\n            num_attention_heads=4,\n        )\n        model = MistralModel(cfg)\n        model = MistralForCausalLM(cfg)\n```"}, {"role": "assistant", "content": "we want to check that a generative decoder-only model doesn't return its base model as encoder, Just a tiny chnage"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42295, "url": "https://github.com/huggingface/transformers/pull/42295#discussion_r2545399317"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_youtu.py`:\n\n```python\n# Copyright 2024 The HuggingFace Inc. team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\"\"\"Testing suite for the PyTorch Youtu-LLM model.\"\"\"\n\nimport unittest\n\nimport pytest\nfrom packaging import version\nfrom parameterized import parameterized\n\nfrom transformers import AutoTokenizer, YoutuConfig, is_torch_available\nfrom transformers.testing_utils import (\n    cleanup,\n    require_torch,\n    require_torch_accelerator,\n    require_torch_large_accelerator,\n    slow,\n    torch_device,\n)\n\nfrom ...generation.test_utils import GenerationTesterMixin\nfrom ...test_configuration_common import ConfigTester\nfrom ...test_modeling_common import ModelTesterMixin, ids_tensor\nfrom ...test_pipeline_mixin import PipelineTesterMixin\n\n\nif is_torch_available():\n    import torch\n\n    torch.set_float32_matmul_precision(\"high\")\n\n    from transformers import (\n        Cache,\n        YoutuForCausalLM,\n        YoutuModel,\n    )\n\n\nclass YoutuModelTester:\n```"}, {"role": "assistant", "content": "I found some attributes are incompatible:\r\n```\r\nFAILED tests/models/youtu/test_modeling_youtu.py::YoutuModelTest::test_model_rope_scaling_from_config_0_linear - AttributeError: 'CausalLMOutputWithPast' object has no attribute 'last_hidden_state'\r\nFAILED tests/models/youtu/test_modeling_youtu.py::YoutuModelTest::test_model_rope_scaling_from_config_1_dynamic - AttributeError: 'CausalLMOutputWithPast' object has no attribute 'last_hidden_state'\r\nFAILED tests/models/youtu/test_modeling_youtu.py::YoutuModelTest::test_model_rope_scaling_from_config_2_yarn - AttributeError: 'CausalLMOutputWithPast' object has no attribute 'last_hidden_state'\r\nFAILED tests/models/youtu/test_modeling_youtu.py::YoutuModelTest::test_training_overfit - AttributeError: 'BaseModelOutputWithPast' object has no attribute 'loss'\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43166, "url": "https://github.com/huggingface/transformers/pull/43166#discussion_r2726717499"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\nself.spider: Optional[Spider] = None\n        self.running = False\n        self.paused = False\n        self.scheduler_cls = load_object(crawler.settings[\"SCHEDULER\"])\n        self.scheduler_cls = self._get_scheduler_class(crawler.settings)\n        downloader_cls = load_object(self.settings['DOWNLOADER'])\n        self.downloader = downloader_cls(crawler)\n        self.scraper = Scraper(crawler)\n        self._spider_closed_callback = spider_closed_callback\n\n    def _get_scheduler_class(self, settings: BaseSettings) -> type:\n        from scrapy.core.scheduler import BaseScheduler\n        scheduler_cls = load_object(settings[\"SCHEDULER\"])\n        if not issubclass(scheduler_cls, BaseScheduler):\n            raise TypeError(\n                f\"The provided scheduler class ({settings['SCHEDULER']})\"\n                \" does not fully implement the scheduler interface\"\n            )\n```"}, {"role": "assistant", "content": "It shouldn't, the subclass check is done via a metaclass, it makes sure the necessary methods exist."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 3559, "url": "https://github.com/scrapy/scrapy/pull/3559#discussion_r617032995"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `decorator.py`:\n\n```python\ndef override(self, **kwargs: Any) -> Task[FParams, FReturn]: ...\n\n\ndef unwrap_callable(func):\n    from airflow.sdk.bases.decorator import _TaskDecorator\n    from airflow.sdk.definitions.mappedoperator import OperatorPartial\n\n    if isinstance(func, (_TaskDecorator, OperatorPartial)):\n        # unwrap to the real underlying callable\n        return getattr(func, \"function\", getattr(func, \"_func\", func))\n    return func\n\n\ndef is_async_callable(func):\n```"}, {"role": "assistant", "content": "I refactored the is_async_callable method to take into account more scenario's like with FastAPI, I also added different test cases documenting the methods behaviour."}], "_meta": {"repo": "apache/airflow", "pr_number": 59087, "url": "https://github.com/apache/airflow/pull/59087#discussion_r2627055980"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pipeline.py`:\n\n```python\ns = s.copy()\n            s['to_upper'] = True\n            return s\n\n    # TODO: need to expand this logic to cover more cases, like datetimes, etc\n```"}, {"role": "assistant", "content": "Yeah we can... I was trying to improve JSON schema for this case  mentioned:\r\n\r\n```\r\nta = TypeAdapter(Annotated[int, validate_as(str).transform(int)])\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9459, "url": "https://github.com/pydantic/pydantic/pull/9459#discussion_r1628436832"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_edgetam_video.py`:\n\n```python\ninput_modalities = (\"video\", \"text\")\n    _can_record_outputs = {\"mask_decoder_attentions\": OutputRecorder(EdgeTamVideoTwoWayAttentionBlock, index=2)}\n    _keys_to_ignore_on_load_unexpected = []\n    _tied_weights_keys = {\n        \"prompt_encoder.shared_embedding.positional_embedding\": \"shared_image_embedding.positional_embedding\"\n    }\n    # need to be ignored, as it's a buffer and will not be correctly detected as tied weight\n    _keys_to_ignore_on_load_missing = [\"prompt_encoder.shared_embedding.positional_embedding\"]\n```"}, {"role": "assistant", "content": "Well, for sure you won't have warnings about tied weights if we never tie them haha - did you make sure that both weights correctly live inside ALL main checkpoints? If it's the case, then yes probably they were never supposed to be tied"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42840, "url": "https://github.com/huggingface/transformers/pull/42840#discussion_r2614745584"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_d_fine.py`:\n\n```python\nref_points_input = ref_points_detach.unsqueeze(2)\n            query_pos_embed = self.query_pos_head(ref_points_detach).clamp(min=-10, max=10)\n\n            if output_hidden_states:\n                all_hidden_states += (hidden_states,)\n\n            output = decoder_layer(\n                hidden_states=hidden_states,\n            hidden_states = decoder_layer(\n                hidden_states,\n                position_embeddings=query_pos_embed,\n                reference_points=ref_points_input,\n                spatial_shapes=spatial_shapes,\n                spatial_shapes_list=spatial_shapes_list,\n                encoder_hidden_states=encoder_hidden_states,\n                encoder_attention_mask=encoder_attention_mask,\n                output_attentions=output_attentions,\n                **kwargs,\n            )\n\n            hidden_states = output[0]\n\n            if i == 0:\n                # Initial bounding box predictions with inverse sigmoid refinement\n                new_reference_points = F.sigmoid(self.pre_bbox_head(output[0]) + inverse_sigmoid(ref_points_detach))\n                new_reference_points = F.sigmoid(\n                    self.pre_bbox_head(hidden_states) + inverse_sigmoid(ref_points_detach)\n```"}, {"role": "assistant", "content": "Nope they're the same! output used to be `(hidden_states,)`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2686923639"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_content_streams.py`:\n\n```python\n)\n\n\n@pytest.mark.asyncio\nasync def test_empty_request():\n    stream = encode(data={}, files={})\n    sync_content = b\"\".join([part for part in stream])\n    async_content = b\"\".join([part async for part in stream])\n\n    assert stream.can_replay()\n    assert stream.get_headers() == {\n        \"Content-Length\": \"0\",\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n```"}, {"role": "assistant", "content": "Looking at RFC 7320, it looks like for POST requests including a `Content-Length` always is sort of recommended, yes:\r\n\r\n> A user agent SHOULD send a Content-Length in a request message when\r\n   no Transfer-Encoding is sent and the request method defines a meaning\r\n   for an enclosed payload body. **For example, a Content-Length header\r\n   field is normally sent in a POST request even when the value is 0\r\n   (indicating an empty payload body).**\r\n\r\nSo given that we only use `encode()` for multipart POST requests, I think it would make sense for us to do it. But let's treat that as a separate PR maybe? \ud83d\ude04"}], "_meta": {"repo": "encode/httpx", "pr_number": 861, "url": "https://github.com/encode/httpx/pull/861#discussion_r392840494"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_glm46v.py`:\n\n```python\n- `\"none\"` or `ChannelDimension.NONE`: image in (height, width) format.\n\n        \"\"\"\n        # Try to use config values if set, otherwise fallback to global defaults\n        size = size if size is not None else self.size\n        if size is not None and (\"shortest_edge\" not in size or \"longest_edge\" not in size):\n            raise ValueError(\"size must contain 'shortest_edge' and 'longest_edge' keys.\")\n```"}, {"role": "assistant", "content": "i think we still need the error, in case users pass size in incorrect format"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39585, "url": "https://github.com/huggingface/transformers/pull/39585#discussion_r2606711656"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_tasks.py`:\n\n```python\nassert result.status == 'FAILURE'\n\n\nclass test_apply_tasks:\n    \"\"\"Tests for tasks called via apply() method.\"\"\"\n\n    def test_apply_single_task_ids(self, manager):\n```"}, {"role": "assistant", "content": "or maybe, since `apply()` is sync and tests are actually equals, maybe leave only one between `integration` and `unit` tests"}], "_meta": {"repo": "celery/celery", "pr_number": 9784, "url": "https://github.com/celery/celery/pull/9784#discussion_r2171582756"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conf.py`:\n\n```python\n\" or as a file extension, from the supported list %s\" %\n                             (output_format, tuple(valid_output_formats)))\n\n    overwrite = False\n    if overwrite_output:\n        if output:\n            raise UsageError(\"Please use only one of --output and --overwrite-output\")\n```"}, {"role": "assistant", "content": "```suggestion\r\n            raise UsageError(\"Please use only one of -o/--output and -O/--overwrite-output\")\r\n```\r\nOr something similar. I wonder if that would be more informative, perhaps not everybody knows exactly what `-o/-O` means."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4512, "url": "https://github.com/scrapy/scrapy/pull/4512#discussion_r421082215"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_content.py`:\n\n```python\nassert isinstance(stream, httpx.SyncByteStream)\n    assert isinstance(stream, httpx.AsyncByteStream)\n\n    sync_content = stream.read()\n    async_content = await stream.aread()\n```"}, {"role": "assistant", "content": "We're matching the style of the other test cases now.\r\nThese `.read()`/`.aread()` operations were only added to this test case so that we'd have coverage of those code lines."}], "_meta": {"repo": "encode/httpx", "pr_number": 2407, "url": "https://github.com/encode/httpx/pull/2407#discussion_r994626502"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auto_round.py`:\n\n```python\noutput = quantized_model.generate(**input_ids, max_new_tokens=40, do_sample=False)\n        self.assertIn(self.tokenizer.decode(output[0], skip_special_tokens=True), self.EXPECTED_OUTPUTS)\n\n    @require_intel_extension_for_pytorch\n```"}, {"role": "assistant", "content": "maybe we can skip those tests or require a specific tag to be enabled ? It will be too slow on our CI to run the model on our cpu."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42852, "url": "https://github.com/huggingface/transformers/pull/42852#discussion_r2731590591"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_grounding_dino.py`:\n\n```python\nreturn token_ids\n\n\nclass GroundingDinoProcessorKwargs(ProcessingKwargs, total=False):\n    _defaults = {\n        \"text_kwargs\": {\n            \"add_special_tokens\": True,\n            \"padding\": False,\n            \"truncation\": None,\n            \"max_length\": None,\n            \"stride\": 0,\n            \"pad_to_multiple_of\": None,\n            \"return_attention_mask\": None,\n            \"return_overflowing_tokens\": False,\n            \"return_special_tokens_mask\": False,\n            \"return_offsets_mapping\": False,\n            \"return_token_type_ids\": True,\n            \"return_length\": False,\n            \"verbose\": True,\n        }\n    }\n```"}, {"role": "assistant", "content": "Yes exactly, this should include all defaults for all modalities. However here, the base processor was \r\n1) not passing any of the kwargs to the `image_processor` \r\n2) hence, not passing any defaults to the same image processor.\r\nSo, we should not pass default image kwargs here, but simply make sure image processing kwargs are received by the image processor post `self._merge_kwargs` as done now."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 31964, "url": "https://github.com/huggingface/transformers/pull/31964#discussion_r1677714440"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_kernels.py`:\n\n```python\n# Copyright 2025 The HuggingFace Team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n# Run the test: CUDA_VISIBLE_DEVICES=0 RUN_SLOW=1 pytest -sv tests/kernels/test_kernels.py\n\n\nimport copy\nimport types\nfrom unittest.mock import patch\n\nfrom transformers import AutoModelForCausalLM, AutoTokenizer, KernelConfig\nfrom transformers.integrations.hub_kernels import (\n    _HUB_KERNEL_MAPPING,\n    _KERNEL_MODULE_MAPPING,\n    is_kernel,\n    lazy_load_kernel,\n    load_and_register_attn_kernel,\n)\nfrom transformers.masking_utils import ALL_MASK_ATTENTION_FUNCTIONS\nfrom transformers.modeling_utils import ALL_ATTENTION_FUNCTIONS\nfrom transformers.testing_utils import (\n    TestCasePlus,\n    cleanup,\n    require_kernels,\n    require_torch_accelerator,\n    slow,\n    torch_device,\n)\nfrom transformers.utils import is_kernels_available\n\n\nif is_kernels_available():\n    import kernels as kernels_pkg\n    from kernels import Device, Mode, kernelize\n\n\n@require_kernels\n@slow\nclass TestHubKernels(TestCasePlus):\n    @classmethod\n    def setUpClass(cls):\n        cls.model_id = \"unsloth/Llama-3.2-1B-Instruct\"\n        cls.tokenizer = AutoTokenizer.from_pretrained(cls.model_id)\n        cls.model_kernelized = AutoModelForCausalLM.from_pretrained(\n            cls.model_id, use_kernels=True, device_map=torch_device\n        )\n        cls.model_not_kernelized = AutoModelForCausalLM.from_pretrained(\n            cls.model_id, use_kernels=False, device_map=torch_device\n        )\n        cls.input = \"Hello\"\n\n    def tearDown(self):\n```"}, {"role": "assistant", "content": "this should be  `tearDownClass` now.\r\n\r\nwe should still keep `tearDown` with only `cleanup(torch_device, gc_collect=True)`."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41765, "url": "https://github.com/huggingface/transformers/pull/41765#discussion_r2452271555"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `closespider.py`:\n\n```python\ndef page_count(self, response: Response, request: Request, spider: Spider) -> None:\n        self.counter[\"pagecount\"] += 1\n        self.counter[\"pagecount_since_last_item\"] += 1\n        if self.counter[\"pagecount\"] == self.close_on[\"pagecount\"]:\n            assert self.crawler.engine\n            self.crawler.engine.close_spider(spider, \"closespider_pagecount\")\n```"}, {"role": "assistant", "content": "Maybe add an early return at the end of this `if`. No need to check if the condition below has been met if this one has."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6434, "url": "https://github.com/scrapy/scrapy/pull/6434#discussion_r1671744827"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `project.py`:\n\n```python\nreturn str(d)\n\n\ndef data_path(path: str, createdir: bool = False) -> str:\ndef data_path(path: Union[str, PathLike, Path], createdir: bool = False) -> str:\n```"}, {"role": "assistant", "content": "I meant removing `Path`, not removing `PathLike`. `Union[str, PathLike]` is the usual hint for these APIs."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6133, "url": "https://github.com/scrapy/scrapy/pull/6133#discussion_r1381815160"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `link.py`:\n\n```python\nUsing the anchor tag sample below to illustrate the parameters::\n\n            <a href=\"/nofollow.html#foo\" rel=\"nofollow\">Dont follow this one</a>\n            <a href=\"https://example.com/nofollow.html#foo\" rel=\"nofollow\">Dont follow this one</a>\n```"}, {"role": "assistant", "content": "I actually think that it\u2019s good that the URL was not absolute here. We simply need to indicate, either in the preceding paragraph or in the documentation about the `url` parameter below, that the example `url` value assumes that this code comes from `https://example.com`.\r\n\r\nDirectly making this an absolute URL in the code example hides the fact that the `url` parameter in `Link` must be an absolute URL.\r\n\r\nAlthough it could be argued that saying `absolute URL` instead of `address` below should be enough to clarify that. I guess keeping the absolute URL here but indicating that below would work for me as well."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4775, "url": "https://github.com/scrapy/scrapy/pull/4775#discussion_r489411499"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `bitnet.py`:\n\n```python\nreturn output\n\n\ndef _replace_with_bitnet_linear(\n    model,\n    modules_to_not_convert=None,\n    current_key_name=None,\n    quantization_config=None,\n    has_been_replaced=False,\n    pre_quantized=False,\n):\ndef replace_with_bitnet_linear(model, modules_to_not_convert: list[str] | None = None, quantization_config=None):\n    \"\"\"\n    Private method that wraps the recursion for module replacement.\n    Public method that recursively replaces the kinear layers of the given model with bitnet quantized layers.\n```"}, {"role": "assistant", "content": "```suggestion\n    Public method that replaces the linear layers of the given model with bitnet quantized layers.\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42711, "url": "https://github.com/huggingface/transformers/pull/42711#discussion_r2602584343"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\ndef _subclass_schema(self, type_: Any) -> core_schema.CoreSchema:\n        \"\"\"Generate schema for a Type, e.g. `Type[int]`.\"\"\"\n        type_param = self._get_first_arg_or_any(type_)\n        type_param = _typing_extra.eval_type(type_param, *self._types_namespace)\n```"}, {"role": "assistant", "content": "The evaluation of forward refs is still a mess, but looking at the other places where `_get_first_arg_or_any` (and `_get_args_resolving_forward_refs`), this is the only place where the extra evaluation is needed. Let's go this way for now but this should be cleaned up at some point."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10621, "url": "https://github.com/pydantic/pydantic/pull/10621#discussion_r1803038168"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deprecate.py`:\n\n```python\nreturn f'{cls.__module__}.{cls.__name__}'\n\n\nDEPRECATION_RULES = [\n    ('scrapy.telnet.', 'scrapy.extensions.telnet.'),\n]\nDEPRECATION_RULES = []\n\n\ndef update_classpath(path):\n```"}, {"role": "assistant", "content": "Yeah but the logic depends all on `DEPRECATION_RULES` variable right?\r\n\r\n```python\r\n    for prefix, replacement in DEPRECATION_RULES:\r\n        if isinstance(path, str) and path.startswith(prefix):\r\n            new_path = path.replace(prefix, replacement, 1)\r\n            warnings.warn(f\"`{path}` class is deprecated, use `{new_path}` instead\",\r\n                          ScrapyDeprecationWarning)\r\n            return new_path\r\n    return path\r\n```\r\nIf nothing is provided it will just return what was originally send by parameter right?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5730, "url": "https://github.com/scrapy/scrapy/pull/5730#discussion_r1030303840"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_types.py`:\n\n```python\nassert exc_info.value.errors(include_url=False) == errors\n\n\ndef test_mutable_mapping() -> None:\ndef test_mutable_mapping_userdict_subclass() -> None:\n    \"\"\"Addresses https://github.com/pydantic/pydantic/issues/9549.\n\n    Note - we still don't do a good job of handling subclasses, as we convert the input to a dict\n    via the MappingValidator annotation's schema.\n```"}, {"role": "assistant", "content": "Good catch -- well the `MappingValidator` is not a thing anymore but I think the comment is still relevant."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11658, "url": "https://github.com/pydantic/pydantic/pull/11658#discussion_r2025556029"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_addons.py`:\n\n```python\nimport unittest\nfrom typing import Any, Dict, Optional\n\nfrom scrapy.crawler import Crawler\nfrom scrapy.settings import BaseSettings\nfrom scrapy.utils.test import get_crawler\n\n\nclass GoodAddon:\n    def __init__(self, config: Optional[Dict[str, Any]] = None) -> None:\n```"}, {"role": "assistant", "content": "It looked good to me on my latest pass. Though I guess the `AddonTest` below only really tests BaseSettings.update, so maybe it is not that useful."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5950, "url": "https://github.com/scrapy/scrapy/pull/5950#discussion_r1271917540"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crawler.py`:\n\n```python\nassert self.engine\n            yield maybeDeferred(self.engine.stop)\n\n    @staticmethod\n    def _get_component(component_class, components):\n        for component in components:\n            if (\n                type(component)  # pylint: disable=unidiomatic-typecheck\n                is component_class\n```"}, {"role": "assistant", "content": "Use cases I could find in the wild:\r\n- `isinstance`: 1, 2, 3, 4, 5.\r\n- `type` match: none found.\r\n- `str` in: 1, 2.\r\n- N/A: 1, 2, 3.\r\n\r\nSo, do we go with `isinstance`? Do we provide a boolean parameter to switch to a `type` match?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6181, "url": "https://github.com/scrapy/scrapy/pull/6181#discussion_r1433852041"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\n@property\n    def optional(self) -> bool:\n        return self.expected is not None and self.expected.optional\n        return bool(self.expected) and all(\n            diagnostic.optional for diagnostic in self.expected\n        )\n\n    @property\n    def multi(self) -> bool:\n        return bool(self.expected) and all(\n            diagnostic.multi for diagnostic in self.expected\n        )\n\n    def diagnostics_by_source(self, source: Source) -> list[Diagnostic]:\n        match source:\n            case Source.NEW:\n                return self.new\n            case Source.OLD:\n                return self.old\n            case Source.EXPECTED:\n                return self.expected\n            case _:\n                raise ValueError(f\"Invalid source: {source}\")\n\n    def classify(self, source: Source) -> Classification:\n        if source in self.sources:\n            if Source.EXPECTED in self.sources:\n                assert self.expected is not None\n```"}, {"role": "assistant", "content": "I'm surprised that ty doesn't catch this but `self.expected` should never be `None` here"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22746, "url": "https://github.com/astral-sh/ruff/pull/22746#discussion_r2715756019"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_robotstxt_interface.py`:\n\n```python\n)\n\n\nclass DecodeRobotsTxtTest(unittest.TestCase):\n    def test_native_string_conversion(self):\n        robotstxt_body = \"User-agent: *\\nDisallow: /\\n\".encode(\"utf-8\")\n        decoded_content = decode_robotstxt(\n            robotstxt_body, spider=None, to_native_str_type=True\n        )\n        self.assertEqual(decoded_content, \"User-agent: *\\nDisallow: /\\n\")\n\n    def test_decode_utf8(self):\n        robotstxt_body = \"User-agent: *\\nDisallow: /\\n\".encode(\"utf-8\")\n        decoded_content = decode_robotstxt(robotstxt_body, spider=None)\n        self.assertEqual(decoded_content, \"User-agent: *\\nDisallow: /\\n\")\n\n    def test_decode_non_utf8(self):\n        robotstxt_body = b\"User-agent: *\\n\\xFFDisallow: /\\n\"\n        decoded_content = decode_robotstxt(robotstxt_body, spider=None)\n        self.assertNotEqual(decoded_content, \"\")\n```"}, {"role": "assistant", "content": "I also think we should use `assertEqual` with the actual value.\r\n\r\n> was trying to make sure that this code wouldn't fall under the case where a `UnicodeDecodeError` is thrown\r\n\r\n`assertEqual` with the actual value works for this as well, as long as the actual value is not `\"\"`, i.e. `self.assertEqual(decoded_content, \"foo\")` implies `self.assertNotEqual(decoded_content, \"\")`, but is better than the latter because it also proves we are using `ignore` and not some other error handling (e.g. replacing errors with special characters or something)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6298, "url": "https://github.com/scrapy/scrapy/pull/6298#discussion_r1551233860"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `triggerer_job_runner.py`:\n\n```python\nframe = _RequestFrame(id=next(self.id_counter), body=msg.model_dump())\n        bytes = frame.as_bytes()\n\n        async with self._lock:\n        async with self._async_lock:\n```"}, {"role": "assistant", "content": "It exists in the parent class CommsDecoder,  correctly suggested that I should align those, otherwise we would have duplicate lock definitions."}], "_meta": {"repo": "apache/airflow", "pr_number": 60268, "url": "https://github.com/apache/airflow/pull/60268#discussion_r2675051994"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\n#     return json_schema\n\n        # we reflect the application of custom plain, no-info serializers to defaults for\n        # json schemas viewed in serialization mode\n        # JSON Schemas viewed in serialization mode:\n        # TODO: improvements along with https://github.com/pydantic/pydantic/issues/8208\n        # TODO: improve type safety here\n        if self.mode == 'serialization':\n            if (\n                (ser_schema := schema['schema'].get('serialization', {}))\n                and (ser_func := ser_schema.get('function'))\n                and ser_schema.get('type') == 'function-plain'  # type: ignore\n                and ser_schema.get('info_arg') is False  # type: ignore\n            ):\n        if (\n            self.mode == 'serialization'\n            and (ser_schema := schema['schema'].get('serialization'))\n            and (ser_func := ser_schema.get('function'))\n            and ser_schema.get('type') == 'function-plain'\n            and not ser_schema.get('info_arg')\n            and not (default is None and ser_schema.get('when_used') == 'json-unless-none')\n        ):\n            try:\n                default = ser_func(default)  # type: ignore\n            except Exception:\n                # It might be that the provided default needs to be validated first\n                # (assuming `validate_default` is enabled). However, we can't perform\n                # such validation during JSON Schema generation so we don't support\n                # this pattern for now.\n                # (One example is when using `foo: ByteSize = '1MB'`, which validates and\n                # serializes as an int. In this case, `ser_func` is `int` and `int('1MB')` fails).\n                self.emit_warning(\n                    'non-serializable-default',\n                    f'Unable to serialize value {default!r} with the plain serializer; excluding default from JSON schema',\n                )\n                return json_schema\n```"}, {"role": "assistant", "content": "Could we do something like this?\r\n\r\nhttps://github.com/pydantic/pydantic/blob/0c97049bd40ac95cce7bbebad8369b9426af4b09/pydantic/json_schema.py#L2017-L2044\r\n\r\nI feel like we shouldn't be skipping that logic here, we could maybe call that function?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10121, "url": "https://github.com/pydantic/pydantic/pull/10121#discussion_r1715482568"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tokenization_utils_tokenizers.py`:\n\n```python\n# Optionally patches mistral tokenizers with wrong regex\n        if vocab_size > 100000 and getattr(self._tokenizer, \"pre_tokenizer\", None) is not None:\n            kwargs.pop(\"tokenizer\", None)\n```"}, {"role": "assistant", "content": "We dont need the kwargs in the patch fn, how about we change the signature and remove the **kwargs instead? This was how it was before"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42528, "url": "https://github.com/huggingface/transformers/pull/42528#discussion_r2577882193"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_utils.py`:\n\n```python\nreturn value[1:-1] if value[0] == value[-1] == '\"' else value\n\n\ndef guess_content_type(filename: typing.Optional[str]) -> typing.Optional[str]:\n    if filename:\n        return mimetypes.guess_type(filename)[0] or \"application/octet-stream\"\n    return None\n\n\ndef get_filelike_length(stream: typing.IO) -> int:\n    \"\"\"\n    Given a file-like stream object, efficiently compute and return its length\n    in number of bytes.\n    \"\"\"\n    try:\n        # Is it an actual file?\n        fd = stream.fileno()\n    except OSError:\n        # No... is it something that supports random access, like `io.BytesIO`?\n        if not hasattr(stream, \"seekable\") or not stream.seekable():  # pragma: nocover\n            # Not even that? Sorry, we're doomed...\n            raise\n```"}, {"role": "assistant", "content": "Right, so yeah the content is delimited by the `boundary` markers, so files *without* a content-length header are perfectly okay. Eg in the MDN example here https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition\r\n\r\n```\r\nPOST /test.html HTTP/1.1\r\nHost: example.org\r\nContent-Type: multipart/form-data;boundary=\"boundary\"\r\n\r\n--boundary\r\nContent-Disposition: form-data; name=\"field1\"\r\n\r\nvalue1\r\n--boundary\r\nContent-Disposition: form-data; name=\"field2\"; filename=\"example.txt\"\r\n\r\nvalue2\r\n--boundary--\r\n```\r\n\r\nI *guess* we ought to include the Content-Length where possible, but it's feasible that our policy could alternately be \"let's *not* include the Content-Length\". Perhaps it'd be good to take a steer on that from some prior art. Eg. what does the streaming multipart implementation in the requests toolbelt do?... https://toolbelt.readthedocs.io/en/latest/uploading-data.html#streaming-multipart-data-encoder"}], "_meta": {"repo": "encode/httpx", "pr_number": 857, "url": "https://github.com/encode/httpx/pull/857#discussion_r390201831"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `triggerer_job_runner.py`:\n\n```python\nawait asyncio.sleep(0)\n        return finished_ids\n\n    async def sync_state_to_supervisor(self, finished_ids: list[int]):\n    def validate_state_changes(self, finished_ids: list[int]) -> messages.TriggerStateChanges:\n        # Copy out of our dequeues in threadsafe manner to sync state with parent\n        events_to_send = []\n\n        req_encoder = _new_encoder()\n        events_to_send: list[tuple[int, DiscrimatedTriggerEvent]] = []\n        failures_to_send: list[tuple[int, list[str] | None]] = []\n\n        while self.events:\n            data = self.events.popleft()\n            events_to_send.append(data)\n            trigger_id, trigger_event = self.events.popleft()\n\n            try:\n                req_encoder.encode(trigger_event)\n                events_to_send.append((trigger_id, trigger_event))\n            except NotImplementedError as e:\n                logger.error(\n                    \"Trigger %s returned non-serializable result %r. Cancelling trigger.\",\n                    trigger_id,\n                    trigger_event,\n                )\n                self.failed_triggers.append((trigger_id, e))\n```"}, {"role": "assistant", "content": "Probably best to catch any error.\r\n\r\nThough I don't love the fact that this encodes things twice, throwing the result away once.\r\n\r\n```suggestion\r\n            try:\r\n                req_encoder.encode(trigger_event)\r\n            except Exception as e:\r\n                logger.error(\r\n                    \"Trigger %s returned non-serializable result %r. Cancelling trigger.\",\r\n                    trigger_id,\r\n                    trigger_event,\r\n                )\r\n                self.failed_triggers.append((trigger_id, e))\r\n            else:\r\n                events_to_send.append((trigger_id, trigger_event))\r\n\r\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60152, "url": "https://github.com/apache/airflow/pull/60152#discussion_r2687511128"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `display.py`:\n\n```python\n\"\"\"\n\nimport sys\nimport platform\nfrom pprint import pformat as pformat_\n\n\ndef _colorize(text, colorize=True):\n    if not colorize or not sys.stdout.isatty():\n        return text\n    try:\n        import pygments.util\n        from pygments.formatters import get_formatter_by_name\n        from pygments import highlight\n        from pygments.formatters import TerminalFormatter\n        from pygments.lexers import PythonLexer\n        return highlight(text, PythonLexer(), TerminalFormatter())\n    except ImportError:\n        return text\n\n    if sys.platform == \"win32\" and platform.release() == \"10\":\n        if platform.version() >= \"10.0.14393\":\n```"}, {"role": "assistant", "content": "> * Shouldn\u2019t this be a single `if` statement?\r\n> \r\n> * Is `platform.release() == \"10\"` needed, given `platform.version() >= \"10.0.14393\"`?\r\n\r\nyes, it should be single `if` statement and there is no need for `platform.release( ) == \"10\"`\r\n\r\n>     * Isn\u2019t using `>=` for string comparison problematic here? \r\nIt is problematic. So, now I have used `packaging.version.parse()` for version comparison."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4403, "url": "https://github.com/scrapy/scrapy/pull/4403#discussion_r399152224"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\n@property\n    def defined_constraints(self) -> dict[str, Any]:\n        \"\"\"Fetch a key / value mapping of constraints to values that are not None. Used for core schema updates.\"\"\"\n        return {field.name: getattr(self, field.name) for field in fields(self)}\n        return {field.name: value for field in fields(self) if (value := getattr(self, field.name)) is not None}\n\n    def __get_pydantic_core_schema__(self, source: Any, handler: GetCoreSchemaHandler) -> core_schema.CoreSchema:\n        schema = handler(source)\n\n        if schema['type'] == 'function-wrap':\n            # for function-wrap schemas, url constraints is applied to the inner schema\n            inner = schema['schema']\n\n            if annotated_type := inner['type'] not in ('url', 'multi-host-url'):\n                raise PydanticUserError(\n                    f\"'UrlConstraints' cannot annotate '{annotated_type}'.\", code='invalid-annotated-type'\n                )\n            for constraint_key, constraint_value in self.defined_constraints.items():\n                inner[constraint_key] = constraint_value\n            schema['schema'] = inner\n        else:\n            if annotated_type := schema['type'] not in ('url', 'multi-host-url'):\n                raise PydanticUserError(\n```"}, {"role": "assistant", "content": "There isn't one but I think it would make sense in a world where constraints are wrapping validators which core can occasionally optimize."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10922, "url": "https://github.com/pydantic/pydantic/pull/10922#discussion_r1852419319"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `addons.py`:\n\n```python\nwhich to read the add-on configuration\n        :type settings: :class:`~scrapy.settings.Settings`\n        \"\"\"\n        addons = build_component_list(settings[\"ADDONS\"])\n        for addon in build_component_list(settings[\"ADDONS\"]):\n            self._add(addon, settings)\n        enabled = []\n        for clspath in build_component_list(settings[\"ADDONS\"]):\n            try:\n                addoncls = load_object(clspath)\n                addon = create_instance(\n                    addoncls, settings=settings, crawler=self.crawler\n                )\n                addon.update_settings(settings)\n                self.addons.append(addon)\n            except NotConfigured as e:\n                if e.args:\n                    clsname = (\n                        clspath.split(\".\")[-1] if isinstance(clspath, str) else clspath\n```"}, {"role": "assistant", "content": "I.e. wouldn't it be easier to debug issues if the full path is present?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5950, "url": "https://github.com/scrapy/scrapy/pull/5950#discussion_r1280633350"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_forward_ref.py`:\n\n```python\nfunc_val(a=1)\n\n\n@pytest.mark.xfail(\n    reason='In `GenerateSchema`, only the current class module is taken into account. '\n    'This is similar to `test_uses_the_correct_globals_to_resolve_model_forward_refs`.'\n)\ndef test_uses_the_correct_globals_to_resolve_forward_refs_on_serializers(create_module):\n    # Note: unlike `test_uses_the_correct_globals_to_resolve_model_forward_refs`,\n    # we use the globals of the underlying func to resolve the return type.\n    @create_module\n    def module_1():\n        from pydantic import BaseModel, field_serializer  # or model_serializer\n        from pydantic import BaseModel, field_serializer  # or model_serializer, computed_field\n```"}, {"role": "assistant", "content": "The goal was to mentioned that this also applied to `computed_field`"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10929, "url": "https://github.com/pydantic/pydantic/pull/10929#discussion_r1852556025"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_multipart.py`:\n\n```python\n)\n\n\ndef get_multipart_boundary_from_content_type(\n    content_type: typing.Optional[str],\n) -> typing.Optional[bytes]:\n    if not content_type or not content_type.startswith(\"multipart/form-data\"):\n        return None\n    if \";\" in content_type:\n        for section in content_type.split(\";\"):\n            if section.strip().startswith(\"boundary=\"):\n                return section.strip().split(\"boundary=\")[-1].encode(\"latin-1\")\n```"}, {"role": "assistant", "content": "After reviewing the grammar for boundary (RFC 2046 Appendix A, referencing RFC 2045 \u00a75.1, referencing RFC 822 \u00a73.3 which has been replaced by RFC 5322 \u00a73.2.4):\r\n\r\n1. The only quoting character that seems to be valid is the double quote `\"` (`'` is not valid for that usage);\r\n2. However, when the double quote is in use, any backslash `\\` will be part of a \"quoted pair\", meaning that it is semantically equivalent to the next character (`\\\\` => `\\`, `\\\"` => `\"`);\r\n3. However, there is a limitation on allowed characters in a boundary - none of the characters that would require a quoted pair escape are allowed in a boundary;\r\n\r\nIn other words:\r\n * We need to handle only `\"` for quoting;\r\n * We also need to decide what to do about quoted pairs:\r\n   * Either we write a simpler implementation that does not handle them, as all legal boundaries can be written without using quoted pairs;\r\n   * Or we go the extra mile of supporting quoted pairs;\r\n * What do we want to do about the fact that not all ascii characters are allowed as part of a boundary?"}], "_meta": {"repo": "encode/httpx", "pr_number": 2278, "url": "https://github.com/encode/httpx/pull/2278#discussion_r945285489"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `collection.py`:\n\n```python\nif not dag.timetable.can_be_scheduled:\n            return cls(None, 0)\n\n        latest_run = session.scalar(_get_latest_runs_stmt(dag_id=dag.dag_id))\n        if isinstance(  # todo: AIP-76 what's a more general way to detect?\n```"}, {"role": "assistant", "content": "i actually figured out, i think, a way where we don't need an attribute"}], "_meta": {"repo": "apache/airflow", "pr_number": 59115, "url": "https://github.com/apache/airflow/pull/59115#discussion_r2710419442"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\nreturn schema\n\n\nclass _BaseMultiHostUrl(MultiHostUrl):\nclass _BaseMultiHostUrl:\n    _constraints: ClassVar[UrlConstraints] = UrlConstraints()\n    _url: _CoreMultiHostUrl\n\n    @cached_property\n    def _validator(self) -> TypeAdapter:\n        return TypeAdapter(self.__class__)\n```"}, {"role": "assistant", "content": "It feels like it could be both simpler and more efficient if here this `TypeAdapter` just built the underlying rust `Url`, with appropriate constraints? Is there a reason why that might be problematic for subclasses? \ud83e\udd14"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10766, "url": "https://github.com/pydantic/pydantic/pull/10766#discussion_r1829698083"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `mxfp4.py`:\n\n```python\nelse:\n            blocks = blocks.reshape(local_experts, -1, module.intermediate_size // 2)\n        if getattr(target_device, \"type\", target_device) == \"cpu\":\n            target_device = \"cuda\"\n            target_device = torch.accelerator.current_accelerator().type if hasattr(torch, \"accelerator\") else \"cuda\"\n```"}, {"role": "assistant", "content": "if  can OK this, not familiar w/ different accelerators"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41830, "url": "https://github.com/huggingface/transformers/pull/41830#discussion_r2502725681"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\nreturn isinstance(v, (list, tuple, set, frozenset, GeneratorType, deque))\n\n\ndef validate_field_name(bases: List[Type['BaseModel']], field_name: str) -> None:\ndef validate_field_name(bases: Iterable[Type[Any]], field_name: str) -> None:\n```"}, {"role": "assistant", "content": "`validate_field_name` is called from `ModelMetaclass.__new__`, where `bases` is a tuple. This caused an Cython error as in 3.x it is able to understand and check type annotations using `list`. This turns out being not necessary I believe because I disabled the `annotation_typing` directive as I was getting more errors, but still good to have the annotation fixed anyway."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10847, "url": "https://github.com/pydantic/pydantic/pull/10847#discussion_r1879707569"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_requests.py`:\n\n```python\n{'stuff': 'elixr'.encode('utf-8')},\n        ))\n    def test_unicode_multipart_post(self, httpbin, data):\n        r = requests.post(httpbin('post'),\n            data=data,\n            files={'file': ('test_requests.py', open(__file__, 'rb'))})\n        assert r.status_code == 200\n        with open(__file__, 'rb') as f:\n            r = requests.post(httpbin('post'),\n                data=data,\n                files={'file': ('test_requests.py', f)})\n            assert r.status_code == 200\n\n    def test_unicode_multipart_post_fieldnames(self, httpbin):\n        filename = os.path.splitext(__file__)[0] + '.py'\n        r = requests.Request(\n            method='POST', url=httpbin('post'),\n            data={'stuff'.encode('utf-8'): 'elixr'},\n            files={'file': ('test_requests.py', open(filename, 'rb'))})\n        prep = r.prepare()\n        assert b'name=\"stuff\"' in prep.body\n        assert b'name=\"b\\'stuff\\'\"' not in prep.body\n        with open(filename, 'rb') as f:\n            r = requests.Request(\n                method='POST', url=httpbin('post'),\n                data={'stuff'.encode('utf-8'): 'elixr'},\n                files={'file': ('test_requests.py', f)})\n            prep = r.prepare()\n            assert b'name=\"stuff\"' in prep.body\n```"}, {"role": "assistant", "content": "These asserts can be done at the same indentation as the `with` block."}], "_meta": {"repo": "psf/requests", "pr_number": 4766, "url": "https://github.com/psf/requests/pull/4766#discussion_r221472224"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `reactorless.py`:\n\n```python\nfrom __future__ import annotations\n\nimport sys\nfrom importlib.abc import MetaPathFinder\nfrom typing import TYPE_CHECKING\n\nfrom scrapy.utils.asyncio import is_asyncio_available\nfrom scrapy.utils.reactor import is_reactor_installed\n\nif TYPE_CHECKING:\n    from collections.abc import Sequence\n    from importlib.machinery import ModuleSpec\n    from types import ModuleType\n\n\ndef is_reactorless() -> bool:\n    \"\"\"Check if we are running in the reactorless mode, i.e. with ``TWISTED_ENABLED=False``.\n\n    As this checks the runtime state and not the setting itself, it can be\n    wrong when executed very early, before the reactor and/or the asyncio event\n    loop are initiliazed.\n\n    .. versionadded:: VERSION\n    \"\"\"\n    return is_asyncio_available() and not is_reactor_installed()\n\n\nclass ReactorImportHook(MetaPathFinder):\n    \"\"\"Hook that prevents importing :mod:`twisted.internet.reactor`.\"\"\"\n\n    def find_spec(\n        self,\n        fullname: str,\n        path: Sequence[str] | None,\n        target: ModuleType | None = None,\n    ) -> ModuleSpec | None:\n        if fullname == \"twisted.internet.reactor\":\n            raise ImportError(\n                f\"Import of {fullname} is forbidden in the reactorless mode, to avoid silent problems.\"\n```"}, {"role": "assistant", "content": "The error message should be more specific about what kind of \"silent problems\" could occur. Consider clarifying that importing the reactor module could lead to unexpected behavior when running without a Twisted reactor.\n```suggestion\n                f\"Import of {fullname} is forbidden in the reactorless mode, \"\n                \"because importing the Twisted reactor when running without a Twisted \"\n                \"reactor can lead to unexpected behavior.\"\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7199, "url": "https://github.com/scrapy/scrapy/pull/7199#discussion_r2665791342"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deadline.py`:\n\n```python\nREFERENCE = \"reference\"\n    INTERVAL = \"interval\"\n    CALLBACK = \"callback\"\n```"}, {"role": "assistant", "content": "That's that yes, its mostly copypasta from the older models but with some renaming. You can just skim this one through, no need to check in great detail"}], "_meta": {"repo": "apache/airflow", "pr_number": 61118, "url": "https://github.com/apache/airflow/pull/61118#discussion_r2735024339"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_gpt_bigcode.py`:\n\n```python\ndef forward(\n        self,\n        hidden_states: Optional[tuple[torch.Tensor]],\n        encoder_hidden_states: Optional[torch.Tensor] = None,\n        layer_past: Optional[Cache] = None,\n        attention_mask: Optional[torch.Tensor] = None,\n        encoder_hidden_states: Optional[torch.Tensor] = None,\n```"}, {"role": "assistant", "content": "I mean that the signature should stay the same, e.g. see https://github.com/huggingface/transformers/blob/84d19be41e0131e6f2a660fe6af8b77094906af7/src/transformers/models/gpt_bigcode/modeling_gpt_bigcode.py#L586-L596\r\n\r\nIt will need to adjust the calls from the module above like https://github.com/huggingface/transformers/blob/84d19be41e0131e6f2a660fe6af8b77094906af7/src/transformers/models/gpt_bigcode/modeling_gpt_bigcode.py#L901-L910\r\n\r\nChanging the signature is breaking a bit too much!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41818, "url": "https://github.com/huggingface/transformers/pull/41818#discussion_r2461668784"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\ndef get_total_train_batch_size(self, args) -> int:\n        \"\"\"Calculates total batch size (micro_batch * grad_accum * dp_world_size).\n\n        Note: Only considers DP and TP (dp_world_size = world_size // tp_size).\"\"\"\n        dp_world_size = args.world_size // self.get_tp_size()\n        Note: Only considers DP and TP and SP/CP (dp_world_size = world_size // tp_size // cp_size // sp_size).\n\n        Though do note that DP_world_size isn't args.world_size // self.get_sp_size, since SP ranks reuse DP ranks, so the variable below is misleading.\n        \"\"\"\n\n        dp_world_size = args.world_size // self.get_tp_size() // self.get_cp_size() // self.get_sp_size\n```"}, {"role": "assistant", "content": "```suggestion\n        dp_world_size = args.world_size // self.get_tp_size() // self.get_cp_size() // self.get_sp_size()\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41832, "url": "https://github.com/huggingface/transformers/pull/41832#discussion_r2539220371"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `log.py`:\n\n```python\nand adapts it into a tuple of positional arguments for logger.log calls,\n    handling backward compatibility as well.\n    \"\"\"\n    if not {\"level\", \"msg\", \"args\"} <= set(logkws):\n        warnings.warn(\"Missing keys in LogFormatter method\", ScrapyDeprecationWarning)\n\n    if \"format\" in logkws:\n        warnings.warn(\n            \"`format` key in LogFormatter methods has been \"\n            \"deprecated, use `msg` instead\",\n            ScrapyDeprecationWarning,\n        )\n\n    level = logkws.get(\"level\", logging.INFO)\n    message = logkws.get(\"format\", logkws.get(\"msg\"))\n    message = str(logkws.get(\"msg\"))\n```"}, {"role": "assistant", "content": "> `logkws.get(\"msg\", \"\")` is fine I think.\r\n\r\nOnly if `msg` is missing from the dict, not if it exists as `None`, which mypy probably considers a possibility.\r\n\r\nIf it _could_ exist as `None` (e.g. it the user made a mistake), `logkws.get(\"msg\") or \"\"` should work. Otherwise, what  said, and `assert message is not None` after the line should silence mypy about the impossible scenario of `logkws` containing `{\"msg\": None}`."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6116, "url": "https://github.com/scrapy/scrapy/pull/6116#discussion_r1365077351"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `version.py`:\n\n```python\nreturn '\\n'.join('{:>30} {}'.format(k + ':', str(v).replace('\\n', ' ')) for k, v in info.items())\n\n\ndef check_pydantic_core_version() -> bool:\n    \"\"\"Check that the installed `pydantic-core` dependency is compatible.\"\"\"\n    return version('pydantic_core') == '2.27.2'\n```"}, {"role": "assistant", "content": "Does pydantic_core offer a `__version__` attribute? If so we should use that."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11324, "url": "https://github.com/pydantic/pydantic/pull/11324#discussion_r1928225249"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `typing.py`:\n\n```python\n# TypeError: ForwardRef._evaluate() missing 1 required keyword-only argument: 'recursive_guard'\n        return cast(Any, type_)._evaluate(globalns, localns, recursive_guard=set())\n\nelse:\n\n    def evaluate_forwardref(type_: ForwardRef, globalns: Any, localns: Any) -> Any:\n        # Pydantic 1.x will not support PEP 695 syntax, but provide `type_params` to avoid\n        # warnings:\n        return cast(Any, type_)._evaluate(globalns, localns, type_params=(), recursive_guard=set())\n```"}, {"role": "assistant", "content": "Seems this block has introduced a regression for some python3.12 versions https://github.com/pydantic/pydantic/issues/11230"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10847, "url": "https://github.com/pydantic/pydantic/pull/10847#discussion_r1906086954"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_ernie4_5_vl_moe.py`:\n\n```python\n# coding=utf-8\n# Copyright 2025 Baidu and HuggingFace Inc. team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nimport math\nfrom typing import Optional, Union\n\nimport numpy as np\n\nfrom ...image_processing_utils import BaseImageProcessor, BatchFeature\nfrom ...image_transforms import convert_to_rgb, resize, to_channel_dimension_format\nfrom ...image_utils import (\n    OPENAI_CLIP_MEAN,\n    OPENAI_CLIP_STD,\n    ChannelDimension,\n    ImageInput,\n    PILImageResampling,\n    get_image_size,\n    infer_channel_dimension_format,\n    is_scaled_image,\n    make_flat_list_of_images,\n    make_list_of_images,\n    to_numpy_array,\n    valid_images,\n    validate_preprocess_arguments,\n)\nfrom ...processing_utils import ImagesKwargs\nfrom ...utils import TensorType, logging\n\n\nlogger = logging.get_logger(__name__)\n\n\nclass Ernie4_5_VLImageProcessorKwargs(ImagesKwargs, total=False):\n    r\"\"\"\n    patch_size (`int`, *optional*, defaults to 14):\n        The spatial patch size of the vision encoder.\n    merge_size (`int`, *optional*, defaults to 2):\n        The merge size of the vision encoder to llm encoder.\n    \"\"\"\n\n    patch_size: int\n    merge_size: int\n\n\ndef smart_resize(\n```"}, {"role": "assistant", "content": "Ok using modular now, will update later today for all review comments"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39585, "url": "https://github.com/huggingface/transformers/pull/39585#discussion_r2599820395"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `context_managers_39.py`:\n\n```python\n# don't remove the brackets here, it changes the meaning of the code.\nwith (x, y) as z:\n    pass\n\n\n# don't remove the brackets here, it changes the meaning of the code.\n# even tough the code will always trigger a runtime error\n```"}, {"role": "assistant", "content": "```suggestion\r\n# even though the code will always trigger a runtime error\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 4646, "url": "https://github.com/psf/black/pull/4646#discussion_r2034396806"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `fields.py`:\n\n```python\nReturns:\n            An instance of the field metadata.\n        \"\"\"\n        final = False\n        if _typing_extra.is_finalvar(annotation):\n            final = True\n            if annotation is not typing_extensions.Final:\n        # 1. Check if the annotation is the `Final` type qualifier:\n        final = _typing_extra.is_finalvar(annotation)\n        if final:\n            if _typing_extra.is_generic_alias(annotation):\n                # The annotation is a parametrized `Final`, e.g. `Final[int]`.\n```"}, {"role": "assistant", "content": "Maybe prefix with 1.1, like you've done below for #3? And same for else block below"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11109, "url": "https://github.com/pydantic/pydantic/pull/11109#discussion_r1894506448"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n:param default: the value to return if no setting is found\n        :type default: object\n        \"\"\"\n        if name == \"CONCURRENT_REQUESTS_PER_IP\" and (self[name] or default) != 0:\n```"}, {"role": "assistant", "content": "> also the calls of `CONCURRENT_REQUESTS_PER_IP` setting use getint method that makes the default be 0\r\n\r\nThat is a good point, but I think we should assume this (or more importantly, future settings we might deprecate this way) may also be read with a more generic getter, i.e. `get()` or `[]`, besides their type-specific getter."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6921, "url": "https://github.com/scrapy/scrapy/pull/6921#discussion_r2174842325"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `canvas.py`:\n\n```python\nheaders (Dict): Stamps that should be added to headers.\n        \"\"\"\n        self.stamp_links(visitor, **headers)\n\n        headers = headers.copy()\n        headers = deepcopy(headers)\n        visitor_headers = None\n        if visitor is not None:\n            visitor_headers = visitor.on_signature(self, **headers)\n            visitor_headers = visitor.on_signature(self, **headers) or {}\n        headers = self._stamp_headers(visitor_headers, **headers)\n        return self.set(**headers)\n\n    def _stamp_headers(self, visitor_headers=None, **headers):\n        headers = deepcopy(headers)\n        if visitor_headers is not None:\n            visitor_headers = visitor_headers or {}\n            if \"stamped_headers\" not in visitor_headers:\n                visitor_headers[\"stamped_headers\"] = list(visitor_headers.keys())\n            _merge_dictionaries(headers, visitor_headers)\n            _merge_dictionaries(headers, visitor_headers, aggregate_duplicates=False)\n            headers[\"stamped_headers\"] = list(set(headers[\"stamped_headers\"]))\n        else:\n            headers[\"stamped_headers\"] = [header for header in headers.keys() if header not in self.options]\n            _merge_dictionaries(headers, self.options)\n            stamped_headers = [\n                header for header in headers.keys()\n                if all([\n                    header != \"stamped_headers\",\n                    header in self.options.get(\"stamped_headers\", [])\n                ])\n            ]\n            if \"stamped_headers\" in headers:\n                headers[\"stamped_headers\"].extend(stamped_headers)\n            else:\n                headers[\"stamped_headers\"] = stamped_headers\n            for stamp in headers.keys():\n                if stamp != \"stamped_headers\" and stamp not in headers[\"stamped_headers\"]:\n                    headers[\"stamped_headers\"].append(stamp)\n            headers[\"stamped_headers\"] = list(set(headers[\"stamped_headers\"]))\n            _merge_dictionaries(headers, self.options, aggregate_duplicates=False)\n\n        # Preserve previous stamped headers\n        stamped_headers = set(self.options.get(\"stamped_headers\", []))\n        stamped_headers.update(headers[\"stamped_headers\"])\n        stamped_headers.update(headers.get(\"stamped_headers\", []))\n        headers[\"stamped_headers\"] = list(stamped_headers)\n        return self.set(**headers)\n        for previous_header in stamped_headers:\n            if previous_header not in headers and previous_header in self.options:\n                headers[previous_header] = self.options[previous_header]\n        return headers\n```"}, {"role": "assistant", "content": "> I guess your comment should explain what happens during replacing that requires us to always set all stamped headers even if they were not touched by the visitor or by the kwargs.\r\n\r\nTBH I don't know. The new test cases are checking so many new edge cases that in the case of stamping with task replacement, this happened.\r\n\r\nIt is not perfect but it will require a lot of time investigating it just for the comment whereas the feature is still not completed, so if it's acceptable, I'd prefer to leave this code with the comment referencing the replace, but not investigate more at the moment as its too expensive for the sake of having a more detailed comment."}], "_meta": {"repo": "celery/celery", "pr_number": 8045, "url": "https://github.com/celery/celery/pull/8045#discussion_r1098868959"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crawler.py`:\n\n```python\nassert self.engine\n            yield maybeDeferred(self.engine.stop)\n\n    @staticmethod\n    def _get_component(component_class, components):\n        for component in components:\n            if (\n                type(component)  # pylint: disable=unidiomatic-typecheck\n                is component_class\n```"}, {"role": "assistant", "content": "The use case for isinstance: there is e.g. a middleware (Scrapy built-in, or provided by some package). Some other object (could be e.g. some extension) uses a components getter to find the middleware, and read some information from it. Then, to change the behavior of the middleware, user makes a subclass, disables the original middleware, and enables the new one. \r\n\r\nThe question is: should the extension keep reading the information from the new middleware, or should it behave as is there is no middeware available anymore? \r\n\r\nIt seems there are arguments for both. For me it looks like using a subclass is better, because subclass is expected to keep the features of the base class, and extend it. So, +0.5 to do isinstance."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6181, "url": "https://github.com/scrapy/scrapy/pull/6181#discussion_r1434129374"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_validators.py`:\n\n```python\n)\n        return x\n    except TypeError:\n        if isinstance(x, pathlib.PurePath):\n            try:\n                if not (len(str(x)) >= min_length):\n                    raise PydanticKnownError(\n                        'too_short', {'field_type': 'Value', 'min_length': min_length, 'actual_length': len(str(x))}\n                    )\n                return x\n            except TypeError:\n                ...\n```"}, {"role": "assistant", "content": "```suggestion\r\n                pass\r\n```\r\n\r\nThe ellipsis is best used for stub definitions"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10846, "url": "https://github.com/pydantic/pydantic/pull/10846#discussion_r1846624559"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\n# We don't want to normalize relative URLs, since doing so\n                # removes any leading `../` portion.\n                self._uri_reference = self._uri_reference.normalize()\n        else:\n        elif isinstance(url, URL):\n            self._uri_reference = url._uri_reference\n        else:\n            raise TypeError(\"Invalid type for url.  Expected str or httpx.URL\")\n```"}, {"role": "assistant", "content": "(Nit) Consider showing the received type of `url`\r\n\r\n```suggestion\r\n            raise TypeError(f\"Expected url to be an str or httpx.URL, got {type(url)}\")\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1259, "url": "https://github.com/encode/httpx/pull/1259#discussion_r483835011"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_processing_siglip2.py`:\n\n```python\n# Copyright 2025 The HuggingFace Team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\nimport unittest\n\nimport torch\n\nfrom transformers import AutoProcessor, Siglip2Tokenizer\nfrom transformers.testing_utils import require_tokenizers, require_torch, slow\n\n\n@require_torch\n@require_tokenizers\n@slow\nclass Siglip2ProcessorTest(unittest.TestCase):\n    def test_siglip2_text_defaults_padding_to_64(self):\n        processor = AutoProcessor.from_pretrained(\"google/siglip2-so400m-patch14-384\")\n        inputs = processor(text=[\"hello world\"], return_tensors=\"pt\")\n        self.assertEqual(inputs[\"input_ids\"].shape[1], 64)\n\n    def test_siglip2_text_is_lowercased(self):\n        processor = AutoProcessor.from_pretrained(\"google/siglip2-so400m-patch14-384\")\n        a = processor(text=[\"HELLO WORLD\"], return_tensors=\"pt\")\n        b = processor(text=[\"hello world\"], return_tensors=\"pt\")\n        self.assertTrue(torch.equal(a[\"input_ids\"], b[\"input_ids\"]))\n\n\n@require_torch\n@require_tokenizers\n@slow\nclass Siglip2TokenizerTest(unittest.TestCase):\n    def test_lowercasing_and_padding_defaults(self):\n```"}, {"role": "assistant", "content": "same, not slow and inherit from `TokenizerTesterMixin` to get common tests. Also tokenizer tests are usually in their own separate file"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43101, "url": "https://github.com/huggingface/transformers/pull/43101#discussion_r2675553480"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_api.py`:\n\n```python\nproxy: ProxyTypes | None = None,\n    timeout: TimeoutTypes = DEFAULT_TIMEOUT_CONFIG,\n    follow_redirects: bool = False,\n    verify: VerifyTypes = True,\n    cert: CertTypes | None = None,\n    ssl_context: typing.Optional[ssl.SSLContext] = None,\n```"}, {"role": "assistant", "content": "```suggestion\r\n    ssl_context: ssl.SSLContext | None = None,\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 3022, "url": "https://github.com/encode/httpx/pull/3022#discussion_r1790226408"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `packages.py`:\n\n```python\ntarget = chardet.__name__\nfor mod in list(sys.modules):\n    if mod == target or mod.startswith(f\"{target}.\"):\n        target = target.replace(target, \"chardet\")\n```"}, {"role": "assistant", "content": "Got it, but still the for loop seems necessary. It'll just be mapping the last package of chardet modules to chardet package of requests. \r\n\r\nIf that is the expected behaviour then we can just assign the last package without running the for loop."}], "_meta": {"repo": "psf/requests", "pr_number": 6562, "url": "https://github.com/psf/requests/pull/6562#discussion_r1377593896"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_cache_utils.py`:\n\n```python\npast_key_values=past_key_values_eager,\n            use_cache=True,\n        )\n        self.assertTrue(torch.allclose(res.logits, res_eager.logits))\n        self.assertTrue(torch.allclose(res.logits, res_eager.logits, atol=1e-3))\n```"}, {"role": "assistant", "content": "The atol seems a bit high, can we reduce it, e.g. `1e-5`? It's basically the difference between using the kwarg or manually repeating :eyes:"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39412, "url": "https://github.com/huggingface/transformers/pull/39412#discussion_r2216667832"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `gcs.py`:\n\n```python\n'gcs_base_path': url_parts.path,\n            **url_parts.query,\n        }\n\n\nclass GCSBackend(GCSBackendBase):\n    \"\"\"Google Cloud Storage task result backend.\n\n    Uses Firestore for chord ref count.\n    \"\"\"\n\n    implements_incr = True\n    supports_native_join = True\n\n    # Firestore parameters\n    _collection_name = 'celery'\n    _field_count = 'chord_count'\n    _field_expires = 'expires_at'\n\n    def __init__(self, **kwargs):\n        if not (firestore and firestore_admin_v1):\n            raise ImproperlyConfigured(\n                'You must install google-cloud-firestore to use gcs backend'\n            )\n        super().__init__(**kwargs)\n\n        self._firestore_lock = RLock()\n        self._firestore_client = None\n\n        self.firestore_project = self.app.conf.get(\n            'firestore_project', self.project\n        )\n        if not self._is_firestore_ttl_policy_enabled():\n```"}, {"role": "assistant", "content": "this is a Firestore TTL,  not the GCS ttl. If it won't be set - then all chord ref keys will remain and not cleaned up. \r\nthe `ttl` is for the GCS results to expire. See my prev. comment re the native chord implementation"}], "_meta": {"repo": "celery/celery", "pr_number": 9302, "url": "https://github.com/celery/celery/pull/9302#discussion_r2058848553"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `stream.py`:\n\n```python\nfrom twisted.internet.error import ConnectionClosed\nfrom twisted.python.failure import Failure\nfrom twisted.web.client import ResponseFailed\nfrom typing import Dict\nfrom typing import List, Optional, Tuple, TYPE_CHECKING\n```"}, {"role": "assistant", "content": "And it should definitely not be split into 2 lines :slightly_smiling_face:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r478350996"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scraper.py`:\n\n```python\nif isinstance(output, Failure):\n            ex = output.value\n            if isinstance(ex, DropItem):\n                if ex.log_level is None:\n                    ex.log_level = spider.crawler.settings.get(\n                        \"DEFAULT_DROPITEM_LOG_LEVEL\", \"WARNING\"\n                    )\n                else:\n                    ex.log_level = ex.log_level.upper()\n```"}, {"role": "assistant", "content": "If I remove `severity = getattr(logging, log_level.upper())` and set `\"level\": log_level`, then one of my test cases called `test_log_formatter()` fails.\r\n\r\nAlso, I realized that `.upper()` in `severity = getattr(logging, log_level.upper())` is unnecessary so it can be removed and the test cases still pass."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6608, "url": "https://github.com/scrapy/scrapy/pull/6608#discussion_r1913104668"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\nleaves.insert(i + 1, new_comma)\n                    break\n\n    leaves_to_track: Set[LeafID] = set()\n    if (\n        Preview.handle_trailing_commas_in_head in original.mode\n        and component == _BracketSplitComponent.head\n```"}, {"role": "assistant", "content": "```suggestion\r\n        and component is _BracketSplitComponent.head\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 3370, "url": "https://github.com/psf/black/pull/3370#discussion_r1016849625"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pyramid_celery_app.py`:\n\n```python\nfrom unittest.mock import MagicMock, Mock\n\nfrom click import Option\n\nfrom celery import Celery\n\n# This module defines a mocked Celery application to replicate\n# the behavior of Pyramid-Celery's configuration by preload options.\n# Preload options should propagate to commands like shell and purge etc.\n#\n# The Pyramid-Celery project https://github.com/sontek/pyramid_celery\n# assumes that you want to configure Celery via an ini settings file.\n# The .ini files are the standard configuration file for Pyramid\n# applications.\n# See https://docs.pylonsproject.org/projects/pyramid/en/latest/quick_tutorial/ini.html\n#\n\napp = Celery(set_as_current=False)\napp.config_from_object(\"t.integration.test_worker_config\")\n\nclass PurgeMock:\n    def queue_purge(self, queue):\n        return 0\n\nclass ConnMock:\n    default_channel = PurgeMock()\n    channel_errors = KeyError\n\nmock = Mock()\nmock.__enter__ = Mock(return_value=ConnMock())\nmock.__exit__ = Mock(return_value=False)\n\napp.connection_for_write = MagicMock(return_value=mock)\n```"}, {"role": "assistant", "content": "I use this Mock to prevent hanging of execution and get immediate return during the test. If there is a more standard way to mock the purge functionality in the context of tests let me know."}], "_meta": {"repo": "celery/celery", "pr_number": 8374, "url": "https://github.com/celery/celery/pull/8374#discussion_r1264041812"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_engine.py`:\n\n```python\nself.assertEqual(len(e.open_spiders), 0)\n\n\nclass CancelledRequestEngineTest(EngineTest):\n\n    @defer.inlineCallbacks\n    def test_crawler(self):\n        for spider in TestSpider, DictItemsSpider:\n            self.run = CancelledRequestCrawlerRun(spider)\n            with LogCapture() as log:\n                yield self.run.run()\n                log.check_present((\"scrapy.core.downloader.handlers.http11\",\n                                   \"DEBUG\",\n                                   \"Cancelled request <GET http://localhost:{}/redirected> from signal handler\"\n                                   \" CancelledRequestCrawlerRun.bytes_received\".format(self.run.portno)))\n                log.check_present((\"scrapy.core.downloader.handlers.http11\",\n                                   \"DEBUG\",\n                                   \"Cancelled request <GET http://localhost:{}/> from signal handler\"\n                                   \" CancelledRequestCrawlerRun.bytes_received\".format(self.run.portno)))\n                log.check_present((\"scrapy.core.downloader.handlers.http11\",\n                                   \"DEBUG\",\n                                   \"Cancelled request <GET http://localhost:{}/numbers> from signal handler\"\n                                   \" CancelledRequestCrawlerRun.bytes_received\".format(self.run.portno)))\n            self._assert_visited_urls()\n            self._assert_scheduled_requests(urls_to_visit=9)\n            self._assert_downloaded_responses()\n            self._assert_signals_caught()\n            self._assert_bytes_received()\n\n    def _assert_bytes_received(self):\n        self.assertEqual(9, len(self.run.bytes))\n        for request, data in self.run.bytes.items():\n            joined_data = b\"\".join(data)\n            self.assertTrue(len(data) == 1)  # signal was fired only once\n            if self.run.getpath(request.url) == \"/numbers\":\n                self.assertTrue(len(data) == 1)  # signal was fired only once\n```"}, {"role": "assistant", "content": "This seems redundant, given the line two lines above."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4559, "url": "https://github.com/scrapy/scrapy/pull/4559#discussion_r423951978"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `npu_flash_attention.py`:\n\n```python\nelse:\n        attn_mask_npu = get_attn_mask_npu(q.device)\n        head_num = q.shape[1]\n        output = npu_fusion_attention(\n        output = torch_npu.npu_fusion_attention(\n```"}, {"role": "assistant", "content": "Yeap, `torch_npu.npu_fusion_attention` api is the way to use FA2 on Ascend NPU."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40151, "url": "https://github.com/huggingface/transformers/pull/40151#discussion_r2276246364"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_glm_image.py`:\n\n```python\ndef __init__(\n        self,\n        vocab_size: int | None = 168064,\n        vision_vocab_size: int | None = 16512,\n        attention_bias: bool | None = True,\n        vocab_size: int = 168064,\n        max_position_embeddings: int = 131072,\n        vision_vocab_size: int = 16512,\n        attention_bias: bool = True,\n        pad_token_id: int = 167841,\n        eos_token_id: int = 16385,\n        **super_kwargs,\n    ):\n        self.vocab_size = vocab_size\n        super().__init__(\n            vocab_size=vocab_size,\n            max_position_embeddings=max_position_embeddings,\n            pad_token_id=pad_token_id,\n            **super_kwargs,\n        )\n        self.vision_vocab_size = vision_vocab_size\n        self.attention_bias = attention_bias\n        super().__init__(ignore_keys_at_rope_validation={\"mrope_section\"}, **super_kwargs)\n        self.eos_token_id = eos_token_id\n\n    @property\n    def mrope_section(self) -> list[int]:\n        \"\"\"Return mrope_section from rope_parameters for vLLM MROPE detection.\"\"\"\n        if self.rope_parameters is not None:\n            return self.rope_parameters.get(\"mrope_section\", [8, 12, 12])\n        return [8, 12, 12]\n```"}, {"role": "assistant", "content": "not sure about this one. We are always storing all rope params in `self.rope_parameters` so if `mrope_section1`has a default value, it needs to be set in the config's `__init__`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43342, "url": "https://github.com/huggingface/transformers/pull/43342#discussion_r2741088438"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_nanochat.py`:\n\n```python\n# coding=utf-8\n# Copyright 2025 The HuggingFace Inc. team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\nimport math\nfrom collections.abc import Callable\nfrom typing import Optional, Union\n\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\n\nfrom ...cache_utils import Cache, DynamicCache\nfrom ...generation import GenerationMixin\nfrom ...masking_utils import create_causal_mask\nfrom ...modeling_layers import GradientCheckpointingLayer\nfrom ...modeling_outputs import BaseModelOutputWithPast, CausalLMOutputWithPast\nfrom ...modeling_utils import ALL_ATTENTION_FUNCTIONS, PreTrainedModel\nfrom ...processing_utils import Unpack\nfrom ...utils import TransformersKwargs, auto_docstring, logging\nfrom .configuration_nanochat import NanoChatConfig\n\n\nlogger = logging.get_logger(__name__)\n\n\ndef _apply_rotary_pos_emb(\n    query: torch.Tensor,\n    key: torch.Tensor,\n    cos: torch.Tensor,\n    sin: torch.Tensor,\n) -> tuple[torch.Tensor, torch.Tensor]:\n    \"\"\"Custom implementation of Rotary Position Embedding.\n    Copied from [nanochat](https://github.com/karpathy/nanochat/blob/4346536ab2e57917ec543b20e88c4bdc47eda572/nanochat/gpt.py#L41)\n    and modified to work with the shape of the query and key tensors.\n\n    Args:\n        query: Query tensor of shape [batch, seq_len, num_heads, head_dim]\n        key: Key tensor of shape [batch, seq_len, num_kv_heads, head_dim]\n        cos: Cosine part of the rotary embedding of shape [1, seq_len, 1, head_dim//2]\n        sin: Sine part of the rotary embedding of shape [1, seq_len, 1, head_dim//2]\n\n    Returns:\n        Tuple of rotated query and key tensors of shape [batch, seq_len, num_heads, head_dim] and [batch, seq_len, num_kv_heads, head_dim]\n    \"\"\"\n    # Expects query/key as [B, T, H, D] and cos/sin as [1, T, 1, D//2]\n    d = query.shape[3] // 2\n    q1, q2 = query[..., :d], query[..., d:]\n    k1, k2 = key[..., :d], key[..., d:]\n```"}, {"role": "assistant", "content": "The same as https://github.com/huggingface/transformers/blob/fe11cbb808b4301399240e40c5cb6cca9bb00d4d/src/transformers/models/llama/modeling_llama.py#L111-L112"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41634, "url": "https://github.com/huggingface/transformers/pull/41634#discussion_r2436718099"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\n`report` is where output about exclusions goes.\n    \"\"\"\n\n    def is_ignored(\n```"}, {"role": "assistant", "content": "Doesn't seem like this needs to be a nested function."}], "_meta": {"repo": "psf/black", "pr_number": 3338, "url": "https://github.com/psf/black/pull/3338#discussion_r1005120876"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_black.py`:\n\n```python\nos.unlink(tmp_file)\n        self.assertFormatEqual(expected, actual)\n\n    @patch(\"black.dump_to_file\", dump_to_stderr)\n    def test_one_empty_line(self) -> None:\n        for nl in [\"\\n\", \"\\r\\n\"]:\n            source = expected = nl\n            actual = fs(source)\n            self.assertFormatEqual(expected, actual)\n            black.assert_equivalent(source, actual)\n            black.assert_stable(source, actual, DEFAULT_MODE)\n\n    def test_one_empty_line_ff(self) -> None:\n        for nl in [\"\\n\", \"\\r\\n\"]:\n            expected = nl\n            tmp_file = Path(black.dump_to_file(nl))\n            try:\n                self.assertFalse(ff(tmp_file, write_back=black.WriteBack.YES))\n                with open(tmp_file, \"rb\") as f:\n                    actual = f.read().decode(\"utf8\")\n            finally:\n                os.unlink(tmp_file)\n            self.assertFormatEqual(expected, actual)\n```"}, {"role": "assistant", "content": "Patched the test by explicitly rewriting the temporary file in binary mode on Windows only:\r\n\r\n```diff\r\ndiff --git a/tests/test_black.py b/tests/test_black.py\r\nindex b49830f..9ae17af 100644\r\n--- a/tests/test_black.py\r\n+++ b/tests/test_black.py\r\n@@ -167,6 +167,12 @@ class BlackTestCase(BlackBaseTestCase):\r\n         for nl in [\"\\n\", \"\\r\\n\"]:\r\n             expected = nl\r\n             tmp_file = Path(black.dump_to_file(nl))\r\n+            if system() == \"Windows\":\r\n+                # Writing files in text mode automatically uses the system newline,\r\n+                # but in this case we don't want this for testing reasons. See:\r\n+                # https://github.com/psf/black/pull/3348\r\n+                with open(tmp_file, \"wb\") as f:\r\n+                    f.write(nl.encode(\"utf-8\"))\r\n             try:\r\n                 self.assertFalse(ff(tmp_file, write_back=black.WriteBack.YES))\r\n                 with open(tmp_file, \"rb\") as f:\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 3348, "url": "https://github.com/psf/black/pull/3348#discussion_r1003705066"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_omdet_turbo.py`:\n\n```python\nspatial_shapes=None,\n        spatial_shapes_list=None,\n        level_start_index=None,\n        output_attentions: bool = False,\n    ):\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> tuple[torch.Tensor, torch.Tensor]:\n```"}, {"role": "assistant", "content": "for later but IIRC tuples in this situation are annoyances for torch gradient chgeckpointing, to keep in mind"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2685877044"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cache_manager.py`:\n\n```python\nself._uninit_block_ids.append(id_to_uninitialize)\n        return True\n\n    def get_free_blocks(self, n_blocks: int, last_block_id: int | None) -> list[int] | None:\n        \"\"\"Returns a list of (n_blocks) free block and mark them as no longuer free in the internal data structures. One\n        can also pass a (last_block_id) to indicate the last block id in the sequence, which is used to keep track of\n        the parent block. If the manager cannot find enough free blocks, it returns None.\"\"\"\n    def get_free_blocks(\n        self, n_blocks: int, last_block_id: int | None, shareable: bool, group_id: int\n    ) -> list[int] | None:\n        \"\"\"Returns a list of (n_blocks) free block and mark them as no longuer free in the internal data structures.\n        If the (shareable) flag is set to True, a Block object is created to keep track of the block, with the\n        (last_block_id) to indicate the last block id in the sequence, also named the parent block. If the manager\n        cannot find enough free blocks, it returns None.\"\"\"\n        if not self.has_enough_free_blocks(n_blocks):\n            return None\n        allocated_block_ids = [self._uninit_block_ids.popleft() for _ in range(n_blocks)]\n        # If we use prefix caching, we keep track of the allocated blocks as partial blocks\n        if self._use_prefix_sharing:\n        # If the block is shareable, we keep track of the allocated blocks as partial blocks\n        if shareable:\n```"}, {"role": "assistant", "content": "The thing is, for non shareable blocks, we dont need the block object at all: we just want the physical block_id. Hence no need to create a python object that will never be used and keep track of it. So less overhead!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42877, "url": "https://github.com/huggingface/transformers/pull/42877#discussion_r2627246538"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `docs.py`:\n\n```python\n{!../../docs/missing-translation.md!}\n\"\"\"\n\nnon_translated_sections = [\nnon_translated_sections = (\n    \"reference/\",\n```"}, {"role": "assistant", "content": "To be OS agnostic:\r\n```suggestion\r\n    \"reference\",\r\n```\r\nassuming we have no \"normal\" pages starting with \"reference\" (I don't think that's a real issue)"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 14033, "url": "https://github.com/fastapi/fastapi/pull/14033#discussion_r2371531886"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_rope_utils.py`:\n\n```python\nrope_parameters.setdefault(\"rope_theta\", rope_theta)\n            if partial_rotary_factor is not None:\n                rope_parameters[\"partial_rotary_factor\"] = partial_rotary_factor\n\n            # Move pretraining-time maximum length to rope parameter dict for RoPE types with scaling\n            if rope_parameters[\"rope_type\"] in [\"llama3\", \"yarn\", \"longrope\"]:\n                if hasattr(self, \"original_max_position_embeddings\"):\n                    # NOTE: Phi3 (and potentially other models) save `original_max_position_embeddings` field\n                    # containing the pretrained value outside rope parameters. This is an exception case where we\n                    # give priority to `self.original_max_position_embeddings\n                    self.rope_parameters[\"original_max_position_embeddings\"] = self.original_max_position_embeddings\n                else:\n                    self.rope_parameters.setdefault(\"original_max_position_embeddings\", self.max_position_embeddings)\n```"}, {"role": "assistant", "content": "It's useful for vLLM too, which has been applying this patch manually for a while"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42513, "url": "https://github.com/huggingface/transformers/pull/42513#discussion_r2588476904"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `poolmanager.py`:\n\n```python\nif headers:\n            headers_.update(headers)\n\n        return headers_\n\n    def urlopen(self, method, url, **kw):\n    def urlopen(self, method, url, redirect=True, **kw):\n        \"Same as HTTP(S)ConnectionPool.urlopen, ``url`` must be absolute.\"\n        kw['assert_same_host'] = False\n        kw['headers'] = self._set_proxy_headers(url, headers=kw.get('headers'))\n        return self.proxy_pool.urlopen(method, url, **kw)\n        u = parse_url(url)\n\n        if u.scheme == \"http\":\n            # It's too late to set proxy headers on per-request basis for\n            # tunnelled HTTPS connections, should use\n            # constructor's proxy_headers instead.\n            kw['headers'] = self._set_proxy_headers(url, kw.get('headers',\n                                                                self.headers))\n            kw['headers'].update(self.proxy_headers)\n```"}, {"role": "assistant", "content": "We need the set the Proxy-Authorization header regardless of HTTP or HTTPS. Is there a reason urllib3 can't do it? Because if there is, we'll need to fix it up in Requests."}], "_meta": {"repo": "psf/requests", "pr_number": 1515, "url": "https://github.com/psf/requests/pull/1515#discussion_r5728742"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_validators.py`:\n\n```python\n)\n        return x\n    except TypeError:\n        if isinstance(x, pathlib.PurePath):\n            try:\n                if not (len(str(x)) >= min_length):\n                    raise PydanticKnownError(\n                        'too_short', {'field_type': 'Value', 'min_length': min_length, 'actual_length': len(str(x))}\n                    )\n                return x\n            except TypeError:\n                pass\n```"}, {"role": "assistant", "content": "IMO it would be more correct to convert this to `bytes()` instead of `str()`"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10846, "url": "https://github.com/pydantic/pydantic/pull/10846#discussion_r1848982157"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dataproc.py`:\n\n```python\ndef execute(self, context: Context) -> None:\n        hook = DataprocHook(gcp_conn_id=self.gcp_conn_id, impersonation_chain=self.impersonation_chain)\n        operation = self._delete_cluster(hook)\n        if not self.deferrable:\n            hook.wait_for_operation(timeout=self.timeout, result_retry=self.retry, operation=operation)\n            self.log.info(\"Cluster deleted.\")\n        else:\n            try:\n                hook.get_cluster(\n                    project_id=self.project_id, region=self.region, cluster_name=self.cluster_name\n                )\n            except NotFound:\n        try:\n            op: operation.Operation = self._delete_cluster(hook)\n            if not self.deferrable:\n                hook.wait_for_operation(timeout=self.timeout, result_retry=self.retry, operation=op)\n                self.log.info(\"Cluster deleted.\")\n                return\n            except Exception as e:\n                raise AirflowException(str(e))\n\n            end_time: float = time.time() + self.timeout\n            self.defer(\n                trigger=DataprocDeleteClusterTrigger(\n                    gcp_conn_id=self.gcp_conn_id,\n                    project_id=self.project_id,\n                    region=self.region,\n                    cluster_name=self.cluster_name,\n                    end_time=end_time,\n                    metadata=self.metadata,\n                    impersonation_chain=self.impersonation_chain,\n                    polling_interval_seconds=self.polling_interval_seconds,\n                ),\n                method_name=\"execute_complete\",\n            else:\n                end_time: float = time.time() + self.timeout\n                self.defer(\n                    trigger=DataprocDeleteClusterTrigger(\n                        gcp_conn_id=self.gcp_conn_id,\n                        project_id=self.project_id,\n                        region=self.region,\n                        cluster_name=self.cluster_name,\n                        end_time=end_time,\n                        metadata=self.metadata,\n                        impersonation_chain=self.impersonation_chain,\n                        polling_interval_seconds=self.polling_interval_seconds,\n                    ),\n                    method_name=\"execute_complete\",\n                )\n        except NotFound:\n            self.log.info(\n                \"Cluster %s not found in region %s. Skipping deletion.\", self.cluster_name, self.region\n            )\n            raise AirflowSkipException(\n```"}, {"role": "assistant", "content": "<img width=\"1918\" height=\"561\" alt=\"image\" src=\"https://github.com/user-attachments/assets/0fed2936-79ed-40ff-b8d9-ebd6bb7ef3d3\" />"}], "_meta": {"repo": "apache/airflow", "pr_number": 60083, "url": "https://github.com/apache/airflow/pull/60083#discussion_r2661438453"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub_kernels.py`:\n\n```python\nif callable(is_kernel_available) and is_kernel_available():\n            # Try to import the module \"{kernel_name}\" from parent package level\n            try:\n                module = importlib.import_module(f\"{kernel_name}\")\n                module = importlib.import_module(f\"{new_kernel_name}\")\n```"}, {"role": "assistant", "content": "This is required to allow the function to fallback to the pypi package"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41540, "url": "https://github.com/huggingface/transformers/pull/41540#discussion_r2511341911"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_dagbag.py`:\n\n```python\nDagBag(dag_folder=os.fspath(tmp_path), include_examples=False)\n            assert \"SIGSEGV signal handler registration failed. Not in the main thread\" in caplog.text\n\n    def test_bundle_path_is_in_syspath_during_parse(self, tmp_path):\n        \"\"\"\n        Test that bundle_path is correctly added to and removed from sys.path during DAG import.\n        \"\"\"\n        util_file = tmp_path / \"bundle_util.py\"\n        util_file.write_text('def get_message(): return \"Hello from bundle!\"')\n\n        dag_file = tmp_path / \"test_dag.py\"\n        dag_file.write_text(\n            textwrap.dedent(\n                \"\"\"\\\n                from airflow import DAG\n                from airflow.decorators import task\n```"}, {"role": "assistant", "content": "```suggestion\n                from airflow.sdk import DAG\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 55894, "url": "https://github.com/apache/airflow/pull/55894#discussion_r2365619889"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\n)\n            for key, proxy in proxy_map.items()\n        }\n        self._proxies = dict(sorted(self._proxies.items()))\n        if mounts is not None:\n```"}, {"role": "assistant", "content": "Do I understand correctly that the mounts overrides proxies? Like:\r\n```python\r\nclient = Client(..., proxies={\"http://\": SomeTransport()}, ..., mounts={\"http://\": SomeOtherTransport())\r\nassert isinstance(client._mounts[\"http://\"], SomeOtherTransport)\r\n```\r\nDo we need to outline it somewhere?"}], "_meta": {"repo": "encode/httpx", "pr_number": 1362, "url": "https://github.com/encode/httpx/pull/1362#discussion_r506405555"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conversion_mapping.py`:\n\n```python\ndef _build_checkpoint_conversion_mapping():\n    mapping = {\n        \"mixtral\": [\n            WeightRenaming(r\"\\.block_sparse_moe\\.\", \".mlp.\"),\n            WeightConverter(\n```"}, {"role": "assistant", "content": "Not a fan to need both for a single set of keys, see also my other comment!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42254, "url": "https://github.com/huggingface/transformers/pull/42254#discussion_r2541842366"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `masking_utils.py`:\n\n```python\nif (\n        not is_tracing\n        # only cases when lower and upper diags are the same, see https://github.com/pytorch/pytorch/issues/108108\n        and (query_length == 1 or kv_length == query_length)\n        and (query_length == 1 or (kv_length == query_length if not is_torch_xpu_available() else True))\n```"}, {"role": "assistant", "content": "```suggestion\r\n        and (query_length == 1 or (kv_length == query_length or is_torch_xpu_available()))\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39573, "url": "https://github.com/huggingface/transformers/pull/39573#discussion_r2225275319"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_blt.py`:\n\n```python\nattentions=outputs.attentions,\n        )\n\n    # full forward each step\n    def prepare_inputs_for_generation(self, input_ids, **kwargs):\n```"}, {"role": "assistant", "content": "yeah i'll rather prefer to have in `test_training_mixing.py` than forcing in the modeling the `use_cache=False`\r\n```diff\r\n         with torch.no_grad():\r\n                generated_ids = model.generate(\r\n                    prompt_ids,\r\n                    max_new_tokens=num_tokens_to_generate,\r\n                    do_sample=False,\r\n                    pad_token_id=config.pad_token_id if hasattr(config, \"pad_token_id\") else 0,\r\n                    eos_token_id=0,\r\n+                    use_cache=False,\r\n                )\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42685, "url": "https://github.com/huggingface/transformers/pull/42685#discussion_r2619301606"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sessions.py`:\n\n```python\n# It's possible that users might accidentally send a Request object.\n        # Guard against that specific failure case.\n        if getattr(request, 'prepare', None):\n        if not isinstance(request, PreparedRequest):\n            raise ValueError('You can only send PreparedRequests.')\n```"}, {"role": "assistant", "content": "The reasoning, essentially, is that Requests assumes that if you're building `Request` and `PreparedRequest` objects yourself, you are doing _everything_ about preparing them yourself. The `Request` -> `PreparedRequest` flow is basically an advanced use case, when you need to work around or change something Requests does internally.\n\nWhen considered in that light, passing a `Request` to `Session.send()` is likely to be a _mistake_: you have a flow through your code where the `Request` doesn't get prepared prior to sending. That was the purpose of this exception: rather than quietly succeed but potentially do something wrong, we assume that advanced users will just fix the exception."}], "_meta": {"repo": "psf/requests", "pr_number": 1507, "url": "https://github.com/psf/requests/pull/1507#discussion_r5522899"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `client.py`:\n\n```python\nawait response.aclose()\n                raise exc from None\n            else:\n                response.history = list(history)\n                await response.aread()\n                request = next_request\n                await response.aclose()\n                history.append(response)\n```"}, {"role": "assistant", "content": "As suggested by , this part closely follows the behavior we have when handling redirection: copy the current history onto the latest response, read the response (instead of closing it), then add the response to the history.\r\n\r\nThe only difference is that here we mutate `history` in-place instead of creating a new list (`history = history + [response]`) so that the change is propagated to `.send_handling_redirects()`.\r\n\r\nIt's possible to change this so that we build and maintain an `auth_history` list instead, and merge it with the initial `history` both here and `.send_handling_redirects()`, but I'm not sure the gained immutability would be worth the extra complexity.\r\n\r\nSeparate note: I don't think we test the case of redirect + auth yet, but that would be a good idea. Definitely out of scope for this PR though?"}], "_meta": {"repo": "encode/httpx", "pr_number": 718, "url": "https://github.com/encode/httpx/pull/718#discussion_r362957305"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `release_management_validation.py`:\n\n```python\n@release_management_group.command(\n    name=\"validate-rc-by-pmc\",\n    help=\"Validate release candidate for PMC voting\",\n    name=\"verify-rc-by-pmc\",\n    help=(\n        \"Verify a release candidate for PMC voting (EXPERIMENTAL).\\n\"\n```"}, {"role": "assistant", "content": "```suggestion\n        \"[EXPERIMENTAL] Verify a release candidate for PMC voting.\\n\"\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60993, "url": "https://github.com/apache/airflow/pull/60993#discussion_r2741061046"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tokenize.py`:\n\n```python\nexcept StopIteration:\n            line = \"\"\n        lnum += 1\n\n        # skip lines that are just a slash, to avoid storing that line's\n        # indent information.\n        if not contstr and line.rstrip(\"\\n\").strip(\" \\t\") == \"\\\\\":\n```"}, {"role": "assistant", "content": "Made changes. The reason I can't do `.strip()` is because `\\` must be at the end of the line. If there's spaces after the backslash it's no longer escaping the newline:\r\n\r\n```console\r\n$ printf 'print(2 + \\\\\\n3)'\r\nprint(2 + \\\r\n3)\r\n\r\n$ printf 'print(2 + \\\\\\n3)' | python3\r\n5\r\n\r\n$ printf 'print(2 + \\\\ \\n3)' | python3\r\n  File \"<stdin>\", line 1\r\n    print(2 + \\\r\n               ^\r\nSyntaxError: unexpected character after line continuation character\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 4343, "url": "https://github.com/psf/black/pull/4343#discussion_r1590010955"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nser_json_inf_nan='null',\n    validate_default=False,\n    validate_return=False,\n    protected_namespaces=('model_',),\n    protected_namespaces=('model_validate', 'model_dump'),\n```"}, {"role": "assistant", "content": "Would it make sense to also add `model_fields` here and all of the existing pydantic `model_` fields that would Raise a real conflict error prior to this change? An example of a collision here that could be confusing is:\r\n\r\n```py\r\n    class SomePydanticParentModel(BaseModel):\r\n        model_fields: dict = {\"bar\": \"baz\"}\r\n        model_config = ConfigDict(protected_namespaces=())\r\n\r\n    class SomePydanticChildModel(SomePydanticParentModel):\r\n        pass\r\n\r\n    parent_instance = SomePydanticParentModel()\r\n    # Passes, looks like model_fields is fine to use\r\n    assert parent_instance.model_fields == {\"bar\": \"baz\"}\r\n\r\n    child_instance = SomePydanticChildModel()\r\n    # Fails, and is somewhat surprising / confusing that the child doesn't inherit the field\r\n    # correctly from the parent \r\n    assert child_instance.model_fields == {\"bar\": \"baz\"}\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10441, "url": "https://github.com/pydantic/pydantic/pull/10441#discussion_r1775350459"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_fields.py`:\n\n```python\nf\"Unexpected field with name {ann_name!r}; only 'root' is allowed as a field of a `RootModel`\"\n            )\n\n        # when building a generic model with `MyModel[int]`, the generic_origin check makes sure we don't get\n        # \"... shadows an attribute\" warnings\n        generic_origin = getattr(cls, '__pydantic_generic_metadata__', {}).get('origin')\n        for base in bases:\n            dataclass_fields = {\n                field.name for field in (dataclasses.fields(base) if dataclasses.is_dataclass(base) else ())\n            }\n            if hasattr(base, ann_name):\n                if ann_name not in cls_annotations:\n                    # Don't warn when a field exists in a parent class but has not been defined in the current class\n                    continue\n\n                # when building a generic model with `MyModel[int]`, the generic_origin check makes sure we don't get\n                # \"... shadows an attribute\" warnings\n                generic_origin = getattr(cls, '__pydantic_generic_metadata__', {}).get('origin')\n```"}, {"role": "assistant", "content": "I'm surprised this was worth moving to a lower loop level, it's presumably not expensive to evaluate. Should we instead be moving this up to the top level above the loop on line 273?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12681, "url": "https://github.com/pydantic/pydantic/pull/12681#discussion_r2697569904"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pointers.py`:\n\n```python\nptr.set_type(c_int)\n        self.assertIs(ptr._type_, c_int)\n\nclass TestPointerStringProto(unittest.TestCase):\n```"}, {"role": "assistant", "content": "I would prefer to add the test to the end of PointersTestCase, instead of adding a new test case."}], "_meta": {"repo": "python/cpython", "pr_number": 144108, "url": "https://github.com/python/cpython/pull/144108#discussion_r2722100584"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scheduler.py`:\n\n```python\nself._smqclass: type[BaseQueue] | None = self._get_start_queue_cls(\n            crawler, \"MEMORY\"\n        )\n        if (\n            self.crawler\n            and self.crawler.settings.getint(\"CONCURRENT_REQUESTS_PER_IP\") != 0\n```"}, {"role": "assistant", "content": "After removing the default setting, `getint` may return None or raise if the key is missing. Consider using `getint(\"CONCURRENT_REQUESTS_PER_IP\", 0)` to provide a fallback and avoid unexpected errors.\n```suggestion\n            and self.crawler.settings.getint(\"CONCURRENT_REQUESTS_PER_IP\", 0) != 0\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6921, "url": "https://github.com/scrapy/scrapy/pull/6921#discussion_r2173112674"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `urllength.py`:\n\n```python\nclass UrlLengthMiddleware:\n\n    def __init__(self, maxlength):\n    def __init__(self, maxlength, stats):\n        self.maxlength = maxlength\n        self.stats = stats\n\n    @classmethod\n    def from_settings(cls, settings):\n    def from_crawler(cls, crawler):\n```"}, {"role": "assistant", "content": "we might not inject `stats` instance to a mw, but instead access it by `spider.crawler.stats` so no need to change signatures, and backward compatibility will be kept. \r\n\r\nIs that fine?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5036, "url": "https://github.com/scrapy/scrapy/pull/5036#discussion_r593074824"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\n\"\"\"\n\n    _constraints = UrlConstraints(\n        allowed_schemes=['clickhouse+native', 'clickhouse+asynch'],\n        allowed_schemes=['clickhouse+native', 'clickhouse+asynch', 'clickhouse+http', 'clickhouse', 'clickhouses', 'clickhousedb'],\n```"}, {"role": "assistant", "content": "```suggestion\r\n        allowed_schemes=[\r\n            'clickhouse+native',\r\n            'clickhouse+asynch',\r\n            'clickhouse+http',\r\n            'clickhouse',\r\n            'clickhouses',\r\n            'clickhousedb',\r\n        ],\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11319, "url": "https://github.com/pydantic/pydantic/pull/11319#discussion_r1928498009"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nraise AttributeError(attribute)\n\n\ndef _annotated_type(type_: Any) -> Any | None:\n    return get_args(type_)[0] if _typing_extra.is_annotated(type_) else None\n```"}, {"role": "assistant", "content": "Generally a cleaner approach than what we had though, so feel free to just resolve this as is."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 8939, "url": "https://github.com/pydantic/pydantic/pull/8939#discussion_r1548440462"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `urllength.py`:\n\n```python\nfrom __future__ import annotations\n\nimport logging\nimport warnings\nfrom typing import TYPE_CHECKING, Any\nfrom typing import TYPE_CHECKING\n\nfrom scrapy.exceptions import NotConfigured, ScrapyDeprecationWarning\nfrom scrapy.http import Request, Response\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.spidermiddlewares.base import BaseSpiderMiddleware\n\nif TYPE_CHECKING:\n    from collections.abc import AsyncIterable, Iterable\n\n    # typing.Self requires Python 3.11\n    from typing_extensions import Self\n\n    from scrapy import Spider\n    from scrapy.crawler import Crawler\n    from scrapy.settings import BaseSettings\n    from scrapy.http import Request, Response\n\n\nlogger = logging.getLogger(__name__)\n\n\nclass UrlLengthMiddleware:\nclass UrlLengthMiddleware(BaseSpiderMiddleware):\n    crawler: Crawler\n\n    def __init__(self, maxlength: int):\n        self.maxlength: int = maxlength\n\n    @classmethod\n    def from_settings(cls, settings: BaseSettings) -> Self:\n        warnings.warn(\n            f\"{cls.__name__}.from_settings() is deprecated, use from_crawler() instead.\",\n```"}, {"role": "assistant", "content": "This is removed early but I don't think it's a big deal (we should try to remember to mention it in the release notes though)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6693, "url": "https://github.com/scrapy/scrapy/pull/6693#discussion_r2052598971"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scheduler_job_runner.py`:\n\n```python\n.where(~DM.is_paused)\n                .where(TI.state == TaskInstanceState.SCHEDULED)\n                .where(DM.bundle_name.is_not(None))\n                .join(\n                    dr_task_concurrency_subquery,\n                    and_(\n                        TI.dag_id == dr_task_concurrency_subquery.c.dag_id,\n                        TI.run_id == dr_task_concurrency_subquery.c.run_id,\n                    ),\n                    isouter=True,\n                )\n                .where(func.coalesce(dr_task_concurrency_subquery.c.dr_count, 0) < DM.max_active_tasks)\n                .options(selectinload(TI.dag_model))\n                .order_by(-TI.priority_weight, DR.logical_date, TI.map_index)\n            )\n\n            # Create a subquery with row numbers partitioned by dag_id and run_id.\n            # Different dags can have the same run_id but\n            # the dag_id combined with the run_id uniquely identify a run.\n            ranked_query = (\n                query.add_columns(\n                    func.row_number()\n                    .over(\n                        partition_by=[TI.dag_id, TI.run_id],\n                        order_by=[-TI.priority_weight, DR.logical_date, TI.map_index],\n                    )\n                    .label(\"row_num\"),\n                    DM.max_active_tasks.label(\"dr_max_active_tasks\"),\n                    # Create columns for the order_by checks here for sqlite.\n                    TI.priority_weight.label(\"priority_weight_for_ordering\"),\n                    DR.logical_date.label(\"logical_date_for_ordering\"),\n                    TI.map_index.label(\"map_index_for_ordering\"),\n                )\n            ).subquery()\n\n            # Select only rows where row_number <= max_active_tasks.\n            query = (\n                select(TI)\n                .select_from(ranked_query)\n                .join(\n                    TI,\n                    (TI.dag_id == ranked_query.c.dag_id)\n                    & (TI.task_id == ranked_query.c.task_id)\n                    & (TI.run_id == ranked_query.c.run_id)\n                    & (TI.map_index == ranked_query.c.map_index),\n                )\n                .where(ranked_query.c.row_num <= ranked_query.c.dr_max_active_tasks)\n```"}, {"role": "assistant", "content": "The window function limits selection to `max_active_tasks` per dag_run without considering currently executing tasks. For example, if a dag_run has 3 tasks already executing and `max_active_tasks=4`, this query would select 4 scheduled tasks (since `row_num` goes 1-4), but only 1 can actually be queued. This means up to 3 extra tasks are retrieved and then rejected at line 701.\n\nConsider incorporating the current task count (`dr_count` from line 505) into the row number filter to improve efficiency:\n1. Add `dr_task_concurrency_subquery.c.dr_count` to the columns at line 533\n2. Change line 559 to: `where(ranked_query.c.row_num <= (ranked_query.c.dr_max_active_tasks - func.coalesce(ranked_query.c.dr_count, 0)))`\n\nThis would reduce unnecessary database retrievals and subsequent filtering in Python code."}], "_meta": {"repo": "apache/airflow", "pr_number": 54103, "url": "https://github.com/apache/airflow/pull/54103#discussion_r2594698570"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_dag.py`:\n\n```python\ndag_models = query.all()\n        assert dag_models == [dag_model]\n\n    def test_dags_needing_dagruns_query_count(self, dag_maker, session):\n        \"\"\"Test that dags_needing_dagruns avoids N+1 on adrq.asset access.\"\"\"\n        num_assets = 10\n        assets = [Asset(uri=f\"test://asset{i}\", group=\"test-group\") for i in range(num_assets)]\n\n        with dag_maker(\n            session=session,\n            dag_id=\"my_dag\",\n            max_active_runs=10,\n            schedule=assets,\n            start_date=pendulum.now().add(days=-2),\n        ):\n            EmptyOperator(task_id=\"dummy\")\n\n        dag_model = dag_maker.dag_model\n        asset_models = dag_model.schedule_assets\n        assert len(asset_models) == num_assets\n        for asset_model in asset_models:\n            session.add(AssetDagRunQueue(asset_id=asset_model.id, target_dag_id=dag_model.dag_id))\n        session.flush()\n\n        # Clear identity map so N+1 on adrq.asset is exposed\n        session.expire_all()\n\n        with assert_queries_count(6):\n```"}, {"role": "assistant", "content": "The expected query count of 6 doesn't match the PR description which states 'After: 4 queries'. Either the assertion should be updated to 4, or the PR description should be updated to explain why 6 queries are expected.\n```suggestion\n        with assert_queries_count(4):\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60957, "url": "https://github.com/apache/airflow/pull/60957#discussion_r2718888332"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `mode.py`:\n\n```python\nstr(int(self.is_ipynb)),\n            str(int(self.magic_trailing_comma)),\n            str(int(self.experimental_string_processing)),\n            \",\".join(sorted(self.python_cell_magics)),\n```"}, {"role": "assistant", "content": "Of course.  I've done that and resolved the merge conflicts."}], "_meta": {"repo": "psf/black", "pr_number": 2744, "url": "https://github.com/psf/black/pull/2744#discussion_r788436436"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\n) -> dict[str, list[torch.Tensor]]:\n        raise NotImplementedError\n\n    @property\n    def reverse_op(self) -> ConversionOps:\n        raise NotImplementedError\n\n\nclass Chunk(ConversionOps):\n    \"\"\"Split a tensor along ``dim`` into equally sized chunks or using explicit ``sizes``.\"\"\"\n\n    reverse_op: type[ConversionOps]\n    \"\"\"Split a tensor along ``dim`` into equally sized chunks.\"\"\"\n\n    def __init__(self, dim: int = 0, chunks: Optional[int] = None, sizes: Optional[Sequence[int]] = None):\n    def __init__(self, dim: int = 0):\n        self.dim = dim\n        self.chunks = chunks\n        self.sizes = list(sizes) if sizes is not None else None\n        self.reverse_op = Concatenate\n\n    def convert(\n        self,\n        value: dict[str, list[torch.Tensor]],\n        source_keys: list[str],\n        target_keys: list[str],\n        source_patterns: list[str],\n        target_patterns: list[str],\n        full_layer_name: str,\n        model,\n        missing_keys,\n        config,\n    ) -> dict[str, list[torch.Tensor]]:\n        tensors = next(iter(value.values()))\n        tensor = tensors[0]\n        sizes = len(target_keys)\n        if len(value) > 1:\n            raise ValueError(\"Unexpected value in `Chunk`!\")\n```"}, {"role": "assistant", "content": "For the current state of the mappings we have it's fine - we can definitely lift it later, but we have to be extremely careful about the sizes we use in the `torch.chunk` then! It may become undefined with several inputs, as the `target_patterns` are then mixed between them, and we don't know anymore which belong to which!"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42396, "url": "https://github.com/huggingface/transformers/pull/42396#discussion_r2566131250"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nself._type = type\n        self._config = config\n        self._parent_depth = _parent_depth\n\n        if module is None:\n            f = sys._getframe(1)\n            self._module_name = cast(str, f.f_globals.get('__name__', ''))\n        else:\n            self._module_name = module\n\n        self._core_schema: CoreSchema | None = None\n        self._validator: SchemaValidator | PluggableSchemaValidator | None = None\n        self._serializer: SchemaSerializer | None = None\n        self.core_schema: CoreSchema\n        self.validator: SchemaValidator | PluggableSchemaValidator\n        self.serializer: SchemaSerializer\n\n        localns: _namespace_utils.MappingNamespace = (\n            _typing_extra.parent_frame_namespace(parent_depth=self._parent_depth) or {}\n        )\n        globalns: _namespace_utils.GlobalsNamespace = sys._getframe(max(self._parent_depth - 1, 1)).f_globals.copy()\n```"}, {"role": "assistant", "content": "Eh, we don't copy the result of `parent_frame_namepsace` which returns `f_locals`, so I think removing this is fine."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10537, "url": "https://github.com/pydantic/pydantic/pull/10537#discussion_r1838417060"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `connections.py`:\n\n```python\ntry:\n        data = test_body.model_dump(by_alias=True)\n        data[\"conn_id\"] = transient_conn_id\n\n        existing_conn = session.scalar(\n```"}, {"role": "assistant", "content": "Thanks for catching this, I missed it.\nThis approach seems more appropriate than reading the connection directly from the database."}], "_meta": {"repo": "apache/airflow", "pr_number": 59643, "url": "https://github.com/apache/airflow/pull/59643#discussion_r2637192836"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\nfrom __future__ import annotations\n\nimport argparse\nimport itertools as it\nimport json\nimport re\nimport subprocess\nimport sys\nfrom dataclasses import dataclass\nfrom enum import Flag, StrEnum, auto\nfrom functools import reduce\nfrom operator import attrgetter, or_\nfrom pathlib import Path\nfrom textwrap import dedent\nfrom typing import Any, Self\n\nCONFORMANCE_ERROR_PATTERN = re.compile(r\"#\\s*E(?:\\s*(?::\\s*(.+)|\\[(.+)\\]))?\\s*\")\n\n\nclass Source(Flag):\n    OLD = auto()\n    NEW = auto()\n    EXPECTED = auto()\n\n\nclass Classification(StrEnum):\n    TRUE_POSITIVE = auto()\n    FALSE_POSITIVE = auto()\n    TRUE_NEGATIVE = auto()\n    FALSE_NEGATIVE = auto()\n\n\n@dataclass\nclass Position:\n    line: int\n    column: int\n\n\n@dataclass\n```"}, {"role": "assistant", "content": "```suggestion\r\n(kw_only=True, slots=True)\r\n```"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22231, "url": "https://github.com/astral-sh/ruff/pull/22231#discussion_r2680019957"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_apertus.py`:\n\n```python\ndef __init__(self, config: ApertusConfig, device=None):\n        super().__init__()\n        # BC: \"rope_type\" was originally \"type\"\n        if hasattr(config, \"rope_scaling\") and isinstance(config.rope_scaling, dict):\n            self.rope_type = config.rope_scaling.get(\"rope_type\", config.rope_scaling.get(\"type\"))\n        else:\n            self.rope_type = \"default\"\n        self.max_seq_len_cached = config.max_position_embeddings\n        self.original_max_seq_len = config.max_position_embeddings\n\n        standardize_rope_params(config)\n        self.config = config\n        self.rope_init_fn = ROPE_INIT_FUNCTIONS[self.rope_type]\n\n        inv_freq, self.attention_scaling = self.rope_init_fn(self.config, device)\n        self.rope_type = self.config.rope_parameters[\"rope_type\"]\n        rope_init_fn: Callable = self.compute_default_rope_parameters\n        if self.rope_type != \"default\":\n            rope_init_fn = ROPE_INIT_FUNCTIONS[self.rope_type]\n        inv_freq, self.attention_scaling = rope_init_fn(self.config, device)\n\n        self.register_buffer(\"inv_freq\", inv_freq, persistent=False)\n        self.original_inv_freq = self.inv_freq\n        self.original_inv_freq = inv_freq\n\n    @staticmethod\n    def compute_default_rope_parameters(\n        config: Optional[ApertusConfig] = None,\n        device: Optional[\"torch.device\"] = None,\n        seq_len: Optional[int] = None,\n        layer_type: Optional[str] = None,\n    ) -> tuple[\"torch.Tensor\", float]:\n        \"\"\"\n        Computes the inverse frequencies according to the original RoPE implementation\n        Args:\n            config ([`~transformers.PreTrainedConfig`]):\n                The model configuration.\n            device (`torch.device`):\n                The device to use for initialization of the inverse frequencies.\n            seq_len (`int`, *optional*):\n                The current sequence length. Unused for this type of RoPE.\n            layer_type (`str`, *optional*):\n                The current layer type if the model has different RoPE parameters per type.\n                Should not be used unless `config.layer_types is not None`\n        Returns:\n            Tuple of (`torch.Tensor`, `float`), containing the inverse frequencies for the RoPE embeddings and the\n            post-processing scaling factor applied to the computed cos/sin (unused in this type of RoPE).\n        \"\"\"\n        # For backward compatibility standardize the `rope_parameters_dict` if it uses old format\n        standardize_rope_params(config)\n\n        base = (\n            config.rope_parameters[layer_type][\"rope_theta\"]\n            if layer_type is not None\n            else config.rope_parameters[\"rope_theta\"]\n        )\n        partial_rotary_factor = getattr(config, \"partial_rotary_factor\", 1.0)\n```"}, {"role": "assistant", "content": "No I am not in favor of adding code that is not original to the model. This model and a bunch of the other did never have partial rotary. The \"eager_inv_freq\" should just be: \r\n```\r\n        # Compute the inverse frequencies\r\n        inv_freq = 1.0 / (\r\n            base ** (torch.arange(0, dim, 2, dtype=torch.int64).to(device=device, dtype=torch.float) / dim)\r\n        )\r\n```\r\nand that's it, no need for an extra function and etc"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39847, "url": "https://github.com/huggingface/transformers/pull/39847#discussion_r2426079585"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `job.py`:\n\n```python\nreturn job_request_obj\n\n    def get_or_create_pod(self, pod_request_obj, context):\n        \"\"\"Polls for pods created by the job object\n\n        Parameters\n        ----------\n        pod_request_obj : V1Pod\n            Kubernetes Pod object definition\n        context : Context\n            Airflow context\n\n        Returns\n        -------\n        V1Pod\n            Kubernetes Pod object from cluster hook\n        \"\"\"\n        pod = None\n        with timeout(seconds=self.pod_creation_timeout, error_message=\"Exceeded pod_creation_timeout.\"):\n            while pod is None:\n                try:\n                    pod = self.find_pod(self.namespace or pod_request_obj.metadata.namespace, context=context)\n                except ApiException:\n                    log.exception(\"Error getting pod - retrying\")\n                    time.sleep(1)\n```"}, {"role": "assistant", "content": "added `pod_poll_interval` parameter to configure this"}], "_meta": {"repo": "apache/airflow", "pr_number": 53368, "url": "https://github.com/apache/airflow/pull/53368#discussion_r2222578414"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_urls.py`:\n\n```python\nreturn isinstance(other, (URL, str)) and str(self) == str(URL(other))\n\n    def __str__(self) -> str:\n        return self._uri_reference.unsplit()\n        return str(self._uri_reference)\n\n    def __repr__(self) -> str:\n        class_name = self.__class__.__name__\n        url_str = str(self)\n        if self._uri_reference.userinfo:\n            # Mask any password component in the URL representation, to lower the\n            # risk of unintended leakage, such as in debug information and logging.\n            username = quote(self.username)\n            url_str = (\n                rfc3986.urlparse(url_str)\n                .copy_with(userinfo=f\"{username}:[secure]\")\n                .unsplit()\n            )\n        return f\"{class_name}({url_str!r})\"\n        scheme, userinfo, host, port, path, query, fragment = self._uri_reference\n\n        if \":\" in userinfo:\n            # Mask any password component.\n            userinfo = f'{userinfo.split(\":\")[0]}:[secure]'\n\n        authority = \"\".join(\n            [\n                f\"{userinfo}@\" if userinfo else \"\",\n                f\"[{host}]\" if \":\" in host else host,\n                f\":{port}\" if port is not None else \"\",\n            ]\n        )\n        url = \"\".join(\n```"}, {"role": "assistant", "content": "Right now we're doing this here because we need to mask the password for `__repr__`, but not for the `__str__`.\r\n\r\nWe could perhaps simplify a little by having a `to_string(mask_password: bool)` method on the `ParseResult` class."}], "_meta": {"repo": "encode/httpx", "pr_number": 2252, "url": "https://github.com/encode/httpx/pull/2252#discussion_r907152909"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dnf5.py`:\n\n```python\nrc=1,\n                    )\n                elif result != libdnf5.base.Transaction.TransactionRunResult_SUCCESS:\n                    if result == libdnf5.base.Transaction.TransactionRunResult_ERROR_RPM_RUN:\n                        failures = [transaction.get_rpm_messages()]\n```"}, {"role": "assistant", "content": "`get_rpm_messages` was introduced in `5.2.7.0` (https://github.com/rpm-software-management/dnf5/commit/541a8479bb26af7c3ba7e8e71e82f9ab0abf924f) so we should have some kind of fallback for when it is not available. Does `get_transaction_problems` or `get_problems` or $other return anything for such failures?\n\nAlso, `get_rpm_messages` already returns an iterable so storing it in a list is not what we want, no? I would do something similar to what we do in the `else` branch below, depending on what `get_rpm_messages` individual items are. And since tests didn't catch it we should have something asserting an item in the `failures` list too."}], "_meta": {"repo": "ansible/ansible", "pr_number": 86123, "url": "https://github.com/ansible/ansible/pull/86123#discussion_r2494862621"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_std_types_schema.py`:\n\n```python\n}:\n        return None\n\n    is_path_like_subtype_invalid = (\n        orig_source_type == os.PathLike\n        and orig_source_type_arg\n        and orig_source_type_arg\n        not in {\n            str,\n            bytes,\n            Any,\n        }\n    )\n\n    if is_path_like_subtype_invalid:\n        return None\n\n    metadata, remaining_annotations = _known_annotated_metadata.collect_known_metadata(annotations)\n    _known_annotated_metadata.check_metadata(metadata, _known_annotated_metadata.STR_CONSTRAINTS, source_type)\n    _known_annotated_metadata.check_metadata(metadata, _known_annotated_metadata.STR_CONSTRAINTS, orig_source_type)\n\n    construct_path = orig_source_type\n```"}, {"role": "assistant", "content": "I realize I've skipped the decoding here, one moment... trying to add back in with correct typing"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9764, "url": "https://github.com/pydantic/pydantic/pull/9764#discussion_r1659006857"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `text_to_audio.py`:\n\n```python\n- **audio** (`np.ndarray` of shape `(nb_channels, audio_length)`) -- The generated audio waveform.\n            - **sampling_rate** (`int`) -- The sampling rate of the generated audio waveform.\n        \"\"\"\n        if isinstance(text_inputs, (list, tuple, types.GeneratorType)):\n            if isinstance(text_inputs, types.GeneratorType):\n                text_inputs, _ = itertools.tee(text_inputs)\n                text_inputs, first_item = (x for x in text_inputs), next(_)\n```"}, {"role": "assistant", "content": "Let's exchange the wildcard tho, i.e. `_` - trying to be explicit here"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42326, "url": "https://github.com/huggingface/transformers/pull/42326#discussion_r2557014516"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pipeline_images.py`:\n\n```python\npath, new_im, new_buf = next(get_images_gen)\n        assert path == \"full/3fd165099d8e71b8a48b2683946e64dbfad8b52d.jpg\"\n        assert orig_im == new_im\n        assert orig_im.copy() == new_im\n```"}, {"role": "assistant", "content": "`orig_im` would be the opened image in the specific class of `JpegImagePlugin` - https://github.com/scrapy/scrapy/actions/runs/16583228546/job/46903534162#step:5:262\r\n\r\nCalling `copy()` turns it into a more general `Image` instance, to match what is returned by `ImageOps.exif_tranpose()`"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6975, "url": "https://github.com/scrapy/scrapy/pull/6975#discussion_r2239836303"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_api.py`:\n\n```python\nauth: AuthTypes | None = None,\n    proxy: ProxyTypes | None = None,\n    follow_redirects: bool = False,\n    cert: CertTypes | None = None,\n    verify: VerifyTypes = True,\n    ssl_context: typing.Optional[ssl.SSLContext] = None,\n```"}, {"role": "assistant", "content": "```suggestion\r\n    ssl_context: ssl.SSLContext | None = None,\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 3022, "url": "https://github.com/encode/httpx/pull/3022#discussion_r1790227923"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nUNSET = UnsetType()\n\n\ndef create_ssl_context(\n    cert: CertTypes | None = None,\n    verify: VerifyTypes = True,\n    trust_env: bool = True,\n    http2: bool = False,\n) -> ssl.SSLContext:\n    return SSLConfig(\n        cert=cert, verify=verify, trust_env=trust_env, http2=http2\n    ).ssl_context\n\n\nclass SSLConfig:\n    \"\"\"\n    SSL Configuration.\n    \"\"\"\n\nclass SSLContext(ssl.SSLContext):\n    DEFAULT_CA_BUNDLE_PATH = Path(certifi.where())\n\n    def __init__(\n        self,\n        *,\n        cert: CertTypes | None = None,\n        verify: VerifyTypes = True,\n        cert: CertTypes | None = None,\n        trust_env: bool = True,\n        http2: bool = False,\n    ) -> None:\n        self.cert = cert\n        self.verify = verify\n        set_minimum_tls_version_1_2(self)\n        self.options |= ssl.OP_NO_COMPRESSION\n        self.set_ciphers(DEFAULT_CIPHERS)\n        self.trust_env = trust_env\n        self.http2 = http2\n        self.ssl_context = self.load_ssl_context()\n\n    def load_ssl_context(self) -> ssl.SSLContext:\n        keylogfile = os.environ.get(\"SSLKEYLOGFILE\")\n        if keylogfile and self.trust_env:\n```"}, {"role": "assistant", "content": "Yes we're applying this unilaterally. (In line with `ssl.create_default_context()`, `urllib3`, and `requests`)"}], "_meta": {"repo": "encode/httpx", "pr_number": 3022, "url": "https://github.com/encode/httpx/pull/3022#discussion_r1791571187"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `RUF068.py`:\n\n```python\nimport typing\n\n\nclass A: ...\n\n\nclass B: ...\n\n\n# Good\n__all__ = \"A\" + \"B\"\n__all__: list[str] = [\"A\", \"B\"]\n__all__: typing.Any = (\"A\", \"B\")\n__all__ = [\"A\", \"B\"]\n__all__ += [\"A\", \"B\"]\n__all__.extend([\"A\", \"B\"])\n\n# Bad\n__all__: list[str] = [\"A\", \"B\", \"A\"]\n__all__: typing.Any = (\"A\", \"B\", \"B\")\n__all__ = [\"A\", \"A\", \"B\"]\n__all__ = [\"A\", \"B\", \"A\"]\n__all__ = [\"A\", \"A\", \"B\", \"B\"]\n```"}, {"role": "assistant", "content": "Let's throw in one multi-line case without comments."}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22114, "url": "https://github.com/astral-sh/ruff/pull/22114#discussion_r2656479847"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nif metadata_schema:\n                self._add_js_function(metadata_schema, metadata_js_function)\n\n        _add_custom_serialization_from_json_encoders(self._json_encoders, obj, schema)\n```"}, {"role": "assistant", "content": "Does it matter? We're editing the CoreSchema here directly while the js func won't get executed until later. Or maybe I'm misunderstanding. Is there a test case we can add?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6737, "url": "https://github.com/pydantic/pydantic/pull/6737#discussion_r1271291783"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_triggerer_job.py`:\n\n```python\n# Re-load the triggers\n        trigger_runner_supervisor.load_triggers()\n\n        # Wait for up to 3 seconds for it to vanish from the TriggerRunner's storage\n        for _ in range(30):\n        # Wait for up to 100 seconds for it to vanish from the TriggerRunner's storage\n```"}, {"role": "assistant", "content": "> In your description, you said 10s. Do we need 100s here instead?\n\nOops, I'm bad at math. Yes, 100 * 0.1 is 10 seconds. I think we should only need 10s"}], "_meta": {"repo": "apache/airflow", "pr_number": 60754, "url": "https://github.com/apache/airflow/pull/60754#discussion_r2708410951"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `remove_except_parens.py`:\n\n```python\n# These brackets are redundant, therefore remove.\ntry:\n    a.something\nexcept (AttributeError) as err:\n```"}, {"role": "assistant", "content": "I've added these tests and all works as expected \ud83d\ude04"}], "_meta": {"repo": "psf/black", "pr_number": 2939, "url": "https://github.com/psf/black/pull/2939#discussion_r833059344"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_vivit.py`:\n\n```python\nexpectations = Expectations(\n            {\n                (None, None): [-0.9498, 2.7971, -1.4049, 0.1024, -1.8353],\n                (\"cuda\", 8): [-0.9498, 2.7971, -1.4049, 0.1025, -1.8353],\n                (\"cuda\", 8): [-0.9502,  2.7967, -1.4046,  0.1027, -1.8345],\n```"}, {"role": "assistant", "content": "wait, there seems to have some double spaces here ..?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43406, "url": "https://github.com/huggingface/transformers/pull/43406#discussion_r2716965648"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_loaders.py`:\n\n```python\nbase.autodiscover_tasks(['foo'])\n            frm.assert_called()\n\n    def test_find_related_module(self):\n    # Happy - get something back\n    def test_find_related_module__when_existent_package_alone(self):\n        with patch('importlib.import_module') as imp:\n            imp.return_value = Mock()\n            imp.return_value.__path__ = 'foo'\n            assert base.find_related_module('bar', 'tasks').__path__ == 'foo'\n            imp.assert_any_call('bar')\n            imp.assert_any_call('bar.tasks')\n            assert base.find_related_module('foo', None).__path__ == 'foo'\n            imp.assert_called_once_with('foo')\n\n            imp.reset_mock()\n            assert base.find_related_module('bar', None).__path__ == 'foo'\n            imp.assert_called_once_with('bar')\n    def test_find_related_module__when_existent_package_and_related_name(self):\n        with patch('importlib.import_module') as imp:\n            first_import = Mock()\n            first_import.__path__ = 'foo'\n            second_import = Mock()\n            second_import.__path__ = 'foo/tasks'\n            imp.side_effect = [first_import, second_import]\n            assert base.find_related_module('foo', 'tasks').__path__ == 'foo/tasks'\n            imp.assert_any_call('foo')\n            imp.assert_any_call('foo.tasks')\n\n    def test_find_related_module__when_existent_package_parent_and_related_name(self):\n        with patch('importlib.import_module') as imp:\n            first_import = ModuleNotFoundError(name='foo.BarApp')  # Ref issue #2248\n```"}, {"role": "assistant", "content": "It seems like this behavior was added to match some edge case w/ how Django apps present themselves for auto-discovery (see #2248)."}], "_meta": {"repo": "celery/celery", "pr_number": 8632, "url": "https://github.com/celery/celery/pull/8632#discussion_r1389981573"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_granitemoehybrid.py`:\n\n```python\nfrom ...processing_utils import Unpack\nfrom ...utils import TransformersKwargs, auto_docstring, can_return_tuple, logging\nfrom ...utils.generic import check_model_inputs\nfrom ...utils.import_utils import is_causal_conv1d_available, is_mamba_2_ssm_available\nfrom .configuration_granitemoehybrid import GraniteMoeHybridConfig\n\n\nif is_mamba_2_ssm_available():\n    from mamba_ssm.ops.triton.selective_state_update import selective_state_update\n    from mamba_ssm.ops.triton.ssd_combined import mamba_chunk_scan_combined, mamba_split_conv1d_scan_combined\nelse:\n    selective_state_update = None\n\nif is_causal_conv1d_available():\n    from causal_conv1d import causal_conv1d_fn, causal_conv1d_update\nelse:\n    causal_conv1d_update, causal_conv1d_fn = None, None\n```"}, {"role": "assistant", "content": "yup sounds good! I only rewrote what we had before in a more general way! we can add version checking later."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41540, "url": "https://github.com/huggingface/transformers/pull/41540#discussion_r2534599463"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `fields.py`:\n\n```python\n\"\"\"\n        self._attributes_set = {k: v for k, v in kwargs.items() if v is not _Unset}\n        kwargs = {k: _DefaultValues.get(k) if v is _Unset else v for k, v in kwargs.items()}  # type: ignore\n        self.annotation, annotation_metadata = self._extract_metadata(kwargs.get('annotation'))\n```"}, {"role": "assistant", "content": "`annotation` is only provided in kwargs from `from_annotation` and `from_annotated_attribute`, and in both cases the metadata from `Annotated` is already extracted, so it isn't necessary to do it a second time here."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11109, "url": "https://github.com/pydantic/pydantic/pull/11109#discussion_r1888512603"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_model_construction.py`:\n\n```python\nprivate_attributes = self.__dict__.get('__private_attributes__')\n            if private_attributes and item in private_attributes:\n                return private_attributes[item]\n            if item == '__pydantic_core_schema__':\n                # This means the class didn't get a schema generated for it, likely because there was an undefined reference\n                maybe_mock_validator = getattr(self, '__pydantic_validator__', None)\n                if isinstance(maybe_mock_validator, MockValSer):\n                    rebuilt_validator = maybe_mock_validator.rebuild()\n                    if rebuilt_validator is not None:\n                        # In this case, a validator was built, and so `__pydantic_core_schema__` should now be set\n                        return getattr(self, '__pydantic_core_schema__')\n```"}, {"role": "assistant", "content": "Well, I guess it comes down to whether there is any way that the MockValSer can be set _without_ using the defer_build stuff. If it can be set without the defer build then yeah it seems suspicious to delete this."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 8939, "url": "https://github.com/pydantic/pydantic/pull/8939#discussion_r1548679239"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\nyield self._closewait\n\n    def stop(self) -> Deferred:\n        \"\"\"Stop the execution engine gracefully\"\"\"\n        \"\"\"\n        Gracefully stop the execution engine\n        \"\"\"\n        @inlineCallbacks\n        def _finish_stopping_engine(_) -> Deferred:\n            yield self.signals.send_catch_log_deferred(signal=signals.engine_stopped)\n            self._closewait.callback(None)\n\n        if not self.running:\n            raise RuntimeError(\"Engine not running\")\n\n        self.running = False\n        dfd = self.close_spider(self.spider, reason=\"shutdown\") if self.spider is not None else defer_succeed(None)\n        return dfd.addBoth(lambda _: self._finish_stopping_engine())\n        return dfd.addBoth(_finish_stopping_engine)\n\n    def close(self) -> Deferred:\n        \"\"\"Close the execution engine gracefully.\n\n        \"\"\"\n        Gracefully close the execution engine.\n        If it has already been started, stop it. In all cases, close all spiders and the downloader.\n        \"\"\"\n        if self.running:\n            return self.stop()  # will also close spiders and downloader\n        elif self.spider is not None:\n            return self.close_spider(self.spider, reason=\"shutdown\")  # will also close downloader\n```"}, {"role": "assistant", "content": ":lipstick: \r\n\r\n```suggestion\r\n        if self.spider is not None:\r\n            return self.close_spider(self.spider, reason=\"shutdown\")  # will also close downloader\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5090, "url": "https://github.com/scrapy/scrapy/pull/5090#discussion_r610378439"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nself.parent = parent\n        self._local_item = context['item'] = item\n        self._local_values = defaultdict(list)\n        # Preprocess values if item built from dict\n        # Values need to be added to item._values if added them from dict (not with add_values)\n        # values from initial item\n        for field_name, value in item.items():\n            self._values[field_name] = self._process_input_value(field_name, value)\n            self._values[field_name] += arg_to_iter(value)\n```"}, {"role": "assistant", "content": "> Something like a parameter to ItemLoader that sets the old behavior?\r\n\r\nI was thinking about parameter or attribute of Loader. I could set this when defining my subclass of ItemLoader. But I see potential problem from library point of view - it can be hard to maintain in the future, there will be 2 different logics, not sure how many people will even think about this attribute or parameter. If I will be only project using it - it is not much sense, I can just subclass ItemLoader my side and change some things. I could also stick to old ItemLoader library but there is no easy way, because itemloaders were moved to separate repo, so I cannot simply use some old version of itemLoader with Scrapy 2.4.1. First release of itemloaders is after this change and scrapy 2.4.1 imports itemloaders.\r\n\r\n> Our would it work for you if we simply extended the ItemLoader API with something like set_value to replace any value added so far?\r\n\r\nThere is already replace_value, which is doing what I would need here. I guess the problem is because in the past in many cases loader.add_value was actually replacing value when people intended to add_value, now code relies on this and this creates mess when situation is cleared up."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4036, "url": "https://github.com/scrapy/scrapy/pull/4036#discussion_r580967534"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `media.py`:\n\n```python\nextra={'spider': info.spider}\n                    )\n        return item\n\n    def file_path(self, request, response=None, info=None, item=None):\n        \"\"\"Returns the path where downloaded media should be stored\"\"\"\n        pass\n```"}, {"role": "assistant", "content": "We could do this, but `file_path` or `_file_path` is **not called anywhere** in the `MediaPipeline`, it is only called in its subclasses `ImagesPipeline` and `FilesPipeline` where `file_path` is implemented, so even if a user overrides or uses this class directly `file_path` will not be called. It looks like this class is not meant to be used directly by users according to the docs and I'm guessing that's why its not implemented here. \r\n\r\nHowever if we raise an exception here, I think we should raise the exception in `media_to_download` and `get_media_requests` as well since they are also not implemented?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4686, "url": "https://github.com/scrapy/scrapy/pull/4686#discussion_r465619031"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `typing.py`:\n\n```python\ndef evaluate_forwardref(type_: ForwardRef, globalns: Any, localns: Any) -> Any:\n        return type_._evaluate(globalns, localns)\n\nelif sys.version_info < (3, 12):\nelif sys.version_info < (3, 12, 8):\n```"}, {"role": "assistant", "content": "Ah... guess I misread the bug description. Have amended and force-pushed your suggestion."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11232, "url": "https://github.com/pydantic/pydantic/pull/11232#discussion_r1907447866"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `elasticsearch.py`:\n\n```python\nreturn [self.get(key) for key in keys]\n\n    def delete(self, key):\n        self.server.delete(index=self.index, doc_type=self.doc_type, id=key)\n        if self.doc_type:\n            self.server.delete(index=self.index, id=key, doc_type=self.doc_type)\n        else:\n            self.server.delete(index=self.index, id=key)\n\n    def _get_server(self):\n        \"\"\"Connect to the Elasticsearch server.\"\"\"\n        http_auth = None\n        if self.username and self.password:\n            http_auth = (self.username, self.password)\n        return elasticsearch.Elasticsearch(\n            f'{self.host}:{self.port}',\n            retry_on_timeout=self.es_retry_on_timeout,\n            max_retries=self.es_max_retries,\n            timeout=self.es_timeout,\n            scheme=self.scheme,\n            http_auth=http_auth,\n        )\n        if elasticsearch.VERSION[0] <= 7:\n```"}, {"role": "assistant", "content": "we can try keep support of both 7.x and 8.x for better upgrade ability"}], "_meta": {"repo": "celery/celery", "pr_number": 8519, "url": "https://github.com/celery/celery/pull/8519#discussion_r1331895314"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_cloud_run.py`:\n\n```python\ncloud_run_hook.delete_job(job_name=JOB_NAME, region=REGION, project_id=PROJECT_ID)\n        cloud_run_hook._client.delete_job.assert_called_once_with(delete_request)\n\n    @mock.patch(\n        \"airflow.providers.google.common.hooks.base_google.GoogleBaseHook.__init__\",\n        new=mock_base_gcp_hook_default_project_id,\n    )\n    @mock.patch(\"airflow.providers.google.cloud.hooks.cloud_run.JobsClient\")\n    def test_get_conn_with_transport(self, mock_jobs_client):\n        \"\"\"Test that transport parameter is passed to JobsClient.\"\"\"\n        hook = CloudRunHook(transport=\"rest\")\n        hook.get_credentials = self.dummy_get_credentials\n        hook.get_conn()\n\n        mock_jobs_client.assert_called_once()\n        call_kwargs = mock_jobs_client.call_args[1]\n        assert call_kwargs[\"transport\"] == \"rest\"\n\n    @mock.patch(\n        \"airflow.providers.google.common.hooks.base_google.GoogleBaseHook.__init__\",\n        new=mock_base_gcp_hook_default_project_id,\n    )\n    @mock.patch(\"airflow.providers.google.cloud.hooks.cloud_run.JobsClient\")\n    def test_get_conn_without_transport(self, mock_jobs_client):\n        \"\"\"Test that JobsClient is created with default 'grpc' transport when not specified.\"\"\"\n        hook = CloudRunHook()\n        hook.get_credentials = self.dummy_get_credentials\n        hook.get_conn()\n\n        mock_jobs_client.assert_called_once()\n        call_kwargs = mock_jobs_client.call_args[1]\n        assert call_kwargs[\"transport\"] == \"grpc\"\n```"}, {"role": "assistant", "content": "I. have applied all the suggested changes, do review the PR at your availability"}], "_meta": {"repo": "apache/airflow", "pr_number": 60394, "url": "https://github.com/apache/airflow/pull/60394#discussion_r2706043769"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_aimv2.py`:\n\n```python\ndef get_input_embeddings(self) -> nn.Module:\n        return self.embeddings.patch_embed\n\n    @deprecate_kwarg(\"attention_mask\", version=\"v4.58.0\")\n    @check_model_inputs(tie_last_hidden_states=False)\n    @auto_docstring\n    def forward(\n        self,\n        pixel_values,\n```"}, {"role": "assistant", "content": "As part of vision and vlms refactor, we'll be trying to add/standardize support for attention masks, so we might want to keep that? Cc"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41681, "url": "https://github.com/huggingface/transformers/pull/41681#discussion_r2438843929"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_eomt_fast.py`:\n\n```python\nstacked_images, do_rescale, rescale_factor, do_normalize, image_mean, image_std\n            )\n            processed_images_grouped[shape] = stacked_images\n        images = reorder_images(processed_images_grouped, grouped_images_index)\n        processed_images = reorder_images(processed_images_grouped, grouped_images_index)\n\n        processed_images = torch.stack(images, dim=0) if return_tensors else images\n\n        return processed_images, patch_offsets\n        return BatchFeature(\n            data={\"pixel_values\": processed_images, \"patch_offsets\": patch_offsets},\n            tensor_type=return_tensors,\n            skip_tensor_conversion=[\"patch_offsets\"],\n```"}, {"role": "assistant", "content": "Yep! We used to create the batch then add the non-converted path_offsets, but I fell it's cleaner to be explicit this way"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42750, "url": "https://github.com/huggingface/transformers/pull/42750#discussion_r2607618611"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `quantizer_hqq.py`:\n\n```python\nelse:\n                self.using_multi_gpu = len(set(device_map.values())) > 1\n\n    def update_missing_keys(\n        self, model: \"PreTrainedModel\", missing_keys: list[str], prefix: str, **kwargs\n    ) -> list[str]:\n        if self.pre_quantized:\n            return [key for key in missing_keys if (\"weight\" not in key)]\n        else:\n            return missing_keys\n\n    # Adds missing keys for HQQLinear modules that are loaded but the model with initialized with torch.nn.Linear\n    def update_expected_keys(\n        self, model: \"PreTrainedModel\", expected_keys: list[str], loaded_keys: list[str]\n    ) -> list[str]:\n        if not self.pre_quantized:\n            return expected_keys\n\n        # Collects all quantizable (linear) layers\n        def _find_hqq_quantizable_layers(model, layers):\n            for name, module in model.named_children():\n                if isinstance(module, (torch.nn.Linear)):\n                    layers.add(module.name)\n                _find_hqq_quantizable_layers(module, layers)\n\n        new_keys = set(expected_keys)\n\n        # Name modules\n        for name, module in model.named_modules():\n            module.name = name\n\n        # valid modules are Linear layers that have HQQLinear state_dict. We ignore skip_modules and any layers with Linear state_dict() params\n        _valid_modules = set()\n        _find_hqq_quantizable_layers(model, _valid_modules)\n\n        # Remove skipped modules\n        _skipped_modules = set()\n        for _module in _valid_modules:\n            for _skip_module in model.config.quantization_config[\"skip_modules\"]:\n                if _skip_module in _module:\n                    _skipped_modules.add(_module)\n        _valid_modules -= _skipped_modules\n\n        # Append new expected layers based on _ref_keys\n        _ref_keys = HQQLinear(\n            linear_layer=None,\n            quant_config=None,\n            compute_dtype=torch.float16,\n            device=\"cpu\",\n            del_orig=False,\n        ).state_dict_keys() - {\"bias\"}\n\n        # Clean-up\n        _rm_keys = set()\n        for key in new_keys:\n            if any(_module in key for _module in _valid_modules):\n                _rm_keys.add(key)\n        new_keys -= _rm_keys\n        # At this point, new_keys contains all the keys of the layers that are NOT HQQLinear or torch.nn.Linear\n\n        # Re-populate Linear/HQQLinear\n        for _module in _valid_modules:\n            if _module + \".weight\" in loaded_keys:\n                new_keys.add(_module + \".weight\")\n            else:\n                new_keys.update({_module + \".\" + _ref_key for _ref_key in _ref_keys})\n            if _module + \".bias\" in loaded_keys:\n                new_keys.add(_module + \".bias\")\n\n        return list(new_keys)\n    # TODO: to remove\n    # # Adds missing keys for HQQLinear modules that are loaded but the model with initialized with torch.nn.Linear\n```"}, {"role": "assistant", "content": "```suggestion\n    # TODO: to remove\n    # Kept here in case we see some interest in adding support for it\n    # # Adds missing keys for HQQLinear modules that are loaded but the model with initialized with torch.nn.Linear\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42633, "url": "https://github.com/huggingface/transformers/pull/42633#discussion_r2591482040"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\n_grad_norm = self.optimizer.clip_master_grads(args.max_grad_norm)\n                            else:\n                                grad_norm_context = contextlib.nullcontext\n                                if self.is_tp_enabled:\n                                if self.is_tp_enabled and not self.is_fsdp_enabled:\n```"}, {"role": "assistant", "content": "why this won't work in case of fsdpv2 ? Also it seems that we are getting rid of dtensor for tp here so this will probably change https://github.com/huggingface/transformers/pull/43157#issuecomment-3738339409"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43226, "url": "https://github.com/huggingface/transformers/pull/43226#discussion_r2683060455"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_trainer.py`:\n\n```python\nfinal_model_path = os.path.join(final_checkpoint_path, SAFE_WEIGHTS_NAME)\n        self.assertTrue(os.path.exists(final_model_path), \"Final model checkpoint was not saved!\")\n\n    def test_resume_batch_order(self):\n        \"\"\"\n        Test that verifies dataloader order is reproducible when resuming from partial checkpoints.\n        Tests resuming from checkpoint 7 (within epoch 1).\n        \"\"\"\n\n        # --- Helper classes and functions defined locally for this test ---\n        class DummyDataset(torch.utils.data.Dataset):\n            def __init__(self, size: int = 32):\n                self.size = size\n                self.data = torch.randn((size, 10))\n                self.data[:, 0] = torch.arange(0, size)  # Encode the data order\n                self.labels = torch.randint(0, 10, (size,))\n\n            def __len__(self) -> int:\n                return self.size\n\n            def __getitem__(self, idx: int):\n                return {\"input_ids\": self.data[idx], \"labels\": self.labels[idx]}\n\n        class DummyModel(nn.Module):\n            def __init__(self, size: int):\n                super().__init__()\n                self.fc = nn.Linear(10, 10, bias=False)\n                # data_order logs the order of data points seen by the model\n                self.register_buffer(\"data_order\", torch.empty(0, dtype=torch.long))\n\n            def load_state_dict(self, state_dict, strict=True):\n                # Handle data_order buffer size mismatch during checkpoint loading\n                if \"data_order\" in state_dict:\n                    saved_data_order = state_dict[\"data_order\"]\n                    if hasattr(self, \"data_order\") and self.data_order.shape != saved_data_order.shape:\n                        # Resize the buffer to match the saved state\n                        self.data_order = saved_data_order.clone()\n\n                return super().load_state_dict(state_dict, strict=strict)\n\n            def forward(self, input_ids: torch.Tensor, labels: torch.Tensor = None):\n                logits = self.fc(input_ids)\n                loss = None\n                if labels is not None:\n                    loss_fn = nn.CrossEntropyLoss()\n                    loss = loss_fn(logits, labels)\n\n                # Log the data order for verification\n                data_indices = input_ids[:, 0].int()\n                self.data_order = torch.cat([self.data_order, data_indices.detach().clone()])\n\n                return {\"loss\": loss, \"logits\": logits}\n\n        # Scenario 1: Run baseline training to completion\n        # 1.1 Run training to completion\n        set_seed(42)\n        train_dataset = DummyDataset(size=10)\n        model_baseline = DummyModel(size=10)\n```"}, {"role": "assistant", "content": "it only creates 3 checkpoints, I think the dataset you created is too small."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40691, "url": "https://github.com/huggingface/transformers/pull/40691#discussion_r2490690965"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `stream.py`:\n\n```python\nArguments:\n            delta -- Window change delta\n        \"\"\"\n        if self.remaining_content_length > 0 and not self.stream_closed_local:\n        if self.stream_closed_local is False:\n```"}, {"role": "assistant", "content": ":lipstick: \r\n\r\n```suggestion\r\n        if not self.stream_closed_local:\r\n```\r\n\r\nUnless it can be something else (`None`), which would be a bit confusing."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r441681999"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_type_adapter.py`:\n\n```python\nassert exc_info.value.errors(include_url=False) == [\n        {'type': 'list_type', 'loc': (), 'msg': 'Input should be a valid list', 'input': 'not a list'}\n    ]\n\n\n@pytest.mark.parametrize('defer_build', [False, True])\n@pytest.mark.parametrize('defer_build_mode', [('model',), ('type_adapter',), ('model', 'type_adapter')])\n@pytest.mark.parametrize('is_annotated', [False, True])  # FastAPI heavily uses Annotated\ndef test_respects_defer_build(\n    defer_build: bool, defer_build_mode: Tuple[Literal['model', 'type_adapter']], is_annotated: bool\n) -> None:\n    class Model(BaseModel, defer_build=defer_build, _defer_build_mode=defer_build_mode):\n        x: int\n\n    class SubModel(Model):\n        y: Optional[int] = None\n\n    @pydantic_dataclass(config=ConfigDict(defer_build=defer_build, _defer_build_mode=defer_build_mode))\n    class DataClassModel:\n        x: int\n\n    @pydantic_dataclass\n    class SubDataClassModel(DataClassModel):\n        y: Optional[int] = None\n\n    class TypedDictModel(TypedDict):\n        __pydantic_config__ = ConfigDict(defer_build=defer_build, _defer_build_mode=defer_build_mode)  # type: ignore\n        x: int\n\n    models: list[tuple[type, Optional[ConfigDict]]] = [\n        (Model, None),\n        (SubModel, None),\n        (create_model('DynamicModel', __base__=Model), None),\n        (create_model('DynamicSubModel', __base__=SubModel), None),\n        (DataClassModel, None),\n        (SubDataClassModel, None),\n        (TypedDictModel, None),\n        (Dict[str, int], ConfigDict(defer_build=defer_build, _defer_build_mode=defer_build_mode)),\n    ]\n\n    for model, adapter_config in models:\n        tested_model = Annotated[model, Field(title='abc')] if is_annotated else model\n\n        ta = TypeAdapter(tested_model, config=adapter_config)\n        if defer_build and 'type_adapter' in defer_build_mode:\n            assert not ta._schema_initialized, f'{tested_model} should be built deferred'\n        else:\n            assert ta._schema_initialized\n\n        validated = ta.validate_python({'x': 1})  # Sanity check it works\n```"}, {"role": "assistant", "content": "Done, added tests for serialization/validation also"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 8939, "url": "https://github.com/pydantic/pydantic/pull/8939#discussion_r1533979449"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dataclass_no_any.py`:\n\n```python\nfrom pydantic import ConfigDict\n```"}, {"role": "assistant", "content": "```suggestion\r\n```\r\nIs that necessary any more? It looks unused now"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10522, "url": "https://github.com/pydantic/pydantic/pull/10522#discussion_r1783502793"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_api.py`:\n\n```python\nauth: AuthTypes | None = None,\n    proxy: ProxyTypes | None = None,\n    follow_redirects: bool = False,\n    cert: CertTypes | None = None,\n    verify: VerifyTypes = True,\n    ssl_context: typing.Optional[ssl.SSLContext] = None,\n```"}, {"role": "assistant", "content": "```suggestion\r\n    ssl_context: ssl.SSLContext | None = None,\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 3022, "url": "https://github.com/encode/httpx/pull/3022#discussion_r1790228710"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_continuous_batching.py`:\n\n```python\ngenerate_outputs = model.generate(**inputs.to(torch_device), generation_config=model.generation_config)\n\n        for i, user_message in enumerate(user_messages):\n            continuous_batching_output = continuous_batching_outputs[f\"req_{i}\"].generated_tokens\n            # Find the corresponding request in the continuous batching outputs\n            input_tokens = inputs.input_ids[i][inputs.attention_mask[i] == 1].tolist()\n            key_to_pop = None\n            for key, state in continuous_batching_outputs.items():\n                if state.prompt_ids == input_tokens:\n                    key_to_pop = key\n                    break\n            if key_to_pop is None:\n                self.fail(f\"Request {i} not found in continuous batching outputs\")\n```"}, {"role": "assistant", "content": "Used to be that, but we sort requests when prefix sharing is enabled, so it shuffles the order and breaks the correspondance."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42839, "url": "https://github.com/huggingface/transformers/pull/42839#discussion_r2619813596"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `mode.py`:\n\n```python\nstr(int(self.is_ipynb)),\n            str(int(self.magic_trailing_comma)),\n            str(int(self.experimental_string_processing)),\n            \",\".join(sorted(self.python_cell_magics)),\n```"}, {"role": "assistant", "content": "Good point. Maybe we can hash the value with some consistent hashing algorithm available in the stdlib."}], "_meta": {"repo": "psf/black", "pr_number": 2744, "url": "https://github.com/psf/black/pull/2744#discussion_r786103716"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `masking_utils.py`:\n\n```python\nallow_is_causal_skip (`bool`, optional):\n            Whether to allow to return `None` for the mask under conditions where we can use the `is_causal` argument in\n            `torch.sdpa` instead. Default to `True`.\n        allow_torch_fix (`bool`, optional):\n            Whether to update the mask in case a query is not attending to any tokens, to solve a bug in torch's older\n            versions. We need an arg to skip it when using eager. By default `True`.\n```"}, {"role": "assistant", "content": "Doubled comment, unrelated but should be removed nonetheless. Slipped through"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42325, "url": "https://github.com/huggingface/transformers/pull/42325#discussion_r2549859530"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\n`report` is where output about exclusions goes.\n    \"\"\"\n\n    def is_ignored(\n        gitignore_dict: Dict[Path, PathSpec], child: Path, report: Report\n    ) -> bool:\n        for _dir, _gitignore in gitignore_dict.items():\n            relative_path = normalize_path_maybe_ignore(child, _dir, report)\n            if relative_path is None:\n                continue\n```"}, {"role": "assistant", "content": "Yeah, seems like the `continue` produces additional unnecessary output. I'll replace it with `break` so that the function returns `False`"}], "_meta": {"repo": "psf/black", "pr_number": 3338, "url": "https://github.com/psf/black/pull/3338#discussion_r1000839355"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `proxy_http.py`:\n\n```python\nresponse=proxy_response,\n            )\n        else:\n            proxy_response.on_close = None\n            await proxy_response.read()\n            # Hack to ingest the response, without closing it.\n            async for chunk in proxy_response._raw_stream:\n                pass\n```"}, {"role": "assistant", "content": "Actually this point in the code surprised me too. Yes I think we're making sure that we maintain the connection. However I *actually* think that this is highlighting an issue here. I *think* that we probably actually want an explicit \"proxy being established state\" on the HTTP Connection, that will play into the stuff I was starting to think about on https://github.com/encode/httpx/pull/624. It wouldn't at all surprise me if we have some buggy behavior aroung this, such as later maintaining proxy connections that ought to have become closed."}], "_meta": {"repo": "encode/httpx", "pr_number": 648, "url": "https://github.com/encode/httpx/pull/648#discussion_r359823694"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `accelerate.py`:\n\n```python\ndispatch_model(model, **device_map_kwargs)\n\n\ndef get_disk_only_shard_files(device_map, weight_map):\n    \"\"\"\n    Returns the list of shard files containing only weights offloaded to disk.\n    \"\"\"\n    files_content = defaultdict(list)\n    for weight_name, filename in weight_map.items():\n        while len(weight_name) > 0 and weight_name not in device_map:\n            weight_name = \".\".join(weight_name.split(\".\")[:-1])\n        files_content[filename].append(device_map[weight_name])\n\n    return [fname for fname, devices in files_content.items() if set(devices) == {\"disk\"}]\n\n\ndef expand_device_map(device_map, param_names):\n    \"\"\"\n    Expand a device map to return the correspondence parameter name to device.\n    \"\"\"\n    # Here, we first sort by number of submodules, then length of the full string, to make sure to match correctly\n    device_map_regex = re.compile(\n        \"|\".join(rf\"({k})\" for k in sorted(device_map.keys(), key=lambda x: (x.count(\".\"), len(x)), reverse=True))\n    )\n    new_device_map = {}\n    for module, device in device_map.items():\n        new_device_map.update(\n            {p: device for p in param_names if p == module or p.startswith(f\"{module}.\") or module == \"\"}\n        )\n    for param in param_names:\n        device_match = device_map_regex.match(param)\n        new_device_map[param] = device_map[device_match.group()] if device_match else device_map.get(\"\", \"cpu\")\n\n    return new_device_map\n\n\ndef accelerate_disk_offload(\n    disk_offload_folder,\n    checkpoint_files,\n    device_map,\n    checkpoint_keys,\n    sharded_metadata,\n    dtype,\n    disk_offload_folder: str | None,\n    checkpoint_files: list[str] | None,\n    device_map: dict,\n    expected_keys: list[str],\n    sharded_metadata: dict | None,\n    dtype: torch.dtype | None,\n    weight_mapping=None,\n):\n    disk_only_shard_files = []\n    from ..core_model_loading import WeightRenaming, build_glob_alternation, repl\n```"}, {"role": "assistant", "content": "just missing a doc about \"weights that are only renamed are not saved twice\" or something like that"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42242, "url": "https://github.com/huggingface/transformers/pull/42242#discussion_r2556106698"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `logstats.py`:\n\n```python\nself.task.start(self.interval)\n\n    def log(self, spider):\n        items = self.stats.get_value('item_scraped_count', 0)\n        pages = self.stats.get_value('response_received_count', 0)\n        irate = (items - self.itemsprev) * self.multiplier\n        prate = (pages - self.pagesprev) * self.multiplier\n        self.pagesprev, self.itemsprev = pages, items\n        self.calculate_stats()\n\n        msg = (\"Crawled %(pages)d pages (at %(pagerate)d pages/min), \"\n               \"scraped %(items)d items (at %(itemrate)d items/min)\")\n        log_args = {'pages': pages, 'pagerate': prate,\n                    'items': items, 'itemrate': irate}\n        log_args = {'pages': self.pages, 'pagerate': self.prate,\n                    'items': self.items, 'itemrate': self.irate}\n        logger.info(msg, log_args, extra={'spider': spider})\n\n    def spider_closed(self, spider, reason):\n        if self.task and self.task.running:\n            self.task.stop()\n\n        self.calculate_stats()\n        self.stats.set_value('IPM', self.irate)\n        self.stats.set_value('RPM', self.prate)\n```"}, {"role": "assistant", "content": "Thanks ! I'll update this one along with the tests. Please don't merge this one yet as I'd like to have tests on this module. Marking it as `WIP:` at the moment."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4111, "url": "https://github.com/scrapy/scrapy/pull/4111#discussion_r340539659"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_compression.py`:\n\n```python\nimport brotli\nexcept ImportError:\n    pass\nelse:\n    try:\n        brotli.Decompressor.process\n    except AttributeError:\n\n        def _brotli_decompress(decompressor, data):\n```"}, {"role": "assistant", "content": "Should we add a warning here?\r\n\r\nBy the way `brotlipy` is now `brotlicffi` (with the import name adjusted accordingly), but whether we need to add support for it is a separate question."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6261, "url": "https://github.com/scrapy/scrapy/pull/6261#discussion_r1508690276"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `serialized_dag.py`:\n\n```python\nreturn [cls._sort_serialized_dag_dict(i) for i in serialized_dag]\n        return serialized_dag\n\n    @classmethod\n    def _process_deadline_alerts(\n        cls,\n        serialized_dag_id: str,\n        dag_data: dict[str, Any],\n        session: Session,\n    ) -> bool:\n        \"\"\"\n        Process DeadlineAlerts for a Dag during serialization.\n\n        Creates or finds deadline_alert records in the database and replaces\n        the deadline field in dag_data with UUID references.\n\n        :param serialized_dag_id: The serialized_dag id\n        :param dag_data: The serialized Dag data dictionary (will be modified in place)\n        :param session: Database session\n        \"\"\"\n        dag_deadline_data = dag_data.get(\"dag\", {}).get(\"deadline\")\n        if not dag_deadline_data:\n            return False\n\n        log.debug(\"Processing DeadlineAlerts for Dag: %s\", serialized_dag_id)\n\n        deadline_alerts = dag_deadline_data if isinstance(dag_deadline_data, list) else [dag_deadline_data]\n        deadline_alert_ids = []\n        new_alerts = []\n\n        for deadline_alert in deadline_alerts:\n            deadline_data = deadline_alert.get(Encoding.VAR, deadline_alert)\n\n            reference = deadline_data[DeadlineAlertFields.REFERENCE]\n            interval = deadline_data[DeadlineAlertFields.INTERVAL]\n            callback = deadline_data[DeadlineAlertFields.CALLBACK]\n\n            # This looks odd, but I had issues comparing the serialized data directly\n            # while doing manual testing. To avoid them, we fetch by dag_id and interval,\n            # then use python's dict comparison instead of trying to match strings in SQL.\n            candidates = (\n                session.execute(\n                    select(DeadlineAlertModel).filter(\n                        DeadlineAlertModel.serialized_dag_id == serialized_dag_id,\n                        DeadlineAlertModel.interval == interval,\n                    )\n                )\n                .scalars()\n```"}, {"role": "assistant", "content": "```suggestion\r\n                session.scalars(\r\n                    select(DeadlineAlertModel).where(\r\n                        DeadlineAlertModel.serialized_dag_id == serialized_dag_id,\r\n                        DeadlineAlertModel.interval == interval,\r\n                    )\r\n                )\r\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 58248, "url": "https://github.com/apache/airflow/pull/58248#discussion_r2563802006"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `canvas.py`:\n\n```python\nreturn callback\n\n    def link_error(self, errback):\n        if self.app.conf.task_allow_error_cb_on_chord_header:\n            # self.tasks can be a list of the chord header workflow.\n            if isinstance(self.tasks, list):\n                for task in self.tasks:\n                    task.link_error(errback)\n            else:\n                self.tasks.link_error(errback)\n        else:\n            warnings.warn(\n                \"task_allow_error_cb_on_chord_header=False is pending deprecation in \"\n```"}, {"role": "assistant", "content": "Currently to make the Enabled state the default when the previous behavior will be fully deprecated. But this is subject to change."}], "_meta": {"repo": "celery/celery", "pr_number": 7712, "url": "https://github.com/celery/celery/pull/7712#discussion_r951333226"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dataclasses.py`:\n\n```python\ncls.__pydantic_complete__ = pydantic_complete  # type: ignore\n        return cls\n\n    if _cls is None:\n        return create_dataclass\n\n    return create_dataclass(_cls)\n    return create_dataclass if _cls is None else create_dataclass(_cls)\n```"}, {"role": "assistant", "content": "One nice thing about this new approach is that it removes the need for the noqa above"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9843, "url": "https://github.com/pydantic/pydantic/pull/9843#discussion_r1683251963"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `comms.py`:\n\n```python\nerr_decoder: TypeAdapter[ErrorResponse] = attrs.field(factory=lambda: TypeAdapter(ToTask), repr=False)\n\n    # Threading lock for sync operations\n    _thread_lock: threading.Lock = attrs.field(factory=threading.Lock, repr=False)\n    # Async lock for async operations\n    _async_lock: asyncio.Lock = attrs.field(factory=asyncio.Lock, repr=False)\n```"}, {"role": "assistant", "content": "This is worth consolidating with the async lock on Trigger since `TriggerCommsDecoder` inherits this\n\nhttps://github.com/apache/airflow/blob/0b341e6b92040360f86f5697da119c58a91aa4c2/airflow-core/src/airflow/jobs/triggerer_job_runner.py#L783"}], "_meta": {"repo": "apache/airflow", "pr_number": 59087, "url": "https://github.com/apache/airflow/pull/59087#discussion_r2672640943"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_multipart.py`:\n\n```python\ndef __init__(self, name: str, value: typing.Union[str, bytes]) -> None:\n        if not isinstance(name, str):\n            raise TypeError(\"Invalid type for name. Expected str.\")\n            raise TypeError(f\"Invalid type for name. Expected str, \"\n                            f\"got {type(name).__name__}: {name!r}\")\n        if not isinstance(value, (str, bytes)):\n            raise TypeError(\"Invalid type for value. Expected str or bytes.\")\n            raise TypeError(f\"Invalid type for value. Expected str or bytes, \"\n                            f\"got {type(value).__name__}: {value!r}\")\n```"}, {"role": "assistant", "content": "```suggestion\r\n            raise TypeError(\r\n                f\"Invalid type for value. Expected str or bytes, got {type(value)}: {value!r}\"\r\n            )\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1368, "url": "https://github.com/encode/httpx/pull/1368#discussion_r511991985"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nif dataloader is None:\n                logger.warning(\"failed to use PyTorch jit mode due to current dataloader is none.\")\n                return model\n            jit_inputs = []\n            example_batch = next(iter(dataloader))\n            for key in example_batch:\n                example_tensor = torch.ones_like(example_batch[key])\n                jit_inputs.append(example_tensor)\n            jit_inputs = tuple(jit_inputs)\n            example_batch = self._prepare_inputs(example_batch)\n            try:\n                jit_model = model.eval()\n                with ContextManagers([self.autocast_smart_context_manager(), torch.no_grad()]):\n                    jit_model = torch.jit.trace(jit_model, jit_inputs, strict=False)\n                with ContextManagers([self.autocast_smart_context_manager(cache_enabled=False), torch.no_grad()]):\n                    if version.parse(version.parse(torch.__version__).base_version) >= version.parse(\"1.14.0\"):\n                        if isinstance(example_batch, dict):\n                            jit_model = torch.jit.trace(jit_model, example_kwarg_inputs=example_batch, strict=False)\n                        else:\n                            jit_model = torch.jit.trace(\n                                jit_model,\n                                example_kwarg_inputs={key: example_batch[key] for key in example_batch},\n                                strict=False,\n                            )\n```"}, {"role": "assistant", "content": "I don't fully understand this path here, as `example_batch` is not a dict here, but you are using it as one."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 19891, "url": "https://github.com/huggingface/transformers/pull/19891#discussion_r1011701958"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `reactor.py`:\n\n```python\nreturn self._func(*self._a, **self._kw)\n\n\ndef install_reactor(reactor_path):\ndef install_reactor(reactor_path, event_loop_path=None):\n    \"\"\"Installs the :mod:`~twisted.internet.reactor` with the specified\n    import path.\"\"\"\n    import path. Also installs the asyncio event loop with the specified import\n    path if the asyncio reactor is enabled\"\"\"\n    reactor_class = load_object(reactor_path)\n    if reactor_class is asyncioreactor.AsyncioSelectorReactor:\n        with suppress(error.ReactorAlreadyInstalledError):\n            asyncioreactor.install(asyncio.get_event_loop())\n            if event_loop_path is not None:\n                event_loop_class = load_object(event_loop_path)\n                event_loop = event_loop_class()\n                asyncio.set_event_loop(event_loop)\n            asyncioreactor.install()\n```"}, {"role": "assistant", "content": "Interesting. However, maybe we should avoid calling `asyncio.set_event_loop()`. Changing the default loop globally may cause unexpected issues in projects that execute another asyncio loop after the Scrapy-based crawling finishes."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4414, "url": "https://github.com/scrapy/scrapy/pull/4414#discussion_r398017430"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dependency_versions_table.py`:\n\n```python\n\"opentelemetry-api\": \"opentelemetry-api\",\n    \"opentelemetry-exporter-otlp\": \"opentelemetry-exporter-otlp\",\n    \"opentelemetry-sdk\": \"opentelemetry-sdk\",\n    \"sudachipy\": \"sudachipy>=0.6.6\",\n```"}, {"role": "assistant", "content": "this file was updated by `make fix-repo` - not sure why it changed the order, I will revert, run `make fix-repo` and see if it keeps it unchanged"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43490, "url": "https://github.com/huggingface/transformers/pull/43490#discussion_r2745344151"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auth.py`:\n\n```python\nimport hashlib\nimport json\nimport os\nimport typing\n\nimport httpcore\nimport pytest\n\nfrom httpx import (\n    URL,\n    AsyncClient,\n    Auth,\n    DigestAuth,\n    Headers,\n    ProtocolError,\n    Request,\n    RequestBodyUnavailable,\n    Response,\n)\nfrom httpx._config import CertTypes, TimeoutTypes, VerifyTypes\nfrom httpx._dispatch.base import AsyncDispatcher\nfrom httpx._content_streams import ContentStream, JSONStream\n\n\nclass MockDispatch(AsyncDispatcher):\n    def __init__(self, auth_header: str = \"\", status_code: int = 200) -> None:\ndef get_header_value(headers, key, default=None):\n    lookup = key.encode(\"ascii\").lower()\n    for header_key, header_value in headers:\n        if header_key.lower() == lookup:\n            return header_value.decode(\"ascii\")\n    return default\n\n\nclass MockDispatch(httpcore.AsyncHTTPProxy):\n    def __init__(self, auth_header: bytes = b\"\", status_code: int = 200) -> None:\n        self.auth_header = auth_header\n        self.status_code = status_code\n\n    async def send(\n    async def request(\n        self,\n        request: Request,\n        verify: VerifyTypes = None,\n        cert: CertTypes = None,\n        timeout: TimeoutTypes = None,\n    ) -> Response:\n        headers = [(\"www-authenticate\", self.auth_header)] if self.auth_header else []\n        body = json.dumps({\"auth\": request.headers.get(\"Authorization\")}).encode()\n        return Response(\n            self.status_code, headers=headers, content=body, request=request\n        method: bytes,\n        url: typing.Tuple[bytes, bytes, int, bytes],\n        headers: typing.List[typing.Tuple[bytes, bytes]],\n        stream: ContentStream,\n        timeout: typing.Dict[str, typing.Optional[float]] = None,\n    ) -> typing.Tuple[\n        bytes, int, bytes, typing.List[typing.Tuple[bytes, bytes]], ContentStream\n    ]:\n        authorization = get_header_value(headers, \"Authorization\")\n        response_headers = (\n            [(b\"www-authenticate\", self.auth_header)] if self.auth_header else []\n        )\n        response_stream = JSONStream({\"auth\": authorization})\n        return b\"HTTP/1.1\", self.status_code, b\"\", response_headers, response_stream\n\n\nclass MockDigestAuthDispatch(AsyncDispatcher):\nclass MockDigestAuthDispatch(httpcore.AsyncHTTPProxy):\n```"}, {"role": "assistant", "content": "Why does this have to be an `HTTPProxy` now? (Is it an oversight?)"}], "_meta": {"repo": "encode/httpx", "pr_number": 804, "url": "https://github.com/encode/httpx/pull/804#discussion_r388512691"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `convert_glm4v_moe_mgt_weights_to_hf.py`:\n\n```python\n\"n_shared_experts\": text_config.get(\"n_shared_experts\", 1),\n        \"norm_topk_prob\": text_config.get(\"norm_topk_prob\", True),\n        \"num_experts_per_tok\": text_config.get(\"num_experts_per_tok\", 8),\n        \"rope_scaling\": {\"type\": \"default\", \"mrope_section\": [8, 12, 12]},\n```"}, {"role": "assistant", "content": "In the main branch it is now called `rope_parameters` and also includes the theta inside the dict. So maybe\n\n`\"rope_scaling\": {\"rope_type\": \"default\", \"rope_theta\": 10000.0, \"mrope_section\": [8, 12, 12]},`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41784, "url": "https://github.com/huggingface/transformers/pull/41784#discussion_r2452638417"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\nraise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')\n\n        def __setattr__(self, name: str, value: Any) -> None:\n            if name in self.__class_vars__:\n            if (setattr_handler := self.__pydantic_setattr_handlers__.get(name)) is not None:\n                setattr_handler(self, name, value)\n            elif (setattr_handler := self._setattr_handler(name, value)) is not None:\n                setattr_handler(self, name, value)  # call here to not memo on possibly unknown fields\n                self.__pydantic_setattr_handlers__[name] = setattr_handler  # memoize the handler for faster access\n\n        def _setattr_handler(self, name: str, value: Any) -> Callable[[BaseModel, Any, Any], None] | None:\n            \"\"\"Get a handler for setting an attribute on the model instance.\n\n            Returns:\n                A handler for setting an attribute on the model instance. Used for memoization of the handler.\n```"}, {"role": "assistant", "content": "Can you give a bit more context here for folks who might be diving into this code for the first time on memoization and why it's helpful? Feel free to put that in the main docstring description, thanks!"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10868, "url": "https://github.com/pydantic/pydantic/pull/10868#discussion_r1848321691"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_emu3.py`:\n\n```python\nlogger = logging.get_logger(__name__)\n\n\n@dataclass\n@auto_docstring\nclass Emu3VQVAEModelOutput(BaseModelOutputWithPooling):\n    r\"\"\"\n    image_tokens (`torch.FloatTensor` of shape `(batch_size, config.vocab_size`):\n        Indices of the image tokens predicted by the VQ-VAE model.\n    \"\"\"\n\n    image_tokens: torch.FloatTensor | None = None\n```"}, {"role": "assistant", "content": "Yess, you're right. Updated to LongTensor in de56122695e8157fb52953aa3c4538e97eedc425"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2694139139"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `serialized_dag.py`:\n\n```python\nserialized_dag_hash = session.scalars(\n            select(cls.dag_hash).where(cls.dag_id == dag.dag_id).order_by(cls.created_at.desc())\n        ).first()\n        dag_version = DagVersion.get_latest_version(dag.dag_id, session=session)\n        dag_version = DagVersion.get_latest_version(dag.dag_id, session=session, load_dag_model=True)\n```"}, {"role": "assistant", "content": "Thanks, that makes sense. For now, I reused the existing load_dag_model flag since it already covers eager-loading of serialized_dag.\r\nIf you prefer, I can rename it to load_serialized_dag for better clarity \u2014 let me know what you think."}], "_meta": {"repo": "apache/airflow", "pr_number": 56422, "url": "https://github.com/apache/airflow/pull/56422#discussion_r2433094186"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nif maybe_schema is not None:\n                return maybe_schema\n\n            schema = cls.__dict__.get('__pydantic_core_schema__')\n            if (\n                schema is not None\n                and not isinstance(schema, MockCoreSchema)\n                # Due to the way generic classes are built, it's possible that an invalid schema may be temporarily\n                # set on generic classes. Probably we could resolve this to ensure that we get proper schema caching\n                # for generics, but for simplicity for now, we just always rebuild if the class has a generic origin:\n                and not cls.__pydantic_generic_metadata__['origin']\n            ):\n```"}, {"role": "assistant", "content": "did a good job at intuitively extracting some of this logic as follows:\r\n\r\n```py\r\ndef get_existing_core_schema(obj: Any) -> core_schema.CoreSchema | None:\r\n    # Only use the cached value from this _exact_ class; we don't want one from a parent class\r\n    # This is why we check `cls.__dict__` and don't use `cls.__pydantic_core_schema__` or similar.\r\n    if (\r\n        hasattr(obj, '__dict__')\r\n        and (existing_schema := obj.__dict__.get('__pydantic_core_schema__')) is not None\r\n        and not isinstance(existing_schema, MockCoreSchema)\r\n    ):\r\n        return existing_schema\r\n    return None\r\n```\r\n\r\nMaybe we could eagerly pull changes like that into this PR, given that https://github.com/pydantic/pydantic/pull/10655 isn't quite ready to merge yet?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10863, "url": "https://github.com/pydantic/pydantic/pull/10863#discussion_r1848393876"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asset.py`:\n\n```python\nDagScheduleAssetAliasReference,\n        TaskOutletAssetReference,\n    ]\n    for model in models_to_check:\n        session.execute(\n            delete(model)\n            .where(model.dag_id.in_(select(DagModel.dag_id).where(DagModel.is_stale)))\n            .execution_options(synchronize_session=\"fetch\")\n        )\n```"}, {"role": "assistant", "content": "I'd add a comment here for posterity (also preventing future us trying to \"optimise\" this and make it into single query."}], "_meta": {"repo": "apache/airflow", "pr_number": 60166, "url": "https://github.com/apache/airflow/pull/60166#discussion_r2667608259"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\n@property\n    def defined_constraints(self) -> dict[str, Any]:\n        \"\"\"Fetch a key / value mapping of constraints to values that are not None. Used for core schema updates.\"\"\"\n        return {field.name: getattr(self, field.name) for field in fields(self)}\n        return {field.name: value for field in fields(self) if (value := getattr(self, field.name)) is not None}\n\n    def __get_pydantic_core_schema__(self, source: Any, handler: GetCoreSchemaHandler) -> core_schema.CoreSchema:\n        schema = handler(source)\n\n        if schema['type'] == 'function-wrap':\n            # for function-wrap schemas, url constraints is applied to the inner schema\n            inner = schema['schema']\n\n            if annotated_type := inner['type'] not in ('url', 'multi-host-url'):\n                raise PydanticUserError(\n                    f\"'UrlConstraints' cannot annotate '{annotated_type}'.\", code='invalid-annotated-type'\n                )\n            for constraint_key, constraint_value in self.defined_constraints.items():\n                inner[constraint_key] = constraint_value\n            schema['schema'] = inner\n```"}, {"role": "assistant", "content": "This seems like a noop (inner is mutated but not recreated).\r\n\r\n```suggestion\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10922, "url": "https://github.com/pydantic/pydantic/pull/10922#discussion_r1852398813"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nfor header in headers:\n            self[header] = headers[header]\n\n    def copy(self) -> \"Headers\":\n        return Headers(self.items(), encoding=self.encoding)\n```"}, {"role": "assistant", "content": "Also I noticed the same thing can be done already with the class constructor, but happy to roll this change back if you prefer \ud83d\ude42 \r\nhttps://github.com/encode/httpx/blob/21d7e16559d9360ae3a5c5cfd23bab8bb85ee4a8/httpx/_models.py#L391"}], "_meta": {"repo": "encode/httpx", "pr_number": 1003, "url": "https://github.com/encode/httpx/pull/1003#discussion_r431711258"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\n},\n        )\n\n    def _path_schema(self, tp: Any, path_type: Any) -> CoreSchema:\n        if tp is os.PathLike and path_type not in {str, bytes, Any}:\n```"}, {"role": "assistant", "content": "We need to account for `typing.Any` and `typing_extensions.Any`, something like:\r\n\r\n```suggestion\r\n        if tp is os.PathLike and path_type not in {str, bytes} or not _typing_extra.is_any(tp):\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10846, "url": "https://github.com/pydantic/pydantic/pull/10846#discussion_r1876052262"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\n# properly closed.\n            return defer.maybeDeferred(slot.storage.store, slot.file)\n        slot.finish_exporting()\n        logfmt = \"%s %%(format)s feed (%%(itemcount)d items) in: %%(uri)s\"\n        log_args = {'format': slot.format,\n                    'itemcount': slot.itemcount,\n                    'uri': slot.uri}\n        logfmt = f\"{slot.format} feed ({str(slot.itemcount)} items) in: {slot.uri}\"\n```"}, {"role": "assistant", "content": "As this is no longer a format string, it can be renamed to something like \"logmsg\" I think."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5246, "url": "https://github.com/scrapy/scrapy/pull/5246#discussion_r715444218"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `strategy.py`:\n\n```python\nlimit_task = consumer._limit_task\n    limit_post_eta = consumer._limit_post_eta\n    Request = symbol_by_name(task.Request)\n    Req = create_request_cls(Request, task, consumer.pool, hostname, eventer, app=app)\n    Req = create_request_cls(Request, task, consumer.pool, hostname, eventer,\n                             app=app)\n\n    revoked_tasks = consumer.controller.state.revoked\n    eta_task_limit = getattr(app.conf, 'worker_eta_task_limit', None)\n\n    class ETATaskTracker:\n        \"\"\"Track ETA tasks to enforce limits.\"\"\"\n        def __init__(self):\n            self.count = 0\n\n        def check_limit(self, req):\n            if eta_task_limit is not None and self.count >= eta_task_limit:\n                info(\"ETA task limit reached (%s/%s), rejecting task %s\",\n                     self.count, eta_task_limit, req.id)\n                req.reject(requeue=True)\n                return True\n\n            self.count += 1\n            return False\n\n        def create_callback(self, req, original_callback):\n            def eta_callback(*args):\n                self.count = max(0, self.count - 1)\n                return original_callback(*args)\n            eta_callback.__name__ = 'eta_callback'\n            return eta_callback\n\n    eta_tracker = ETATaskTracker()\n    # Apply ETA task limit to QoS prefetch count if configured\n    if eta_task_limit is not None:\n        # Set a maximum prefetch count to limit ETA tasks\n        original_prefetch = consumer.qos.value\n        consumer.qos.value = min(original_prefetch, eta_task_limit)\n        consumer.qos.set(consumer.qos.value)\n```"}, {"role": "assistant", "content": "Thanks for the quick update ! But are you sure this works ? It seems that this code would be executed only once during the strategy initialization ? But the actual incrementation of prefetch count is done on each task fetching inside `task_message_handler` (here for example). So maybe it should be moved there.\r\n\r\nHowever, I still believe that this should more appear in kombu ? For example when you define the consumer or consumer.qos you would pass it the prefetch limit. And when you call `consumer.qos.increment_eventually()` it would not increment after the limit is reached. The benefit of this approach is that you don't violate the single responsibility principle, and the cap of prefetch count would be transparent here when done in kombu. Basically, you won't need any change here in strategy apart from passing that prefetch limit when you initialize the consumer or consumer.qos whichever is initialized here."}], "_meta": {"repo": "celery/celery", "pr_number": 9853, "url": "https://github.com/celery/celery/pull/9853#discussion_r2264996278"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\n_constraints = UrlConstraints(host_required=True, allowed_schemes=['http', 'https'])\n\n    @property\n    def host(self) -> str:\n        \"\"\"The required URL host.\"\"\"\n        return self._url.host  # type: ignore\n```"}, {"role": "assistant", "content": "We can remove the added `host` specs that overrode the `str | None` return type from `_BaseUrl`, as `AnyUrl` enforces `str`"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10856, "url": "https://github.com/pydantic/pydantic/pull/10856#discussion_r1844120688"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `encoders.py`:\n\n```python\nif isinstance(obj, BaseModel):\n        encoder = getattr(obj.__config__, \"json_encoders\", {})\n        if custom_encoder:\n            encoder.update(custom_encoder)\n            encoder = {**encoder, **custom_encoder}\n```"}, {"role": "assistant", "content": "The following snippet from slackner illustrates the side effect in 2 cases:\r\n\r\n- With `print(c)` : side effect from `b = jsonable_encoder(creds, custom_encoder=ENCODERS)` when calling `jsonable_encoder` later on the same instance but with a different custom_encoder\r\n- With `print(d)` : side effect from `b = jsonable_encoder(creds, custom_encoder=ENCODERS)` when calling `jsonable_encoder` later on another instance\r\n\r\n```python\r\nfrom pydantic import BaseModel, SecretStr\r\nfrom fastapi.encoders import jsonable_encoder\r\n\r\n\r\nclass Credentials(BaseModel):\r\n    password: SecretStr\r\n\r\n\r\nENCODERS = {SecretStr: lambda v: v.get_secret_value() if v is not None else None}\r\n\r\ncreds = Credentials(password=\"helloworld\")\r\n\r\na = jsonable_encoder(creds)\r\nprint(a)  # {'password': '**********'}, as expected\r\nb = jsonable_encoder(creds, custom_encoder=ENCODERS)\r\nprint(b)  # {'password': 'helloworld'}, as expected\r\nc = jsonable_encoder(creds)\r\nprint(c)  # gives {'password': 'helloworld'}, but should be {'password': '**********'}?\r\n\r\n\r\ncreds = Credentials(password=\"123456789\")\r\n\r\nd = jsonable_encoder(creds)\r\nprint(d)  # gives {'password': '123456789'}, but should be {'password': '**********'}?\r\n```\r\n\r\nBefore this PR, calling jsonable_encoder with a custom_encoder updates the global \"json_encoders\" config of the model.\r\nAfter this PR, calling jsonable_encoder with a custom_encoer argument only affects the current call"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 4972, "url": "https://github.com/fastapi/fastapi/pull/4972#discussion_r892603230"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_async_client.py`:\n\n```python\nassert response.status_code == 200\n    assert response.content == data\n\n\n@pytest.mark.usefixtures(\"async_environment\")\nasync def test_context_managed_transport():\n    class Transport(httpcore.AsyncHTTPTransport):\n        def __init__(self):\n            self.events = []\n\n        async def aclose(self):\n            self.events.append(\"transport.aclose\")\n\n        async def __aenter__(self):\n            await super().__aenter__()\n            self.events.append(\"transport.__aenter__\")\n\n        async def __aexit__(self):\n            await super().__aexit__()\n            self.events.append(\"transport.__aexit__\")\n\n    # Note that we're including 'proxies' here to *also* run through the\n    # proxy context management, although we can't easily test that at the\n    # moment, since we can't add proxies as transport instances.\n    #\n    # Once we have a more generalised Mount API we'll be able to remove this\n    # in favour of ensuring all mounts are context managed, which will\n    # also neccessarily include proxies.\n    transport = Transport()\n    async with httpx.AsyncClient(transport=transport, proxies=\"http://www.example.com\"):\n        pass\n\n    assert transport.events == [\n        \"transport.__aenter__\",\n        \"transport.aclose\",\n        \"transport.__aexit__\",\n    ]\n```"}, {"role": "assistant", "content": "I'm curious why `transport.aclose` is included at all here? Do we call `.aclose()` anywhere before `Client.__aexit__()`?\r\n\r\nEdit: hmm, probably because the base `.__aexit__()` implementation calls into `.aclose()`?"}], "_meta": {"repo": "encode/httpx", "pr_number": 1218, "url": "https://github.com/encode/httpx/pull/1218#discussion_r477207333"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloadermiddleware.py`:\n\n```python\nfrom pytest import mark\nfrom twisted.internet import defer\nfrom twisted.internet.defer import Deferred\nfrom twisted.internet.defer import Deferred, inlineCallbacks\nfrom twisted.python.failure import Failure\nfrom twisted.trial.unittest import TestCase\n\nfrom scrapy.core.downloader.middleware import DownloaderMiddlewareManager\nfrom scrapy.exceptions import _InvalidOutput\nfrom scrapy.http import Request, Response\nfrom scrapy.spiders import Spider\nfrom scrapy.utils.python import to_bytes\nfrom scrapy.utils.test import get_crawler, get_from_asyncio_queue\nfrom tests.spiders import NoRequestsSpider\n\n\nclass ManagerTestCase(TestCase):\n    settings_dict = None\n\n    @inlineCallbacks\n    def setUp(self):\n        self.crawler = get_crawler(Spider, self.settings_dict)\n        self.spider = self.crawler._create_spider(\"foo\")\n        self.crawler = get_crawler(NoRequestsSpider, self.settings_dict)\n        yield self.crawler.crawl()\n        self.spider = self.crawler.spider\n        self.mwman = DownloaderMiddlewareManager.from_crawler(self.crawler)\n        # some mw depends on stats collector\n        self.crawler.stats.open_spider(self.spider)\n        return self.mwman.open_spider(self.spider)\n        yield self.mwman.open_spider(self.spider)\n\n    def tearDown(self):\n        self.crawler.stats.close_spider(self.spider, \"\")\n        return self.mwman.close_spider(self.spider)\n```"}, {"role": "assistant", "content": "no strong opinion on that; please follow the approach you prefer. I haven't checked all code which is relevant (e.g. scrapy shell), while you have checked it :)"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6038, "url": "https://github.com/scrapy/scrapy/pull/6038#discussion_r1321688968"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_async_client.py`:\n\n```python\nfrom datetime import timedelta\nfrom typing import AsyncGenerator\n\nimport pytest\nfrom uvicorn.main import Server\n\nimport httpx\n\n\n@pytest.mark.usefixtures(\"async_environment\")\nasync def test_get(server):\nasync def test_get(server: Server) -> None:\n    url = server.url\n```"}, {"role": "assistant", "content": "What do you think about #991?\r\n\r\nI'm thinking adding the `server: Server` annotations everywhere is super cumbersome, and doesn't add a lot of value. We can have mypy type check the inside of our test functions anyway, which will save us a big amount of work. If we go for that approach, then we actually don't really need to move `TestServer` anywhere (since we won't really need to import it for type hints purposes).\r\n\r\nBesides, note that I initally submitted #990 but closed it as I think #991 is a better way forward."}], "_meta": {"repo": "encode/httpx", "pr_number": 985, "url": "https://github.com/encode/httpx/pull/985#discussion_r429625657"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `httpcompression.py`:\n\n```python\nto_decode: list[bytes] = []\n        while to_keep:\n            encoding = to_keep.pop()\n            if encoding not in ACCEPTED_ENCODINGS:\n            if encoding not in supported_encodings:\n```"}, {"role": "assistant", "content": "`x-gzip` handling was silently broken in 2.12.0 (IIRC) when this code was added."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6618, "url": "https://github.com/scrapy/scrapy/pull/6618#discussion_r1973243365"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloadermiddleware.py`:\n\n```python\nfrom pytest import mark\nfrom twisted.internet import defer\nfrom twisted.internet.defer import Deferred\nfrom twisted.internet.defer import Deferred, inlineCallbacks\nfrom twisted.python.failure import Failure\nfrom twisted.trial.unittest import TestCase\n\nfrom scrapy.core.downloader.middleware import DownloaderMiddlewareManager\nfrom scrapy.exceptions import _InvalidOutput\nfrom scrapy.http import Request, Response\nfrom scrapy.spiders import Spider\nfrom scrapy.utils.python import to_bytes\nfrom scrapy.utils.test import get_crawler, get_from_asyncio_queue\nfrom tests.spiders import NoRequestsSpider\n\n\nclass ManagerTestCase(TestCase):\n    settings_dict = None\n\n    @inlineCallbacks\n    def setUp(self):\n        self.crawler = get_crawler(Spider, self.settings_dict)\n        self.spider = self.crawler._create_spider(\"foo\")\n        self.crawler = get_crawler(NoRequestsSpider, self.settings_dict)\n        yield self.crawler.crawl()\n        self.spider = self.crawler.spider\n        self.mwman = DownloaderMiddlewareManager.from_crawler(self.crawler)\n        # some mw depends on stats collector\n        self.crawler.stats.open_spider(self.spider)\n        return self.mwman.open_spider(self.spider)\n        yield self.mwman.open_spider(self.spider)\n\n    def tearDown(self):\n        self.crawler.stats.close_spider(self.spider, \"\")\n        return self.mwman.close_spider(self.spider)\n```"}, {"role": "assistant", "content": "No opinion on the name (I proposed load, but apply sounds good too)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6038, "url": "https://github.com/scrapy/scrapy/pull/6038#discussion_r1321672972"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_decorators.py`:\n\n```python\nreturn False\n\n    raise PydanticUserError(\n        f'Unrecognized field_validator function signature for {validator} with `mode={mode}`:{sig}',\n        f'Unrecognized {type} function signature for {validator} with `mode={mode}`: {sig}',\n```"}, {"role": "assistant", "content": "I removed the underscore in particular for field validators, that aren't necessarily defined using the `` decorator (i.e. with the `*Validator` metadata classes)."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12366, "url": "https://github.com/pydantic/pydantic/pull/12366#discussion_r2422854022"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_utils.py`:\n\n```python\nopening the file, but avoids maintaining yet another property flag.\n        \"\"\"\n        class_file = sys.modules[cls.__module__].__file__\n        with open(class_file, \"r\") as f:\n        with open(class_file, \"r\", encoding=\"utf8\") as f:\n```"}, {"role": "assistant", "content": "Yes, Python on Windows is notorious for requiring `encoding=\"utf8\"` when opening files if the file might contain characters that can't be mapped to anything:\r\n\r\n```\r\nFAILED tests/models/aya_vision/test_modeling_aya_vision.py::AyaVisionModelTest::test_get_image_features_attentions - UnicodeDecodeError: 'charmap' codec can't decode byte 0x8d in position 17271: character maps to <undefined>\r\nFAILED tests/models/chinese_clip/test_modeling_chinese_clip.py::ChineseCLIPModelTest::test_get_image_features_attentions - UnicodeDecodeError: 'charmap' codec can't decode byte 0x9d in position 43871: character maps to <undefined>\r\nFAILED tests/models/chinese_clip/test_modeling_chinese_clip.py::ChineseCLIPModelTest::test_get_text_features_attentions - UnicodeDecodeError: 'charmap' codec can't decode byte 0x9d in position 43871: character maps to <undefined>\r\n```\r\n\r\n```\r\n    def decode(self, input, final=False):\r\n>       return codecs.charmap_decode(input,self.errors,decoding_table)[0]\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nE       UnicodeDecodeError: 'charmap' codec can't decode byte 0x9d in position 43871: character maps to <undefined>\r\n```\r\n\r\nIn short, if the modeling class file has e.g. Chinese characters, then you won't be able to use `model.set_attn_implementation`, not ideal.\r\n\r\nI can definitely move this to a separate PR if you prefer."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2718148186"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\nraise ValueError(f'\"{self.__class__.__name__}\" object has no field \"{name}\"')\n        elif not self.__config__.allow_mutation or self.__config__.frozen:\n            raise TypeError(f'\"{self.__class__.__name__}\" is immutable and does not support item assignment')\n        elif name in self.__fields__ and self.__fields__[name].final:\n            raise TypeError(\n```"}, {"role": "assistant", "content": "https://github.com/samuelcolvin/pydantic-core/issues/219"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 2768, "url": "https://github.com/pydantic/pydantic/pull/2768#discussion_r937669849"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nreturn self._list\n\n    def keys(self) -> typing.List[str]:  # type: ignore\n        return [key.decode(self.encoding) for key, value in self._list]\n        return [key.decode(self.encoding) for key in self._dict.keys()]\n\n    def values(self) -> typing.List[str]:  # type: ignore\n        return [value.decode(self.encoding) for key, value in self._list]\n        return [value.decode(self.encoding) for value in self._dict.values()]\n\n    def items(self) -> typing.List[typing.Tuple[str, str]]:  # type: ignore\n        \"\"\"\n        Return a list of `(key, value)` pairs of headers. Concatenate headers\n        into a single comma seperated value when a key occurs multiple times.\n        \"\"\"\n        return [\n            (key.decode(self.encoding), value.decode(self.encoding))\n            for key, value in self._dict.items()\n        ]\n\n    def multi_items(self) -> typing.List[typing.Tuple[str, str]]:  # type: ignore\n        \"\"\"\n        Return a list of `(key, value)` pairs of headers. Allow multiple\n        occurances of the same key without concatenating into a single\n        comma seperated value.\n        \"\"\"\n        return [\n            (key.decode(self.encoding), value.decode(self.encoding))\n            for key, value in self._list\n        ]\n\n    def get(self, key: str, default: typing.Any = None) -> typing.Any:\n        \"\"\"\n        Return a header value. If multiple occurances of the header occur\n```"}, {"role": "assistant", "content": "```suggestion\r\n        Return a header value. If multiple occurences of the header occur\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1089, "url": "https://github.com/encode/httpx/pull/1089#discussion_r463124702"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `UP045_py39.py`:\n\n```python\n\"\"\"\nRegression test for https://github.com/astral-sh/ruff/issues/20096\n\"\"\"\n\nfrom __future__ import annotations\n\nfrom typing import Optional, cast, TypeAlias\n\n\nx: Optional[str]             # UP045\nx: \"Optional[str]\"           # UP045\ncast(\"Optional[str]\", None)  # UP045\ncast(Optional[str], None)    # okay, str | None is a runtime error\nx: TypeAlias = \"Optional[str]\"  # UP045\nx: TypeAlias = Optional[str]  # okay\n```"}, {"role": "assistant", "content": "Sorry, I only just realized that my comment probably made it sound like I had left a bug in the PR. When Claude and I looked into it, the bug appears to be upstream of the rule itself in our complex string annotation parsing, or at least in how that parsing interacts with our semantic model. I think the rule itself is behaving correctly with the annotations it's asked to check.\r\n\r\nThanks for taking another look!"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22320, "url": "https://github.com/astral-sh/ruff/pull/22320#discussion_r2717344978"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dataclasses.py`:\n\n```python\nif frozen is not None:\n            frozen_ = frozen\n        else:\n            # It's not recommended to define both, as the setting from the dataclass decorator will take priority.\n            if config_wrapper.frozen:\n                warn(\n                    \"Both 'dataclass' decorator and 'config.frozen' are defined. 'config.frozen' take priority.\",\n                    UserWarning,\n                )\n```"}, {"role": "assistant", "content": "I'm inclined to raise a warning here - makes it more likely that folks can figure out the issue on their own + don't open an issue with a question.\r\n\r\nAgreed with  though, this isn't logically in the right place given the warning."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10082, "url": "https://github.com/pydantic/pydantic/pull/10082#discussion_r1709223621"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `text_to_audio.py`:\n\n```python\nreturn preprocess_params, params, postprocess_params\n\n    def postprocess(self, audio):\n        output_dict = {}\n\n        if self.model.config.model_type == \"csm\":\n            waveform_key = \"audio\"\n        else:\n            waveform_key = \"waveform\"\n\n        # We directly get the waveform\n        if self.no_processor:\n            if isinstance(audio, dict):\n                waveform = audio[waveform_key]\n            elif isinstance(audio, tuple):\n                waveform = audio[0]\n        needs_decoding = False\n        if isinstance(audio, dict):\n            if \"audio\" in audio:\n                audio = audio[\"audio\"]\n            else:\n                waveform = audio\n        # Or we need to postprocess to get the waveform\n        else:\n            waveform = self.processor.decode(audio)\n\n        if isinstance(audio, list):\n            output_dict[\"audio\"] = [el.to(device=\"cpu\", dtype=torch.float).numpy() for el in waveform]\n                needs_decoding = True\n                audio = audio[\"sequences\"]\n        elif isinstance(audio, tuple):\n            audio = audio[0]\n\n        if needs_decoding:\n            audio = self.processor.decode(audio)\n\n        if isinstance(audio, list) and len(audio) > 1:\n            audio = [el.to(device=\"cpu\", dtype=torch.float).numpy() for el in audio]\n        elif isinstance(audio, list):\n            audio = audio[0].to(device=\"cpu\", dtype=torch.float).numpy()\n```"}, {"role": "assistant", "content": "The reasoning is to standardize the output. Because CSM was returning a list even for a single audio, and to be able to do extract the audio with `outputs[\"audio\"]` as in the other models, rather than having to index it like such `outputs[\"audio\"][0]`\r\n\r\n\r\nBut I can change to something like this so it's more concise:\r\n```python\r\nif isinstance(audio, list):\r\n    audio = [el.to(device=\"cpu\", dtype=torch.float).numpy() for el in audio]\r\n    audio = audio if len(audio) > 1 else audio[0]\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42326, "url": "https://github.com/huggingface/transformers/pull/42326#discussion_r2565562101"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_utils.py`:\n\n```python\n- `'np'`: Return NumPy `np.ndarray` objects.\n        disable_grouping (`bool`, *optional*):\n            Whether to group images by shapes when processing or not, only relevant for fast image processing.\n        image_seq_length (`int`, *optional*):\n            The number of image tokens to be used for each image in the input.\n            Added for backward compatibility but this should be set as a processor attribute in future models.\n```"}, {"role": "assistant", "content": "sorry for nitty-picking after PR is merged, For my own understanding, do we need it in here, because not all image processors are VLM-specific and `image_seq_length` isn't always needed for them"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41997, "url": "https://github.com/huggingface/transformers/pull/41997#discussion_r2494805853"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pool_command.py`:\n\n```python\nrich.print(success)\n\n\n@provide_api_client(kind=ClientKind.CLI)\n```"}, {"role": "assistant", "content": "Was starting to review and had exactly the same thought in parallel."}], "_meta": {"repo": "apache/airflow", "pr_number": 59850, "url": "https://github.com/apache/airflow/pull/59850#discussion_r2649062031"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_qwen3_vl.py`:\n\n```python\n**kwargs,\n        )\n\n        # Qwen3VL position_ids are prepareed with rope_deltas in forward\n        model_inputs[\"position_ids\"] = None\n        # Qwen3VL position_ids are prepared with rope_deltas\n        if position_ids is None:\n            # Calculate RoPE index once per generation in the pre-fill stage only.\n            # When compiling, we can't check tensor values thus we check only input length\n            # It is safe to assume that `length!=1` means we're in pre-fill because compiled\n            # models currently cannot do asssisted decoding\n            if model_inputs[\"cache_position\"][0] == 0 or self.model.rope_deltas is None:\n                vision_positions, rope_deltas = self.model.get_rope_index(\n                    model_inputs.get(\"input_ids\", None),\n                    image_grid_thw=image_grid_thw,\n                    video_grid_thw=video_grid_thw,\n                    attention_mask=attention_mask,\n                )\n                self.model.rope_deltas = rope_deltas\n            # then use the prev pre-calculated rope-deltas to get the correct position ids\n            elif \"position_ids\" in model_inputs:\n                batch_size, seq_length = model_inputs[\"position_ids\"].shape\n                device = model_inputs[\"position_ids\"].device\n                position_ids = torch.arange(seq_length, device=device)\n                position_ids = position_ids.view(1, 1, -1).expand(3, batch_size, -1)\n                delta = cache_position[0] + self.model.rope_deltas\n                delta = delta.repeat_interleave(batch_size // delta.shape[0], dim=0)\n                vision_positions = position_ids + delta.expand_as(position_ids)\n```"}, {"role": "assistant", "content": "yep, mostly copy from qwen2-vl. Modular is overwriting this class, so we're not copying automatically apparently"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42508, "url": "https://github.com/huggingface/transformers/pull/42508#discussion_r2580313674"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_glmasr.py`:\n\n```python\n# coding=utf-8\n# Copyright 2025 the HuggingFace Team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\nfrom collections.abc import Callable\nfrom typing import Optional, Union\n\nimport numpy as np\nimport torch\nfrom torch import nn\n\nfrom ...activations import ACT2FN\nfrom ...feature_extraction_utils import BatchFeature\nfrom ...modeling_outputs import BaseModelOutput\nfrom ...modeling_utils import ALL_ATTENTION_FUNCTIONS\nfrom ...processing_utils import ProcessingKwargs, ProcessorMixin, Unpack\nfrom ...tokenization_utils_base import PreTokenizedInput, TextInput\nfrom ...utils import logging\nfrom ..auto import AutoConfig\nfrom ..glm4.modeling_glm4 import apply_rotary_pos_emb\nfrom ..voxtral.configuration_voxtral import VoxtralConfig, VoxtralEncoderConfig\nfrom ..voxtral.modeling_voxtral import (\n    VoxtralAttention,\n    VoxtralEncoder,\n    VoxtralEncoderLayer,\n    VoxtralForConditionalGeneration,\n    VoxtralPreTrainedModel,\n    eager_attention_forward,\n)\n\n\nlogger = logging.get_logger(__name__)\n\n\nclass GlmasrAudioRotaryEmbedding(nn.Module):\n    inv_freq: torch.Tensor  # fix linting for `register_buffer`\n\n    def __init__(self, dim: int, theta: float = 10000.0) -> None:\n        super().__init__()\n        inv_freq = 1.0 / (theta ** (torch.arange(0, dim, 2, dtype=torch.float) / dim))\n        self.register_buffer(\"inv_freq\", inv_freq, persistent=False)\n\n    def forward(self, seqlen: int) -> torch.Tensor:\n        seq = torch.arange(seqlen, device=self.inv_freq.device, dtype=self.inv_freq.dtype)\n        freqs = torch.outer(seq, self.inv_freq)\n        return freqs\n```"}, {"role": "assistant", "content": "let's inherit directly from `Qwen2_5_VisionRotaryEmbedding` here"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42875, "url": "https://github.com/huggingface/transformers/pull/42875#discussion_r2635803257"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deb822_repository.py`:\n\n```python\n# popped non-deb822 args\n    mode = params.pop('mode')\n    state = params.pop('state')\n    _install_python_debian_param = params.pop('install_python_debian')\n```"}, {"role": "assistant", "content": "No need to save the popped value, since it's already been consulted above."}], "_meta": {"repo": "ansible/ansible", "pr_number": 86403, "url": "https://github.com/ansible/ansible/pull/86403#discussion_r2677972468"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `genspider.py`:\n\n```python\ntry:\n            spidercls = self.crawler_process.spider_loader.load(name)\n        except KeyError:\n            pass\n            if not self.settings.get('NEWSPIDER_MODULE'):\n                if exists(name + \".py\"):\n                    print(\"%r already exists\" % (abspath(name + \".py\")))\n                    return\n            else:\n                spiders_module = import_module(self.settings['NEWSPIDER_MODULE'])\n                spiders_dir = dirname(spiders_module.__file__)\n                spiders_dir_abs = abspath(spiders_dir)\n                if exists(join(spiders_dir_abs, name + \".py\")):\n                    print(\"%r already exists\" % (join(spiders_dir_abs, (name + \".py\"))))\n                    return\n```"}, {"role": "assistant", "content": "Hmm...I had discussed the same with  https://github.com/scrapy/scrapy/pull/4623#discussion_r439445481 and he said since it was just a matter of renaming the file which the user could do easily it wasn't required. However, I could add it if its needed."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4623, "url": "https://github.com/scrapy/scrapy/pull/4623#discussion_r440184743"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `kernel_config.py`:\n\n```python\nif isinstance(kernel, str):\n                if \"/\" not in kernel or \":\" not in kernel:\n                    raise ValueError(\n                        f\"Kernel mapping for '{layer_name}' must be a valid repo name with a layer name (e.g., 'org/repo:layer_name'), got: {kernel}\"\n                        f\"Kernel mapping for '{layer_name}' must be a valid repo name with a layer name (e.g., 'org/repo:layer_name' or '/abs-path:layer_name'), got: {kernel}\"\n```"}, {"role": "assistant", "content": "```suggestion\n                        f\"Kernel mapping for '{layer_name}' must be a valid repo name with a layer name (e.g., 'org/repo:layer_name' or '/abs/path:layer_name'), got: {kernel}\"\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42800, "url": "https://github.com/huggingface/transformers/pull/42800#discussion_r2622492373"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processing_ernie4_5_vl.py`:\n\n```python\n# coding=utf-8\n# Copyright 2025 Baidu and HuggingFace Inc. team. All rights reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\nfrom typing import Optional, Union\n\nimport numpy as np\n\nfrom ...image_processing_utils import BatchFeature\nfrom ...image_utils import ImageInput\nfrom ...processing_utils import MultiModalData, ProcessingKwargs, ProcessorMixin, Unpack\nfrom ...tokenization_utils_base import PreTokenizedInput, TextInput\nfrom ...video_utils import VideoInput\n\n\nclass Ernie4_5_VLProcessorKwargs(ProcessingKwargs, total=False):\n    _defaults = {\n        \"text_kwargs\": {\n            \"padding\": False,\n            \"return_token_type_ids\": False,\n            \"return_mm_token_type_ids\": True,\n        },\n    }\n\n\nclass Ernie4_5_VLProcessor(ProcessorMixin):\n    r\"\"\"\n    Constructs a Ernie 4.5 VL processor which wraps a Ernie 4.5 VL image processor and a Llama tokenizer into a single processor.\n    [`Ernie4_5_VLProcessor`] offers all the functionalities of [`Ernie4_5_VLImageProcessor`] and [`LlamaTokenizerFast`]. See the\n    [`~Ernie4_5_VLProcessor.__call__`] and [`~Ernie4_5_VLProcessor.decode`] for more information.\n    Args:\n        image_processor ([`Ernie4_5_VLImageProcessor`], *optional*):\n            The image processor is a required input.\n        tokenizer ([`LlamaTokenizerFast`], *optional*):\n            The tokenizer is a required input.\n        video_processor ([`Ernie4_5_VLVideoProcessor`], *optional*):\n            The video processor is a required input.\n        chat_template (`str`, *optional*): A Jinja template which will be used to convert lists of messages\n            in a chat into a tokenizable string.\n    \"\"\"\n\n    attributes = [\"image_processor\", \"tokenizer\", \"video_processor\"]\n    image_processor_class = \"AutoImageProcessor\"\n    video_processor_class = \"AutoVideoProcessor\"\n\n    tokenizer_class = (None, \"LlamaTokenizerFast\")\n```"}, {"role": "assistant", "content": "I've had enough pain there. It's a problem where a weird discrepancy between llama slow and fast tokenizers came apparent - especially when using special tokens. I don't want to introduce possibly faulty tokenizers and other models also often don't have a slow tokenizer defined\r\n\r\nEdit: maybe past ernie PRs can show you some past lol"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39585, "url": "https://github.com/huggingface/transformers/pull/39585#discussion_r2519138664"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `defaults.py`:\n\n```python\ninherit_parent_priority=Option(False, type='bool'),\n        default_delivery_mode=Option(2, type='string'),\n        default_queue=Option('celery'),\n        default_queue_type=Option('classic', type='string'),\n```"}, {"role": "assistant", "content": "there are many versions of rabbitmq where qourum is not default"}], "_meta": {"repo": "celery/celery", "pr_number": 9121, "url": "https://github.com/celery/celery/pull/9121#discussion_r2516671028"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_auth.py`:\n\n```python\nreturn f\"Basic {token}\"\n\n\nclass NetRCAuth(Auth):\n    \"\"\"\n    Use a 'netrc' file to lookup basic auth credentials based on the url host.\n    \"\"\"\n\n    def __init__(self, file: typing.Optional[str]):\n        self._netrc_info = netrc.netrc(file)\n\n    def auth_flow(self, request: Request) -> typing.Generator[Request, Response, None]:\n        auth_info = self._netrc_info.authenticators(request.url.host)\n        if auth_info is None or auth_info[2] is None:\n```"}, {"role": "assistant", "content": "I'm asking since previously you were checking \r\n```python\r\nif credentials is not None:\r\n    ...\r\n```\r\n\r\nand python documentation says (link) that \r\n> If the netrc file did not contain an entry for the given host, return the tuple associated with the \u2018default\u2019 entry. If neither matching host nor default entry is available, return None."}], "_meta": {"repo": "encode/httpx", "pr_number": 2535, "url": "https://github.com/encode/httpx/pull/2535#discussion_r1066617055"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `python.py`:\n\n```python\n\"\"\"\nThis module contains essential stuff that should've come with Python itself ;)\n\"\"\"\nimport errno\nimport gc\nimport inspect\nimport os\nimport re\nimport inspect\nimport sys\nimport weakref\nimport errno\nfrom functools import partial, wraps\nfrom itertools import chain\nimport sys\n\nfrom scrapy.utils.decorators import deprecated\n\n\ntry:\n    from dataclasses import is_dataclass, asdict as dataclass_asdict\nexcept ImportError:\n    def is_dataclass_instance(_):\n        return False\n\n    def dataclass_asdict(_):\n        raise ImportError(\"no module named 'dataclasses'\")\nelse:\n    def is_dataclass_instance(obj):\n```"}, {"role": "assistant", "content": "Even if so, I think it is better to add tests, because the example in docs is only guaranteed to work with the Python these docs are for, while we support many Pythons, and a backport as well."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 3881, "url": "https://github.com/scrapy/scrapy/pull/3881#discussion_r395129879"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `iso8601.py`:\n\n```python\ndef parse_iso8601(datestring):\n    \"\"\"Parse and convert ISO-8601 string to datetime.\"\"\"\n    warn(\"parse_iso8601\", \"v5.3\", \"v6\", \"datetime.datetime.fromisoformat\")\n```"}, {"role": "assistant", "content": "In used what I found built in.  The parameter `depracation` is provided, so the final result is a `warnings.warn` with a CDeprecationWarning.  So yes, I believe so."}], "_meta": {"repo": "celery/celery", "pr_number": 8098, "url": "https://github.com/celery/celery/pull/8098#discussion_r1123912764"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `parsing.py`:\n\n```python\nreturn code\n\n\nclass ASTSafetyError(Exception):\n```"}, {"role": "assistant", "content": "We don't provide compatibility guarantees for this function. I don't think inheriting from AssertionError makes semantic sense."}], "_meta": {"repo": "psf/black", "pr_number": 4270, "url": "https://github.com/psf/black/pull/4270#discussion_r1597527834"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `shell.py`:\n\n```python\ncrawler._apply_settings()\n        # The Shell class needs a persistent engine in the crawler\n        crawler.engine = crawler._create_engine()\n        crawler.engine.start(_start_request_processing=False)\n        deferred_from_coro(crawler.engine.start_async(_start_request_processing=False))\n```"}, {"role": "assistant", "content": "> we could add a private helper function instead\r\n\r\nI think this would be nice. I cannot think of a name, though :sweat_smile:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6979, "url": "https://github.com/scrapy/scrapy/pull/6979#discussion_r2243716559"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_async_client.py`:\n\n```python\nresponse = await client.get(\"custom://www.example.com\")\n        assert response.status_code == 200\n        assert response.json() == {\"app\": \"mounted\"}\n\n\n@pytest.mark.usefixtures(\"async_environment\")\nasync def test_response_aclose_map_exceptions():\n    class BrokenStream:\n        async def __aiter__(self):\n            # so we're an AsyncIterator\n            pass  # pragma: nocover\n\n        async def aclose(self):\n            raise httpcore.CloseError(OSError(104, \"Connection reset by peer\"))\n\n    def handle(request: httpx.Request) -> httpx.Response:\n        return httpx.Response(200, stream=BrokenStream())\n\n    async with httpx.AsyncClient(transport=httpx.MockTransport(handle)) as client:\n        async with client.stream(\"GET\", \"http://example.com\") as response:\n            with pytest.raises(httpx.CloseError):\n                await response.aclose()\n```"}, {"role": "assistant", "content": "Yup, I like the way  has approached the test case here, too."}], "_meta": {"repo": "encode/httpx", "pr_number": 1465, "url": "https://github.com/encode/httpx/pull/1465#discussion_r577537371"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_flash_attention_utils.py`:\n\n```python\n\"\"\"\n    is_fa2 = is_flash_attn_2_available()\n    is_fa3 = is_flash_attn_3_available()\n    if implementation == \"flash_attention_2\" or (implementation is None and is_fa2 and not is_fa3):\n\n    # Package `flash-attn` is unavailable on Ascend NPU, which will cause ImportError\n    # Flash-Attention2 related apis for Ascend NPU must be imported from `.integrations.npu_flash_attention` module\n    if implementation == \"flash_attention_2\" and is_torch_npu_available():\n        from .integrations.npu_flash_attention import npu_flash_attn_func as flash_attn_func\n        from .integrations.npu_flash_attention import npu_flash_attn_varlen_func as flash_attn_varlen_func\n        from .integrations.npu_flash_attention import pad_input, unpad_input\n    elif implementation == \"flash_attention_2\" or (implementation is None and is_fa2 and not is_fa3):\n```"}, {"role": "assistant", "content": "`is_fa2` can not be used for Ascend NPU due to checking package `flash-attn` exists or not. Besides, for Ascend NPU, `implementation=\"flash_attention_2\"` also eixsts. Therefore, `is_torch_npu_available` judgement can not be removed"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40151, "url": "https://github.com/huggingface/transformers/pull/40151#discussion_r2276261759"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nmintime = time() - age\n        for key, slot in list(self.slots.items()):\n            if not slot.active and slot.lastseen + slot.delay < mintime:\n                self.slots.pop(key).close()\n                inactive_slot = self.slots.pop(key)\n                inactive_slot.close()\n```"}, {"role": "assistant", "content": "According to Codecov this part is not covered by tests (it probably was not covered by tests before.\r\n\r\nIt seems functionally equivalent to the code before the change, so maybe you could just revert this change.\r\n\r\nI am OK with the change though, it is more readable. But if you are going to change it, it would be great if you could also extend test coverage for it. Although that may not be trivial."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5328, "url": "https://github.com/scrapy/scrapy/pull/5328#discussion_r933167276"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `helpers.py`:\n\n```python\ndef is_core_timetable_import_path(importable_string: str) -> bool:\n    \"\"\"Whether an importable string points to a core timetable class.\"\"\"\n    return importable_string.startswith(\"airflow.timetables.\")\n\n\nclass PartitionMapperNotFound(ValueError):\n    \"\"\"Raise when a PartitionMapper cannot be found.\"\"\"\n\n    def __init__(self, type_string: str) -> None:\n        self.type_string = type_string\n\n    def __str__(self) -> str:\n        return (\n            f\"PartitionMapper class {self.type_string!r} could not be imported or \"\n            \"you have a top level database access that disrupted the session. \"\n            \"Please check the airflow best practices documentation.\"\n        )\n\n\ndef is_core_partition_mapper_import_path(importable_string: str) -> bool:\n    \"\"\"Whether an importable string points to a core partition mapper class.\"\"\"\n    return importable_string.startswith(\"airflow.timetables.\")\n```"}, {"role": "assistant", "content": "Maybe we should move the partition mapper to a separate package."}], "_meta": {"repo": "apache/airflow", "pr_number": 60204, "url": "https://github.com/apache/airflow/pull/60204#discussion_r2689856065"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nlabels = None\n        if self.model_accepts_loss_kwargs:\n            kwargs = {}\n            if num_items_in_batch is not None:\n                kwargs[\"num_items_in_batch\"] = num_items_in_batch\n            # if num_items_in_batch is not None:\n```"}, {"role": "assistant", "content": "TODO: num_items_in_batch doesn't respect data vs model parallelism at all, resulting in a wrong loss calc."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40205, "url": "https://github.com/huggingface/transformers/pull/40205#discussion_r2282624086"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\n# Fully Connected\n        residual = hidden_states\n        hidden_states = self.activation_fn(self.fc1(hidden_states))\n        hidden_states = nn.functional.dropout(hidden_states, p=self.activation_dropout, training=self.training)\n        hidden_states = self.fc2(hidden_states)\n        hidden_states = nn.functional.dropout(hidden_states, p=self.dropout, training=self.training)\n        hidden_states = self.mlp(hidden_states)\n        hidden_states = residual + hidden_states\n        hidden_states = self.final_layer_norm(hidden_states)\n\n        outputs = (hidden_states,)\n        return hidden_states\n\n\ndef _expand(tensor, length: int):\n    return tensor.unsqueeze(1).repeat(1, int(length), 1, 1, 1).flatten(0, 1)\n\n\n# taken from https://github.com/facebookresearch/detr/blob/master/models/segmentation.py\nclass DetrMaskHeadSmallConv(nn.Module):\n```"}, {"role": "assistant", "content": "on this one, naming can be upgraded to modern standards a bit, especially with the `Renaming` helping us out"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2685795406"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `poolmanager.py`:\n\n```python\nif headers:\n            headers_.update(headers)\n\n        return headers_\n\n    def urlopen(self, method, url, **kw):\n    def urlopen(self, method, url, redirect=True, **kw):\n        \"Same as HTTP(S)ConnectionPool.urlopen, ``url`` must be absolute.\"\n        kw['assert_same_host'] = False\n        kw['headers'] = self._set_proxy_headers(url, headers=kw.get('headers'))\n        return self.proxy_pool.urlopen(method, url, **kw)\n        u = parse_url(url)\n\n        if u.scheme == \"http\":\n            # It's too late to set proxy headers on per-request basis for\n            # tunnelled HTTPS connections, should use\n            # constructor's proxy_headers instead.\n            kw['headers'] = self._set_proxy_headers(url, kw.get('headers',\n                                                                self.headers))\n            kw['headers'].update(self.proxy_headers)\n```"}, {"role": "assistant", "content": "> To my utter disgust, GitHub seems unwilling to let me open a PR against your fork\n\nMhh, I see the issue. Our branches our not comparable for whatever reason... I send an issue report to GitHub."}], "_meta": {"repo": "psf/requests", "pr_number": 1515, "url": "https://github.com/psf/requests/pull/1515#discussion_r5760232"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\n)\n        return d2\n\n    @inlineCallbacks\n    def _handle_downloader_output(\n```"}, {"role": "assistant", "content": "No, I didn't, I'll check what can be done straight away."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6767, "url": "https://github.com/scrapy/scrapy/pull/6767#discussion_r2071923366"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\n# In the DataParallel case, convert the scalar tensor into a 2-dim tensor with the same value repeated\n                    num_items_in_batch = num_items_in_batch.unsqueeze(0).expand(self.args.n_gpu, -1)\n                # Divide by number of devices with the same batch\n                if pc := getattr(self.accelerator, \"parallelism_config\", None):\n                pc = getattr(self.accelerator, \"parallelism_config\", None)\n                if pc is not None and pc.cp_backend == \"torch\":\n```"}, {"role": "assistant", "content": "let's revert this and just set `self.model_accepts_loss_kwargs` to False when sp is enabled. This way we will skip all the logic related to `num_items_in_batch`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41832, "url": "https://github.com/huggingface/transformers/pull/41832#discussion_r2538970452"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `types.py`:\n\n```python\nfrom io import BytesIO\nfrom ipaddress import IPv4Address, IPv6Address\nfrom typing import Union\n\nfrom twisted.internet.ssl import Certificate\n# for python < 3.8 -- typing.TypedDict is undefined\nfrom typing_extensions import TypedDict\n\nfrom scrapy.http.headers import Headers\n\n\nclass H2ConnectionMetadataDict(TypedDict):\n    \"\"\"Some meta data of this connection\n    initialized when connection is successfully made\n    \"\"\"\n    certificate: Union[None, Certificate]\n    ip_address: Union[None, IPv4Address, IPv6Address]\n```"}, {"role": "assistant", "content": "```suggestion\r\n    certificate: Optional[Certificate]\r\n    ip_address: Optional[Union[IPv4Address, IPv6Address]]\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r447677562"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\ndef _subclass_schema(self, type_: Any) -> core_schema.CoreSchema:\n        \"\"\"Generate schema for a Type, e.g. `Type[int]`.\"\"\"\n        type_param = self._get_first_arg_or_any(type_)\n        # Assume `type[Annotated[<typ>, ...]]` is equivalent to `type[<typ>]`:\n        type_param = _typing_extra.annotated_type(type_param) or type_param\n```"}, {"role": "assistant", "content": ", are you ok with this assumption?\r\n\r\nIf so, then I'm happy to move forward with this PR. Thanks !"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9932, "url": "https://github.com/pydantic/pydantic/pull/9932#discussion_r1686468174"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_typing_extra.py`:\n\n```python\nvalue, globalns, localns\n            )\n    except TypeError as e:\n        if not (isinstance(value, typing.ForwardRef) and is_backport_fixable_error(e)):\n            raise\n        try:\n            from eval_type_backport import eval_type_backport\n        except ImportError:\n            raise TypeError(\n                f'You have a type annotation {value.__forward_arg__!r} '\n                f'which makes use of newer typing features than are supported in your version of Python. '\n                f'To handle this error, you should either remove the use of new syntax '\n                f'or install the `eval_type_backport` package.'\n            ) from e\n        if isinstance(value, typing.ForwardRef):\n            if is_backport_fixable_error(e):\n                try:\n                    from eval_type_backport import eval_type_backport\n                except ImportError:\n                    raise TypeError(\n                        f'Unable to evaluate type annotation {value.__forward_arg__!r}. If you are making use '\n                        'of the new typing syntax (unions using `|` since Python 3.10 or builtins subscripting '\n                        'since Python 3.9), you should either replace the use of new syntax with the existing '\n                        '`typing` constructs or install the `eval_type_backport` package.'\n                    ) from e\n\n                return eval_type_backport(value, globalns, localns, try_default=False)\n```"}, {"role": "assistant", "content": "The thing is `eval_type_backport` is used by `eval_type_lenient` (defined above), and is the one responsible for catching (and not erroring) `NameError`s"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10030, "url": "https://github.com/pydantic/pydantic/pull/10030#discussion_r1705733278"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trans.py`:\n\n```python\n\"\"\"\n            assert_is_leaf_string(string)\n            if \"f\" in string_prefix:\n                string = _toggle_fexpr_quotes(string, QUOTE)\n                # After quotes toggling, quotes in expressions won't be escaped\n                # because quotes can't be reused in f-strings. So we can simply\n                # let the escaping logic below run without knowing f-string\n                # expressions.\n                f_expressions = (\n                    string[span[0] : span[1]] for span in iter_fexpr_spans(string)\n                )\n                expressions_contain_printable_quotes = any(\n                    re.search(r\".*[\\'\\\"].*=\", expression)\n```"}, {"role": "assistant", "content": "And maybe it's better to be more consistent, even if the regex becomes a bit more complex"}], "_meta": {"repo": "psf/black", "pr_number": 4005, "url": "https://github.com/psf/black/pull/4005#discussion_r1381296109"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloader_handlers_http_base.py`:\n\n```python\nasync def test_download_cause_data_loss(\n        self, url: str, mockserver: MockServer\n    ) -> None:\n        # TODO: this one checks for Twisted-specific exceptions\n        request = Request(mockserver.url(f\"/{url}\", is_secure=self.is_secure))\n        async with self.get_dh() as download_handler:\n            with pytest.raises(ResponseFailed) as exc_info:\n            with pytest.raises(ResponseDataLoss):\n```"}, {"role": "assistant", "content": "The new exception `ResponseDataLoss` is raised in the handler but this test doesn't verify the cause chain. Consider adding an assertion to verify that `exc_info.value.__cause__` is set correctly to maintain the original error information."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7208, "url": "https://github.com/scrapy/scrapy/pull/7208#discussion_r2656469596"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `schema.py`:\n\n```python\nimport importlib.resources\nimport json\nimport sys\nfrom typing import Any\n\n\ndef get_schema(tool_name: str = \"cibuildwheel\") -> Any:\n    \"Get the stored complete schema for black's settings.\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n    \"\"\"Get the stored complete schema for black's settings.\"\"\"\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 4181, "url": "https://github.com/psf/black/pull/4181#discussion_r1468513233"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `fields.py`:\n\n```python\nif self.default_factory is None:\n            return _utils.smart_deepcopy(self.default)\n        elif call_default_factory:\n            if validated_data is None:\n                raise ValueError(\"'validated_data' must be provided if 'call_default_factory' is True.\")\n            if _fields.takes_validated_data_argument(self.default_factory):\n                if validated_data is None:\n                    raise ValueError(\n                        \"'validated_data' is missing but should be provided. This is a bug, please report this.\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n                       \"The default factory requires the 'validated_data' argument, which was not provided when calling 'get_default'.\"\r\n```\r\n\r\nI don't think mentioning \"this is a bug\" is correct, as users could really just call `get_default` in the wrong way."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10909, "url": "https://github.com/pydantic/pydantic/pull/10909#discussion_r1852161064"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `parsing.py`:\n\n```python\nreturn code\n\n\ndef parse_ast(src: str) -> Union[ast.AST, ast3.AST, ast27.AST]:\ndef parse_single_version(\n    src: str, version: Tuple[int, int]\n) -> Union[ast.AST, ast3.AST, ast27.AST]:\n    filename = \"<unknown>\"\n    if (3, 8) <= version < (4, 0):\n        return ast.parse(src, filename, feature_version=version)\n    elif version >= (3, 6):\n```"}, {"role": "assistant", "content": "IIRC we need typed_ast for <3.8 because the built-in `ast` module has limited feature_version support. In other words, using `ast` <3.8 would force Black to be able to only parse using the grammar of the runtime version. I'm not entirely sure though, I would strongly encourage either putting this information in a comment or the dev documentation because it's been like a year of me being here and I still don't 100% understand this area (for more info see this bpo issue)."}], "_meta": {"repo": "psf/black", "pr_number": 2304, "url": "https://github.com/psf/black/pull/2304#discussion_r650330405"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sdpa_attention.py`:\n\n```python\n\" Please set your attention to `eager` if you want any of these features.\"\n        )\n\n    if hasattr(module, \"num_key_value_groups\"):\n        key = repeat_kv(key, module.num_key_value_groups)\n        value = repeat_kv(value, module.num_key_value_groups)\n```"}, {"role": "assistant", "content": "set  enable_gqa=False in torch.nn.functional.scaled_dot_product_attention"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39412, "url": "https://github.com/huggingface/transformers/pull/39412#discussion_r2206395848"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `time.py`:\n\n```python\nreturn datetime.fromisoformat(dt)\n\n\ndef is_naive(dt):\n    \"\"\"Return :const:`True` if :class:`~datetime.datetime` is naive.\"\"\"\ndef is_naive(dt: datetime) -> bool:\n    \"\"\"Return True if :class:`~datetime.datetime` is naive, meaning it doesn't have timezone info set.\"\"\"\n    return dt.tzinfo is None or dt.tzinfo.utcoffset(dt) is None\n\n\ndef make_aware(dt, tz):\ndef _can_detect_ambiguous(tz: tzinfo) -> bool:\n    \"\"\"Helper function to determine if a timezone can detect ambiguous times using dateutil.\"\"\"\n\n    return isinstance(tz, ZoneInfo) or hasattr(tz, \"is_ambiguous\")\n\n\ndef _is_ambigious(dt: datetime, tz: tzinfo) -> bool:\n    \"\"\"Helper function to determine if a timezone is ambigious using dateutil.\n```"}, {"role": "assistant", "content": "```suggestion\r\n    \"\"\"Helper function to determine if a timezone is ambiguous using python-dateutil.\r\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 8159, "url": "https://github.com/celery/celery/pull/8159#discussion_r1161245328"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `shared.py`:\n\n```python\nFutureDate,\n    PastDatetime,\n]\n\n\nclass DeferredModel(BaseModel):\n    model_config = {'defer_build': True}\n\n\ndef rebuild_model(model: Type[BaseModel]) -> None:\n    model.model_rebuild(force=True, _types_namespace={})\n```"}, {"role": "assistant", "content": "This is fine bc it's working now, but if we do more complex model rebuilding, we might need to remove this types namespace specification."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10602, "url": "https://github.com/pydantic/pydantic/pull/10602#discussion_r1798357654"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `abstractoperator.py`:\n\n```python\nDEFAULT_TASK_EXECUTION_TIMEOUT: datetime.timedelta | None = conf.gettimedelta(\n    \"core\", \"default_task_execution_timeout\"\n)\n\nDEFAULT_EMAIL_ON_FAILURE: bool = conf.getboolean(\"email\", \"default_email_on_failure\", fallback=True)\nDEFAULT_EMAIL_ON_RETRY: bool = conf.getboolean(\"email\", \"default_email_on_retry\", fallback=True)\n```"}, {"role": "assistant", "content": "We should have some test coverage for this. The test: `test_default_email_on_actions` only checks for true. Maybe use `conf_vars` to explicitly set to false and assert it."}], "_meta": {"repo": "apache/airflow", "pr_number": 59912, "url": "https://github.com/apache/airflow/pull/59912#discussion_r2652335798"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pipeline_media.py`:\n\n```python\nself.assertIsNone(context)\n\n\nclass MockedMediaPipeline(MediaPipeline):\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self._mockcalled = []\n\n    def download(self, request, info):\n        self._mockcalled.append(\"download\")\n        return super().download(request, info)\n\n    def media_to_download(self, request, info, *, item=None):\n        self._mockcalled.append(\"media_to_download\")\n        if \"result\" in request.meta:\n            return request.meta.get(\"result\")\n        return super().media_to_download(request, info)\n\n    def get_media_requests(self, item, info):\n        self._mockcalled.append(\"get_media_requests\")\n        return item.get(\"requests\")\n\n    def media_downloaded(self, response, request, info, *, item=None):\n        self._mockcalled.append(\"media_downloaded\")\n        return super().media_downloaded(response, request, info)\n\n    def media_failed(self, failure, request, info):\n        self._mockcalled.append(\"media_failed\")\n        return super().media_failed(failure, request, info)\n\n    def item_completed(self, results, item, info):\n        self._mockcalled.append(\"item_completed\")\n        item = super().item_completed(results, item, info)\n        item[\"results\"] = results\n        return item\n\n\nclass MediaPipelineTestCase(BaseMediaPipelineTestCase):\n```"}, {"role": "assistant", "content": "I\u2019ve kept required tests. Let me know if im missing something"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6368, "url": "https://github.com/scrapy/scrapy/pull/6368#discussion_r1607035571"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `processor.py`:\n\n```python\nsys.path.append(bundle_root)\n\n    result = _parse_file(msg, log)\n\n    if result is not None:\n        comms_decoder.send(result)\n\n\ndef _parse_file(msg: DagFileParseRequest, log: FilteringBoundLogger) -> DagFileParsingResult | None:\n    # TODO: Set known_pool names on DagBag!\n\n    static_check_result = check_dag_file_static(os.fspath(msg.file))\n```"}, {"role": "assistant", "content": "same here ->  names should be updated  - > I think we should make it clear that this is a \"dag stability\" check - not \"static check\" in general."}], "_meta": {"repo": "apache/airflow", "pr_number": 59430, "url": "https://github.com/apache/airflow/pull/59430#discussion_r2644086300"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `connection.py`:\n\n```python\n# HTTP request. Don't try to upgrade to TLS in this case.\n            pass\n\n        self.set_open_connection(http_version, socket=socket, on_release=on_release)\n\n    def set_open_connection(\n        self,\n        http_version: str,\n        socket: BaseSocketStream,\n        on_release: typing.Optional[typing.Callable],\n    ) -> None:\n        if http_version == \"HTTP/2\":\n            self.h2_connection = HTTP2Connection(\n            self.open_connection = HTTP2Connection(\n```"}, {"role": "assistant", "content": "This is the only place where we reference `HTTP2Connection` in this file, so we'll be able to lazily-import it here, and fail if `h2` isn't installed. :+1:"}], "_meta": {"repo": "encode/httpx", "pr_number": 616, "url": "https://github.com/encode/httpx/pull/616#discussion_r355125337"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nAt present the following types can be named/recursive:\n\n        - BaseModel\n        - Dataclasses\n        - TypedDict\n        - TypeAliasType\n        - Pydantic model\n        - Pydantic and stdlib dataclasses\n        - Typed dictionaries\n        - Named tuples\n        - `TypeAliasType` instances\n        - Enums\n        \"\"\"\n        ref = get_type_ref(tp)\n        # return the reference if we're either (1) in a cycle or (2) it was already defined\n        if ref in self.seen or ref in self.definitions:\n        # return the reference if we're either (1) in a cycle or (2) it the reference was already encountered:\n        if ref in self._recursively_seen or ref in self._definitions:\n            yield (ref, core_schema.definition_reference_schema(ref))\n        else:\n            self.seen.add(ref)\n            self._recursively_seen.add(ref)\n            try:\n                yield (ref, None)\n            finally:\n                self.seen.discard(ref)\n                self._recursively_seen.discard(ref)\n\n    def get_from_ref(self, ref: str) -> CoreSchema | None:\n        \"\"\"Resolve the schema from the given reference.\"\"\"\n        return self._definitions.get(ref)\n\n    def create_reference_to_schema(self, schema: CoreSchema) -> core_schema.DefinitionReferenceSchema:\n```"}, {"role": "assistant", "content": "Or even `create_definition_reference_schema` to be more explicit"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11208, "url": "https://github.com/pydantic/pydantic/pull/11208#discussion_r1905606673"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `config.py`:\n\n```python\nif mode not in (\"DEFAULT\", \"CONNECT_ONLY\", \"TUNNEL_ONLY\"):\n            raise ValueError(f\"Unknown proxy mode {mode!r}\")\n\n        if url.username or url.password:\n            headers.setdefault(\n                \"Proxy-Authorization\",\n                self.build_auth_header(url.username, url.password),\n            )\n            # Remove userinfo from the URL authority, e.g.:\n            # 'username:password@proxy_host:proxy_port' -> 'proxy_host:proxy_port'\n            credentials, _, authority = url.authority.rpartition(\"@\")\n            url = url.copy_with(authority=authority)\n```"}, {"role": "assistant", "content": "Perhaps replace these two lines with `ul = url.copy_with(username=None, password=None)`?"}], "_meta": {"repo": "encode/httpx", "pr_number": 780, "url": "https://github.com/encode/httpx/pull/780#discussion_r368442692"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_ctrl.py`:\n\n```python\n):\n        # Overwritten -- inputs_embeds not working properly\n\n        # only last tokens for inputs_ids if past is defined in kwargs\n        if past_key_values is not None:\n            past_length = past_key_values.get_seq_length()\n\n            # Some generation methods already pass only the last input ID\n            if input_ids.shape[1] > past_length:\n                remove_prefix_length = past_length\n            else:\n                # Default to old behavior: keep only final ID\n                remove_prefix_length = input_ids.shape[1] - 1\n\n            input_ids = input_ids[:, remove_prefix_length:]\n\n        model_inputs = {\"input_ids\": input_ids, \"past_key_values\": past_key_values, \"use_cache\": use_cache}\n        model_inputs = super().prepare_inputs_for_generation(\n```"}, {"role": "assistant", "content": "Oh right, some of the comments are a bit off imo. I wouldn't guess why `inputs_embeds` doesn't work looking at the code"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43280, "url": "https://github.com/huggingface/transformers/pull/43280#discussion_r2690639141"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n\"(useful when piping source on standard input).\"\n    ),\n)\n@click.option(\n    \"--python-cell-magics\",\n    multiple=True,\n```"}, {"role": "assistant", "content": "A bit jarring to write `--python-cell-magics custom1 --python-cell-magics custom2`. Should we use a comma-separated list instead?"}], "_meta": {"repo": "psf/black", "pr_number": 2744, "url": "https://github.com/psf/black/pull/2744#discussion_r778129323"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_lzma.py`:\n\n```python\nimport unittest\n\nfrom test.support import import_helper, threading_helper\nfrom test.support.threading_helper import run_concurrently\n\nlzma = import_helper.import_module(\"lzma\")\nfrom lzma import LZMACompressor, LZMADecompressor\n\nfrom test.test_lzma import INPUT\n\n\nNTHREADS = 10\n\n\n@threading_helper.requires_working_threading()\nclass TestLZMA(unittest.TestCase):\n    def test_compressor(self):\n        lzc = LZMACompressor()\n\n        # First compress() outputs LZMA header\n        header = lzc.compress(INPUT)\n        self.assertGreater(len(header), 0)\n\n        def worker():\n            # it should return empty bytes as it buffers data internally\n            data = lzc.compress(INPUT)\n            self.assertEqual(data, b\"\")\n\n        run_concurrently(worker_func=worker, nthreads=NTHREADS - 1)\n        full_compressed = header + lzc.flush()\n        decompressed = lzma.decompress(full_compressed)\n        # The decompressed data should be INPUT repeated NTHREADS times\n        self.assertEqual(decompressed, INPUT * NTHREADS)\n\n    def test_decompressor(self):\n        chunk_size = 128\n        chunks = [bytes([ord(\"a\") + i]) * chunk_size for i in range(NTHREADS)]\n        input_data = b\"\".join(chunks)\n        compressed = lzma.compress(input_data)\n\n        lzd = LZMADecompressor()\n        output = []\n\n        def worker():\n            data = lzd.decompress(compressed, chunk_size)\n            self.assertEqual(len(data), chunk_size)\n            output.append(data)\n```"}, {"role": "assistant", "content": "> `output.append(data)` without synchronization causes race conditions in free-threaded mode, potentially losing data or corrupting the list.\r\n\r\n `list` is thread safe in free-threaded build."}], "_meta": {"repo": "python/cpython", "pr_number": 140711, "url": "https://github.com/python/cpython/pull/140711#discussion_r2470432112"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dag_stability_checker.py`:\n\n```python\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport ast\nfrom dataclasses import dataclass\nfrom enum import Enum\nfrom pathlib import Path\n\n\nclass DagStabilityCheckerResult:\n    \"\"\"\n    Represents the result of stability analysis on a DAG file.\n\n    Stores detected warnings and formats them appropriately based on the configured check level\n    (warning or error).\n    \"\"\"\n\n    def __init__(self, check_level):\n        self.check_level: str = check_level\n        self.warnings: list[RuntimeVaryingValueWarning] = []\n        self.runtime_varying_values: dict = {}\n\n    def format_warnings(self) -> str | None:\n        \"\"\"Return formatted string of warning list.\"\"\"\n        if not self.warnings:\n            return None\n\n        lines = [\n            \"\u26a0\ufe0f This Dag uses runtime-variable values in Dag construction.\",\n            \"\u26a0\ufe0f It causes the Dag version to increase as values change on every Dag parse.\",\n            \"\",\n        ]\n        for w in self.warnings:\n            lines.append(f\"Line {w.line}, Col {w.col}\")\n            lines.append(f\"Code: {w.code}\")\n            lines.append(f\"Issue: {w.message}\")\n            lines.append(\"\")\n\n        if self.runtime_varying_values:\n            lines.append(\"\ufe0f\u26a0\ufe0f Don't use the variables as arguments in DAG/Task constructors:\")\n            # Sort by line number\n            sorted_vars = sorted(self.runtime_varying_values.items(), key=lambda x: x[1][0])\n            for var_name, (line, source) in sorted_vars:\n                lines.append(f\"  Line {line}: '{var_name}' related '{source}'\")\n            lines.append(\"\")\n```"}, {"role": "assistant", "content": "```suggestion\n            lines.extend(\n                [\n                    \"\ufe0f\u26a0\ufe0f Don't use the variables as arguments in DAG/Task constructors:\",\n                    *(\n                        f\"  Line {line}: '{var_name}' related '{source}'\"\n                        for var_name, (line, source) in sorted(\n                            self.runtime_varying_values.items(),\n                            key=lambda x: x[1][0],\n                        )\n                    ),\n                    \"\",\n                ]\n            )\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 59430, "url": "https://github.com/apache/airflow/pull/59430#discussion_r2660923594"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nself._created_lr_scheduler = False\n\n        # Set use_cache for the model\n        if getattr(self.model, \"config\", None) is not None:\n            self.model.config.use_cache = self.args.use_cache\n        if getattr(self.model, \"generation_config\", None) is not None:\n            self.model.generation_config.use_cache = self.args.use_cache\n```"}, {"role": "assistant", "content": "The logic stays as is, so yes, kwarg > config > generation config"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43000, "url": "https://github.com/huggingface/transformers/pull/43000#discussion_r2672089355"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_known_annotated_metadata.py`:\n\n```python\nreturn v\n\n            schema = cs.no_info_after_validator_function(val_func, schema)\n        elif isinstance(annotation, at.Not):\n            if hasattr(annotation.func, '__qualname__'):\n                func_name = annotation.func.__qualname__\n\n                def val_func(v: Any) -> Any:\n                    if annotation.func(v):  # noqa: B023\n                        raise PydanticCustomError(\n                            'not_operation_failed',\n                            f'Not of {func_name} failed',  # type: ignore  # noqa: B023\n                        )\n\n                    return v\n\n                schema = cs.no_info_after_validator_function(val_func, schema)\n            elif hasattr(annotation.func, '__class__'):\n                class_name = annotation.func.__class__.__qualname__\n\n                if (annotation_type := type(annotation.func)) in (at_to_constraint_map := _get_at_to_constraint_map()):\n                    constraint = at_to_constraint_map[annotation_type]\n\n                    def val_func(v: Any) -> Any:\n                        try:\n                            if get_constraint_validator(constraint)(v, getattr(annotation.func, constraint)) is v:  # noqa: B023\n                                raise PydanticCustomError(\n                                    'not_operation_failed',\n                                    f'Not of {class_name} failed',  # type: ignore  # noqa: B023\n                                )\n                        except PydanticKnownError:\n                            pass\n\n                        return v\n\n                    schema = cs.no_info_after_validator_function(val_func, schema)\n```"}, {"role": "assistant", "content": "So I'm inclined to just support callables, as the signature indicates - feel free to modify the tests accordingly."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10210, "url": "https://github.com/pydantic/pydantic/pull/10210#discussion_r1727583986"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_dataclasses.py`:\n\n```python\nTestInitVar(1, 2, 0)\n\n\ndef test_initvar_pydantic_field() -> None:\n    @pydantic.dataclasses.dataclass\n    class TestInitVar:\n        x: InitVar[int] = Field(title='X')\n\n        def __post_init__(self, x: int):\n            assert x == 1\n\n    assert TestInitVar.__pydantic_fields__['x'].init_var\n\n    t = TestInitVar(x=1)\n\n    with pytest.raises(AttributeError):\n        t.x\n\n\n@pytest.mark.xfail(reason='Ideally we should raise an attribute error, like stdlib dataclasses')\ndef test_initvar_pydantic_field() -> None:\n```"}, {"role": "assistant", "content": "```suggestion\r\ndef test_initvar_pydantic_field_attribute_access() -> None:\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12495, "url": "https://github.com/pydantic/pydantic/pull/12495#discussion_r2503936803"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `text_to_audio.py`:\n\n```python\ndef postprocess(self, waveform):\n        output_dict = {}\n\n        if isinstance(waveform, tuple):\n```"}, {"role": "assistant", "content": "Hi,  actually **return_dict_in_generate** should be used. because this is used in generate() func. speech t5 also has such issue. see the return of speech t5. tuple or tensor will be returned. https://github.com/huggingface/transformers/blob/main/src/transformers/models/speecht5/modeling_speecht5.py#L2561-L2593"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 29722, "url": "https://github.com/huggingface/transformers/pull/29722#discussion_r1547652073"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_florence2.py`:\n\n```python\n# Initialize weights and apply final processing\n        self.post_init()\n\n    def forward(self, hidden_states: torch.Tensor, **kwargs):\n    @check_model_inputs(tie_last_hidden_states=False)\n```"}, {"role": "assistant", "content": "we would also need `_can_record_outputs` in `Florence2VisionPreTrainedModel` to get all hiddens and attentions"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2639444868"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `retry.py`:\n\n```python\nFailed pages are collected on the scraping process and rescheduled at the end,\nonce the spider has finished crawling all regular (non failed) pages.\n\"\"\"\nimport warnings\nfrom logging import Logger, getLogger\nfrom typing import Optional, Union\n\nfrom twisted.internet import defer\nfrom twisted.internet.error import (\n    ConnectError,\n    ConnectionDone,\n    ConnectionLost,\n    ConnectionRefusedError,\n    DNSLookupError,\n    TCPTimedOutError,\n    TimeoutError,\n)\nfrom twisted.web.client import ResponseFailed\n\nfrom scrapy.core.downloader.handlers.http11 import TunnelError\nfrom scrapy.exceptions import NotConfigured\nimport six\n\nfrom scrapy.exceptions import NotConfigured, ScrapyDeprecationWarning\nfrom scrapy.http.request import Request\nfrom scrapy.settings import Settings\nfrom scrapy.spiders import Spider\nfrom scrapy.utils.misc import load_object\nfrom scrapy.utils.python import global_object_name\nfrom scrapy.utils.response import response_status_message\n\nretry_logger = getLogger(__name__)\n\n\nclass BackwardsCompatibilityMetaclass(type):\n    @property\n    def EXCEPTIONS_TO_RETRY(self):\n        warnings.warn(\n            \"Attribute RetryMiddleware.EXCEPTIONS_TO_RETRY is deprecated. \"\n            \"Use the RETRY_EXCEPTIONS setting instead.\",\n            ScrapyDeprecationWarning,\n            stacklevel=2,\n        )\n        return tuple(\n            load_object(x) if isinstance(x, six.string_types) else x\n```"}, {"role": "assistant", "content": "```suggestion\r\n            load_object(x) if isinstance(x, str) else x\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5929, "url": "https://github.com/scrapy/scrapy/pull/5929#discussion_r1188873515"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_list.py`:\n\n```python\nfrom typing import List\n\nimport pytest\nfrom dirty_equals import IsDict, IsOneOf, IsPartialDict\nfrom fastapi import FastAPI, File, Form, UploadFile\nfrom fastapi._compat import PYDANTIC_V2\nfrom fastapi.testclient import TestClient\nfrom pydantic import BaseModel\nfrom typing_extensions import Annotated\n\nfrom tests.utils import needs_pydanticv2\n\nfrom .utils import get_body_model_name\n\napp = FastAPI()\n\n# =====================================================================================\n# Without aliases\n\n\n@app.post(\"/list-bytes\", operation_id=\"list_bytes\")\nasync def read_list_bytes(p: Annotated[List[bytes], File()]):\n    return {\"file_size\": [len(file) for file in p]}\n\n\n@app.post(\"/list-uploadfile\", operation_id=\"list_uploadfile\")\nasync def read_list_uploadfile(p: Annotated[List[UploadFile], File()]):\n    return {\"file_size\": [file.size for file in p]}\n\n\nclass FormModelListBytes(BaseModel):\n    p: List[bytes] = File()\n\n\n@app.post(\"/model-list-bytes\", operation_id=\"model_list_bytes\")\nasync def read_model_list_bytes(\n    p: Annotated[\n        FormModelListBytes,\n        Form(\n            media_type=\"multipart/form-data\"  # Remove media_type when https://github.com/fastapi/fastapi/pull/14343 is fixed\n        ),\n    ],\n):\n    return {\"file_size\": [len(file) for file in p.p]}\n\n\nclass FormModelListUploadFile(BaseModel):\n    p: List[UploadFile] = File()\n\n\n@app.post(\"/model-list-uploadfile\", operation_id=\"model_list_uploadfile\")\nasync def read_model_list_uploadfile(\n    p: Annotated[\n        FormModelListUploadFile,\n        Form(\n            media_type=\"multipart/form-data\"  # Remove media_type when https://github.com/fastapi/fastapi/pull/14343 is fixed\n        ),\n    ],\n):\n    return {\"file_size\": [file.size for file in p.p]}\n```"}, {"role": "assistant", "content": "Let's remove these. Pydantic models with fields that should be read from bytes are not supported in FastAPI, at least not yet, and I'm not sure if it would make sense supporting it. Currently it's not supported to use a different function to declare a field in a Pydantic model other than `Field()` (at least not intentionally), I would prefer to avoid that for now."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 14358, "url": "https://github.com/fastapi/fastapi/pull/14358#discussion_r2607250726"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `pod_manager.py`:\n\n```python\nmessage_timestamp = line_timestamp\n                                progress_callback_lines.append(line)\n                            else:  # previous log line is complete\n                                for line in progress_callback_lines:\n```"}, {"role": "assistant", "content": "Here progress_callback_lines contains lines of logs. \r\nCan you share the full logs you were getting."}], "_meta": {"repo": "apache/airflow", "pr_number": 59372, "url": "https://github.com/apache/airflow/pull/59372#discussion_r2627393479"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_clip.py`:\n\n```python\n- 0 for tokens that are **masked**.\n\n                [What are attention masks?](../glossary#attention-mask)\n            causal_attention_mask (`torch.Tensor` of shape `(batch_size, sequence_length)`, *optional*):\n                Causal mask for the text model. Mask values selected in `[0, 1]`:\n\n                - 1 for tokens that are **not masked**,\n                - 0 for tokens that are **masked**.\n\n                [What are attention masks?](../glossary#attention-mask)\n            output_attentions (`bool`, *optional*):\n                Whether or not to return the attentions tensors of all attention layers. See `attentions` under\n                returned tensors for more detail.\n            output_hidden_states (`bool`, *optional*):\n                Whether or not to return the hidden states of all layers. See `hidden_states` under returned tensors\n                for more detail.\n            return_dict (`bool`, *optional*):\n                Whether or not to return a [`~utils.ModelOutput`] instead of a plain tuple.\n        \"\"\"\n        output_attentions = output_attentions if output_attentions is not None else self.config.output_attentions\n        output_hidden_states = (\n            output_hidden_states if output_hidden_states is not None else self.config.output_hidden_states\n        )\n\n        encoder_states = () if output_hidden_states else None\n        all_attentions = () if output_attentions else None\n\n        hidden_states = inputs_embeds\n        for idx, encoder_layer in enumerate(self.layers):\n            if output_hidden_states:\n                encoder_states = encoder_states + (hidden_states,)\n            layer_outputs = encoder_layer(\n        for encoder_layer in self.layers:\n            hidden_states = encoder_layer(\n                hidden_states,\n                attention_mask,\n                causal_attention_mask,\n                output_attentions=output_attentions,\n                **kwargs,\n            )\n\n            hidden_states = layer_outputs[0]\n\n            if output_attentions:\n                all_attentions = all_attentions + (layer_outputs[1],)\n\n        if output_hidden_states:\n            encoder_states = encoder_states + (hidden_states,)\n\n        return BaseModelOutput(\n            last_hidden_state=hidden_states,\n            hidden_states=encoder_states,\n            attentions=all_attentions,\n        )\n\n\nclass CLIPTextTransformer(nn.Module):\nclass CLIPTextTransformer(CLIPPreTrainedModel):\n```"}, {"role": "assistant", "content": "Due to some models using this as \"model\" backbone, I needed to make this a pretrained module to work with check_inputs"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41750, "url": "https://github.com/huggingface/transformers/pull/41750#discussion_r2445571995"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conftest.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport os\n\nos.environ[\"_AIRFLOW__AS_LIBRARY\"] = \"true\"\n```"}, {"role": "assistant", "content": "This will require getting rid of all the import side effects though"}], "_meta": {"repo": "apache/airflow", "pr_number": 59883, "url": "https://github.com/apache/airflow/pull/59883#discussion_r2672081389"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\n@mypyc_attr(patchable=True)\ndef parse_pyproject_toml(path_config: str) -> Dict[str, Any]:\n    \"\"\"Parse a pyproject toml file, pulling out relevant parts for Black\n    \"\"\"Parse a pyproject toml file, pulling out relevant parts for Black.\n\n    If parsing fails, will raise a tomllib.TOMLDecodeError\n    If parsing fails, will raise a tomllib.TOMLDecodeError.\n    \"\"\"\n    with open(path_config, \"rb\") as f:\n        pyproject_toml = tomllib.load(f)\n    config = pyproject_toml.get(\"tool\", {}).get(\"black\", {})\n    return {k.replace(\"--\", \"\").replace(\"-\", \"_\"): v for k, v in config.items()}\n    config: Dict[str, Any] = pyproject_toml.get(\"tool\", {}).get(\"black\", {})\n    config = {k.replace(\"--\", \"\").replace(\"-\", \"_\"): v for k, v in config.items()}\n\n    if \"target_version\" not in config:\n        inferred_target_version = infer_target_version(pyproject_toml)\n        if inferred_target_version is not None:\n            config[\"target_version\"] = [inferred_target_version.name.lower()]\n\n    return config\n\n\ndef infer_target_version(pyproject_toml: Dict[str, Any]) -> Optional[TargetVersion]:\n    \"\"\"Infer Black's target version from the project metadata in pyproject.toml.\n\n    If target version cannot be inferred, returns None.\n    \"\"\"\n    requires_python = get_req_python(pyproject_toml)\n    if requires_python is not None:\n        return parse_req_python(requires_python)\n    return None\n\n\ndef get_req_python(pyproject_toml: Dict[str, Any]) -> Optional[str]:\n    \"\"\"Get the required Python version from the project metadata.\n\n    Currently only supports the PyPA standard format:\n    https://packaging.python.org/en/latest/specifications/declaring-project-metadata/#requires-python\n\n    If the field is not present or cannot be parsed, returns None.\n    \"\"\"\n    project_metadata = pyproject_toml.get(\"project\", {})\n    requires_python: Optional[str] = project_metadata.get(\"requires-python\", None)\n    return requires_python\n\n\ndef parse_req_python(requires_python: str) -> Optional[TargetVersion]:\n```"}, {"role": "assistant", "content": "Much better this way! Added a commit with this change."}], "_meta": {"repo": "psf/black", "pr_number": 3219, "url": "https://github.com/psf/black/pull/3219#discussion_r998491252"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_engine.py`:\n\n```python\nassert b\"Traceback\" not in stderr, stderr\n\n\nclass TestEngineDownloadSync(TestEngineBase):\n    \"\"\"Test cases for the synchronous download method of ExecutionEngine.\"\"\"\n\n    def setUp(self):\n        super().setUp()\n        self.crawler = get_crawler(MySpider)\n        self.engine = ExecutionEngine(self.crawler, lambda _: None)\n        self.engine.downloader = Mock()\n        self.engine._slot = Mock()\n        self.engine._slot.inprogress = set()\n\n        # Stop the downloader's slot GC loop to prevent reactor cleanup issues\n        # self.engine.downloader._slot_gc_loop = Mock()\n        # self.engine.downloader._slot_gc_loop.running = False\n\n    def tearDown(self):\n        from twisted.internet import reactor\n\n        # Clean up any pending calls\n        for c in reactor.getDelayedCalls():\n            c.cancel()\n```"}, {"role": "assistant", "content": "Are there problems with these tests if this is not done? We have some rare failures related to something like this, but they are a more general problem and it looks like these new tests at least don't fail every time."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6842, "url": "https://github.com/scrapy/scrapy/pull/6842#discussion_r2126223180"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `exceptions.py`:\n\n```python\nsuper(RequestException, self).__init__(*args, **kwargs)\n\n\nclass JSONDecodeError(StandardJSONDecodeError, SimpleJSONDecodeError):\n    \"\"\"Couldn't decode the text into json\"\"\"\n\n\nclass InvalidJSONError(RequestException):\n```"}, {"role": "assistant", "content": "I think we're still waiting on a response here, ."}], "_meta": {"repo": "psf/requests", "pr_number": 5856, "url": "https://github.com/psf/requests/pull/5856#discussion_r667096117"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\nno_commas = (\n                original.is_def\n                and opening_bracket.value == \"(\"\n                and not any(leaf.type == token.COMMA for leaf in leaves)\n                and not any(\n                    leaf.type == token.COMMA\n                    and (\n                        Preview.typed_params_trailing_comma not in original.mode\n                        or not is_part_of_annotation(leaf)\n```"}, {"role": "assistant", "content": "I tried, but it ended up adding a lot of unrelated changes to this PR since `is_part_of_annotation` currently checks for both return and parameter annotations. I can do that refactor in a future PR."}], "_meta": {"repo": "psf/black", "pr_number": 4164, "url": "https://github.com/psf/black/pull/4164#discussion_r1466689991"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_auto.py`:\n\n```python\n# This is tied to the processing `-` -> `_` in `model_type_to_module_name`. For example, instead of putting\n# `transfo-xl` (as in `CONFIG_MAPPING_NAMES`), we should use `transfo_xl`.\nDEPRECATED_MODELS = []\nDEPRECATED_MODELS = [\n```"}, {"role": "assistant", "content": "`python utils/check_repo.py` fails with\r\n\r\n```Traceback (most recent call last):\r\n  File \"/home/eric_bezzam/transformers/utils/check_repo.py\", line 1311, in <module>\r\n    check_repo_quality()\r\n  File \"/home/eric_bezzam/transformers/utils/check_repo.py\", line 1305, in check_repo_quality\r\n    check_deprecated_constant_is_up_to_date()\r\n  File \"/home/eric_bezzam/transformers/utils/check_repo.py\", line 1219, in check_deprecated_constant_is_up_to_date\r\n    raise Exception(\"\\n\".join(message))\r\nException: The following models are in the deprecated folder, make sure to add them to `DEPRECATED_MODELS` in `models/auto/configuration_auto.py`: deta, efficientformer, ernie_m, gptsan_japanese, graphormer, jukebox, mctct, mega, mmbt, nat, nezha, open_llama, qdqbert, realm, retribert, speech_to_text_2, tapex, trajectory_transformer, transfo_xl, tvlt, van, vit_hybrid, xlm_prophetnet.\r\nmake: *** [Makefile:47: repo-consistency] Error 1\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43002, "url": "https://github.com/huggingface/transformers/pull/43002#discussion_r2640039895"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `db.py`:\n\n```python\nreturn None\n\n\ndef _handle_fab_downgrade(*, session: Session) -> None:\ndef _handle_fab_downgrade(*, session: Session, is_mysql: bool) -> None:\n```"}, {"role": "assistant", "content": "Are we sure we want to use a boolean here and change the api of the method instead of just having another function Incase of MySQL, and when calling it, have an if statement to decide which method to call"}], "_meta": {"repo": "apache/airflow", "pr_number": 59218, "url": "https://github.com/apache/airflow/pull/59218#discussion_r2645197334"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nself.cookies.extract_cookies(response)\n        response.default_encoding = self._default_encoding\n\n        status = f\"{response.status_code} {response.reason_phrase}\"\n        response_line = f\"{response.http_version} {status}\"\n        logger.debug(\n            'HTTP Request: %s %s \"%s\"', request.method, request.url, response_line\n        logger.info(\n```"}, {"role": "assistant", "content": "It could yes, though it's less useful to have logging if everything is at the same level.\r\nI like the different \"show me nothing\", \"show me the requests\", \"show me the debug\" lighting levels.\r\n\r\n(Similar: gunicorn, uvicorn using INFO for requests, and DEBUG for other stuffs)"}], "_meta": {"repo": "encode/httpx", "pr_number": 2547, "url": "https://github.com/encode/httpx/pull/2547#discussion_r1141930995"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `media.py`:\n\n```python\nfp = self._fingerprinter.fingerprint(request)\n        cb = request.callback or (lambda _: _)\n        eb = request.errback\n        request.callback = None\n```"}, {"role": "assistant", "content": "Hm, it might still be cleaner to add the no callback marker to these requests, as they're not supposed to use \"parse\" callback."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5798, "url": "https://github.com/scrapy/scrapy/pull/5798#discussion_r1086975090"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `helpers.py`:\n\n```python\ntry:\n            serialized = template_field.serialize()\n        except AttributeError:\n            serialized = str(template_field)\n            if callable(template_field):\n                full_qualified_name = qualname(template_field, True)\n                serialized = f\"<function {full_qualified_name}>\"\n```"}, {"role": "assistant", "content": "```suggestion\n                serialized = f\"<callable {full_qualified_name}>\"\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60065, "url": "https://github.com/apache/airflow/pull/60065#discussion_r2667317642"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asyncio.py`:\n\n```python\ndef install_asyncio_reactor():\n    \"\"\" Tries to install AsyncioSelectorReactor\n    \"\"\"\n    try:\n```"}, {"role": "assistant", "content": "Right, I missed that. I agree, `return` instead of `pass` in the first occurrence does sound better to me."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4010, "url": "https://github.com/scrapy/scrapy/pull/4010#discussion_r354536273"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `functools.py`:\n\n```python\nreturn decorating_function\n\ndef _lru_cache_wrapper(user_function, maxsize, typed, _CacheInfo):\n    if not callable(user_function):\n```"}, {"role": "assistant", "content": "I would definitely be a bigger change. if we move it to the caller, we would also have to touch the C code in `_funtoolsmodule.c`:\r\n\r\n```c\r\n    if (!PyCallable_Check(func)) {\r\n        PyErr_SetString(PyExc_TypeError,\r\n                        \"the first argument must be callable\");\r\n        return NULL;\r\n    }\r\n```\r\n\r\nmy goal in this PR is to get the behaviour of the C-version of `_lru_cache_wrapper` and the Python version of the same function into alignment (which they should have been from the start)."}], "_meta": {"repo": "python/cpython", "pr_number": 144031, "url": "https://github.com/python/cpython/pull/144031#discussion_r2712158444"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_siglip2.py`:\n\n```python\nfrom ...utils.generic import check_model_inputs, is_flash_attention_requested\n\n\nclass Siglip2Tokenizer(GemmaTokenizer):\n    \"\"\"\n    Gemma tokenizer + SigLIP2 training default: lowercase normalization.\n    \"\"\"\n\n    def __init__(\n        self,\n        vocab: str | dict[str, int] | None = None,\n        merges: str | list[str] | None = None,\n        unk_token: str = \"<unk>\",\n        bos_token: str = \"<bos>\",\n        eos_token: str = \"<eos>\",\n        pad_token: str = \"<pad>\",\n        mask_token: str = \"<mask>\",\n        **kwargs,\n    ):\n        super().__init__(\n            vocab=vocab,\n            merges=merges,\n            unk_token=unk_token,\n            bos_token=bos_token,\n            eos_token=eos_token,\n            pad_token=pad_token,\n            mask_token=mask_token,\n            **kwargs,\n        )\n\n        # Persist for save/load + push_to_hub dynamic tokenizer test\n        if hasattr(self, \"init_kwargs\") and isinstance(self.init_kwargs, dict):\n            self.init_kwargs.setdefault(\"tokenizer_class\", self.__class__.__name__)\n\n        backend = getattr(self, \"_tokenizer\", None)\n        if backend is not None and backend.normalizer is not None:\n            backend.normalizer = normalizers.Sequence([normalizers.Lowercase(), backend.normalizer])\n\n    def _unk_id(self) -> int:\n        raise ValueError(\"_unk_id is not needed for SigLIP2.\")\n```"}, {"role": "assistant", "content": "```suggestion\r\n        raise AttributeError(\"_unk_id is not needed for SigLIP2.\")\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43101, "url": "https://github.com/huggingface/transformers/pull/43101#discussion_r2736723615"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_http_headers.py`:\n\n```python\nself.assertEqual(h.getlist('X-Forwarded-For'), [b'ip1', b'ip2'])\n        assert h.getlist('X-Forwarded-For') is not hlist\n\n    def test_multivalue_for_one_header(self):\n        h = Headers(((\"a\", \"b\"), (\"a\", \"c\")))\n        self.assertEqual(h[\"a\"], b\"c\")\n        self.assertEqual(h.get(\"a\"), b\"c\")\n        self.assertEqual(h.getlist(\"a\"), [b\"b\", b\"c\"])\n        assert h.getlist(\"a\") is not [\"b\", \"c\"]\n```"}, {"role": "assistant", "content": "this check always returns True:\r\n\r\n```py\r\nIn [1]: [\"b\", \"c\"] is not [\"b\", \"c\"]\r\nOut[1]: True\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5526, "url": "https://github.com/scrapy/scrapy/pull/5526#discussion_r895972813"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `bigtable.py`:\n\n```python\n\"\"\"\n        instance = self.get_instance(instance_id=instance_id, project_id=project_id)\n        if instance is None:\n            raise RuntimeError(f\"Instance {instance_id} did not exist; unable to delete table {table_id}\")\n        table = instance.table(table_id=table_id)\n        table.delete()\n            self.log.warning(\"Instance '%s' does not exist in project '%s'. Exiting\", instance_id, project_id)\n```"}, {"role": "assistant", "content": "Here it actually makes sense to raise a `RuntimeError`, because the instance needs to exists so we could actually delete the table. After we ensure that it exists, then we could actually use `try..except` to supress the table if it doesn't exist - which apparently we already do in the operator."}], "_meta": {"repo": "apache/airflow", "pr_number": 60712, "url": "https://github.com/apache/airflow/pull/60712#discussion_r2702728664"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nreturn_type_schema = self._apply_field_serializers(\n            return_type_schema,\n            filter_field_decorator_info_by_field(field_serializers.values(), d.cls_var_name),\n            computed_field=True,\n        )\n```"}, {"role": "assistant", "content": "I believe you can remove the `computed_field` argument from the `_apply_field_serializers` function as well.\r\n\r\nhttps://github.com/pydantic/pydantic/blob/a6dc87285f93f90c2d5c298ee7c52f5d7e878194/pydantic/_internal/_generate_schema.py#L2196C9-L2201"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10390, "url": "https://github.com/pydantic/pydantic/pull/10390#discussion_r1758886279"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_configmap.py`:\n\n```python\n\"execution_api_server_url should not be set for Airflow 2.x versions\"\n            )\n\n    @pytest.mark.parametrize(\n        (\"git_sync_enabled\", \"ssh_key_secret\", \"ssh_key\", \"expected_volume\"),\n        [\n            (True, \"my-secret\", None, True),\n            (True, None, \"my-key\", True),\n            (True, \"my-secret\", \"my-key\", True),\n            (True, None, None, False),\n            (False, \"my-secret\", None, False),\n            (False, None, \"my-key\", False),\n        ],\n    )\n    def test_pod_template_git_sync_ssh_key_volume(\n        self, git_sync_enabled, ssh_key_secret, ssh_key, expected_volume\n    ):\n        dag_values = {\"gitSync\": {\"enabled\": git_sync_enabled}}\n        if ssh_key_secret:\n            dag_values[\"gitSync\"][\"sshKeySecret\"] = ssh_key_secret\n        if ssh_key:\n            dag_values[\"gitSync\"][\"sshKey\"] = ssh_key\n```"}, {"role": "assistant", "content": "Let's split this test into two test cases based on the settings (`sshKeySecret` or `sshKey`) that we set. It will be more readable, and in general, there should be no logic in tests"}], "_meta": {"repo": "apache/airflow", "pr_number": 59418, "url": "https://github.com/apache/airflow/pull/59418#discussion_r2624643825"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_transforms.py`:\n\n```python\nreturn x.float()\n\n\ndef _group_images_by_shape(nested_images, is_nested: bool = False):\n    \"\"\"Helper function to flatten a single level of nested image structures and group by shape.\"\"\"\ndef _group_images_by_shape(nested_images, *paired_inputs, is_nested: bool = False):\n```"}, {"role": "assistant", "content": "It's more that it's harder to read, even for internal use: at a glance, on this method I don't know what is `paired_inputs` and how to structure it from the get-go. Just my 2 cents, though, we can merge"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41393, "url": "https://github.com/huggingface/transformers/pull/41393#discussion_r2509341500"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_requests.py`:\n\n```python\nr = s.get(url)\n        assert r.status_code == 200\n\n    def test_connection_error(self):\n    def test_connection_error_invalid_domain(self):\n        \"\"\"Connecting to an unknown domain should raise a ConnectionError\"\"\"\n        with pytest.raises(ConnectionError):\n            requests.get(\"http://fooobarbangbazbing.httpbin.org\")\n            requests.get(\"http://doesnotexist.google.com\")\n\n    def test_connection_error_invalid_port(self):\n        \"\"\"Connecting to an invalid port should raise a ConnectionError\"\"\"\n        with pytest.raises(ConnectionError):\n            requests.get(\"http://httpbin.org:1\")\n```"}, {"role": "assistant", "content": "Huh. This line hangs on my machine and I'm pretty sure I wrote this test. Maybe your local machine is sending back a TCP RST, mine isn't"}], "_meta": {"repo": "psf/requests", "pr_number": 2436, "url": "https://github.com/psf/requests/pull/2436#discussion_r23981147"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `is_simple_lookup_for_doublestar_expression.py`:\n\n```python\n# flags: --preview\nm2 = None if not isinstance(dist, Normal) else m** 2 + s * 2\nm3 = None if not isinstance(dist, Normal) else m**2 + s * 2\nm4 = None if not isinstance(dist, Normal) else s**2 + s * 2\n```"}, {"role": "assistant", "content": "You are right, they are testing the same thing I'll remove the duplicate test."}], "_meta": {"repo": "psf/black", "pr_number": 4154, "url": "https://github.com/psf/black/pull/4154#discussion_r1477632836"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub_kernels.py`:\n\n```python\nlayer_name=\"RMSNorm\",\n                )\n            },\n            \"npu\": {\n                Mode.INFERENCE: LayerRepository(\n                    repo_id=\"kernels-community/liger_kernels\",\n                    layer_name=\"LigerRMSNorm\",\n                )\n            },\n```"}, {"role": "assistant", "content": "Yes, Triton can run on NPU. It only requires pip install triton-ascend, without modifying any of the original Triton code."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42106, "url": "https://github.com/huggingface/transformers/pull/42106#discussion_r2510512789"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\nreturn self.encoder\n\n    def freeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(False)\n\n    def unfreeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(True)\n```"}, {"role": "assistant", "content": "Yes agreed, we could start a deprecation cycle, or just remove it for v5. It's present in several other vision models"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2440576879"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `task.py`:\n\n```python\nTypeError: If not enough arguments are passed, or too many\n                arguments are passed.  Note that signature checks may\n                be disabled by specifying ``@task(typing=False)``.\n            ValueError: If soft_time_limit and time_limit are set,\n                and soft_time_limit is less than time_limit\n            ValueError: If soft_time_limit and time_limit both set\n```"}, {"role": "assistant", "content": "```suggestion\r\n            ValueError: If soft_time_limit and time_limit both are set\r\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 9246, "url": "https://github.com/celery/celery/pull/9246#discussion_r1750241415"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_connections.py`:\n\n```python\n{\"connection_id\": TEST_CONN_ID, \"conn_type\": \"ftp\"},\n        ],\n    )\n    def test_should_respond_403_by_default(self, test_client, body):\n    @mock.patch(\"airflow.api_fastapi.core_api.routes.public.connections.conf.get\")\n    def test_should_respond_403_by_default(self, mock_conf_get, test_client, body):\n        mock_conf_get.return_value = \"Disabled\"\n        response = test_client.post(\"/connections/test\", json=body)\n        assert response.status_code == 403\n        assert response.json() == {\n            \"detail\": \"Testing connections is disabled in Airflow configuration. \"\n            \"Contact your deployment admin to enable it.\"\n        }\n\n    @mock.patch.dict(os.environ, {\"AIRFLOW__CORE__TEST_CONNECTION\": \"Enabled\"})\n    def test_should_merge_password_with_existing_connection(self, test_client, session):\n        connection = Connection(\n            conn_id=TEST_CONN_ID,\n            conn_type=\"sqlite\",\n            password=\"existing_password\",\n        )\n        session.add(connection)\n        session.commit()\n\n        body = {\n            \"connection_id\": TEST_CONN_ID,\n            \"conn_type\": \"sqlite\",\n            \"password\": \"***\",\n        }\n        response = test_client.post(\"/connections/test\", json=body)\n        assert response.status_code == 200\n        assert response.json()[\"status\"] is True\n```"}, {"role": "assistant", "content": "I would also add an assertion to check wasn't mutated into db, and that no other connection record was created"}], "_meta": {"repo": "apache/airflow", "pr_number": 59643, "url": "https://github.com/apache/airflow/pull/59643#discussion_r2702177199"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n'Missing connection string! Do you have the'\n                ' database_url setting set to a real value?')\n\n        self.session_manager = SessionManager()\n\n        create_tables_at_setup = conf.get(\"database_create_tables_at_setup\", None)\n```"}, {"role": "assistant", "content": "Let's see.. hmm, why do we even want this warning?\nYeah, we can define v6.0.0 will change defaults, but do we really care to warn the user about it, potentially every time?"}], "_meta": {"repo": "celery/celery", "pr_number": 9228, "url": "https://github.com/celery/celery/pull/9228#discussion_r1759758531"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_multi_body_errors.py`:\n\n```python\n\"title\": \"Age\",\n                                \"anyOf\": [\n                                    {\"exclusiveMinimum\": 0.0, \"type\": \"number\"},\n                                    {\"type\": \"string\"},\n                                    IsOneOf(\n                                        # pydantic < 2.12.0a1\n                                        {\"type\": \"string\"},\n                                        # pydantic >= 2.12.0a1\n```"}, {"role": "assistant", "content": "```suggestion\r\n                                        # pydantic >= 2.12.0\r\n```"}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 14036, "url": "https://github.com/fastapi/fastapi/pull/14036#discussion_r2369203300"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub_kernels.py`:\n\n```python\nif hasattr(kernel, \"flash_attn_varlen_func\"):\n        if attention_wrapper is None:\n            attention_wrapper = flash_attention_forward\n        kernel_function = partial(attention_wrapper, implementation=kernel)\n```"}, {"role": "assistant", "content": "Changed the logic so that CB is now able to use all fa versions with lazy loading, i.e. fa2, fa3, kernels fas"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41427, "url": "https://github.com/huggingface/transformers/pull/41427#discussion_r2414380496"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sessions.py`:\n\n```python\n# Preferred clock, based on which one is more accurate on a given system.\nif sys.platform == 'win32':\n```"}, {"role": "assistant", "content": "It was a performance issue for Windows where the clock wasn't granular enough for CI to pass on Appveyor (#3988). I can take a look at standardizing everything onto perf_counter but that's probably a separate deep dive."}], "_meta": {"repo": "psf/requests", "pr_number": 6091, "url": "https://github.com/psf/requests/pull/6091#discussion_r833422938"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cache_manager.py`:\n\n```python\n# limitations under the License.\nfrom abc import ABC, abstractmethod\nfrom collections import deque\nfrom collections.abc import Iterator\nfrom math import ceil\nfrom typing import Optional\nfrom typing import Optional, TypeVar\n\nfrom .requests import logger\n\n\nT = TypeVar('T')\ndef reverse_enumerate(xs: list[T]) -> Iterator[tuple[int, T]]:\n    index = len(xs) - 1\n    for x in xs[::-1]:\n        yield index, x\n        index -= 1\n```"}, {"role": "assistant", "content": "yeah I figured it'd be slower, I was trolling mostly trolling writing this \ud83d\ude04\r\n\r\nI wonder if it's the `enumerate` or the `len` call that makes things slower tho"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42094, "url": "https://github.com/huggingface/transformers/pull/42094#discussion_r2522957919"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_gemma3n.py`:\n\n```python\nself.ffw_layer_1 = nn.Linear(self.config.hidden_size, self.config.hidden_size * 4, bias=False)\n        self.ffw_layer_2 = nn.Linear(self.config.hidden_size * 4, self.config.hidden_size, bias=False)\n        self.post_layer_norm = Gemma3nRMSNorm(self.config.hidden_size)\n        self.post_layer_scale = torch.tensor(self.config.conf_residual_weight)\n        self.register_buffer(\"post_layer_scale\", torch.tensor(self.config.conf_residual_weight), persistent=False)\n```"}, {"role": "assistant", "content": "Ha indeed, there is still an explicit tensor casting in the __init__. You can simply remove it and use as a scalar"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43178, "url": "https://github.com/huggingface/transformers/pull/43178#discussion_r2691336080"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_known_annotated_metadata.py`:\n\n```python\nreturn v\n\n            schema = cs.no_info_after_validator_function(val_func, schema)\n        elif isinstance(annotation, at.Not):\n            if hasattr(annotation.func, '__qualname__'):\n                func_name = annotation.func.__qualname__\n\n                def val_func(v: Any) -> Any:\n                    if annotation.func(v):  # noqa: B023\n                        raise PydanticCustomError(\n                            'not_operation_failed',\n                            f'Not of {func_name} failed',  # type: ignore  # noqa: B023\n                        )\n\n                    return v\n\n                schema = cs.no_info_after_validator_function(val_func, schema)\n            elif hasattr(annotation.func, '__class__'):\n                class_name = annotation.func.__class__.__qualname__\n\n                if (annotation_type := type(annotation.func)) in (at_to_constraint_map := _get_at_to_constraint_map()):\n                    constraint = at_to_constraint_map[annotation_type]\n\n                    def val_func(v: Any) -> Any:\n                        try:\n                            if get_constraint_validator(constraint)(v, getattr(annotation.func, constraint)) is v:  # noqa: B023\n                                raise PydanticCustomError(\n                                    'not_operation_failed',\n                                    f'Not of {class_name} failed',  # type: ignore  # noqa: B023\n                                )\n                        except PydanticKnownError:\n                            pass\n\n                        return v\n\n                    schema = cs.no_info_after_validator_function(val_func, schema)\n```"}, {"role": "assistant", "content": "```suggestion\r\n```\r\n\r\nI don't think we need this logic..."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10210, "url": "https://github.com/pydantic/pydantic/pull/10210#discussion_r1727506553"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_glm4v.py`:\n\n```python\nif t_bar * h_bar * w_bar > max_pixels:\n        beta = math.sqrt((num_frames * height * width) / max_pixels)\n        h_bar = math.floor(height / beta / factor) * factor\n        w_bar = math.floor(width / beta / factor) * factor\n        h_bar = max(factor, math.floor(height / beta / factor) * factor)\n        w_bar = max(factor, math.floor(width / beta / factor) * factor)\n```"}, {"role": "assistant", "content": "Yeah, GLM4V fails with tiny images if we add processing tests. I will make a new PR adding the tests"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39600, "url": "https://github.com/huggingface/transformers/pull/39600#discussion_r2259919980"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nuripar_function = load_object(uri_params) if uri_params else lambda x, y: None\n        uripar_function(params, spider)\n        return params\n\n    def _load_filter(self, feed_options):\n        # load the item filter if declared else load the default filter class\n        item_filter_class = load_object(feed_options.get(\"item_filter\",\"scrapy.itemchecker.ItemChecker\"))\n```"}, {"role": "assistant", "content": ":lipstick:  You could use the actual class here, instead of a string, provided you import it first.\r\n\r\n```suggestion\r\n        item_filter_class = load_object(feed_options.get(\"item_filter\", ItemChecker))\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5178, "url": "https://github.com/scrapy/scrapy/pull/5178#discussion_r650562793"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_black.py`:\n\n```python\none.write_text(\"print('hello')\", encoding=\"utf-8\")\n            two = (workspace / \"two.py\").resolve()\n            two.write_text(\"print('hello')\", encoding=\"utf-8\")\n            black.write_cache({}, [one], mode)\n            cache = black.Cache.read(mode)\n            cache.write([one])\n            invokeBlack([str(workspace)])\n            assert one.read_text(encoding=\"utf-8\") == \"print('hello')\"\n            assert two.read_text(encoding=\"utf-8\") == 'print(\"hello\")\\n'\n            cache = black.read_cache(mode)\n            assert str(one) in cache\n            assert str(two) in cache\n            cache = black.Cache.read(mode)\n            assert not cache.is_changed(one)\n            assert not cache.is_changed(two)\n\n    @pytest.mark.parametrize(\"color\", [False, True], ids=[\"no-color\", \"with-color\"])\n    def test_no_cache_when_writeback_diff(self, color: bool) -> None:\n        mode = DEFAULT_MODE\n        with cache_dir() as workspace:\n            src = (workspace / \"test.py\").resolve()\n            src.write_text(\"print('hello')\", encoding=\"utf-8\")\n            with patch(\"black.read_cache\") as read_cache, patch(\n                \"black.write_cache\"\n            with patch.object(black.Cache, \"read\") as read_cache, patch.object(\n                black.Cache, \"write\"\n            ) as write_cache:\n                cmd = [str(src), \"--diff\"]\n                if color:\n                    cmd.append(\"--color\")\n                invokeBlack(cmd)\n                cache_file = get_cache_file(mode)\n                assert cache_file.exists() is False\n                read_cache.assert_called_once()\n```"}, {"role": "assistant", "content": "Yeah, this was a result of initializing the cache with `cache = Cache.read(mode)`.  Technically it did one unnecessary read in some cases.\r\n\r\nChanging it wasn't too difficult. I just pushed 85b4a91c1b9dc70cb53af2dc37c9eaf4b985e453 to delay the cache read."}], "_meta": {"repo": "psf/black", "pr_number": 3821, "url": "https://github.com/psf/black/pull/3821#discussion_r1294300828"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\n\"\"\"\n)\nclass DetrForSegmentation(DetrPreTrainedModel):\n    _checkpoint_conversion_mapping = {\n        \"bbox_attention.q_linear\": \"bbox_attention.q_proj\",\n        \"bbox_attention.k_linear\": \"bbox_attention.k_proj\",\n    }\n```"}, {"role": "assistant", "content": "Yes the issue is that these mappings are only needed for `DetrForSegmentation`, and not other Detr models, so if I put them in the general conversion mapping, I get an error saying these patterns don't match any keys..."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2710671493"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `files.py`:\n\n```python\ngitignore = root / \".gitignore\"\n    lines: List[str] = []\n    if gitignore.is_file():\n        with gitignore.open() as gf:\n        with open(gitignore, \"rb\") as buf:\n            srcbuf = io.BytesIO(buf.read())\n            encoding, _ = tokenize.detect_encoding(srcbuf.readline)\n```"}, {"role": "assistant", "content": "`tokenize.detect_encoding` detects the encoding based on the approach used in Python files (`# encoding: utf-8` comments), so I don't think this works for gitignore files."}], "_meta": {"repo": "psf/black", "pr_number": 2229, "url": "https://github.com/psf/black/pull/2229#discussion_r632066309"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `offsite.py`:\n\n```python\nclass OffsiteMiddleware:\n    crawler: Crawler\n\n    def __init__(self, stats: StatsCollector):\n        self.stats = stats\n        self.domains_seen: set[str] = set()\n\n    @classmethod\n    def from_crawler(cls, crawler: Crawler) -> Self:\n        assert crawler.stats\n        o = cls(crawler.stats)\n        crawler.signals.connect(o.spider_opened, signal=signals.spider_opened)\n        crawler.signals.connect(o.request_scheduled, signal=signals.request_scheduled)\n        o.crawler = crawler\n        return o\n\n    def __init__(self, stats: StatsCollector):\n        self.stats = stats\n        self.domains_seen: set[str] = set()\n```"}, {"role": "assistant", "content": "For the record, I kind of like the `__init__` after the `from_crawler`, in order of execution :slightly_smiling_face:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7037, "url": "https://github.com/scrapy/scrapy/pull/7037#discussion_r2314576819"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n\"\"\"Shared provider discovery utilities and data structures.\"\"\"\n\nfrom __future__ import annotations\n\nimport contextlib\nimport json\nimport logging\nimport pathlib\nfrom collections.abc import Callable, MutableMapping\nfrom dataclasses import dataclass\nfrom functools import wraps\nfrom importlib.resources import files as resource_files\nfrom time import perf_counter\nfrom typing import Any, NamedTuple, ParamSpec\n\nfrom packaging.utils import canonicalize_name\n\nfrom airflow._shared.module_loading import entry_points_with_dist, import_string\nfrom airflow.exceptions import AirflowOptionalProviderFeatureException\n```"}, {"role": "assistant", "content": "Moving it to task sdk: https://github.com/apache/airflow/pull/60323"}], "_meta": {"repo": "apache/airflow", "pr_number": 60218, "url": "https://github.com/apache/airflow/pull/60218#discussion_r2676118842"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nfrom scrapy.utils.misc import create_instance, load_object\nfrom scrapy.utils.python import without_none_values\n\n\nlogger = logging.getLogger(__name__)\n```"}, {"role": "assistant", "content": "Hi. Of course. I don't know why but any time I am trying to reformat code using PyCharm it deletes that line. This time I forgot to bring it back."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4434, "url": "https://github.com/scrapy/scrapy/pull/4434#discussion_r446685533"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `decorators.py`:\n\n```python\ndef valid_method_info(self, info: ValidationInfo) -> Self: ...\n\n\nclass BeforeFieldValidator(BaseModel):\n    \"\"\"Same tests should apply to `mode='plain'`.\"\"\"\n\n    @field_validator('foo', mode='before')\n    def no_classmethod(self, value: Any) -> Any:\n        \"\"\"TODO this shouldn't be valid, the decorator should only work on classmethods.\n\n        We might want to do the same type checking as wrap model validators.\n        \"\"\"\n\n    @field_validator('foo', mode='before')\n    @classmethod\n    def valid_classmethod(cls, value: Any) -> Any: ...\n\n    @field_validator('foo', mode='before')  # pyright: ignore[reportArgumentType]\n    @classmethod\n    def invalid_with_info(cls, value: Any, info: int) -> Any: ...\n\n    @field_validator('foo', mode='before', json_schema_input_type=int)  # `input_type` allowed here.\n```"}, {"role": "assistant", "content": "Let's modify the comment to `json_schema_input_type` allowed here, and add the same one for the below `WrapFieldValidator` case"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10094, "url": "https://github.com/pydantic/pydantic/pull/10094#discussion_r1723999197"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_result.py`:\n\n```python\nresult = self.app.AsyncResult(self.task4['id'])\n        assert result.date_done is None\n\n    @pytest.mark.parametrize('result_dict, date', [\n        ({'date_done': None}, None),\n        ({'date_done': '1991-10-05T05:41:06'},\n         datetime.datetime(1991, 10, 5, 5, 41, 6)),\n        ({'date_done': datetime.datetime(1991, 10, 5, 5, 41, 6)},\n         datetime.datetime(1991, 10, 5, 5, 41, 6))\n    @patch('celery.app.base.to_utc')\n    @patch('celery.app.base.Celery.timezone', new_callable=mock.PropertyMock)\n    @pytest.mark.parametrize('timezone, date', [\n        (None, \"2024-08-24T00:00:00+00:00\"),\n```"}, {"role": "assistant", "content": "```suggestion\r\n        (\"utc\", \"2024-08-24T00:00:00+00:00\"),\r\n```"}], "_meta": {"repo": "celery/celery", "pr_number": 8385, "url": "https://github.com/celery/celery/pull/8385#discussion_r1732589232"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nreturn True\n        logger.error(\"Unknown feed format: %(format)s\", {'format': format})\n\n    def _batch_deliveries_supported(self, uri):\n        \"\"\"\n        If FEED_STORAGE_BATCH_ITEM_COUNT setting is specified uri has to contain %(batch_time)s or %(batch_id)s\n        to distinguish different files of partial output\n        \"\"\"\n        if self.storage_batch_size is None or '%(batch_time)s' in uri or '%(batch_id)s' in uri:\n```"}, {"role": "assistant", "content": "To support `0` as well:\r\n\r\n```suggestion\r\n        if not self.storage_batch_size or '%(batch_time)s' in uri or '%(batch_id)s' in uri:\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4434, "url": "https://github.com/scrapy/scrapy/pull/4434#discussion_r425952136"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `exceptions.py`:\n\n```python\nfrom typing import Any, Dict, Optional, Sequence, Type\nfrom typing import Any, Sequence, Type\n\nfrom pydantic import BaseModel, ValidationError, create_model\nfrom pydantic.error_wrappers import ErrorList\nfrom starlette.exceptions import HTTPException as StarletteHTTPException\n\n\nclass HTTPException(StarletteHTTPException):\n    def __init__(\n        self,\n        status_code: int,\n        detail: Any = None,\n        headers: Optional[Dict[str, Any]] = None,\n    ) -> None:\n        super().__init__(status_code=status_code, detail=detail)\n        self.headers = headers\n\nfrom starlette.exceptions import HTTPException as HTTPException  # noqa\n```"}, {"role": "assistant", "content": "```suggestion\r\nfrom starlette.exceptions import HTTPException\r\n```\r\n\r\nI suppose there's not reason for `noqa` anymore."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 4488, "url": "https://github.com/fastapi/fastapi/pull/4488#discussion_r866818027"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `manager.py`:\n\n```python\nself._processors[file] = processor\n            Stats.gauge(\"dag_processing.file_path_queue_size\", len(self._file_queue))\n\n    def add_files_to_queue(self, known_files: dict[str, set[DagFileInfo]]):\n    def _add_new_files_to_queue(self, known_files: dict[str, set[DagFileInfo]]):\n        \"\"\"\n        Add new files to the front of the queue.\n\n        A \"new\" file is a file that has not been processed yet and is not currently being processed.\n        \"\"\"\n        new_files = []\n        for files in known_files.values():\n            for file in files:\n                if file not in self._file_stats:  # todo: store stats by bundle also?\n                    # We found new file after refreshing dir. add to parsing queue at start\n                    self.log.info(\"Adding new file %s to parsing queue\", file)\n                    self._file_queue.appendleft(file)\n                # todo: store stats by bundle also?\n                if file not in self._file_stats and file not in self._processors:\n                    new_files.append(file)\n\n        if new_files:\n            self.log.info(\"Adding %d new files to the front of the queue\", len(new_files))\n            self._add_files_to_queue(new_files, True)\n```"}, {"role": "assistant", "content": "I don't think we need to, as we emit it as we start processes already, so it should already be up to date."}], "_meta": {"repo": "apache/airflow", "pr_number": 60124, "url": "https://github.com/apache/airflow/pull/60124#discussion_r2665139202"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `httpcompression.py`:\n\n```python\nif hasattr(spider, \"download_warnsize\"):\n            self._warn_size = spider.download_warnsize\n\n    @staticmethod\n    def _get_unsupported_suggestion(encoding: bytes) -> str:\n        if encoding == b\"br\":\n            return \" You need to install brotli or brotlicffi to use it.\"\n        if encoding == b\"zstd\":\n            return \" You need to install zstandard to use it.\"\n        return \"\"\n\n    def process_request(\n        self, request: Request, spider: Spider\n    ) -> Request | Response | None:\n\n        user_header = request.headers.get(\"Accept-Encoding\")\n        if user_header:\n```"}, {"role": "assistant", "content": "```suggestion\r\n        if user_header:\r\n            user_header = user_header.lower()\r\n```\r\n\r\nWhile I found no resource to confirm that the value is meant to be interpreted as case-insensitive (this was the closest), I suspect it should be. And it might be weird not to warn about `BR` but warn about `br`."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6618, "url": "https://github.com/scrapy/scrapy/pull/6618#discussion_r1922212392"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `21538.py`:\n\n```python\n# Regression test for https://github.com/astral-sh/ruff/issues/21538\nfoo = \"{'bar': {\\t'\"\n```"}, {"role": "assistant", "content": "This test already passes on `main`. The panic in that issue is caused because RUF027 calls `parse_expression` on `f\"{'bar': {\\t'\"`."}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 21895, "url": "https://github.com/astral-sh/ruff/pull/21895#discussion_r2606822195"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trainer.py`:\n\n```python\nreturn inputs\n\n    def _is_attention_mask_causal(self, attention_mask):\n        \"\"\"\n        Check if an attention mask is causal (compatible with causal attention).\n        Context parallelism only supports causal attention patterns. This function\n        checks if the provided attention mask is compatible.\n\n        Args:\n            attention_mask (torch.Tensor): The attention mask to check\n\n        Returns:\n            bool: True if the mask is causal or compatible with causal attention\n        \"\"\"\n        if attention_mask is None:\n            return True  # No mask is considered causal (model uses default causal masking)\n\n        # Handle different mask dimensions\n        if attention_mask.dim() == 2:\n            # (batch_size, seq_len) - standard padding mask, compatible with causal attention\n            return True\n        elif attention_mask.dim() in [3, 4]:\n            # (batch_size, seq_len, seq_len) or (batch_size, num_heads, seq_len, seq_len)\n            # Check if it's lower triangular (causal)\n            seq_len = attention_mask.shape[-1]\n            if seq_len <= 1:\n                return True  # Single token or empty is always causal\n\n            # Take first batch and head (if 4D) for checking pattern\n            if attention_mask.dim() == 4:\n                mask = attention_mask[0, 0]  # First batch, first head\n            else:\n                mask = attention_mask[0]  # First batch\n\n            # Check if upper triangular part is masked (should be 0 or very negative for causal)\n            upper_triangular = torch.triu(mask, diagonal=1)\n\n            # For causal masks, upper triangular should be 0 or very negative (like -inf)\n            # Use a reasonable threshold to handle float precision issues\n            is_causal = torch.all(upper_triangular <= 1e-6) or torch.all(upper_triangular < -1e4)\n            return is_causal.item() if isinstance(is_causal, torch.Tensor) else is_causal\n\n        # For unknown dimensions, be conservative and reject\n        return False\n\n    def _prepare_context_parallel_inputs(self, model, inputs: dict[str, Union[torch.Tensor, Any]]):\n        \"\"\"\n        Prepare inputs for context parallelism by setting up buffers and validation.\n\n        Args:\n            model: The model being trained\n            inputs: Input tensors to prepare\n\n        Returns:\n            tuple: (context_manager, prepared_inputs) where context_manager is either\n                   the context parallelism wrapper or a no-op context\n        \"\"\"\n        if (\n            getattr(self.accelerator, \"parallelism_config\") is not None\n```"}, {"role": "assistant", "content": "```suggestion\r\n            getattr(self.accelerator, \"parallelism_config\", None) is not None\r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40205, "url": "https://github.com/huggingface/transformers/pull/40205#discussion_r2293641714"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `image_processing_conditional_detr.py`:\n\n```python\nif \"pad_and_return_pixel_mask\" in kwargs:\n            do_pad = kwargs.pop(\"pad_and_return_pixel_mask\")\n\n        if \"max_size\" in kwargs:\n            logger.warning_once(\n                \"The `max_size` parameter is deprecated and will be removed in v4.26. \"\n                \"Please specify in `size['longest_edge'] instead`.\",\n            )\n            max_size = kwargs.pop(\"max_size\")\n        else:\n            max_size = None if size is None else 1333\n```"}, {"role": "assistant", "content": "I think in this case it's better to convert warning to a `ValueError`, so users know what is the reason if it crashes and how to fix it\r\n\r\nHub-related deprecations are so annoying sometimes \ud83d\ude43"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41681, "url": "https://github.com/huggingface/transformers/pull/41681#discussion_r2445131158"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `exporters.py`:\n\n```python\nself.file.write(b\"]\")\n\n    def export_item(self, item):\n        if self.first_item:\n            self.first_item = False\n        else:\n            self.file.write(b\",\")\n            self._beautify_newline()\n        itemdict = dict(self._get_serialized_fields(item))\n        data = self.encoder.encode(itemdict)\n        self.file.write(to_bytes(data, self.encoding))\n        # catch exception and don't add empty item for export\n        try:\n            itemdict = dict(self._get_serialized_fields(item))\n            data = to_bytes(self.encoder.encode(itemdict), self.encoding)\n        except TypeError as e:\n            raise e\n```"}, {"role": "assistant", "content": "But as this code does nothing then removing it won't break the test."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5952, "url": "https://github.com/scrapy/scrapy/pull/5952#discussion_r1260184819"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `integration_utils.py`:\n\n```python\nmetrics = rewrite_logs(metrics)\n            self._trackio.log(metrics)\n\n    def on_push_begin(self, args, state, control, model, **kwargs):\n        if not state.is_world_process_zero or self._trackio is None:\n            return\n        \n        import trackio\n        \n        trackio_version = packaging.version.parse(trackio.__version__)\n        if trackio_version <= packaging.version.parse(\"0.12.0\"):\n```"}, {"role": "assistant", "content": "I'd recommend forcing trackio>=0.12 directly in the callback init"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42850, "url": "https://github.com/huggingface/transformers/pull/42850#discussion_r2615576127"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\ndef _prepare_generation_config(\n        self,\n        generation_config: GenerationConfig | None,\n        use_model_defaults: bool | None = None,\n        **kwargs: Any,\n    ) -> tuple[GenerationConfig, dict]:\n        \"\"\"\n        Prepares the base generation config, then applies any generation configuration options from kwargs. This\n        function handles retrocompatibility with respect to configuration files.\n        \"\"\"\n        # parameterization priority:\n        # kwargs > non-global default values in `generation_config` > `model.generation_config` > GenerationConfig()\n        # user-defined kwargs or `generation_config` > `self.generation_config` > global default values\n        # NOTE: doesn't make sense to allow kwargs and `generation_config`. Might be strict and make them mutually exclusive?\n```"}, {"role": "assistant", "content": "Fair enough but maybe we can break for v5? Not super important but it gives us a good opportunity to do so. \r\n\r\nEither way, let's upgrade this to a TODO (as well)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42702, "url": "https://github.com/huggingface/transformers/pull/42702#discussion_r2610703988"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_namespace_utils.py`:\n\n```python\n# passed as a separate argument. However, internally, `_eval_type` calls\n    # `ForwardRef._evaluate` which will merge type params with the localns,\n    # essentially mimicking what we do here.\n    type_params: tuple[TypeVar, ...] = ()\n```"}, {"role": "assistant", "content": "I somehow forgot to actually fetch the type params here :thinking:"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11093, "url": "https://github.com/pydantic/pydantic/pull/11093#discussion_r1880710044"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `default_settings.py`:\n\n```python\nFEED_TEMPDIR = None\nFEEDS = {}\nFEED_URI_PARAMS = None  # a function to extend uri arguments\nFEED_STORE_EMPTY = False\nFEED_STORE_EMPTY = True\n```"}, {"role": "assistant", "content": "We need to update the docs accordingly."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5847, "url": "https://github.com/scrapy/scrapy/pull/5847#discussion_r1137406774"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_flash_attention_utils.py`:\n\n```python\nmax_length_q = int(q_len.max())\n        max_length_k = int(last_position_ids.max()) + 1\n    else:\n        position_ids = position_ids.flatten()\n        indices_q = torch.arange(position_ids.size(0), device=position_ids.device, dtype=torch.int32)\n```"}, {"role": "assistant", "content": "Yes, the creation of values on cuda device would mean that there is a blocking CPU to GPU memory copy. The new change is also blocking because  `nonzero` has to decide the resulting tensor shape. However, it is slightly faster than before. And the readability has improved."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40060, "url": "https://github.com/huggingface/transformers/pull/40060#discussion_r2279022258"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\n}\n        data = yield self.exported_no_data(settings)\n        self.assertEqual(data['csv'], b'')\n\n\nclass PartialDeliveriesTest(FeedExportTestBase):\n```"}, {"role": "assistant", "content": "Here and in a few other parts of the code it says \u201cpartial\u201d; \u201dbatch\u201d is more consistent with the rest of the code, and more unambiguous (\u201cpartial\u201d may be interpreted as not delivering all data).\r\n\r\n```suggestion\r\nclass BatchDeliveriesTest(FeedExportTestBase):\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4434, "url": "https://github.com/scrapy/scrapy/pull/4434#discussion_r425956446"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_black.py`:\n\n```python\nversions = black.detect_target_versions(root)\n        self.assertIn(black.TargetVersion.PY38, versions)\n\n    def test_detect_debug_f_strings(self) -> None:\n```"}, {"role": "assistant", "content": "Can you also include a couple of normal cases like the ones in here (not all of them, a couple should be enough)\r\n\r\nhttps://github.com/python/cpython/blob/71c3d649b5a0324c6eb01f9ad025c1e102b82bba/Lib/test/test_fstring.py#L1262-L1291"}], "_meta": {"repo": "psf/black", "pr_number": 3215, "url": "https://github.com/psf/black/pull/3215#discussion_r942606052"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sessions.py`:\n\n```python\nkwargs.setdefault('stream', self.stream)\n        kwargs.setdefault('verify', self.verify)\n        kwargs.setdefault('cert', self.cert)\n        kwargs.setdefault('proxies', self.rebuild_proxies(request, self.proxies))\n        if 'proxies' not in kwargs:\n```"}, {"role": "assistant", "content": "This change should actually fix the performance regression in most cases (`Session.request` - which I assume is the most common flow - always sets `proxies` on `kwargs`)."}], "_meta": {"repo": "psf/requests", "pr_number": 5924, "url": "https://github.com/psf/requests/pull/5924#discussion_r701262009"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dupefilters.py`:\n\n```python\nclass BaseDupeFilter:\n\n    @classmethod\n    def from_settings(cls, settings):\n        return cls()\n```"}, {"role": "assistant", "content": "Come to think of it, this is technically backward incompatible, as users may be calling `super().from_settings()` in their subclasses."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4524, "url": "https://github.com/scrapy/scrapy/pull/4524#discussion_r485469295"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `compat.py`:\n\n```python\nimport importlib\nimport sys\n\n# -------\n# urllib3\n# -------\nfrom urllib3 import __version__ as urllib3_version\n\n# Detect which major version of urllib3 is being used.\nis_urllib3_2 = urllib3_version.split('.')[0] == 2\n```"}, {"role": "assistant", "content": "I believe this is a string, not an integer. Also, should do a >= check instead of equals."}], "_meta": {"repo": "psf/requests", "pr_number": 6757, "url": "https://github.com/psf/requests/pull/6757#discussion_r1683193453"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nif isinstance(obj, PydanticRecursiveRef):\n            return core_schema.definition_reference_schema(schema_ref=obj.type_ref)\n\n        try:\n            if obj in {bool, int, float, str, bytes, list, set, frozenset, dict}:\n                # Note: obj may fail to be hashable if it has an unhashable annotation\n                return {'type': obj.__name__}\n            elif obj is tuple:\n                return {'type': 'tuple-variable'}\n        except TypeError:  # obj not hashable; can happen due to unhashable annotations\n            pass\n\n        if obj is Any or obj is object:\n            return core_schema.any_schema()\n        return self.match_type(obj)\n\n    def match_type(self, obj: Any) -> core_schema.CoreSchema:  # noqa: C901\n        \"\"\"Main mapping of types to schemas.\n\n        The general structure is a series of if statements starting with the simple cases\n        (non-generic primitive types) and then handling generics and other more complex cases.\n\n        Each case either generates a schema directly, calls into a public user-overridable method\n        (like `GenerateSchema.tuple_variable_schema`) or calls into a private method that handles some\n        boilerplate before calling into the user-facing method (e.g. `GenerateSchema._tuple_schema`).\n\n        The idea is that we'll evolve this into adding more and more user facing methods over time\n        as they get requested and we figure out what the right API for them is.\n        \"\"\"\n        if obj is str:\n            return self.str_schema()\n        elif obj is bytes:\n            return self.bytes_schema()\n        elif obj is int:\n            return self.int_schema()\n        elif obj is float:\n            return self.float_schema()\n        elif obj is bool:\n            return self.bool_schema()\n        elif obj is Any or obj is object:\n            return self.any_schema()\n        elif obj is None or obj is _typing_extra.NoneType:\n            return core_schema.none_schema()\n            return self.none_schema()\n        elif obj in TUPLE_TYPES:\n            return self._tuple_schema(obj)\n        elif obj in LIST_TYPES:\n            return self.list_schema(self._get_first_arg_or_any(obj))\n```"}, {"role": "assistant", "content": "Yeah I think that's a good call. Better to have it and not use it."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6737, "url": "https://github.com/pydantic/pydantic/pull/6737#discussion_r1271292276"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `openlineage.py`:\n\n```python\n# Conditional imports - only load expensive dependencies when plugin is enabled\nif not conf.is_disabled():\n    from airflow.lineage.hook import HookLineageReader\n    from airflow.providers.common.compat.sdk import HookLineageReader\n```"}, {"role": "assistant", "content": "We should yes, but in this case not added because it is already there: https://github.com/apache/airflow/blob/main/providers/openlineage/pyproject.toml#L63"}], "_meta": {"repo": "apache/airflow", "pr_number": 60968, "url": "https://github.com/apache/airflow/pull/60968#discussion_r2730859416"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `main.py`:\n\n```python\ndel self.__pydantic_private__[item]  # type: ignore\n                    return\n                except KeyError as exc:\n                    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc\n\n            self._check_frozen(item, None)\n\n            if item in self.__pydantic_fields__:\n                    raise AttributeError(f'{cls.__name__!r} object has no attribute {item!r}') from exc\n\n            model_frozen = cls.model_config.get('frozen', False)\n\n            field_info = self.__pydantic_fields__.get(item)\n            if field_info is not None:\n                if model_frozen or field_info.frozen:\n```"}, {"role": "assistant", "content": "We should make this consistent with the above pattern.\r\n\r\nIt's hard - we're not at the 3 repetition rule here that necessitates abstraction. I'm ok with keeping this duplicated code as long as it's as consistent as possible."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11432, "url": "https://github.com/pydantic/pydantic/pull/11432#discussion_r1952864207"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conf.py`:\n\n```python\nf.write(svg)\n\n\ndef replace_pr_numbers_with_links(content: str) -> str:\n    \"\"\"Replaces all PR numbers with the corresponding GitHub link.\"\"\"\n\n    base_url = \"https://github.com/psf/black/pull/\"\n    pr_num_regex = re.compile(r\"\\(#(\\d+)\\)\")\n\n    def num_to_link(match: re.Match) -> str:\n```"}, {"role": "assistant", "content": "```suggestion\r\n    def num_to_link(match: re.Match[str]) -> str:\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 4346, "url": "https://github.com/psf/black/pull/4346#discussion_r1589995328"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\njson_schema = populate_defs(schema, json_schema)\n        return json_schema\n\n    def sort(self, value: JsonSchemaValue, parent_key: str | None = None) -> JsonSchemaValue:\n        \"\"\"Override this method to customize the sorting of the JSON schema (e.g., don't sort at all, sort all keys unconditionally, etc.)\n\n        By default, alphabetically sort the keys in the JSON schema, skipping the 'properties' and 'default' keys to preserve field definition order.\n        This sort is recursive, so it will sort all nested dictionaries as well.\n        \"\"\"\n        sorted_dict: dict[str, JsonSchemaValue] = {}\n        keys = value.keys()\n        if (parent_key != 'properties') and (parent_key != 'default'):\n            keys = sorted(keys)\n        for key in keys:\n            sorted_dict[key] = self._sort_recursive(value[key], parent_key=key)\n        return sorted_dict\n\n    def _sort_recursive(self, value: Any, parent_key: str | None = None) -> Any:\n        \"\"\"Recursively sort a JSON schema value.\"\"\"\n        if isinstance(value, dict):\n            sorted_dict: dict[str, JsonSchemaValue] = {}\n            keys = value.keys()\n            if (parent_key != 'properties') and (parent_key != 'default'):\n```"}, {"role": "assistant", "content": "```suggestion\r\n            if parent_key not in ('properties', 'default'):\r\n```\r\n\r\nEasier to extend in the future"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10595, "url": "https://github.com/pydantic/pydantic/pull/10595#discussion_r1795639362"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_granitemoehybrid.py`:\n\n```python\n@require_torch\nclass GraniteMoeHybridModelTest(BambaModelTest, GenerationTesterMixin, unittest.TestCase):\nclass GraniteMoeHybridModelTest(ModelTesterMixin, GenerationTesterMixin, PipelineTesterMixin, unittest.TestCase):\n```"}, {"role": "assistant", "content": "Perhaps add a comment explaining why it is better not to inherit from another test, so if someone is tempted to do the same, that someone will have a hint"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42247, "url": "https://github.com/huggingface/transformers/pull/42247#discussion_r2535357003"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `video_processing_qwen3_vl.py`:\n\n```python\npatches = stacked_videos\n\n            # Check that videos have `num_frames` divisible by `temporal_patch_size`\n            if patches.shape[1] % temporal_patch_size != 0:\n                repeats = patches[:, -1:].repeat(1, temporal_patch_size - 1, 1, 1, 1)\n                patches = torch.cat([patches, repeats], dim=1)\n            T = patches.shape[1]\n            if pad := -T % temporal_patch_size:\n                repeats = patches[:, -1:].expand(-1, pad, -1, -1, -1)\n                patches = torch.cat((patches, repeats), dim=1)\n```"}, {"role": "assistant", "content": "done~ \r\ndid not change `smart_resize`. \r\nthe `smart_resize` in qwen2vl and qwen3vl video processor is not same, is it correct?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42083, "url": "https://github.com/huggingface/transformers/pull/42083#discussion_r2505847562"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_docs_extraction.py`:\n\n```python\n\"\"\"Utilities related to attribute docstring extraction.\"\"\"\nfrom __future__ import annotations\n\nimport ast\nimport inspect\nimport itertools\nimport textwrap\nfrom typing import Any\n\n\nclass DocstringVisitor(ast.NodeVisitor):\n    def __init__(self) -> None:\n        super().__init__()\n\n        self.target: str | None = None\n        self.attrs: dict[str, str] = {}\n        self.previous_node_type: type[ast.AST] | None = None\n\n    def visit(self, node: ast.AST) -> Any:\n        node_result = super().visit(node)\n        self.previous_node_type = type(node)\n        return node_result\n\n    def visit_AnnAssign(self, node: ast.AnnAssign) -> Any:\n        if isinstance(node.target, ast.Name):\n            self.target = node.target.id\n\n    def visit_Expr(self, node: ast.Expr) -> Any:\n        if isinstance(node.value, ast.Str) and self.previous_node_type is ast.AnnAssign:\n            docstring = inspect.cleandoc(node.value.s)\n            if self.target:\n                self.attrs[self.target] = docstring\n            self.target = None\n\n\ndef _dedent_source_lines(source: list[str]) -> str:\n    # Required for nested class definitions, e.g. in a function block\n    dedent_source = textwrap.dedent(''.join(source))\n    if dedent_source.startswith((' ', '\\t')):\n        # We are in the case where there's a dedented (usually multiline) string\n        # at a lower indentation level than the class itself. We wrap our class\n        # in a function as a workaround.\n        dedent_source = f'def dedent_workaround():\\n{dedent_source}'\n    return dedent_source\n\n\ndef _extract_source_from_frame(cls: type[Any]) -> list[str] | None:\n    frame = inspect.currentframe()\n\n    while frame:\n        lnum = frame.f_lineno\n        try:\n            lines, _ = inspect.findsource(frame)\n        except OSError:\n            # Source can't be parsed (maybe because running in an interactive terminal),\n            # we don't want to error here.\n            pass\n        else:\n            if inspect.getmodule(frame) is inspect.getmodule(cls) and isinstance(lnum, int):\n```"}, {"role": "assistant", "content": "According to typeshed:\r\n\r\n```python\r\n    # see discussion in #6769: f_lineno *can* sometimes be None,\r\n    # but you should probably file a bug report with CPython if you encounter it being None in the wild.\r\n    # An `int | None` annotation here causes too many false-positive errors.\r\n    \r\n    def f_lineno(self) -> int | Any: ...\r\n```\r\n\r\nMight be better to let the error be raised (`lines[lnum - 1 :]` will throw if `lnum` is `None`), so that it can be reported as stated?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6563, "url": "https://github.com/pydantic/pydantic/pull/6563#discussion_r1374437275"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_responses.py`:\n\n```python\ndef test_response():\n    response = httpx.Response(200, content=b\"Hello, world!\", request=REQUEST)\n    response = httpx.Response(\n        200,\n        content=b\"Hello, world!\",\n        request=httpx.Request(\"GET\", \"https://example.org\"),\n    )\n\n    assert response.status_code == 200\n    assert response.reason_phrase == \"OK\"\n    assert response.text == \"Hello, world!\"\n    assert response.request is REQUEST\n    assert response.request.method == \"GET\"\n    assert response.request.url == \"https://example.org\"\n    assert response.elapsed >= datetime.timedelta(0)\n    assert not response.is_error\n\n\ndef test_raise_for_status():\n    REQUEST = httpx.Request(\"GET\", \"https://example.org\")\n```"}, {"role": "assistant", "content": "I guess let's use the same \"use lowercase if not using globals\" convention here, even if it results in a slightly larger diff since we have to change the rest of this test case?\r\n```suggestion\r\n    request = httpx.Request(\"GET\", \"https://example.org\")\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1243, "url": "https://github.com/encode/httpx/pull/1243#discussion_r481419825"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tokenization_gemma.py`:\n\n```python\nself._tokenizer.decoder = decoders.Sequence(\n            [decoders.Replace(\"\u2581\", \" \"), decoders.ByteFallback(), decoders.Fuse()]\n        )\n        # Normalization replaces literal spaces with \"\u2581\", so splitting on \" \" would be a no-op.\n        self._tokenizer.normalizer = normalizers.Replace(\" \", \"\u2581\")\n        self._tokenizer.pre_tokenizer = pre_tokenizers.Split(\" \", \"merged_with_previous\")\n```"}, {"role": "assistant", "content": "Thanks! Agreed \u2014 the minimal one-liner is sufficient here.\r\nI\u2019ve removed the additional test and updated the PR accordingly."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43106, "url": "https://github.com/huggingface/transformers/pull/43106#discussion_r2669776282"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `kernel_config.py`:\n\n```python\nif not isinstance(repo_name, str) or \"/\" not in repo_name or \":\" not in repo_name:\n                        raise ValueError(\n                            f\"Kernel mapping for '{layer_name}' must be a valid repo name with a layer name (e.g., 'org/repo:layer_name'), got: {repo_name}\"\n                            f\"Kernel mapping for '{layer_name}' must be a valid repo name with a layer name (e.g., 'org/repo:layer_name' or '/abs-path:layer_name'), got: {repo_name}\"\n                        )\n            if kernel is not None and kernel[0] == \"/\":\n                self.check_kernel_from_local = True\n```"}, {"role": "assistant", "content": "It's a good idea to let users decide on local kernel loading. \ud83c\udf7b"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42800, "url": "https://github.com/huggingface/transformers/pull/42800#discussion_r2622957425"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `project.py`:\n\n```python\nreturn str(d)\n\n\ndef data_path(path: str, createdir: bool = False) -> str:\ndef data_path(path: Union[str, PathLike, Path], createdir: bool = False) -> str:\n```"}, {"role": "assistant", "content": "`pathlib.Path` is a subclass of `os.PathLike` so it's not needed to be mentioned separately here."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6133, "url": "https://github.com/scrapy/scrapy/pull/6133#discussion_r1381680291"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hitl.py`:\n\n```python\ntask_id=task_id,\n        session=session,\n        map_index=map_index,\n        try_number=None,\n    )\n    return task_instance.hitl_detail\n\n\n@task_instances_hitl_router.get(\n    task_instance_hitl_path + \"/tries/{try_number}\",\n    status_code=status.HTTP_200_OK,\n    responses=create_openapi_http_exception_doc([status.HTTP_404_NOT_FOUND]),\n    dependencies=[Depends(requires_access_dag(method=\"GET\", access_entity=DagAccessEntity.HITL_DETAIL))],\n)\ndef get_hitl_detail_try(\n```"}, {"role": "assistant", "content": "Double `detail` in the name is confusing. I get why it's there though. \r\n\r\nAlso I think in the current impl, you missed the trailing `s` `get_hitl_detail_try_detail`"}], "_meta": {"repo": "apache/airflow", "pr_number": 56760, "url": "https://github.com/apache/airflow/pull/56760#discussion_r2577679017"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `quantizer_quark.py`:\n\n```python\n@property\n    def is_trainable(self):\n        return False\n\n    def get_weight_conversions(self):\n        from ..core_model_loading import WeightConverter\n        from ..integrations.quark import QuarkDeserialize\n\n        return [\n            WeightConverter(\n                source_keys=[\"weight_scale\"], target_keys=\"weight_scale\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(source_keys=[\"bias_scale\"], target_keys=\"bias_scale\", operations=[QuarkDeserialize(self)]),\n            WeightConverter(\n                source_keys=[\"input_scale\"], target_keys=\"input_scale\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(\n                source_keys=[\"output_scale\"], target_keys=\"output_scale\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(\n                source_keys=[\"weight_zero_point\"], target_keys=\"weight_zero_point\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(\n                source_keys=[\"bias_zero_point\"], target_keys=\"bias_zero_point\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(\n                source_keys=[\"input_zero_point\"], target_keys=\"input_zero_point\", operations=[QuarkDeserialize(self)]\n            ),\n            WeightConverter(\n                source_keys=[\"output_zero_point\"], target_keys=\"output_zero_point\", operations=[QuarkDeserialize(self)]\n            ),\n        ]\n```"}, {"role": "assistant", "content": "let's do a loop, but good way to do many to many ;)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42457, "url": "https://github.com/huggingface/transformers/pull/42457#discussion_r2569255357"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `log.py`:\n\n```python\nand adapts it into a tuple of positional arguments for logger.log calls,\n    handling backward compatibility as well.\n    \"\"\"\n    if not {\"level\", \"msg\", \"args\"} <= set(logkws):\n        warnings.warn(\"Missing keys in LogFormatter method\", ScrapyDeprecationWarning)\n\n    if \"format\" in logkws:\n        warnings.warn(\n            \"`format` key in LogFormatter methods has been \"\n            \"deprecated, use `msg` instead\",\n            ScrapyDeprecationWarning,\n        )\n\n    level = logkws.get(\"level\", logging.INFO)\n    message = logkws.get(\"format\", logkws.get(\"msg\"))\n    message = logkws.get(\"msg\", \"\")\n    assert message is not None\n```"}, {"role": "assistant", "content": "Hi Gallarcio,\r\nI don't really understand why we have to fall back: `message = logkws[\"msg\"] or \"\"`.\r\n\r\nFirstly ,this part of the warnings has been removed according to    's comments https://github.com/scrapy/scrapy/pull/6116#discussion_r1363487495\r\n``` python\r\nif not {\"level\", \"msg\", \"args\"} <= set(logkws):\r\n        warnings.warn(\"Missing keys in LogFormatter method\", ScrapyDeprecationWarning)\r\n```\r\n----------------\r\nSecondly:\r\n> Gallaecio: The warning was about msg being a required key, so I think logkws[\"msg\"] instead of logkws.get(\"msg\", \"\") makes sense now that the warning is gone.\r\n\r\nAlthough msg is a requried key, but it is only mentioned and constrained in comments in `class LogFormatter`,  there is no actual code constraints. The user can still provide a dictionary without the `msg key`. Hence, if `key msg` is missing, simply using `logkws[\"msg\"]` would arise a KeyError.\r\n\r\nAnd I agree the point we cannot assert `message is not None`. \r\nIn fact, our current logging system could cope with the case `{\"msg\": None}`. So maybe only `message = logkws.get(\"msg\", \"\")` should be fine."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6116, "url": "https://github.com/scrapy/scrapy/pull/6116#discussion_r1366704279"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `strings.py`:\n\n```python\nelif codepoint > end_codepoint:\n            lowest = idx + 1\n        else:\n            return 0 if width < 0 else width\n            return max(width, 0)\n```"}, {"role": "assistant", "content": "Sounds good, this change was on the edge of inclusion anyways, so reverted."}], "_meta": {"repo": "psf/black", "pr_number": 4694, "url": "https://github.com/psf/black/pull/4694#discussion_r2145312326"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\nreturn self.encoder\n\n    def freeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(False)\n\n    def unfreeze_backbone(self):\n        for name, param in self.backbone.conv_encoder.model.named_parameters():\n        for _, param in self.backbone.model.named_parameters():\n            param.requires_grad_(True)\n```"}, {"role": "assistant", "content": "these methods should _really_ be user-side responsibilities :fearful: I would be pro-removal! We can always communicate on it"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2440475793"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scraper.py`:\n\n```python\ncrawler.settings[\"ITEM_PROCESSOR\"]\n        )\n        self.itemproc: ItemPipelineManager = itemproc_cls.from_crawler(crawler)\n        self._itemproc_needs_spider: dict[str, bool] = {}\n        for method in (\n        itemproc_methods = [\n            \"open_spider\",\n            \"close_spider\",\n            \"process_item\",\n        ]\n        if not hasattr(self.itemproc, \"process_item_async\"):\n            warnings.warn(\n                f\"{global_object_name(itemproc_cls)} doesn't define a process_item_async() method,\"\n                f\" this is deprecated and the method will be required in the future Scrapy versions.\",\n                ScrapyDeprecationWarning,\n                stacklevel=2,\n            )\n            itemproc_methods.append(\"process_item\")\n            self._itemproc_has_process_async = False\n        elif (\n            issubclass(itemproc_cls, ItemPipelineManager)\n            and method_is_overridden(itemproc_cls, ItemPipelineManager, \"process_item\")\n            and not method_is_overridden(\n                itemproc_cls, ItemPipelineManager, \"process_item_async\"\n            )\n        ):\n            warnings.warn(\n                f\"{global_object_name(itemproc_cls)} overrides process_item() but doesn't override process_item_async().\"\n                f\" This is deprecated. process_item() will be used, but in the future Scrapy versions process_item_async() will be used instead.\",\n```"}, {"role": "assistant", "content": "```suggestion\r\n                f\" This is deprecated. process_item() will be used, but in future Scrapy versions process_item_async() will be used instead.\",\r\n```\r\n\r\n(applies to similar strings as well)"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7005, "url": "https://github.com/scrapy/scrapy/pull/7005#discussion_r2269044848"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conf.py`:\n\n```python\ndef build_component_list(\n    compdict: MutableMapping[Any, Any],\n    custom: Any = None,\n    *,\n```"}, {"role": "assistant", "content": "While this seems similar to the `convert_image` scenario above, I feel like here we are more justified in this change, because the Pythonic way to fix `build_component_list({}, foo, bar)` was switching to `build_component_list({}, convert=bar)`.\r\n\r\nThat said, I wonder if we should follow a similar inspect-based deprecation approach here as well, in case some users went with `build_component_list({}, None, bar)` instead, as that was also a valid way to get rid of the warning."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6500, "url": "https://github.com/scrapy/scrapy/pull/6500#discussion_r1822174241"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `mode.py`:\n\n```python\nfeatures_and_magics,\n        ]\n        return \".\".join(parts)\n\n    def __hash__(self) -> int:\n```"}, {"role": "assistant", "content": "It would be easier to remove `lru_cache` from `make_comment`, and either add manual coaching or create an internal function that doesn't take `mode` within that function and put the lru_cache on that instead.\n\nI don't think that method cares about every aspect of `mode` when it's doing the caching."}], "_meta": {"repo": "psf/black", "pr_number": 4645, "url": "https://github.com/psf/black/pull/4645#discussion_r2224349638"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\nreturn \"True positives removed\"\n\n\n@dataclass(kw_only=True, slots=True)\nclass Evaluation:\n```"}, {"role": "assistant", "content": "This class feels pretty heavy only to support the case where one group has both true and false positives. \r\n\r\nI was wondering if we could change `classify` to return an iterable of `(Classification, int)` instead. Most groups return exactly one, with the exception of the `many` case where ty emits too many diagnostics, in which case we return two."}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22746, "url": "https://github.com/astral-sh/ruff/pull/22746#discussion_r2721493099"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `deb822_repository.py`:\n\n```python\ndescription:\n        - Tells APT whether the source is enabled or not.\n        type: bool\n    exclude:\n```"}, {"role": "assistant", "content": "Please create a changelog fragment. See this fragment as an example. And test for this change."}], "_meta": {"repo": "ansible/ansible", "pr_number": 86171, "url": "https://github.com/ansible/ansible/pull/86171#discussion_r2515053194"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `core_model_loading.py`:\n\n```python\n# Due to how our `_checkpoint_conversion_mapping` mappings are written, we need a few exceptions here\n        # when instantiating the reverse mapping (i.e. the targets become sources, and sources become targets)\n        # The issues lie in the sources usually, so here we need to check the targets for the reversed mapping\n\n        # Process target_patterns: detect capturing groups and replace with \\1\n        # Store the original capturing group patterns for reverse mapping\n        target_capturing_groups: list[str | None] = []\n        for i, pattern in enumerate(self.target_patterns):\n            # Some mapping contains `^` to notify start of string when matching -> remove it during reverse mapping\n            pattern = pattern.removeprefix(\"^\")\n            # Some mapping contains `$` to notify end of string when matching -> remove it during reverse mapping\n            pattern = pattern.removesuffix(\"$\")\n            # Remove negative lookahead/behind if any. This is ugly but needed for reverse mapping of\n            # Qwen2.5, Sam3, Ernie4.5 VL MoE!\n            pattern = re.sub(r\"\\(\\?.+\\)\", \"\", pattern)\n            # Allow capturing groups in patterns, i.e. to add/remove a prefix to all keys (e.g. timm_wrapper, sam3)\n            if r\"(.+)\" in pattern:\n                pattern = pattern.replace(r\"(.+)\", r\"\\1\")\n            self.target_patterns[i] = pattern\n            self.target_patterns[i], captured_group = reverse_target_pattern(pattern)\n            if captured_group is not None:\n                target_capturing_groups.append(captured_group)\n\n        # We also need to check capturing groups in the sources during reverse mapping (e.g. timm_wrapper, sam3)\n        capturing_groups_index = 0\n        for i, pattern in enumerate(self.source_patterns):\n            if r\"\\1\" in pattern:\n                pattern = pattern.replace(r\"\\1\", r\"(.+)\")\n```"}, {"role": "assistant", "content": "indeed this replace seems wrong! cc  if you know more"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2685644344"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_main.py`:\n\n```python\n]\n\n\nclass StrFoo(str, Enum):\n    FOO = 'foo'\n    BAR = 'bar'\n\n\n@pytest.mark.parametrize('value', [StrFoo.FOO, StrFoo.FOO.value, 'foo', 'hello'])\ndef test_literal_use_enum_values_multi_type(value):\n    class Model(BaseModel):\n        baz: Literal[StrFoo.FOO, 'hello']\n        model_config = ConfigDict(use_enum_values=True)\n\n    assert isinstance(Model(baz=value).baz, str)\n\n\ndef test_literal_use_enum_values_with_default():\n    class Model(BaseModel):\n        baz: Literal[StrFoo.FOO] = Field(default=StrFoo.FOO)\n        model_config = ConfigDict(use_enum_values=True)\n\n    assert isinstance(Model().baz, str)\n\n    validated = Model.model_validate_json('{\"baz\": \"foo\"}')\n    assert isinstance(validated.baz, str)\n\n    validated = Model.model_validate({'baz': StrFoo.FOO})\n    assert isinstance(validated.baz, str)\n```"}, {"role": "assistant", "content": "```suggestion\r\n.mark.parametrize('value', [StrFoo.FOO, StrFoo.FOO.value, 'foo', 'hello'])\r\ndef test_literal_use_enum_values_multi_type(value) -> None:\r\n    class Model(BaseModel):\r\n        baz: Literal[StrFoo.FOO, 'hello']\r\n        model_config = ConfigDict(use_enum_values=True)\r\n\r\n    assert isinstance(Model(baz=value).baz, str)\r\n\r\n\r\ndef test_literal_use_enum_values_with_default() -> None:\r\n    class Model(BaseModel):\r\n        baz: Literal[StrFoo.FOO] = Field(default=StrFoo.FOO)\r\n        model_config = ConfigDict(use_enum_values=True, validate_default=True)\r\n\r\n    validated = Model()\r\n    assert type(validated.baz) is str\r\n    assert type(validated.model_dump()['baz']) is str\r\n\r\n    validated = Model.model_validate_json('{\"baz\": \"foo\"}')\r\n    assert type(validated.baz) is str\r\n    assert type(validated.model_dump()['baz']) is str\r\n\r\n    validated = Model.model_validate({'baz': StrFoo.FOO})\r\n    assert type(validated.baz) is str\r\n    assert type(validated.model_dump()['baz']) is str\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9787, "url": "https://github.com/pydantic/pydantic/pull/9787#discussion_r1662588697"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_processing_common.py`:\n\n```python\nif \"tokenizer\" not in attribute:\n                    self.assertEqual(repr(attribute_first), repr(attribute_reloaded))\n\n    def test_save_load_pretrained_additional_features(self):\n        \"\"\"\n        Tests that additional kwargs passed to from_pretrained are correctly applied to components.\n        \"\"\"\n        attributes = self.processor_class.get_attributes()\n\n        if not any(attr in [\"tokenizer\", \"image_processor\"] for attr in attributes):\n```"}, {"role": "assistant", "content": "Added support for video_processor. However it looks like very few feature extractors actually use AudioKwargs, so it's difficult to set a kwargs that will work with all feature extractors safely. Maybe  you have more context to handle this?"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41773, "url": "https://github.com/huggingface/transformers/pull/41773#discussion_r2515278705"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloader_handlers.py`:\n\n```python\ntimeout = yield self.assertFailure(d, error.TimeoutError)\n        self.assertIn(domain, timeout.osError)\n\n    def test_download_with_proxy_without_http_scheme(self):\n        def _test(response):\n            self.assertEqual(response.status, 200)\n            self.assertEqual(response.url, request.url)\n            self.assertEqual(response.body, b'http://example.com')\n\n        http_proxy = self.getURL('').replace('http:', '')\n```"}, {"role": "assistant", "content": "I\u2019m guessing the reason it happens in the test is because it happens with `localhost` as proxy. You could argue that `localhost` being the proxy is uncommon, but still I think we should support it, specially if it\u2019s trivial to support."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4649, "url": "https://github.com/scrapy/scrapy/pull/4649#discussion_r447965472"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `databricks_workflow.py`:\n\n```python\nif not session:\n            raise AirflowException(\"Session not provided.\")\n\n        return session.query(DagRun).filter(DagRun.dag_id == dag.dag_id, DagRun.run_id == run_id).first()\n        dagrun = session.query(DagRun).filter(DagRun.dag_id == dag.dag_id, DagRun.run_id == run_id).first()\n```"}, {"role": "assistant", "content": "How about just use `.one()` instead and let SQLAlchemy raise the error?"}], "_meta": {"repo": "apache/airflow", "pr_number": 57768, "url": "https://github.com/apache/airflow/pull/57768#discussion_r2488747122"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `providers_manager.py`:\n\n```python\nself._plugins_set: set[PluginInfo] = set()\n        self._init_airflow_core_hooks()\n\n        self._runtime_manager = None\n\n    def __getattribute__(self, name: str):\n```"}, {"role": "assistant", "content": "Don't love this, maybe change it to each method I guess"}], "_meta": {"repo": "apache/airflow", "pr_number": 60218, "url": "https://github.com/apache/airflow/pull/60218#discussion_r2675305616"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_edgetam_video.py`:\n\n```python\ninput_modalities = (\"video\", \"text\")\n    _can_record_outputs = {\"mask_decoder_attentions\": OutputRecorder(EdgeTamVideoTwoWayAttentionBlock, index=2)}\n    _keys_to_ignore_on_load_unexpected = []\n    _tied_weights_keys = {\n        \"prompt_encoder.shared_embedding.positional_embedding\": \"shared_image_embedding.positional_embedding\"\n    }\n    # need to be ignored, as it's a buffer and will not be correctly detected as tied weight\n    _keys_to_ignore_on_load_missing = [\"prompt_encoder.shared_embedding.positional_embedding\"]\n```"}, {"role": "assistant", "content": "Everything seems to work just fine without it \ud83e\udd37, no warnings either"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42840, "url": "https://github.com/huggingface/transformers/pull/42840#discussion_r2614621229"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_audioflamingo3.py`:\n\n```python\n# coding=utf-8\n# Copyright 2025 NVIDIA CORPORATION and the HuggingFace Inc. team. All rights\n# reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\n\"\"\"PyTorch AudioFlamingo3 model.\"\"\"\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import Optional, Union\n\nimport torch\nfrom torch import nn\n\nfrom ...cache_utils import Cache\nfrom ...generation import GenerationMixin\nfrom ...masking_utils import eager_mask, padding_mask_function\nfrom ...modeling_outputs import BaseModelOutput, ModelOutput\nfrom ...modeling_utils import PreTrainedModel\nfrom ...utils import auto_docstring, logging\nfrom ..auto import AutoModelForCausalLM\nfrom ..whisper.modeling_whisper import WhisperAttention, WhisperEncoder, WhisperEncoderLayer\nfrom .configuration_audioflamingo3 import AudioFlamingo3Config, AudioFlamingo3EncoderConfig\n\n\nlogger = logging.get_logger(__name__)\n\n\n@dataclass\n@auto_docstring(\n    custom_intro=\"\"\"\n    Base class for AudioFlamingo3 causal language model (or autoregressive) outputs.\n    \"\"\"\n)\nclass AudioFlamingo3CausalLMOutputWithPast(ModelOutput):\n    \"\"\"\n    Output type of :class:`~transformers.AudioFlamingo3ForConditionalGeneration`.\n\n    Args:\n        loss (`torch.FloatTensor`, *optional*):\n            Next-token prediction loss (returned when `labels` is provided).\n        logits (`torch.FloatTensor`, *optional*):\n            Scores for each vocabulary token before SoftMax,\n            shape `(batch_size, sequence_length, vocab_size)`.\n        past_key_values (`Cache`, *optional*):\n            Cache to speed up autoregressive decoding.\n        hidden_states (`tuple(torch.FloatTensor)`, *optional*):\n            Hidden states of the language model.\n        attentions (`tuple(torch.FloatTensor)`, *optional*):\n            Attention maps of the language model.\n        attention_mask (`torch.FloatTensor`, *optional*):\n            Attention mask passed to the language model.\n    \"\"\"\n\n    loss: Optional[torch.FloatTensor] = None\n    logits: Optional[torch.FloatTensor] = None\n    past_key_values: Optional[Cache] = None\n    hidden_states: Optional[tuple[torch.FloatTensor, ...]] = None\n    attentions: Optional[tuple[torch.FloatTensor, ...]] = None\n    attention_mask: Optional[torch.FloatTensor] = None\n\n\nclass AudioFlamingo3Attention(WhisperAttention):\n    \"\"\"Alias of WhisperAttention kept for configuration/splitting consistency.\"\"\"\n```"}, {"role": "assistant", "content": "Can remove such comments so they don't appear in the modeling file."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40290, "url": "https://github.com/huggingface/transformers/pull/40290#discussion_r2440258977"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `setup.py`:\n\n```python\n'cssselect>=0.9.1',\n    'itemloaders>=1.0.1',\n    'parsel>=1.5.0',\n    'PyDispatcher>=2.0.5',\n```"}, {"role": "assistant", "content": "Nice catch, and great suggestion. Due to some circumstances, I am currently unable to do the suggestion in the near future though."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4814, "url": "https://github.com/scrapy/scrapy/pull/4814#discussion_r511918806"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nitems = parse_qsl(value)\n        elif isinstance(value, QueryParams):\n            items = value.multi_items()\n        elif isinstance(value, list):\n        elif type(value) in [list, tuple]:\n```"}, {"role": "assistant", "content": "From the docs for `type()`:\r\n> The `isinstance()` built-in function is recommended for testing the type of an object, because it takes subclasses into account.\r\n\r\nThis would be better written as:\r\n```suggestion\r\n        elif any(isinstance(value, t) for t in [list, tuple]):\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1426, "url": "https://github.com/encode/httpx/pull/1426#discussion_r541113627"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `video_processing_utils.py`:\n\n```python\nlogger.info(\n                f\"loading configuration file {video_processor_file} from cache at {resolved_video_processor_file}\"\n            )\n\n        # Specific models need the original path for modification in `from_dict`, e.g. see `Ernie 4.5 VL` with fonts\n        kwargs[\"resolved_file_path\"] = final_resolved_file_path\n```"}, {"role": "assistant", "content": "Like discussed, we cannot change it for now. Added a TODO when we can resolve the underlying class (to properly override)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39585, "url": "https://github.com/huggingface/transformers/pull/39585#discussion_r2611163123"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `session.py`:\n\n```python\ndef prepare_models(self, engine):\n        if not self.prepared:\n            ResultModelBase.metadata.create_all(engine)\n            # SQLAlchemy will check if the items exist before trying to\n            # create them, which is a race condition. If it raises an error\n            # in one iteration, the next may pass all the existence checks\n            # and the call will succeed.\n            max_retries = 10\n            retries = 0\n            while True:\n                try:\n                    ResultModelBase.metadata.create_all(engine)\n```"}, {"role": "assistant", "content": "So subsequent calls to `.create_all` will succeed, even if the schema has been already created?"}], "_meta": {"repo": "celery/celery", "pr_number": 6298, "url": "https://github.com/celery/celery/pull/6298#discussion_r491479502"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `snowflake_sql_api.py`:\n\n```python\nfor attempt in Retrying(**self.retry_config):  # type: ignore\n                with attempt:\n                    if method.upper() in (\"GET\", \"POST\"):\n                        response = session.request(\n                            method=method.lower(), url=url, headers=headers, params=params, json=json\n                        )\n                        request_kwargs = dict(method=method.lower(), url=url, headers=headers, params=params, json=json)\n```"}, {"role": "assistant", "content": "I'll make this change with the below review is complete.\r\nhttps://github.com/apache/airflow/pull/60689/files#r2700868724\r\n```python\r\nrequest_kwargs: dict[str, Any] = {\r\n    \"method\": method.lower(),\r\n    \"url\": url,\r\n    \"headers\": headers,\r\n    \"params\": params,\r\n    \"json\": json,\r\n}\r\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60689, "url": "https://github.com/apache/airflow/pull/60689#discussion_r2700975176"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pipeline_media.py`:\n\n```python\nself.assertIsNone(context)\n\n\nclass MockedMediaPipeline(MediaPipeline):\n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self._mockcalled = []\n\n    def download(self, request, info):\n        self._mockcalled.append(\"download\")\n        return super().download(request, info)\n\n    def media_to_download(self, request, info, *, item=None):\n        self._mockcalled.append(\"media_to_download\")\n        if \"result\" in request.meta:\n            return request.meta.get(\"result\")\n        return super().media_to_download(request, info)\n\n    def get_media_requests(self, item, info):\n        self._mockcalled.append(\"get_media_requests\")\n        return item.get(\"requests\")\n\n    def media_downloaded(self, response, request, info, *, item=None):\n        self._mockcalled.append(\"media_downloaded\")\n        return super().media_downloaded(response, request, info)\n\n    def media_failed(self, failure, request, info):\n        self._mockcalled.append(\"media_failed\")\n        return super().media_failed(failure, request, info)\n\n    def item_completed(self, results, item, info):\n        self._mockcalled.append(\"item_completed\")\n        item = super().item_completed(results, item, info)\n        item[\"results\"] = results\n        return item\n\n\nclass MediaPipelineTestCase(BaseMediaPipelineTestCase):\n```"}, {"role": "assistant", "content": "On the first glance this, or maybe parts of this, looks like tests for the `MediaPipeline` machinery so they need to stay (unless the same tests are also in some other class/file)."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6368, "url": "https://github.com/scrapy/scrapy/pull/6368#discussion_r1606070394"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `job.py`:\n\n```python\nlabel_selector = self._build_find_pod_label_selector(context, exclude_checked=exclude_checked)\n        pod_list: Sequence[k8s.V1Pod] = []\n        retry_number: int = 0\n        parallelism = self.parallelism or 1  # Default to using single pod parallelism\n\n        while len(pod_list) != self.parallelism or retry_number <= self.discover_pods_retry_number:\n        while len(pod_list) != parallelism or retry_number <= self.discover_pods_retry_number:\n```"}, {"role": "assistant", "content": "The while loop condition uses `or` but should use `and`. With the current logic, the loop will continue as long as either `len(pod_list) != parallelism` OR `retry_number <= self.discover_pods_retry_number` is true. This means:\n1. If pods are found matching the parallelism count, the loop continues as long as `retry_number <= self.discover_pods_retry_number`\n2. If the retry number exceeds the limit but pods don't match, it still continues\n\nThe correct logic should be: `while len(pod_list) != parallelism and retry_number <= self.discover_pods_retry_number:` to retry finding pods until either the expected count is found OR the retry limit is reached.\n```suggestion\n        while len(pod_list) != parallelism and retry_number <= self.discover_pods_retry_number:\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 53368, "url": "https://github.com/apache/airflow/pull/53368#discussion_r2594686671"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `base.py`:\n\n```python\nA = typing.TypeVar(\"A\", bound=\"AsyncBaseTransport\")\n\n\nclass SyncByteStream:\n    def __iter__(self) -> typing.Iterator[bytes]:\n        raise NotImplementedError(\n            \"The '__iter__' method must be implemented.\"\n        )  # pragma: nocover\n        yield b\"\"  # pragma: nocover\n\n    def close(self) -> None:\n        \"\"\"\n        Subclasses can override this method to release any network resources\n        after a request/response cycle is complete.\n\n        Streaming cases should call use a `try...finally` block to ensure that\n```"}, {"role": "assistant", "content": "```suggestion\r\n        Streaming cases should use a `try...finally` block to ensure that\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1550, "url": "https://github.com/encode/httpx/pull/1550#discussion_r611080393"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\n# because it could lead to inconsistent refs handling, etc.\n        cls = cast('type[BaseModel]', schema['cls'])\n        config = cls.model_config\n        title = config.get('title')\n\n        with self._config_wrapper_stack.push(config):\n            json_schema = self.generate_inner(schema['schema'])\n\n        self._update_class_schema(json_schema, cls, config)\n\n        return json_schema\n\n    def _update_class_schema(self, json_schema: JsonSchemaValue, cls: type[Any], config: ConfigDict) -> None:\n        \"\"\"Update json_schema with the following, extracted from `config` and `cls`:\n\n        * title\n        * description\n        * additional properties\n        * json_schema_extra\n        * deprecated\n\n        Done in place, hence there's no return value as the original json_schema is mutated.\n        No ref resolving is involved here, as that's not appropriate for simple updates.\n        \"\"\"\n        from .main import BaseModel\n        from .root_model import RootModel\n\n        if config_title := config.get('title'):\n            json_schema.setdefault('title', config_title)\n        elif model_title_generator := config.get('model_title_generator'):\n            title = model_title_generator(cls)\n            if not isinstance(title, str):\n                raise TypeError(f'model_title_generator {model_title_generator} must return str, not {title.__class__}')\n            json_schema.setdefault('title', title)\n        if 'title' not in json_schema:\n            json_schema['title'] = cls.__name__\n\n        # BaseModel and dataclasses; don't use cls.__doc__ as it will contain the verbose class signature by default\n        docstring = None if cls is BaseModel or dataclasses.is_dataclass(cls) else cls.__doc__\n\n        if docstring and 'description' not in json_schema:\n            json_schema['description'] = inspect.cleandoc(docstring)\n```"}, {"role": "assistant", "content": "```suggestion\r\n        if docstring:\r\n            json_schema.setdefault('description', inspect.cleandoc(docstring))\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10675, "url": "https://github.com/pydantic/pydantic/pull/10675#discussion_r1814919667"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_siglip2.py`:\n\n```python\nfor i in range(batch_size):\n            # (1, dim, height, width) -> (1, dim, target_height, target_width)\n            height, width = spatial_shapes[i]\n            height, width = spatial_shapes[i].tolist()  # will be itemized in F.interpolate either way\n            torch_compilable_check((width > 0), \"Width of resized positional embeddings must be positive.\")\n            torch_compilable_check((height > 0), \"Height of resized positional embeddings must be positive.\")\n            torch_compilable_check((height * width) <= max_length, \"Resized positional embeddings exceed max_length.\")\n```"}, {"role": "assistant", "content": "makes siglip2 exportable by checking for shapes validity. the itemization is done implicitly during interpolation so moving it here is just a more explicit rewrite."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43436, "url": "https://github.com/huggingface/transformers/pull/43436#discussion_r2720948590"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub_kernels.py`:\n\n```python\n_HUB_KERNEL_MAPPING: dict[str, dict[str, str]] = {\n    \"causal-conv1d\": {\"repo_id\": \"kernels-community/causal-conv1d\"},\n    \"mamba-ssm\": {\"repo_id\": \"kernels-community/mamba-ssm\", \"revision\": \"clean-mamba-ssm\"},\n```"}, {"role": "assistant", "content": "Copied over from: https://github.com/huggingface/transformers/pull/41664"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41540, "url": "https://github.com/huggingface/transformers/pull/41540#discussion_r2511342443"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_sam_hq.py`:\n\n```python\nimages=[raw_image, raw_image],\n            input_points=input_points,\n            input_labels=input_labels,\n            images_kwargs={\"point_pad_value\": -10},\n            point_pad_value=-10,\n            return_tensors=\"pt\",\n        ).to(torch_device)\n\n        with torch.no_grad():\n            outputs = model(**inputs)\n        scores = outputs.iou_scores.squeeze()\n        self.assertTrue(torch.allclose(scores[0][-1], torch.tensor(0.4482), atol=1e-4))\n        self.assertTrue(torch.allclose(scores[1][-1], torch.tensor(0.4482), atol=1e-4))\n        self.assertTrue(torch.allclose(scores[0][-1], torch.tensor(0.8858), atol=1e-4))\n        self.assertTrue(torch.allclose(scores[1][-1], torch.tensor(0.9092), atol=1e-4))\n```"}, {"role": "assistant", "content": "This was never passing and the values were completely wrong"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43420, "url": "https://github.com/huggingface/transformers/pull/43420#discussion_r2718055820"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trans.py`:\n\n```python\nreturn Err(cant_transform)\n\n\ndef hug_power_op(line: Line, features: Collection[Feature]) -> Iterator[Line]:\n    \"\"\"A transformer which normalizes spacing around power operators.\"\"\"\n\n    # Performance optimization to avoid unnecessary Leaf clones and other ops.\n    for leaf in line.leaves:\n        if leaf.type == token.DOUBLESTAR:\n            break\n    else:\n        raise CannotTransform(\"No doublestar token was found in the line.\")\n\n    def is_simple_lookup(index: int, step: Literal[1, -1]) -> bool:\n```"}, {"role": "assistant", "content": "Fair enough, my intuition would be to make private functions in that case. But style-wise I think it's a matter of taste, I was just more concerned about the potential performance hit with math-heavy code. Haven't tested it at all though \ud83d\ude04"}], "_meta": {"repo": "psf/black", "pr_number": 2726, "url": "https://github.com/psf/black/pull/2726#discussion_r779938242"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\npydantic_js_annotation_functions: list[GetJsonSchemaFunction] = []\n\n        def inner_handler(obj: Any) -> CoreSchema:\n            from_property = self._generate_schema_from_property(obj, source_type)\n            if from_property is None:\n            # TODO can obj be != source? if not, then just call self.generate_schema\n            schema = self._generate_schema_from_get_schema_method(obj, source_type)\n\n            if schema is None:\n                schema = self._generate_schema_inner(obj)\n```"}, {"role": "assistant", "content": "Turns out there's some cases where `obj != source_type` :/"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10863, "url": "https://github.com/pydantic/pydantic/pull/10863#discussion_r1848712466"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `unix_console.py`:\n\n```python\nfrom .unix_eventqueue import EventQueue\nfrom .utils import wlen\n\n# declare posix optional to allow None assignment on other platforms\n```"}, {"role": "assistant", "content": "iirc, `types` is either a) not a real module or b) already loaded at interpreter start, so this shouldn't be a big deal. a rudimentary test:\r\n\r\n```\r\n>>> timeit.timeit(\"import sys\")\r\n0.3161898439284414\r\n>>> timeit.timeit(\"import types\")\r\n0.05900560016743839\r\n```"}], "_meta": {"repo": "python/cpython", "pr_number": 118655, "url": "https://github.com/python/cpython/pull/118655#discussion_r1915225527"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nfor header in headers:\n            self[header] = headers[header]\n\n    def copy(self) -> \"Headers\":\n        return Headers(self.items(), encoding=self.encoding)\n```"}, {"role": "assistant", "content": "I've added the method back and documented & tested it."}], "_meta": {"repo": "encode/httpx", "pr_number": 1003, "url": "https://github.com/encode/httpx/pull/1003#discussion_r432041728"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `config.py`:\n\n```python\n3. Using `'never'` we would have gotten `user=SubUser(hobbies=['scuba diving'], sins=['lying'])`.\n    \"\"\"\n\n    ser_json_timedelta: Literal['iso8601', 'float']\n    ser_json_timedelta: Literal['iso8601', 'milliseconds_float', 'seconds_float']\n    \"\"\"\n    The format of JSON serialized timedeltas. Accepts the string values of `'iso8601'` and\n    `'float'`. Defaults to `'iso8601'`.\n    'seconds_float'`, `'float_milliseconds'` and `'float'`. Defaults to `'iso8601'`.\n```"}, {"role": "assistant", "content": "Should read:\r\n\r\n```\r\nThe format of JSON serialized timedeltas. Accepts the string values of `'iso8601'`, `'seconds_float'`, and `'milliseconds_float'`. Defaults to `'iso8601'`.\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10293, "url": "https://github.com/pydantic/pydantic/pull/10293#discussion_r1765147899"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `nodes.py`:\n\n```python\n)\n\n\ndef is_with_stmt(leaf: Leaf) -> bool:\n    \"\"\"Return True if the given leaf starts a with statement.\"\"\"\n    return bool(\n        leaf.type == token.NAME\n        and leaf.value == \"with\"\n```"}, {"role": "assistant", "content": "Does this also cover `async with`? We should treat both of these the same."}], "_meta": {"repo": "psf/black", "pr_number": 3589, "url": "https://github.com/psf/black/pull/3589#discussion_r1121131041"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cache.py`:\n\n```python\nCACHE_DIR = get_cache_dir()\n\n\ndef read_cache(mode: Mode) -> Cache:\n    \"\"\"Read the cache if it exists and is well formed.\n\n    If it is not well formed, the call to write_cache later should resolve the issue.\n    \"\"\"\n    cache_file = get_cache_file(mode)\n    if not cache_file.exists():\n        return {}\n\n    with cache_file.open(\"rb\") as fobj:\n        try:\n            cache: Cache = pickle.load(fobj)\n        except (pickle.UnpicklingError, ValueError, IndexError):\n            return {}\n\n    return cache\n\n\ndef get_cache_file(mode: Mode) -> Path:\n    return CACHE_DIR / f\"cache.{mode.get_cache_key()}.pickle\"\n\n\ndef get_cache_info(path: Path) -> CacheInfo:\n    \"\"\"Return the information used to check if a file is already formatted or not.\"\"\"\n    stat = path.stat()\n    return stat.st_mtime, stat.st_size\n\n@dataclass\nclass Cache:\n    mode: Mode\n    cache_file: Path\n    file_data: Dict[str, FileData] = field(default_factory=dict)\n\n    @classmethod\n    def read(cls, mode: Mode) -> Self:\n        \"\"\"Read the cache if it exists and is well formed.\n\n        If it is not well formed, the call to write later should\n        resolve the issue.\n        \"\"\"\n        cache_file = get_cache_file(mode)\n        if not cache_file.exists():\n            return cls(mode, cache_file)\n\n        with cache_file.open(\"rb\") as fobj:\n            try:\n                file_data: Dict[str, FileData] = pickle.load(fobj)\n            except (pickle.UnpicklingError, ValueError, IndexError):\n                return cls(mode, cache_file)\n\n        return cls(mode, cache_file, file_data)\n\n    @staticmethod\n    def hash_digest(path: Path) -> str:\n        \"\"\"Return hash digest for path.\"\"\"\n\n        with open(path, \"rb\") as fp:\n            data = fp.read()\n        return hashlib.sha256(data).hexdigest()\n```"}, {"role": "assistant", "content": "`sha256` works well for mypy. I would stick with it in this case.\r\nhttps://github.com/python/mypy/blob/v1.5.1/mypy/util.py#L501-L510"}], "_meta": {"repo": "psf/black", "pr_number": 3821, "url": "https://github.com/psf/black/pull/3821#discussion_r1292749167"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sdk.py`:\n\n```python\nTaskDeferred as TaskDeferred,\n        XComNotFound as XComNotFound,\n    )\n    from airflow.sdk.log import redact as redact\n```"}, {"role": "assistant", "content": "```suggestion\n    from airflow.sdk.log import redact\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 59688, "url": "https://github.com/apache/airflow/pull/59688#discussion_r2642392323"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_internvl.py`:\n\n```python\ndef set_input_embeddings(self, value):\n        self.language_model.set_input_embeddings(value)\n\n    @can_return_tuple\n    def get_image_features(\n        self,\n        pixel_values: torch.FloatTensor,\n        vision_feature_layer: Optional[Union[int, list[int]]] = None,\n        vision_feature_select_strategy: Optional[str] = None,\n        **kwargs,\n    ):\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> Union[torch.FloatTensor, BaseModelOutputWithPooling]:\n```"}, {"role": "assistant", "content": "i know it's not yet done typing-wise, just flagging, it is tuple or ModelOutput for all models"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2639480492"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nSee documentation in docs/topics/loaders.rst\n\"\"\"\nfrom collections import defaultdict\nfrom contextlib import suppress\nimport itemloaders\n\nfrom scrapy.item import Item\nfrom scrapy.loader.common import wrap_loader_context\nfrom scrapy.loader.processors import Identity\nfrom scrapy.selector import Selector\nfrom scrapy.utils.misc import arg_to_iter, extract_regex\nfrom scrapy.utils.python import flatten\n\n\ndef unbound_method(method):\n    \"\"\"\n    Allow to use single-argument functions as input or output processors\n    (no need to define an unused first 'self' argument)\n    \"\"\"\n    with suppress(AttributeError):\n        if '.' not in method.__qualname__:\n            return method.__func__\n    return method\n\n\nclass ItemLoader:\nclass ItemLoader(itemloaders.ItemLoader):\n\n    default_item_class = Item\n    default_input_processor = Identity()\n    default_output_processor = Identity()\n    default_selector_class = Selector\n\n    def __init__(self, item=None, selector=None, response=None, parent=None, **context):\n    def __init__(self, response=None, item=None, selector=None, parent=None, **context):\n```"}, {"role": "assistant", "content": "Any reason for changing arguments order here? It might break code that doesn't make use of named args."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4516, "url": "https://github.com/scrapy/scrapy/pull/4516#discussion_r416086594"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auth.py`:\n\n```python\nassert len(response.history) == 0\n\n\ndef test_digest_auth_returns_no_auth_if_alternate_auth_scheme() -> None:\n    url = \"https://example.org/\"\n    auth = DigestAuth(username=\"tomchristie\", password=\"password123\")\n    auth_header = b\"Token ...\"\n\n    client = Client(\n```"}, {"role": "assistant", "content": "CI is failing, I guess this should be `httpx.Client`?"}], "_meta": {"repo": "encode/httpx", "pr_number": 1240, "url": "https://github.com/encode/httpx/pull/1240#discussion_r480955747"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scrapydocs.py`:\n\n```python\n# pylint: disable=import-error\n# ruff: noqa: PGH003\nfrom collections.abc import Sequence\nfrom operator import itemgetter\nfrom typing import Any\n\nfrom docutils import nodes\nfrom docutils.nodes import Element, General, Node, document\nfrom docutils.parsers.rst import Directive\nfrom docutils.parsers.rst.roles import set_classes\nfrom sphinx.application import Sphinx\nfrom sphinx.util.nodes import make_refnode\n\n\nclass settingslist_node(nodes.General, nodes.Element):\nclass settingslist_node(General, Element):\n    pass\n\n\nclass SettingsListDirective(Directive):\n    def run(self):\n    def run(self) -> Sequence[Node]:\n        return [settingslist_node(\"\")]\n\n\ndef is_setting_index(node):\n    if node.tagname == \"index\" and node[\"entries\"]:\ndef is_setting_index(node: Node) -> bool:\n    if node.tagname == \"index\" and node[\"entries\"]:  # type: ignore\n        # index entries for setting directives look like:\n        # [('pair', 'SETTING_NAME; setting', 'std:setting-SETTING_NAME', '')]\n        entry_type, info, refid = node[\"entries\"][0][:3]\n        entry_type, info, refid = node[\"entries\"][0][:3]  # type: ignore\n        return entry_type == \"pair\" and info.endswith(\"; setting\")\n    return False\n\n\ndef get_setting_target(node):\ndef get_setting_target(node: Node) -> Node:\n    # target nodes are placed next to the node in the doc tree\n    return node.parent[node.parent.index(node) + 1]\n\n\ndef get_setting_name_and_refid(node):\ndef get_setting_name_and_refid(node: Node) -> tuple[Node, str]:\n    \"\"\"Extract setting name from directive index node\"\"\"\n    entry_type, info, refid = node[\"entries\"][0][:3]\n    entry_type, info, refid = node[\"entries\"][0][:3]  # type: ignore\n    return info.replace(\"; setting\", \"\"), refid\n\n\ndef collect_scrapy_settings_refs(app, doctree):\ndef collect_scrapy_settings_refs(app: Sphinx, doctree: document) -> None:\n    env = app.builder.env\n\n    if not hasattr(env, \"scrapy_all_settings\"):\n        env.scrapy_all_settings = []\n        env.scrapy_all_settings = []  # type: ignore\n\n    for node in doctree.traverse(is_setting_index):\n        targetnode = get_setting_target(node)\n        assert isinstance(targetnode, nodes.target), \"Next node is not a target\"\n    for node in doctree.findall(is_setting_index):\n        # This seems not needed anymore.\n```"}, {"role": "assistant", "content": "Interesting, the page is indeed generated correctly AFAICS.\r\n\r\n`def get_setting_target()` is also no longer needed then."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6624, "url": "https://github.com/scrapy/scrapy/pull/6624#discussion_r1922285753"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `shell.py`:\n\n```python\nb.append(\"Useful shortcuts:\")\n        if self.inthread:\n            b.append(\"  fetch(url[, redirect=True]) \"\n                     \"Fetch URL and update local objects \"\n                     \"(by default, redirects are followed)\")\n                     \"Fetch URL and update local objects (by default, redirects are followed)\")\n            b.append(\"  fetch(req)                  \"\n                     \"Fetch a scrapy.Request and update local objects \")\n        b.append(\"  shelp()           Shell help (print this help)\")\n        b.append(\"  view(response)    View response in a browser\")\n\n        return \"\\n\".join(\"[s] %s\" % l for l in b)\n        return \"\\n\".join(\"[s] %s\" % line for line in b)\n```"}, {"role": "assistant", "content": "Indeed, I almost did that, but I decided not to in order to keep the diff simpler. Perhaps we can do it in a later PR :+1:"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4558, "url": "https://github.com/scrapy/scrapy/pull/4558#discussion_r424398138"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nclass S3FeedStorage(BlockingFeedStorage):\n\n    def __init__(self, uri, access_key=None, secret_key=None, acl=None, endpoint_url=None, *,\n                 feed_options=None):\n    def __init__(self, uri, access_key=None, secret_key=None, session_token=None,\n                 acl=None, endpoint_url=None, *, feed_options=None):\n```"}, {"role": "assistant", "content": "I noticed the backward incompatibility of `S3FeedStorage.__init__()`. At first, I implemented this API exactly as you suggested.\r\n\r\nBut keeping the position of argument `acl` unchanged and adding `session_token` as a keyword argument, breaks the consistency with `S3DownloadHandler.__init__()`, `botocore.credentials.Credentials.__init__()`. We have to break one of them anyway."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5210, "url": "https://github.com/scrapy/scrapy/pull/5210#discussion_r677153622"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nraise ImportError(f'Module \"{module_path}\" does not define a \"{class_name}\" attribute/class')\n\n\ndef qualname(o: object | Callable) -> str:\ndef qualname(o: object | Callable, use_qualname: bool = False) -> str:\n    \"\"\"Convert an attribute/class/function to a string importable by ``import_string``.\"\"\"\n```"}, {"role": "assistant", "content": "```suggestion\n    \"\"\"Convert an attribute/class/callable to a string importable by ``import_string``.\"\"\"\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60065, "url": "https://github.com/apache/airflow/pull/60065#discussion_r2667320016"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_llama4.py`:\n\n```python\nThe id of the end of sentence token.\n        tie_word_embeddings (`bool`, *optional*, defaults to `False`):\n            Whether to tie weight embeddings\n        attention_dropout (`int`, *optional*, defaults to 0.0): TODO\n        num_experts_per_tok (`int`, *optional*, defaults to 1): TODO\n        num_local_experts (`int`, *optional*, defaults to 16): TODO\n        moe_layers (`int`, *optional*): TODO\n        interleave_moe_layer_step (`int`, *optional*, defaults to 1): TODO\n        use_qk_norm (`int`, *optional*, defaults to `True`): TODO\n        output_router_logits (`int`, *optional*, defaults to `False`): TODO\n        router_aux_loss_coef (`int`, *optional*, defaults to 0.001): TODO\n        router_jitter_noise (`int`, *optional*, defaults to 0.0): TODO\n        attention_dropout (`int`, *optional*, defaults to 0.0):\n            The dropout ratio for the attention probabilities.\n        num_experts_per_tok (`int`, *optional*, defaults to 1):\n            Number of experts to route each token to. This is the top-k value for the token-choice routing.\n        num_local_experts (`int`, *optional*, defaults to 16):\n            Number of experts for each Softmax router.\n        moe_layers (`int`, *optional*):\n```"}, {"role": "assistant", "content": "The parameter type should be `list` or `list[int]` instead of `int`. Looking at the function signature (line 286), `moe_layers` is defined as a list parameter that can be None. According to the description, it contains indices of layers that are MoE layers.\n```suggestion\n        moe_layers (`list[int]`, *optional*):\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43460, "url": "https://github.com/huggingface/transformers/pull/43460#discussion_r2723836591"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `generation_whisper.py`:\n\n```python\ncut_off_length=None,\n    return_token_timestamps=False,\n    force_unique_generate_call=False,\n    skip_ending_double_timestamps=False,\n```"}, {"role": "assistant", "content": "added a comment explaining this hidden parameters and links to related PRs to understand why we need it"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 35750, "url": "https://github.com/huggingface/transformers/pull/35750#discussion_r2169194604"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `configuration_utils.py`:\n\n```python\nlogger.warning_once(\"`torch_dtype` is deprecated! Use `dtype` instead!\")\n        self.dtype = value\n\n    @property\n    def rope_scaling(self):\n        logger.warning_once(\n            \"`rope_scaling` has been deprecated. Please use `rope_parameters` instead, which contains all RoPE configuration \"\n```"}, {"role": "assistant", "content": "(pls set target version for removal, perhaps something far away in the future like v5.6?)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39847, "url": "https://github.com/huggingface/transformers/pull/39847#discussion_r2413398953"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `setup.py`:\n\n```python\n'security': ['pyOpenSSL >= 0.14', 'cryptography>=1.3.4'],\n        'socks': ['PySocks>=1.5.6, !=1.5.7'],\n        'socks:sys_platform == \"win32\" and python_version == \"2.7\"': ['win_inet_pton'],\n        'lgpl': ['chardet>=3.0.2,<5']\n```"}, {"role": "assistant", "content": "This seems somewhat disingenuous. For one thing, it's not the _only_ way to get `lgpl` dependencies. For another, it really exists to just force `chardet` to be installed on py3 so should be named something more like `use_chardet_on_py3`"}], "_meta": {"repo": "psf/requests", "pr_number": 5797, "url": "https://github.com/psf/requests/pull/5797#discussion_r641068555"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\nf\"--python-version={python_version}\",\n            \"--output-format=gitlab\",\n            \"--ignore=assert-type-unspellable-subtype\",\n            \"--error=invalid-legacy-positional-parameter\",\n```"}, {"role": "assistant", "content": "this is necessary because I made the default severity of the lint `Level::Warn` rather than `Level::Error` (since it won't fail at runtime)"}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22943, "url": "https://github.com/astral-sh/ruff/pull/22943#discussion_r2741872858"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_canvas.py`:\n\n```python\n[\n                        stamped_header in link.options\n                        for stamped_header in link.options[\"stamped_headers\"]\n                        if link  # the link itself doensn't have a link\n                        if link  # the link itself doesn't have a link\n                    ],\n                    [\n                        stamped_header in link_error.options\n                        for stamped_header in link_error.options[\"stamped_headers\"]\n                        if link_error  # the link_error itself doensn't have a link\n                        if link_error  # the link_error itself doesn't have a link\n```"}, {"role": "assistant", "content": "```suggestion\r\n                        if link_error  # the link_error itself doesn't have a link_error\r\n```\r\nThis might also be a copy past typo, but since I'm still trying to understand the code I didn't change it."}], "_meta": {"repo": "celery/celery", "pr_number": 8498, "url": "https://github.com/celery/celery/pull/8498#discussion_r1323394698"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloader_handlers.py`:\n\n```python\nassert \"scheme\" not in dh._handlers\n        assert \"scheme\" in dh._notconfigured\n\n    def test_buggy_handler(self, caplog: pytest.LogCaptureFixture) -> None:\n        handlers = {\"scheme\": BuggyDH}\n        crawler = get_crawler(settings_dict={\"DOWNLOAD_HANDLERS\": handlers})\n        dh = DownloadHandlers(crawler)\n        assert \"scheme\" in dh._schemes\n        assert \"scheme\" not in dh._handlers\n        assert \"scheme\" in dh._notconfigured\n        assert (\n            'Loading \"<class \\'tests.test_downloader_handlers.BuggyDH\\'>\" for scheme \"scheme\"'\n            in caplog.text\n        )\n```"}, {"role": "assistant", "content": "This test verifies logging output but doesn't assert what happens after the exception is caught. Consider adding an assertion to verify the handler is properly marked as not configured."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7164, "url": "https://github.com/scrapy/scrapy/pull/7164#discussion_r2623561148"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cookies.py`:\n\n```python\ncookiejar.set_cookie(create_cookie(name, cookie_dict[name]))\n\n    return cookiejar\n\n\ndef merge_cookies(cookiejar, cookies):\n    \"\"\"Add cookies to cookiejar and returns a merged CookieJar.\n\n    :param cookiejar: CookieJar object to add the cookies to.\n    :param cookies: Dictionary or CookieJar object to be added.\n    \"\"\"\n    if not isinstance(cookiejar, cookielib.CookieJar):\n        raise ValueError('You can only merge into CookieJar')\n    \n    if isinstance(cookies, dict):\n        cookiejar = cookiejar_from_dict(\n            cookies, cookiejar=cookiejar, overwrite=False)\n    elif isinstance(cookies, cookielib.CookieJar):\n        try:\n            try:\n                cookiejar.update(cookies)\n            except AttributeError:\n                raise CookieJarError\n        except CookieJarError:\n            for cookie_in_jar in cookies:\n                cookiejar.set_cookie(cookie_in_jar)\n```"}, {"role": "assistant", "content": "Ah, sorry, I think we got our wires crossed here. There's no point throwing this exception if we're just going to catch it straight away. The right code here would be:\n\n``` python\ntry:\n    cookiejar.update(cookies)\nexcept AttributeError:\n    for cookie_in_jar in cookies:\n        cookierjar.set_cookie(cookie_in_jar)\n```"}], "_meta": {"repo": "psf/requests", "pr_number": 1713, "url": "https://github.com/psf/requests/pull/1713#discussion_r7458284"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\nself.assertEqual(row['expected'], data[feed_options['format']])\n\n\nclass FeedPostProcessedExportsTest(FeedExportTestBase):\n    __test__ = True\n\n    items = [{'foo': 'bar'}]\n    expected = b'foo\\r\\nbar\\r\\n'\n\n    class MyPlugin1:\n        def __init__(self, file, feed_options):\n            self.file = file\n            self.feed_options = feed_options\n            self.char = self.feed_options.get('plugin1_char', b'')\n\n        def write(self, data):\n            return self.file.write(bytes(data) + self.char)\n```"}, {"role": "assistant", "content": "Why is the casting needed? Who is trying to write a string instead of bytes? Maybe this should be fixed earlier in the execution."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5190, "url": "https://github.com/scrapy/scrapy/pull/5190#discussion_r676150909"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `media.py`:\n\n```python\nfp = self._fingerprinter.fingerprint(request)\n        cb = request.callback or (lambda _: _)\n        eb = request.errback\n        request.callback = None\n```"}, {"role": "assistant", "content": "> So we set callback to NO\\_CALLBACK twice, in get\\_media\\_requests and in \\_process\\_request (both called from process\\_item, one after the other)?\r\n\r\nYes. I think if the reader sees `FilesPipeline.get_media_requests()` with `Request(u, callback=NO_CALLBACK)`, it helps re-assure the idea that the `parse()` method isn't supposed to be involved here.\r\n\r\nAlthough they could also further inspect `MediaPipeline._process_request()` and see that `NO_CALLBACK` is assigned, they won't have to if `FilesPipeline.get_media_requests()` already shows it."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5798, "url": "https://github.com/scrapy/scrapy/pull/5798#discussion_r1090204896"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nbound = typevar.__bound__\n        constraints = typevar.__constraints__\n        typevar_default_value = getattr(typevar, '__default__', None)\n\n        try:\n            typevar_has_default = typevar.has_default()  # type: ignore\n        except AttributeError:\n            # could still have a default if it's an old version of typing_extensions.TypeVar\n            typevar_has_default = getattr(typevar, '__default__', None) is not None\n            typevar_has_default = typevar_default_value is not None\n\n        if (bound is not None) + (len(constraints) != 0) + typevar_has_default > 1:\n        if len(constraints) != 0 and (bound is not None or typevar_has_default):\n            raise NotImplementedError(\n                'Pydantic does not support mixing more than one of TypeVar bounds, constraints and defaults'\n                'Pydantic does not support mixing more than one of TypeVar constraints and default/bound'\n            )\n\n        if typevar_has_default:\n```"}, {"role": "assistant", "content": "I don't think we've fully added support here - if both `bound` and `default` are specified (and different), we need to figure out how to generate the right schema..."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10789, "url": "https://github.com/pydantic/pydantic/pull/10789#discussion_r1842464524"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `spidermw.py`:\n\n```python\nSee documentation in docs/topics/spider-middleware.rst\n\"\"\"\nfrom collections.abc import Iterable\nfrom itertools import islice\nfrom typing import Callable, Union, Any\nfrom typing import Callable, Union, Any, Generator, Iterable\n```"}, {"role": "assistant", "content": "```suggestion\r\nfrom typing import Any, Callable, Generator, Iterable, Union\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5077, "url": "https://github.com/scrapy/scrapy/pull/5077#discussion_r612571697"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `feedexport.py`:\n\n```python\nkey.close()\n\n\n\nclass GCSFeedStorage(BlockingFeedStorage):\n\n    project_id = None\n```"}, {"role": "assistant", "content": "No, I mean to declare them as instance attributes instead of class attributes.\r\nThis is how we are doing in `S3FeedStorage`, for example.\r\n\r\nClass attributes are really useful when storing constants or helper values, things that are shared across multiple instances of the same class.\r\n\r\nIn this case, I don't think you should reuse the storage settings.\r\n\r\nIn worst case scenarios, it could also lead to indesirable mutability when trying to change an instance attribute value causes the class attribute value and therefore all other instance attribute values to be changed too.\r\n\r\nIn a nutshell, you **need** those values in order to initialize the instance, so there's no reason to keep an unused default value as a class attribute."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 3608, "url": "https://github.com/scrapy/scrapy/pull/3608#discussion_r253478285"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_pools.py`:\n\n```python\nassert response_data[\"update\"][\"success\"] == [\"pool1\"]\n\n        # Assert: fetch from DB and check only masked field changed\n        updated_pool = session.query(Pool).filter_by(pool=\"pool1\").one()\n        updated_pool = session.scalars(select(Pool).where(Pool.pool == \"pool1\")).one()\n```"}, {"role": "assistant", "content": "what if we use ... \n`updated_pool = session.scalar(select(Pool).where(Pool.pool==\"pool1\"))`"}], "_meta": {"repo": "apache/airflow", "pr_number": 59733, "url": "https://github.com/apache/airflow/pull/59733#discussion_r2642021245"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `canvas.py`:\n\n```python\ndef _apply_tasks(self, tasks, producer=None, app=None, p=None,\n                     add_to_parent=None, chord=None,\n                     args=None, kwargs=None, **options):\n                     args=None, kwargs=None, group_index=None, **options):\n```"}, {"role": "assistant", "content": "It won't be used, I added the parameter to prevent it from being included in the `options`"}], "_meta": {"repo": "celery/celery", "pr_number": 9910, "url": "https://github.com/celery/celery/pull/9910#discussion_r2377870192"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_conditional_detr.py`:\n\n```python\nself.assertEqual(len(results[\"scores\"]), 5)\n        torch.testing.assert_close(results[\"scores\"], expected_scores, rtol=2e-4, atol=2e-4)\n        self.assertSequenceEqual(results[\"labels\"].tolist(), expected_labels)\n        torch.testing.assert_close(results[\"boxes\"][0, :], expected_slice_boxes)\n        # increase tolerance for boxes to 2e-4 as now using sdpa attention by\n```"}, {"role": "assistant", "content": "```suggestion\r\n        # increase tolerance for boxes to 2e-4 as sdpa attention new default shifts results \r\n```"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2711547982"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_commands.py`:\n\n```python\nself.assertEqual(2, self.call('genspider', self.project_name))\n        assert not exists(join(self.proj_mod_path, 'spiders', '%s.py' % self.project_name))\n\n    def test_same_name_as_existing_spider(self):\n        self.call('genspider', 'example', 'example.com')\n        self.assertEqual(0, self.call('genspider', 'example', 'example.com'))\n```"}, {"role": "assistant", "content": "I think we could maybe compare the md5 checksum of the file before and after if it's really necessary. Do you think we need that or should I just stick to checking the printed message?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4623, "url": "https://github.com/scrapy/scrapy/pull/4623#discussion_r438947016"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\ndef host(self) -> str:\n        \"\"\"\n        The URL host as a string.\n        Always normlized to lowercase, and IDNA encoded.\n        Always normlized to lowercase, with IDNA hosts decoded into unicode.\n```"}, {"role": "assistant", "content": "Old typo\r\n```suggestion\r\n        Always normalized to lowercase, with IDNA hosts decoded into unicode.\r\n```"}], "_meta": {"repo": "encode/httpx", "pr_number": 1590, "url": "https://github.com/encode/httpx/pull/1590#discussion_r618621946"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `cache_manager.py`:\n\n```python\nelse:\n            self._uninit_block_ids.extend(blocks)\n\n    def uninitialize_redundant_block(self, block_id: int) -> None:\n```"}, {"role": "assistant", "content": "```suggestion\r\n    def reset_redundant_block(self, block_id: int) -> None:\r\n```\r\nif this is what it is doing"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43150, "url": "https://github.com/huggingface/transformers/pull/43150#discussion_r2685563714"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_gpt_oss.py`:\n\n```python\nmodel_split_percents = [0.5, 0.6]\n    model_tester_class = GptOssModelTester\n\n    def test_initialization_raises_error_for_flash_attn(self):\n```"}, {"role": "assistant", "content": "We have decorators for non-standard library, here you should use `` and ``"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42736, "url": "https://github.com/huggingface/transformers/pull/42736#discussion_r2622664297"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `exceptions.py`:\n\n```python\n\"\"\"\nfrom urllib3.exceptions import HTTPError as BaseHTTPError\n\ntry:\n```"}, {"role": "assistant", "content": "For Python 3, in the `compat.py` file itself, reference to the `json` package directly, whether aliased as `json` or actually the `json` package itself, would always look for the `json` package rather than whatever was aliased as it. So, just in the `compat.py` file itself, I used the check. From all other scripts that have `from .compat import json`, however, it works as expected."}], "_meta": {"repo": "psf/requests", "pr_number": 5856, "url": "https://github.com/psf/requests/pull/5856#discussion_r673381345"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `utils.py`:\n\n```python\ngeneration_config = self.generation_config\n\n        # `torch.compile` can't compile `copy.deepcopy`, arguments in `kwargs` that are part of `generation_config`\n        # will mutate the object with `.update`. As such, passing these arguments through `kwargs` is disabled.\n        if is_torchdynamo_compiling():\n            model_kwargs = kwargs\n            generate_attributes_in_kwargs = [\n                key for key, value in kwargs.items() if getattr(generation_config, key, None) != value\n            ]\n            if len(generate_attributes_in_kwargs) > 0:\n                raise ValueError(\n                    \"`torch.compile` exception: all generation configuration attributes must be passed within a \"\n                    f\"`generation_config` instance passed to `generate` (found: {generate_attributes_in_kwargs}).\"\n                )\n        else:\n        # will mutate the object with `.update`. As such, passing these arguments through `kwargs` is disabled -- an\n        # exception will be raised in `_validate_model_kwargs`\n        if not is_torchdynamo_compiling():\n            generation_config = copy.deepcopy(generation_config)\n            model_kwargs = generation_config.update(**kwargs)\n        else:\n            model_kwargs = kwargs\n```"}, {"role": "assistant", "content": "The only option to add kwargs is through model's generation config? Maybe we need to add this in the docs"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 30788, "url": "https://github.com/huggingface/transformers/pull/30788#discussion_r1615779225"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nreturn _linked_to_musl\n    _linked_to_musl = tuple(map(int, version.split('.')))\n    return _linked_to_musl\n\n\ntry:\n```"}, {"role": "assistant", "content": "I think this will be easier to do in `Lib/test/test_capi/test_misc.py`. In particular only need to\r\n1. Add a new `_testcapimodule.c` entry point that makes a Py_buffer C API of the PyObject passed to it, gets the pointer and turns that pointer into a `PyObject *` (https://docs.python.org/3/c-api/long.html#c.PyLong_FromVoidPtr) which it returns\r\n2. one alignment test across the range of types and constructions care about.\r\n\r\nI like how your existing test iterates through / tests all the different array typecodes.\r\n\r\nI think it would be good to extend the test to both test empty (the size that caused this bug) + non-empty arrays (they should also be aligned)"}], "_meta": {"repo": "python/cpython", "pr_number": 140559, "url": "https://github.com/python/cpython/pull/140559#discussion_r2479914586"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\nself.assertEqual(row['expected'], data[feed_options['format']])\n\n\nclass FeedPostProcessedExportsTest(FeedExportTestBase):\n    __test__ = True\n\n    items = [{'foo': 'bar'}]\n    expected = b'foo\\r\\nbar\\r\\n'\n\n    class MyPlugin1:\n        def __init__(self, file, feed_options):\n            self.file = file\n            self.feed_options = feed_options\n            self.char = self.feed_options.get('plugin1_char', b'')\n\n        def write(self, data):\n            return self.file.write(bytes(data) + self.char)\n```"}, {"role": "assistant", "content": "> Does it work if you use 2 separate write calls?\r\n\r\nYup it works that way. It also works like this: `self.file.write(self.char + data)` weirdly.\r\n\r\n> If we go this route, it might be good to indicate that the input data may be a memoryview, and support that officially.\r\n\r\nBy that you mean we should include in the documentation to warn the users that input could be a `memoryview` while using `PickleItemExporter`?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5190, "url": "https://github.com/scrapy/scrapy/pull/5190#discussion_r677492156"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub_kernels.py`:\n\n```python\nif hasattr(kernel, \"flash_attn_varlen_func\"):\n        if attention_wrapper is None:\n            attention_wrapper = flash_attention_forward\n        kernel_function = partial(attention_wrapper, implementation=kernel)\n```"}, {"role": "assistant", "content": "This didn't have any effect currently and we only used the forced loading to get the correct implementation"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41427, "url": "https://github.com/huggingface/transformers/pull/41427#discussion_r2411456789"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_utils.py`:\n\n```python\n# when a different component (e.g. language_model) is used.\n        self._keep_in_fp32_modules = copy.copy(self.__class__._keep_in_fp32_modules)\n        self._keep_in_fp32_modules_strict = copy.copy(self.__class__._keep_in_fp32_modules_strict)\n        self._tied_weights_keys = copy.copy(self.__class__._tied_weights_keys)\n```"}, {"role": "assistant", "content": "I think `Overwrite the class attribute to make it an instance attribute, blah blah blah` is descriptive enough as it applied to class attributes in general\r\n\r\nI added one small sentence at the end of that comment to make it explicit :)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43619, "url": "https://github.com/huggingface/transformers/pull/43619#discussion_r2746091360"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_pe_audio_video.py`:\n\n```python\nconfig: PeAudioVideoConfig\n    base_model_prefix = \"model\"\n    supports_gradient_checkpointing = True\n    _no_split_modules = [\"PeAudioVideoEncoderLayer\"]\n    _no_split_modules = [\n        \"PeAudioVideoEncoderLayer\",\n        \"TimmWrapperForImageClassification\",\n    ]\n```"}, {"role": "assistant", "content": "Looks like the parallelism test is failing because layers are too big to fit in cuda:0, so it is bulking it all in cuda:1. I'd say we can skip and add a reason in description"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42917, "url": "https://github.com/huggingface/transformers/pull/42917#discussion_r2627492088"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_validators.py`:\n\n```python\nraise TypeError(f\"Unable to apply constraint 'max_length' to supplied value {x}\")\n\n\n_CONSTRAINT_TO_VALIDATOR_LOOKUP: dict[str, Callable] = {\ndef _extract_decimal_digits_info(decimal: Decimal) -> tuple[int, int]:\n    \"\"\"Compute the total number of digits and decimal places for a given [`Decimal`][decimal.Decimal] instance.\n\n    This function handles both normalized and non-normalized Decimal instances.\n    Example: Decimal('1.230'), normalize=False -> 4 digits, 3 decimal places\n```"}, {"role": "assistant", "content": "```suggestion\r\n    Example: Decimal('1.230') -> 4 digits, 3 decimal places\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10506, "url": "https://github.com/pydantic/pydantic/pull/10506#discussion_r1778938490"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `imap.py`:\n\n```python\nimport email\nimport imaplib\nimport itertools\n```"}, {"role": "assistant", "content": "Sorry about that! I was working on another issue and accidentally included these changes. Removed now."}], "_meta": {"repo": "apache/airflow", "pr_number": 60973, "url": "https://github.com/apache/airflow/pull/60973#discussion_r2721848580"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_models.py`:\n\n```python\nmessage = message.format(self, error_type=\"Server Error\")\n            raise HTTPError(message, response=self)\n\n    def json(self, **kwargs: typing.Any) -> typing.Union[dict, list]:\n    def json(self, **kwargs: typing.Any) -> typing.Any:\n```"}, {"role": "assistant", "content": "I get a different (and even more confusing) error:\r\n\r\n```python\r\ndata: dict = httpx.get(\"http://example.com\").json()\r\n```\r\n\r\n```console\r\nerror: Incompatible types in assignment (expression has type \"Union[Dict[Any, Any], List[Any]]\", variable has type \"Dict[Any, Any]\")\r\n```\r\n\r\nI assume it's because mypy doesn't allow just down-sizing a union like that - you'd need to make a proper `assert`, or `cast()`."}], "_meta": {"repo": "encode/httpx", "pr_number": 923, "url": "https://github.com/encode/httpx/pull/923#discussion_r418951855"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scheduler_job_runner.py`:\n\n```python\n.where(~DM.is_paused)\n                .where(TI.state == TaskInstanceState.SCHEDULED)\n                .where(DM.bundle_name.is_not(None))\n                .join(\n                    dr_task_concurrency_subquery,\n                    TI.run_id == dr_task_concurrency_subquery.c.run_id,\n                    isouter=True,\n                )\n                .where(func.coalesce(dr_task_concurrency_subquery.c.dr_count, 0) < DM.max_active_tasks)\n```"}, {"role": "assistant", "content": "<img width=\"856\" height=\"528\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/80293a36-7909-40c9-95e2-21a2fb9ba81a\" />"}], "_meta": {"repo": "apache/airflow", "pr_number": 54103, "url": "https://github.com/apache/airflow/pull/54103#discussion_r2479691474"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\nreturn {field.name: getattr(self, field.name) for field in fields(self)}\n\n\n# TODO: there's a lot of repeated code in these two base classes - should we consolidate, or does that up\n# the complexity enough that it's not worth saving a few lines?\nclass _BaseUrl:\n    _constraints: ClassVar[UrlConstraints] = UrlConstraints()\n    _url: Url\n\n    def __init__(self, url: str | Url) -> None:\n        if isinstance(url, Url):\n            self._url = url\n        else:\n            # TODO: this doesn't actually enforce constraints on subclasses, we should either:\n            # Fully commit to validating on __init__ for Pydantic types\n            # imo, we should not do this, the maintenance burden is VERY high here\n            # OR, we should warn that validation does not occur on __init__ and standardize this across types\n            assert isinstance(url, str)\n```"}, {"role": "assistant", "content": "I don't think we need this, if we do it should at least have a message with it."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10766, "url": "https://github.com/pydantic/pydantic/pull/10766#discussion_r1829282871"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_modernbert.py`:\n\n```python\n# Initialize weights and apply final processing\n        self.post_init()\n\n    @can_return_tuple\n    @auto_docstring\n    def forward(\n        self,\n        input_ids: torch.LongTensor | None = None,\n        attention_mask: torch.Tensor | None = None,\n        sliding_window_mask: torch.Tensor | None = None,\n        position_ids: torch.Tensor | None = None,\n        inputs_embeds: torch.Tensor | None = None,\n        labels: torch.Tensor | None = None,\n        indices: torch.Tensor | None = None,\n        cu_seqlens: torch.Tensor | None = None,\n        max_seqlen: int | None = None,\n        batch_size: int | None = None,\n        seq_len: int | None = None,\n        output_attentions: bool | None = None,\n        output_hidden_states: bool | None = None,\n        return_dict: bool | None = None,\n        **kwargs,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> tuple[torch.Tensor] | TokenClassifierOutput:\n        r\"\"\"\n        sliding_window_mask (`torch.Tensor` of shape `(batch_size, sequence_length)`, *optional*):\n            Mask to avoid performing attention on padding or far-away tokens. In ModernBert, only every few layers\n            perform global attention, while the rest perform local attention. This mask is used to avoid attending to\n            far-away tokens in the local attention layers when not using Flash Attention.\n        labels (`torch.LongTensor` of shape `(batch_size, sequence_length)`, *optional*):\n            Labels for computing the token classification loss. Indices should be in `[0, ..., config.num_labels - 1]`.\n        indices (`torch.Tensor` of shape `(total_unpadded_tokens,)`, *optional*):\n            Indices of the non-padding tokens in the input sequence. Used for unpadding the output.\n        cu_seqlens (`torch.Tensor` of shape `(batch + 1,)`, *optional*):\n            Cumulative sequence lengths of the input sequences. Used to index the unpadded tensors.\n        max_seqlen (`int`, *optional*):\n            Maximum sequence length in the batch excluding padding tokens. Used to unpad input_ids and pad output tensors.\n        batch_size (`int`, *optional*):\n            Batch size of the input sequences. Used to pad the output tensors.\n        seq_len (`int`, *optional*):\n            Sequence length of the input sequences including padding tokens. Used to pad the output tensors.\n        \"\"\"\n        return_dict = return_dict if return_dict is not None else self.config.use_return_dict\n        self._maybe_set_compile()\n```"}, {"role": "assistant", "content": "Do we still even need this? We should support native `torch.compile` now that we do not so much custom stuff anymore"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43030, "url": "https://github.com/huggingface/transformers/pull/43030#discussion_r2699265483"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `function.py`:\n\n```python\n}\n\n\ndef f(a, **kwargs) -> A:\ndef f(a, **kwargs,) -> A:\n```"}, {"role": "assistant", "content": "I don't see it as avoidable: we're now preserving trailing commas, and it's pretty hard to remove them only in function signatures as far as I can tell. I'm very open to suggestions, but as you say I don't think human devs would write a function like this so it's moot."}], "_meta": {"repo": "psf/black", "pr_number": 826, "url": "https://github.com/psf/black/pull/826#discussion_r292959211"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_auth.py`:\n\n```python\nreturn b\"HTTP/1.1\", self.status_code, b\"\", response_headers, response_stream\n\n\nclass SyncMockTransport(httpcore.SyncHTTPTransport):\n```"}, {"role": "assistant", "content": "I would naively suggest moving the body of `request` to a separate function? Seems like it's all synchronous code, but it's not a big deal anyway."}], "_meta": {"repo": "encode/httpx", "pr_number": 1012, "url": "https://github.com/encode/httpx/pull/1012#discussion_r433100851"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_downloader_handlers.py`:\n\n```python\nhost = self.host + ':' + str(self.portno)\n\n        def _test(response):\n            self.assertEqual(response.body, bytes(host, 'utf-8'))\n            self.assertEqual(request.headers.get('Host'), bytes(host, 'utf-8'))\n            self.assertEqual(response.body, to_bytes(host))\n            self.assertEqual(request.headers.get('Host'), to_bytes(host))\n```"}, {"role": "assistant", "content": "`to_bytes` is meant for scenarios where the input may be either `bytes` or `str`.\r\n\r\nBecause here we control the input type, `str`, `host.encode()` would make more sense, being more explicit."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4610, "url": "https://github.com/scrapy/scrapy/pull/4610#discussion_r468402310"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `networks.py`:\n\n```python\nimport email_validator\n    except ImportError as e:\n        raise ImportError('email-validator is not installed, run `pip install pydantic[email]`') from e\n    if getattr(email_validator, '__version__', '').partition('.')[0] == '2':\n        return\n    else:\n        input_email = 'testaddr@example.tld'\n        valid_email = email_validator.validate_email(input_email, check_deliverability=False)\n        if not hasattr(valid_email, 'normalized'):\n            raise ImportError('email-validator version >= 2.0 required')\n```"}, {"role": "assistant", "content": ",\r\n\r\nThe check works with `2.0.0`:\r\n\r\n```py\r\nimport email_validator\r\nfrom importlib.metadata import version\r\n\r\ndef import_email_validator() -> None:\r\n    global email_validator\r\n    try:\r\n        import email_validator\r\n    except ImportError as e:\r\n        raise ImportError('email-validator is not installed, run `pip install pydantic[email]`') from e\r\n\r\n    print(version(\"email-validator\"))\r\n    #> 2.0.0\r\n    \r\n    if not version(\"email-validator\").partition('.')[0] == '2':\r\n        raise ImportError('email-validator version >= 2.0 required, run pip install -U email-validator')\r\n\r\nimport_email_validator()\r\n```\r\n\r\nThis doesn't raise an error. I don't get an error if I'm using 2.1 either. I do get an error if I'm using < v2"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 6033, "url": "https://github.com/pydantic/pydantic/pull/6033#discussion_r1406777742"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\nforce=False,\n        )\n\n    def _fetch_parent_frame(self, depth: int) -> FrameType | None:\n        frame = sys._getframe(depth)\n```"}, {"role": "assistant", "content": "Because `parent_frame_namespace` returns the locals directly, but I need the globals as well to check for the module of the frame. Previously, we did another call to `sys._getframe` to fetch the globals (resulting in the frame being fetched twice), but it ends up being cleaner fetching the relevant frame once, and pulling up `f_locals` and `f_globals` from it."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10893, "url": "https://github.com/pydantic/pydantic/pull/10893#discussion_r1851581538"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `time.py`:\n\n```python\nreturn zone\n\n    @cached_property\n    def local(self) -> LocalTimezone:\n        \"\"\"Return LocalTimezone instance for the application.\"\"\"\n        return LocalTimezone()\n    def local(self) -> tzinfo:\n        \"\"\"Return the local system timezone for the application.\"\"\"\n        try:\n            timezone = get_localzone()\n        except Exception as ex:\n            timezone = None\n            logger.warning(\"Failed to retrieve local timezone (%s): %s\", type(ex).__name__, ex)\n        if timezone is None:\n```"}, {"role": "assistant", "content": "Several possible exceptions: `ZoneInfoNotFoundError`, `LookupError`, `ValueError`. In addition it could try to access files to get the timezone, depending on the OS, so exceptions could come from that as well. We want `LocalTimezone` to always be the fallback so no value in capturing more specific exceptions."}], "_meta": {"repo": "celery/celery", "pr_number": 9862, "url": "https://github.com/celery/celery/pull/9862#discussion_r2312445286"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\nclass SSLContext(ssl.SSLContext):\n    DEFAULT_CA_BUNDLE_PATH = Path(certifi.where())\n\n    def __init__(\n        self,\n        verify: VerifyTypes = True,\n        cert: CertTypes | None = None,\n        verify: bool = True,\n    ) -> None:\n        self.verify = verify\n        set_minimum_tls_version_1_2(self)\n        self.options |= ssl.OP_NO_COMPRESSION\n        self.set_ciphers(DEFAULT_CIPHERS)\n\n        keylogfile = os.environ.get(\"SSLKEYLOGFILE\")\n        if keylogfile:\n            self.keylog_filename = keylogfile\n\n        logger.debug(\n            \"load_ssl_context verify=%r cert=%r\",\n            verify,\n            cert,\n        )\n        super().__init__()\n        self._verify = verify\n\n        # Our SSL setup here is similar to the stdlib `ssl.create_default_context()`\n        # implementation, except with `certifi` used for certificate verification.\n        if not verify:\n            self.check_hostname = False\n            self.verify_mode = ssl.CERT_NONE\n            self._load_client_certs(cert)\n            return\n\n        if isinstance(verify, bool):\n            ca_bundle_path = self.DEFAULT_CA_BUNDLE_PATH\n        elif Path(verify).exists():\n            ca_bundle_path = Path(verify)\n        else:\n            raise IOError(\n                \"Could not find a suitable TLS CA certificate bundle, \"\n                \"invalid path: {}\".format(verify)\n            )\n\n        self.verify_mode = ssl.CERT_REQUIRED\n        self.check_hostname = True\n\n        # Signal to server support for PHA in TLS 1.3. Raises an\n        # AttributeError if only read-only access is implemented.\n        try:\n            self.post_handshake_auth = True\n        except AttributeError:  # pragma: no cover\n            pass\n\n        # Disable using 'commonName' for SSLContext.check_hostname\n        # when the 'subjectAltName' extension isn't available.\n        try:\n            self.hostname_checks_common_name = False\n        except AttributeError:  # pragma: no cover\n            pass\n```"}, {"role": "assistant", "content": "Ah... there's possibly useful context to talk through for both `post_handshake_auth`, and for `hostname_checks_common_name`. I'm going to suggest that we start by matching the `stdlib` behaviour, and have a design discussion review on the SSL settings prior to 1.0.\r\n\r\nUsing commonName fallback has been deprecated for some time...\r\n\r\n* https://stackoverflow.com/questions/43665243/invalid-self-signed-ssl-cert-subject-alternative-name-missing\r\n* https://github.com/encode/httpx/discussions/2978\r\n* https://github.com/encode/httpx/discussions/3125\r\n\r\nThis is not enforced in `ssl.create_default_context()`, and perhaps we don't need to either if the user is working with self-signed certs may be their responsibility.\r\n\r\nWrt. PHA, this was introduced in `urllib3` based on this ticket...\r\n\r\nhttps://github.com/urllib3/urllib3/issues/1634\r\n\r\nIt's not obvious to me that \"client cert authentication based on HTTP request parameters like method or path\" is desirable."}], "_meta": {"repo": "encode/httpx", "pr_number": 3335, "url": "https://github.com/encode/httpx/pull/3335#discussion_r1795147435"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `stats.py`:\n\n```python\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.utils.python import global_object_name, to_bytes\nfrom scrapy.utils.request import request_httprepr\nfrom scrapy.utils.response import response_httprepr\nfrom scrapy.utils.python import global_object_name\n\nfrom twisted.web import http\n\n\ndef get_header_size(headers):\n    if headers is None:\n        return None\n    size = 0\n    for key, value in headers.items():\n        if isinstance(value, bytes):\n            size += len(b\": \") + len(key) + len(value)\n        elif isinstance(value, (list, tuple)):\n            for v in value:\n                size += len(b\": \") + len(key) + len(v)\n    return size + len(b'\\r\\n') * (len(headers.keys()) - 1)\n\n\ndef get_status_size(response_status):\n    values = [\n        9,\n        len(to_bytes(str(response_status))),\n        1,\n        len(to_bytes(http.RESPONSES.get(response_status, b''))),\n        2,\n    ]\n    return sum(values)\n```"}, {"role": "assistant", "content": "related codelines changed in https://github.com/GeorgeA92/scrapy/commit/d7b3cbfbaab7c040d306bf9be0a64c2e144accc2"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4972, "url": "https://github.com/scrapy/scrapy/pull/4972#discussion_r709583820"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `auto_docstring.py`:\n\n```python\n}\n\n\nclass ProcessorArgs:\n    # __init__ arguments\n    image_processor = {\n        \"description\": \"\"\"\n    The image processor is a required input.\n    \"\"\",\n        \"type\": \"{image_processor_class}\",\n    }\n\n    tokenizer = {\n        \"description\": \"\"\"\n    The tokenizer is a required input.\n    \"\"\",\n        \"type\": \"{tokenizer_class}\",\n    }\n\n    video_processor = {\n        \"description\": \"\"\"\n    The video processor is a required input.\n    \"\"\",\n        \"type\": \"{video_processor_class}\",\n    }\n\n    audio_processor = {\n        \"description\": \"\"\"\n    The audio processor is a required input.\n    \"\"\",\n        \"type\": \"{audio_processor_class}\",\n    }\n\n    feature_extractor = {\n        \"description\": \"\"\"\n    The feature extractor is a required input.\n    \"\"\",\n        \"type\": \"{feature_extractor_class}\",\n    }\n\n    chat_template = {\n        \"description\": \"\"\"\n    A Jinja template which will be used to convert lists of messages in a chat into a tokenizable string.\n    \"\"\",\n        \"type\": \"str\",\n    }\n\n    # __call__ arguments\n    text = {\n        \"description\": \"\"\"\n    The sequence or batch of sequences to be encoded. Each sequence can be a string or a list of strings\n    (pretokenized string). If the sequences are provided as list of strings (pretokenized), you must set\n    `is_split_into_words=True` (to lift the ambiguity with a batch of sequences).\n    \"\"\",\n    }\n\n    audio = {\n```"}, {"role": "assistant", "content": "I think audios is deprecated but still present in some places"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42101, "url": "https://github.com/huggingface/transformers/pull/42101#discussion_r2669994786"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_triggerer_job.py`:\n\n```python\n# Re-load the triggers\n        trigger_runner_supervisor.load_triggers()\n\n        # Wait for up to 3 seconds for it to vanish from the TriggerRunner's storage\n        for _ in range(30):\n        # Wait for up to 100 seconds for it to vanish from the TriggerRunner's storage\n```"}, {"role": "assistant", "content": "We all are since we stopped calculating by hand :)"}], "_meta": {"repo": "apache/airflow", "pr_number": 60754, "url": "https://github.com/apache/airflow/pull/60754#discussion_r2731618470"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `providers_manager.py`:\n\n```python\nself._plugins_set: set[PluginInfo] = set()\n        self._init_airflow_core_hooks()\n\n        self._runtime_manager = None\n\n    def __getattribute__(self, name: str):\n        # Hacky but does the trick for now\n        runtime_properties = {\n            \"hooks\",\n            \"taskflow_decorators\",\n            \"filesystem_module_names\",\n            \"asset_factories\",\n            \"asset_uri_handlers\",\n            \"asset_to_openlineage_converters\",\n        }\n```"}, {"role": "assistant", "content": "That's true, but I didn't want to change a lot on that front and would rather handle it when I am getting rid of this compat shim"}], "_meta": {"repo": "apache/airflow", "pr_number": 60218, "url": "https://github.com/apache/airflow/pull/60218#discussion_r2694065523"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test.py`:\n\n```python\nreturn runner.create_crawler(spidercls or Spider)\n\n\ndef get_pythonpath():\ndef get_pythonpath() -> str:\n    \"\"\"Return a PYTHONPATH suitable to use in processes so that they find this\n    installation of Scrapy\"\"\"\n    scrapy_path = import_module('scrapy').__path__[0]\n    return os.path.dirname(scrapy_path) + os.pathsep + os.environ.get('PYTHONPATH', '')\n    return str(Path(scrapy_path).parent) + os.pathsep + os.environ.get('PYTHONPATH', '')\n```"}, {"role": "assistant", "content": "`os.pathsep` is a separator of paths (: or ;) as opposed to `os.sep`. It's a list of paths, not a single path."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5682, "url": "https://github.com/scrapy/scrapy/pull/5682#discussion_r1032649552"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\nself.paused = False\n\n    def _next_request(self) -> None:\n        assert self.slot is not None  # typing\n        if self.slot is None:\n            return\n```"}, {"role": "assistant", "content": "This is necessary because `close_spider` uses `setattr` to set `self.slot` to `None`. However, I wonder if we can make it so that `_next_request` in not called in the first place, in those scenarios."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5440, "url": "https://github.com/scrapy/scrapy/pull/5440#discussion_r820599834"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_set.py`:\n\n```python\nfor cubevert in edge:\n                self.assertIn(cubevert, g)\n\nclass TestPySet_Add(unittest.TestCase):\n    def test_set(self):\n        # Test the PySet_Add c-api for set objects\n        s = set()\n        assert _testcapi.pyset_add(s, 1) == {1}\n```"}, {"role": "assistant", "content": "Please use assertEqual():\r\n\r\n```suggestion\r\n        self.assertEqual(_testcapi.pyset_add(s, 1), {1})\r\n```\r\n\r\nSame remark for other tests."}], "_meta": {"repo": "python/cpython", "pr_number": 140234, "url": "https://github.com/python/cpython/pull/140234#discussion_r2470311100"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_falcon_mamba.py`:\n\n```python\nsupports_gradient_checkpointing = True\n    _is_stateful = True\n\n    def to(self, *args, **kwargs):\n        # Check if dtype conversion is happening\n        dtype_present_in_args = \"dtype\" in kwargs\n        if not dtype_present_in_args:\n            for arg in args:\n                if isinstance(arg, torch.dtype):\n                    dtype_present_in_args = True\n                    break\n\n        result = super().to(*args, **kwargs)\n        # Clear cached dtype if dtype conversion occurred, so the dtype property\n        # will check actual parameters instead of returning stale cached value\n        if dtype_present_in_args and hasattr(self, \"_dtype\"):\n            self._dtype = None\n        return result\n```"}, {"role": "assistant", "content": "Some models introduced this attribute (only four models: mamba, falcon_mamba, lfm2, and lfm2_moe)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43178, "url": "https://github.com/huggingface/transformers/pull/43178#discussion_r2691197791"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nreturn max(cast(int, self.getpriority(name)) for name in self)\n        return get_settings_priority(\"default\")\n\n    def replace_in_component_list(\n        self, name: _SettingsKeyT, old_cls: type, new_cls: type, pos: int | None = None\n    ) -> None:\n        \"\"\"Replace *old_cls* with *new_cls* in the *name* component list.\n\n        If *old_cls* is missing, :exc:`KeyError` is raised.\n\n        If *old_cls* was present as an import string, even more than once,\n        those keys are dropped and replaced by *new_cls*.\n\n        If *pos* is specified, that is the value assigned to *new_cls* in the\n        component list. Otherwise, the value of *old_cls* is used. If *old_cls*\n        was present multiple times (possible with import strings) with\n        different values, the value assigned to *new_cls* is one of them, with\n        no guarantee about which one it is.\n\n        This change is applied regardless of the priority of the *name*\n        setting. The setting priority is not affected by this change either.\n        \"\"\"\n        component_list = self.getdict(name)\n        old_pos = None\n        for cls_or_path in tuple(component_list):\n            if isinstance(cls_or_path, str):\n                _cls = load_object(cls_or_path)\n            else:\n                _cls = cls_or_path\n            if _cls == old_cls:\n```"}, {"role": "assistant", "content": "> we haven't seen these cases in the wild yet, right?\r\n\r\nNot that I recall, no."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6614, "url": "https://github.com/scrapy/scrapy/pull/6614#discussion_r1940976585"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_typing_extra.py`:\n\n```python\n\"\"\"Logic for interacting with type annotations, mostly extensions, shims and hacks to wrap python's typing module.\"\"\"\n\"\"\"Logic for interacting with type annotations, mostly extensions, shims and hacks to wrap Python's typing module.\"\"\"\n\nfrom __future__ import annotations as _annotations\nfrom __future__ import annotations\n\nimport dataclasses\nimport collections.abc\nimport re\nimport sys\nimport types\nimport typing\nimport warnings\nfrom collections.abc import Callable\nfrom functools import partial\nfrom types import GetSetDescriptorType\nfrom typing import TYPE_CHECKING, Any, Final\nfrom functools import lru_cache, partial\nfrom typing import Any, Callable\n\nfrom typing_extensions import Annotated, Literal, TypeAliasType, TypeGuard, Unpack, deprecated, get_args, get_origin\nimport typing_extensions\nfrom typing_extensions import TypeIs, deprecated, get_args, get_origin\n\nfrom ._namespace_utils import GlobalsNamespace, MappingNamespace, NsResolver, get_module_ns_of\n\nif TYPE_CHECKING:\n    from ._dataclasses import StandardDataclass\nif sys.version_info < (3, 10):\n    NoneType = type(None)\n    EllipsisType = type(Ellipsis)\nelse:\n    from types import EllipsisType as EllipsisType\n    from types import NoneType as NoneType\n\ntry:\n    from typing import _TypingBase  # type: ignore[attr-defined]\nexcept ImportError:\n    from typing import _Final as _TypingBase  # type: ignore[attr-defined]\n\ntyping_base = _TypingBase\n# See https://typing-extensions.readthedocs.io/en/latest/#runtime-use-of-types:\n\n\nif sys.version_info < (3, 9):\n    # python < 3.9 does not have GenericAlias (list[int], tuple[str, ...] and so on)\n    TypingGenericAlias = ()\nelse:\n    from typing import GenericAlias as TypingGenericAlias  # type: ignore\n@lru_cache(maxsize=None)\ndef _get_typing_objects_by_name_of(name: str) -> tuple[Any, ...]:\n    result = tuple(getattr(module, name) for module in (typing, typing_extensions) if hasattr(module, name))\n    if not result:\n        raise ValueError(f'Neither typing nor typing_extensions has an object called {name!r}')\n```"}, {"role": "assistant", "content": "```suggestion\r\n        raise ValueError(f'Neither `typing` nor `typing_extensions` has an object called {name!r}')\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10725, "url": "https://github.com/pydantic/pydantic/pull/10725#discussion_r1825749665"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_rope_utils.py`:\n\n```python\nmost scaling types, a `factor` of x will enable the model to handle sequences of length x *\n            original maximum pre-trained length.\n        original_max_position_embeddings (`int`, *optional*):\n            Used with 'dynamic', 'longrope' and 'llama3'. The original max position embeddings used during\n            Used with 'yarn', 'longrope' and 'llama3'. The original max position embeddings used during\n            pretraining.\n```"}, {"role": "assistant", "content": "dynamic uses `config.max_position_embedding` and doesn't require us to set explicit `original_max_position_embeddings` in rope dict"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42513, "url": "https://github.com/huggingface/transformers/pull/42513#discussion_r2581153507"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conftest.py`:\n\n```python\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\nfrom __future__ import annotations\n\nimport os\n\nos.environ[\"_AIRFLOW__AS_LIBRARY\"] = \"true\"\n```"}, {"role": "assistant", "content": "Let me just do it after this in a follow up: https://github.com/apache/airflow/issues/60253"}], "_meta": {"repo": "apache/airflow", "pr_number": 59883, "url": "https://github.com/apache/airflow/pull/59883#discussion_r2671413856"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_typing_extra.py`:\n\n```python\nvalue, globalns, localns\n            )\n    except TypeError as e:\n        if not (isinstance(value, typing.ForwardRef) and is_backport_fixable_error(e)):\n            raise\n        try:\n            from eval_type_backport import eval_type_backport\n        except ImportError:\n            raise TypeError(\n                f'You have a type annotation {value.__forward_arg__!r} '\n                f'which makes use of newer typing features than are supported in your version of Python. '\n                f'To handle this error, you should either remove the use of new syntax '\n                f'or install the `eval_type_backport` package.'\n            ) from e\n\n        return eval_type_backport(value, globalns, localns, try_default=False)\n        if isinstance(value, typing.ForwardRef):\n```"}, {"role": "assistant", "content": "I suggest keeping `is_backport_fixable_error`, and also updating `is_not_subscriptable_error` to check for Python <= 3.8 and `is_unsupported_types_for_union_error` for Python <= 3.9 (double check those Python versions). The newer `type 'CustomType' is not subscriptable` format isn't backport fixable because the backport only applies to old versions. So you can definitely make a better guess about whether it's worth suggesting installing `eval_type_backport`."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10030, "url": "https://github.com/pydantic/pydantic/pull/10030#discussion_r1701935936"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `httpcompression.py`:\n\n```python\nACCEPTED_ENCODINGS: list[bytes] = [b\"gzip\", b\"deflate\"]\n\ntry:\n    try:\n        import brotli  # noqa: F401\n    except ImportError:\n        import brotlicffi  # noqa: F401\n```"}, {"role": "assistant", "content": "I think we can restore brotlicffi compatibility after https://github.com/python-hyper/brotlicffi/pull/207 is released, but it's fine to drop it now."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 7134, "url": "https://github.com/scrapy/scrapy/pull/7134#discussion_r2522897971"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modular_glm4v.py`:\n\n```python\nThe temporal, height and width of feature shape of each image in LLM.\n        video_grid_thw (`torch.LongTensor` of shape `(num_videos, 3)`, *optional*):\n            The temporal, height and width of feature shape of each video in LLM.\n        rope_deltas (`torch.LongTensor` of shape `(batch_size, )`, *optional*):\n            The rope index difference between sequence length and multimodal rope.\n```"}, {"role": "assistant", "content": "Oh thanks, the repo check complains on the docs order. Just noticed that the arg isn't even in the signature \ud83d\ude06"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41773, "url": "https://github.com/huggingface/transformers/pull/41773#discussion_r2564460815"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_canvas.py`:\n\n```python\nbackend = fail.app.backend\n        j_key = backend.get_key_for_group(original_group_id, '.j')\n        redis_connection = get_redis_connection()\n        # The redis key is either a list or zset depending on configuration\n        # The redis key is either a list or a set depending on configuration\n```"}, {"role": "assistant", "content": "I struggled to find references to \"zset\" in the Redis documentation. Not sure if it has fallen into disuse (the term itself).\r\n\r\nIt's used extensively in this book tho > https://redis.com/ebook/part-2-core-concepts/chapter-3-commands-in-redis/3-5-sorted-sets/"}], "_meta": {"repo": "celery/celery", "pr_number": 8498, "url": "https://github.com/celery/celery/pull/8498#discussion_r1324532236"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\nTypeError: If no method has been defined for generating a JSON schema for a given pydantic core schema type.\n        \"\"\"\n        mapping: dict[CoreSchemaOrFieldType, Callable[[CoreSchemaOrField], JsonSchemaValue]] = {}\n        core_schema_types: list[CoreSchemaOrFieldType] = _typing_extra.literal_values(\n            CoreSchemaOrFieldType  # type: ignore\n        )\n        core_schema_types: list[CoreSchemaOrFieldType] = list(get_literal_values(CoreSchemaOrFieldType))\n```"}, {"role": "assistant", "content": "Doesn't strike me as necessary, but also, very low stakes, feel free to leave it as you wish"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11479, "url": "https://github.com/pydantic/pydantic/pull/11479#discussion_r1973837137"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n\"(useful when piping source on standard input).\"\n    ),\n)\n@click.option(\n    \"--python-cell-magics\",\n    multiple=True,\n```"}, {"role": "assistant", "content": "Agreed, though this is how `click` supports multiple options out of the box.  This is also how `target-version` takes multiple arguments.  I expect that we would need to introduce a custom callback to support multiple options, which might then also require custom logic when reading from the `pyproject.toml` file.\r\n\r\nMy expectation is that this will rather mostly be used in a configuration file and so perhaps the clunkiness on the command line is acceptable."}], "_meta": {"repo": "psf/black", "pr_number": 2744, "url": "https://github.com/psf/black/pull/2744#discussion_r778143187"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_detr.py`:\n\n```python\n# segmentation head\n        hidden_size, number_of_heads = config.d_model, config.encoder_attention_heads\n        intermediate_channel_sizes = self.detr.model.backbone.conv_encoder.intermediate_channel_sizes\n        intermediate_channel_sizes = self.detr.model.backbone.intermediate_channel_sizes\n```"}, {"role": "assistant", "content": "I did this to support BC, but not very happy about it, not sure if there's a cleaner way to do this:\r\nhttps://github.com/huggingface/transformers/pull/41549/changes#diff-5229d293ce9b5a88ce60b77fe0b89a5ec6240faae55381b5097424f11ac0149dR1489-R1493"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41549, "url": "https://github.com/huggingface/transformers/pull/41549#discussion_r2678216536"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `unified.py`:\n\n```python\n__slots__ = [\"response\"]\n    selectorlist_cls = SelectorList\n\n    def __init__(self, response=None, text=None, type=None, root=None, **kwargs):\n    def __init__(self, response=None, text=None, type=None, root=_NOT_SET, **kwargs):\n```"}, {"role": "assistant", "content": "On current parsel version(1.8.1) I definitely don't see option without import of `_NOT_SET` from parsel module. Any other internally created `object()` on root - will not pass checks against module's `_NOT_SET` on parsel side\r\n\r\nI tried similar approach\r\nhttps://github.com/scrapy/scrapy/compare/master...GeorgeA92:scrapy:warning_roottext_from_parser_jmespath"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5918, "url": "https://github.com/scrapy/scrapy/pull/5918#discussion_r1184599298"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conversion_mapping.py`:\n\n```python\n# Add the ones from the quantizer as well if provided\n    if hf_quantizer is not None:\n        weight_conversions.extend(hf_quantizer.get_weight_conversions())\n        # NOTE: Since get_weight_conversions() only serves to dequantize, we need to put them first in the list.\n        # However, for now it's not possible to match 1 param with 2 converters (i.e. 1 dequantization converter\n        # and 1 model-specific converter). Which means that if a model that has model-specific conversions and is being\n        # dequantized, the model-specific conversion that has patterns matching the dequantization patterns will be ignored.\n        weight_conversions = hf_quantizer.get_weight_conversions() + weight_conversions\n```"}, {"role": "assistant", "content": "cool, as we talked offline let's add more comments about how to handle the weight converter"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43227, "url": "https://github.com/huggingface/transformers/pull/43227#discussion_r2709294210"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `celery_command.py`:\n\n```python\n@_providers_configuration_loaded\ndef worker(args):\n    \"\"\"Start Airflow Celery worker.\"\"\"\n    # This needs to be imported locally to not trigger Providers Manager initialization\n    from airflow.providers.celery.executors.celery_executor import app as celery_app\n    team_config = None\n    if hasattr(args, \"team\") and args.team:\n        # Multi-team is enabled, create team-specific Celery app and use team based config\n        # This requires Airflow 3.2+, and core.multi_team config to be true to be enabled.\n        if not AIRFLOW_V_3_2_PLUS:\n            raise AirflowConfigException(\n                \"Multi-team Celery workers require Airflow version 3.2 or higher. \"\n                \"Please upgrade your Airflow installation or remove the --team argument.\"\n            )\n        if not conf.getboolean(\"core\", \"multi_team\", fallback=False):\n            raise AirflowConfigException(\n                \"Multi-team Celery workers require core.multi_team configuration to be enabled. \"\n```"}, {"role": "assistant", "content": "```suggestion\n                \"Error: Multi-team Celery workers require core.multi_team configuration to be enabled. \"\n```"}], "_meta": {"repo": "apache/airflow", "pr_number": 60675, "url": "https://github.com/apache/airflow/pull/60675#discussion_r2744598503"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_lw_detr_vit.py`:\n\n```python\nimport unittest\n\nfrom transformers import LwDetrViTConfig, is_torch_available\nfrom transformers.testing_utils import require_torch\n\nfrom ...test_backbone_common import BackboneTesterMixin\nfrom ...test_modeling_common import floats_tensor, ids_tensor\n\n\nif is_torch_available():\n    from transformers import LwDetrViTBackbone\n\n\nclass LwDetrVitModelTester:\n    def __init__(\n        self,\n        parent,\n        batch_size=3,\n        num_labels=3,\n        num_channels=3,\n        use_labels=True,\n        is_training=True,\n        image_size=256,\n        hidden_size=16,\n        num_hidden_layers=6,\n        num_attention_heads=2,\n        window_block_indices=[0, 2],\n        out_indices=[1, 3, 5],\n        num_windows=16,\n        dropout_prob=0.0,\n        attn_implementation=\"eager\",\n    ):\n        self.parent = parent\n        self.batch_size = batch_size\n        self.num_labels = num_labels\n        self.num_channels = num_channels\n        self.use_labels = use_labels\n        self.image_size = image_size\n\n        self.hidden_size = hidden_size\n        self.num_hidden_layers = num_hidden_layers\n        self.num_attention_heads = num_attention_heads\n        self.window_block_indices = window_block_indices\n        self.out_indices = out_indices\n        self.num_windows = num_windows\n        self.dropout_prob = dropout_prob\n        self.attn_implementation = attn_implementation\n\n        self.is_training = is_training\n\n    def prepare_config_and_inputs(self):\n        pixel_values = floats_tensor([self.batch_size, self.num_channels, self.image_size, self.image_size])\n\n        labels = None\n        if self.use_labels:\n            labels = ids_tensor([self.batch_size], self.num_labels)\n\n        config = self.get_config()\n\n        return config, pixel_values, labels\n\n    def get_config(self):\n        return LwDetrViTConfig(\n            hidden_size=self.hidden_size,\n            num_hidden_layers=self.num_hidden_layers,\n            num_attention_heads=self.num_attention_heads,\n            window_block_indices=self.window_block_indices,\n            out_indices=self.out_indices,\n            num_windows=self.num_windows,\n            hidden_dropout_prob=self.dropout_prob,\n            attention_probs_dropout_prob=self.dropout_prob,\n            attn_implementation=self.attn_implementation,\n        )\n\n    def prepare_config_and_inputs_for_common(self):\n        config_and_inputs = self.prepare_config_and_inputs()\n        config, pixel_values, labels = config_and_inputs\n        inputs_dict = {\"pixel_values\": pixel_values}\n        return config, inputs_dict\n\n\n@require_torch\nclass LwDetrViTBackboneTest(BackboneTesterMixin, unittest.TestCase):\n    all_model_classes = (LwDetrViTBackbone,) if is_torch_available() else ()\n    has_attentions = False\n```"}, {"role": "assistant", "content": "It does have attention though? Again you can check vitdet tests to see how to test windowed attentions"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 40991, "url": "https://github.com/huggingface/transformers/pull/40991#discussion_r2590760964"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `type_adapter.py`:\n\n```python\ncode='type-adapter-config-unused',\n            )\n\n        config_wrapper = _config.ConfigWrapper(config)\n\n        core_schema: CoreSchema\n        self._type = type\n        self._config_wrapper = _config.ConfigWrapper(config)\n        self._parent_depth = _parent_depth\n        if module is None:\n            f = sys._getframe(1)\n            self._module_name = cast(str, f.f_globals.get('__name__', ''))\n        else:\n            self._module_name = module\n\n        self._schema_initialized = False\n        if not self._defer_build(type, config):\n            # Immediately initialize the core schema, validator and serializer\n            _, _, _ = (self.core_schema, self.validator, self.serializer)\n\n    @cached_property\n    def core_schema(self) -> CoreSchema:\n        \"\"\"Core schema\"\"\"\n        try:\n            core_schema = _getattr_no_parents(type, '__pydantic_core_schema__')\n            return _getattr_no_parents(self._type, '__pydantic_core_schema__')\n        except AttributeError:\n            core_schema = _get_schema(type, config_wrapper, parent_depth=_parent_depth + 1)\n            return _get_schema(self._type, self._config_wrapper, parent_depth=self._parent_depth + 3)\n        finally:\n            self._schema_initialized = True\n\n        core_config = config_wrapper.core_config(None)\n        validator: SchemaValidator\n    @cached_property\n    def validator(self) -> SchemaValidator:\n        \"\"\"Validator\"\"\"\n        try:\n            validator = _getattr_no_parents(type, '__pydantic_validator__')\n            return _getattr_no_parents(self._type, '__pydantic_validator__')\n        except AttributeError:\n            if module is None:\n                f = sys._getframe(1)\n                module = cast(str, f.f_globals.get('__name__', ''))\n            validator = create_schema_validator(\n                core_schema, type, module, str(type), 'TypeAdapter', core_config, config_wrapper.plugin_settings\n            )  # type: ignore\n\n        serializer: SchemaSerializer\n            return create_schema_validator(\n                schema=self.core_schema,\n                schema_type=self._type,\n                schema_type_module=self._module_name,\n                schema_type_name=str(self._type),\n                schema_kind='TypeAdapter',\n                config=self._core_config,\n                plugin_settings=self._config_wrapper.plugin_settings,\n            )\n\n    @cached_property\n    def serializer(self) -> SchemaSerializer:\n        \"\"\"Serializer\"\"\"\n        try:\n            serializer = _getattr_no_parents(type, '__pydantic_serializer__')\n            return _getattr_no_parents(self._type, '__pydantic_serializer__')\n        except AttributeError:\n            serializer = SchemaSerializer(core_schema, core_config)\n            return SchemaSerializer(self.core_schema, self._core_config)\n\n    @classmethod\n    def _defer_build(cls, type_: Any, type_adapter_config: ConfigDict | None) -> bool:\n```"}, {"role": "assistant", "content": "Why not use `self._type` and self._config_wrapper`?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 8939, "url": "https://github.com/pydantic/pydantic/pull/8939#discussion_r1533146186"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_pe_audio_video.py`:\n\n```python\nconfig: PeAudioVideoConfig\n    base_model_prefix = \"model\"\n    supports_gradient_checkpointing = True\n    _no_split_modules = [\"PeAudioVideoEncoderLayer\"]\n    _no_split_modules = [\n        \"PeAudioVideoEncoderLayer\",\n        \"TimmWrapperForImageClassification\",\n    ]\n```"}, {"role": "assistant", "content": "It's failing for me even before moving `no_split_module` under a timm PreTrainedModel, so the issue is not exactly in the location of `no_split_module`"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42917, "url": "https://github.com/huggingface/transformers/pull/42917#discussion_r2627476977"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `json_schema.py`:\n\n```python\n\"\"\"\n        json_schema: JsonSchemaValue = {'type': 'object'}\n\n        keys_schema = self.generate_inner(schema['keys_schema']).copy() if 'keys_schema' in schema else {}\n        keys_core_schema = schema.get('keys_schema')\n        self.generate_inner(keys_core_schema).copy() if keys_core_schema is not None else {}\n```"}, {"role": "assistant", "content": "```suggestion\r\n        keys_schema = self.generate_inner(schema['keys_schema']).copy() if 'keys_schema' in schema else {}\r\n```\r\n\r\nWalking back my original suggestion, just because we don't need to use the `keys_core_schema` anywhere"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10478, "url": "https://github.com/pydantic/pydantic/pull/10478#discussion_r1779216591"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_fields.py`:\n\n```python\nBaseModel = import_cached_base_model()\n    FieldInfo_ = import_cached_field_info()\n\n    dataclass_fields = {\n        field.name for base in bases for field in (dataclasses.fields(base) if dataclasses.is_dataclass(base) else ())\n    }\n```"}, {"role": "assistant", "content": "Hum maybe we could be even smarter:\r\n\r\n```python\r\nfor base in bases:\r\n    if hasattr(base, ann_name):\r\n        ...\r\n        if dataclasses.is_dataclass(base):\r\n            continue"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10456, "url": "https://github.com/pydantic/pydantic/pull/10456#discussion_r1771360099"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_aria.py`:\n\n```python\ndef get_output_embeddings(self) -> nn.Module:\n        return self.lm_head\n\n    @auto_docstring\n    def get_image_features(\n        self,\n        pixel_values: torch.FloatTensor,\n        pixel_mask: torch.FloatTensor | None = None,\n        vision_feature_layer: int = -1,\n    ):\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> tuple | BaseModelOutputWithPooling:\n        return self.model.get_image_features(\n```"}, {"role": "assistant", "content": "As discussed via Slack, we'll go with the current \"manual\" implementation initially to place the breaking change pre-v5, and post-v5 we can generalize these as much as possible in a new Mixin."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42564, "url": "https://github.com/huggingface/transformers/pull/42564#discussion_r2715986235"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\ntype=click.IntRange(min=1),\n    default=None,\n    help=(\n        \"Number of parallel workers [default: BLACK_NUM_WORKERS environment variable \"\n        \"or number of CPUs in the system]\"\n        \"When Black formats multiple files, it may use a process pool to speed up\"\n        \" formatting. This option controls the number of parallel workers. This can\"\n        \" also be specified via the BLACK_NUM_WORKERS environment variable. Defaults\"\n        \" to the number of CPUs in the system.\"\n    ),\n)\n@click.option(\n    \"-q\",\n    \"--quiet\",\n    is_flag=True,\n    help=(\n        \"Don't emit non-error messages to stderr. Errors are still emitted; silence\"\n        \" those with 2>/dev/null.\"\n        \"Stop emitting all non-critical output. Error messages will still be emitted\"\n        \" (which can Error messages will still be emitted (which can silenced by\"\n        \" 2>/dev/null).\"\n    ),\n)\n@click.option(\n    \"-v\",\n    \"--verbose\",\n    is_flag=True,\n    help=(\n        \"Also emit messages to stderr about files that were not changed or were ignored\"\n        \" due to exclusion patterns.\"\n        \"Emit messages about files that were not changed or were ignored due to\"\n        \" exclusion patterns. If Black is using a configuration file, a blue message\"\n```"}, {"role": "assistant", "content": "I feel like we shouldn't specify color in our text."}], "_meta": {"repo": "psf/black", "pr_number": 4076, "url": "https://github.com/psf/black/pull/4076#discussion_r1408481162"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nreturn request.stream\n\n\n_Client = typing.TypeVar(\"_Client\", bound=\"Client\")\n```"}, {"role": "assistant", "content": "Did, and added some reasons behind the change here \ud83d\ude09"}], "_meta": {"repo": "encode/httpx", "pr_number": 1336, "url": "https://github.com/encode/httpx/pull/1336#discussion_r498316180"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `models.py`:\n\n```python\nreturn content\n\n    def json(self, **kwargs):\n        r\"\"\"Returns the json-encoded content of a response, if any.\n        r\"\"\"Returns the json-decoded dict of a response, if any.\n```"}, {"role": "assistant", "content": "```suggestion\n        r\"\"\"Decodes the JSON response body (if any) as a Python object.\n\n           This may return a dictionary, list, etc. depending on what is in the response.\n```"}], "_meta": {"repo": "psf/requests", "pr_number": 6529, "url": "https://github.com/psf/requests/pull/6529#discussion_r1950711358"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_deformable_detr.py`:\n\n```python\nconfig_and_inputs = self.model_tester.prepare_config_and_inputs()\n        self.model_tester.create_and_check_deformable_detr_object_detection_head_model(*config_and_inputs)\n\n    def test_tie_weights_is_not_modified(self):\n        config, inputs_dict = self.model_tester.prepare_config_and_inputs_for_common()\n        config.tie_word_embeddings = True\n\n        config.with_box_refine = True\n        config.two_stage = True\n\n        model = DeformableDetrForObjectDetection(config)\n        self.assertTrue(\"model.decoder.bbox_embed\" in model._tied_weights_keys)\n        self.assertTrue(\"model.decoder.class_embed\" in model._tied_weights_keys)\n\n        # if we update config attr, model's tied weights keys also change\n        config.with_box_refine = False\n        config.two_stage = False\n\n        model = DeformableDetrForObjectDetection(config)\n        self.assertFalse(\"model.decoder.bbox_embed\" in model._tied_weights_keys)\n        self.assertFalse(\"model.decoder.class_embed\" in model._tied_weights_keys)\n```"}, {"role": "assistant", "content": "My bad, I didn't see it was `assertFalse` in the second case - makes total sense, it's adding a whole new key pair"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43619, "url": "https://github.com/huggingface/transformers/pull/43619#discussion_r2745951883"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `video_processing_utils.py`:\n\n```python\nindices = torch.arange(0, total_num_frames, total_num_frames / num_frames).int()\n        else:\n            indices = torch.arange(0, total_num_frames).int()\n        return indices\n\n        video = video[indices].contiguous()\n        return video\n    def _decode_and_sample_videos(\n        self,\n        videos: VideoInput,\n        video_metadata: Union[VideoMetadata, dict],\n        do_sample_frames: Optional[bool] = None,\n        sample_indices_fn: Optional[Callable] = None,\n    ) -> list[\"torch.Tensor\"]:\n        \"\"\"\n        Decode input videos and sample frames if needed.\n        \"\"\"\n        videos = make_batched_videos(videos)\n        video_metadata = make_batched_metadata(videos, video_metadata=video_metadata)\n\n        # Only sample frames if an array video is passed, otherwise first decode -> then sample\n        if is_valid_video(videos[0]) and do_sample_frames:\n            sampled_videos = []\n            for video, metadata in zip(videos, video_metadata):\n                indices = sample_indices_fn(metadata=metadata)\n                sampled_videos.append(video[indices])\n            videos = sampled_videos\n        elif not is_valid_video(videos[0]):\n            if isinstance(videos[0], list):\n                # Videos sometimes are passed as a list of image URLs, especially through templates\n                videos = [\n                    torch.stack([F.pil_to_tensor(image) for image in images], dim=0)\n                    for images in self.fetch_images(videos)\n                ]\n```"}, {"role": "assistant", "content": "`fetch_images` can handle all image types, including decoded images, so yeah, it is delegated"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 39600, "url": "https://github.com/huggingface/transformers/pull/39600#discussion_r2259922572"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sdpa_attention.py`:\n\n```python\n#   - npu is not supported gqa currently\n    if _is_torch_xpu_available:\n        return _is_torch_greater_or_equal_than_2_8 and not isinstance(key, torch.fx.Proxy)\n    if _is_torch_npu_available:\n        return False\n```"}, {"role": "assistant", "content": "Sorry for missing updating comments, have made it correct :)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41601, "url": "https://github.com/huggingface/transformers/pull/41601#discussion_r2432206810"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `tasks.py`:\n\n```python\nw = Widget.objects.get(id=widget_id)\n    w.name = name\n    w.save()\n    \n@shared_task(\n    bind=True,\n    autoretry_for=(Exception,),\n    retry_kwargs={\"max_retries\": 2, \"countdown\": 10 * 60},  # retry 2 times in 10 minutes\n)\ndef error_task():\n```"}, {"role": "assistant", "content": "yes, it's correct, need \"self\" for it. I forgot when I typed it again."}], "_meta": {"repo": "celery/celery", "pr_number": 10081, "url": "https://github.com/celery/celery/pull/10081#discussion_r2754012301"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `sessions.py`:\n\n```python\nnew_proxies = proxies.copy()\n        no_proxy = proxies.get('no_proxy')\n\n        bypass_proxy = should_bypass_proxies(url, no_proxy=no_proxy)\n        bypass_proxy = False\n        if self.trust_env:\n            bypass_proxy = should_bypass_proxies(url, no_proxy=no_proxy)\n        if self.trust_env and not bypass_proxy:\n```"}, {"role": "assistant", "content": "Looking at the new change, I don't have an issue with the general idea. This seems like a performance improvement for rebuild_proxies, regardless of the outcome for #5888. Stylistically, I'd like to simplify the logic here a bit more though. Something along the lines of this would be preferred:\r\n\r\n```suggestion\r\n        if self.trust_env and not should_bypass_proxies(url, no_proxy=no_proxy):\r\n```\r\n\r\n I don't want to volunteer you but if you have a moment, would you mind confirming this PR resolves your issue in #5891?"}], "_meta": {"repo": "psf/requests", "pr_number": 5894, "url": "https://github.com/psf/requests/pull/5894#discussion_r687377459"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\n) -> Set[Path]:\n    \"\"\"Compute the set of files to be formatted.\"\"\"\n    sources: Set[Path] = set()\n    path_empty(src, \"No Path provided. Nothing to do \ud83d\ude34\", quiet, verbose, ctx)\n```"}, {"role": "assistant", "content": "Shouldn't happen anymore because the check is done above."}], "_meta": {"repo": "psf/black", "pr_number": 2804, "url": "https://github.com/psf/black/pull/2804#discussion_r790599096"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `linegen.py`:\n\n```python\n)\n                    for leaf in leaves\n                )\n                # In particular, don't add one within a parenthesized return annotation.\n                # Unfortunately the indicator we're in a return annotation (RARROW) may\n                # be defined directly in the parent node, the parent of the parent ...\n                # and so on depending on how complex the return annotation is.\n                # This isn't perfect and there's some false negatives but they are in\n                # contexts were a comma is actually fine.\n                and not any(\n                    node.prev_sibling.type == RARROW\n                    for node in (\n                        leaves[0].parent,\n                        getattr(leaves[0].parent, \"parent\", None),\n                    )\n                    if isinstance(node, Node) and isinstance(node.prev_sibling, Leaf)\n                )\n                # Except the false negatives above for PEP 604 unions where we\n                # can't add the comma.\n                # Don't add one inside parenthesized return annotations\n                and not get_annotation_type(leaves[0]) == \"return\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n                and get_annotation_type(leaves[0]) != \"return\"\r\n```"}], "_meta": {"repo": "psf/black", "pr_number": 4202, "url": "https://github.com/psf/black/pull/4202#discussion_r1475576405"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `encoders.py`:\n\n```python\ncustom_encoder=encoders,\n            sqlalchemy_safe=sqlalchemy_safe,\n        )\n    if dataclasses.is_dataclass(obj):\n    if dataclasses.is_dataclass(type(obj)):\n```"}, {"role": "assistant", "content": "I have separated this change into a second commit so that you can see the failure in CI. Please have a look."}], "_meta": {"repo": "fastapi/fastapi", "pr_number": 12970, "url": "https://github.com/fastapi/fastapi/pull/12970#discussion_r1864265876"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `log.py`:\n\n```python\nif TYPE_CHECKING:\n    from structlog.typing import EventDict, FilteringBoundLogger, Processor\n\n    from airflow.logging_config import RemoteLogIO\n    from airflow.sdk._shared.logging.remote import RemoteLogIO\n    from airflow.sdk.types import Logger, RuntimeTaskInstanceProtocol as RuntimeTI\n\n\nfrom airflow.sdk._shared.secrets_masker import redact\n\n\nclass _ActiveLoggingConfig:\n    \"\"\"Internal class to track active logging configuration.\"\"\"\n\n    logging_config_loaded = False\n    remote_task_log: RemoteLogIO | None = None\n    default_remote_conn_id: str | None = None\n```"}, {"role": "assistant", "content": "setter seems to be a good idea, let me take a stab at it"}], "_meta": {"repo": "apache/airflow", "pr_number": 60826, "url": "https://github.com/apache/airflow/pull/60826#discussion_r2711155329"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `report.py`:\n\n```python\nfrom black.output import out, err\n\n\ndef root_relative(path: Path, root: Optional[Path]) -> Path:\n    if not root:\n        return path\n    return Path(os.path.relpath(path, start=Path(f\"{root}/../\")))\n```"}, {"role": "assistant", "content": "`pathlib.Path` does have `p.relative_to`. But this works fine too \ud83d\udc4d"}], "_meta": {"repo": "psf/black", "pr_number": 2526, "url": "https://github.com/psf/black/pull/2526#discussion_r766382961"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_modeling_mm_grounding_dino.py`:\n\n```python\ndef test_load_save_without_tied_weights(self):\n        pass\n\n    # Ignore copy\n    def test_tie_weights_is_not_modified(self):\n        # this model doesn't need a test\n        pass\n```"}, {"role": "assistant", "content": "Just passing through, why doesn't this need a test? (wrt comment)"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43619, "url": "https://github.com/huggingface/transformers/pull/43619#discussion_r2746389469"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asyncio_enabled_reactor_different_loop.py`:\n\n```python\n\"ASYNCIO_EVENT_LOOP\": \"uvloop.Loop\",\n    }\n)\nprocess.crawl(NoRequestsSpider)\nd = process.crawl(NoRequestsSpider)\nd.addErrback(lambda failure: failure.printTraceback())\n```"}, {"role": "assistant", "content": "The issue here is that we're not following https://docs.scrapy.org/en/latest/topics/practices.html#run-scrapy-from-a-script in the tests because it's problematic. So, it may be problematic for our users as well."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6038, "url": "https://github.com/scrapy/scrapy/pull/6038#discussion_r1324530155"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `text_to_audio.py`:\n\n```python\nelse:\n            waveform_key = \"waveform\"\n\n        # We directly get the waveform\n        if self.no_processor:\n            if isinstance(audio, dict):\n                waveform = audio[waveform_key]\n            elif isinstance(audio, tuple):\n                waveform = audio[0]\n            else:\n                waveform = audio\n        # Or we need to postprocess to get the waveform\n        if isinstance(audio, dict):\n            waveform = audio[waveform_key]\n        elif isinstance(audio, tuple):\n            waveform = audio[0]\n        else:\n            waveform = self.processor.decode(audio)\n```"}, {"role": "assistant", "content": "Example usage:\r\n```python\r\nfrom transformers import pipeline\r\nimport soundfile as sf\r\n\r\n\r\ndia_pipeline = pipeline(\r\n    \"text-to-audio\", model=model_checkpoint,\r\n)\r\noutputs = dia_pipeline(\r\n    \"[S1] Dia is an open weights text to dialogue model.\",\r\n    generate_kwargs={\"max_new_tokens\": 512},\r\n)\r\nassert outputs[\"sampling_rate\"] == 44100\r\n\r\naudio = outputs[\"audio\"].squeeze()\r\nfn = \"dia_pipeline_output.wav\"\r\nsf.write(fn, audio, outputs[\"sampling_rate\"])\r\nprint(f\"Audio saved to {fn}\")\r\n```\r\n\r\nI'm reluctant to allow voice cloning through pipeline, as this would require passing an `audios` input to pipeline (since Dia doesn't support chat templates).\r\n\r\nMoreover, allowing inputs like `audios` is exactly what they are trying to phase out with `image-text-to-text` in https://github.com/huggingface/transformers/pull/42359 (to only support chat template usage)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42326, "url": "https://github.com/huggingface/transformers/pull/42326#discussion_r2559082189"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_async_client.py`:\n\n```python\nassert response.status_code == 200\n    assert response.content == data\n\n\n@pytest.mark.usefixtures(\"async_environment\")\nasync def test_context_managed_transport():\n    class Transport(httpcore.AsyncHTTPTransport):\n        def __init__(self):\n            self.events = []\n\n        async def aclose(self):\n            self.events.append(\"transport.aclose\")\n\n        async def __aenter__(self):\n            await super().__aenter__()\n            self.events.append(\"transport.__aenter__\")\n\n        async def __aexit__(self):\n            await super().__aexit__()\n            self.events.append(\"transport.__aexit__\")\n\n    # Note that we're including 'proxies' here to *also* run through the\n    # proxy context management, although we can't easily test that at the\n    # moment, since we can't add proxies as transport instances.\n    #\n    # Once we have a more generalised Mount API we'll be able to remove this\n    # in favour of ensuring all mounts are context managed, which will\n    # also neccessarily include proxies.\n    transport = Transport()\n    async with httpx.AsyncClient(transport=transport, proxies=\"http://www.example.com\"):\n        pass\n\n    assert transport.events == [\n        \"transport.__aenter__\",\n        \"transport.aclose\",\n        \"transport.__aexit__\",\n    ]\n```"}, {"role": "assistant", "content": "Yes.\r\n\r\nThe base implementation is \"Just call `.close()`/`.aclose()`\".\r\n\r\nOne of the allowable things for a concrete transport to do is \"Just implement `close`/`aclose`\", which is in fact what our existing implementations do.\r\n\r\nThat gives us both the simple case, while still allowing *some* implementations to do more complex stuff with `__aenter__`, `__aexit__`."}], "_meta": {"repo": "encode/httpx", "pr_number": 1218, "url": "https://github.com/encode/httpx/pull/1218#discussion_r477213626"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `peft.py`:\n\n```python\n)\n            peft_config.inference_mode = not is_trainable\n\n        if peft_config.peft_type != PeftType.LORA:\n        if hotswap and (peft_config.peft_type != PeftType.LORA):\n```"}, {"role": "assistant", "content": "Actually, we can fully remove this check no? It's already checked above L206"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42663, "url": "https://github.com/huggingface/transformers/pull/42663#discussion_r2598400175"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `crawl.py`:\n\n```python\ndef __init__(self, *a: Any, **kw: Any):\n        super().__init__(*a, **kw)\n        self._compile_rules()\n        if method_is_overridden(self.__class__, CrawlSpider, \"_parse_response\"):\n            warnings.warn(\n                \"CrawlSpider._parse_response method is deprecated: \"\n                \"it will be removed in future Scrapy releases. \"\n                \"Please override CrawlSpider.parse_with_rules method instead.\"\n```"}, {"role": "assistant", "content": "```suggestion\r\n                f\"The CrawlSpider._parse_response method, which the \"\r\n                f\"{global_object_name(self.__class__)} class overrides, is \"\r\n                f\"deprecated: it will be removed in future Scrapy releases. \"\r\n                f\"Please override the CrawlSpider.parse_with_rules method \"\r\n                f\"instead.\"\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6804, "url": "https://github.com/scrapy/scrapy/pull/6804#discussion_r2108542324"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `base.py`:\n\n```python\ndef __init__(self, *args, **kwargs):\n        if hasattr(self.key_t, '__func__'):  # pragma: no cover\n            self.key_t = self.key_t.__func__  # remove binding\n        self._encode_prefixes()\n        super().__init__(*args, **kwargs)\n        self._add_global_keyprefix()\n        self._encode_prefixes()\n        if self.implements_incr:\n            self.apply_chord = self._apply_chord_incr\n\n    def _add_global_keyprefix(self):\n```"}, {"role": "assistant", "content": "from my understanding, this feature needs to be documented properly"}], "_meta": {"repo": "celery/celery", "pr_number": 7620, "url": "https://github.com/celery/celery/pull/7620#discussion_r1012654253"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `retry.py`:\n\n```python\n)\nfrom twisted.web.client import ResponseFailed\n\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.utils.response import response_status_message\nfrom scrapy.core.downloader.handlers.http11 import TunnelError\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.http.request import Request\nfrom scrapy.spiders import Spider\nfrom scrapy.utils.python import global_object_name\nfrom scrapy.utils.response import response_status_message\n\n\nlogger = logging.getLogger(__name__)\nretry_logger = getLogger(__name__)\n\n\ndef get_retry_request(\n    request: Request,\n    *,\n    spider: Spider,\n    reason: Union[str, Exception] = 'unspecified',\n    max_retry_times: Optional[int] = None,\n    priority_adjust: Union[int, float, None] = None,\n    logger: Logger = retry_logger,\n    stats_base_key: str = 'retry',\n):\n    \"\"\"\n    Returns a new :class:`~scrapy.Request` object to retry the specified\n    request, or ``None`` if retries of the specified request have been\n    exhausted.\n\n    For example, in a :class:`~scrapy.Spider` callback, you could use it as\n    follows::\n\n        def parse(self, response):\n            if not response.text:\n                new_request = get_retry_request(\n                    response.request,\n                    spider=self,\n                    reason='empty',\n                )\n                if new_request:\n```"}, {"role": "assistant", "content": "You definitely could write it without the `if`. My main concern here is readability. What about doing what you suggest and renaming the variable as `new_request_or_none`?"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4902, "url": "https://github.com/scrapy/scrapy/pull/4902#discussion_r595841532"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `trace.py`:\n\n```python\ndef traceback_clear(exc=None):\n    \"\"\"Clear traceback frames to prevent memory leaks.\n```"}, {"role": "assistant", "content": "After clearing frame objects, explicitly set `exc.__traceback__ = None` to fully break references and avoid retaining the traceback on the exception itself."}], "_meta": {"repo": "celery/celery", "pr_number": 9799, "url": "https://github.com/celery/celery/pull/9799#discussion_r2187385518"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nself.cookies.extract_cookies(response)\n        response.default_encoding = self._default_encoding\n\n        status = f\"{response.status_code} {response.reason_phrase}\"\n        response_line = f\"{response.http_version} {status}\"\n        logger.debug(\n            'HTTP Request: %s %s \"%s\"', request.method, request.url, response_line\n        logger.info(\n```"}, {"role": "assistant", "content": "Based on the other python packages, I don't recall any other python client having an INFO log message level. :thinking:"}], "_meta": {"repo": "encode/httpx", "pr_number": 2547, "url": "https://github.com/encode/httpx/pull/2547#discussion_r1141706645"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `images.py`:\n\n```python\nf\"{self.min_width}x{self.min_height})\"\n            )\n\n        if self._deprecated_convert_image is None:\n            self._deprecated_convert_image = \"response_body\" not in get_func_args(\n                self.convert_image\n            )\n            if self._deprecated_convert_image:\n                warnings.warn(\n                    f\"{self.__class__.__name__}.convert_image() method overridden in a deprecated way, \"\n                    \"overridden method does not accept response_body argument.\",\n                    category=ScrapyDeprecationWarning,\n                )\n\n        if self._deprecated_convert_image:\n            image, buf = self.convert_image(orig_image)\n        else:\n            image, buf = self.convert_image(\n                orig_image, response_body=BytesIO(response.body)\n            )\n        image, buf = self.convert_image(\n            orig_image, response_body=BytesIO(response.body)\n        )\n        yield path, image, buf\n\n        for thumb_id, size in self.thumbs.items():\n            thumb_path = self.thumb_path(\n                request, thumb_id, response=response, info=info, item=item\n            )\n            if self._deprecated_convert_image:\n                thumb_image, thumb_buf = self.convert_image(image, size)\n            else:\n                thumb_image, thumb_buf = self.convert_image(image, size, buf)\n            thumb_image, thumb_buf = self.convert_image(image, size, response_body=buf)\n            yield thumb_path, thumb_image, thumb_buf\n\n    def convert_image(\n        self,\n        image: Image.Image,\n        size: tuple[int, int] | None = None,\n        response_body: BytesIO | None = None,\n        *,\n        response_body: BytesIO,\n```"}, {"role": "assistant", "content": "I get that the goal is to make the parameter required, without a default value, but we deprecated it having `None` as value, not it being used as a positional argument, so this change is backward-incompatible.\r\n\r\nI\u2019m thinking we should raise `ValueError` if the value is `None` now, and log a new warning if the parameter is used positionally, so that we can eventually make this change. And maybe we should take the chance to do the same with  `size`, deprecate it being positional.\r\n\r\nI was unsure how to handle such a deprecation without removing the typing hints. Gemini suggested using `inspect`:\r\n\r\n```python\r\nimport inspect\r\n\r\ndef my_function(param1: int, param2: str = \"default_value\"):\r\n    frame_record = inspect.stack()[1]\r\n    args, _, _, values = inspect.getargvalues(frame_record[0])\r\n    if param2 in args:\r\n        print(\"param2 was passed positionally\")\r\n    else:\r\n        print(\"param2 was passed as a keyword argument\")\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6500, "url": "https://github.com/scrapy/scrapy/pull/6500#discussion_r1822158615"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nfrom ..functional_validators import AfterValidator, BeforeValidator, FieldValidatorModes, PlainValidator, WrapValidator\nfrom ..json_schema import JsonSchemaValue\nfrom ..version import version_short\nfrom ..warnings import PydanticDeprecatedSince20\nfrom ..warnings import PydanticDeprecatedSince20, PydanticSkipValidationWarning\n```"}, {"role": "assistant", "content": "```suggestion\r\nfrom ..warnings import PydanticArbitraryTypeWarning, PydanticDeprecatedSince20\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12002, "url": "https://github.com/pydantic/pydantic/pull/12002#discussion_r2161114862"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `scraper.py`:\n\n```python\nimport logging\nfrom collections import deque\nfrom collections.abc import Iterable\nfrom typing import Union\nfrom typing import Union, Optional, Tuple, Set, Deque, Any, Iterable\n```"}, {"role": "assistant", "content": "```suggestion\r\nfrom typing import Any, Deque, Iterable, Optional, Set, Tuple, Union\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5100, "url": "https://github.com/scrapy/scrapy/pull/5100#discussion_r613335926"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `modeling_dinov3_vit.py`:\n\n```python\nsequence_output = self.norm(hidden_states)\n        pooled_output = sequence_output[:, 0, :]\n\n        return BaseModelOutputWithPooling(\n            last_hidden_state=sequence_output,\n            pooler_output=pooled_output,\n        )\n        return BaseModelOutputWithPooling(last_hidden_state=sequence_output, pooler_output=pooled_output)\n\n\n@auto_docstring\nclass DINOv3ViTBackbone(DINOv3ViTPreTrainedModel, BackboneMixin):\n    def __init__(self, config):\n        super().__init__(config)\n        super()._init_backbone(config)\n\n        self.embeddings = DINOv3ViTEmbeddings(config)\n        self.rope_embeddings = DINOv3ViTRopePositionEmbedding(config)\n        self.layer = nn.ModuleList([DINOv3ViTLayer(config) for _ in range(config.num_hidden_layers)])\n        self.norm = nn.LayerNorm(config.hidden_size, eps=config.layer_norm_eps)\n        self.gradient_checkpointing = False\n\n        self.num_features = [config.hidden_size for _ in range(config.num_hidden_layers + 1)]\n        self.layernorm = nn.LayerNorm(config.hidden_size, eps=config.layer_norm_eps)\n        self.post_init()\n\n    def get_input_embeddings(self):\n        return self.embeddings.patch_embeddings\n\n    @check_model_inputs()\n    @can_return_tuple\n    def forward(\n        self,\n        pixel_values: torch.Tensor,\n        output_hidden_states: Optional[bool] = None,\n        **kwargs: Unpack[TransformersKwargs],\n    ) -> BackboneOutput:\n        pixel_values = pixel_values.to(self.embeddings.patch_embeddings.weight.dtype)\n        hidden_states = self.embeddings(pixel_values)\n        position_embeddings = self.rope_embeddings(pixel_values)\n\n        stage_hidden_states: list[torch.Tensor] = [hidden_states]\n\n        for layer_module in self.layer:\n            hidden_states = layer_module(hidden_states, position_embeddings=position_embeddings)\n            stage_hidden_states.append(hidden_states)\n\n        sequence_output = self.norm(hidden_states)\n```"}, {"role": "assistant", "content": "this should go in the loop below, amd use self.norm instead of self.layernorm"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 41276, "url": "https://github.com/huggingface/transformers/pull/41276#discussion_r2487296709"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `asgi.py`:\n\n```python\nstatus_code = None\n        response_headers = None\n        body_parts = []\n        request_complete = False\n        response_started = False\n        response_complete = False\n        response_complete = create_event()\n\n        headers = [] if headers is None else headers\n        stream = ByteStream(b\"\") if stream is None else stream\n\n        request_body_chunks = stream.__aiter__()\n\n        async def receive() -> dict:\n            nonlocal response_complete\n            nonlocal request_complete, response_complete\n\n            if response_complete:\n            if request_complete:\n                # Simulate blocking until the response is complete and then disconnect\n```"}, {"role": "assistant", "content": "I'd tweak this comment. We're not \"simulating\" blocking until the response is complete, we *are* blocking until the response is complete. :)"}], "_meta": {"repo": "encode/httpx", "pr_number": 919, "url": "https://github.com/encode/httpx/pull/919#discussion_r420820086"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nif proxy is not None:\n                await proxy.aclose()\n\n        self._is_closed = True\n```"}, {"role": "assistant", "content": "It a bit confuses me, since there should be another ways to avoid race conditions, e.g. locks."}], "_meta": {"repo": "encode/httpx", "pr_number": 1197, "url": "https://github.com/encode/httpx/pull/1197#discussion_r472964894"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_config.py`:\n\n```python\n# whether to validate default values during validation, default False\n    validate_default: bool\n    validate_return: bool\n    protected_namespaces: tuple[str, ...]\n    protected_namespaces: tuple[str | Pattern[str], ...]\n```"}, {"role": "assistant", "content": "As we use future annotations, we can import `Pattern` from `re` instead"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10522, "url": "https://github.com/pydantic/pydantic/pull/10522#discussion_r1783315229"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_model_construction.py`:\n\n```python\nand `raise_errors=True`.\n    \"\"\"\n    typevars_map = get_model_typevars_map(cls)\n\n    if not cls.__pydantic_fields_complete__:\n        # Rebuild the model fields so we can get the NameError for the specific undefined annotation\n```"}, {"role": "assistant", "content": "```suggestion\r\n        # Note: when coming from `ModelMetaclass.__new__()`, this results in fields being built twice.\r\n        # We do so a second time here so that we can get the `NameError` for the specific undefined annotation.\r\n        # Alternatively, we could let `GenerateSchema()` raise the error, but there are cases where incomplete\r\n        # fields are inherited in `collect_model_fields()` and can actually have their annotation resolved in the\r\n        # generate schema process. As we want to avoid having `__pydantic_fields_complete__` set to `False`\r\n        # when `__pydantic_complete__` is `True`, we rebuild here:\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 11759, "url": "https://github.com/pydantic/pydantic/pull/11759#discussion_r2048511273"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nif maybe_schema is not None:\n                return maybe_schema\n\n            schema = dataclass.__dict__.get('__pydantic_core_schema__')\n            if schema is not None and not isinstance(schema, MockCoreSchema):\n                schema = self._unpack_refs_defs(schema)\n                ref = get_ref(schema)\n                if ref:\n                    self.defs.definitions[ref] = schema\n                    return core_schema.definition_reference_schema(ref)\n                else:\n                    return schema\n```"}, {"role": "assistant", "content": "This certainly should be in a shared pattern, but seems like https://github.com/pydantic/pydantic/pull/10655 does something similar already. Maybe it's best to have it implemented there when rebasing?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10863, "url": "https://github.com/pydantic/pydantic/pull/10863#discussion_r1848525378"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `hub.py`:\n\n```python\ncommit_hash: str | None\n\n\ndef is_offline_mode():\n    # Import inside the function so test patches on `huggingface_hub.constants` are picked up.\n    from huggingface_hub import constants as hf_hub_constants\n\n    return hf_hub_constants.HF_HUB_OFFLINE\n```"}, {"role": "assistant", "content": "This will be live in transformers v5 which is not out yet. I do think it's the best timing to bump `huggingface_hub` minimal version without damage (in practice v5 will bump huggingface_hub from 0.x to 1.x, so it doesn't matter much if it's 1.0 or 1.2)."}], "_meta": {"repo": "huggingface/transformers", "pr_number": 42657, "url": "https://github.com/huggingface/transformers/pull/42657#discussion_r2593172977"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `logstats_extended.py`:\n\n```python\nimport logging\nfrom datetime import datetime\n\nfrom twisted.internet import task\n\nfrom scrapy import signals\nfrom scrapy.exceptions import NotConfigured\nfrom scrapy.utils.serialize import ScrapyJSONEncoder\n\nlogger = logging.getLogger(__name__)\n\n\nclass LogStatsExtended:\n    \"\"\"Log basic scraping stats periodically\"\"\"\n\n    def __init__(\n            self, stats, interval=60.0,\n            ext_stats_enabled=False,\n            ext_stats_include=None,\n            ext_stats_exclude=None,\n            ext_delta_enabled=False,\n            ext_delta_include=None,\n            ext_delta_exclude=None,\n            ext_timing_enabled=False,\n            ext_timing_include=None,\n            ext_timing_exclude=None,\n    ):\n        self.stats = stats\n        self.interval = interval\n        self.multiplier = 60.0 / self.interval\n        self.task = None\n        self.encoder = ScrapyJSONEncoder(sort_keys=True, indent=4)\n        self.ext_stats_enabled = ext_stats_enabled\n        self.ext_stats_include = ext_stats_include\n        self.ext_stats_exclude = ext_stats_exclude\n        self.ext_delta_enabled = ext_delta_enabled\n        self.ext_delta_include = ext_delta_include\n        self.ext_delta_exclude = ext_delta_exclude\n        self.ext_timing_enabled = ext_timing_enabled\n        self.ext_timing_include = ext_timing_include\n        self.ext_timing_exclude = ext_timing_exclude\n\n\n    @classmethod\n    def from_crawler(cls, crawler):\n        interval = crawler.settings.getfloat(\"LOGSTATS_INTERVAL\")\n```"}, {"role": "assistant", "content": "Instead of having 3 new `_ENABLED` settings, we could have a single one called `LOGSTATS_FOO`, where `FOO` would be whatever the prefix/suffix of the new class is, e.g. `LOGSTATS_EXTENDED` if we keep the current name.\r\n\r\n```suggestion\r\n        settings = crawler.settings\r\n        interval = settings.getfloat(\"LOGSTATS_INTERVAL\")\r\n        if not interval or not settings.getfloat(\"LOGSTATS_EXTENDED\"):\r\n            raise NotConfigured\r\n```\r\n\r\nThen, to get those `_enabled` booleans, you could do:\r\n\r\n```suggestion\r\n        ext_stats_include = crawler.settings.getlist(\"LOGSTATS_STATS_INCLUDE\", [])\r\n        ext_stats_exclude = crawler.settings.getlist(\"LOGSTATS_STATS_EXCLUDE\", [])\r\n        ext_stats_enabled = bool(ext_stats_include) or bool(ext_stats_exclude)\r\n```\r\n\r\nIt probably makes sense to move the `_enabled` definition later on, to `__init__`, when following this approach."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5926, "url": "https://github.com/scrapy/scrapy/pull/5926#discussion_r1200160763"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_generate_schema.py`:\n\n```python\nif origin is not None:\n                namedtuple_cls = origin\n\n            with self._types_namespace_stack.push(namedtuple_cls):\n                annotations: dict[str, Any] = get_cls_type_hints_lenient(namedtuple_cls, self._types_namespace)\n            with self._ns_resolver.push(namedtuple_cls):\n                annotations: dict[str, Any] = get_cls_type_hints_lenient(namedtuple_cls)\n```"}, {"role": "assistant", "content": "Why no more args here from `self._types_namespace` (and same for above)?"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10530, "url": "https://github.com/pydantic/pydantic/pull/10530#discussion_r1786450889"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `engine.py`:\n\n```python\nfinally:\n            self._slot.nextcall.schedule()\n\n    @deferred_f_from_coro_f\n    async def open_spider(\n    def open_spider(self, spider: Spider, close_if_idle: bool = True) -> Deferred[None]:\n        return deferred_from_coro(self.open_spider_async(spider, close_if_idle))\n\n    async def open_spider_async(\n        self,\n        spider: Spider,\n        close_if_idle: bool = True,\n```"}, {"role": "assistant", "content": "Maybe this would be a good chance to apply position-only (*spider*) and keyword-only (*close_if_idle*) logic to the new async method, to make things easier for us in case we ever decide to deprecate some part of the signature."}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 6817, "url": "https://github.com/scrapy/scrapy/pull/6817#discussion_r2108382699"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `dag_run.py`:\n\n```python\ndag_run_router = AirflowRouter(tags=[\"DagRun\"], prefix=\"/dags/{dag_id}/dagRuns\")\n\n\n@dag_run_router.get(\n    \"/recent-configurations\",\n    responses=create_openapi_http_exception_doc([status.HTTP_404_NOT_FOUND]),\n    dependencies=[Depends(requires_access_dag(method=\"GET\", access_entity=DagAccessEntity.RUN))],\n)\n```"}, {"role": "assistant", "content": "`airflow-core/src/airflow/api_fastapi/core_api/routes/ui/dag_run.py` might be a better place for this route."}], "_meta": {"repo": "apache/airflow", "pr_number": 56406, "url": "https://github.com/apache/airflow/pull/56406#discussion_r2572701616"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\nvalid by calling :func:`assert_equivalent` and :func:`assert_stable` on it.\n    `mode` is passed to :func:`format_str`.\n    \"\"\"\n    if mode.is_ipynb:\n        return format_ipynb_string(src_contents, mode=mode)\n```"}, {"role": "assistant", "content": "This means we're skipping the equivalent and stable checks below for notebooks."}], "_meta": {"repo": "psf/black", "pr_number": 2357, "url": "https://github.com/psf/black/pull/2357#discussion_r667261407"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `display.py`:\n\n```python\n\"\"\"\n\nimport sys\nfrom distutils.version import LooseVersion as check\n```"}, {"role": "assistant", "content": "\ud83d\ude04You re' right.\r\nbut to use `parse_version`, I have to use two `if` statements(like below) as single `if` statement is failing one flake test of crossing 79 characters limit in a single line.\r\n```\r\n    if sys.platform == \"win32\":\r\n        if parse_version(version()) >= parse_version(\"10.0.14393\"):\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 4403, "url": "https://github.com/scrapy/scrapy/pull/4403#discussion_r416903778"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_fields.py`:\n\n```python\ngeneric_origin = getattr(cls, '__pydantic_generic_metadata__', {}).get('origin')\n        for base in bases:\n            dataclass_fields = {\n                field.name for field in (dataclasses.fields(base) if dataclasses.is_dataclass(base) else ())\n                field.name\n                for base in bases\n```"}, {"role": "assistant", "content": "Not quite reverted here - probably want to remove the nested comprehension"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10456, "url": "https://github.com/pydantic/pydantic/pull/10456#discussion_r1771559049"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_canvas.py`:\n\n```python\nredis_connection = get_redis_connection()\n        redis_connection.delete(redis_key)\n\n    def test_chaining_upgraded_chords_pure_groups(self, manager, subtests):\n        \"\"\" This test is built to reproduce the github issue https://github.com/celery/celery/issues/5958\n```"}, {"role": "assistant", "content": "Thanks!\r\nThese tests cover:\r\n1. Fix in chord.__or__.\r\n2. Fix in chain.__or__.\r\n3. Make sure the workaround from the last 2 years is not broken from this change."}], "_meta": {"repo": "celery/celery", "pr_number": 7919, "url": "https://github.com/celery/celery/pull/7919#discussion_r1032913525"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_std_types_schema.py`:\n\n```python\nimport pathlib\n\n    if source_type not in {\n        os.PathLike[bytes],\n        os.PathLike[str],\n        os.PathLike[Any],\n```"}, {"role": "assistant", "content": "I'd rather us use `get_origin` on `source_type`, and if that's `os.PathLike`, then we can move forward with building a validator that takes into account how `os.PathLike` is parametrized"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 9764, "url": "https://github.com/pydantic/pydantic/pull/9764#discussion_r1654758273"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_client.py`:\n\n```python\nproxy = Proxy(url=proxies) if isinstance(proxies, (str, URL)) else proxies\n            return {\"all\": proxy}\n\n    @property\n    def base_url(self) -> URL:\n        \"\"\"\n        Base URL to use when sending requests with relative URLs.\n        \"\"\"\n        return self._base_url\n```"}, {"role": "assistant", "content": "Thanks yup. Should have been `self._base_url` in `__init__`.\r\nIt was still working (because there's a property setter) but it's neater now."}], "_meta": {"repo": "encode/httpx", "pr_number": 1130, "url": "https://github.com/encode/httpx/pull/1130#discussion_r465873534"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `conformance.py`:\n\n```python\nf\"--python-version={python_version}\",\n            \"--output-format=gitlab\",\n            \"--ignore=assert-type-unspellable-subtype\",\n            \"--error=invalid-legacy-positional-parameter\",\n```"}, {"role": "assistant", "content": "I feel like we should set up our conformance suite integration such that warnings count as errors for conformance suite purposes in general."}], "_meta": {"repo": "astral-sh/ruff", "pr_number": 22943, "url": "https://github.com/astral-sh/ruff/pull/22943#discussion_r2748483779"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `finegrained_fp8.py`:\n\n```python\nself.block_size = block_size\n        self.num_experts = config.num_local_experts\n        self.hidden_dim = config.hidden_size\n        self.intermediate_dim = config.intermediate_size\n        intermediate_dim = (\n            config.moe_intermediate_size if hasattr(config, \"moe_intermediate_size\") else config.intermediate_size\n        )\n        self.intermediate_dim = intermediate_dim\n```"}, {"role": "assistant", "content": "let's set `self.intermediate_dim` directly instead of the double assignment"}], "_meta": {"repo": "huggingface/transformers", "pr_number": 43616, "url": "https://github.com/huggingface/transformers/pull/43616#discussion_r2746151373"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `__init__.py`:\n\n```python\ndst_contents = format_file_contents(src_contents, fast=fast, mode=mode)\n    except NothingChanged:\n        return False\n    except ModuleNotFoundError:\n        warnings.warn(\n            f\"Skipping '{src}' as Jupyter dependencies are not installed.\\n\"\n            \"You can fix this by running ``pip install black[jupyter]``\"\n        )\n        return False\n```"}, {"role": "assistant", "content": "This is also what's causing the caching bug I noted above."}], "_meta": {"repo": "psf/black", "pr_number": 2357, "url": "https://github.com/psf/black/pull/2357#discussion_r671599527"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `config.py`:\n\n```python\nThe format of JSON serialized timedeltas. Accepts the string values of `'iso8601'` and\n    `'float'`. Defaults to `'iso8601'`.\n\n    - `'iso8601'` will serialize timedeltas to ISO 8601 durations.\n    !!! warning\n        In v2.11+ it is recommended to use the [`ser_json_temporal`][pydantic.config.ConfigDict.ser_json_temporal]\n        setting instead of `ser_json_timedelta`. This setting will be deprecated in v3.\n    - `'iso8601'` will serialize timedeltas to [ISO 8601 text format](https://en.wikipedia.org/wiki/ISO_8601#Durations).\n    - `'float'` will serialize timedeltas to the total number of seconds.\n```"}, {"role": "assistant", "content": "```suggestion\r\n    - `'iso8601'` will serialize timedeltas to ISO 8601 text format.\r\n    - `'float'` will serialize timedeltas to the total number of seconds.\r\n    \r\n    !!! warning\r\n        Starting in v2.11, it is recommended to use the [`ser_json_temporal`][pydantic.config.ConfigDict.ser_json_temporal]\r\n        setting instead of `ser_json_timedelta`. This setting will be deprecated in v3.\r\n```"}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 12068, "url": "https://github.com/pydantic/pydantic/pull/12068#discussion_r2281395813"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `_model_construction.py`:\n\n```python\nelse:\n            # These are instance variables, but have been assigned to `NoInitField` to trick the type checker.\n            for instance_slot in '__pydantic_fields_set__', '__pydantic_extra__', '__pydantic_private__':\n                del namespace[instance_slot]\n                if instance_slot in namespace:  # Safe check in case the metaclass is used other than in `BaseModel`:\n                    del namespace[instance_slot]\n```"}, {"role": "assistant", "content": "Surely, `nameapace.pop(instance_slot, None)` is better - only one lookup of the dict."}], "_meta": {"repo": "pydantic/pydantic", "pr_number": 10242, "url": "https://github.com/pydantic/pydantic/pull/10242#discussion_r1732412416"}}
{"messages": [{"role": "system", "content": "You are an expert code reviewer. Analyze the provided Python code and give constructive, specific feedback. Focus on bugs, potential issues, code quality, and improvements. Be direct and actionable."}, {"role": "user", "content": "Review this Python code from `test_feedexport.py`:\n\n```python\nmaxDiff = None\n\n    def test_init(self):\n        settings_dict = {\n            'FEED_URI': 'file:///tmp/foobar',\n            'FEED_STORAGES': {\n                'file': FileFeedStorageWithoutFeedOptions\n            },\n        }\n        crawler = get_crawler(settings_dict=settings_dict)\n        feed_exporter = FeedExporter.from_crawler(crawler)\n        with tempfile.NamedTemporaryFile() as temp:\n            settings_dict = {\n                'FEED_URI': f'file:///{temp.name}',\n```"}, {"role": "assistant", "content": "```suggestion\r\n                'FEED_URI': f'file://{temp.name}',\r\n```"}], "_meta": {"repo": "scrapy/scrapy", "pr_number": 5198, "url": "https://github.com/scrapy/scrapy/pull/5198#discussion_r683291676"}}
