{
  "tech": "postgresql",
  "count": 30,
  "examples": [
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1816,
      "title": "Mismatch between pg default encoding and client on Windows",
      "problem": "**Please complete the following information:**\n- OS: Win11 25H2\n- Psycopg version: 2.9.9 (dt dec pq3 ext lo64)\n- Python version: 3.12\n- PostgreSQL version: 14\n- pip version: 25.2\n\n**Describe the bug**\nI don't know if this is really a bug or not, might be more of config thing I'm missing. Either way I think it might be related to https://github.com/psycopg/psycopg2/issues/442\n\nWhen I install Postgres on windows with the region set to something non-English - the presumably may use more/different chars / utf8 - on connection, when the database doesn't exist yet - I'm getting a Unicode decode error. Seems to be when trying to decode the expected error from pg about the db not existing. I've confirmed with German and Japanese. I know it seems weird to try to connect before it exists but I'm trying to check if it exists.\n\nSo - a bit annoying to repro but: \n- Install PostgreSQL with region set to US English\n- Open a connection to pg with psycopg2\n\t- trying to get db that doesn't exist --> all good (excepted exception about not existing)\n- Uninstall PostgresSQL completely (remove data dir / program files folder / etc post uninstaller)\n- Switch OS region to German / Germany in Windows region settings\n- Restart\n- Reinstall PostgresSQL\n- Open a connection to pg with psycopg2\n\t- trying to get db that doesn't exist --> unexpected Unicode decode error\n- Uninstall PostgreSQL\n- Switch / keep os region in German /Germany\n\t- Select \"Beta: use unicode utf-8 for worldwide language support\" for non unicode programs\n- Restart \n- Install Postgres\n- Open a connection to pg with psycopg2\n\t- trying to get db that doesn't exist --> all good (expected exception - about db not existing)\n\nI think it could maybe related to this: https://github.com/psycopg/psycopg2/blob/master/psycopg/connection_int.c#L90 - eg it seems like Postgres is sending back raw cp1252 data, but psycopg2 is not getting the memo and trying to decode UTF8. I tried to debug but not set up to build the C side so I was stuck at the binding. Someone else also noticed and found the same workaround in (https://github.com/kvesteri/sqlalchemy-utils/issues/716) and some others might have hit this https://github.com/kvesteri/sqlalchemy-utils/issues/769\n\nI tried sending a couple settings the connect string like playing with lc_messages, client_encoding, etc - but I could get neither the version installed with region set to English to fail (trying to cause the mismatch and understand it) nor the version installed in German to work. Also switching them around in `psql` didn't affect anything.\n\nOddly - on the \"installed in English version\" - I can switch to german using lc_messages and it works. \n\nFrom the working German messages I can see that when it fails, it's trying to decode this angled quote char (\u00bb), which in cp1252 is just `0xbb` but in UTF8 would be `0xc2 0xbb`...\n\n```bash\n...\n...\n...\n  File \"c:\\dev\\redacted\\virtual_env\\Lib\\site-packages\\psycopg2\\__init__.py\", line 123, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xbb in position 79: invalid start byte\n\n```\n\nI put the little script to repro here, the annoying part is really the uninstall / reinstall / setttings switching. \n\nhttps://github.com/heathhenley/pg_region_debug\n\nAfter install with the English region version from pg on my \"postgres\" default db I get (idk if these are relevant - but just trying to sus it out):\n- \"SHOW LC_MESSAGES\" -->  \"English_United States.1252\"\n- \"SHOW CLIENT_ENCODING\" --> \"UNICODE\" (setting this to cp1252 didn't break)\n\nIn the German region version I get (this one is raising):\n- \"SHOW LC_MESSAGES\" --> \"German_Germany.1252\"\n- \"SHOW CLIENT_ENCODING\" --> \"WIN1252\" (setting this to unicode using psql didn't fix)\n\nIn the German region version with \"beta: use unicode utf-8 support for universal languages\" on in region settings (this one works!):\n- \"SHOW LC_MESSAGES\" --> \"German_Germany.UTF8\" (setting this to German_Germany.1252 doesn't trigger error)\n- \"SHOW CLIENT_ENCODING\" --> \"UTF8\" (setting this to WIN1252 doesn't trigger error)\n\nThere's also an option to change the locale when you run the postgres installer on windows (at least the one packaged by edb) - which I suspect probably affects this but I didn't try it yet. I also haven't tried psycopg3 yet but planning to update when I get a chance.\n",
      "solution": "Yes, in pg3 we have improved that area a lot.\n\nThe problem with connection errors is that we receive them before we receive the database encoding (which will never be sent). So we take care of it the best way we can:\n\n- upon receiving a connection error, we decode it as utf8 (the sanest default) but with chars replacing instead of erroring on decode errors\n- if a user has specified an encoding in their connection string then such encoding is used for decoding, as you have verified in your last message.\n\nI will close this ticket because we are not planning to backport these improvements to pg2. You are free to use pg3 of course, but fixing this issue in pg2 codebase is not something I am willing to provide for free. Sponsorship to the problem is welcome (but I prefer to use sponsored time to improve pg3 rather than backport its feature to a 20 years old codebase \ud83d\ude09)",
      "labels": [],
      "created_at": "2025-11-12T15:36:09Z",
      "closed_at": "2025-11-12T18:39:53Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1816",
      "comments_count": 6
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1811,
      "title": "Postgres notices that happen right when the connection is established are written directly to stderr",
      "problem": "- OS: Debian 12\n- Psycopg version: 2.9.11\n- Python version: 3.11 (latest patch packaged by debian)\n- PostgreSQL version: managed postgres on Google cloud (I do not have the exact version at hand right now, but can find out if required)\n\n---\n\nDear maintainers,\nWhen our application connects to a managed postgres database on GCP with a password that is near expiry, the following is printed to stderr:\n\n`Caution: Password is set to expire on 2025-09-13 06:23:52+00. Be sure to update the password before the expiration time.`\n\nWe did some digging and it appears that this is a `NOTICE` that is sent on connection establishment. As our password is rotated regularly, this message is not actionable for us and we would like to suppress it.\n\nAs we do not have a custom notice handler in our python application, this notice should not appear on stderr in the first place. I read through the psycopg2 code and I believe that there is a race condition where `NOTICE` messages that are sent right when the connection is established are handled by the default `libpq` notice handler which writes directly to stderr and can not be suppressed from python code.\n\nWould you consider this a bug in psycopg2, or do you have suggestions how we could suppress that message? \nThanks a lot in advance\n\n## Pointers:\n* The default `libpq` notice handler that logs to stderr: https://www.postgresql.org/docs/current/libpq-notice-processing.html#LIBPQ-NOTICE-PROCESSING\n* The code where the notice handler is set **after** the connection was fully established and some notices might already have been sent: https://github.com/psycopg/psycopg2/blob/master/psycopg/connection_int.c#L717-L743\n",
      "solution": "Hmmm not so easy. The fact that PQconnectDB is a factory function makes the thing difficult.\n\nUnfortunately `pqConnectDBComplete` is an internal function, not an API function, therefore we cannot reimplement that thin wrapper.\n\nThe problem can be solved by setting up a connection using the async API [PQconnectStart/Poll](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-PQCONNECTSTARTPARAMS).\n\nUsing the async path means creates major regressions: timeout, multiple hosts connections, load balancing etc. are not handled by the libpq and need to be re-employmented by the driver. This is a major work that was done for psycopg 3 but I don't see happening in psycopg2.\n\nTherefore let's close this here and let's say that maybe this will be done in Psycopg 3. We would still need to jump through some hoops because we currently set the notice handler after connecting, but there should be a way to sneak it before starting to poll.\n\nFeel free to:\n\n- test if the issue is verified on Psycopg 3 too\n- open a ticket on the Psycopg 3 tracker\n- propose to sponsor the development of the feature, because it happens on a proprietary database\n\nThank you very much",
      "labels": [],
      "created_at": "2025-10-22T13:04:15Z",
      "closed_at": "2025-10-23T08:47:49Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1811",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1634,
      "title": "psycopg2  The error message does not match the actual situation",
      "problem": "**This is a bug tracker**\r\nIf you have a question, such has \"how do you do X with Python/PostgreSQL/psycopg2\" please [write to the mailing list](https://lists.postgresql.org/manage/) or [open a question](https://github.com/psycopg/psycopg2/discussions) instead.\r\n\r\n**Please complete the following information:**\r\n- OS:win11\r\n- Psycopg version:2.9.9\r\n- Python version:3.11\r\n- PostgreSQL version:15.9\r\n- pip version 22.1\r\n- PC NAME: pc20070343\r\n\r\n**Describe the bug**\r\nPlease let us know:\r\nAnother computer is connected normally \r\n\r\nI cannot connect to myself using PC20070343\r\n\r\nconn = psycopg2.connect( host=\"pc20070343\",  port=\"5432\")\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\Ot903056\\PycharmProjects\\PublicServer\\test.py\", line 4, in <module>\r\n    conn = psycopg2.connect(\r\n           ^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\Ot903056\\PycharmProjects\\PublicServer\\venv\\Lib\\site-packages\\psycopg2\\__init__.py\", line 122, in connect\r\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xd6 in position 84: invalid continuation byte\r\n\r\nBUT!\r\nconn = psycopg2.connect( host=\"127.0.0.1\",  port=\"5432\")  Successfully connected!\r\n\r\nconn = psycopg2.connect( host=\"locationhost\",  port=\"5432\")  # not input database\r\n\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\Ot903056\\PycharmProjects\\PublicServer\\test.py\", line 4, in <module>\r\n    conn = psycopg2.connect(\r\n           ^^^^^^^^^^^^^^^^^\r\n  File \"C:\\Users\\Ot903056\\PycharmProjects\\PublicServer\\venv\\Lib\\site-packages\\psycopg2\\__init__.py\", line 122, in connect\r\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xd6 in position 61: invalid continuation byte\r\n\r\nThe error message does not match the actual situation\r\n",
      "solution": "@eayin2 thank you for confirming that the issue is fixed in psycopg 3.\r\n\r\nFixing the issue in psycopg2 is not trivial, so it will not be done, unless someone wants to fund for the development.\r\n\n\n---\n\nhey dude, I got the same problem, and I solved it. Are you from China? If you create database with  **_Collate_** and **_Ctype_** in Chinese but not in `en_US.utf8 ` that will case the `UnicodeDecodeError`\r\n![image](https://github.com/psycopg/psycopg2/assets/36042895/3461e9fc-f4a4-4491-b986-9282c6b3648e)\r\n\n\n---\n\nsolved for me after giving correct password for the user.",
      "labels": [],
      "created_at": "2023-10-13T03:01:07Z",
      "closed_at": "2025-10-22T12:00:39Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1634",
      "comments_count": 20
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1791,
      "title": "python core dump if execute has more arguments than placeholders",
      "problem": "**Please complete the following information:**\n- OS: ArchLinux, kernel 6.14.6-arch1-1\n- Psycopg version: 2.9.10\n- Python version: 3.13.5\n- PostgreSQL version: 17.5\n- pip version 25.1.1\n\n**Describe the bug**\n\nExecuting the following script:\n\n```\nimport psycopg2 as pg\nconnection = pg.connect(dbname=\"test\")\ncursor = connection.cursor()\ncursor.execute(\"select * from values where a = %s\", [\"test\", 1])\n```\n\nFails with:\n\n```\npython: /usr/include/python3.13/cpython/bytesobject.h:25: PyBytes_AS_STRING: Assertion `PyBytes_Check(op)' failed.\nAborted (core dumped)\n```\n\nThe issue is caused by having more arguments than placeholders, so of course it's a user error. But it feels like aborting the interpreter is too brutal, and it would be nice if there was a clearer error message (psycopg 3 correctly throws a ProgrammingError in the same example).",
      "solution": "I don't think there's something too unusual, but I guess some version/packaging differences are there. Will try to make a Docker image.\n\nPerhaps you can point me to an example Docker template? I tried looking through the issues, but failed to find other issues with Docker reproducers.\n\n---\n\nManaged to reproduce the issue inside Docker with an ArchLinux-built psycopg2, but not with psycopg2-binary from pip. So looks like it is indeed some packaging issue.\n\nHere's a reproducer:\n\n```\n$ docker network create repro_2025-07-09\n$ docker run --rm --name=pgsql-17.5 --env POSTGRES_PASSWORD=test --env POSTGRES_USER=test --env POSTGRES_DB=test --network repro_2025-07-09 postgres:17.5\n\n# in another terminal\n$ docker run --rm --tty --interactive --entrypoint bash --network repro_2025-07-09 archlinux:base-20250629.0.373469\n[root@bcc4a3ec0a82 /]# pacman -Sy python python-psycopg2\n[root@bcc4a3ec0a82 /]# python\nPython 3.13.5 (main, Jun 21 2025, 09:35:00) [GCC 15.1.1 20250425] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import psycopg2 as pg\n>>> connection = pg.connect(host=\"pgsql-17.5\", user=\"test\", password=\"test\", dbname=\"test\")\n>>> cursor = connection.cursor()\n>>> cursor.execute(\"select * from values where a = %s\", [\"test\", 1])\npython: /usr/include/python3.13/cpython/bytesobject.h:25: PyBytes_AS_STRING: Assertion `PyBytes_Check(op)' failed.\nAborted (core dumped)\n\n# cleanup\n$ docker network rm repro_2025-07-09\n```\n\n---\n\nI narrowed the issue to `-DNDEBUG` gcc flag. This flag disables asserts, so essentially the difference is that psycopg2-binary from pip was built without asserts, but ArchLinux package keeps the asserts in (CFLAGS in ArchLinux does not include `-DNDEBUG`).\n\nFailing assertion is on this line: https://github.com/psycopg/psycopg2/blob/master/psycopg/cursor_type.c#L345\n\nIt looks like the issue is that in Python 3, exception strings are Unicode strings, not bytes. Replacing `Bytes_AS_STRING` with `PyUnicode_AsUTF8` fixes the issue.",
      "labels": [],
      "created_at": "2025-07-09T05:43:03Z",
      "closed_at": "2025-10-09T23:24:32Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1791",
      "comments_count": 8
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1490,
      "title": "Cannot find libpq.5.dylib after updating to postgres 14.5",
      "problem": "# tl; dr\r\n\r\nHomebrew PostgreSQL installation moved the location of the libpq.\r\n\r\nReinstalling psycopg2 should fix the problem.\r\n\r\n---\r\n\r\nI'm using the latest `postgresql@14`, installed by `brew`.\r\n\r\nI was getting the following error today\r\n\r\n```text\r\nTraceback (most recent call last):\r\n  File \"/Users/matt/servertest/diff/snapshot.py\", line 12, in <module>\r\n    from app import app\r\n  File \"/Users/matt/server-core/app/__init__.py\", line 9, in <module>\r\n    import psycopg2.extensions\r\n  File \"/Users/matt/.pyenv/versions/nammu-backend-3.10.3/lib/python3.10/site-packages/psycopg2/__init__.py\", line 51, in <module>\r\n    from psycopg2._psycopg import (                     # noqa\r\nImportError: dlopen(/Users/matt/.pyenv/versions/nammu-backend-3.10.3/lib/python3.10/site-packages/psycopg2/_psycopg.cpython-310-darwin.so, 0x0002): Library not loaded: '/usr/local/opt/postgresql/lib/libpq.5.dylib'\r\n  Referenced from: '/Users/matt/.pyenv/versions/3.10.3/envs/nammu-backend-3.10.3/lib/python3.10/site-packages/psycopg2/_psycopg.cpython-310-darwin.so'\r\n  Reason: tried: '/usr/local/opt/postgresql/lib/libpq.5.dylib' (no such file), '/usr/local/lib/libpq.5.dylib' (no such file), '/usr/lib/libpq.5.dylib' (no such file), '/usr/local/Cellar/postgresql@14/14.5_1/lib/libpq.5.dylib' (no such file), '/usr/local/lib/libpq.5.dylib' (no such file), '/usr/lib/libpq.5.dylib' (no such file)\r\n```\r\n\r\nIt started after running\r\n\r\n```bash\r\nbrew update && brew upgrade\r\n```\r\n\r\nThe reason is that the `libpq.5.dylib` file is expected in\r\n\r\n```text\r\n/usr/local/Cellar/postgresql@14/14.5_1/lib/libpq.5.dylib\r\n```\r\n\r\nBut is actually in\r\n\r\n```text\r\n/usr/local/Cellar/postgresql@14/14.5_1/lib/postgresql@14/libpq.5.dylib\r\n```\r\n\r\nThe solution was to reinstall `psycopg2`\r\n\r\n```bash\r\npip reinstall pyscopg2\r\n```\r\n\r\nThere was not a new version of `psycopg2` available. I was already using `psycopg2` version 2.9.3.\r\n\r\nRather, it might be that, when installing, `psycopg2` looks for and caches the path to the `libpq.5.dylib` file, which has changed in the latest version of `postgres`. Maybe someone here can confirm this?\r\n\r\nBefore today, I was using `postgres` 14.4 without issue. The problematic update was to `postgres` 14.5, which was released on August 11th, 2022. It was available as an update via `brew` sometime between August 24th and 27th, 2022.\r\n\r\nSorry to post a resolved issue, but I thought it might help someone.",
      "solution": "As I just mentioned in https://github.com/Homebrew/homebrew-core/issues/109164:\r\n> I found a reason why reinstalling `dbt` wasn't enough:\r\n> https://github.com/dbt-labs/dbt-core/blob/1df713fee986741289568f553befdd4e38a51122/plugins/postgres/setup.py#L32-L40\r\n> `dbt` by default uses `psycopg2-binary`, not `psycopg2`. And it seems reinstalling `psycopg2-binary` doesn't solve the issue, but additionally installing pure `psycopg2` - does.\r\n\r\nSo maybe we should re-open the issue if `psycopg2-binary` is still affected?\r\n\n\n---\n\n> > For the record, re-installing \"psycopg2-binary\" also works (if you're using that instead of just \"psycopg2\").\r\n> \r\n> That's interesting, because I have verified that twice in a clear environment where I installed dbt-redshift and reinstalling the binary package didn't help at all, I had to play with the source package.\r\n\r\nyou also have to clear the pip / wheel cache locally. \r\n\r\nAs I understood the issue this can only happen when the wheel was locally built, then cached. A reinstall won't rebuild the local wheel but only pull it from the cache\n\n---\n\n> > For the record, re-installing \"psycopg2-binary\" also works (if you're using that instead of just \"psycopg2\").\r\n> \r\n> That's interesting, because I have verified that twice in a clear environment where I installed dbt-redshift and reinstalling the binary package didn't help at all, I had to play with the source package.\r\n\r\nHmm, well then I guess I could give some context on what my set up is like. My system is an M1 Macbook Air. Yesterday I started experiencing issues with my Postgres installation, which was installed through Homebrew. This was related to upgrading to the latest version of postgres - v14.5, I believe. Some of the paths changed - and this broke many things. I tried fixing it in various ways, including a full re-install of Postgres through Homebrew, until I decided to try out \"Postgres app\" ([link](https://postgresapp.com/)). This worked immediately and made my Db accessible and usable again through PSQL and pgAdmin (I had backups available, so I just used 'pg_restore' to get my data restored). However, I still wasn't able to interact with it using Python.\r\n\r\nRelatedly, the way I was using Postgres in Python was through PipEnv. For the longest time, I had 'psycopg2-binary' and just 'pscopg' (which is version 3.x) installed in that same PipEnv virtual env. I think having the latter package didn't really affect anything. I had even forgotten that it was around.\r\n\r\nIn any case, these are the steps I took today to fix the issue I had with psycopg:\r\n* Removed 'psycopg' (v3.x): 'pipenv uninstall psycopg' (this is probably not relevant)\r\n* 'pipenv uninstall psycopg2-binary'\r\n* 'pipenv install psycopg2-binary'\r\n\r\nI didn't do any cache clearing - it worked immediately.",
      "labels": [],
      "created_at": "2022-08-28T03:02:35Z",
      "closed_at": "2022-09-05T14:27:50Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1490",
      "comments_count": 21
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1434,
      "title": "Unable to build and install psycopg2 on Apple M1 chip with Python3.9",
      "problem": "**This is a bug tracker**\r\nIf you have a question, such as \"how do you do X with Python/PostgreSQL/psycopg2\" please [write to the mailing list](https://lists.postgresql.org/manage/) or [open a question](https://github.com/psycopg/psycopg2/discussions) instead.\r\n\r\n**Before opening this ticket, please confirm that:**\r\n- [x] I am running the latest version of pip, i.e. typing ``pip --version`` you get [this version](https://pypi.org/project/pip/). [\u2705](https://github.com/psycopg/psycopg2/issues/1208)\r\n- [x] I have read the [installation documentation](https://www.psycopg.org/docs/install.html) and the [frequently asked questions](https://www.psycopg.org/docs/faq.html)  [\u2705]\r\n- [x] I am not trying to install `psycopg2-binary` on an Apple M1, for which [binary packages are not supported](https://github.com/psycopg/psycopg2/issues/1286)  [\u2705]\r\n- [x] If install failed, I typed `pg_config` on the command line and I obtained an output instead of an error.  [\u2705]\r\n\r\n**Please complete the following information:**\r\n- OS: macos 11.5.2 with M1 chip\r\n- Psycopg version: psycopg2 >= 2.8.0\r\n- Python version: python3.9.10\r\n- PostgreSQL version: 14.2\r\n- pip version: 22.0.4\r\n\r\nusing `pip install psycopg` I have tried installing various versions of psycopg2>=2.9.0 on my macOS M1 chip but zero success. \r\nI have followed this thread [here](https://github.com/psycopg/psycopg2/issues/1208) but had no success. \r\nI have installed the various required libraries like libpq, openssl but no success.\r\nI have had some success building psycopg2 on python3.8 and tried porting the build to py3.9. But when I launch the app I get the infamous `Symbol not found: _PQbackendPID` error.\r\ninstalling psycopg-binary did not work too which is expected.\r\n\r\nI do not know what else to do. Any help is kindly appreciated. Here are the build errors I get\r\n[clang_py39_build_error.txt](https://github.com/psycopg/psycopg2/files/8256087/clang_py39_build_error.txt)\r\n\r\n",
      "solution": "Thanks. I fixed the issue with [this](https://stackoverflow.com/a/39244687/9181403)\n\n---\n\nIssue still persists. If the problem occur, one need to link the library.\nexport LDFLAGS=\"-L$(brew --prefix openssl)/lib\" \nexport CPPFLAGS=\"-I$(brew --prefix openssl)/include\"",
      "labels": [],
      "created_at": "2022-03-15T18:15:10Z",
      "closed_at": "2022-03-15T19:43:16Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1434",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1784,
      "title": "SSL issue when using psycopg in combination with tensorflow",
      "problem": "**Please complete the following information:**\n- OS: Docker python 3.12-slim\n- Psycopg version: psycopg 3.2.9 (also binary and C), psycopg2 2.9.10 (also binary and C)\n- Python version: 3.12\n- PostgreSQL version: 16.3\n- pip version: \n\n**Describe the bug**\n\nAfter a long search and trial and error I found the following bug regarding the usage of psycopg in combination with Tensorflow.\nEvery time the application would have a segmentation error when starting up the SSL connection.\n\n![Image](https://github.com/user-attachments/assets/a75bb8f5-e99d-4968-b603-327deb85ed97)\n\nWorkaround was to import psycopg before tensorflow.\nFYI: I tried all packages of psycopg (binary, c)\n\n![Image](https://github.com/user-attachments/assets/9d454d66-849a-47cd-96fe-1d3d308a08b5)\n\nResult afterwards:\n\n![Image](https://github.com/user-attachments/assets/250bc24f-c7a8-4506-8c1c-7c67be3b9e9f)\n\nHopefully this post helps other people to avoid this",
      "solution": "The issue has been reported upstream. Tensorflow uses [BoringSSL](https://github.com/google/boringssl), which is described as a fork of OpenSSL. Most likely this brings to a conflict in the global symbols.\n\nI doubt we can do anything about it ourselves. Tensorflow should migrate to use OpenSSL instead but it's up to them to decide if and when.\n\nWhile the import ordering seems to work for the author, it's not impossible that it will stop working at some time in the future. In order to prevent this to happen, my suggestion is to organise your software as a multi-process system, keeping separate the code importing Tensorflow from the code importing Psycopg, and to communicate between the two components using IPC.\n\nWhich is a pain, I understand. I had to do something similar in order to work around problems with... another Google library, gRPC. So is all I have to say is \"meh\".\n\nThank you very much for the report, I do hope it will be useful to others. Closing this here because we have no other action to take. If we can actively do something we can discuss about it in https://github.com/tensorflow/tensorflow/issues/93969.",
      "labels": [],
      "created_at": "2025-05-22T06:58:33Z",
      "closed_at": "2025-06-05T02:39:53Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1784",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1773,
      "title": "Psycopg2.connect warning",
      "problem": "**This is a bug tracker**\nWhy am I getting Server-Side Request Forgery (SSRF)  \"conn = psycopg2.connect(host=host, user=user, dbname=dbname, password=password, sslmode=sslmode, connect_timeout=5)\"\n\nI have ensured that host regex and trusted ip, still i am getting the isssue.\n\n**Please complete the following information:**\n- Psycopg version: 2.9.9\n- Python version: >3.9\n- pip version >24\n\n**Describe the bug**\nPlease let us know:\nScript-\n\n```python\nfrom flask import request, jsonify\nimport logging\nimport psycopg2\nfrom datetime import datetime\nimport os\nfrom urllib.parse import urlparse\nimport re\nfrom config import Config\nimport socket\nfrom ipaddress import ip_address, ip_network\n\nhost = os.environ.get(\"HOST\")\nuser = os.environ.get(\"USER\")\ndbname = os.environ.get(\"DBNAME\")\npassword = os.environ.get(\"PASSWORD\")\nsslmode = \"require\"\n\ntrusted_hosts = Config.HOST\n\n# Block IP ranges (private networks)\nprivate_networks = [\n    ip_network('172.16.0.0/12'),\n    ip_network('192.168.0.0/16'),\n    ip_network('169.254.0.0/16'),\n    ip_network('127.0.0.0/8')\n]\n\n# Validate host input (use regex to match valid domain names or IP addresses)\ndef is_valid_host(host):\n    # Simple regex to allow only valid IPs or domain names\n    domain_pattern = r'^(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,}$'\n    ip_pattern = r'^(?:\\d{1,3}\\.){3}\\d{1,3}$'  # Basic IPv4 check\n    if re.match(domain_pattern, host) or re.match(ip_pattern, host):\n        return True\n    return False\n\ndef is_safe_url(url):\n    parsed_url = urlparse(url)\n    # Block unsafe schemes like file://, ftp://, etc.\n    unsafe_schemes = ['file', 'ftp', 'dict', 'gopher']\n    if parsed_url.scheme in unsafe_schemes:\n        return False\n    return True\n\ndef is_trusted_ip(host):\n    try:\n        resolved_ip = socket.gethostbyname(host)\n        # Check if the resolved IP is in the restricted ranges or private networks\n        if any(ip_address(resolved_ip) in network for network in private_networks):\n            logging.error(f\"Attempt to connect to a restricted IP address: {resolved_ip}.\")\n            raise ValueError(\"Untrusted internal IP detected!\")\n        return True\n    except socket.gaierror:\n        logging.error(f\"Failed to resolve the host: {host}.\")\n        raise ValueError(f\"Invalid host: {host}\")\n\ndef is_allowed_host(host):\n    # Check if the host is in the list of trusted hosts\n    if host not in trusted_hosts:\n        logging.error(\"Host not found in trusted list.\")\n        raise ValueError(\"Untrusted host detected!\")\n\ndef validate_url_scheme(url):\n    parsed_url = urlparse(url)\n    if parsed_url.scheme not in ['http', 'https']:\n        logging.error(f\"Unsafe URL scheme detected: {parsed_url.scheme}\")\n        raise ValueError(\"Unsafe URL scheme detected!\")\n\n# Ensure host format is valid\nif not is_valid_host(host):\n    print(f\"Invalid host format: {host}\")\n    raise ValueError(\"Invalid host format detected!\")\n\n# Check if the host is in the trusted list\nis_allowed_host(host)\n\n# Validate if the resolved IP is safe (i.e., not internal)\nis_trusted_ip(host)\n\n# Ensure safe URL scheme\nif not is_safe_url(host):\n    raise ValueError(f\"Unsafe URL scheme detected: {host}\")\n\nif dbname != Config.DBNAME:\n    logging.error(\"Database not found\")\n    raise ValueError(\"Untrusted dbname detected!\")\n\nconn = None \ntry:\n    validate_url_scheme(host)\n    conn = psycopg2.connect(host=host, user=user, dbname=dbname, password=password, sslmode=sslmode, connect_timeout=5)\n    logging.info(\"Database connection established for geme analytics\")\nexcept psycopg2.OperationalError as oe:\n    logging.error(f\"Operational error: {oe}\")\nexcept psycopg2.InterfaceError as ie:\n    logging.error(f\"Interface error: {ie}\")\nexcept psycopg2.DatabaseError as de:\n    logging.error(f\"Database error: {de}\")\nexcept psycopg2.Error as e:\n    logging.error(f\"General psycopg2 error: {e}\")\nexcept Exception as e:\n    logging.error(f\"An unexpected error occurred: {e}\")\nfinally:\n    if conn:\n        logging.info(\"Database connection maintained for geme analytics\")\n    else:\n        logging.info(\"No connection to close\")\n```\n\n\nIf possible, provide a script reproducing the issue.\n",
      "solution": "You are reporting an seems to be an issue with a source code security scanner on your codebase. This has nothing to do with psycopg. You should report the issue with Kodiak.",
      "labels": [],
      "created_at": "2025-02-17T11:27:31Z",
      "closed_at": "2025-02-17T12:15:36Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1773",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1445,
      "title": "SSL SYSCALL error: EOF detected",
      "problem": "I am using a ThreadedConnectionPool in a Flask app, and using context manager to get and return connections to the pool. The pattern I am using is this:\r\n\r\n```\r\nPS_POOL = ThreadedConnectionPool(10, 100, host=PGURL, user=PGUSER, password=PGPASSWORD, port=5432)\r\n\r\n@contextmanager\r\ndef get_cursor():\r\n    conn = PS_POOL.getconn()\r\n    conn.autocommit = True\r\n    try:\r\n        cursor = conn.cursor(cursor_factory=RealDictCursor)\r\n        yield cursor\r\n    finally:\r\n        cursor.close()\r\n        PS_POOL.putconn(conn)\r\n\r\nwith get_cursor() as cursor:\r\n    cursor.execute(\"some query\")\r\n```\r\n\r\nAs you can see, my context function closes the cursor and then puts the connection back into the pool when it is finished. My issue is that I am occasionally seeing the error ```SSL SYSCALL error: EOF detected``` when performing a query. This error happens a few times in a row after inactivity, and then the call will start working again, so I assume some of the connections in the pool are corrupted somehow. I'm filing this as an issue because I assume the connection pool should be returning working connection objects.",
      "solution": "Yes, it is an issue, but it cannot be fixed easily, and will not be fixed in psycopg 2.\r\n\r\nPsycopg 3 pool works better. About psycopg 2, there are [ways to detect disconnections](https://www.psycopg.org/psycopg3/docs/advanced/async.html#detecting-disconnections) which can be used with psycopg 2 pool too. Psycopg 2 pool doesn't have a `check()` method like psycopg 3 does, but all in all it's a simple object and it wouldn't be a problem to empty it.\r\n\r\nMore details about what can and can't be done is also available in [psycopg 3 pool docs](https://www.psycopg.org/psycopg3/docs/advanced/pool.html#connection-quality).\r\n\r\nFor psycopg-pool 3.2 I am considering to introduce an automatic disconnection check: https://github.com/psycopg/psycopg/issues/247 for details.\r\n\r\nWhatever happens, it will not happen in psycopg 2: its pool is a really simplistic object and it is not a good base to bolt other features on top of it. It is not an \"active\" object, like psycopg 3 one, so there is not really a way to check for connection quality in the background and I don't want to add a check on getconn for reasons explained in the docs linked above.\n\n---\n\nIt fixed for me after increasing server resources (including CPU and RAM).\n\n---\n\nHi @arabinda-g  - \r\nGood to know you fixed this issue and I m also facing it btw like occasionally seeing the error SSL SYSCALL error: EOF detected when performing a query.\r\n\r\nSo where did you increase the CPU and RAM ? \r\nHave you observed any insufficient CPU and memory which give you the evidence to increase it ? \r\n\r\n",
      "labels": [],
      "created_at": "2022-04-07T21:47:57Z",
      "closed_at": "2022-04-07T22:09:56Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1445",
      "comments_count": 9
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1736,
      "title": "Add Python 3.13 packages for Windows",
      "problem": "Packages for other platforms already released: see #1692.\r\n\r\nFor Windows we need https://github.com/appveyor/ci/issues/3927\r\n",
      "solution": "@dvarrazzo Thanks for making note of this, this is currently impacting our team\r\n\r\nFingers crossed will be resolved soon. Have a great one \ud83d\ude07\n\n---\n\nI am also having this exact issue. @muizz-IHT  and @Loparch. I am on python 13. tried downgrading and that didnt help. Installed using pip install pyscopg2-binary, uninstalled and reinstalled a few times. Installed the visual studio C+ tools, etc. Tried everything I could now posting this here. The issue for me happens here:\r\n\r\n```\r\n$ c:/Users/myuser/Home/Development/venv2/Scripts/python.exe c:/Users/myuser/Home/Development/app/main.py\r\nTraceback (most recent call last):\r\n  File \"c:\\Users\\myuser\\Home\\Development\\app\\main.py\", line 30, in <module>\r\n    engine=create_engine(DATABASE_URL)\r\n  File \"<string>\", line 2, in create_engine\r\n  File \"C:\\Users\\myuser\\Home\\Development\\venv2\\Lib\\site-packages\\sqlalchemy\\util\\deprecations.py\", line 281, in warned\r\n    return fn(*args, **kwargs)  # type: ignore[no-any-return]\r\n  File \"C:\\Users\\myuser\\Home\\Development\\venv2\\Lib\\site-packages\\sqlalchemy\\engine\\create.py\", line 599, in create_engine\r\n    dbapi = dbapi_meth(**dbapi_args)\r\n  File \"C:\\Users\\myuser\\Home\\Development\\venv2\\Lib\\site-packages\\sqlalchemy\\dialects\\postgresql\\psycopg2.py\", line 690, in import_dbapi\r\n    import psycopg2\r\n  File \"C:\\Users\\myuser\\Home\\Development\\venv2\\Lib\\site-packages\\psycopg2\\__init__.py\", line 51, in <module>\r\n    from psycopg2._psycopg import (                     # noqa\r\n    ...<10 lines>...\r\n    )\r\nImportError: DLL load failed while importing _psycopg: The specified module could not be found.\r\n(venv2) \r\n```\r\n\n\n---\n\nIs there a change to workaround this by using Github Actions instead or [Python 3.13rc1 on Appvayer](https://www.appveyor.com/docs/windows-images-software/#python)?",
      "labels": [],
      "created_at": "2024-10-16T11:27:45Z",
      "closed_at": "2025-01-04T20:00:45Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1736",
      "comments_count": 14
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1767,
      "title": "PostgreSQL system administration functions fail due to no FROM clause",
      "problem": "PostgreSQL has a series of built in administrative functions that you can see [in this URL](https://www.postgresql.org/docs/9.4/functions-admin.html), and as you can see in this sample, when you run pg_relation_size('TABLENAME'), you actually make no use of the FROM clause:\r\n\r\n![image](https://github.com/user-attachments/assets/3ce39014-28a2-4228-b277-17b579adea0f)\r\n\r\nHowever, when I try to query our database through psycopg2 and run this command, I am met with this error:\r\n\r\n`psycopg2.errors.UndefinedTable: missing FROM-clause entry for table \"SOMETABLE\"\r\nLINE 1: select pg_relation_size(SOMETABLE...\r\n`\r\n\r\nNormally, an SQL query is supposed to have a FROM statement, sure, but as you can see in the previously linked URL, and in the attached screenshot, these administrative functions run just fine without any FROM statements, and in fact, I cannot find a way to even get them to work *with* a FROM statement.\r\n\r\nIt's possible there is another way to make this work with psycopg2, but if there is, I'm not aware of.\r\n\r\nIf any additional information is needed, I'm naturally willing to help.",
      "solution": "As to answer your other question, I'm essentially making my own Pandas-esque module for data operations, except I was somewhat annoyed with having to use our internal tools to fetch the data that I needed because they were rather slow, so I created a direct connection to our database to allow me to query the tables I'd need without manually having to download it and move it to any specific folder for future use. I wanted to use the admin tools to give the user an estimate of how long it would take to download the query since, as far as I can tell from the testing I did yesterday, there was no good way of making a download progress tracker, so being able to present the user with the size of the download they were requesting would allow me to at least make an estimate. \r\n\r\nIf you know of a solution, I'm all ears!",
      "labels": [],
      "created_at": "2024-12-16T10:01:15Z",
      "closed_at": "2024-12-17T09:07:55Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1767",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1756,
      "title": "Update psycopg2-binary 2.9.10 error",
      "problem": "- OS: macOS 15.1.1\r\n- Psycopg version: 2.9.10\r\n- Python version: 3.9.9\r\n- PostgreSQL version: 16.1\r\n- pip version: 23.3.2\r\n- poetry version: 1.8.4\r\nI updated psycopg2-binary version from 2.9.9 to 2.9.10 using poetry and I got the following error:\r\n\r\n ld: library 'ssl' not found\r\n  clang: error: linker command failed with exit code 1 (use -v to see invocation)\r\n  error: command '/usr/bin/gcc' failed with exit code 1\r\n  \r\n\r\n  at ~/Library/Application Support/pypoetry/venv/lib/python3.12/site-packages/poetry/installation/chef.py:164 in _prepare\r\n      160\u2502 \r\n      161\u2502                 error = ChefBuildError(\"\\n\\n\".join(message_parts))\r\n      162\u2502 \r\n      163\u2502             if error is not None:\r\n    \u2192 164\u2502                 raise error from None\r\n      165\u2502 \r\n      166\u2502             return path\r\n      167\u2502 \r\n      168\u2502     def _prepare_sdist(self, archive: Path, destination: Path | None = None) -> Path:\r\n\r\nNote: This error originates from the build backend, and is likely not a problem with poetry but with psycopg2-binary (2.9.10) not supporting PEP 517 builds. You can verify this by running 'pip wheel --no-cache-dir --use-pep517 \"psycopg2-binary (==2.9.10)\"'.\r\n\r\n\r\n",
      "solution": "Hello,\r\n\r\nthis is probably just a manifestation of the problem reported in #1753.\r\n\r\nYou can specify psycopg != 2.9.10 (in the assumption that we will merge #1755 and fix the problem in the next version), or upgrade your OS. Psycopg 3 has likely the same problem and should receive a similar fix.",
      "labels": [],
      "created_at": "2024-11-25T04:25:48Z",
      "closed_at": "2024-11-25T12:02:46Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1756",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1753,
      "title": "High macOS deployment targets for psycopg2-binary",
      "problem": "**This is a bug tracker**\r\nIf you have a question, such has \"how do you do X with Python/PostgreSQL/psycopg2\" please [write to the mailing list](https://lists.postgresql.org/manage/) or [open a question](https://github.com/psycopg/psycopg2/discussions) instead.\r\n\r\n**Before opening this ticket, please confirm that:**\r\n- [x] I am running the latest version of pip, i.e. typing ``pip --version`` you get [this version](https://pypi.org/project/pip/).\r\n- [x] I have read the [installation documentation](https://www.psycopg.org/docs/install.html) and the [frequently asked questions](https://www.psycopg.org/docs/faq.html)\r\n- [ ] If install failed, I typed `pg_config` on the command line and I obtained an output instead of an error.\r\n\r\n**Please complete the following information:**\r\n- OS: macOS 13 arm64 \r\n- Psycopg version: 2.9.10\r\n- Python version: 3.12.7\r\n- PostgreSQL version:\r\n- pip version: 24.3.1\r\n\r\nThe `MACOSX_DEPLOYMENT_TARGET` sets the minimum version of macOS that the `psycopg2-binary` wheels will install on so the introduction of [setting MACOSX_DEPLOYMENT_TARGET to the CI runner version](https://github.com/psycopg/psycopg2/commit/a59079a4f2c4af12224a385eff4397954b647293#diff-5bcf795eb775d7afa43ccd6534c336b59bc441c814c20f4b30603fa7d50fb03cR171) blocks installs on anything older than the CI runner. As of `2.9.10`, `pip install psycopg2-binary` on a macOS <14.0 arm64 or <12.0 x86_64 machine will ignore the wheels, pull the sdist, probably fail to build from source and give the misleading advice to try `pip install psycopg2-binary` instead.\r\n\r\nJudging by the lack of *drop support for macOS 13* entries in the changelog and macOS 13 still having another year before its EOL date, I'm guessing that wasn't intentional?\r\n\r\nIncidentally, why publish sdists for the `psycopg2-binary` package?",
      "solution": "Hello,\r\n\r\nThe variable was added because latest cibuildwheel versions require it. If omitted, build fails. I haven't found a simple workaround. See also discussion at https://github.com/pypa/cibuildwheel/discussions/1926\r\n\r\nWe don't declare support for specific OS, we only declare support for specific Python versions. Binary packages are produced on a best-effort basis.\r\n\r\nThe presence of the source in the binary package was for a fallback for people adding `psycopg2-binary` in the `requirements.txt` and making impossible to install dependencies on platforms not supporting binary. Psycopg 3 uses [a different and better strategy](https://www.psycopg.org/psycopg3/docs/basic/install.html#handling-dependencies).\r\n\r\nAs my competence with macOS is limited and I had made my attempts at the time of releasing the latest version, I will close this ticket here. If you think you can provide a solution to the problem, a MR is welcome.",
      "labels": [],
      "created_at": "2024-11-19T10:50:21Z",
      "closed_at": "2024-11-19T22:23:40Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1753",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1286,
      "title": "psycopg2-binary support for M1 chipset",
      "problem": "Hello all,\r\nWith a big of guidance I'm happy to contribute a PR.\r\nFor now, let me document the current situation for any other M1 users. Please do correct me if I got the details wrong!\r\n\r\nPython 3.8.10 is the first 3.8 version with support for M1 chipset (see [bug](https://bugs.python.org/issue41100#msg392734)). Older versions of pyenv do not have access to Python 3.8.10 (some details in [here](https://github.com/getsentry/sentry/issues/26069)).\r\n```\r\npyenv install 3.8.10\r\npython -m venv .venv\r\nsource .venv/bin/activate\r\npython -m pip install --upgrade pip wheel\r\n```\r\n\r\nIf you try to install `psycopg2_binary` and expect a wheel, it is not currently available.\r\n\r\nThere's the `SYSTEM_VERSION_COMPAT=1` trick to pretend to be 10.6 instead of 11.x, however, the architecture still returns `arm64`.\r\n\r\n```shell\r\n\u276f python -c \"import platform; print(platform.mac_ver())\"\r\n('11.4', ('', '', ''), 'arm64')\r\n\r\n~/code/M1 via \ud83d\udc0d v3.8.2 (venv_3_system) on \u2601\ufe0f  armenzg@sentry.io\r\n\u276f SYSTEM_VERSION_COMPAT=1 python -c \"import platform; print(platform.mac_ver())\"\r\n('10.16', ('', '', ''), 'arm64')\r\n```\r\n\r\nIf you don't have a wheel then you need to build from source. See the log [1] at the bottom of this comment.\r\n\r\nIn order to have the libraries to build it, I took these steps which are based on [this post](https://www.djangocookbook.com/recipes/django-development-environment-on-apple-m1/):\r\n```shell\r\nbrew install postgresql\r\n# If you open a new terminal tab you will see that pg_config is available\r\nexport CPPFLAGS=\"-I/opt/homebrew/opt/openssl@1.1/include\"\r\nexport LDFLAGS=\"-L/opt/homebrew/opt/openssl@1.1/lib -L${HOME}/.pyenv/versions/3.8.10/lib\"\r\n```\r\n\r\nAfter that, it is possible to build the wheel\r\n```shell\r\npip install psycopg2-binary==2.8.6\r\nCollecting psycopg2-binary==2.8.6\r\n  Using cached psycopg2-binary-2.8.6.tar.gz (384 kB)\r\nBuilding wheels for collected packages: psycopg2-binary\r\n  Building wheel for psycopg2-binary (setup.py) ... done\r\n  Created wheel for psycopg2-binary: filename=psycopg2_binary-2.8.6-cp38-cp38-macosx_11_0_arm64.whl size=137096 sha256=af1103eb3c4d9fee1636d27e9dbab6c8bbe7fcd8502bea2a4a194f016a8afb85\r\n  Stored in directory: /Users/armenzg/Library/Caches/pip/wheels/15/d7/13/ef37b82cf1de521c82c129a16ad8007a81b4eab0f23b22c7b3\r\nSuccessfully built psycopg2-binary\r\nInstalling collected packages: psycopg2-binary\r\nSuccessfully installed psycopg2-binary-2.8.6\r\n```\r\n\r\nDid I do this right? How can I help to have a release that includes an arm64 wheel?\r\n\r\n[1]\r\n```\r\nSYSTEM_VERSION_COMPAT=1 pip install psycopg2-binary==2.8.6\r\nCollecting psycopg2-binary==2.8.6\r\n  Using cached psycopg2-binary-2.8.6.tar.gz (384 kB)\r\n    ERROR: Command errored out with exit status 1:\r\n     command: /Users/armenzg/code/M1/venv_3_system/bin/python3 -c 'import io, os, sys, setuptools, tokenize; sys.argv[0] = '\"'\"'/private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-install-9zonoxgp/psycopg2-binary_43fe9c32f13f470ebebbbdf290cabfe4/setup.py'\"'\"'; __file__='\"'\"'/private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-install-9zonoxgp/psycopg2-binary_43fe9c32f13f470ebebbbdf290cabfe4/setup.py'\"'\"';f = getattr(tokenize, '\"'\"'open'\"'\"', open)(__file__) if os.path.exists(__file__) else io.StringIO('\"'\"'from setuptools import setup; setup()'\"'\"');code = f.read().replace('\"'\"'\\r\\n'\"'\"', '\"'\"'\\n'\"'\"');f.close();exec(compile(code, __file__, '\"'\"'exec'\"'\"'))' egg_info --egg-base /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg\r\n         cwd: /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-install-9zonoxgp/psycopg2-binary_43fe9c32f13f470ebebbbdf290cabfe4/\r\n    Complete output (23 lines):\r\n    running egg_info\r\n    creating /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg/psycopg2_binary.egg-info\r\n    writing /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg/psycopg2_binary.egg-info/PKG-INFO\r\n    writing dependency_links to /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg/psycopg2_binary.egg-info/dependency_links.txt\r\n    writing top-level names to /private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg/psycopg2_binary.egg-info/top_level.txt\r\n    writing manifest file '/private/var/folders/j1/d109sd4n55qbk5ty8gzq5jgm0000gn/T/pip-pip-egg-info-cacpi1hg/psycopg2_binary.egg-info/SOURCES.txt'\r\n\r\n    Error: pg_config executable not found.\r\n\r\n    pg_config is required to build psycopg2 from source.  Please add the directory\r\n    containing pg_config to the $PATH or specify the full executable path with the\r\n    option:\r\n\r\n        python setup.py build_ext --pg-config /path/to/pg_config build ...\r\n\r\n    or with the pg_config option in 'setup.cfg'.\r\n\r\n    If you prefer to avoid building psycopg2 from source, please install the PyPI\r\n    'psycopg2-binary' package instead.\r\n\r\n    For further information please check the 'doc/src/install.rst' file (also at\r\n    <https://www.psycopg.org/docs/install.html>).\r\n\r\n    ----------------------------------------\r\nWARNING: Discarding https://files.pythonhosted.org/packages/fc/51/0f2c6aec5c59e5640f507b59567f63b9d73a9317898810b4db311da32dfc/psycopg2-binary-2.8.6.tar.gz#sha256=11b9c0ebce097180129e422379b824ae21c8f2a6596b159c7659e2e5a00e1aa0 (from https://pypi.org/simple/psycopg2-binary/) (requires-python:>=2.7,!=3.0.*,!=3.1.*,!=3.2.*,!=3.3.*). Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.\r\nERROR: Could not find a version that satisfies the requirement psycopg2-binary==2.8.6 (from versions: 2.7.4, 2.7.5, 2.7.6, 2.7.6.1, 2.7.7, 2.8, 2.8.1, 2.8.2, 2.8.3, 2.8.4, 2.8.5, 2.8.6)\r\nERROR: No matching distribution found for psycopg2-binary==2.8.6\r\n```",
      "solution": "Hello. Could anyone tell how to get this paackage to work on a M1 machine? What are the step-by-step workarounds? Thank you!\n\n---\n\n@fikisipi Trust is an important matter, yes, so I don't think it is wise to distribute packages in the project name which are built by third parties.\r\n\r\nI don't doubt about your good faith or intention but I wouldn't want to create a precedent for others, while at the same time desensitise people into no longer auditing the quality of the packages they install.\r\n\r\nRecent events of the guy who intentionally messed up the npm packages he maintained should be a warning call for users and a responsibility call for package authors.\r\n\r\nAs such, I would kindly ask you to request pypi to withdraw the package you distributed. I'm happy to look together with you into how to build these packages reliably and distribute them as psycopg2-binary. There is also the problem that it's impossible to create a portable requirements file if the distribution package name is different - a problem we already have with the psycopg2/psycopg2-binary packages. I don't wish to make this more complex for users.\r\n\r\nThank you for your understanding and please know that I appreciate your gesture :)\n\n---\n\n@joshfriend project was built on the same machine, tried removing and creating a new venv that didn't work but what fixed it for me was running \"pip unistall psycopg2-binary\" & \"pip unistall psycopg2\" then run \"arch -arm64 pip install psycopg2 --no-binary :all:\"",
      "labels": [],
      "created_at": "2021-06-08T18:51:45Z",
      "closed_at": "2022-07-28T12:04:56Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1286",
      "comments_count": 30
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1741,
      "title": "Anyone experiences psycopg2-2.9.10 installation failure with python3.8 on Windows?",
      "problem": "### Discussed in https://github.com/psycopg/psycopg2/discussions/1740\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **amethystzh** October 22, 2024</sup>\r\nHi, here I have a problem, that when I tried to install the latest 2.9.10 on my Windows with python3.8, it failed. yet when I tried with python3.11 it succeed. I tried with 2 of my windows PC both the same way. one is Python3.8.5, the other is Python3.8.8. I also tried on my Linux with Python3.8 it can succeed, summarize as below:\r\n|OS |Python|result|\r\n----|--------|-----|\r\n|Win|3.8.5|failed|\r\n|Win|3.8.8|failed|\r\n|Win|3.11.8|succeed|\r\n|Linux|3.8.5|succeed|\r\nseems 2.9.10 release note clarify it adds supporting for 3.13 & drops supporting for 3.7, yet has not mention 3.8, so I think it will still support 3.8?\r\nthere's an issue raised for psycopg2-binary for 3.9, but from the comments seems it's only for binary on Mac? https://github.com/psycopg/psycopg2/issues/1737</div>",
      "solution": "Similar issue for me on Ubuntu 24.04 for python 3.10 (and install works on python 3.12) when running uv pip install psycopg2 :\r\n```\r\nResolved 1 package in 2ms\r\nerror: Failed to prepare distributions\r\n  Caused by: Failed to download and build `psycopg2==2.9.10`\r\n  Caused by: Build backend failed to build wheel through `build_wheel` (exit status: 1)\r\n\r\n[stdout]\r\nrunning bdist_wheel\r\nrunning build\r\nrunning build_py\r\ncopying lib/extras.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/_ipaddress.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/_range.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/extensions.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/errors.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/sql.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/tz.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/_json.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/pool.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/__init__.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\ncopying lib/errorcodes.py -> build/lib.linux-x86_64-cpython-310/psycopg2\r\nrunning build_ext\r\nbuilding 'psycopg2._psycopg' extension\r\nclang -pthread -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -fPIC \"-DPSYCOPG_VERSION=2.9.10 (dt dec pq3 ext lo64)\" -DPSYCOPG_DEBUG=1 -DPG_VERSION_NUM=160004 -DHAVE_LO64=1 -DPSYCOPG_DEBUG=1 -I/home/paul/.cache/uv/builds-v0/.tmphdlEai/include -I/home/paul/.local/share/uv/python/cpython-3.10.13-linux-x86_64-gnu/include/python3.10 -I. -I/usr/include/postgresql -I/usr/include/postgresql/16/server -I/usr/include/libxml2 -c psycopg/adapter_asis.c -o build/temp.linux-x86_64-cpython-310/psycopg/adapter_asis.o -Wdeclaration-after-statement\r\n\r\n[stderr]\r\n\r\nIt appears you are missing some prerequisite to build the package from source.\r\n\r\nYou may install a binary package by installing 'psycopg2-binary' from PyPI.\r\nIf you want to install psycopg2 from source, please install the packages\r\nrequired for the build and try again.\r\n\r\nFor further information please check the 'doc/src/install.rst' file (also at\r\n<https://www.psycopg.org/docs/install.html>).\r\n\r\nerror: command 'clang' failed: No such file or directory\r\n```",
      "labels": [],
      "created_at": "2024-10-23T06:34:50Z",
      "closed_at": "2024-10-30T14:30:58Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1741",
      "comments_count": 6
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1737,
      "title": "psycopg2-binary version 2.9.10 installation fails on MacOS/Python 3.9",
      "problem": "**This is a bug tracker**\r\nIf you have a question, such has \"how do you do X with Python/PostgreSQL/psycopg2\" please [write to the mailing list](https://lists.postgresql.org/manage/) or [open a question](https://github.com/psycopg/psycopg2/discussions) instead.\r\n\r\n**Before opening this ticket, please confirm that:**\r\n- [ ] I am running the latest version of pip, i.e. typing ``pip --version`` you get [this version](https://pypi.org/project/pip/).\r\n- [ ] I have read the [installation documentation](https://www.psycopg.org/docs/install.html) and the [frequently asked questions](https://www.psycopg.org/docs/faq.html)\r\n- [ ] If install failed, I typed `pg_config` on the command line and I obtained an output instead of an error.\r\n\r\n**Please complete the following information:**\r\n- OS: MacOS Sonoma 14.7\r\n- Psycopg version: 2.9.10\r\n- Python version: 23.2\r\n- PostgreSQL version: \r\n- pip version: 24.2\r\n\r\nThis output is produced when trying to install 2.9.10:\r\n\r\n```\r\nCollecting psycopg2-binary\r\n  Downloading psycopg2-binary-2.9.10.tar.gz (385 kB)\r\n     \u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501 385.8/385.8 kB 4.8 MB/s eta 0:00:00\r\n  Preparing metadata (setup.py) ... error\r\n  error: subprocess-exited-with-error\r\n  \r\n  \u00d7 python setup.py egg_info did not run successfully.\r\n  \u2502 exit code: 1\r\n  \u2570\u2500> [23 lines of output]\r\n      running egg_info\r\n      creating /private/var/folders/78/cpt_wrr57ns62nrmbr5df77800rhd8/T/pip-pip-egg-info-o_le5nps/psycopg2_binary.egg-info\r\n      writing /private/var/folders/78/cpt_wrr57ns62nrmbr5df77800rhd8/T/pip-pip-egg-info-o_le5nps/psycopg2_binary.egg-info/PKG-INFO\r\n      writing dependency_links to /private/var/folders/78/cpt_wrr57ns62nrmbr5df77800rhd8/T/pip-pip-egg-info-o_le5nps/psycopg2_binary.egg-info/dependency_links.txt\r\n      writing top-level names to /private/var/folders/78/cpt_wrr57ns62nrmbr5df77800rhd8/T/pip-pip-egg-info-o_le5nps/psycopg2_binary.egg-info/top_level.txt\r\n      writing manifest file '/private/var/folders/78/cpt_wrr57ns62nrmbr5df77800rhd8/T/pip-pip-egg-info-o_le5nps/psycopg2_binary.egg-info/SOURCES.txt'\r\n      \r\n      Error: pg_config executable not found.\r\n      \r\n      pg_config is required to build psycopg2 from source.  Please add the directory\r\n      containing pg_config to the $PATH or specify the full executable path with the\r\n      option:\r\n      \r\n          python setup.py build_ext --pg-config /path/to/pg_config build ...\r\n      \r\n      or with the pg_config option in 'setup.cfg'.\r\n      \r\n      If you prefer to avoid building psycopg2 from source, please install the PyPI\r\n      'psycopg2-binary' package instead.\r\n      \r\n      For further information please check the 'doc/src/install.rst' file (also at\r\n      <https://www.psycopg.org/docs/install.html>).\r\n      \r\n      [end of output]\r\n```\r\n\r\nInstalling 2.9.9 does not have any issues in the same environment. This broke some tests in Apache Beam ([beam/#32811](https://github.com/apache/beam/issues/32811))",
      "solution": "@jrmccluskey I've reviewed the issue: all the packages we can produce on public runners have been produced and are available on PyPI:\r\n\r\n```\r\npsycopg2_binary-2.9.10-cp310-cp310-macosx_12_0_x86_64.whl\r\npsycopg2_binary-2.9.10-cp311-cp311-macosx_12_0_x86_64.whl\r\npsycopg2_binary-2.9.10-cp312-cp312-macosx_12_0_x86_64.whl\r\npsycopg2_binary-2.9.10-cp313-cp313-macosx_12_0_x86_64.whl\r\npsycopg2_binary-2.9.10-cp38-cp38-macosx_12_0_x86_64.whl\r\npsycopg2_binary-2.9.10-cp39-cp39-macosx_12_0_x86_64.whl\r\n\r\npsycopg2_binary-2.9.10-cp310-cp310-macosx_14_0_arm64.whl\r\npsycopg2_binary-2.9.10-cp311-cp311-macosx_14_0_arm64.whl\r\npsycopg2_binary-2.9.10-cp312-cp312-macosx_14_0_arm64.whl\r\npsycopg2_binary-2.9.10-cp313-cp313-macosx_14_0_arm64.whl\r\n```\r\n\r\nOther combinations are no more supported by publicly available runners so we will not support them for free. Apache Beam is welcome to contribute to this project, or to use `psycopg2` in non-binary version.\r\n\r\n@LuisHenri this is a ticket open for macOS, see #1736 about windows.",
      "labels": [],
      "created_at": "2024-10-16T18:15:36Z",
      "closed_at": "2024-10-20T13:17:03Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1737",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1692,
      "title": "Psycopg2 doesn't install on Python 3.13 alpha",
      "problem": "**This is a bug tracker**\r\nIf you have a question, such has \"how do you do X with Python/PostgreSQL/psycopg2\" please [write to the mailing list](https://lists.postgresql.org/manage/) or [open a question](https://github.com/psycopg/psycopg2/discussions) instead.\r\n\r\n**Before opening this ticket, please confirm that:**\r\n- [X] I am running the latest version of pip, i.e. typing ``pip --version`` you get [this version](https://pypi.org/project/pip/).\r\n- [X] I have read the [installation documentation](https://www.psycopg.org/docs/install.html) and the [frequently asked questions](https://www.psycopg.org/docs/faq.html)\r\n- [X] If install failed, I typed `pg_config` on the command line and I obtained an output instead of an error.\r\n\r\n**Please complete the following information:**\r\n- OS: Linux (6.8.5-zen1-1-zen) on Arch Linux\r\n- Psycopg version: 2.9.9\r\n- Python version: 3.13.0a6+ (heads/main:6dc661bc9f)\r\n- PostgreSQL version: 16.2\r\n- pip version: 24.0\r\n",
      "solution": "Yes, most definitely the upload workflow broke for the v4 passage. We had the same breakage in the psycopg 3 repository but someone was kind enough to provide an upgrade. So we have a good reference of something working, we will need to backport it here.\r\n\r\nEverything else that is currently failing (macOS builds, windows builds) is currently working on psycopg 3 so we can do a work of backporting all the other solutions used there. They include:\r\n\r\n- building windows packages on Github actions, if we cannot fix Appveyor\r\n- building macOS ARM64 packages on Github actions (instead of Scaleway)\r\n- adapting to newer versions of cibuildwheel\r\n- building libpq with OpenSSL 3.x\r\n",
      "labels": [],
      "created_at": "2024-04-16T07:47:20Z",
      "closed_at": "2024-10-16T11:28:54Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1692",
      "comments_count": 9
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1727,
      "title": "Notification is not added to notifies list when received during the commit",
      "problem": "- OS: I observe this on linux and macos but I can see this is os independent.\r\n- Psycopg version: 2.9.9\r\n- Python version: 3.11.9\r\n- PostgreSQL version: 13.15\r\n- pip version 24.0\r\n\r\n## The issue\r\n\r\nI'm using the recommended way to receive async notifications that is:\r\n\r\n1. invoke `select.select` to wait on the data available on the connection\r\n2. invoke `connection.poll`\r\n3. process `connection.notifies` list. Each notification is processed in a transaction\r\n\r\nBasically the code is almost the copy and paste from the documentation except that I do not use autocommit because I manually manage transactions:\r\n```\r\ncurs = conn.cursor()\r\ncurs.execute(\"LISTEN test;\")\r\nconn.commit()\r\n\r\nwhile True:\r\n    if select.select([conn],[],[],1) == ([],[],[]):\r\n        print(\"Timeout\")\r\n    else:\r\n        conn.poll()\r\n        while conn.notifies:\r\n            notify = conn.notifies.pop(0)\r\n            print(\"Got NOTIFY:\", notify.pid, notify.channel, notify.payload)\r\n            # some processing that updates the DB based on the notify content\r\n            conn.commit()\r\n```\r\n\r\nThe problem is that sometimes (specifically when the notification is received during the `commit`) this code gets into the state that:\r\n- there is no data to read from the socket (as `select.select` shows)\r\n- but if I invoke `poll` on the connection new notifications will be added to `notifies` list\r\n\r\nBecause of this the code loops on the `select.select` and some notifications processing is delayed until the new notification comes in later.\r\n\r\n# My interpretation of what happens\r\n\r\nI've tracked this down to the problem in the `pq_commit` and/or `pq_execute_command_locked`. Namely, according to pqlib [documentation](https://www.postgresql.org/docs/16/libpq-notify.html):\r\n\r\n> You should, however, remember to check PQnotifies after each [PQgetResult](https://www.postgresql.org/docs/16/libpq-async.html#LIBPQ-PQGETRESULT) or [PQexec](https://www.postgresql.org/docs/16/libpq-exec.html#LIBPQ-PQEXEC), to see if any notifications came in during the processing of the command.\r\n\r\n`pq_execute_command_locked` does invoke `PQexec` and that according to my understanding reads up the data from the socket but then `PQnotifies` are not checked in `pq_commit`. So the followup invocation of `select` shows there is not more data to read and there is no progress in the listen loop.\r\n\r\nMost probably this is not the only place this happens. For example in `pq_get_result_async` I can see that notifications are checked _before_ executing `PQgetResult` but according to pqlib docs above that should happen after.\r\n\r\n### The script reproducing the issue.\r\n\r\n```\r\nimport threading\r\nimport select\r\nimport psycopg2\r\nimport psycopg2.extensions\r\nimport time\r\n\r\nlisten_conn = psycopg2.connect(\"postgres://postgres:123@localhost:5432/postgres\")\r\nnotify_conn = psycopg2.connect(\"postgres://postgres:123@localhost:5432/postgres\")\r\n\r\nstop_event = threading.Event()\r\nbatch_processed_event = threading.Event()  # Event to signal batch completion\r\n\r\n\r\ndef setup_db():\r\n    \"\"\"Setup the table and trigger with a sleep to simulate slow commit.\"\"\"\r\n    with listen_conn.cursor() as curs:\r\n        # Create a test table\r\n        curs.execute(\"DROP TABLE IF EXISTS test_table;\")\r\n        curs.execute(\r\n            \"\"\"\r\n        CREATE TABLE test_table (\r\n            id SERIAL PRIMARY KEY,\r\n            value TEXT\r\n        );\r\n        \"\"\"\r\n        )\r\n\r\n        # Create the trigger function that will induce a sleep\r\n        curs.execute(\r\n            \"\"\"\r\n        CREATE OR REPLACE FUNCTION slow_commit_trigger()\r\n        RETURNS TRIGGER AS $$\r\n        BEGIN\r\n            PERFORM pg_sleep(0.5);  -- 500ms sleep to simulate slow commit\r\n            RETURN NEW;\r\n        END;\r\n        $$ LANGUAGE plpgsql;\r\n        \"\"\"\r\n        )\r\n\r\n        # Create the trigger on update\r\n        curs.execute(\r\n            \"\"\"\r\n        CREATE TRIGGER slow_commit\r\n        AFTER UPDATE ON test_table\r\n        FOR EACH STATEMENT\r\n        EXECUTE FUNCTION slow_commit_trigger();\r\n        \"\"\"\r\n        )\r\n\r\n        # Insert an initial row to update during the notification processing\r\n        curs.execute(\r\n            \"INSERT INTO test_table (id, value) VALUES (1, 'initial') ON CONFLICT DO NOTHING;\"\r\n        )\r\n\r\n    listen_conn.commit()\r\n\r\n\r\n# Function to listen for notifications\r\ndef listen(num_notifications):\r\n    with listen_conn.cursor() as curs:\r\n        curs.execute(\"LISTEN test;\")\r\n\r\n    listen_conn.commit()\r\n\r\n    print(f\"listener: Waiting for {num_notifications} notifications on channel 'test'\")\r\n\r\n    while True:\r\n        notifications_received = 0\r\n        timeout_occurred = False\r\n\r\n        start_time = time.time()\r\n        while (\r\n            notifications_received < num_notifications and time.time() - start_time < 10\r\n        ):\r\n            print(\"listener: select on the connection socket ....\")\r\n            if select.select([listen_conn], [], [], 1) == ([], [], []):\r\n                print(\"listener:  nothing to read from socket\")\r\n                continue\r\n\r\n            print(\"listener: poll after select\")\r\n            listen_conn.poll()\r\n            while listen_conn.notifies:\r\n                notify = listen_conn.notifies.pop(0)\r\n                print(\r\n                    f\"listener: Got NOTIFY: pid={notify.pid}, channel={notify.channel}, payload={notify.payload}\"\r\n                )\r\n                notifications_received += 1\r\n\r\n                # Simulate processing by updating the table, which will trigger the delay\r\n                with listen_conn.cursor() as curs:\r\n                    curs.execute(\r\n                        \"UPDATE test_table SET value = 'processed' WHERE id = 1;\"\r\n                    )\r\n                print(\"listener: commit (with delay due to trigger)\")\r\n                listen_conn.commit()\r\n\r\n        # Signal the notify thread that the batch has been processed\r\n        print(\"listener: Batch processed, signaling notifier to send next batch\")\r\n        batch_processed_event.set()  # Signal that the listener has processed the batch\r\n\r\n        # If we had a timeout, we explicitly poll and check if a delayed notification was received\r\n        if notifications_received < num_notifications:\r\n            if listen_conn.notifies:\r\n                assert False, \"we have notifications after the timeout\"\r\n            else:\r\n                print(\"listener: we don't have notifications after the timeout\")\r\n            print(\"listener: polling..\")\r\n            listen_conn.poll()\r\n            if listen_conn.notifies:\r\n                print(\"listener: we have notifications after the poll\")\r\n                stop_event.set()\r\n                return\r\n            else:\r\n                print(\"listener: we don't have notifications after the poll\")\r\n\r\n\r\n# Function to send notifications\r\ndef notify(num_notifications):\r\n    while not stop_event.is_set():\r\n        for i in range(1, num_notifications + 1):\r\n            print(f\"notifier: Sending notification {i}/{num_notifications}\")\r\n            with notify_conn.cursor() as curs:\r\n                curs.execute(f\"NOTIFY test, 'notification {i}';\")\r\n            notify_conn.commit()\r\n            time.sleep(0.1)\r\n\r\n        print(\"notifier: waiting for listener to process notifications\")\r\n\r\n        batch_processed_event.wait()\r\n        batch_processed_event.clear()  # Reset the event for the next batch\r\n\r\n\r\n# Main section to run both threads\r\ndef main(num_notifications):\r\n    setup_db()\r\n\r\n    listener_thread = threading.Thread(\r\n        target=listen, args=(num_notifications,), daemon=True\r\n    )\r\n    notifier_thread = threading.Thread(\r\n        target=notify, args=(num_notifications,), daemon=True\r\n    )\r\n\r\n    listener_thread.start()\r\n    notifier_thread.start()\r\n\r\n    listener_thread.join()\r\n    notifier_thread.join()\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    # Specify how many notifications you want to send and process in each loop\r\n    num_notifications = 3\r\n    main(num_notifications)\r\n```\r\n",
      "solution": "The workaround that works is:\r\n```\r\nwhile True:\r\n    if select.select([conn],[],[],1) == ([],[],[]):\r\n        print(\"Timeout\")\r\n    else:\r\n        need_to_poll = True\r\n        while need_to_poll:\r\n            need_to_poll = False\r\n            conn.poll()\r\n            while conn.notifies:\r\n                notify = conn.notifies.pop(0)\r\n                print(\"Got NOTIFY:\", notify.pid, notify.channel, notify.payload)\r\n                # some processing that updates the DB based on the notify content\r\n                conn.commit()\r\n                need_to_poll = True\r\n```\n\n---\n\nFixed by merging #1728. Thank you very much for reporting the problem and providing a solution!\r\n\r\nI will wrap a release in the next few days.",
      "labels": [],
      "created_at": "2024-09-09T12:50:32Z",
      "closed_at": "2024-10-11T13:25:36Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1727",
      "comments_count": 5
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1360,
      "title": "sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) SCRAM authentication requires libpq version 10 or above",
      "problem": "- OS: Docker running ubuntu 18.04\r\n- Psycopg version: 2.8.2 (tried lates psycopg2-binary as well)\r\n- Python version: 3.7.3\r\n- PostgreSQL version: docker pull postgres:latest\r\n- pip version: 19.1.1 \r\n\r\n1: what you did\r\n\r\nI have an application with multiple containers, one of which, container-A makes sql requests to another postgres container.\r\n\r\nMy container-A Dockerfile has (among other things):\r\nRUN pip install libpq5\r\nRUN pip install psycopg2-binary\r\n\r\n2: what you expected to happen\r\n\r\nNot see the error. It used to work before. \r\n\r\n3: what happened instead\r\nGetting the error:\r\nsqlalchemy.exc.OperationalError: (psycopg2.OperationalError) SCRAM authentication requires libpq version 10 or above\r\n\r\n",
      "solution": "```\r\nRUN pip install libpq5\r\nRUN pip install psycopg2-binary\r\n```\r\n\r\nThese two together are not needed. If you install psycopg2-binary it will ignore the system libpq.\r\n\r\n```\r\n sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) SCRAM authentication requires libpq version 10 or above\r\n```\r\n\r\nAccording to the news file, psycopg 2.8 binary was packaged with Postgres 11.2 libpq.\r\n\r\nhttps://github.com/psycopg/psycopg2/blob/3430dcdee60ad80202abda54a2f2a55da4c0d8df/NEWS#L179\r\n\r\nSo I think you might have a stray psycopg2 version. I am sorry that the psycopg2 and psycopg2-binary version don't play well together.\r\n\r\nTo look into it better try to get more info about the package installed in your container:\r\n```python\r\n>>> import psycopg2\r\n\r\n# Checking where it is installed\r\n>>> print(psycopg2)\r\n<module 'psycopg2' from '/home/piro/dev/psycopg2/.venv/lib/python3.8/site-packages/psycopg2/__init__.py'>\r\n\r\n# Checking the versions:\r\n>>> print(psycopg2.__version__)\r\n2.9.1 (dt dec pq3 ext lo64)\r\n>>> print(psycopg2.__libpq_version__)\r\n130003\r\n>>> print(psycopg2.extensions.libpq_version())\r\n130003\r\n```\r\n\r\nIf the problem is a conflicting package try to add a `RUN pip uninstall psycopg2` before those commands. However I would advise to install the libpq-dev and python3-dev packages and install psycopg non-binary.\n\n---\n\nI also saw this error running a container on an M1 laptop. Seems to be related to [this SO question](https://stackoverflow.com/q/69573312/596068).\r\n\r\nI can run the ARM and x86 images on the machine [via Docker Desktop](https://docs.docker.com/desktop/multi-arch/), and this shows that the libpq versions differ\r\n\r\n```shell\r\n# x86\r\n$ docker run --platform linux/amd64 -it python:3.8-slim bash -c 'pip install psycopg2-binary && find / -name \"libpq*\"'\r\n\u2026\r\nSuccessfully installed psycopg2-binary-2.9.1\r\n\u2026\r\n/usr/local/lib/python3.8/site-packages/psycopg2_binary.libs/libpq-6f24e430.so.5.13\r\n\r\n# ARM\r\n$ docker run --platform linux/arm64 -it python:3.8-slim bash -c 'pip install psycopg2-binary && find / -name \"libpq*\"'\r\n\u2026\r\nSuccessfully installed psycopg2-binary-2.9.1\r\n\u2026\r\n/usr/local/lib/python3.8/site-packages/psycopg2_binary.libs/libpq-c98caf99.so.5.9\r\n```\r\n\r\nARM gets **5.9** whilst x86 gets the newer **5.13**. My guess is the usage of 5.9 is causing the problem reported in this issue.\r\n\r\nCould this be a packaging problem? If the aarch64 wheel is being built with an old 5.9 library by mistake?\r\n\r\n**Edit**: You can see the library version difference in the [latest package build workflow](https://github.com/psycopg/psycopg2/actions/runs/1330580224):\r\n\r\n- [x86_64 log shows](https://github.com/psycopg/psycopg2/runs/3863775227?check_suite_focus=true#step:5:869) libpq version as `130003`.\r\n- [aarch64 log shows](https://github.com/psycopg/psycopg2/runs/3863775305?check_suite_focus=true#step:5:462) libpq version as `90623 `. This is less than version 10, and so explains the SCRAM error (as that's only available in >= 10).\n\n---\n\nI'm experiencing this issue as well. Is there a temporary workaround anyone has found short of emulating amd64?",
      "labels": [],
      "created_at": "2021-10-05T03:26:40Z",
      "closed_at": "2023-04-02T10:37:31Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1360",
      "comments_count": 30
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1726,
      "title": "cursor.fetchall() returning  ValueError: year -1 is out of range",
      "problem": "the query is failing with ValueError: year -1 is out of range, in cursor.fetchall()\r\nbut in the database its working.\r\n\r\n**Please complete the following information:**\r\n- OS: Ubuntu 22.04\r\n- Psycopg version: unknown since not defined picking it automatically\r\n- Python version:3.10\r\n- PostgreSQL version:15\r\n- pip version:22.3.1 \r\n\r\n**Describe the bug**\r\nPlease let us know:\r\nQuery consists of \r\nselect\r\nto_char((appln.created_date AT time ZONE 'utc' AT time ZONE 'Asia/Calcutta'),'dd-mm-yyyy hh24:mi'),\r\nto_char((appln.last_status_change_date AT time ZONE 'utc' AT time ZONE 'Asia/Calcutta'),'dd-mm-yyyy hh24:mi') AS \"stateEnteredDate\"\r\nfrom application appln\r\nwhere appln.created_date between '2020-08-01T00:00:00.000Z' AND '2024-08-31T23:59:59.999Z' \r\n\r\ndate filter got replaced here by string replace\r\n",
      "solution": "Can you find, in your dataset, the value that causes the problem?\n\n---\n\nIt is fixed, this query has a date of birth columns which has '0001-12-31' dates, which is causing problem ",
      "labels": [],
      "created_at": "2024-09-04T09:46:18Z",
      "closed_at": "2024-09-05T05:22:24Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1726",
      "comments_count": 4
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1723,
      "title": "Using psycopg.connect hangs for around 90 seconds on the latest versions of psycopg2-binary",
      "problem": "**This is a bug tracker**\r\n\r\n**Please complete the following information:**\r\n\r\n- OS: MacOS 14.6.1 (23G93)\r\n- Psycopg version: 2.9.9 (dt dec pq3 ext lo64)\r\n- Python version: 3.10.0\r\n- PostgreSQL version: tested with Debian 16.4-1.pgdg120+1 running on docker\r\n- pip version: 2.9.9\r\n\r\n**Describe the bug**\r\n\r\nI noticed the hanging of psycopg2-binary starting from version 2.9.6. Here is the script I used (pg must be started via docker):\r\n\r\n```python\r\nimport time\r\nimport psycopg2\r\n\r\n# run docker with\r\n# docker run --name postgres -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres\r\nt = time.perf_counter()\r\nconn = psycopg2.connect(\"dbname=postgres user=postgres password=postgres host=localhost\")\r\nt_elapsed = time.perf_counter() - t\r\nprint(f\"Elapsed time on version {psycopg2.__version__} was  {t_elapsed:.2f}\")\r\n```\r\n\r\nSeems like this bug was introduced in version 2.9.7, here are the outputs:\r\n\r\n| psycopg2 version | Output |\r\n| ------------------| --------|\r\n| 2.9.6 | Elapsed time on version 2.9.6 (dt dec pq3 ext lo64) was  0.07 | \r\n| 2.9.7 | Elapsed time on version 2.9.7 (dt dec pq3 ext lo64) was  90.19 | \r\n| 2.9.8 | Elapsed time on version 2.9.8 (dt dec pq3 ext lo64) was  90.24 |\r\n| 2.9.9 | Elapsed time on version 2.9.9 (dt dec pq3 ext lo64) was  90.20 |\r\n\r\nWith debug I could go as far as the Python wrapper goes, up to the call:\r\n\r\n```python\r\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\r\n```\r\n\r\nCould this somehow be unrelated to the python wrapper, but rather to the libpg under it?",
      "solution": "Thanks @dvarrazzo , I tried looking for a related issue yesterday but I could not find anything, this issue you mentioned is exactly what was needed.\r\n\r\nFor anyone that may com to this thread, the solution was to go to Ticket Viewer and remove all entries. It had some expired tickets:\r\n\r\n<img width=\"676\" alt=\"image\" src=\"https://github.com/user-attachments/assets/460d47ea-99a8-4e21-a9c9-dde2b22f4c30\">\r\n\r\nNot it connects as expected \ud83d\udc4d ",
      "labels": [],
      "created_at": "2024-08-20T13:21:42Z",
      "closed_at": "2024-08-20T17:11:59Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1723",
      "comments_count": 3
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1697,
      "title": "malloc: double free on Mac M1",
      "problem": "Versions:\r\n\r\n- OS: Mac M1\r\n- Psycopg version:  '2.9.9 (dt dec pq3 ext lo64)' (from master\r\n- Python version: 3.10.14\r\n\r\n\r\n**Describe the bug**\r\nUpon `psycopg2.connect`,\r\n\r\n```\r\npython(46885,0x203d8fac0) malloc: double free for ptr 0x1243fd200\r\npython(46885,0x203d8fac0) malloc: *** set a breakpoint in malloc_error_break to debug\r\nAbort trap: 6\r\n```\r\n\r\n",
      "solution": "@dvarrazzo Unfortunately, no. My colleague had this problem, and he fixed it by now - by cleaning up his environment and reinstalling latest versions of everything. We use Python 3.10. If I find out more, I will post here.",
      "labels": [],
      "created_at": "2024-05-15T18:20:05Z",
      "closed_at": "2024-05-27T11:40:25Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1697",
      "comments_count": 6
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1712,
      "title": "Inconsistent results when using psycopg2.extensions.QuotedString",
      "problem": "- OS: `Darwin Peter-MacBook-Pro.local 23.5.0 Darwin Kernel Version 23.5.0: Wed May  1 20:09:52 PDT 2024; root:xnu-10063.121.3~5/RELEASE_X86_64 x86_64`\r\n- Psycopg version: `2.9.9 (dt dec pq3 ext lo64)`\r\n- Python version: `3.11.6 (main, Nov 26 2023, 11:01:31) [Clang 15.0.0 (clang-1500.0.40.1)]`\r\n- PostgreSQL version: `PostgreSQL 14.12 (Homebrew) on x86_64-apple-darwin23.4.0, compiled by Apple clang version 15.0.0 (clang-1500.3.9.4), 64-bit`\r\n- pip version: `24.1`\r\n\r\nPlease let us know:\r\nCalls to the `QuotedString().getquoted()` are Inconsistent. See the following tests demonstrating the problem:\r\n```!python\r\n\r\nimport unittest\r\nimport psycopg2\r\nfrom psycopg2.extensions import QuotedString\r\n\r\n\r\nclass Psycopg2Test1(unittest.TestCase):\r\n    def test_quote_no_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \"'foo\\\\\\\\'\"\r\n        result = QuotedString(input_.encode(\"utf-8\")).getquoted().decode(\"utf-8\")\r\n        self.assertEqual(result, expected)\r\n\r\n\r\nclass Psycopg2Test2(unittest.TestCase):\r\n    def test_quote_during_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \"'foo\\\\\\\\'\"\r\n        result = QuotedString(input_.encode(\"utf-8\")).getquoted().decode(\"utf-8\")\r\n        self.assertEqual(result, expected)\r\n\r\n        dsn = \"...\"\r\n        with psycopg2.connect(dsn=dsn) as conn:\r\n            result2 = QuotedString(input_.encode(\"utf-8\")).getquoted().decode(\"utf-8\")\r\n            self.assertEqual(result2, expected)\r\n\r\n\r\nclass Psycopg2Test3(unittest.TestCase):\r\n    def test_quote_after_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \"'foo\\\\\\\\'\"\r\n        result = QuotedString(input_.encode(\"utf-8\")).getquoted().decode(\"utf-8\")\r\n        self.assertEqual(result, expected)\r\n\r\n        dsn = \"...\"\r\n        with psycopg2.connect(dsn=dsn) as conn:\r\n            pass\r\n        result2 = QuotedString(input_.encode(\"utf-8\")).getquoted().decode(\"utf-8\")\r\n        self.assertEqual(result2, expected)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    unittest.main()\r\n\r\n\r\n```\r\n\r\n1: what you did - see script\r\n2: what you expected to happen - see expected\r\n3: what happened instead - got an unsupported string literal `'foo\\'`\r\n",
      "solution": "Yes, it is a known problem with libpq: it returns different results according to the presence of a connection or not.\r\n\r\nThe problem [is worked around in psycopg 3](https://github.com/psycopg/psycopg/blob/be4f63915188888d3748fee63c46cbc0e838acff/psycopg/psycopg/adapt.py#L83-L94).\r\n\r\n```python\r\nimport unittest\r\nimport psycopg\r\nfrom psycopg.sql import quote\r\n\r\n\r\nclass Psycopg3Test1(unittest.TestCase):\r\n    def test_quote_no_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \" E'foo\\\\\\\\'\"\r\n        result = quote(input_)\r\n        self.assertEqual(result, expected)\r\n\r\n\r\nclass Psycopg3Test2(unittest.TestCase):\r\n    def test_quote_during_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \" E'foo\\\\\\\\'\"\r\n        result = quote(input_)\r\n        self.assertEqual(result, expected)\r\n\r\n        dsn = \"\"\r\n        with psycopg.connect(dsn) as conn:\r\n            result2 = quote(input_)\r\n            self.assertEqual(result2, expected)\r\n\r\n\r\nclass Psycopg3Test3(unittest.TestCase):\r\n    def test_quote_after_connection(self):\r\n        input_ = \"foo\\\\\"\r\n        expected = \" E'foo\\\\\\\\'\"\r\n        result = quote(input_)\r\n        self.assertEqual(result, expected)\r\n\r\n        dsn = \"\"\r\n        with psycopg.connect(dsn) as conn:\r\n            pass\r\n        result2 = quote(input_)\r\n        self.assertEqual(result2, expected)\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    unittest.main()\r\n```\r\n\r\nIf you are composing sql statements off-line you can probably use [`psycopg.sql`](https://www.psycopg.org/psycopg3/docs/api/sql.html), which, starting from psycopg 3.2, can be consistently used even without a connection available.\r\n",
      "labels": [],
      "created_at": "2024-07-10T14:09:23Z",
      "closed_at": "2024-07-11T05:39:38Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1712",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1242,
      "title": "psycopg2.connect v slow from 2.85 (Windows 10)",
      "problem": "I have a problem with a very slow connection using psycopg2.connect from version 2.85 onwards.\r\n\r\npsycopg2.connect() using v 2.84 is instantaneous\r\npsycopg2.connect() using v 2.85 (and 2.86) takes about 4 secs.\r\n\r\nI'm running the commands on the same db using the same parameters.  I've checked Python 3.7 and 3.8 using a clean env with just psycopg2 and dependencies installed with the issue persisting.  Installation is on Windows 10 using conda package and connection is to a local Linux machine.\r\n\r\n2.85 package list\r\nca-certificates           2021.1.19            haa95532_0\r\ncertifi                   2020.12.5        py38haa95532_0\r\nkrb5                      1.17.1               hc04afaa_0\r\nlibpq                     12.2                 h3235a2c_0\r\nopenssl                   1.1.1j               h2bbff1b_0\r\npip                       21.0.1           py38haa95532_0\r\npsycopg2                  2.8.5            py38hcd4344a_1\r\npsycopg2-binary           2.8.5                    pypi_0    pypi\r\npython                    3.8.5                h5fd99cc_1\r\nsetuptools                52.0.0           py38haa95532_0\r\nsqlite                    3.33.0               h2a8f88b_0\r\ntk                        8.6.10               he774522_0\r\nvc                        14.2                 h21ff451_1\r\nvs2015_runtime            14.27.29016          h5e58377_2\r\nwheel                     0.36.2             pyhd3eb1b0_0\r\nwincertstore              0.2                      py38_0\r\nzlib                      1.2.11               h62dcd97_4\r\n\r\n2.84 package list\r\nca-certificates           2021.1.19            haa95532_0\r\ncertifi                   2020.12.5        py38haa95532_0\r\nkrb5                      1.16.4               hc04afaa_0\r\nlibpq                     11.2                 h3235a2c_0\r\nopenssl                   1.1.1j               h2bbff1b_0\r\npip                       21.0.1           py38haa95532_0\r\npsycopg2                  2.8.4            py38h7a1dbc1_0\r\npython                    3.8.5                h5fd99cc_1\r\nsetuptools                52.0.0           py38haa95532_0\r\nsqlite                    3.33.0               h2a8f88b_0\r\ntk                        8.6.10               he774522_0\r\nvc                        14.2                 h21ff451_1\r\nvs2015_runtime            14.27.29016          h5e58377_2\r\nwheel                     0.36.2             pyhd3eb1b0_0\r\nwincertstore              0.2                      py38_0\r\nzlib                      1.2.11               h62dcd97_4",
      "solution": "I've figured out the issue.  Analyzing the packets showed a 4-5 second gap with the last packet sent being a 'gssenc encrypt request' which was rejected by my local server. So what must have happened is the default on gssenc changed from 'disable' to 'prefer'.  Anyway, setting the gssencmode='disable' in my connection options fixed the issue.\r\n\r\nI suggest making this the default option for psycopg2\n\n---\n\nI had the same issue, with connection taking 60 secs. Using Django, the solution was to add the following option:\r\n```\r\nDATABASES = {\r\n    \"default\": {\r\n        \"ENGINE\": \"django.db.backends.postgresql\",\r\n        # \u2026\r\n        \"OPTIONS\": {\r\n            'gssencmode': 'disable',\r\n        },\r\n    }\r\n}\r\n```\r\nThank you for sharing your solution. It probably saved me hours of troubleshooting!",
      "labels": [],
      "created_at": "2021-02-21T09:01:04Z",
      "closed_at": "2021-02-24T14:00:05Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1242",
      "comments_count": 7
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1705,
      "title": "module fails to initialize upon second import",
      "problem": "I would like to reopen issue 1414... the problem stems from improper handling\r\nof static variables during repeated module initialization (we encountered it during\r\nPython interpreter reinitialization in OpenPBS server). Please see the patch attached...\r\n[encodings_reinit_patch.txt](https://github.com/user-attachments/files/15818717/encodings_reinit_patch.txt)\r\n",
      "solution": "Fixing this bug is not on my roadmap. Psycopg 3 has been released and it is likely not affected by this problem.\r\n\r\nIf you want the bug fixed as a paid consultancy please get in touch privately.\r\n\r\nOtherwise please make a MR with your changeset and also include a test in CI to show that it works as expected.",
      "labels": [],
      "created_at": "2024-06-13T11:55:33Z",
      "closed_at": "2024-06-13T12:16:27Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1705",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1645,
      "title": "psycopg2-binary on OSX hangs when attempting to connect.",
      "problem": "- OS: MacOSX Ventura 13.1\r\n- Psycopg version: 2.9.9 (binary)\r\n- Python version: 3.10.9\r\n- PostgreSQL version: PostgreSQL [16.0 (Debian 16.0-1.pgdg120+1)  (via postgres docker)\r\n- pip version - pip 23.3.1\r\n\r\nWhen attempting to just connect to the database with 2.9.9, it just hangs. Installing 2.9.6 it works just fine and connects without issue. \r\n\r\n\r\n1: what you did\r\nI attempted to use psycopg2 to connect to the postgres database. \r\n2: what you expected to happen\r\nTo connect in a reasonable amount of time. \r\n3: what happened instead\r\nIt failed to connect and after 3 minutes exited. \r\n\r\nHere is script I used to connect: \r\n\r\n```\r\nimport psycopg2\r\n\r\ntry:\r\n    conn = psycopg2.connect(\"dbname='postgres' user='postgres' host='localhost' password='hello'\")\r\nexcept:\r\n    print(\"I am unable to connect to the database\")\r\n```\r\n",
      "solution": "I'm able to replicate the same issue with the psql client, so the issue is obviously something with the PSQL client library. Still trying to figure out what its doing when it hangs.\n\n---\n\nCan you try with different settings for the `sslmode` connection setting, to figure out if the problem comes from the OpenSSL library?\n\n---\n\nThe issue was something to do with GSSAPI. I went to the OSX Ticket Viewer and removed the ticket which was there (related to connecting to some windows domain) and once that was done the connection now happens immediately as expected. Sorry for the noise, but I hope this may help someone else save some time.",
      "labels": [],
      "created_at": "2023-11-18T19:14:11Z",
      "closed_at": "2023-11-18T19:58:46Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1645",
      "comments_count": 13
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1684,
      "title": "SELECT queries are not working, however INSERT works",
      "problem": "```\r\n        select_query = \"SELECT * from rri\"\r\n        res = connection.cursor().execute(select_query)\r\n        result_rows = connection.cursor().fetchall()\r\n```\r\n\r\nAfter using the following query , I receive the error: psycopg2.ProgrammingError: no results to fetch.\r\nHowever there are clearly records present in the database table. \r\n\r\n![image](https://github.com/psycopg/psycopg2/assets/91143023/cf697e9e-89c9-476f-b626-15a13e737736)\r\n\r\nInsert operations work just fine.\r\n\r\n```\r\n   insert_query = \"INSERT INTO rri (timestamp, ms) VALUES (%s, %s)\"\r\n    connection.cursor().execute(insert_query, (timestamp, ms))\r\n    connection.commit()\r\n```\r\n\r\nI really appreciate if someone can reach out because I'm at my wit's end.",
      "solution": "solved: needed to assign connection.cursor() to a variable:\r\n\r\n```\r\nconnection = psycopg2.connect(**db_params)\r\n    cur = connection.cursor()\r\n    cur.execute('SELECT * FROM rri;')\r\n\r\n    rows = cur.fetchall()\r\n    connection.commit()\r\n    connection.close()\r\n```\r\n\r\n",
      "labels": [],
      "created_at": "2024-03-12T15:17:52Z",
      "closed_at": "2024-03-12T15:41:37Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1684",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1683,
      "title": "Fails to execute in an Azure Function",
      "problem": "- [X] I am running the latest version of pip, i.e. typing ``pip --version`` you get [this version](https://pypi.org/project/pip/).\r\n- [X] I have read the [installation documentation](https://www.psycopg.org/docs/install.html) and the [frequently asked questions](https://www.psycopg.org/docs/faq.html)\r\n- [X] If install failed, I typed `pg_config` on the command line and I obtained an output instead of an error.\r\n\r\n**Please complete the following information:**\r\n- OS: Azure Function Debian Linux\r\n- Psycopg version: 2.8.4\r\n- Python version: 3.8\r\n- pip version: 24.0\r\n\r\nI build my application on Github Actions and then deploy it to a Function app in Azure. When I execute the code that imports psycopg2.sql then an exception is thrown\r\nImportError: libpq.so.5: cannot open shared object file: No such file or directory.\r\n\r\nHaving investigated this online I have installed psycopg2-binary and removed psyopg2. When that happens I get a more immediate error of psycopg2 module not found error.\r\nI have tried it with and without Psycopg2 installed and always the same result.\r\nPsycopg2 doesn't seem to work correctly when installed on an Azure Function\r\n",
      "solution": "I don't know about Azure functions. They are not free software, so I cannot spend time looking for a solution for free. Feel free to reach out for a private consultancy.",
      "labels": [],
      "created_at": "2024-03-11T22:56:12Z",
      "closed_at": "2024-03-11T23:15:52Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1683",
      "comments_count": 1
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1679,
      "title": "Relistening to PostgreSQL notifications fails after PostgreSQL restarts",
      "problem": "Thank you so much for this package!\r\n\r\n- OS: Ubuntu Linux\r\n- Psycopg version: 2.9.9\r\n- Python version: 3.10\r\n- PostgreSQL version: 14\r\n- pip version: 24.0\r\n\r\nBelow is a script that demonstrates the problem. It `LISTEN`s to notifications on a channel `test_update`, and prints them when they arrive. It also reconnects and re-listens after a few seconds if the PostgreSQL server is restarted. For some reason `NOTIFY`s no longer come through after the reconnect + re-`LISTEN` (but the connection works otherwise).\r\n\r\n\r\n```python\r\n# test_reader.py\r\nimport asyncio\r\nimport psycopg2\r\nimport signal\r\nimport time\r\n\r\ndb_name = 'dbname'\r\ndb_user = 'dbuser'\r\n\r\nconn: psycopg2.extensions.connection\r\nloop: asyncio.AbstractEventLoop\r\n\r\ndef connect_to_db_and_listen():\r\n    global conn\r\n    conn = psycopg2.connect(f\"dbname={db_name} user={db_user}\")\r\n    conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)\r\n    cursor = conn.cursor()\r\n    cursor.execute(\"LISTEN test_update;\")\r\n    loop.add_reader(conn, handle_notify)\r\n    print(\"Listening for notifications on channel 'test_update'.\")\r\n\r\ndef handle_notify():\r\n    print(\"handle_notify()\")\r\n    try:\r\n        conn.poll()\r\n    except psycopg2.OperationalError as e:\r\n        # Probably the postgresql server is restarting\r\n        print(f\"Caught an OperationalError: {e}\")\r\n        print(\"Attempting to reconnect to the database in 5 seconds.\")\r\n        time.sleep(5)\r\n        connect_to_db_and_listen()\r\n        return\r\n    while conn.notifies:\r\n        notify = conn.notifies.pop(0)\r\n        print(f\"Got NOTIFY: {notify.pid}, {notify.channel}.\")\r\n\r\nasync def main():\r\n    global loop\r\n    loop = asyncio.get_running_loop()\r\n    stop = loop.create_future()\r\n    loop.add_signal_handler(signal.SIGTERM, stop.set_result, None)\r\n    loop.add_signal_handler(signal.SIGINT, stop.set_result, None)\r\n    connect_to_db_and_listen()\r\n    await stop\r\n\r\nasyncio.run(main())\r\n```\r\n\r\nTo test:\r\n\r\n```\r\npython3 test_reader.py\r\n```\r\n\r\nIn psql: `NOTIFY test_update;` results in the Python script printing:\r\n\r\n```\r\nListening for notifications on channel 'test_update'.\r\nhandle_notify()\r\nGot NOTIFY: 131981, test_update.\r\n```\r\n\r\nTo restart PostgreSQL: `sudo systemctl restart postgresql`\r\n\r\nThe Python script then outputs:\r\n\r\n```\r\nCaught an OperationalError: server closed the connection unexpectedly\r\n        This probably means the server terminated abnormally\r\n        before or while processing the request.\r\n\r\nAttempting to reconnect to the database in 5 seconds.\r\nListening for notifications on channel 'test_update'.\r\n```\r\n\r\nSo far, so good. I can confirm that the reconnection works (e.g. by issuing a `SELECT 1+1;` and fetching the result). But now issuing `NOTIFY test_update;` in psql yields no result in the Python script.\r\n\r\nWhat's even stranger is that if I create another connection (creating a copy of  `conn` called `conn2` and a corresponding `handle_notify2`), then:\r\n- Before restarting PostgreSQL, I see the notifications twice, as expected, but\r\n- After restarting PostgreSQL, notifications come through on the (new) second connection, but not on the (new) first connection.\r\n\r\n",
      "solution": "Thank you very much! That works great in psycopg 3 - I am going to try migrating the project over.\r\n\r\nBtw, `signal` is just there to handle quitting with CTRL-C etc, and the global variables are there just to avoid having to create wrappers around the callbacks, just for this MWE. In the actual code (where the problem  was found), global variables aren't used. But yes, maybe the issue is with asyncio or postgresql rather than psycopg2. In any case, onwards to psycopg 3!",
      "labels": [],
      "created_at": "2024-02-24T22:50:04Z",
      "closed_at": "2024-02-25T00:31:53Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1679",
      "comments_count": 6
    },
    {
      "tech": "postgresql",
      "repo": "psycopg/psycopg2",
      "issue_number": 1677,
      "title": "vulnerability  with psycopg2 2.7.3.2",
      "problem": "\r\n\r\n**Please complete the following information:**\r\n- OS: \r\n- NAME=\"AlmaLinux\"\r\nVERSION=\"8.8 (Sapphire Caracal)\"\r\n- Psycopg version: \r\n- psycopg2               2.7.3.2\r\n- Python version:\r\n- 3.6\r\n- PostgreSQL version:\r\n- psql (PostgreSQL) 15.2\r\n- pip version \r\n  pip 21.3.1 from /usr/local/lib/python3.6/site-packages/pip (python 3.6)\r\n\r\n\r\n**Describe the bug**\r\n I found that this particular package has below vulnerability\r\n CVE-2021-3711\r\nCVE-2022-1292\r\nCVE-2022-2068\r\nCVE-2023-4807\r\nCVE-2021-23840\r\nCVE-2022-0778\r\nCVE-2022-4450\r\nCVE-2023-0215\r\nCVE-2023-0464\r\nCVE-2021-3712\r\nCVE-2023-0286\r\nCVE-2023-2650\r\nCVE-2020-1971\r\nCVE-2021-23841\r\nCVE-2021-3449\r\nCVE-2021-4160\r\nCVE-2022-4304\r\nCVE-2024-0727\r\nCVE-2022-2097\r\nCVE-2023-0465\r\nCVE-2023-0466\r\nCVE-2023-3817\r\nCVE-2023-5678\r\n\r\nto remove these I tried to update the updated package, but I am not sure which version of this package does not has these issues \r\nIf some one help to point out if we have any version of this package which does not contains above vulnerability please let me know \r\nThank you,\r\n",
      "solution": "No, I can't. I don't know in which version they were fixed in the libraries we bundled. You can use the git history of the project to figure it out or you can pay me for my time to look it up for you.\r\n\r\nI suggest that you don't use `psycopg2-binary`. Use `psycopg2` and the library will bind with the OpenSSL and other libraries on your system. From there on you can use your OS facilities to manage library upgrades and security updates.",
      "labels": [],
      "created_at": "2024-02-21T12:08:19Z",
      "closed_at": "2024-02-21T12:13:43Z",
      "url": "https://github.com/psycopg/psycopg2/issues/1677",
      "comments_count": 3
    }
  ]
}